
<table>
<thead>
    <tr><th>file:line</th><th>query</th><th>new query</th><th>comment</th></tr>
</thead>
<tbody>
   <tr><td>commissions/scripts/generate_sales_comp_data.php:173</td><td>create table qcpr_snapshot_$snapshot_date 
select 
  * 
from 
  qcpr_source</td><td></td><td></td></tr>
   <tr><td>cron/ns_sync/archived/release_orders_sync.php:20</td><td>CREATE TABLE sync_orders 
SELECT 
  order_id, 
  account_id, 
  if(
    billing_account_id = 0, account_id, 
    billing_account_id
  ) billing_account_id, 
  replacement_order_id, 
  space(22) replacement_ns_id, 
  expansion_order_id, 
  space(8) expansion_ns_id, 
  space(1500) accounting_memo, 
  space(45) po_numbers, 
  space(5) multiple_po, 
  space(5) process_without_po, 
  space(50) sales_rep 
FROM 
  orders 
WHERE 
  status = 0 
  AND draft = 0 
  AND om_order_id = 0 
  and ns_order_id = '' 
  and account_id > 0 
  AND date_entered > '2009-08-01' 
  AND date_entered <= '$start_time'</td><td></td><td></td></tr>
   <tr><td>cron/ns_sync/archived/release_orders_sync.php:60</td><td>CREATE TABLE sync_order_po 
SELECT 
  s.order_id, 
  group_concat(
    concat_ws(' ', p.po, p.po_amount, p.po_date)
  ) accounting_memo, 
  group_concat(p.po) po_numbers, 
  count(distinct p.order_po_id) total_po, 
  'No ' no_po 
FROM 
  sync_orders s, 
  order_po p 
WHERE 
  s.order_id = p.order_id 
  AND p.po NOT IN ('', 'PENDING') 
GROUP BY 
  s.order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/orders_changed.php:75</td><td>CREATE TEMPORARY TABLE tmp_changed_spt(
  INDEX(order_id, cancel_id, lock_month), 
  id INT AUTO_INCREMENT PRIMARY KEY
) 
SELECT 
  a.lock_month, 
  a.order_id, 
  a.cancel_id, 
  spt.sub_product_type_id, 
  spt.sub_product_type_name, 
  CASE WHEN spt.pd_deliverable = 'Y' THEN spt.pd_sort ELSE 0 END pd_sort, 
  CASE WHEN spt.pd_deliverable = 'Y' 
  AND a.sub_product_type_id IN (4, 5) THEN 'N' WHEN spt.pd_deliverable = 'Y' 
  AND a.sub_product_type_id IN (14, 24) THEN 'Y' ELSE 0 END online, 
  SUM(a.difference) spt_diff, 
  spt.quote_sort 
FROM 
  (
    amortization.amortization_orders_changed a, 
    amortization.orders o
  ) 
  LEFT JOIN amortization.sub_product_types spt ON spt.sub_product_type_id = a.sub_product_type_id 
WHERE 
  a.order_id = o.order_id 
  AND o.order_total != 0 
  AND a.status = 0 "
                .($all_months ? " 
  and YEAR(a.report_month) >= YEAR('$unlock_month') " : " 
  and a.lock_month = '$lock_month' ").
                " 
GROUP BY 
  a.lock_month, 
  a.order_id, 
  a.cancel_id, 
  spt.sub_product_type_id 
ORDER BY 
  report_month DESC;</td><td></td><td>skip</td></tr>
   <tr><td>finance/payments/import/insert_payments_do.php:13</td><td>CREATE TEMPORARY TABLE tmp_unique_ns_order_id (
  PRIMARY KEY (order_id)
) 
SELECT 
  ns_order_id, 
  order_id, 
  count(order_id) order_count 
FROM 
  interlink.orders 
GROUP BY 
  ns_order_id 
HAVING 
  order_count = 1;</td><td></td><td>skip</td></tr>
   <tr><td>finance/payments/import/insert_payments_do.php:23</td><td>CREATE TEMPORARY TABLE tmp_find_invoice_order (
  PRIMARY KEY (ns_invoice_id)
) 
SELECT 
  oi.ns_invoice_id, 
  max(oi.order_id) order_id, 
  max(o.ns_order_id) ns_order_id, 
  count(DISTINCT o.order_id) order_count 
FROM 
  billing.invoice_orders oi 
  INNER JOIN interlink.orders o ON o.order_id = oi.order_id 
  INNER JOIN tmp_unique_ns_order_id unique_ns ON unique_ns.order_id = o.order_id 
WHERE 
  1 
GROUP BY 
  oi.ns_invoice_id 
HAVING 
  order_count = 1;</td><td></td><td>skip</td></tr>
   <tr><td>finance/payments/import/insert_payments_do.php:140</td><td>CREATE TABLE order_tax (
  PRIMARY KEY (il_order_id)
) 
SELECT 
  il_order_id, 
  SUM(sales_tax) sales_tax 
FROM 
  invoices 
GROUP BY 
  il_order_id 
HAVING 
  sales_tax > 0</td><td></td><td></td></tr>
   <tr><td>finance/payments/import/insert_payments_do.php:150</td><td>CREATE TABLE payments_tax (
  primary key (payment_id)
) 
SELECT 
  p.payment_id, 
  p.payment_total / i.invoice_total * i.sales_tax payment_tax 
FROM 
  billing.payments p 
  INNER JOIN billing.invoices i ON p.ns_invoice_id = i.ns_invoice_id 
  INNER JOIN order_tax ot ON ot.il_order_id = i.il_order_id 
WHERE 
  1 
  AND i.sales_tax > 0</td><td></td><td></td></tr>
   <tr><td>finance/payments/import/insert_payments_do.php:166</td><td>create table order_invoices_split (
  primary key (order_id)
) 
select 
  distinct io.order_id 
from 
  invoice_orders io, 
  invoices i 
where 
  io.invoice_id = i.invoice_id 
  and round(io.invoice_amount) not between i.invoice_total - 5 
  and i.invoice_total + 5</td><td></td><td></td></tr>
   <tr><td>finance/payments/import/insert_payments_do.php:175</td><td>create table invoice_credits (
  primary key(invoice_id)
) 
select 
  i.invoice_id, 
  i.invoice_id credit_invoice_id, 
  t.transaction_date credit_date, 
  t.transaction_amount *-1 credit_amount, 
  t.date_modified date_entered 
from 
  invoices i, 
  $payment_table t 
where 
  i.ns_invoice_id = t.invoice_id 
  and t.transaction_type = 'Credit Memo'</td><td></td><td></td></tr>
   <tr><td>finance/payments/import/insert_payments_do.php:197</td><td>create temporary table invoice_payments (
  primary key(invoice_id)
) 
select 
  invoice_id, 
  sum(payment_total) payment_total 
from 
  payments 
where 
  payment_total <> 0 
group by 
  invoice_id</td><td></td><td></td></tr>
   <tr><td>finance/payments/import/insert_payments_do.php:231</td><td>CREATE TABLE tmp_order_total_after_credits(
  PRIMARY KEY(order_id)
) 
SELECT 
  os.order_id, 
  os.order_total - IFNULL(credit_amount, 0)+ IFNULL(commission_credit, 0) order_total_after_credits, 
  os.sales_tax - IFNULL(tax_credit_amount, 0) sales_tax_after_credits, 
  (
    os.sales_tax - IFNULL(tax_credit_amount, 0)
  )/ GREATEST(
    p.payment_total, 
    (
      os.order_total - IFNULL(credit_amount, 0)+ IFNULL(commission_credit, 0)
    )
  ) sales_tax_perc 
FROM 
  interlink.order_summary os 
  LEFT JOIN (
    SELECT 
      order_id, 
      SUM(credit_amount) credit_amount, 
      SUM(tax_credit_amount) tax_credit_amount 
    FROM 
      interlink.order_cancels 
    GROUP BY 
      order_id
  ) oc USING(order_id) 
  LEFT JOIN (
    SELECT 
      order_id, 
      SUM(payment_total) payment_total 
    FROM 
      billing.payments 
    GROUP BY 
      order_id
  ) p USING(order_id) 
  LEFT JOIN (
    SELECT 
      il_order_id order_id, 
      SUM(invoice_total) commission_credit 
    FROM 
      billing.commission_credits 
    WHERE 
      il_order_id > 0 
      AND GREATEST(invoice_date, post_date) < NOW() 
    GROUP BY 
      il_order_id
  ) commission_credits USING(order_id) 
WHERE 
  order_id >= 5227</td><td></td><td></td></tr>
   <tr><td>finance/payments/import/insert_payments_do.php:246</td><td>CREATE TABLE tmp_payments_update_sales_tax(
  PRIMARY KEY(payment_id)
) 
SELECT 
  payments_to_update.*, 
  payments_to_update.payment_total * os.sales_tax_perc new_payment_sales_tax 
FROM 
  tmp_order_total_after_credits os 
  INNER JOIN (
    SELECT 
      order_id, 
      SUM(payment_total) payment_total, 
      SUM(sales_tax) payment_sales_tax 
    FROM 
      billing.payments 
    GROUP BY 
      order_id
  ) p USING(order_id) 
  INNER JOIN billing.payments payments_to_update USING(order_id) 
WHERE 
  1 
  AND (
    ABS(
      p.payment_total - os.order_total_after_credits
    ) < 1 
    OR p.payment_total > os.order_total_after_credits
  ) -- order is paid in full
  AND ABS(
    payment_sales_tax - os.sales_tax_after_credits
  ) >.5 -- sales tax on paymments don't match order's sales tax
  ;</td><td></td><td></td></tr>
   <tr><td>finance/payments/import/insert_payments_do.php:260</td><td>CREATE TABLE tmp_payments_previously_logged(
  PRIMARY KEY(payment_id, rank_id)
) ENGINE = INNODB 
SELECT 
  CASE payment_id WHEN @curr_payment THEN @curRank := @curRank + 1 ELSE @curRank := 1 
  AND @curr_payment := payment_id END rank_id, 
  payment_id, 
  old_value, 
  new_value, 
  date_entered 
FROM 
  (
    SELECT 
      record_id payment_id, 
      old_value, 
      new_value, 
      date_entered 
    FROM 
      interlink.history_log 
    WHERE 
      TABLE_NAME = 'billing.payments' 
      AND COLUMN_NAME = 'sales_tax' 
    ORDER BY 
      record_id, 
      date_entered DESC
  ) hl CROSS 
  JOIN (
    SELECT 
      @curr_payment := 0, 
      @curRank := 0
  ) r;</td><td></td><td></td></tr>
   <tr><td>orders/convert_pd.php:103</td><td>CREATE TABLE $pd_products (
  primary key (product_id)
) 
SELECT 
  p.product_id, 
  pg.product_group_name, 
  p.product_name, 
  p.start_date, 
  p.summer_type_id, 
  p.status, 
  p.program_id, 
  p.product_line_id, 
  p.student_licenses, 
  p.teacher_licenses, 
  p.parent_licenses, 
  sum(
    if(
      sp.sub_product_type_id in (4, 5), 
      sp.sub_product_qty, 
      0
    )
  ) onsite_pd, 
  sum(
    if(
      sp.sub_product_type_id in (14, 24), 
      sp.sub_product_qty, 
      0
    )
  ) online_pd, 
  sum(
    if(
      sp.sub_product_type_id = 4, sp.sub_product_qty, 
      0
    )
  ) initial_onsite_pd, 
  sum(
    if(
      sp.sub_product_type_id = 5, sp.sub_product_qty, 
      0
    )
  ) followup_onsite_pd, 
  sum(
    if(
      sp.sub_product_type_id = 24, sp.sub_product_qty, 
      0
    )
  ) initial_online_pd, 
  sum(
    if(
      sp.sub_product_type_id = 14, sp.sub_product_qty, 
      0
    )
  ) followup_online_pd, 
  sum(
    sp.list_price * sp.sub_product_qty
  ) price 
FROM 
  sub_products sp, 
  products p, 
  product_groups pg 
WHERE 
  p.product_id = sp.product_id 
  AND pg.product_group_id = p.product_group_id 
GROUP BY 
  p.product_id 
HAVING 
  (
    onsite_pd > 0 
    OR online_pd > 0
  )</td><td></td><td></td></tr>
   <tr><td>orders/convert_pd.php:121</td><td>CREATE TEMPORARY TABLE pd_product_matches (
  primary key (original_product_id, product_id)
) 
SELECT 
  p1.product_id original_product_id, 
  p2.* 
FROM 
  $pd_products p1, 
  $pd_products p2 
WHERE 
  p1.product_id <> p2.product_id 
  AND p1.student_licenses = p2.student_licenses 
  AND p1.teacher_licenses = p2.teacher_licenses 
  AND p1.parent_licenses = p2.parent_licenses 
  AND p1.price = p2.price 
  AND p1.summer_type_id = p2.summer_type_id 
  AND p1.program_id = p2.program_id 
  AND p1.product_line_id = p2.product_line_id 
  AND (
    (p1.onsite_pd * $ratio)+ p1.online_pd
  ) = (
    (p2.onsite_pd * $ratio)+ p2.online_pd
  ) 
  AND (
    (p1.initial_onsite_pd * $ratio)+ p1.initial_online_pd
  ) = (
    (p2.initial_onsite_pd * $ratio)+ p2.initial_online_pd
  ) 
  AND (
    (p1.followup_onsite_pd * $ratio)+ p1.followup_online_pd
  ) = (
    (p2.followup_onsite_pd * $ratio)+ p2.followup_online_pd
  ) 
  AND year(p1.start_date) = year(p2.start_date) 
  AND (
    p1.onsite_pd <> p2.onsite_pd 
    or p1.online_pd <> p2.online_pd
  ) 
  AND p1.onsite_pd > 0 
  AND p2.online_pd >= p1.online_pd 
  AND p2.status = 0</td><td></td><td>skip</td></tr>
   <tr><td>reports/amortization/yearly_revenue_index.php:109</td><td>CREATE TEMPORARY TABLE tmp_sales_rep (
  PRIMARY KEY(order_id)
) 
SELECT 
  order_id, 
  user_id 
FROM 
  interlink.user_orders_lock 
WHERE 
  role_id IN (6) 
GROUP BY 
  order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/amortization/yearly_revenue_index.php:122</td><td>CREATE TEMPORARY TABLE tmp_order_info (
  PRIMARY KEY(order_id)
) 
SELECT 
  oi.order_id, 
  oi.order_date, 
  oi.start_date, 
  oi.end_date, 
  a.state_code state, 
  u.user_f_last sales_rep, 
  opm.opportunity_product_id business_type_id, 
  opmo.opportunity_product_name, 
  a.account_id, 
  a.account_name, 
  os.order_total, 
  obs.cancel_total, 
  obs.cancel 
FROM 
  interlink.orders oi 
  LEFT JOIN interlink.opportunities op ON oi.order_id = op.order_id 
  LEFT JOIN interlink.opportunity_product_map opm ON opm.opportunity_id = op.opportunity_id 
  LEFT JOIN interlink.opportunity_products opmo ON opmo.opportunity_product_id = opm.opportunity_product_id 
  LEFT JOIN tmp_sales_rep uol ON uol.order_id = oi.order_id 
  LEFT JOIN commissions.users u ON u.user_id = uol.user_id 
  LEFT JOIN interlink.accounts a ON a.account_id = oi.account_id 
  LEFT JOIN interlink.order_summary os ON os.order_id = oi.order_id 
  LEFT JOIN interlink.order_billing_summary obs ON obs.order_id = oi.order_id 
GROUP BY 
  oi.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/amortization/yearly_revenue_index.php:156</td><td>CREATE TEMPORARY TABLE tmp_order_detail_lines_new_renew (
  PRIMARY KEY (line_id), 
  percent_new DECIMAL (20, 18), 
  percent_renew DECIMAL(20, 18)
) 
SELECT 
  a.line_id, 
  a.order_id, 
  a.cancel_id, 
  a.order_detail_id, 
  rns.new_percent_fin percent_new, 
  rns.renew_percent_fin percent_renew 
FROM 
  amortization.order_detail_amortization a 
  INNER JOIN interlink.order_summary os ON os.order_id = a.order_id 
  INNER JOIN interlink.orders o ON os.order_id = o.order_id 
  INNER JOIN interlink.order_detail_new_renew_summary rns ON rns.order_detail_id = a.order_detail_id 
  AND rns.order_id = a.order_id 
  LEFT JOIN interlink.sub_product_types spt ON spt.sub_product_type_id = a.sub_product_type_id 
WHERE 
  o.order_date >= '2010-01-01' 
GROUP BY 
  a.line_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/amortization/yearly_revenue_index.php:173</td><td>CREATE TEMPORARY TABLE tmp_order_detail_acv_info (
  PRIMARY KEY(order_detail_id, cancel_id), 
  KEY(
    order_detail_id, cancel_id, order_id
  )
) 
SELECT 
  acv.order_id, 
  order_detail_id, 
  acv.cancel_id, 
  CASE WHEN oc.cancel_id > 0 THEN YEAR(cancel_date) ELSE booking_year END booking_year, 
  acv_new_total, 
  acv_renew_total 
FROM 
  amortization.booking_acv_details acv 
  LEFT JOIN interlink.order_cancels oc ON acv.cancel_id = oc.cancel_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/amortization/yearly_revenue_index.php:190</td><td>CREATE TEMPORARY TABLE tmp_order_acv_info (
  PRIMARY KEY(order_id $sub_program_str)
) 
SELECT 
  acv.order_id $sub_program_str, 
  SUM(acv_new_total) acv_new_total, 
  SUM(acv_renew_total) acv_renew_total 
FROM 
  amortization.booking_acv_details acv ".(in_array(" business_type_id ", $group_by_info) ? " 
  LEFT JOIN interlink.order_detail_info_summary odis ON odis.order_detail_id = acv.order_detail_id " : "" )." 
GROUP BY 
  order_id $sub_program_str;</td><td></td><td>skip</td></tr>
   <tr><td>reports/amortization/yearly_revenue_index.php:210</td><td>CREATE TEMPORARY TABLE tmp_order_detail_amortization (
  PRIMARY KEY(
    order_id, order_detail_id, cancel_id $sub_product_type_str
  )
) ENGINE = INNODB 
SELECT 
  od.order_id, 
  od.order_detail_id, 
  l.cancel_id, 
  od.account_id, 
  od.product_id, 
  od.product_name, 
  od.sku, 
  ".(in_array(" sub_product_type_id ", $group_by_info)? " l.sub_product_type_id, 
  spt.sub_product_type_name, 
  ": "") ." SUM(
    IF(
      YEAR(period_month)= $report_year, 
      period_total, 
      0
    )
  ) `$report_year Revenue`, 
  SUM(
    IF(
      YEAR(period_month)= $report_year, 
      period_total, 
      0
    )* lnr.percent_new
  ) `$report_year New Revenue`, 
  SUM(
    IF(
      YEAR(period_month)= $report_year, 
      period_total, 
      0
    )* lnr.percent_renew
  ) `$report_year Renew Revenue`, 
  SUM(
    IF(
      YEAR(period_month)> $report_year, 
      period_total, 
      0
    )
  ) `Post $report_year Revenue`, 
  SUM(
    IF(
      YEAR(period_month)> $report_year, 
      period_total, 
      0
    )* lnr.percent_new
  ) `Post $report_year New Revenue`, 
  SUM(
    IF(
      YEAR(period_month)> $report_year, 
      period_total, 
      0
    )* lnr.percent_renew
  ) `Post $report_year Renew Revenue` 
FROM 
  (
    amortization.order_detail_amortization l, 
    amortization.order_details od
  ) 
  LEFT JOIN amortization.sub_product_types spt ON l.sub_product_type_id = spt.sub_product_type_id 
  LEFT JOIN tmp_order_detail_lines_new_renew lnr ON lnr.line_id = l.line_id 
WHERE 
  period_month >= '$start_year' 
  AND l.line_id = od.line_id 
  AND period_total <> 0 
GROUP BY 
  order_id, 
  order_detail_id, 
  cancel_id $sub_product_type_str;</td><td></td><td>skip</td></tr>
   <tr><td>reports/opportunities/closed_index.php:335</td><td>CREATE TEMPORARY TABLE $table_name 
SELECT 
  p.opportunity_id, 
  p.opportunity_name, 
  q.quote_id, 
  a.state_code, 
  a.account_id, 
  a.account_name, 
  a.account_level, 
  substr(u.first_name, 1, 1) rep_first_name, 
  u.last_name rep_last_name, 
  p.order_id, 
  q.start_date order_start, 
  0000000.00 total, 
  0 num_schools, 
  -0000000.00 standard_discount, 
  -0000000.00 nonstandard_discount, 
  0 nonstandard_discount_percent, 
  0 nonstandard_product, 
  if(
    no_po > 0, 
    'Not Required', 
    group_concat(po.po)
  ) po_number, 
  p.opportunity_type_id, 
  group_concat(
    distinct opm.opportunity_product_id 
    order by 
      opm.opportunity_product_id
  ) opportunity_product 
FROM 
  (
    opportunities p, accounts a, user_orders o, 
    users u, order_po po, quotes q, opportunity_probabilities op $fromStr
  ) 
  LEFT JOIN opportunity_product_map opm on (
    p.opportunity_id = opm.opportunity_id
  ) 
  LEFT JOIN opportunity_product_map opm2 on (
    p.opportunity_id = opm2.opportunity_id
  ) 
WHERE 
  p.account_id = a.account_id 
  AND p.opportunity_id = o.opportunity_id 
  AND p.opportunity_id = po.opportunity_id 
  AND po.status = 0 
  AND p.opportunity_id = q.opportunity_id 
  AND q.final = 1 $whereStr 
  AND o.role_id = '".$ROLE[$DEPARTMENT["sales"]]["sales_rep"]."' 
  AND o.user_id = u.user_id 
  AND p.probability_id = op.probability_id 
  AND op.probability_percent >=.9 
GROUP BY 
  p.opportunity_id, 
  q.quote_id $havingStr</td><td></td><td>skip</td></tr>
   <tr><td>reports/opportunities/closed_index.php:362</td><td>CREATE TEMPORARY TABLE closed_opportunities_quote_total 
SELECT 
  p.opportunity_id, 
  p.order_id, 
  sum(d.price * d.quantity) total, 
  count(distinct d2.account_id) num_schools, 
  sum(
    if(
      d.product_id <> '".$PRODUCTS["non standard discount"]."' 
      AND pr.product_group_id = '" . $PRODUCT_GROUPS["discount"] . "', 
      d.price * d.quantity, 
      0
    )
  ) standard_discount, 
  sum(
    if(
      d.product_id = '".$PRODUCTS["non standard discount"]."', 
      d.price * d.quantity, 0
    )
  ) non_standard_discount, 
  sum(
    if(
      pr.product_group_id <> '" . $PRODUCT_GROUPS["discount"] . "' 
      AND pr.product_group_id <> '" . $PRODUCT_GROUPS["fee"] . "', 
      d.price * d.quantity, 
      0
    )
  ) total_before_discounts 
FROM 
  (
    $table_name p, quote_details d, products pr
  ) 
  LEFT JOIN quote_details d2 ON (
    p.quote_id = d2.quote_id 
    AND d.quote_detail_id = d2.quote_detail_id 
    AND d2.account_id > 0 
    AND (
      d2.account_id != p.account_id 
      OR p.account_level = '".$ACCOUNT_LEVEL["school"]."'
    )
  ) 
WHERE 
  p.quote_id = d.quote_id 
  AND pr.product_id = d.product_id 
  AND p.order_id = 0 
GROUP BY 
  p.opportunity_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/opportunities/closed_index.php:401</td><td>CREATE TEMPORARY TABLE closed_opportunities_credits 
SELECT 
  oc.order_id, 
  sum(oc.credit_amount) credit_amount 
FROM 
  closed_opportunities_quote_total p, 
  order_cancels oc 
WHERE 
  p.order_id = oc.order_id 
GROUP BY 
  oc.order_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/opportunities/closed_index.php:417</td><td>CREATE TEMPORARY TABLE closed_opportunities_total_schools 
SELECT 
  p.opportunity_id, 
  count(distinct d.account_id) num_schools 
FROM 
  $table_name p, 
  quote_details d 
WHERE 
  p.quote_id = d2.quote_id 
  AND d2.account_id > 0 
  AND (
    d2.account_id != p.account_id 
    OR p.account_level = '".$ACCOUNT_LEVEL["school"]."'
  )
) 
GROUP BY 
  p.opportunity_id</td><td></td><td>skip</td></tr>
   <tr><td>util/function/order_validation.php:22</td><td>CREATE TABLE interlink.tmp_order_total_logs (
  PRIMARY KEY (order_id), 
  INDEX(order_month)
) 
SELECT 
  o.order_id, 
  o.order_date, 
  CASE WHEN o.order_date <= @amort_locked_through THEN 1 ELSE 0 END is_prior_year_order, 
  date_format(o.order_date, '%Y-%m-01') order_month, 
  date_format(o.order_date, '%Y%m01') report_month_string, 
  date_add(
    last_day(o.order_date), 
    INTERVAL 3 DAY
  ) amort_month_end, 
  os.order_total, 
  MAX(
    CASE WHEN lon.date_entered < GREATEST(
      date_add(
        last_day(o.order_date), 
        INTERVAL 3 DAY
      ), 
      date_add(o.date_entered, INTERVAL 1 DAY)
    ) THEN lon.log_id ELSE NULL END
  ) max_month_end_log_id, 
  MAX(
    CASE WHEN lon.date_entered > GREATEST(
      date_add(
        last_day(o.order_date), 
        INTERVAL 3 DAY
      ), 
      date_add(o.date_entered, INTERVAL 1 DAY)
    ) THEN lon.log_id ELSE NULL END
  ) max_after_month_end_log_id, 
  MIN(lon.log_id) min_log_id_all_time 
FROM 
  interlink.orders o 
  INNER JOIN interlink.order_summary os ON os.order_id = o.order_id 
  LEFT JOIN commissions.log_order_new_renew lon ON o.order_id = lon.order_id 
  AND (
    lon.is_order_deleted = 0 
    OR os.order_total = 0
  ) 
WHERE 
  1 
GROUP BY 
  o.order_id;</td><td></td><td></td></tr>
   <tr><td>util/function/order_validation.php:47</td><td>CREATE TABLE interlink.tmp_order_totals_changed (
  PRIMARY KEY (order_id)
) 
SELECT 
  o.order_id, 
  o.order_date, 
  tol.order_month, 
  tol.report_month_string, 
  tol.is_prior_year_order, 
  os.new_total, 
  os.renew_total, 
  COALESCE(
    lon1.order_total, lon3.order_total, 
    0
  ) orig_order_total, 
  COALESCE(
    lon2.order_total, os.order_total
  ) current_order_total, 
  lon2.date_entered last_audit_log_date, 
  ar.date_entered amort_locked_date, 
  CASE WHEN log.order_id THEN 1 ELSE 0 END is_reviewed 
FROM 
  interlink.tmp_order_total_logs tol 
  INNER JOIN interlink.orders o ON o.order_id = tol.order_id 
  INNER JOIN interlink.order_summary os ON os.order_id = o.order_id 
  LEFT JOIN commissions.log_order_new_renew lon1 ON lon1.log_id = max_month_end_log_id 
  LEFT JOIN commissions.log_order_new_renew lon2 ON lon2.log_id = max_after_month_end_log_id 
  LEFT JOIN commissions.log_order_new_renew lon3 ON lon3.log_id = min_log_id_all_time 
  AND lon3.date_entered < '2020-11-30' # order totals changes logged after this date; beforehand data missing
  LEFT JOIN amortization.amortization_reports ar ON ar.status = 0 
  AND ar.report_month = tol.order_month 
  LEFT JOIN commissions.log_order_review log ON log.order_id = tol.order_id 
  AND log.review_category = 'data_check' 
  AND log.review_type = 'order_total' 
WHERE 
  1 
  AND abs(
    COALESCE(
      lon2.order_total, os.order_total
    )- COALESCE(
      lon1.order_total, lon3.order_total, 
      0
    )
  )>.05 
  AND lon2.date_entered > ar.date_entered 
  AND NOW() > tol.amort_month_end 
GROUP BY 
  o.order_id;</td><td></td><td></td></tr>
   <tr><td>cron/ns_sync/archived/pre_release_orders_sync.php:20</td><td>CREATE TABLE sync_orders 
SELECT 
  order_id, 
  account_id, 
  if(
    billing_account_id = 0, account_id, 
    billing_account_id
  ) billing_account_id, 
  replacement_order_id, 
  space(22) replacement_ns_id, 
  expansion_order_id, 
  space(8) expansion_ns_id, 
  space(1500) accounting_memo, 
  space(45) po_numbers, 
  space(5) multiple_po, 
  space(5) process_without_po, 
  space(50) sales_rep 
FROM 
  orders 
WHERE 
  status = 0 
  AND draft = 0 
  AND om_order_id = 0 
  and ns_order_id = '' 
  and account_id > 0 
  AND date_entered > '2009-08-01' 
  AND date_entered <= '$start_time'</td><td></td><td></td></tr>
   <tr><td>cron/ns_sync/archived/pre_release_orders_sync.php:60</td><td>CREATE TABLE sync_order_po 
SELECT 
  s.order_id, 
  group_concat(
    concat_ws(' ', p.po, p.po_amount, p.po_date)
  ) accounting_memo, 
  group_concat(p.po) po_numbers, 
  count(distinct p.order_po_id) total_po, 
  'No ' no_po 
FROM 
  sync_orders s, 
  order_po p 
WHERE 
  s.order_id = p.order_id 
  AND p.po NOT IN ('', 'PENDING') 
GROUP BY 
  s.order_id</td><td></td><td></td></tr>
   <tr><td>cron/sa_products.php:22</td><td>create table tech.fm_00612920_textbooks(
  key(account_id)
) 
select 
  distinct od.account_id, 
  group_concat(
    distinct IFNULL(
      pr.program_name, pl.product_line_str
    )
  ) 'textbook_alignment_products', 
  max(od.academic_year_id) 'txtbk_ay' 
from 
  orders o 
  join order_details od on od.order_id = o.order_id 
  and od.status = 0 
  and @start_date <= if(
    od.post_end > od.end_date, od.post_end, 
    od.end_date
  ) 
  and @end_date >= od.start_date 
  join products p on p.product_id = od.product_id 
  and p.product_group_id 
  and p.product_group_id = 61 
  JOIN product_lines pl ON pl.product_line_id = p.product_line_id 
  LEFT JOIN programs pr ON pr.program_id = p.program_id 
  AND pl.product_line_id IN(3, 4, 11) 
where 
  o.status = 0 
group by 
  account_id</td><td></td><td></td></tr>
   <tr><td>cron/sa_products.php:43</td><td>create table tech.fm_00612920_smartyants(
  key(account_id)
) 
select 
  od.account_id, 
  sum(aos.student_licenses) 'sa_licenses', 
  max(aos.academic_year_id) 'sa_ay' 
from 
  orders o 
  join order_details od on od.order_id = o.order_id 
  and od.status = 0 
  and now() between od.start_date 
  and if(
    od.post_end > od.end_date, od.post_end, 
    od.end_date
  ) 
  join products p on p.product_id = od.product_id 
  and p.product_group_id 
  and p.program_id = ".SMARTY_ANTS_PROGRAM." 
  join account_order_summary aos on aos.account_id = od.account_id 
  and aos.order_detail_id = od.order_detail_id 
where 
  o.status = 0 
group by 
  account_id 
having 
  sum(aos.student_licenses) > 0</td><td></td><td></td></tr>
   <tr><td>cron/sa_products.php:62</td><td>create table tech.fm_00612920_textbook_smartyants 
select 
  a.account_id, 
  a.textbook_alignment_products, 
  tay.academic_year_name 'txtbk_ay', 
  ifnull(b.sa_licenses, '') 'smartyants_licenses', 
  ifnull(say.academic_year_name, '') 'sa_ay' 
From 
  tech.fm_00612920_textbooks a 
  join academic_years tay on a.txtbk_ay = tay.academic_year_id 
  left join tech.fm_00612920_smartyants b on a.account_id = b.account_id 
  left join academic_years say on say.academic_year_id = b.sa_ay 
UNION 
select 
  b.account_id, 
  ifnull(
    a.textbook_alignment_products, ''
  ), 
  ifnull(tay.academic_year_name, '') 'txtbk_ay', 
  b.sa_licenses, 
  say.academic_year_name 
From 
  tech.fm_00612920_textbooks a 
  left join academic_years tay on a.txtbk_ay = tay.academic_year_id 
  right join tech.fm_00612920_smartyants b on a.account_id = b.account_id 
  join academic_years say on say.academic_year_id = b.sa_ay</td><td></td><td></td></tr>
   <tr><td>cron/sa_products.php:89</td><td>SELECT 
  CONCAT(
    \ "create table tech.fm_00612920_final_results SELECT account_id 'Account ID', sa_ay 'SA AY', if(smartyants_licenses = 9999, 'Unlimited', smartyants_licenses) 'SA Licenses', txtbk_ay 'Textbook Products AY',\",
query_text,
\" FROM tech.fm_00612920_textbook_smartyants;\"
) final_query into @querytext
FROM 
(
SELECT GROUP_CONCAT(DISTINCT CONCAT(\"IF(FIND_IN_SET('\",
IFNULL(pr.program_name, pl.product_line_str),
\"', textbook_alignment_products)>0,'Yes','') AS '\", 
IFNULL(pr.program_name, pl.product_line_str),\"'\") )query_text
FROM products p
JOIN product_lines pl ON pl.product_line_id = p.product_line_id 
LEFT JOIN programs pr ON pr.program_id = p.program_id AND pl.product_line_id IN(3, 4, 11)
WHERE product_group_id = 61
) a;</td><td></td><td></td></tr>
   <tr><td>cron/trainings_num_attendees.php:10</td><td>CREATE TABLE mykidbiz_tmp.training_attendees 
SELECT 
  ts.training_id, 
  t.school_id, 
  count(distinct tst.trainee_id) num_attendees 
FROM 
  $db_pick.training_session_trainees tst, 
  $db_pick.trainees t, 
  $db_pick.training_session ts 
WHERE 
  tst.trainee_id = t.trainee_id 
  AND tst.training_id = ts.training_id 
  AND training_date >= DATE_ADD(
    curdate(), 
    INTERVAL -2 DAY
  ) 
GROUP BY 
  ts.training_id, 
  t.school_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:474</td><td>CREATE TABLE tech.wu_user_summary (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY(user_id), 
  KEY(district_id), 
  KEY(school_id), 
  KEY(daily_date)
) ENGINE = INNODB 
SELECT 
  * 
FROM 
  summary.ytd_user_summary 
WHERE 
  daily_date BETWEEN '".date("Y-m-d", $start_date)."' 
  AND '".date("Y-m-d", $end_date)."'</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:490</td><td>CREATE TABLE tech.wu_user_summary_time (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY(user_id), 
  KEY(class_id)
) ENGINE = INNODB 
SELECT 
  * 
FROM 
  summary.ytd_user_time 
WHERE 
  daily_date BETWEEN '".date("Y-m-d", $start_date)."' 
  AND '".date("Y-m-d", $end_date)."'</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:506</td><td>CREATE TABLE tech.wu_order_details_all (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY(order_id), 
  KEY(order_detail_id), 
  KEY(account_id)
) ENGINE = INNODB 
SELECT 
  DISTINCT od.*, 
  ay.end_date academic_year_end, 
  ay.summer, 
  o.opportunity_product_id, 
  p.program_id, 
  max(
    if (pe.product_id is not null, 1, 0)
  ) special_editions, 
  if (x.order_id is not null, 'Y', 'N') reportable_exclude, 
  IF(
    pre.order_detail_id IS NOT NULL 
    AND $start_date_str > od.end_date, 
    1, 
    0
  ) renewal_extension 
FROM 
  (
    interlink.order_details od, interlink.orders o, 
    interlink.products p
  ) 
  LEFT JOIN $db_pick.editions e ON (p.program_id = e.program_id) 
  LEFT JOIN interlink.product_editions pe ON (
    p.product_id = pe.product_id 
    AND e.edition_id = pe.edition_id
  ) 
  LEFT JOIN interlink.academic_years ay ON (
    ay.academic_year_id = od.academic_year_id
  ) 
  LEFT JOIN interlink.order_reportable_excludes x ON (o.order_id = x.order_id) 
  LEFT JOIN interlink.pre_post_adjustment_info pre ON pre.order_detail_id = od.order_detail_id 
  AND pre.adjust_reason_id IN(6, 7, 8) #Renewal Extensions
WHERE 
  od.status = 0 
  AND o.order_id = od.order_id 
  AND o.status = 0 
  AND p.product_id = od.product_id 
  AND p.program_id <> ".SMARTY_ANTS_PROGRAM." ### exclude smarty ants
  ".($accounts ? (" 
  AND od.account_id IN($accounts) ") : "")." 
GROUP BY 
  od.order_detail_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:547</td><td>CREATE TABLE tech.wu_order_details (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (order_id), 
  KEY (order_detail_id), 
  KEY (account_id)
) ENGINE = INNODB 
SELECT 
  od.* 
FROM 
  (tech.wu_order_details_all od) 
WHERE 
  $start_date_str <= if(
    od.post_end > od.end_date, od.post_end, 
    od.end_date
  ) 
  AND $end_date_str >= od.start_date</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:560</td><td>CREATE TABLE tech.wu_account_orders (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (account_id), 
  KEY (order_id)
) ENGINE = INNODB 
SELECT 
  DISTINCT od.account_id, 
  od.program_id, 
  od.academic_year_id, 
  od.order_id 
FROM 
  tech.wu_order_details od</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:572</td><td>CREATE TABLE tech.wu_account_summary (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (account_id)
) ENGINE = INNODB 
SELECT 
  ao.account_id, 
  ao.program_id, 
  ao.academic_year_id, 
  sum(os.order_total) order_total 
FROM 
  tech.wu_account_orders ao, 
  interlink.order_summary os 
WHERE 
  ao.order_id = os.order_id 
GROUP BY 
  ao.account_id, 
  ao.program_id, 
  ao.academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:588</td><td>CREATE TABLE tech.wu_school_timezones (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (school_id)
) ENGINE = INNODB 
SELECT 
  s.school_id, 
  tz.time_zone_name time_zone 
FROM 
  $db_pick.districts d, 
  $db_pick.schools s, 
  $db_pick.state_timezone st, 
  $db_pick.time_zones tz 
WHERE 
  s.district_id = d.district_id 
  AND s.state_code = st.state 
  AND if(
    d.district_timezone = 0 
    OR s.state_code != d.state_code, 
    st.time_zone_id, 
    d.district_timezone
  ) = tz.time_zone_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:603</td><td>CREATE TABLE tech.wu_schools (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (school_id), 
  key(account_id)
) ENGINE = INNODB 
SELECT 
  DISTINCT schools.district_id, 
  schools.school_id, 
  schools.account_id, 
  MIN(ay.summer) summer_only, 
  group_concat(distinct od.order_id) order_id, 
  tz.time_zone 
FROM 
  (
    $db_pick.districts, $db_pick.schools, 
    tech.wu_school_timezones tz
  ) 
  LEFT JOIN interlink.accounts a ON (
    a.account_id = schools.account_id
  ) 
  LEFT JOIN tech.wu_order_details od ON (
    a.account_id = od.account_id 
    AND od.academic_year_id > 0 
    AND '".date(' Y - m - d ',$start_date)."' <= IF(
      od.post_end > od.end_date, od.post_end, 
      od.end_date
    ) 
    AND '".date(' Y - m - d ',$end_date)."' >= od.start_date
  ) 
  LEFT JOIN academic_years ay ON (
    ay.academic_year_id = od.academic_year_id
  ) 
  LEFT JOIN $db_pick.school_profile ON (
    schools.school_id = school_profile.school_id 
    AND school_profile.profile_start < school_profile.profile_end 
    AND $start_date_str <= IF(
      school_profile.post_end > school_profile.profile_end, 
      convert_tz(
        school_profile.post_end, '$SERVER_TIMEZONE', 
        tz.time_zone
      ), 
      convert_tz(
        school_profile.profile_end, '$SERVER_TIMEZONE', 
        tz.time_zone
      )
    ) 
    AND $end_date_str >= convert_tz(
      school_profile.profile_start, '$SERVER_TIMEZONE', 
      tz.time_zone
    )
  ) 
WHERE 
  districts.district_id = schools.district_id 
  AND schools.school_id = tz.school_id 
  AND districts.user_type IN (1, 2) 
  AND districts.district_id NOT IN (48, 78, 129, 132, 196, 14) 
  AND school_name != '' 
  AND school_name NOT LIKE '%demo school%' 
  AND a.account_type <> 16 
  AND (
    od.account_id IS NULL 
    OR od.reportable_exclude <> 'Y'
  ) 
  AND (
    (
      school_profile.school_id IS NOT NULL 
      AND school_profile.order_detail_id = 39096
    ) # temp orders
    OR od.account_id IS NOT NULL
  ) ".($accounts ? (" 
  AND schools.account_id IN($accounts) ") : "")." 
GROUP BY 
  schools.district_id, 
  schools.school_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:641</td><td>CREATE TABLE tech.wu_order_detail_program (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (order_detail_id)
) ENGINE = INNODB 
SELECT 
  od.order_detail_id, 
  IF (
    od3.program_id IS NOT NULL, 
    od3.program_id, 
    IF (
      od2.program_id IS NOT NULL, 
      od2.program_id, 
      IF (
        od.opportunity_product_id = 2, 2, 1
      )
    )
  ) program_id 
FROM 
  (
    tech.wu_order_details_all od, account_order_summary aos, 
    tech.wu_schools s
  ) 
  LEFT JOIN tech.wu_order_details_all od2 ON (
    od.order_id = od2.order_id 
    AND od.account_id = od2.account_id 
    AND od.academic_year_id = od2.academic_year_id 
    AND od2.program_id > 0
  ) 
  LEFT JOIN tech.wu_order_details_all od3 ON (
    od2.order_id IS NULL 
    AND od.account_id = od3.account_id 
    AND od.academic_year_id = od3.academic_year_id 
    AND od3.program_id > 0
  ) 
WHERE 
  od.order_detail_id = aos.order_detail_id 
  AND aos.purchased_pd > 0 
  AND s.account_id = aos.account_id 
  AND od.program_id = 0 
GROUP BY 
  od.order_detail_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:677</td><td>CREATE TABLE tech.wu_account_pd (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (account_id)
) ENGINE = INNODB 
SELECT 
  aos.account_id, 
  od.program_id, 
  od.academic_year_id, 
  sum(purchased_pd) purchased_pd, 
  sum(scheduled_pd) scheduled_pd, 
  sum(fulfilled_pd) fulfilled_pd, 
  sum(
    initial_purchased_pd + followup_purchased_pd
  ) onsite_purchased_pd, 
  sum(
    initial_online_purchased_pd + online_purchased_pd
  ) online_purchased_pd, 
  sum(onsite_scheduled_pd) onsite_scheduled_pd, 
  sum(online_scheduled_pd) online_scheduled_pd, 
  sum(
    online_remaining_pd + onsite_remaining_pd
  ) remaining_pls 
FROM 
  interlink.account_order_summary aos, 
  tech.wu_order_details_all od 
WHERE 
  od.order_detail_id = aos.order_detail_id 
GROUP BY 
  aos.account_id, 
  od.program_id, 
  od.academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:707</td><td>CREATE TABLE tech.wu_account_academic_year (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  key(account_id), 
  key(program_id), 
  key(academic_year_id)
) ENGINE = INNODB 
SELECT 
  od.account_id, 
  od.program_id, 
  IF (
    COUNT(DISTINCT od.academic_year_id) > 1, 
    IF (
      COUNT(DISTINCT od2.academic_year_id) = 1, 
      od2.academic_year_id, 
      MAX(od.academic_year_id)
    ), 
    od.academic_year_id
  ) academic_year_id 
FROM 
  tech.wu_order_details od 
  LEFT JOIN tech.wu_order_details od2 ON (
    od.account_id = od2.account_id 
    AND od.program_id = od2.program_id 
    AND $start_date_str <= od2.end_date 
    AND od2.academic_year_id > 0
  ) 
WHERE 
  od.academic_year_id > 0 
GROUP BY 
  od.account_id, 
  od.program_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:727</td><td>CREATE TABLE tech.wu_account_orders (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (account_id), 
  KEY(program_id)
) ENGINE = INNODB 
SELECT 
  DISTINCT od.account_id, 
  od.program_id, 
  od.order_id, 
  od.start_date, 
  if(
    od.post_end > od.start_date, od.post_end, 
    od.end_date
  ) end_date 
FROM 
  (
    tech.wu_order_details od, tech.wu_account_academic_year ay
  ) 
WHERE 
  ay.account_id = od.account_id 
  AND ay.program_id = od.program_id 
  AND ay.academic_year_id = od.academic_year_id 
  AND od.reportable_exclude = 'N' 
GROUP BY 
  od.account_id, 
  od.program_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:745</td><td>CREATE TABLE tech.wu_subscriber_profile_tz (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (user_id), 
  KEY(school_id), 
  KEY(district_id)
) ENGINE = INNODB 
SELECT 
  sp.*, 
  0 district_id, 
  '                                 ' time_zone 
FROM 
  $db_pick.subscriber_profile sp 
WHERE 
  sp.profile_end > date_sub($start_date_str, interval 2 day) 
  /*AND sp.profile_start < date_add($end_date_str, interval 2 day)*/</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:768</td><td>CREATE TABLE $tmp_users_all (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (user_id), 
  KEY(school_id, user_id), 
  KEY(district_id, user_id)
) ENGINE = INNODB 
SELECT 
  DISTINCT s.district_id, 
  sp.school_id, 
  s.user_id, 
  s.subscriber_type 
FROM 
  (
    $db_pick.subscriber s, tech.wu_subscriber_profile_tz sp
  ) 
  LEFT JOIN tech.wu_schools sc ON (sp.school_id = sc.school_id) 
  LEFT JOIN tech.wu_account_orders o ON (sc.account_id = o.account_id) 
WHERE 
  s.user_id = sp.user_id 
  AND s.district_id = sp.district_id 
  AND(
    sp.grade_level <> 1 
    OR s.district_id <> 233
  ) 
  AND (
    $start_date_str < s.subscription_end
  ) 
  AND $start_date_str < convert_tz(
    sp.profile_end, '$SERVER_TIMEZONE', 
    sp.time_zone
  ) 
  AND (
    $end_date_str > convert_tz(
      sp.profile_start, '$SERVER_TIMEZONE', 
      sp.time_zone
    ) 
    OR (
      $end_date_str <= convert_tz(
        sp.profile_start, '$SERVER_TIMEZONE', 
        sp.time_zone
      ) ### future users
      AND o.start_date <= convert_tz(
        sp.profile_end, '$SERVER_TIMEZONE', 
        sp.time_zone
      ) 
      AND o.end_date >= convert_tz(
        sp.profile_start, '$SERVER_TIMEZONE', 
        sp.time_zone
      )
    )
  ) 
  AND (
    sp.system_generated = 'Y' 
    OR $end_date_str BETWEEN convert_tz(
      sp.profile_start, '$SERVER_TIMEZONE', 
      sp.time_zone
    ) 
    AND convert_tz(
      sp.profile_end, '$SERVER_TIMEZONE', 
      sp.time_zone
    )
  ) 
  AND s.status = 0</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:811</td><td>CREATE TABLE tech.wu_classes_tz (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (class_id)
) ENGINE = INNODB 
SELECT 
  c.*, 
  tz.time_zone 
FROM 
  $db_pick.classes c, 
  tech.wu_schools tz 
WHERE 
  tz.school_id = c.school_id 
  AND c.status in (0, 2) 
  AND c.class_id not in ($classIds)</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:826</td><td>CREATE TABLE tech.wu_subscriber_class_tz (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (user_id), 
  KEY (class_id)
) ENGINE = INNODB 
SELECT 
  sc.*, 
  0 school_id, 
  '                             ' time_zone 
FROM 
  $db_pick.subscriber_class sc 
WHERE 
  sc.profile_end > date_sub($start_date_str, interval 2 day) 
  AND sc.class_id not in ($classIds) 
  /**--us34738--**/
  
  /*AND sc.profile_start < date_add($end_date_str, interval 2 day)*/</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:848</td><td>CREATE TABLE tech.wu_subscriber_class (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (user_id), 
  KEY (class_id)
) ENGINE = INNODB 
SELECT 
  DISTINCT a.district_id, 
  a.school_id, 
  sc.class_id, 
  a.user_id, 
  a.subscriber_type 
FROM 
  (
    $tmp_users_all a, tech.wu_subscriber_class_tz sc, 
    tech.wu_classes_tz c, $db_pick.class_profile cp
  ) 
  LEFT JOIN tech.wu_schools s ON (s.school_id = a.school_id) 
  LEFT JOIN tech.wu_account_orders o ON (s.account_id = o.account_id) 
WHERE 
  a.user_id = sc.user_id 
  AND c.class_id = sc.class_id 
  AND $start_date_str < convert_tz(
    sc.profile_end, '$SERVER_TIMEZONE', 
    sc.time_zone
  ) 
  AND (
    $end_date_str > convert_tz(
      sc.profile_start, '$SERVER_TIMEZONE', 
      sc.time_zone
    ) 
    OR (
      $end_date_str <= convert_tz(
        sc.profile_start, '$SERVER_TIMEZONE', 
        sc.time_zone
      ) ### future users
      AND o.start_date <= convert_tz(
        sc.profile_end, '$SERVER_TIMEZONE', 
        sc.time_zone
      ) 
      AND o.end_date >= convert_tz(
        sc.profile_start, '$SERVER_TIMEZONE', 
        sc.time_zone
      )
    )
  ) 
  AND (
    sc.system_generated = 'Y' 
    OR $end_date_str BETWEEN convert_tz(
      sc.profile_start, '$SERVER_TIMEZONE', 
      sc.time_zone
    ) 
    AND convert_tz(
      sc.profile_end, '$SERVER_TIMEZONE', 
      sc.time_zone
    )
  ) 
  AND a.school_id = sc.school_id 
  AND c.class_id = cp.class_id 
  AND $start_date_str < convert_tz(
    cp.profile_end, '$SERVER_TIMEZONE', 
    c.time_zone
  ) 
  AND (
    $end_date_str > convert_tz(
      cp.profile_start, '$SERVER_TIMEZONE', 
      c.time_zone
    ) 
    OR (
      $end_date_str <= convert_tz(
        cp.profile_start, '$SERVER_TIMEZONE', 
        c.time_zone
      ) ### future users
      AND o.start_date <= convert_tz(
        cp.profile_end, '$SERVER_TIMEZONE', 
        c.time_zone
      ) 
      AND o.end_date >= convert_tz(
        cp.profile_start, '$SERVER_TIMEZONE', 
        c.time_zone
      )
    )
  ) 
GROUP BY 
  sc.class_id, 
  a.user_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:884</td><td>CREATE TABLE $tmp_users (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (user_id), 
  KEY(school_id, user_id), 
  KEY(district_id, user_id)
) ENGINE = INNODB 
SELECT 
  DISTINCT district_id, 
  school_id, 
  user_id, 
  subscriber_type 
FROM 
  tech.wu_subscriber_class</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:933</td><td>CREATE TABLE tech.wu_user_programs (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (user_id), 
  KEY(school_id)
) ENGINE = INNODB 
SELECT 
  DISTINCT sc.user_id, 
  t.subscriber_type, 
  sc.school_id, 
  c.program_id, 
  max(
    if (
      se.user_id is not null, 
      1, 
      if (se2.user_id is not null, 1, 0)
    )
  ) special_editions 
FROM 
  (
    $tmp_users_all t, tech.wu_subscriber_class sc, 
    tech.wu_account_usage u, $db_pick.classes c
  ) 
  LEFT JOIN tech.wu_account_orders o ON (
    u.account_id = o.account_id 
    AND u.program_id = o.program_id
  ) 
  LEFT JOIN $db_pick.subscriber_editions se ON (
    sc.user_id = se.user_id 
    AND $edition_str 
    AND u.school_id = se.school_id 
    AND (
      $start_date_str < convert_tz(
        se.end_date, '$SERVER_TIMEZONE', 
        u.time_zone
      ) 
      OR se.end_date = 0
    ) 
    AND $end_date_str > CONVERT_TZ(
      se.start_date, 'US/Eastern', u.time_zone
    )
  ) 
  LEFT JOIN $db_pick.subscriber_editions se2 ### future users
  ON (
    se.user_id IS NULL 
    AND sc.user_id = se2.user_id 
    AND " . str_replace(" IF (
      se ", " IF (
        se2 ", $edition_str) . " 
        AND u.school_id = se2.school_id 
        AND (
          $start_date_str < convert_tz(
            se2.end_date, '$SERVER_TIMEZONE', 
            u.time_zone
          ) 
          OR se2.end_date = 0
        ) 
        AND $end_date_str <= CONVERT_TZ(
          se2.start_date, 'US/Eastern', u.time_zone
        ) 
        AND (
          o.start_date <= CONVERT_TZ(
            se2.end_date, 'US/Eastern', u.time_zone
          ) 
          OR se2.end_date = 0
        ) 
        AND o.end_date >= CONVERT_TZ(
          se2.start_date, 'US/Eastern', u.time_zone
        )
      ) 
      WHERE 
        u.school_id = sc.school_id 
        AND c.class_id = sc.class_id 
        AND t.user_id = sc.user_id 
        AND c.program_id = u.program_id 
      GROUP BY 
        sc.user_id, 
        sc.school_id, 
        c.program_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1016</td><td>CREATE TABLE tech.wu_user_max_lit_program (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (user_id, school_id)
) ENGINE = INNODB 
SELECT 
  user_id, 
  school_id, 
  MAX(program_id) max_lit_program_id 
FROM 
  tech.wu_user_programs 
WHERE 
  program_id IN(
    " . implode(", ", $LITERACY_PROGRAMS) . "
  ) 
GROUP BY 
  user_id, 
  school_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1154</td><td>CREATE TABLE counts_temp (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (school_id), 
  KEY(district_id)
) ENGINE = INNODB 
SELECT 
  $tmp_users.district_id, 
  $tmp_users.school_id, 
  up.program_id, 
  up.special_editions, 
  COUNT(
    DISTINCT IF (
      up.subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "', 
      $tmp_users.user_id, NULL
    )
  ) total, 
  COUNT(
    DISTINCT IF (
      up.subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "', 
      $tmp_users.user_id, NULL
    )
  ) total2, 
  COUNT(
    DISTINCT IF (
      up.subscriber_type = '" . $SUBSCRIBER_TYPES["teacher"] . "', 
      $tmp_users.user_id, NULL
    )
  ) total3, 
  COUNT(
    DISTINCT IF (
      up.subscriber_type = '" . $SUBSCRIBER_TYPES["school"] . "', 
      $tmp_users.user_id, NULL
    )
  ) total4 
FROM 
  $tmp_users, 
  tech.wu_user_programs up, 
  tech.wu_account_usage u 
WHERE 
  $tmp_users.school_id = u.school_id 
  AND $tmp_users.district_id = u.district_id 
  AND $tmp_users.user_id = up.user_id 
  AND $tmp_users.school_id = up.school_id 
GROUP BY 
  $tmp_users.district_id, 
  $tmp_users.school_id, 
  up.program_id, 
  up.special_editions</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1189</td><td>CREATE TABLE counts_temp (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (school_id), 
  KEY (district_id)
) ENGINE = INNODB 
SELECT 
  $tmp_users_all.district_id, 
  $tmp_users_all.school_id, 
  up.program_id, 
  up.special_editions, 
  COUNT(
    DISTINCT IF (
      up.subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "', 
      $tmp_users_all.user_id, NULL
    )
  ) total2, 
  COUNT(
    DISTINCT IF (
      up.subscriber_type = '" . $SUBSCRIBER_TYPES["teacher"] . "', 
      $tmp_users_all.user_id, NULL
    )
  ) total3 
FROM 
  $tmp_users_all, 
  tech.wu_account_usage u, 
  tech.wu_user_programs up 
WHERE 
  $tmp_users_all.school_id = u.school_id 
  AND $tmp_users_all.district_id = u.district_id 
  AND $tmp_users_all.user_id = up.user_id 
  AND $tmp_users_all.school_id = up.school_id 
GROUP BY 
  $tmp_users_all.district_id, 
  $tmp_users_all.school_id, 
  up.program_id, 
  up.special_editions</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1221</td><td>CREATE TABLE tech.wu_login_users (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (school_id)
) ENGINE = INNODB 
SELECT 
  DISTINCT s.district_id, 
  s.school_id, 
  up.program_id, 
  up.special_editions, 
  s.user_id, 
  sum(s.total_logins) total, 
  min(daily_date) first_login, 
  max(daily_date) last_login 
FROM 
  tech.wu_user_summary s, 
  tech.wu_user_programs up 
WHERE 
  s.total_logins > 0 
  AND s.daily_date BETWEEN $start_date_str 
  AND $end_date_str 
  AND s.user_id = up.user_id 
  AND s.program_id = up.program_id 
GROUP BY 
  s.school_id, 
  up.program_id, 
  up.special_editions, 
  s.user_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1241</td><td>CREATE TABLE counts_temp (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (school_id), 
  KEY(district_id)
) ENGINE = INNODB 
SELECT 
  DISTINCT l.district_id, 
  l.school_id, 
  l.program_id, 
  l.special_editions, 
  count(distinct l.user_id) login_users, 
  sum(l.total) total, 
  min(l.first_login) first_login, 
  max(l.last_login) last_login 
FROM 
  $tmp_users tmp_users, 
  tech.wu_login_users l 
where 
  l.user_id = tmp_users.user_id 
  AND l.school_id = tmp_users.school_id 
  and tmp_users.subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "' 
GROUP BY 
  l.school_id, 
  l.program_id, 
  l.special_editions</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1273</td><td>CREATE TABLE tech.wu_login_log_active (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  key(district_id, user_id), 
  key(school_id, user_id), 
  key(class_id, user_id)
) ENGINE = INNODB 
SELECT 
  s.district_id, 
  s.school_id, 
  up.program_id, 
  up.special_editions, 
  if (c.class_id is null, 0, s.class_id) class_id, 
  s.user_id, 
  $tmp_users.subscriber_type, 
  sum(s.total_logins) total_logins 
FROM 
  (
    tech.wu_user_summary s, $tmp_users, 
    tech.wu_account_usage u, tech.wu_user_programs up
  ) 
  LEFT JOIN tech.wu_subscriber_class sc on (
    s.user_id = sc.user_id 
    AND s.class_id = sc.class_id
  ) 
  LEFT JOIN $db_pick.classes c ON (
    c.class_id = sc.class_id 
    AND c.program_id = up.program_id
  ) 
WHERE 
  s.total_logins > 0 
  AND s.daily_date BETWEEN $start_date_str 
  AND $end_date_str 
  AND s.user_id = $tmp_users.user_id 
  AND s.school_id = u.school_id 
  AND s.school_id = $tmp_users.school_id 
  AND s.user_id = up.user_id 
  AND s.school_id = up.school_id 
  AND s.program_id = up.program_id 
  AND $tmp_users.subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "' 
GROUP BY 
  s.user_id, 
  s.school_id, 
  s.class_id, 
  up.program_id, 
  up.special_editions</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1303</td><td>CREATE TABLE tech.wu_login_log_active_teachers (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id)
) ENGINE = INNODB 
SELECT 
  DISTINCT s.daily_date, 
  s.district_id, 
  s.school_id, 
  up.program_id, 
  up.special_editions, 
  s.class_id, 
  s.user_id, 
  $tmp_users.subscriber_type, 
  s.total_logins 
FROM 
  (
    tech.wu_user_summary s, $tmp_users, 
    tech.wu_account_usage u, tech.wu_user_programs up
  ) 
  LEFT JOIN tech.wu_subscriber_class sc on (
    s.user_id = sc.user_id 
    AND s.class_id = sc.class_id
  ) 
  LEFT JOIN $db_pick.classes c ON (
    c.class_id = sc.class_id 
    AND c.program_id = up.program_id
  ) 
WHERE 
  s.total_logins > 0 
  AND s.daily_date BETWEEN $start_date_str 
  AND $end_date_str 
  AND s.user_id = $tmp_users.user_id 
  AND s.school_id = u.school_id 
  AND s.school_id = $tmp_users.school_id 
  AND s.user_id = up.user_id 
  AND s.school_id = up.school_id 
  AND s.program_id = up.program_id 
  AND $tmp_users.subscriber_type <> '" . $SUBSCRIBER_TYPES["student"] . "'</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1366</td><td>CREATE TABLE tech.wu_active_users (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (school_id), 
  KEY (program_id), 
  KEY (special_editions)
) ENGINE = INNODB 
SELECT 
  district_id, 
  school_id, 
  user_id, 
  subscriber_type, 
  program_id, 
  special_editions, 
  sum(total_logins) total_logins 
FROM 
  tech.wu_login_log_active 
GROUP BY 
  district_id, 
  school_id, 
  user_id, 
  program_id, 
  special_editions 
HAVING 
  (
    subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "' 
    AND total_logins >= '$num_logins'
  ) 
  OR (
    subscriber_type <> '" . $SUBSCRIBER_TYPES["student"] . "' 
    AND total_logins >= '$num_teacher_logins'
  )</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1382</td><td>CREATE TABLE counts_temp (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (school_id), 
  KEY(district_id)
) ENGINE = INNODB 
SELECT 
  district_id, 
  school_id, 
  program_id, 
  special_editions, 
  COUNT(
    DISTINCT IF (
      subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "', 
      user_id, NULL
    )
  ) total_students, 
  COUNT(
    DISTINCT IF (
      subscriber_type = '" . $SUBSCRIBER_TYPES["teacher"] . "', 
      user_id, NULL
    )
  ) total_teachers, 
  COUNT(
    DISTINCT IF (
      subscriber_type = '" . $SUBSCRIBER_TYPES["school"] . "', 
      user_id, NULL
    )
  ) total_admins 
FROM 
  tech.wu_active_users 
GROUP BY 
  school_id, 
  program_id, 
  special_editions</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1409</td><td>CREATE TABLE counts_temp2 (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (school_id)
) ENGINE = INNODB 
SELECT 
  school_id, 
  program_id, 
  special_editions, 
  COUNT(
    DISTINCT IF (
      subscriber_type = '" . $SUBSCRIBER_TYPES["teacher"] . "', 
      user_id, NULL
    )
  ) total_teachers 
FROM 
  tech.wu_active_users 
GROUP BY 
  school_id, 
  program_id, 
  special_editions</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1502</td><td>CREATE TABLE tech.wu_assessment_completed (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (school_id), 
  KEY (program_id), 
  KEY (special_editions), 
  KEY (academic_year_id)
) ENGINE = INNODB 
SELECT 
  DISTINCT a.user_id, 
  p.program_id, 
  p.special_editions, 
  d.academic_year_id, 
  ast.assessment_date_id, 
  substring_index(
    max(
      concat(
        sp.profile_end, '|', sp.school_id
      )
    ), 
    '|', 
    -1
  ) school_id 
FROM 
  (
    $tmp_users_all a, tech.wu_subscriber_profile_tz sp, 
    $db_pick.assessment_score_totals ast, 
    tech.wu_user_programs p, tech.wu_assessment_dates d, 
    academic_years ay, tech.wu_schools s, 
    accounts ac
  ) 
  LEFT JOIN tech.wu_ls_check_schools c ON c.school_id = s.school_id 
  AND ay.academic_year_id = c.academic_year_id 
WHERE 
  a.user_id = ast.user_id 
  AND ast.assessment_date_id = d.assessment_date_id 
  AND ay.academic_year_id = d.academic_year_id 
  AND s.school_id = a.school_id 
  AND ac.account_id = s.account_id #US12087 fix for LS pre-test count. Count regular pre-test into summer bucket when taken during summer dates and count into academic year bucket when taken during regular school dates
  AND IF(
    c.school_id IS NOT NULL 
    AND d.assessment_id = 1, 
    IF(
      ay.summer = 0, 
      ast.time_ended <= concat(
        year(ay.end_date), 
        '-', 
        ac.school_end
      ), 
      ast.time_ended > concat(
        year(ay.end_date), 
        '-', 
        ac.school_end
      )
    ), 
    1
  ) 
  AND sp.user_id = a.user_id 
  AND sp.school_id = a.school_id 
  AND (
    $start_date_str < convert_tz(
      sp.profile_end, '$SERVER_TIMEZONE', 
      sp.time_zone
    ) 
    AND $end_date_str > convert_tz(
      sp.profile_start, '$SERVER_TIMEZONE', 
      sp.time_zone
    )
  ) 
  AND ast.time_ended < sp.profile_end 
  AND ast.time_ended < $end_date_str 
  AND a.subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "' 
  AND a.user_id = p.user_id 
GROUP BY 
  a.user_id, 
  ast.assessment_date_id, 
  p.program_id, 
  p.special_editions, 
  d.academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1532</td><td>CREATE TABLE counts_temp (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (school_id)
) ENGINE = INNODB 
SELECT 
  DISTINCT a.school_id, 
  a.program_id, 
  a.special_editions, 
  d.academic_year_id, 
  COUNT(
    DISTINCT if (
      d.assessment_id = '" . $ASSESSMENT["pre"] . "', 
      user_id, null
    )
  ) total_pre, 
  COUNT(
    DISTINCT if (
      d.assessment_id = '" . $ASSESSMENT["mid"] . "', 
      user_id, null
    )
  ) total_inter, 
  COUNT(
    DISTINCT if (
      d.assessment_id = '" . $ASSESSMENT["post"] . "', 
      user_id, null
    )
  ) total_post, 
  COUNT(
    DISTINCT if (
      d.assessment_id = '" . $ASSESSMENT["summer_pre"] . "', 
      user_id, null
    )
  ) total_summer_pre 
FROM 
  tech.wu_assessment_completed a, 
  tech.wu_assessment_dates d 
WHERE 
  a.assessment_date_id = d.assessment_date_id 
  AND a.academic_year_id = d.academic_year_id 
GROUP BY 
  a.school_id, 
  a.program_id, 
  a.special_editions, 
  d.academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1566</td><td>CREATE TABLE tech.wu_ls_users (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (user_id), 
  key(program_id), 
  key(school_id)
) ENGINE = INNODB 
SELECT 
  DISTINCT a.user_id, 
  a.program_id, 
  a.school_id 
FROM 
  tech.wu_assessment_completed a, 
  tech.wu_account_usage u 
WHERE 
  a.school_id = u.school_id 
  AND a.program_id = u.program_id 
  AND a.academic_year_id = u.academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1583</td><td>CREATE TABLE counts_temp (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id)
) ENGINE = INNODB 
SELECT 
  u.district_id, 
  u.school_id, 
  up.program_id, 
  up.special_editions, 
  count(distinct s.user_id) fidelity_users 
FROM 
  $tmp_users u, 
  tech.wu_user_programs up, 
  tech.wu_user_summary s, 
  tech.wu_ls_users l 
WHERE 
  u.user_id = up.user_id 
  AND s.user_id = up.user_id 
  AND s.school_id = up.school_id 
  AND s.school_id = u.school_id 
  AND s.program_id = up.program_id 
  AND s.daily_date BETWEEN '".date("Y-m-d", $start_date)."' 
  AND '".date("Y-m-d", $end_date)."' 
  AND u.subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "' 
  AND s.basic_news_activities > 0 
  AND u.user_id = l.user_id 
  AND u.school_id = l.school_id 
  AND s.program_id = l.program_id 
GROUP BY 
  u.district_id, 
  u.school_id, 
  up.program_id, 
  up.special_editions</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1619</td><td>CREATE TABLE tech.wu_classes_active_temp (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (class_id)
) ENGINE = INNODB 
SELECT 
  district_id, 
  school_id, 
  class_id, 
  COUNT(DISTINCT user_id) active_users 
FROM 
  tech.wu_login_log_active 
WHERE 
  subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "' 
  AND class_id > 0 
  AND class_id not in ($classIds) 
  /**--us34738--**/
GROUP BY 
  class_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1633</td><td>CREATE TABLE tech.wu_classes_active (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (class_id), 
  KEY(school_id, class_id), 
  KEY(district_id, class_id)
) ENGINE = INNODB 
SELECT 
  sc.district_id, 
  sc.school_id, 
  sc.class_id, 
  c.program_id, 
  count(sc.user_id) total_users, 
  tech.wu_classes_active_temp.active_users, 
  IF(
    count(sc.user_id)> 0, 
    (
      wu_classes_active_temp.active_users / count(sc.user_id)
    ), 
    0
  ) perc_active 
FROM 
  (
    tech.wu_subscriber_class sc, tech.wu_school_users u, 
    $db_pick.classes c
  ) 
  LEFT JOIN tech.wu_classes_active_temp ON (
    sc.class_id = wu_classes_active_temp.class_id
  ) 
WHERE 
  u.user_id = sc.user_id 
  AND u.subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "' 
  AND c.class_id = sc.class_id 
  AND c.class_id not in ($classIds) 
  /**--us34738--**/
GROUP BY 
  sc.class_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1653</td><td>CREATE TABLE counts_temp (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (district_id), 
  KEY(school_id)
) ENGINE = INNODB 
SELECT 
  a.district_id, 
  a.school_id, 
  a.program_id, 
  count(DISTINCT a.class_id) total_classes, 
  count(
    DISTINCT IF (
      perc_active >=.5, a.class_id, NULL
    )
  ) active_classes 
FROM 
  tech.wu_classes_active a 
GROUP BY 
  a.school_id, 
  a.program_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1678</td><td>CREATE TABLE tech.wu_classes_se (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (class_id), 
  KEY(school_id, class_id), 
  KEY(district_id, class_id)
) ENGINE = INNODB 
SELECT 
  sc.district_id, 
  sc.school_id, 
  sc.class_id, 
  c.program_id, 
  up.special_editions 
FROM 
  (
    tech.wu_subscriber_class sc, $db_pick.classes c, 
    tech.wu_user_programs up, tech.wu_school_users u
  ) 
WHERE 
  c.class_id = sc.class_id 
  AND sc.user_id = up.user_id 
  AND c.program_id = up.program_id 
  AND u.user_id = sc.user_id 
  AND up.school_id = sc.school_id 
  AND u.subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "' 
GROUP BY 
  sc.class_id, 
  c.program_id, 
  up.special_editions</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1697</td><td>CREATE TABLE counts_temp (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (school_id), 
  KEY(district_id)
) ENGINE = INNODB 
SELECT 
  a.district_id, 
  a.school_id, 
  a.program_id, 
  a.special_editions, 
  count(DISTINCT a.class_id) total_classes, 
  count(
    DISTINCT IF (
      perc_active >=.5, a.class_id, NULL
    )
  ) active_classes 
FROM 
  tech.wu_classes_se a, 
  tech.wu_classes_active b 
WHERE 
  a.class_id = b.class_id 
  AND a.program_id = b.program_id 
GROUP BY 
  a.school_id, 
  a.program_id, 
  a.special_editions</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1725</td><td>CREATE TABLE tech.wu_afterschool_users (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (school_id)
) ENGINE = INNODB 
SELECT 
  DISTINCT s.district_id, 
  s.school_id, 
  up.program_id, 
  up.special_editions, 
  s.user_id, 
  sum(
    s.afterschool_weekday_logins + s.afterschool_weekend_logins
  ) login_total 
FROM 
  tech.wu_user_summary s, 
  tech.wu_user_programs up 
WHERE 
  (
    s.afterschool_weekday_logins + s.afterschool_weekend_logins
  ) > 0 
  AND s.daily_date BETWEEN $start_date_str 
  AND $end_date_str 
  AND s.user_id = up.user_id 
  AND s.program_id = up.program_id 
GROUP BY 
  s.school_id, 
  up.program_id, 
  up.special_editions, 
  s.user_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1744</td><td>CREATE TABLE counts_temp (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (school_id), 
  KEY(district_id)
) ENGINE = INNODB 
SELECT 
  DISTINCT l.district_id, 
  l.school_id, 
  l.program_id, 
  l.special_editions, 
  count(distinct l.user_id) login_users, 
  sum(l.login_total) login_total 
FROM 
  $tmp_users tmp_users, 
  tech.wu_afterschool_users l 
where 
  l.user_id = tmp_users.user_id 
  AND l.school_id = tmp_users.school_id 
  and tmp_users.subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "' 
GROUP BY 
  l.school_id, 
  l.program_id, 
  l.special_editions</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1774</td><td>CREATE TABLE counts_temp (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (account_id)
) ENGINE = INNODB 
SELECT 
  od.account_id, 
  od.program_id, 
  od.special_editions, 
  od.academic_year_id, 
  group_concat(p.sf_product_id) as sf_product_id, 
  sum(aos.student_licenses) student_licenses 
FROM 
  tech.wu_order_details od, 
  interlink.account_order_summary aos, 
  interlink.products p 
WHERE 
  od.order_detail_id = aos.order_detail_id 
  AND p.product_id = od.product_id 
  AND aos.student_licenses > 0 
GROUP BY 
  od.account_id, 
  od.program_id, 
  od.special_editions, 
  od.academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1812</td><td>CREATE TABLE tech.wu_trainings (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (account_id), 
  KEY(event_id)
) ENGINE = INNODB 
SELECT 
  ea.account_id, 
  max(e.event_date) last_training_date, 
  substring_index(
    max(
      concat(
        e.event_date, 
        '|', 
        e.event_id, 
        '|', 
        concat(u.first_name, ' ', u.last_name)
      )
    ), 
    '|', 
    -1
  ) trainer, 
  substring_index(
    max(
      concat(e.event_date, '|', e.event_id)
    ), 
    '|', 
    -1
  ) event_id 
FROM 
  interlink.events e, 
  interlink.event_accounts ea, 
  interlink.event_accounts ea2, 
  interlink.event_users eu, 
  interlink.users u 
WHERE 
  e.event_id = ea.event_id 
  AND e.event_id = eu.event_id 
  AND u.user_id = eu.user_id 
  AND e.event_type_id = 1 
  AND e.event_date < now() 
  AND e.status = 0 
  AND e.event_status NOT IN ('X', 'T') 
  AND e.event_id = ea2.event_id ".($accounts ? (" 
  AND ea.account_id IN($accounts) ") : "")." 
GROUP BY 
  ea.account_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1841</td><td>CREATE TABLE tech.wu_event_info (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (account_id, event_id)
) ENGINE = INNODB 
SELECT 
  t.account_id, 
  t.event_id, 
  count(distinct ea.account_id) num_accounts, 
  GROUP_CONCAT(
    DISTINCT CONCAT(
      w.workshop_code, ' ', w.workshop_name
    ) 
    ORDER BY 
      w.workshop_code, 
      w.workshop_name SEPARATOR '; '
  ) last_training_session_title 
FROM 
  (
    tech.wu_trainings t, event_accounts ea
  ) 
  LEFT JOIN event_workshops ew ON (t.event_id = ew.event_id) 
  LEFT JOIN workshops w ON (w.workshop_id = ew.workshop_id) 
WHERE 
  t.event_id = ea.event_id 
GROUP BY 
  t.account_id, 
  t.event_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1866</td><td>CREATE TABLE tech.wu_events (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (account_id), 
  KEY(event_id)
) ENGINE = INNODB 
SELECT 
  ea.account_id, 
  max(e.event_date) last_event_date, 
  substring_index(
    max(
      concat(
        e.event_date, '|', et.event_type_name
      )
    ), 
    '|', 
    -1
  ) last_event_type, 
  substring_index(
    max(
      concat(
        e.event_date, 
        '|', 
        e.event_id, 
        '|', 
        concat(u.first_name, ' ', u.last_name)
      )
    ), 
    '|', 
    -1
  ) trainer, 
  substring_index(
    max(
      concat(e.event_date, '|', e.event_id)
    ), 
    '|', 
    -1
  ) event_id 
FROM 
  interlink.events e, 
  interlink.event_accounts ea, 
  interlink.event_users eu, 
  interlink.users u, 
  interlink.event_types et 
WHERE 
  e.event_id = ea.event_id 
  AND e.event_id = eu.event_id 
  AND u.user_id = eu.user_id 
  AND e.event_type_id <> 1 
  AND e.event_date <= '" . date("Y-m-d", $end_date) . "' 
  AND e.status = 0 
  AND e.event_status NOT IN ('X', 'T') 
  AND et.event_type_id = e.event_type_id ".($accounts ? (" 
  AND ea.account_id IN($accounts) ") : "")." 
GROUP BY 
  ea.account_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1896</td><td>CREATE TABLE tech.wu_event_info (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (account_id), 
  KEY (event_id)
) ENGINE = INNODB 
SELECT 
  t.account_id, 
  t.event_id, 
  GROUP_CONCAT(
    DISTINCT CONCAT(
      w.workshop_code, ' ', w.workshop_name
    ) 
    ORDER BY 
      w.workshop_code, 
      w.workshop_name SEPARATOR '; '
  ) last_event_session_title 
FROM 
  (tech.wu_events t) 
  LEFT JOIN event_workshops ew ON (t.event_id = ew.event_id) 
  LEFT JOIN workshops w ON (w.workshop_id = ew.workshop_id) 
GROUP BY 
  t.account_id, 
  t.event_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1919</td><td>CREATE TABLE tech.wu_next_event (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  key(account_id), 
  key(event_id)
) ENGINE = INNODB 
SELECT 
  ea.account_id, 
  substring_index(
    min(
      concat(
        e.event_date, 
        '|', 
        LPAD(e.event_type_id, 2, 0), 
        '|', 
        e.event_id, 
        '|', 
        e.event_date
      )
    ), 
    '|', 
    -1
  ) next_event_date, 
  substring_index(
    min(
      concat(
        e.event_date, 
        '|', 
        LPAD(e.event_type_id, 2, 0), 
        '|', 
        e.event_id, 
        '|', 
        et.event_type_name
      )
    ), 
    '|', 
    -1
  ) next_event_type, 
  substring_index(
    min(
      concat(
        e.event_date, 
        '|', 
        LPAD(e.event_type_id, 2, 0), 
        '|', 
        e.event_id, 
        '|', 
        if(
          e.event_status = 'T', 
          'Tentative', 
          if(
            e.event_status = 'S', 
            'Scheduled', 
            if(
              e.event_status = 'C', 'Confirmed', 
              ''
            )
          )
        )
      )
    ), 
    '|', 
    -1
  ) next_event_status, 
  substring_index(
    min(
      concat(
        e.event_date, 
        '|', 
        LPAD(e.event_type_id, 2, 0), 
        '|', 
        e.event_id, 
        '|', 
        concat(u.first_name, ' ', u.last_name)
      )
    ), 
    '|', 
    -1
  ) next_event_trainer, 
  substring_index(
    min(
      concat(
        e.event_date, 
        '|', 
        LPAD(e.event_type_id, 2, 0), 
        '|', 
        e.event_id
      )
    ), 
    '|', 
    -1
  ) event_id 
FROM 
  interlink.events e, 
  interlink.event_accounts ea, 
  interlink.event_users eu, 
  interlink.users u, 
  interlink.event_types et 
WHERE 
  e.event_id = ea.event_id 
  AND e.event_id = eu.event_id 
  AND u.user_id = eu.user_id 
  AND e.event_date > '" . date("Y-m-d", $end_date) . "' 
  AND e.status = 0 
  AND e.event_status NOT IN (
    'X' 
    /*, 'T'*/
    ) ".($accounts ? (" 
  AND ea.account_id IN($accounts) ") : "")." 
  AND et.event_type_id = e.event_type_id 
GROUP BY 
  ea.account_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1949</td><td>CREATE TABLE tech.wu_next_event_titles (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  key(account_id), 
  key(event_id)
) ENGINE = INNODB 
SELECT 
  t.account_id, 
  t.event_id, 
  GROUP_CONCAT(
    DISTINCT CONCAT(
      w.workshop_code, ' ', w.workshop_name
    ) 
    ORDER BY 
      w.workshop_code, 
      w.workshop_name SEPARATOR '; '
  ) next_event_session_title 
FROM 
  (tech.wu_next_event t) 
  LEFT JOIN event_workshops ew ON (t.event_id = ew.event_id) 
  LEFT JOIN workshops w ON (w.workshop_id = ew.workshop_id) 
GROUP BY 
  t.account_id, 
  t.event_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:1975</td><td>CREATE TABLE counts_temp (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (school_id)
) ENGINE = INNODB 
SELECT 
  s.school_id, 
  up.program_id, 
  up.special_editions, 
  count(
    distinct if (
      (
        (
          s.basic_news_activities + s.biology_activities
        ) > 0
      ) 
      and (l.user_id IS NOT NULL), 
      s.user_id, 
      null
    )
  ) users, 
  sum(
    if(
      l.user_id IS NOT NULL, s.basic_news_activities + s.biology_activities, 
      0
    )
  ) activities, 
  sum(
    if (
      l.user_id IS NOT NULL, 
      (
        average_basic_news_score * basic_news_activities
      ) + (
        average_biology_score * s.biology_activities
      ), 
      0
    )
  ) / sum(
    if(
      l.user_id IS NOT NULL, basic_news_activities + s.biology_activities, 
      0
    )
  ) avg_score, 
  (
    (
      SUM(
        if(
          l.user_id IS NOT NULL, s.basic_news_activities + s.biology_activities, 
          0
        )
      )/ $num_weeks
    )/ u.total_students
  ) avg_weekly_activities, 
  sum(s.total_emails) total_emails, 
  sum(s.total_time) total_time, 
  round(
    sum(t.mail_time)/(
      sum(s.total_time)
    )* 100
  ) time_spent_mail, 
  round(
    sum(
      t.news_time + t.bonus_news_time + t.stretch_news_time
    )/(
      sum(s.total_time)
    )* 100
  ) time_spent_news, 
  round(
    sum(
      t.news_activity_time + t.bonus_activity_time + stretch_activity_time
    )/(
      sum(s.total_time)
    )* 100
  ) time_spent_news_mc, 
  round(
    sum(t.news_tq_time + t.bonus_tq_time)/(
      sum(s.total_time)
    )* 100
  ) time_spent_news_tq, 
  round(
    sum(t.biology_time)/(
      sum(s.total_time)
    )* 100
  ) time_spent_bio, 
  round(
    sum(t.biology_activity_time)/(
      sum(s.total_time)
    )* 100
  ) time_spent_bio_mc, 
  round(
    sum(t.biology_tq_time)/(
      sum(s.total_time)
    )* 100
  ) time_spent_bio_tq, 
  round(
    sum(t.writing_time)/(
      sum(s.total_time)
    )* 100
  ) time_spent_writing, 
  round(
    sum(t.stock_time)/(
      sum(s.total_time)
    )* 100
  ) time_spent_stocks, 
  round(
    sum(t.other_time)/(
      sum(s.total_time)
    )* 100
  ) time_spent_other 
FROM 
  (
    tech.wu_user_summary s, tech.wu_user_programs up, 
    tech.wu_account_usage u
  ) 
  LEFT JOIN tech.wu_user_summary_time t ON (
    s.user_id = t.user_id 
    and s.class_id = t.class_id 
    and s.daily_date = t.daily_date 
    AND s.school_id = t.school_id 
    AND s.program_id = t.program_id
  ) 
  LEFT JOIN tech.wu_ls_users l ON (
    s.user_id = l.user_id 
    AND s.school_id = l.school_id 
    AND up.program_id = l.program_id
  ) 
WHERE 
  s.user_id = up.user_id 
  AND s.school_id = up.school_id 
  AND s.program_id = up.program_id 
  AND s.daily_date BETWEEN '".date("Y-m-d", $start_date)."' 
  AND '".date("Y-m-d", $end_date)."' 
  AND up.subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "' 
  AND u.school_id = s.school_id 
  AND u.program_id = s.program_id 
  AND u.special_editions = up.special_editions 
GROUP BY 
  s.school_id, 
  up.program_id, 
  up.special_editions</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:2052</td><td>CREATE TABLE tech.wu_ytd_totals (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (user_id), 
  KEY (school_id), 
  KEY (class_id)
) ENGINE = INNODB 
SELECT 
  DISTINCT y.school_year, 
  y.user_id, 
  y.school_id, 
  y.class_id, 
  y.program_id, 
  y.basic_news_activities_YTD, 
  y.biology_activities_YTD 
FROM 
  summary.ytd_totals y, 
  tech.wu_school_users_all u, 
  tech.wu_ls_users l 
WHERE 
  u.user_id = y.user_id 
  AND u.school_id = y.school_id 
  AND u.subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "' 
  AND y.school_year IN (
    " . implode(", ", $school_years) . "
  ) 
  AND y.user_id = l.user_id 
  AND y.school_id = l.school_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:2123</td><td>CREATE TABLE tech.wu_user_activities (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (user_id), 
  KEY (program_id), 
  KEY (school_id)
) ENGINE = INNODB 
SELECT 
  t.school_id, 
  up.program_id, 
  up.special_editions, 
  t.user_id, 
  sum(
    basic_news_activities_YTD + biology_activities_YTD
  ) ytd_activities 
FROM 
  tech.wu_ytd_totals t, 
  tech.wu_user_programs up, 
  tech.wu_account_usage u, 
  academic_years ay 
WHERE 
  t.user_id = up.user_id 
  AND t.school_id = up.school_id 
  AND t.program_id = up.program_id 
  AND u.school_id = up.school_id 
  AND u.program_id = up.program_id 
  AND u.special_editions = up.special_editions 
  AND ay.academic_year_id = u.academic_year_id 
  AND t.school_year = year(ay.end_date) 
GROUP BY 
  t.school_id, 
  up.program_id, 
  up.special_editions, 
  t.user_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:2150</td><td>CREATE TABLE tech.wu_user_summary_sub (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY(school_id), 
  KEY(program_id), 
  KEY(user_id)
) ENGINE = INNODB 
SELECT 
  * 
FROM 
  summary.ytd_user_summary 
WHERE 
  daily_date BETWEEN '".date("Y-m-d", $end_date)."' 
  AND '".date("Y-m-d", $yesterday)."'</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:2164</td><td>CREATE TABLE tech.wu_user_activities_sub (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (user_id), 
  KEY (program_id), 
  KEY (school_id)
) ENGINE = INNODB 
SELECT 
  s.school_id, 
  s.program_id, 
  s.user_id, 
  sum(
    s.basic_news_activities + s.biology_activities
  ) activities 
FROM 
  tech.wu_user_summary_sub s, 
  tech.wu_ls_users l 
WHERE 
  (
    s.basic_news_activities + s.biology_activities
  ) > 0 
  AND s.user_id = l.user_id 
  AND s.school_id = l.school_id 
  AND s.program_id = l.program_id 
GROUP BY 
  s.school_id, 
  s.program_id, 
  s.user_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:2193</td><td>CREATE TABLE counts_temp (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (school_id)
) ENGINE = INNODB 
SELECT 
  a.school_id, 
  a.program_id, 
  a.special_editions, 
  count(
    if (
      ytd_activities BETWEEN 1 
      and 19, 
      1, 
      NULL
    )
  ) ytd_1_19_activity_users, 
  count(
    if (ytd_activities = 0, 1, NULL)
  ) ytd_0_activity_users, 
  count(
    if (
      ytd_activities BETWEEN 1 
      and 9, 
      1, 
      NULL
    )
  ) ytd_1_9_activity_users, 
  count(
    if (
      ytd_activities BETWEEN 10 
      and 19, 
      1, 
      NULL
    )
  ) ytd_10_19_activity_users, 
  count(
    if (
      ytd_activities BETWEEN 20 
      and 39, 
      1, 
      NULL
    )
  ) ytd_20_39_activity_users, 
  count(
    if (
      ytd_activities BETWEEN 30 
      and 39, 
      1, 
      NULL
    )
  ) ytd_30_39_activity_users, 
  count(
    if (
      ytd_activities BETWEEN 40 
      and 79, 
      1, 
      NULL
    )
  ) ytd_40_79_activity_users, 
  count(
    if (ytd_activities >= 80, 1, NULL)
  ) ytd_80_plus_activity_users 
FROM 
  tech.wu_user_activities a 
GROUP BY 
  a.school_id, 
  a.program_id, 
  a.special_editions</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:2229</td><td>CREATE TABLE tech.wu_order_info (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (account_id)
) ENGINE = INNODB 
SELECT 
  u.account_id, 
  u.program_id, 
  u.academic_year_id, 
  substring_index(
    max(
      concat(
        ay.end_date, 
        '|', 
        if (
          od_old.order_id IS NOT NULL, 'Renew', 
          'New'
        )
      )
    ), 
    '|', 
    -1
  ) renewal_status, 
  group_concat(distinct o.order_id) order_id, 
  min(o.order_date) order_date, 
  min(od.start_date) start_date, 
  max(od.end_date) end_date, 
  max(od_myo.end_date) contract_end_date, 
  MIN(od.renewal_extension) renewal_extension 
FROM 
  tech.wu_account_usage u 
  LEFT JOIN tech.wu_order_details od ON (
    u.account_id = od.account_id 
    AND u.program_id = od.program_id 
    AND od.reportable_exclude = 'N' 
    AND od.academic_year_id = u.academic_year_id
  ) 
  LEFT JOIN interlink.orders o ON o.order_id = od.order_id 
  LEFT JOIN interlink.academic_years ay ON ay.academic_year_id = od.academic_year_id 
  LEFT JOIN tech.wu_order_details_all od_old ON (
    u.account_id = od_old.account_id 
    AND od_old.academic_year_id > 0 
    AND od_old.academic_year_end < ay.end_date 
    AND (od_old.summer = ay.summer) 
    AND od.reportable_exclude = 'N'
  ) 
  LEFT JOIN tech.wu_order_details_all od_myo ON (
    u.account_id = od_myo.account_id 
    AND u.program_id = od_myo.program_id 
    AND od.order_id = od_myo.order_id 
    AND od_myo.academic_year_id > 0 
    AND od_myo.reportable_exclude = 'N'
  ) 
GROUP BY 
  u.account_id, 
  u.program_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:2266</td><td>CREATE TABLE tech.wu_account_info (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (account_id)
) ENGINE = INNODB 
SELECT 
  o.*, 
  was.order_total, 
  pd.purchased_pd, 
  pd.scheduled_pd, 
  pd.fulfilled_pd, 
  pd.onsite_purchased_pd, 
  pd.onsite_scheduled_pd, 
  pd.online_purchased_pd, 
  pd.online_scheduled_pd, 
  pd.remaining_pls 
FROM 
  tech.wu_order_info o 
  LEFT JOIN tech.wu_account_summary was ON (
    o.account_id = was.account_id 
    AND o.program_id = was.program_id 
    AND o.academic_year_id = was.academic_year_id
  ) 
  LEFT JOIN tech.wu_account_pd pd ON (
    o.account_id = pd.account_id 
    AND o.program_id = pd.program_id 
    AND o.academic_year_id = pd.academic_year_id
  )</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:2294</td><td>CREATE TABLE tech.wu_school_dates (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  key(account_id), 
  key(school_id), 
  key(program_id), 
  key(special_editions)
) ENGINE = INNODB 
SELECT 
  u.account_id, 
  u.school_id, 
  u.program_id, 
  u.special_editions, 
  u.academic_year_id, 
  i.start_date school_start, 
  i.end_date school_end 
FROM 
  (
    tech.wu_account_usage u, accounts a
  ) 
  LEFT JOIN tech.wu_account_info i ON (
    a.account_id = i.account_id 
    AND u.program_id = i.program_id
  ) 
WHERE 
  u.program_id = 11 
  AND a.account_id = u.account_id 
  AND a.summer = 0</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:2340</td><td>CREATE TABLE tech.wu_ytd_tables (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  key(school_id), 
  key(program_id)
) ENGINE = INNODB 
SELECT 
  distinct t.db, 
  t.sub_table, 
  d.school_id, 
  d.program_id, 
  d.academic_year_id, 
  d.school_start, 
  d.school_end 
FROM 
  $db_pick.report_summary_tables t, 
  tech.wu_school_dates d 
WHERE 
  t.main_table = 'user_summary' 
  AND (
    d.school_start BETWEEN t.start_date 
    AND if(t.end_date, t.end_date, now()) 
    OR if(
      d.school_end > '" . date("Y-m-d", $end_date) . "', 
      '" . date("Y-m-d", $end_date) . "', 
      d.school_end
    ) BETWEEN t.start_date 
    AND if(t.end_date, t.end_date, now()) 
    OR t.start_date BETWEEN d.school_start 
    and if(
      d.school_end > '" . date("Y-m-d", $end_date) . "', 
      '" . date("Y-m-d", $end_date) . "', 
      d.school_end
    ) 
    OR if(t.end_date, t.end_date, now()) BETWEEN d.school_start 
    and if(
      d.school_end > '" . date("Y-m-d", $end_date) . "', 
      '" . date("Y-m-d", $end_date) . "', 
      d.school_end
    )
  )</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:2366</td><td>CREATE TABLE tech.wu_ytd_user_summary (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  key(user_id), 
  key(program_id), 
  key(school_id)
) ENGINE = INNODB 
SELECT 
  distinct y.school_id, 
  y.program_id, 
  up.special_editions, 
  t.academic_year_id, 
  y.user_id, 
  y.daily_date, 
  y.basic_news_activities, 
  y.biology_activities, 
  y.average_basic_news_score, 
  y.average_biology_score 
FROM 
  (
    summary.ytd_user_summary y, tech.wu_user_programs up, 
    tech.wu_ls_users l
  ) 
  Left join tech.wu_school_dates t on y.school_id = t.school_id 
  AND y.program_id = t.program_id 
WHERE 
  y.user_id = up.user_id 
  AND y.school_id = up.school_id 
  AND y.program_id = up.program_id 
  AND y.daily_date between t.school_start 
  and if (
    t.school_end > '" . date("Y-m-d", $end_date) . "', 
    '" . date("Y-m-d", $end_date) . "', 
    t.school_end
  ) 
  AND up.subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "' 
  AND y.user_id = l.user_id 
  AND y.program_id = l.program_id 
  AND y.school_id = l.school_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:2389</td><td>CREATE TABLE counts_temp2 (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  key(school_id), 
  key(program_id)
) ENGINE = INNODB 
SELECT 
  school_id, 
  program_id, 
  sum(
    (
      average_basic_news_score * basic_news_activities
    ) + (
      average_biology_score * biology_activities
    )
  ) / sum(
    basic_news_activities + biology_activities
  ) avg_score, 
  sum(
    (
      average_basic_news_score * basic_news_activities
    ) + (
      average_biology_score * biology_activities
    )
  ) total_score, 
  sum(
    basic_news_activities + biology_activities
  ) total_activities 
FROM 
  tech.wu_ytd_user_summary 
GROUP BY 
  school_id, 
  program_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:2566</td><td>CREATE TABLE tech.wu_usage_ytd (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  key(account_id), 
  key(program_name), 
  key(special_editions)
) ENGINE = INNODB 
SELECT 
  u.report_start_date, 
  u.report_end_date, 
  u.account_id, 
  u.program_name, 
  u.special_editions, 
  u.academic_year, 
  u.total_students, 
  u.active_students, 
  u.student_licenses 
FROM 
  school_usage_primary_report u, 
  tech.wu_school_dates d 
WHERE 
  u.account_id = d.account_id 
  AND u.program_name = d.program_name 
  AND u.special_editions = d.special_editions 
  AND u.academic_year = d.academic_year 
  AND u.report_end_date BETWEEN d.school_start 
  AND d.school_end</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:2585</td><td>CREATE TABLE tech.wu_usage_ytd_totals (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  key(account_id), 
  key(program_name), 
  key(special_editions)
) ENGINE = INNODB 
SELECT 
  d.account_id, 
  d.program_name, 
  d.special_editions, 
  d.academic_year, 
  SUM(u.total_students) total_students_ytd, 
  SUM(u.active_students) active_students_ytd, 
  SUM(u.student_licenses) total_licenses_ytd 
FROM 
  (
    tech.wu_usage_ytd u, tech.wu_school_dates d
  ) 
WHERE 
  u.account_id = d.account_id 
  AND u.program_name = d.program_name 
  AND u.special_editions = d.special_editions #  AND u.academic_year = d.academic_year
  AND WEEKDAY(u.report_start_date)= 0 
  AND WEEKDAY(u.report_end_date)= 6 
  AND DATEDIFF(
    u.report_end_date, report_start_date
  )= 6 
  AND u.report_end_date <= '" . date(' Y - m - d ', $end_date) . "' 
GROUP BY 
  u.account_id, 
  u.program_name, 
  u.special_editions</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:2610</td><td>CREATE TABLE tech.wu_ytd_missing_accounts (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  key(account_id)
) ENGINE = INNODB 
SELECT 
  DISTINCT u.account_id, 
  u.program_name, 
  u.special_editions, 
  u.report_start_date, 
  u.report_end_date, 
  u.academic_year 
FROM 
  school_usage_primary_report u 
  LEFT JOIN tech.wu_usage_ytd_totals y ON u.account_id = y.account_id 
  AND u.program_name = y.program_name 
  AND u.special_editions = y.special_editions 
WHERE 
  u.report_start_date = '" . date(' Y - m - d ', $start_date) . "' 
  AND u.report_end_date = '" . date(' Y - m - d ', $end_date) . "' 
  AND y.account_id IS NULL</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:2717</td><td>CREATE TABLE tech.wu_usage_4w_dates (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id)
) ENGINE = INNODB 
SELECT 
  DISTINCT u.report_start_date, 
  u.report_end_date 
FROM 
  school_usage_primary_report u 
WHERE 
  WEEKDAY(report_start_date)= 0 
  AND WEEKDAY(report_end_date)= 6 
  AND DATEDIFF(
    report_end_date, report_start_date
  )= 6 
  AND report_end_date <= '" . date(' Y - m - d ', $end_date) . "' 
ORDER BY 
  report_end_date DESC 
LIMIT 
  4</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:2734</td><td>CREATE TABLE tech.wu_usage_4w (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  key(account_id), 
  key(program_name), 
  key(special_editions)
) ENGINE = INNODB 
SELECT 
  u.account_id, 
  u.program_name, 
  u.special_editions, 
  SUM(u.total_students) total_students, 
  SUM(u.active_students) active_students, 
  SUM(u.student_licenses) total_licenses 
FROM 
  (
    tech.wu_usage_ytd u, tech.wu_usage_4w_dates f
  ) 
WHERE 
  WEEKDAY(u.report_start_date)= 0 
  AND WEEKDAY(u.report_end_date)= 6 
  AND DATEDIFF(
    u.report_end_date, u.report_start_date
  )= 6 
  AND u.report_end_date <= '" . date(' Y - m - d ', $end_date) . "' 
  AND u.report_start_date = f.report_start_date 
  AND u.report_end_date = f.report_end_date 
GROUP BY 
  u.account_id, 
  u.program_name, 
  u.special_editions 
HAVING 
  COUNT(
    DISTINCT u.report_start_date, u.report_end_date
  ) <= 4</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:2758</td><td>CREATE TABLE tech.wu_4w_missing_accounts (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  key(account_id)
) ENGINE = INNODB 
SELECT 
  DISTINCT u.account_id, 
  u.program_name, 
  u.special_editions, 
  u.report_start_date, 
  u.report_end_date, 
  u.academic_year 
FROM 
  school_usage_primary_report u 
  LEFT JOIN tech.wu_usage_4w w ON u.account_id = w.account_id 
  AND u.program_name = w.program_name 
  AND u.special_editions = w.special_editions 
WHERE 
  u.report_start_date = '" . date(' Y - m - d ', $start_date) . "' 
  AND u.report_end_date = '" . date(' Y - m - d ', $end_date) . "' 
  AND w.account_id IS NULL</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:2967</td><td>CREATE TABLE tech.wu_licenses_by_program (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  key(school_id)
) ENGINE = INNODB 
SELECT 
  school_id, 
  sum(student_licenses) student_licenses, 
  academic_year_id 
FROM 
  tech.wu_account_usage u 
WHERE 
  " . ($hisd_run ? " program_id = '15' " : " program_id IN (
    " . implode(", ", $use_programs) . "
  ) ") . " 
GROUP BY 
  school_id, 
  academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:2988</td><td>CREATE TABLE counts_temp (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY(school_id), 
  KEY(academic_year_id)
) ENGINE = INNODB 
SELECT 
  u.school_id, 
  u.academic_year_id, 
  COUNT(
    DISTINCT IF (
      up.subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "', 
      up.user_id, NULL
    )
  ) total_students, 
  COUNT(
    DISTINCT IF (
      up.subscriber_type = '" . $SUBSCRIBER_TYPES["teacher"] . "', 
      up.user_id, NULL
    )
  ) total_teachers 
FROM 
  tech.wu_account_usage u 
  LEFT JOIN $tmp_users_all s ON (u.school_id = s.school_id) 
  LEFT JOIN tech.wu_user_programs up ON (
    s.school_id = up.school_id 
    AND s.user_id = up.user_id 
    AND u.program_id = up.program_id
  ) 
WHERE 
  u.program_id IN (
    " . implode(", ", $use_programs) . "
  ) 
GROUP BY 
  u.school_id, 
  u.academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:3020</td><td>CREATE TABLE tech.wu_active_users_by_program (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY(school_id), 
  KEY(academic_year_id)
) ENGINE = INNODB 
SELECT 
  l.school_id, 
  l.user_id, 
  u.academic_year_id, 
  l.subscriber_type, 
  IF(
    l.subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "', 
    SUM(l.total_logins), 
    l.total_logins
  ) total_logins 
FROM 
  (
    tech.wu_login_log_active l, tech.wu_account_usage u
  ) 
WHERE 
  l.program_id IN (
    " . implode(", ", $use_programs) . "
  ) 
  AND l.school_id = u.school_id 
  AND l.program_id = u.program_id 
GROUP BY 
  l.school_id, 
  l.user_id, 
  u.academic_year_id 
HAVING 
  (
    subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "' 
    AND total_logins >= '$num_logins'
  ) 
  OR (
    subscriber_type <> '" . $SUBSCRIBER_TYPES["student"] . "' 
    AND total_logins >= '$num_teacher_logins'
  )</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:3039</td><td>CREATE TABLE counts_temp (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY(school_id), 
  KEY(academic_year_id)
) ENGINE = INNODB 
SELECT 
  school_id, 
  academic_year_id, 
  COUNT(
    DISTINCT IF (
      subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "', 
      user_id, NULL
    )
  ) total_students, 
  COUNT(
    DISTINCT IF (
      subscriber_type = '" . $SUBSCRIBER_TYPES["teacher"] . "', 
      user_id, NULL
    )
  ) total_teachers, 
  COUNT(
    DISTINCT IF (
      subscriber_type = '" . $SUBSCRIBER_TYPES["school"] . "', 
      user_id, NULL
    )
  ) total_admins 
FROM 
  tech.wu_active_users_by_program 
GROUP BY 
  school_id, 
  academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:3065</td><td>CREATE TABLE counts_temp2 (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  key(school_id)
) ENGINE = INNODB 
SELECT 
  school_id, 
  program_id, 
  COUNT(
    DISTINCT IF (
      subscriber_type = '" . $SUBSCRIBER_TYPES["teacher"] . "', 
      user_id, NULL
    )
  ) total_teachers 
FROM 
  tech.wu_active_users 
GROUP BY 
  school_id, 
  program_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:3088</td><td>CREATE TABLE counts_temp (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY(school_id), 
  KEY(academic_year_id)
) ENGINE = INNODB 
SELECT 
  u.school_id, 
  a.academic_year_id, 
  count(distinct s.user_id) fidelity_users 
FROM 
  $tmp_users u, 
  tech.wu_user_programs up, 
  tech.wu_user_summary s, 
  tech.wu_ls_users l, 
  tech.wu_account_usage a 
WHERE 
  u.user_id = up.user_id 
  AND s.user_id = up.user_id 
  AND s.school_id = up.school_id 
  AND s.school_id = u.school_id 
  AND s.program_id = up.program_id 
  AND s.daily_date BETWEEN '".date("Y-m-d", $start_date)."' 
  AND '".date("Y-m-d", $end_date)."' 
  AND u.subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "' 
  AND s.basic_news_activities > 0 
  AND u.user_id = l.user_id 
  AND u.school_id = l.school_id 
  AND s.program_id = l.program_id 
  AND s.program_id IN (
    " . implode(", ", $use_programs) . "
  ) 
  AND a.school_id = u.school_id 
  AND a.program_id = up.program_id 
GROUP BY 
  u.school_id, 
  a.academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:3123</td><td>CREATE TABLE counts_temp (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY(school_id), 
  KEY(academic_year_id)
) ENGINE = INNODB 
SELECT 
  a.school_id, 
  u.academic_year_id, 
  count(DISTINCT a.class_id) total_classes, 
  count(
    DISTINCT IF (
      perc_active >=.5, a.class_id, NULL
    )
  ) active_classes 
FROM 
  tech.wu_classes_active a, 
  tech.wu_account_usage u 
WHERE 
  a.program_id IN (
    " . implode(", ", $use_programs) . "
  ) 
  AND a.school_id = u.school_id 
  AND a.program_id = u.program_id 
GROUP BY 
  a.school_id, 
  u.academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:3149</td><td>CREATE TABLE counts_temp (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY(school_id), 
  KEY(academic_year_id)
) ENGINE = INNODB 
SELECT 
  l.school_id, 
  u.academic_year_id, 
  count(distinct l.user_id) login_users 
FROM 
  $tmp_users tmp_users, 
  tech.wu_afterschool_users l, 
  tech.wu_account_usage u 
where 
  l.user_id = tmp_users.user_id 
  AND l.school_id = tmp_users.school_id 
  and tmp_users.subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "' 
  AND l.program_id IN (
    " . implode(", ", $use_programs) . "
  ) 
  AND u.school_id = l.school_id 
  AND u.program_id = l.program_id 
GROUP BY 
  l.school_id, 
  u.academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:3177</td><td>CREATE TABLE counts_temp (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY(school_id)
) ENGINE = INNODB 
SELECT 
  DISTINCT a.school_id, 
  d.academic_year_id, 
  COUNT(
    DISTINCT if (
      d.assessment_id = '" . $ASSESSMENT["pre"] . "', 
      user_id, null
    )
  ) total_pre, 
  COUNT(
    DISTINCT if (
      d.assessment_id = '" . $ASSESSMENT["mid"] . "', 
      user_id, null
    )
  ) total_inter, 
  COUNT(
    DISTINCT if (
      d.assessment_id = '" . $ASSESSMENT["post"] . "', 
      user_id, null
    )
  ) total_post, 
  COUNT(
    DISTINCT if (
      d.assessment_id = '" . $ASSESSMENT["summer_pre"] . "', 
      user_id, null
    )
  ) total_summer_pre 
FROM 
  tech.wu_assessment_completed a, 
  tech.wu_assessment_dates d 
WHERE 
  a.assessment_date_id = d.assessment_date_id 
  AND a.academic_year_id = d.academic_year_id 
  AND a.program_id IN (
    " . implode(", ", $use_programs) . "
  ) 
GROUP BY 
  a.school_id, 
  d.academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:3209</td><td>CREATE TABLE counts_temp (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY(school_id), 
  KEY(academic_year_id)
) ENGINE = INNODB 
SELECT 
  s.school_id, 
  u.academic_year_id, 
  count(
    distinct if (
      (
        (
          s.basic_news_activities + s.biology_activities
        ) > 0
      ) 
      and (l.user_id IS NOT NULL), 
      s.user_id, 
      null
    )
  ) users, 
  sum(
    if (
      l.user_id IS NOT NULL, 
      (
        average_basic_news_score * basic_news_activities
      ) + (
        average_biology_score * s.biology_activities
      ), 
      0
    )
  ) / sum(
    if(
      l.user_id IS NOT NULL, basic_news_activities + s.biology_activities, 
      0
    )
  ) avg_score, 
  (
    (
      SUM(
        if(
          l.user_id IS NOT NULL, s.basic_news_activities + s.biology_activities, 
          0
        )
      )/ $num_weeks
    )/ p.total_students
  ) avg_weekly_activities, 
  sum(s.total_time) total_time, 
  round(
    sum(t.mail_time)/(
      sum(s.total_time)
    )* 100
  ) time_spent_mail, 
  round(
    sum(
      t.news_time + t.bonus_news_time + t.stretch_news_time
    )/(
      sum(s.total_time)
    )* 100
  ) time_spent_news, 
  round(
    sum(
      t.news_activity_time + t.bonus_activity_time + stretch_activity_time
    )/(
      sum(s.total_time)
    )* 100
  ) time_spent_news_mc, 
  round(
    sum(t.news_tq_time + t.bonus_tq_time)/(
      sum(s.total_time)
    )* 100
  ) time_spent_news_tq, 
  round(
    sum(t.biology_time)/(
      sum(s.total_time)
    )* 100
  ) time_spent_bio, 
  round(
    sum(t.biology_activity_time)/(
      sum(s.total_time)
    )* 100
  ) time_spent_bio_mc, 
  round(
    sum(t.biology_tq_time)/(
      sum(s.total_time)
    )* 100
  ) time_spent_bio_tq, 
  round(
    sum(t.writing_time)/(
      sum(s.total_time)
    )* 100
  ) time_spent_writing, 
  round(
    sum(t.stock_time)/(
      sum(s.total_time)
    )* 100
  ) time_spent_stocks, 
  round(
    sum(t.other_time)/(
      sum(s.total_time)
    )* 100
  ) time_spent_other 
FROM 
  (
    tech.wu_user_summary s, tech.wu_user_programs up, 
    tech.wu_account_usage u, tech.wu_account_usage_by_program p
  ) 
  LEFT JOIN tech.wu_user_summary_time t ON (
    s.user_id = t.user_id 
    and s.class_id = t.class_id 
    and s.daily_date = t.daily_date 
    AND s.school_id = t.school_id 
    AND s.program_id = t.program_id
  ) 
  LEFT JOIN tech.wu_ls_users l ON (
    s.user_id = l.user_id 
    AND s.school_id = l.school_id 
    AND up.program_id = l.program_id
  ) 
WHERE 
  s.user_id = up.user_id 
  AND s.school_id = up.school_id 
  AND s.program_id = up.program_id 
  AND s.daily_date BETWEEN '".date("Y-m-d", $start_date)."' 
  AND '".date("Y-m-d", $end_date)."' 
  AND up.subscriber_type = '" . $SUBSCRIBER_TYPES["student"] . "' 
  AND u.school_id = s.school_id 
  AND u.program_id = s.program_id 
  AND u.special_editions = up.special_editions 
  AND u.program_id IN (
    " . implode(", ", $use_programs) . "
  ) 
  AND u.school_id = p.school_id 
  AND u.academic_year_id = p.academic_year_id 
GROUP BY 
  s.school_id, 
  u.academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:3273</td><td>CREATE TABLE counts_temp (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (school_id)
) ENGINE = INNODB 
SELECT 
  a.school_id, 
  a.academic_year_id, 
  count(
    if (
      ytd_activities BETWEEN 1 
      and 19, 
      1, 
      NULL
    )
  ) ytd_1_19_activity_users, 
  count(
    if (ytd_activities = 0, 1, NULL)
  ) ytd_0_activity_users, 
  count(
    if (
      ytd_activities BETWEEN 1 
      and 9, 
      1, 
      NULL
    )
  ) ytd_1_9_activity_users, 
  count(
    if (
      ytd_activities BETWEEN 10 
      and 19, 
      1, 
      NULL
    )
  ) ytd_10_19_activity_users, 
  count(
    if (
      ytd_activities BETWEEN 20 
      and 39, 
      1, 
      NULL
    )
  ) ytd_20_39_activity_users, 
  count(
    if (
      ytd_activities BETWEEN 30 
      and 39, 
      1, 
      NULL
    )
  ) ytd_30_39_activity_users, 
  count(
    if (
      ytd_activities BETWEEN 40 
      and 79, 
      1, 
      NULL
    )
  ) ytd_40_79_activity_users, 
  count(
    if (ytd_activities >= 80, 1, NULL)
  ) ytd_80_plus_activity_users 
FROM 
  
  /* Because we can have records for more than one academic year, we need to group by academic year */
  (
    SELECT 
      ua.school_id, 
      ua.user_id, 
      SUM(ua.ytd_activities) ytd_activities, 
      ay.academic_year_id 
    FROM 
      tech.wu_user_activities ua 
      JOIN tech.wu_schools s on s.school_id = ua.school_id 
      JOIN tech.wu_account_academic_year ay on ay.account_id = s.account_id 
      and ua.program_id = ay.program_id 
    WHERE 
      ua.program_id IN (
        " . implode(", ", $use_programs) . "
      ) 
    GROUP BY 
      school_id, 
      user_id, 
      ay.academic_year_id
  ) a 
GROUP BY 
  a.school_id, 
  a.academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:3317</td><td>CREATE TABLE counts_temp2 (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  key(school_id), 
  KEY(academic_year_id)
) ENGINE = INNODB 
SELECT 
  s.school_id, 
  s.academic_year_id, 
  sum(
    (
      s.average_basic_news_score * s.basic_news_activities
    ) + (
      s.average_biology_score * s.biology_activities
    )
  ) / sum(
    s.basic_news_activities + s.biology_activities
  ) avg_score, 
  sum(
    (
      s.average_basic_news_score * s.basic_news_activities
    ) + (
      s.average_biology_score * s.biology_activities
    )
  ) total_score, 
  sum(
    s.basic_news_activities + s.biology_activities
  ) total_activities 
FROM 
  tech.wu_ytd_user_summary s 
WHERE 
  s.program_id IN (
    " . implode(", ", $use_programs) . "
  ) 
GROUP BY 
  s.school_id, 
  s.academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:3343</td><td>CREATE TABLE tech.wu_order_info_by_order (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY(school_id), 
  KEY(order_id)
) ENGINE = INNODB 
SELECT 
  u.school_id, 
  u.academic_year_id, 
  o.order_id, 
  o.order_date, 
  os.order_total, 
  min(od.start_date) start_date, 
  max(od.end_date) end_date, 
  max(od_myo.end_date) contract_end_date 
FROM 
  tech.wu_account_usage u 
  LEFT JOIN tech.wu_order_details od ON (
    u.account_id = od.account_id 
    AND u.program_id = od.program_id 
    AND od.reportable_exclude = 'N' 
    AND od.academic_year_id = u.academic_year_id
  ) 
  LEFT JOIN interlink.orders o ON o.order_id = od.order_id 
  LEFT JOIN interlink.academic_years ay ON ay.academic_year_id = od.academic_year_id 
  LEFT JOIN tech.wu_order_details_all od_myo ON (
    u.account_id = od_myo.account_id 
    AND u.program_id = od_myo.program_id 
    AND od.order_id = od_myo.order_id 
    AND od_myo.academic_year_id > 0 
    AND od_myo.reportable_exclude = 'N'
  ) 
  LEFT JOIN interlink.order_summary os ON (o.order_id = os.order_id) 
WHERE 
  u.program_id IN (
    " . implode(", ", $use_programs) . "
  ) 
GROUP BY 
  u.school_id, 
  u.academic_year_id, 
  o.order_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:3377</td><td>CREATE TABLE tech.wu_order_info_by_program (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY(school_id)
) ENGINE = INNODB 
SELECT 
  school_id, 
  academic_year_id, 
  group_concat(distinct order_id) order_id, 
  SUM(order_total) order_total, 
  MIN(order_date) order_date, 
  MIN(start_date) start_date, 
  MAX(end_date) end_date, 
  MAX(contract_end_date) contract_end_date 
FROM 
  tech.wu_order_info_by_order 
GROUP BY 
  school_id, 
  academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:3402</td><td>CREATE TEMPORARY TABLE wu_ordered_training_by_program (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  KEY (account_id), 
  KEY (academic_year)
) ENGINE = INNODB 
SELECT 
  account_id, 
  program_id, 
  academic_year, 
  ordered_training, 
  delivered_training, 
  onsite_purchased_pd, 
  onsite_scheduled_pd, 
  online_purchased_pd, 
  online_scheduled_pd, 
  remaining_pls 
FROM 
  school_usage_primary_report u 
WHERE 
  report_start_date = '" . date(' Y - m - d ', $start_date) . "' 
  AND report_end_date = '" . date(' Y - m - d ', $end_date) . "' 
  AND program_id IN (
    " . implode(", ", $use_programs) . "
  ) 
GROUP BY 
  district_id, 
  school_id, 
  program_id</td><td></td><td>skip</td></tr>
   <tr><td>cron/usage_report.php:3416</td><td>CREATE TEMPORARY TABLE wu_ordered_training ENGINE = INNODB 
SELECT 
  account_id, 
  academic_year, 
  SUM(ordered_training) ordered_training, 
  SUM(delivered_training) delivered_training, 
  SUM(onsite_purchased_pd) onsite_purchased_pd, 
  SUM(onsite_scheduled_pd) onsite_scheduled_pd, 
  SUM(online_purchased_pd) online_purchased_pd, 
  SUM(online_scheduled_pd) online_scheduled_pd, 
  SUM(remaining_pls) remaining_pls 
FROM 
  wu_ordered_training_by_program 
GROUP BY 
  account_id, 
  academic_year</td><td></td><td>skip</td></tr>
   <tr><td>cron/usage_report.php:3475</td><td>CREATE TABLE tech.wu_usage_ytd_by_program (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  key(account_id), 
  KEY(academic_year)
) ENGINE = INNODB 
SELECT 
  DISTINCT u.report_start_date, 
  u.report_end_date, 
  u.account_id, 
  u.academic_year, 
  u.total_students, 
  u.active_students, 
  u.student_licenses 
FROM 
  $program_rollup_table u, 
  tech.wu_school_dates d 
WHERE 
  u.account_id = d.account_id 
  AND u.academic_year = d.academic_year 
  AND d.program_id IN (
    " . implode(", ", $use_programs) . "
  ) 
  AND u.report_end_date BETWEEN d.school_start 
  AND d.school_end</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:3492</td><td>CREATE TABLE tech.wu_usage_ytd_totals_by_program (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  key(account_id), 
  key(academic_year)
) ENGINE = INNODB 
SELECT 
  u.account_id, 
  u.academic_year, 
  SUM(u.total_students) total_students_ytd, 
  SUM(u.active_students) active_students_ytd, 
  SUM(u.student_licenses) total_licenses_ytd 
FROM 
  (tech.wu_usage_ytd_by_program u) 
WHERE 
  WEEKDAY(u.report_start_date)= 0 
  AND WEEKDAY(u.report_end_date)= 6 
  AND DATEDIFF(
    u.report_end_date, report_start_date
  )= 6 
  AND u.report_end_date <= '" . date(' Y - m - d ', $end_date) . "' 
GROUP BY 
  u.account_id, 
  u.academic_year</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:3513</td><td>CREATE TABLE tech.wu_ytd_by_program_missing_accounts (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  key(account_id)
) ENGINE = INNODB 
SELECT 
  DISTINCT u.account_id, 
  u.report_start_date, 
  u.report_end_date, 
  u.academic_year 
FROM 
  $program_rollup_table u 
  LEFT JOIN tech.wu_usage_ytd_totals_by_program y ON u.account_id = y.account_id 
  AND u.academic_year = y.academic_year 
WHERE 
  u.report_start_date = '" . date(' Y - m - d ', $start_date) . "' 
  AND u.report_end_date = '" . date(' Y - m - d ', $end_date) . "' 
  AND y.account_id IS NULL</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:3553</td><td>CREATE TABLE tech.wu_usage_4w (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  key(account_id)
) ENGINE = INNODB 
SELECT 
  u.account_id, 
  u.academic_year, 
  SUM(u.total_students) total_students, 
  SUM(u.active_students) active_students, 
  SUM(u.student_licenses) student_licenses 
FROM 
  (
    tech.wu_usage_ytd_by_program u, tech.wu_usage_4w_dates f
  ) 
WHERE 
  WEEKDAY(u.report_start_date)= 0 
  AND WEEKDAY(u.report_end_date)= 6 
  AND DATEDIFF(
    u.report_end_date, u.report_start_date
  )= 6 
  AND u.report_end_date <= '" . date(' Y - m - d ', $end_date) . "' 
  AND u.report_start_date = f.report_start_date 
  AND u.report_end_date = f.report_end_date 
GROUP BY 
  u.account_id, 
  u.academic_year 
HAVING 
  COUNT(
    DISTINCT u.report_start_date, u.report_end_date
  ) <= 4</td><td></td><td></td></tr>
   <tr><td>cron/usage_report.php:3577</td><td>CREATE TABLE tech.wu_4w_by_program_missing_accounts (
  id INT NOT NULL AUTO_INCREMENT, 
  PRIMARY KEY (id), 
  key(account_id)
) ENGINE = INNODB 
SELECT 
  DISTINCT u.account_id, 
  u.report_start_date, 
  u.report_end_date, 
  u.academic_year 
FROM 
  $program_rollup_table u 
  LEFT JOIN tech.wu_usage_4w y ON u.account_id = y.account_id 
  AND u.academic_year = y.academic_year 
WHERE 
  u.report_start_date = '" . date(' Y - m - d ', $start_date) . "' 
  AND u.report_end_date = '" . date(' Y - m - d ', $end_date) . "' 
  AND y.account_id IS NULL</td><td></td><td></td></tr>
   <tr><td>reports/finance/monthly_revenue/monthly_revenue_index.php:145</td><td>CREATE TEMPORARY TABLE tmp_product_line_order_details(
  PRIMARY KEY(order_detail_id)
) 
SELECT 
  DISTINCT order_detail_id 
FROM 
  products p 
  INNER join product_lines pl on pl.product_line_id = p.product_line_id 
  INNER JOIN order_details od ON (p.product_id = od.product_id) 
WHERE 
  pl.product_line_name = 'Actively Learn ELA';</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/monthly_revenue/monthly_revenue_index.php:181</td><td>CREATE TEMPORARY TABLE tmp_acv_ay (
  PRIMARY KEY (order_detail_id)
) 
SELECT 
  od.order_detail_id, 
  acv.academic_year_id 
FROM 
  amortization.booking_total_acv_year acv 
  INNER JOIN order_details od ON od.order_id = acv.order_id 
  AND od.academic_year_id = acv.academic_year_id 
WHERE 
  is_first_acv = 1 
GROUP BY 
  order_detail_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/monthly_revenue/monthly_revenue_index.php:201</td><td>CREATE TEMPORARY TABLE tmp_product_acv_values (
  PRIMARY KEY (order_id, cancel_id)
) 
SELECT 
  acv.order_id, 
  acv.cancel_id, 
  SUM(acv_total) acv_total, 
  SUM(acv_new_total) acv_new_total, 
  SUM(acv_renew_total) acv_renew_total 
FROM 
  amortization.booking_acv_details acv 
  LEFT JOIN interlink.order_detail_info_summary odis ON odis.order_detail_id = acv.order_detail_id $product_line_from_str 
WHERE 
  1 $product_line_filter_str 
GROUP by 
  order_id, 
  cancel_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/monthly_revenue/monthly_revenue_index.php:224</td><td>CREATE TEMPORARY TABLE tmp_product_line_list (
  PRIMARY KEY (order_id, cancel_id)
) 
SELECT 
  od.order_id, 
  am.cancel_id, 
  ROUND(
    SUM(
      CASE WHEN am.cancel_id = 0 THEN od.after_prod_total ELSE 0 END
    ), 
    2
  ) `List Total`</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/monthly_revenue/monthly_revenue_index.php:257</td><td>CREATE TEMPORARY TABLE tagged_product_revenue (
  PRIMARY KEY (order_id, cancel_id)
) 
SELECT 
  oda.order_id, 
  oda.cancel_id, 
  CASE WHEN $child_program = 1 THEN '$product_line' ELSE rsp.sub_program END product_line $component_list_column_names, 
  SUM(
    CASE WHEN oda.period_month BETWEEN '$report_yearly_start_date' 
    and '$report_yearly_end_date' THEN oda.period_total ELSE 0 END
  ) revenue_months_total, 
  SUM(
    CASE WHEN oda.period_month < '$report_yearly_start_date' THEN oda.period_total ELSE 0 END
  ) prior_revenue_months_total, 
  SUM(
    CASE WHEN oda.period_month > '$report_yearly_end_date' THEN oda.period_total ELSE 0 END
  ) future_revenue_months_total</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/monthly_revenue/monthly_revenue_index.php:368</td><td>CREATE TEMPORARY TABLE tagged_product_revenue_summary (
  PRIMARY KEY (order_id, cancel_id)
) 
SELECT 
  order_id, 
  cancel_id, 
  revenue_months_total 
FROM 
  tagged_product_revenue;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/monthly_revenue/monthly_revenue_index.php:493</td><td>CREATE TEMPORARY TABLE tmp_amort_billing (
  PRIMARY KEY(order_id, cancel_id)
) 
SELECT 
  o.order_id, 
  b.cancel_id, 
  order_total, 
  past_billing, 
  month_billing, 
  future_billing, 
  past_tax, 
  month_tax, 
  past_billing + month_billing prior_billing, 
  past_billing + month_billing + future_billing total_billing 
FROM 
  (
    billing.billing_monthly b, amortization.orders o
  ) 
WHERE 
  o.order_id = b.order_id 
  AND month_date = '$report_month_date';</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/monthly_revenue/monthly_revenue_index.php:508</td><td>CREATE TEMPORARY TABLE order_credits_billed (
  PRIMARY KEY (order_id)
) 
SELECT 
  order_id, 
  0 cancel_id, 
  SUM(prior_billing) billed_credit 
FROM 
  tmp_amort_billing 
WHERE 
  cancel_id <> 0 
GROUP BY 
  order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/monthly_revenue/monthly_revenue_index.php:521</td><td>CREATE TEMPORARY TABLE monthly_product_revenue_export "
            
        
        //$export_get="." SELECT 
            if(o.district_account_id<>0,o.district_account_id,o.account_id) `District Account ID`, 
            replace(if(o.district_account_id<>0,district,o.account_name),',',' ') District,
            replace(if(o.district_account_id<>0,o.account_name,''),',',' ') School, 
            replace(billto,',',' ') 'Bill To', 
            o.state_code State, 
            if(tr.cancel_id>0,concat(o.order_id,'-',tr.cancel_id),o.order_id) 'Order ID', 
            if(tr.cancel_id>0,o.credit_om_order_id,o.om_order_id) 'OM ID', 
            replace(if(o.ns_order_id='SO000001',0,o.ns_order_id),'SO00','') 'NS ID',
            if(tr.cancel_id>0,this_cancel_date,o.order_date) 'Order Date', 
            if(tr.cancel_id>0,this_cancel_date,o.start_date) 'Start Date', 
            if(this_cancel_date,this_cancel_date,o.end_date) 'End Date', 
            if(tr.cancel_id>0,o.credit_total*-1,o.order_total) 'Order Total', 
            if(tr.cancel_id>0,o.credit_total*-1,o.orig_order_total) 'Orig Order Total',
            new_renew.new_total 'Order New Total', 
            new_renew.renew_total 'Order Renew Total', 
            CONCAT(order_type.domestic, ' ', order_type.program) 'Program/Source',
            '$product_line' `Product Line`,
            tr.order_total 'Product Line Total',
            tr.new_total 'Product Line New',
            tr.renew_total 'Product Line Renew',
            tr.acv_total 'Product Line ACV',
            tr.acv_new_total 'Product Line New ACV',
            tr.acv_renew_total 'Product Line Renew ACV'
            $component_total_column_names,
            if(o.cancel_id=0,norev.no_revenue_total,o.tax_credit_total*-1) `Order Sales Tax`
            $component_list_column_names,
            if(tr.cancel_id = 0 and o.first_cancel_date <= '$report_end_date',o.cancel,'') `Order Cancel`,
            if(tr.cancel_id > 0,'Y','') Credit,
            tr.prev_year_total_amount `Prev Revenue`,
            tr.this_year_total_amount `YTD Revenue`,
            tr.this_year_new_total `YTD New Revenue`,
            tr.this_year_renew_total `YTD Renew Revenue`
            $ytd_component_total_column_names,
            tr.future_months_total_amount `$report_year Future Months Revenue`,
            tr.future_months_new_total `$report_year Future Months New Revenue`,
            tr.future_months_renew_total `$report_year Future Months Renew Revenue`,
            tr.future_years_total_amount `Future Years Revenue`,
            tr.future_years_new_total `Future Years New Revenue`,
            tr.future_years_renew_total `Future Years Renew Revenue`,
            tr.recognized_total_amount `Recognized Revenue`,
            tr.recognized_new_total `Recognized New Revenue`,
            tr.recognized_renew_total `Recognized Renew Revenue`,
            CASE WHEN tr.cancel_id=0 THEN ab.prior_billing ELSE 0 END `Prev Order Billed`,
            CASE WHEN tr.cancel_id=0 THEN abc.billed_credit ELSE 0 END `Prev Credits Billed`,
            CASE WHEN tr.cancel_id=0 THEN ab.past_tax ELSE 0 END `Prev Tax Billed`
            $monthly_column_names
        FROM tagged_product_revenue tr
        INNER JOIN amortization.amort_merge o ON o.order_id=tr.order_id AND o.cancel_id=tr.cancel_id
        LEFT JOIN amortization.cancels c ON c.cancel_id=tr.cancel_id AND c.order_id=tr.order_id
        LEFT JOIN amortization.amort_order_type order_type ON (o.order_id = order_type.order_id )
        LEFT JOIN amortization.order_new_renew new_renew ON (o.order_id = new_renew.order_id and tr.cancel_id = new_renew.cancel_id)
        LEFT JOIN tmp_amort_billing ab ON (ab.order_id=tr.order_id AND ab.cancel_id=tr.cancel_id)
        LEFT JOIN order_credits_billed abc ON abc.order_id=tr.order_id AND abc.cancel_id=tr.cancel_id
        LEFT JOIN amortization.order_no_revenue norev ON (o.order_id = norev.order_id)
        ;</td><td></td><td>skip</td></tr>
   <tr><td>reports/opportunities/live_version/trend_index.php:234</td><td>CREATE TEMPORARY TABLE $table_name1 
SELECT 
  ot_id.opportunity_id, 
  ot_min.old_probability_id, 
  ot_max.new_probability_id, 
  last_change 
FROM 
  (
    SELECT 
      ot.opportunity_id, 
      min(opportunity_trend_id) start_id, 
      max(opportunity_trend_id) end_id, 
      max(date_entered) last_change 
    FROM 
      (
        opportunity_trend ot, opportunity_probabilities op_new
      ) 
      left join opportunity_probabilities op_old on (
        ot.old_probability_id = op_old.probability_id
      ) 
    WHERE 
      ot.new_probability_id = op_new.probability_id 
      AND (
        op_new.probability_percent >=.1 
        OR op_old.probability_percent >=.1 
        OR op_new.probability_percent <=.9 
        OR op_old.probability_percent <=.9
      ) $whereStr1 
    GROUP BY 
      opportunity_id
  ) ot_id, 
  opportunity_trend ot_min, 
  opportunity_trend ot_max 
WHERE 
  ot_min.opportunity_trend_id = ot_id.start_id 
  AND ot_max.opportunity_trend_id = ot_id.end_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/opportunities/live_version/trend_index.php:288</td><td>CREATE TEMPORARY TABLE $table_name 
SELECT 
  opportunity_name, 
  date_entered, 
  close_date, 
  total, 
  opportunity_id, 
  last_change, 
  probability_old, 
  probability_new, 
  rep_first_name, 
  rep_last_name, 
  region_name, 
  state_code, 
  district, 
  school, 
  if(
    (
      probability_old = probability_new 
      OR probability_old IS NULL
    ), 
    1, 
    0
  ) static, 
  if(
    probability_old > probability_new, 
    1, 0
  ) declined, 
  if(
    probability_old < probability_new, 
    1, 0
  ) advanced 
FROM 
  (
    SELECT 
      DISTINCT o.opportunity_id, 
      opportunity_name, 
      o.date_entered, 
      close_date, 
      total, 
      t.old_probability_id, 
      t.new_probability_id, 
      t.last_change, 
      op_old.probability_percent probability_old, 
      op_new.probability_percent probability_new, 
      u.first_name rep_first_name, 
      u.last_name rep_last_name, 
      region_name, 
      a.state_code, 
      if(
        a.account_level = 2, d.account_name, 
        a.account_name
      ) district, 
      if(
        a.account_level = 2, a.account_name, 
        ''
      ) school 
    FROM 
      (
        opportunities o, accounts a, user_orders uo, 
        users u, region_states rs, regions r
      ) 
      LEFT JOIN $table_name1 t ON (
        t.opportunity_id = o.opportunity_id
      ) 
      LEFT JOIN opportunity_probabilities op_old ON (
        t.old_probability_id = op_old.probability_id
      ) 
      LEFT JOIN opportunity_probabilities op_new ON (
        t.new_probability_id = op_new.probability_id
      ) 
      LEFT JOIN accounts d on (
        a.parent_account_id = d.account_id
      ) 
    WHERE 
      1 
      AND o.account_id = a.account_id 
      AND o.opportunity_id = uo.opportunity_id 
      AND uo.role_id = '".$ROLE[$DEPARTMENT["sales"]]["sales_rep"]."' 
      AND uo.user_id = u.user_id 
      AND r.department_id = '{$DEPARTMENT["sales"]}' 
      AND rs.region_id = r.region_id 
      AND rs.state_code = a.state_code 
      AND o.order_id = 0 
      AND (
        t.opportunity_id IS NOT NULL 
        OR o.probability_id > 1
      ) $whereStr
  ) tbl</td><td></td><td>skip</td></tr>
   <tr><td>reports/qcpr/renewals/generate_data.php:101</td><td>CREATE $temporary TABLE interlink.temp_renew_qcpr_user_data_source (
  PRIMARY KEY(renewal_user_id), 
  KEY(il_user_id), 
  INDEX(nvp_id), 
  INDEX(vp_id), 
  INDEX(rvp_id), 
  INDEX(srvp_id), 
  INDEX(dm_id)
) 
SELECT 
  
  /*Manager/User Group Data*/
  CAST(
    COALESCE(
      NULLIF(u.nvp_id, ''), 
      1
    ) as CHAR(8)
  ) nvp_id, 
  COALESCE(
    NULLIF(u.nvp, ''), 
    'No NVP'
  ) nvp, 
  COALESCE(
    NULLIF(u.nvp_area_sort, ''), 
    1
  ) nvp_area_sort, 
  CAST(
    COALESCE(
      NULLIF(u.vp_id, ''), 
      1
    ) as CHAR(8)
  ) vp_id, 
  COALESCE(
    NULLIF(u.vp, ''), 
    'No VP'
  ) vp, 
  COALESCE(
    NULLIF(u.vp_area_sort, ''), 
    1
  ) vp_area_sort, 
  CAST(
    COALESCE(
      NULLIF(u.srvp_id, ''), 
      1
    ) as CHAR(8)
  ) srvp_id, 
  COALESCE(
    NULLIF(u.srvp, ''), 
    ''
  ) srvp, 
  COALESCE(
    NULLIF(u.srvp_area_sort, ''), 
    1
  ) srvp_area_sort, 
  CAST(
    COALESCE(
      NULLIF(u.rvp_id, ''), 
      1
    ) as CHAR(8)
  ) rvp_id, 
  COALESCE(
    NULLIF(u.rvp, ''), 
    'No RVP'
  ) rvp, 
  COALESCE(
    NULLIF(u.rvp_area_sort, ''), 
    1
  ) rvp_area_sort, 
  CAST(
    COALESCE(
      NULLIF(u.dm_id, ''), 
      1
    ) as CHAR(8)
  ) dm_id, 
  COALESCE(
    NULLIF(u.dm, ''), 
    ''
  ) dm, 
  COALESCE(
    NULLIF(u.dm_area_sort, ''), 
    1
  ) dm_area_sort, 
  a.area_id, 
  u.`area`, 
  u.user_id il_user_id, 
  u.comp_plan_id, 
  u.comp_plan_id renewal_user_id, 
  u.user_f_last renewal_user, 
  u.last_name, 
  u.status user_status, 
  u.renewal_qcpr_status, 
  cp.termination_date termination_date, 
  CASE WHEN u.area_comp_plan_type IN (
    'nvp', 'vp', 'rvp', 'srvp', 'dm', 'a3k'
  ) THEN u.area_comp_plan_type ELSE 'renewal_user' END comp_plan_type 
FROM 
  commissions.users_cp u 
  LEFT JOIN commissions.compensation_plans cp ON cp.comp_plan_id = u.comp_plan_id 
  AND cp.cmonth = '$report_month_filter' 
  and cp.year = $year 
  LEFT JOIN commissions.areas a on a.area_id = cp.area_id 
  LEFT JOIN commissions.qcpr_manager_permissions m ON m.manager_id = '$curr_user_id' 
  AND m.user_id = u.user_id 
  AND m.cmonth = '$report_month_filter' 
WHERE 
  1 
  AND u.year = $year 
  AND u.cmonth = '$report_month_filter' 
  and u.renewal_qcpr_status = 0 #Has current year order/QC/credit OR non-terminated rep with quota
  $user_where 
GROUP BY 
  u.sales_user_id, 
  u.comp_plan_id;</td><td></td><td></td></tr>
   <tr><td>reports/qcpr/renewals/generate_data.php:153</td><td>CREATE $temporary TABLE interlink.temp_renew_qcpr_user_data_source_copy (
  PRIMARY KEY(renewal_user_id)
) 
SELECT 
  * 
FROM 
  interlink.temp_renew_qcpr_user_data_source</td><td></td><td></td></tr>
   <tr><td>reports/qcpr/renewals/generate_data.php:172</td><td>CREATE $temporary TABLE interlink.temp_renew_qcpr_qc_data_source (
  row_id INT UNSIGNED not null auto_increment PRIMARY KEY, 
  INDEX(renewal_user_id)
) 
SELECT 
  
  /*******USER INFO*******/
  cp.user_id, 
  cp.comp_plan_id renewal_user_id, 
  base.orig_user_id, 
  base.is_primary_user, 
  
  /*******ACCOUNT PROGRAM INFO*******/
  act.display_sort district_type_sort, 
  act.district_type_id district_type_id, 
  act.district_type_name district_type, 
  base.auto_credit_type_id, 
  tad.account_level, 
  tad.district_account_id district_account_id, 
  tad.district_account_name district_account, 
  tad.district_state_code district_state, 
  tad.district_state_code district_state_id, 
  tad.has_district, 
  tad.account_id, 
  tad.account_name account_name, 
  tad.state_code state_id, 
  tad.state_code state, 
  tad.ultimate_parent_id, 
  tad.ultimate_parent_name, 
  base.on_target, 
  CASE WHEN tad.account_level = 1 THEN 'z' WHEN base.on_target = 1 
  AND base.user_quota_include = 1 THEN 'y' ELSE 'n' END on_target_id, 
  CASE WHEN base.on_target = 1 
  AND base.user_quota_include = 1 THEN 1 ELSE 0 END orig_on_target, 
  base.purchaser_level purchaser_level_id, 
  CASE WHEN base.purchaser_level = 1 THEN 'District Purchase' ELSE 'School Purchase' END purchaser_level, 
  base.program_id, 
  
  /*******EXPIRING ACCOUNT*******/
  base.is_myo, 
  CONCAT(
    tad.account_id, 'p', base.program_id, 
    'o', base.order_id
  ) expiring_account_id, 
  tad.account_name expiring_account, 
  CASE WHEN base.school_rank = 1 
  AND base.user_account_display_sort = 1 
  AND rq.max_on_target = 1 
  AND tad.account_level = 2 THEN 1 ELSE 0 END orig_expiring_school_count, 
  CASE WHEN base.school_rank = 1 
  AND base.user_account_display_sort = 1 
  AND rq.max_expiring_school_count = 1 THEN 1 ELSE 0 END expiring_school_count, 
  CASE WHEN base.school_rank = 1 
  AND base.is_myo = 0 
  AND base.auto_credit_type_id != 4 THEN rq.renewal_quota_updated ELSE NULL END expiring_order_account_value, 
  CASE WHEN base.school_rank = 1 
  AND base.is_myo = 1 THEN rq.renewal_quota_updated_myo ELSE NULL END myo_expiring_order_account_value, 
  CASE WHEN base.school_rank = 1 
  AND base.user_account_display_sort = 1 THEN rq.renewal_quota_updated_total ELSE NULL END total_expiring_order_account_value, 
  rq.max_on_target, 
  base.non_quota_account, 
  district_re_allocated, 
  
  /*******NEW ORDER*******/
  CASE WHEN base.school_rank = 1 
  AND base.user_account_display_sort = 1 THEN 1 ELSE 2 END rank, 
  base.school_rank, 
  base.user_account_display_sort, 
  base.order_id booked_order_id, 
  base.order_id booked_order, 
  co.cancel, 
  IFNULL(co.order_total, os.order_total) order_total, 
  IFNULL(base.orig_school_count, 0) orig_booked_school_count, 
  CASE WHEN base.school_rank = 1 
  AND base.user_account_display_sort = 1 THEN rq.max_booked_school_count ELSE NULL END booked_school_count, 
  (
    single_year_value + more_products_yr_1 + more_schools_yr_1
  ) booked_order_account_value_yr_1, 
  CASE WHEN base.is_myo = 1 THEN (
    single_year_value + more_products_yr_1 + more_schools_yr_1
  ) ELSE base.all_yr_value END booked_order_account_value, 
  
  /******QC******/
  CASE WHEN base.is_myo = 0 THEN qc_total ELSE NULL END qc_total, 
  CASE WHEN base.is_myo = 1 THEN qc_total ELSE NULL END myo_qc_total, 
  IFNULL(
    base.qc_total / rq.renewal_quota, 
    0
  ) qc_percent, 
  upsell_qc_total, 
  qc_total + upsell_qc_total acv_upsell_qc_total, 
  IFNULL(
    (qc_total + upsell_qc_total)/ rq.renewal_quota_total, 
    0
  ) acv_upsell_qc_percent, 
  
  /******ACV******/
  base.single_year_value, 
  CASE WHEN base.is_myo = 0 THEN acv_total ELSE NULL END acv_total, 
  CASE WHEN base.is_myo = 1 THEN acv_total ELSE NULL END myo_acv_total, 
  CASE WHEN base.is_myo = 0 THEN IFNULL(
    base.acv_total / rq.renewal_quota, 
    0
  ) ELSE NULL END acv_percent, 
  CASE WHEN base.is_myo = 1 THEN IFNULL(
    base.acv_total / rq.renewal_quota_myo, 
    0
  ) ELSE NULL END myo_acv_percent, 
  
  /******Target Expansion******/
  (
    single_year_value + more_products_yr_1
  )-(
    single_year_acv + more_products_acv
  ) target_school_upsell, 
  GREATEST(
    more_schools_yr_1 - more_schools_acv, 
    0
  ) more_schools_target_year, 
  (
    (
      single_year_value + more_products_yr_1
    )-(
      single_year_acv + more_products_acv
    )
  )+ GREATEST(
    more_schools_yr_1 - more_schools_acv, 
    0
  ) expansion_total_target_yr, 
  
  /*******ACCOUNT LEVEL ADDTL INFO*******/
  rq.expiring_orders, 
  rq.expiring_orders_myo, 
  rq.expiring_sub_programs, 
  rq.expiring_sub_programs_myo, 
  CASE WHEN rq.expiring_sub_programs > '' 
  AND rq.expiring_sub_programs_myo > '' THEN CONCAT(
    rq.expiring_sub_programs, ' | ', 
    rq.expiring_sub_programs_myo
  ) WHEN IFNULL(
    NULLIF(rq.expiring_sub_programs, ''), 
    NULLIF(
      rq.expiring_sub_programs_myo, ''
    )
  )> '' THEN IFNULL(
    NULLIF(rq.expiring_sub_programs, ''), 
    rq.expiring_sub_programs_myo
  ) ELSE '' END exp_sub_program, 
  tad.account_trainer, 
  tad.account_imp_rvp, 
  'data' row_type 
FROM 
  commissions.renewal_order_users base 
  INNER JOIN interlink.accounts a ON a.account_id = base.account_id 
  INNER JOIN commissions.renewal_report_base rb ON rb.cmonth = '$report_month_filter' 
  AND rb.account_id = base.account_id 
  AND rb.order_id = base.order_id 
  AND rb.user_id = base.user_id 
  AND rb.is_myo = base.is_myo 
  AND rb.program_id = base.program_id 
  LEFT JOIN commissions.orders co ON co.order_id = base.order_id 
  AND co.cmonth = '$data_ref_month' 
  LEFT JOIN interlink.order_summary os ON os.order_id = base.order_id 
  LEFT JOIN interlink.opportunity_products op ON op.opportunity_product_id = base.program_id 
  LEFT JOIN commissions.qcpr_account_districts tad ON tad.account_id = base.account_id 
  AND tad.cmonth = '$report_month_filter' 
  LEFT JOIN commissions.users_cp cp ON cp.user_id = base.user_id 
  AND cp.cmonth = '$report_month_filter' 
  AND cp.year = $year 
  LEFT JOIN commissions.account_renewal_quotas_reporting rq ON base.account_id = rq.account_id 
  AND base.user_id = rq.user_id 
  AND base.base_user_id = rq.base_user_id 
  AND base.program_id = rq.program_id 
  AND base.purchaser_level = rq.purchaser_level 
  AND rq.cmonth = '$report_month_filter' 
  LEFT JOIN commissions.auto_credit_types act ON base.auto_credit_type_id = act.auto_credit_type_id 
WHERE 
  base.cmonth = '$report_month_filter' 
  AND base.user_id = base.base_user_id #TESTING
  #LIMIT 1000
  ;</td><td></td><td></td></tr>
   <tr><td>reports/qcpr/renewals/generate_data.php:280</td><td>CREATE $temporary TABLE interlink.temp_renew_qcpr_qc_data_source_copy (
  row_id INT UNSIGNED not null auto_increment PRIMARY KEY, 
  INDEX(renewal_user_id)
) 
SELECT 
  * 
FROM 
  interlink.temp_renew_qcpr_qc_data_source</td><td></td><td></td></tr>
   <tr><td>reports/qcpr/renewals/generate_data.php:571</td><td>/* CREATE $temporary  TABLE  tmp_renewal_export_table (id INT PRIMARY KEY  AUTO_INCREMENT)*/
SELECT 
  rou.last_name `User`, 
  u.last_name `Renewal Rep User`, 
  qc.district_account_id `District ID`, 
  qc.district_account `District`, 
  qc.district_state `District State`, 
  qc.account_id `Account ID`, 
  qc.account_name `Account`, 
  COALESCE(
    tier.tier_name, d_tier.tier_name, 
    ''
  ) `Account Tier Jan $year`, 
  qc.state `State`, 
  qc.ultimate_parent_id `Ultimate Parent ID`, 
  qc.ultimate_parent_name `Ultimate Parent Name`, 
  CASE WHEN qc.account_level = 1 THEN 'District' WHEN qc.account_level = 2 THEN 'School' ELSE '' END `Account Type`, 
  CASE WHEN rou.is_myo = 1 THEN qc.expiring_sub_programs_myo ELSE qc.expiring_sub_programs END `Expiring Program`, 
  qc.district_type `District Type`, 
  qc.purchaser_level `Purchaser Level`, 
  # qc.orig_expiring_order_account_value  `Expiring Renewal Quota`,
  CASE WHEN $distinct_expiring_filter THEN rou.renewal_quota_updated ELSE '' END `Total Expiring & Non-Expiring`, 
  REPLACE(
    CASE WHEN rou.is_myo = 1 THEN qc.expiring_orders_myo ELSE qc.expiring_orders END, 
    ',', ';'
  ) `Expiring Orders`, 
  CASE WHEN $distinct_expiring_filter THEN qc.expiring_school_count ELSE '' END `Expiring # Schools`, 
  CASE WHEN $distinct_expiring_filter THEN qc.booked_school_count ELSE '' END `$year - $year_to # Schools`, 
  
  /*school count can be overridden to 1 even if not on target*/
  CASE WHEN (
    qc.orig_on_target = 0 
    AND qc.booked_school_count = 0
  ) THEN '' WHEN (
    (
      rou.user_id = rou.base_user_id 
      AND qcu.comp_plan_type = 'renewal_user'
    ) 
    OR rou.is_primary_user = 1
  ) 
  AND rou.user_quota_include = 1 THEN qc.rank ELSE 
  /*non primary rank*/
  '1+' END `Order Count (Target Acct)`, 
  CASE WHEN rou.is_myo = 1 THEN 'Y' ELSE '' END `Is MYO Row`, 
  # Expiring ACV
  CASE WHEN rou.is_myo = 0 
  AND $distinct_expiring_filter THEN rou.renewal_quota_updated ELSE 0 END `Expiring Total`, 
  CASE WHEN rou.is_myo = 0 THEN qc.acv_total ELSE 0 END `Expiring $year - $year_to Renewed`, 
  CASE WHEN rou.is_myo = 0 THEN qc.acv_percent ELSE 0 END `Expiring $year - $year_to Renewed %`, 
  # MYO ACV
  CASE WHEN rou.is_myo = 1 
  AND $distinct_expiring_filter THEN rou.renewal_quota_updated ELSE 0 END `MYO Prior Year`, 
  CASE WHEN rou.is_myo = 1 THEN qc.myo_acv_total ELSE 0 END `MYO $year - $year_to Retained`, 
  CASE WHEN rou.is_myo = 1 THEN qc.myo_acv_percent ELSE 0 END `MYO $year - $year_to Retained %`, 
  # UPSELL
  rou.single_year_value - rou.single_year_acv `Target School Product Upsell  $year - $year_to`, 
  rou.more_products_yr_1 - rou.more_products_acv `Target School More Products Upsell  $year - $year_to Year`, 
  qc.more_schools_target_year `More Schools  $year - $year_to Year`, 
  qc.expansion_total_target_yr `Total  $year - $year_to Expansion`, 
  rou.more_schools_more_years + rou.more_products_more_years + rou.target_more_years `More Years`, 
  qc.qc_total `Expiring $year - $year_to Renewed QC`, 
  qc.myo_qc_total `MYO $year - $year_to Retained QC`, 
  rou.upsell_qc_total `Expansion QC`, 
  rou.qc_total + rou.upsell_qc_total 
  /*acv_upsell_qc_total*/
  `Total Net Retention QC`, 
  IFNULL(
    (
      rou.qc_total + rou.upsell_qc_total
    )/ rq.renewal_quota_total, 
    0
  ) 
  /*qc.acv_upsell_qc_percent*/
  `Total Net Retention QC %`, 
  qc.booked_order_account_value_yr_1 `Booked $year - $year_to Total`, 
  qc.booked_order_account_value `Booked Total`, 
  qc.booked_order_id `Booked Order`, 
  CASE WHEN qc.account_level = 1 THEN 'District' WHEN qc.orig_on_target = 1 THEN 'Within Quota' ELSE 'Not Within Quota' END `Quota Bucket`, 
  ioc.orig_order_date `Order Date`, 
  o.start_date `Start Date`, 
  o.end_date `End Date`, 
  ". ( $year >= 2019 ? " CASE WHEN o.increase_due_to_overage = 1 THEN 1 ELSE '' END `Increase due to Overage`, 
  " : "" ) ." CASE WHEN o.Cancel = 'Y' THEN 1 ELSE '' END `Is Cancelled`, 
  IFNULL(
    o.order_total, oi.order_revenue_total
  ) `Order Total`, 
  oi.credit_revenue_total + oi.bad_debt_total `Credits (Cancels/Bad Debt)`, 
  o.sales_rep `Opportunity Owner`, 
  oi.order_renewal_rep `Renewal Rep`, 
  COALESCE(
    NULLIF(oi.order_field_rep, ''), 
    asr.account_sales_rep
  ) `Field Rep`, 
  COALESCE(
    NULLIF(
      oi.order_field_region, 'National Renewal Region'
    ), 
    asr.area_name, 
    ''
  ) `Region`, 
  qc.account_trainer `Account Trainer`, 
  qc.account_imp_rvp `Account Imp. RVP`, 
  rou.po_total `PO Total`, 
  rou.year_po_total `$year - $year_to PO Total` "
            .($corporate_report?
            ", 
  CASE WHEN l.is_domestic = 1 
  OR l.location_code IS NULL THEN 0 ELSE 1 END international -- EXPIRING
  , 
  CASE WHEN $distinct_expiring_filter THEN rxb.literacy ELSE '' END `Expiring Literacy`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.levelset ELSE '' END `Expiring Levelset`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.bae ELSE '' END `Expiring BAE`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.smarty_ants ELSE '' END `Expiring Smarty Ants`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.actively_learn ELSE '' END `Expiring Actively Learn`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.math ELSE '' END `Expiring Math`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.nls_conf ELSE '' END `Expiring NLS Conf`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.nls_pre_conf ELSE '' END `Expiring NLS Pre-Conf`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.teachonomy ELSE '' END `Expiring Teachonomy`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.literacy_misc ELSE '' END `Expiring Literacy Misc`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.smarty_ants_misc ELSE '' END `Expiring Smarty Ants Misc`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.actively_learn_misc ELSE '' END `Expiring Actively Learn Misc`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.math_misc ELSE '' END `Expiring Math Misc`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.science ELSE '' END `Expiring Science`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.onsite_pd + rxb.imf ELSE '' END `Expiring Onsite PD`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.online_pd ELSE '' END `Expiring Online PD`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.pm ELSE '' END `Expiring PM`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.literacy_summer ELSE '' END `Expiring Literacy Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.levelset_summer ELSE '' END `Expiring Levelset Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.bae_summer ELSE '' END `Expiring BAE Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.smarty_ants_summer ELSE '' END `Expiring Smarty Ants Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.actively_learn_summer ELSE '' END `Expiring Actively Learn Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.math_summer ELSE '' END `Expiring Math Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.literacy_misc_summer ELSE '' END `Expiring Literacy Misc Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.smarty_ants_misc_summer ELSE '' END `Expiring Smarty Ants Misc Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.actively_learn_misc_summer ELSE '' END `Expiring Actively Learn Misc Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.math_misc_summer ELSE '' END `Expiring Math Misc Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.science_summer ELSE '' END `Expiring Science Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.onsite_pd_summer + rxb.imf_summer ELSE '' END `Expiring Onsite PD Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.online_pd_summer ELSE '' END `Expiring Online PD Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.pm_summer ELSE '' END `Expiring PM Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.literacy_count ELSE '' END `Expiring Literacy License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.levelset_count ELSE '' END `Expiring Levelset License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.bae_count ELSE '' END `Expiring BAE License Count`, 
  CASE WHEN $distinct_expiring_filter THEN CASE WHEN rxb.smarty_ants_count = 'UNLIMITED' THEN $SA_Unlimited_License_Count ELSE rxb.smarty_ants_count END ELSE '' END `Expiring Smarty Ants License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.actively_learn_count ELSE '' END `Expiring Actively Learn License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.math_count ELSE '' END `Expiring Math License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.nls_conf_count ELSE '' END `Expiring NLS Conf Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.nls_pre_conf_count ELSE '' END `Expiring NLS Pre-Conf Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.teachonomy_count ELSE '' END `Expiring Teachonomy Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.literacy_misc_count ELSE '' END `Expiring Literacy Misc Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.smarty_ants_misc_count ELSE '' END `Expiring Smarty Ants Misc Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.actively_learn_misc_count ELSE '' END `Expiring Actively Learn Misc Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.math_misc_count ELSE '' END `Expiring Math Misc Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.science_count ELSE '' END `Expiring Science License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.onsite_pd_count ELSE '' END `Expiring Onsite PD Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.online_pd_count ELSE '' END `Expiring Online PD Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.pm_count ELSE '' END `Expiring PM Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.literacy_summer_count ELSE '' END `Expiring Literacy Summer License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.levelset_summer_count ELSE '' END `Expiring Levelset Summer License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.bae_summer_count ELSE '' END `Expiring BAE Summer License Count`, 
  CASE WHEN $distinct_expiring_filter THEN CASE WHEN rxb.smarty_ants_summer_count = 'UNLIMITED' THEN $SA_Unlimited_License_Count ELSE rxb.smarty_ants_summer_count END ELSE '' END `Expiring Smarty Ants Summer License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.actively_learn_summer_count ELSE '' END `Expiring Actively Learn Summer License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.math_summer_count ELSE '' END `Expiring Math Summer License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.literacy_misc_summer_count ELSE '' END `Expiring Literacy Misc Summer License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.smarty_ants_misc_summer_count ELSE '' END `Expiring Smarty Ants Misc Summer License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.actively_learn_misc_summer_count ELSE '' END `Expiring Actively Learn Misc Summer License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.math_misc_summer_count ELSE '' END `Expiring Math Misc Summer License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.science_summer_count ELSE '' END `Expiring Science Summer License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.onsite_pd_summer_count ELSE '' END `Expiring Onsite PD Summer Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.online_pd_summer_count ELSE '' END `Expiring Online PD Summer Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.pm_summer_count ELSE '' END `Expiring PM Summer Count` -- BOOKED
  , 
  rbb.literacy `Literacy`, 
  rbb.levelset `Levelset`, 
  rbb.bae `BAE`, 
  rbb.smarty_ants `Smarty Ants`, 
  rbb.actively_learn `Actively Learn`, 
  rbb.math `Math`, 
  rbb.nls_conf `NLS Conf`, 
  rbb.nls_pre_conf `NLS Pre-Conf`, 
  rbb.teachonomy `Teachonomy`, 
  rbb.literacy_misc `Literacy Misc`, 
  rbb.smarty_ants_misc `Smarty Ants Misc`, 
  rbb.actively_learn_misc `Actively Learn Misc`, 
  rbb.math_misc `Math Misc`, 
  rbb.science `Science`, 
  rbb.onsite_pd + rbb.imf `Onsite PD`, 
  rbb.online_pd `Online PD`, 
  rbb.pm `PM`, 
  rbb.literacy_summer `Literacy Summer`, 
  rbb.levelset_summer `Levelset Summer`, 
  rbb.bae_summer `BAE Summer`, 
  rbb.smarty_ants_summer `Smarty Ants Summer`, 
  rbb.actively_learn_summer `Actively Learn Summer`, 
  rbb.math_summer `Math Summer`, 
  rbb.literacy_misc_summer `Literacy Misc Summer`, 
  rbb.smarty_ants_misc_summer `Smarty Ants Misc Summer`, 
  rbb.actively_learn_misc_summer `Actively Learn Misc Summer`, 
  rbb.math_misc_summer `Math Misc Summer`, 
  rbb.science_summer `Science Summer`, 
  rbb.onsite_pd_summer + rbb.imf_summer `Onsite PD Summer`, 
  rbb.online_pd_summer `Online PD Summer`, 
  rbb.pm_summer `PM Summer`, 
  rbb.literacy_count `Literacy License Count`, 
  rbb.levelset_count `Levelset License Count`, 
  rbb.bae_count `BAE License Count`, 
  CASE WHEN rbb.smarty_ants_count = 'UNLIMITED' THEN $SA_Unlimited_License_Count ELSE rbb.smarty_ants_count END `Smarty Ants License Count`, 
  rbb.actively_learn_count `Actively Learn License Count`, 
  rbb.math_count `Math License Count`, 
  rbb.nls_conf_count `NLS Conf Count`, 
  rbb.nls_pre_conf_count `NLS Pre-Conf Count`, 
  rbb.teachonomy_count `Teachonomy Count`, 
  rbb.literacy_misc_count `Literacy Misc Count`, 
  rbb.smarty_ants_misc_count `Smarty Ants Misc Count`, 
  rbb.actively_learn_misc_count `Actively Learn Misc Count`, 
  rbb.math_misc_count `Math Misc Count`, 
  rbb.science_count `Science License Count`, 
  rbb.onsite_pd_count `Onsite PD Count`, 
  rbb.online_pd_count `Online PD Count`, 
  rbb.pm_count `PM Count`, 
  rbb.literacy_summer_count `Literacy Summer License Count`, 
  rbb.levelset_summer_count `Levelset Summer License Count`, 
  rbb.bae_summer_count `BAE Summer License Count`, 
  CASE WHEN rbb.smarty_ants_summer_count = 'UNLIMITED' THEN $SA_Unlimited_License_Count ELSE rbb.smarty_ants_summer_count END `Smarty Ants Summer License Count`, 
  rbb.actively_learn_summer_count `Actively Learn Summer License Count`, 
  rbb.math_summer_count `Math Summer License Count`, 
  rbb.literacy_misc_summer_count `Literacy Misc Summer Count`, 
  rbb.smarty_ants_misc_summer_count `Smarty Ants Misc Summer Count`, 
  rbb.actively_learn_misc_summer_count ` Actively Learn Misc Summer Count`, 
  rbb.math_misc_summer_count `Math Misc Summer Count`, 
  rbb.science_summer_count `Science Summer License Count`, 
  rbb.onsite_pd_summer_count `Onsite PD Summer Count`, 
  rbb.online_pd_summer_count `Online PD Summer Count`, 
  rbb.pm_summer_count `PM Summer Count` "
            : "")
            ." 
FROM 
  commissions.renewal_order_users rou 
  INNER JOIN interlink.accounts a ON a.account_id = rou.account_id 
  LEFT JOIN commissions.account_tiers tier ON a.account_id = tier.account_id 
  AND tier.cmonth = CONCAT('$year-01-01') 
  LEFT JOIN commissions.account_tiers d_tier ON a.parent_account_id = d_tier.account_id 
  AND a.account_level = 2 
  AND d_tier.cmonth = CONCAT('$year-01-01') 
  INNER JOIN interlink.temp_renew_qcpr_user_data_source qcu ON rou.user_id = qcu.il_user_id 
  LEFT JOIN interlink.temp_renew_qcpr_qc_data_source qc ON rou.order_id = qc.booked_order_id 
  AND rou.account_id = qc.account_id 
  AND rou.program_id = qc.program_id 
  AND rou.base_user_id = qc.user_id 
  AND qc.is_myo = rou.is_myo 
  INNER JOIN commissions.users u ON rou.base_user_id = u.user_id 
  LEFT JOIN commissions.orders o ON o.order_id = rou.order_id 
  AND o.cmonth = '$data_ref_month' 
  LEFT JOIN commissions.order_info oi ON oi.order_id = rou.order_id 
  AND oi.cmonth = '$data_ref_month' 
  LEFT JOIN commissions.interlink_orders_copy ioc ON ioc.order_id = o.order_id 
  LEFT JOIN commissions.qcpr_account_sales_rep asr ON asr.account_id = rou.account_id 
  AND asr.cmonth = '$report_month_filter' 
  LEFT JOIN interlink.locations l ON a.state_code = l.location_code 
  AND l.location_type = 's' 
  LEFT JOIN commissions.account_renewal_quotas_reporting rq ON rou.account_id = rq.account_id 
  AND rou.user_id = rq.user_id 
  AND rou.base_user_id = rq.base_user_id 
  AND rou.program_id = rq.program_id 
  AND rou.purchaser_level = rq.purchaser_level 
  AND rq.cmonth = '$report_month_filter' ".($corporate_report?
            " 
  LEFT JOIN commissions.renewal_user_order_booked_buckets rbb ON rbb.order_id = rou.order_id 
  AND rbb.account_id = rou.account_id 
  AND rbb.user_id = rou.user_id 
  AND rbb.is_myo = rou.is_myo 
  AND rbb.program_id = rou.program_id 
  AND rbb.base_user_id = rou.base_user_id 
  AND rbb.ay_bucket_id = 1 
  AND rbb.cmonth = rou.cmonth 
  LEFT JOIN commissions.renewal_user_account_expiring_buckets rxb ON rxb.account_id = rou.account_id 
  AND rxb.user_id = rou.user_id 
  AND rxb.is_myo = rou.is_myo 
  AND rxb.program_id = rou.program_id 
  AND rxb.base_user_id = rou.base_user_id 
  AND rxb.cmonth = rou.cmonth ": " ").
            " 
WHERE 
  rou.cmonth = '$report_month_filter' 
ORDER BY 
  u.last_name, 
  qc.district_state_id, 
  qc.has_district DESC, 
  qc.district_account, 
  qc.on_target_id DESC, 
  qc.account_name, 
  qc.program_id, 
  qc.rank, 
  qc.booked_order_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/index.php:100</td><td>CREATE $temp TABLE exclude_orders_$table_suffix 
SELECT 
  distinct od.order_id 
FROM 
  order_details od, 
  accounts a, 
  order_summary os, 
  orders o 
WHERE 
  a.account_id = od.account_id 
  AND od.order_id = os.order_id 
  AND o.order_id = od.order_id 
  AND (
    a.account_type = 16 
    OR os.order_total < 0 
    /*OR o.se_0_order = 1*/
    )</td><td></td><td></td></tr>
   <tr><td>reports/renewal/index.php:136</td><td>CREATE $temp TABLE orders_$table_suffix 
SELECT 
  if (
    a.billing_account_id, a.billing_account_id, 
    a.account_id
  ) ordering_account_id, 
  b.account_id, 
  sum(b.price * b.quantity) total_purchased, 
  sum(b.list_price * b.quantity) total_list_price, 
  max(b.end_date) order_detail_end, 
  max(ay.end_date) academic_year_end_date, 
  a.order_id, 
  group_concat(distinct c.user_id) user_id, 
  concat(bc.first_name, ' ', bc.last_name) buyer_contact, 
  p.opportunity_id, 
  ot.opportunity_type_name opportunity_type, 
  min(
    if (
      opm.opportunity_product_id is null, 
      1, opm.opportunity_product_id
    )
  ) opportunity_product_id, 
  a.se_0_order 
FROM 
  (
    orders a, order_details b, academic_years ay
  ) 
  LEFT JOIN user_orders c ON a.order_id = c.order_id 
  and c.role_id = 6 
  LEFT JOIN order_contacts oc on (
    a.order_id = oc.order_id 
    and oc.contact_type_id = 3
  ) 
  LEFT JOIN contacts bc ON (bc.contact_id = oc.contact_id) 
  LEFT JOIN exclude_orders_$table_suffix e on a.order_id = e.order_id 
  LEFT JOIN opportunities p on (p.order_id = a.order_id) 
  LEFT JOIN opportunity_product_map opm ON (
    p.opportunity_id = opm.opportunity_id
  ) 
  LEFT JOIN opportunity_types ot ON (
    ot.opportunity_type_id = p.opportunity_type_id
  ) 
WHERE 
  a.order_id = b.order_id $whereStr 
  AND a.status = 0 
  AND b.status = 0 
  AND e.order_id is null 
  AND ay.academic_year_id = b.academic_year_id 
  AND ay.summer = '$summer' 
GROUP BY 
  b.account_id, 
  order_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/index.php:185</td><td>CREATE $temp TABLE has_licenses_$table_suffix 
SELECT 
  a.account_id, 
  a.order_id, 
  max(
    if (sp.sub_product_type_id = 1, 1, 0)
  ) licenses 
FROM 
  orders_$table_suffix a, 
  order_details b, 
  products p, 
  sub_products sp 
WHERE 
  a.order_id = b.order_id 
  AND a.account_id = b.account_id 
  AND b.status = 0 $whereStr 
  AND p.product_id = b.product_id 
  AND p.product_group_id <> '" . $PRODUCT_GROUPS["discount"] . "' 
  AND p.product_id = sp.product_id 
GROUP BY 
  a.account_id, 
  a.order_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/index.php:209</td><td>CREATE $temp TABLE non_license_products_$table_suffix 
SELECT 
  DISTINCT o.account_id, 
  o.order_id, 
  p.product_group_id 
FROM 
  products p, 
  order_details od, 
  orders_$table_suffix o 
WHERE 
  o.order_id = od.order_id 
  AND o.licenses = 0 
  AND o.account_id = od.account_id 
  AND p.product_id = od.product_id 
  AND od.status = 0 
  AND od.end_date = o.order_detail_end 
  AND p.product_group_id <> 28 
  AND p.product_group_id <> '" . $PRODUCT_GROUPS["discount"] . "'</td><td></td><td></td></tr>
   <tr><td>reports/renewal/index.php:227</td><td>CREATE $temp TABLE orders_future_$table_suffix 
SELECT 
  b.account_id, 
  o.order_id, 
  a.se_0_order, 
  if (
    opm.opportunity_product_id is null, 
    1, opm.opportunity_product_id
  ) opportunity_product_id, 
  group_concat(
    distinct b.order_id 
    order by 
      b.order_id separator '; '
  ) orders, 
  group_concat(
    distinct date_format(a.order_date, '%c/%e/%y') 
    order by 
      b.order_id separator '; '
  ) order_date 
FROM 
  (
    orders a, order_details b, products pr, 
    sub_products sp, orders_$table_suffix o, 
    academic_years ay
  ) 
  LEFT JOIN exclude_orders_$table_suffix e on (a.order_id = e.order_id) 
  LEFT JOIN opportunities p ON (p.order_id = a.order_id) 
  LEFT JOIN opportunity_product_map opm ON (
    p.opportunity_id = opm.opportunity_id
  ) 
  LEFT JOIN non_license_products_$table_suffix nl ON (
    o.order_id = nl.order_id 
    AND o.account_id = nl.account_id
  ) 
WHERE 
  a.order_id = b.order_id 
  AND o.account_id = b.account_id 
  AND a.status = 0 
  AND b.status = 0 
  AND pr.product_id = b.product_id 
  AND pr.product_id = sp.product_id 
  AND (
    (
      o.licenses = 1 
      AND sp.sub_product_type_id = 1
    ) 
    OR (
      o.licenses = 0 
      AND nl.product_group_id = pr.product_group_id
    )
  ) 
  AND a.se_0_order = o.se_0_order 
  AND e.order_id is null 
  AND ay.academic_year_id = b.academic_year_id 
  AND ay.summer = '$summer' 
  AND ay.end_date > o.academic_year_end_date 
GROUP BY 
  b.account_id, 
  o.order_id, 
  opm.opportunity_product_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/index.php:269</td><td>CREATE $temp table opps_future_$table_suffix 
SELECT 
  b.account_id, 
  o.order_id, 
  opm.opportunity_product_id, 
  group_concat(
    distinct concat(
      (
        round(op.probability_percent * 100)
      ), 
      '%'
    ) separator '; '
  ) status 
FROM 
  (
    quotes a, quote_details b, opportunities c, 
    opportunity_probabilities op, products p, 
    sub_products sp, orders_$table_suffix o, 
    academic_years ay
  ) 
  LEFT JOIN opportunity_product_map opm ON (
    c.opportunity_id = opm.opportunity_id
  ) 
  LEFT JOIN non_license_products_$table_suffix nl ON (
    o.order_id = nl.order_id 
    AND o.account_id = nl.account_id
  ) 
WHERE 
  a.quote_id = b.quote_id 
  AND c.opportunity_id = a.opportunity_id 
  AND c.order_id = 0 
  AND c.probability_id IN (
    " . implode(", ", array_keys($opportunity_probabilities)) . "
  ) 
  AND op.probability_id = c.probability_id 
  AND p.product_id = b.product_id 
  AND p.product_id = sp.product_id 
  AND (
    (
      o.licenses = 1 
      AND sp.sub_product_type_id = 1
    ) 
    OR (
      o.licenses = 0 
      AND nl.product_group_id = p.product_group_id
    )
  ) 
  AND c.lead_source_id = 7 
  AND (
    a.final = 1 
    or a.date_entered >= '" . date("Y-m-d", mktime(0,0,0,date(m)-3, 1, date(Y))) . "'
  ) 
  AND o.account_id = b.account_id 
  AND ay.academic_year_id = b.academic_year_id 
  AND ay.summer = '$summer' 
  AND ay.end_date > o.academic_year_end_date 
GROUP BY 
  b.account_id, 
  o.order_id, 
  opm.opportunity_product_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/index.php:304</td><td>CREATE $temp table order_totals_$table_suffix 
SELECT 
  DISTINCT o.order_id, 
  os.order_total 
FROM 
  orders_$table_suffix o, 
  order_summary os 
WHERE 
  o.order_id = os.order_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/index.php:314</td><td>CREATE $temp table discounts_$table_suffix 
SELECT 
  distinct a.order_id, 
  order_total, 
  (
    order_total +(
      sum(b.price)*-1
    )
  ) order_total_plus_discount, 
  (
    sum(b.price)*-1
  ) total_discount, 
  (
    sum(
      if (b.product_id <> 2, b.price, 0)
    )*-1
  ) total_standard_discount, 
  (
    sum(
      if (b.product_id = 2, b.price, 0)
    )*-1
  ) total_non_standard_discount, 
  (
    (
      sum(b.price)*-1
    )/(
      order_total +(
        sum(b.price)*-1
      )
    )
  ) discount_percent, 
  (
    (
      sum(
        if (b.product_id <> 2, b.price, 0)
      )*-1
    )/(
      order_total +(
        sum(b.price)*-1
      )
    )
  ) standard_discount_percent, 
  (
    (
      sum(
        if (b.product_id = 2, b.price, 0)
      )*-1
    )/(
      order_total +(
        sum(b.price)*-1
      )
    )
  ) non_standard_discount_percent 
FROM 
  order_totals_$table_suffix a, 
  order_details b, 
  products c 
WHERE 
  a.order_id = b.order_id 
  AND b.product_id = c.product_id 
  AND product_group_id = '" . $PRODUCT_GROUPS["discount"] . "' 
GROUP BY 
  a.order_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/index.php:346</td><td>CREATE 
/*$temp*/
table exception_products_$table_suffix 
SELECT 
  a.order_id, 
  a.account_id, 
  if (
    p.sku like '%bbcp%', 
    'Blackbelt', 
    if (
      p.product_group_id = '" . $PRODUCT_GROUPS["pd"] . "', 
      'PD', 
      if (
        p.product_group_id = '" . $PRODUCT_GROUPS["project_management"] . "', 
        'Project Management', 
        if (
          p.product_group_id = '" . $PRODUCT_GROUPS["levelset"] . "', 
          'Levelset', 
          if (
            p.summer_type_id > 0, 
            'Summer', 
            if (
              p.product_group_id IN (
                '" . implode("', ' ", $upgrade_product_groups) . "'
              ), 
              'Upgrade', 
              ''
            )
          )
        )
      )
    )
  ) exception_product 
FROM 
  orders_$table_suffix a, 
  order_details b, 
  products p 
WHERE 
  a.order_id = b.order_id 
  AND a.account_id = b.account_id 
  AND b.status = 0 
  AND p.product_id = b.product_id 
  AND p.product_group_id NOT IN (
    '" . $PRODUCT_GROUPS["discount"] . "', 
    '" . $PRODUCT_GROUPS["fee"] . "'
  ) $whereStr</td><td></td><td></td></tr>
   <tr><td>reports/renewal/index.php:367</td><td>CREATE $temp table no_exception_products_$table_suffix 
SELECT 
  DISTINCT order_id, 
  account_id 
FROM 
  exception_products_$table_suffix 
WHERE 
  exception_product = ''</td><td></td><td></td></tr>
   <tr><td>reports/renewal/index.php:396</td><td>CREATE $temp table exception_orders_$table_suffix 
SELECT 
  order_id, 
  account_id, 
  concat(
    group_concat(
      distinct exception_product 
      order by 
        exception_product separator '/'
    ), 
    ' only'
  ) exception_reason 
FROM 
  exception_products_$table_suffix 
GROUP BY 
  order_id, 
  account_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/index.php:533</td><td>CREATE $temp table order_years_$table_suffix 
SELECT 
  distinct b.order_id, 
  b.order_length total_years, 
  b.order_date, 
  b.start_date order_start_date, 
  b.end_date order_end_date, 
  b.start_date first_start, 
  b.end_date last_end, 
  os.order_total multi_year_order_total, 
  count(
    distinct(
      if(
        ay.summer = '$summer', od.academic_year_id, 
        null
      )
    )
  ) ay_count 
FROM 
  orders b, 
  orders_$table_suffix c, 
  order_details od, 
  order_summary os, 
  academic_years ay 
WHERE 
  b.order_id = c.order_id 
  AND b.order_id = od.order_id 
  and od.status = 0 
  AND b.order_id = os.order_id 
  AND ay.academic_year_id = od.academic_year_id 
GROUP BY 
  b.order_id 
  /*HAVING total_years > 1*/</td><td></td><td></td></tr>
   <tr><td>reports/renewal/index.php:549</td><td>CREATE $temp table order_details_$table_suffix 
SELECT 
  a.state_code state, 
  c.county_name, 
  if (
    a.account_level = 2, d.account_id, 
    a.account_id
  ) district_id, 
  if (
    a.account_level = 2, d.account_name, 
    a.account_name
  ) district_name, 
  if (
    a.account_level = 2, a.account_id, 
    ''
  ) school_id, 
  if (
    a.account_level = 2, a.account_name, 
    ''
  ) school_name, 
  e.account_id buyer_account_id, 
  e.account_name buyer_name, 
  sum(total_purchased) total_purchased_no_discounts, 
  sum(standard_discount_amount) standard_discount_amount, 
  sum(non_standard_discount_amount) non_standard_discount_amount, 
  sum(total_purchased_new) total_purchased_discounts, 
  sum(total_purchased_standard) total_purchased_standard_discount, 
  max(order_detail_end) order_detail_end, 
  group_concat(distinct u.user_id) sales_rep_id, 
  group_concat(
    distinct u.first_name, ' ', u.last_name
  ) sales_rep, 
  group_concat(distinct u2.user_id) account_sales_rep_id, 
  concat(ur.first_name, ' ', ur.last_name) renewal_rep, 
  group_concat(
    distinct u2.first_name, ' ', u2.last_name
  ) account_sales_rep, 
  account_user_status, 
  o.buyer_contact, 
  group_concat(
    distinct u3.first_name, ' ', u3.last_name
  ) final_sales_rep, 
  final_user_id, 
  o.trainer_id, 
  o.order_id, 
  total_years, 
  order_date, 
  order_start_date, 
  order_end_date, 
  first_start multi_order_start, 
  last_end multi_order_end, 
  ay_count, 
  multi_year_order_total, 
  renewal_order, 
  renewal_order_date, 
  renewal_opportunity_status, 
  o.opportunity_product_id, 
  o.opportunity_id, 
  o.opportunity_type, 
  o.se_0_order, 
  tiers.tier_name, 
  o.exception_reason 
FROM 
  (
    orders_$table_suffix o, accounts a
  ) 
  LEFT JOIN accounts e ON o.ordering_account_id = e.account_id 
  LEFT JOIN accounts d on a.parent_account_id = d.account_id 
  LEFT JOIN users u on o.user_id = u.user_id 
  LEFT JOIN users u2 on o.account_user_id = u2.user_id 
  LEFT JOIN users u3 on o.final_user_id = u3.user_id 
  LEFT JOIN order_years_$table_suffix nr ON (o.order_id = nr.order_id) 
  LEFT JOIN user_accounts uar ON (
    a.account_id = uar.account_id 
    AND uar.role_id = 25
  ) # renewal rep
  LEFT JOIN users ur ON (ur.user_id = uar.user_id) 
  LEFT JOIN counties c ON (c.county_id = a.county_id) 
  LEFT JOIN tiers ON (a.tier_id = tiers.tier_id) 
WHERE 
  a.account_id = o.account_id 
GROUP BY 
  state, 
  district_name, 
  school_name, 
  buyer_account_id, 
  o.order_id 
ORDER BY 
  state, 
  district_name, 
  school_name, 
  u.first_name, 
  u.last_name</td><td></td><td></td></tr>
   <tr><td>reports/renewal/index.php:607</td><td>CREATE $temp TABLE product_lines_$table_suffix 
SELECT 
  o.order_id, 
  o.account_id, 
  GROUP_CONCAT(
    DISTINCT IFNULL(
      pr.program_name, pl.product_line_str
    ) 
    ORDER BY 
      IFNULL(
        pr.program_name, pl.product_line_str
      )
  ) products_on_order 
FROM 
  orders_$table_suffix o 
  JOIN order_details b ON o.order_id = b.order_id 
  AND o.account_id = b.account_id 
  JOIN academic_years ay ON ay.academic_year_id = b.academic_year_id 
  JOIN products p ON p.product_id = b.product_id 
  JOIN product_lines pl ON pl.product_line_id = p.product_line_id 
  LEFT JOIN programs pr ON pr.program_id = p.program_id 
  AND pl.product_line_id IN(3, 4, 11) 
WHERE 
  b.status = 0 $whereStr 
  AND ay.academic_year_id = b.academic_year_id 
  AND ay.summer = '$summer' 
GROUP BY 
  b.account_id, 
  b.order_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/index.php:634</td><td>CREATE $temp TABLE licenses_$table_suffix(
  key(order_id), 
  key(account_id)
) 
SELECT 
  b.order_id, 
  b.account_id, 
  SUM(
    IF(
      p.program_id IN (1, 15) 
      AND p.summer_type_id <> 6, 
      aos.student_licenses, 
      0
    )
  ) literacy_license_count, 
  SUM(
    IF(
      (
        (
          p.program_id IN (1, 10, 11, 12, 13, 14, 15) 
          AND p.summer_type_id = 6
        ) 
        OR p.program_id = 11
      ), 
      aos.student_licenses, 
      0
    )
  ) literacy_summer_license_count, 
  SUM(
    IF(
      p.program_id IN (12, 13, 14) 
      AND p.summer_type_id <> 6, 
      aos.student_licenses, 
      0
    )
  ) bae_license_count, 
  SUM(
    IF(
      p.program_id = 10 
      AND p.summer_type_id <> 6, 
      aos.student_licenses, 
      0
    )
  ) levelset_license_count, 
  SUM(
    IF(
      p.program_id = 2, aos.student_licenses, 
      0
    )
  ) science_license_count, 
  #If SmartyAnts licenses contain a 9999, then display 'Unlimited'
  IF(
    SUM(
      IF(
        p.program_id = ".SMARTY_ANTS_PROGRAM." 
        AND p.summer_type_id <> 6, 
        aos.student_licenses, 
        0
      )
    ) >= 9999, 
    'Unlimited', 
    CAST(
      SUM(
        IF(
          p.program_id = ".SMARTY_ANTS_PROGRAM." 
          AND p.summer_type_id <> 6, 
          aos.student_licenses, 
          0
        )
      ) AS CHAR
    )
  ) smartyants_license_count, 
  IF(
    SUM(
      IF(
        p.program_id = ".SMARTY_ANTS_PROGRAM." 
        AND p.summer_type_id = 6, 
        aos.student_licenses, 
        0
      )
    ) >= 9999, 
    'Unlimited', 
    CAST(
      SUM(
        IF(
          p.program_id = ".SMARTY_ANTS_PROGRAM." 
          AND p.summer_type_id = 6, 
          aos.student_licenses, 
          0
        )
      ) AS CHAR
    )
  ) smartyants_summer_license_count 
FROM 
  orders_$table_suffix o 
  JOIN account_order_summary aos ON o.order_id = aos.order_id 
  AND aos.account_id = o.account_id 
  JOIN order_details b ON b.order_detail_id = aos.order_detail_id 
  JOIN academic_years ay ON b.academic_year_id = ay.academic_year_id 
  JOIN products p on p.product_id = b.product_id 
WHERE 
  b.status = 0 $whereStr 
  AND ay.academic_year_id = b.academic_year_id 
  AND aos.reallocated = 0 
  AND ay.summer = '$summer' 
GROUP BY 
  b.account_id, 
  b.order_id</td><td></td><td></td></tr>
   <tr><td>reports/training/cancel_index.php:84</td><td>CREATE TEMPORARY TABLE tmp_used_cancelled_events (
  KEY(cancelled_event_id)
) 
SELECT 
  cancelled_event_id, 
  event_date 
FROM 
  events 
WHERE 
  status = 0 
  AND cancelled_event_id > 0</td><td></td><td>skip</td></tr>
   <tr><td>reports/training/cancel_index.php:118</td><td>CREATE TEMPORARY TABLE tmp_cancelled_events_data (
  KEY(account_id)
) 
SELECT 
  a.state_code, 
  if (
    a.account_level = 2, p.account_name, 
    a.account_name
  ) district_account_name, 
  if (
    a.account_level = 2, a.account_name, 
    ''
  ) school_account_name, 
  a.account_id, 
  e.order_id, 
  group_concat(
    distinct concat(
      wt.workshop_type_name, ': ', w.workshop_name
    ) 
    order by 
      concat(
        wt.workshop_type_name, ': ', w.workshop_name
      ) separator '; '
  ) session_type, 
  concat(u.first_name, ' ', u.last_name) trainer, 
  e.event_date, 
  e.date_entered date_scheduled, 
  e.shared_day, 
  ec.date_entered date_cancelled, 
  ec.cancel_reason_id, 
  ec.cancel_reason_text, 
  if (
    e2.cancelled_event_id is not null, 
    'Y', ec.rescheduled
  ) rescheduled, 
  if (
    e2.cancelled_event_id is not null, 
    e2.event_date, ec.reschedule_date
  ) reschedule_date, 
  group_concat(
    distinct a2.account_name 
    order by 
      ea.is_primary desc, 
      a2.account_name separator '; '
  ) event_accounts 
FROM 
  (
    order_details od, orders o, events e, 
    accounts a, event_cancels ec, event_users eu, 
    users u, event_accounts ea, accounts a2
  ) 
  LEFT JOIN accounts p ON (
    p.account_id = a.parent_account_id
  ) 
  LEFT JOIN event_workshops ew ON (e.event_id = ew.event_id) 
  LEFT JOIN workshops w ON (w.workshop_id = ew.workshop_id) 
  LEFT JOIN workshop_types wt ON (
    wt.workshop_type_id = w.workshop_type_id
  ) 
  LEFT JOIN tmp_used_cancelled_events e2 ON (
    e.event_id = e2.cancelled_event_id
  ) 
WHERE 
  od.order_detail_id = e.order_detail_id 
  AND od.status = 0 
  AND o.order_id = od.order_id 
  AND o.status = 0 
  AND a.account_id = od.account_id 
  AND e.event_id = ec.event_id 
  AND e.event_id = eu.event_id 
  AND eu.is_primary = 1 
  AND u.user_id = eu.user_id 
  AND e.event_id = ea.event_id 
  AND a2.account_id = ea.account_id $whereStr 
GROUP BY 
  e.event_id 
ORDER BY 
  e.event_date desc</td><td></td><td>skip</td></tr>
   <tr><td>reports/training/cancel_index.php:150</td><td>CREATE TEMPORARY TABLE tmp_account_users (
  KEY(account_id), 
  KEY(state_code)
) 
SELECT 
  DISTINCT account_id, 
  state_code 
FROM 
  tmp_cancelled_events_data</td><td></td><td>skip</td></tr>
   <tr><td>util/function/billing.php:11</td><td>CREATE TEMPORARY TABLE tmp_payment_import (
  primary key (
    transaction_id, invoice_date, transaction_amount, 
    ns_invoice_id
  )
) 
SELECT 
  t.order_id, 
  t.transaction_id, 
  t.invoice_id ns_invoice_id, 
  i.invoice_id, 
  t.transaction_date, 
  t.transaction_amount, 
  t.date_modified, 
  t.invoice_date 
FROM 
  billing.order_invc_transactions t 
  LEFT JOIN billing.invoices i ON (t.invoice_id = i.ns_invoice_id) 
WHERE 
  transaction_type = 'Payment' 
GROUP BY 
  t.transaction_id, 
  t.invoice_date, 
  t.transaction_amount, 
  t.invoice_id 
ORDER BY 
  t.transaction_date, 
  i.invoice_id;</td><td></td><td>skip</td></tr>
   <tr><td>cron/apr/maintain_apr_recipients.php:14</td><td>CREATE TEMPORARY TABLE default_apr_recipients 
SELECT 
  c.contact_id 
FROM 
  contacts c, 
  accounts a 
WHERE 
  a.account_id = c.account_id 
  AND a.account_level = 1 
  AND c.contact_title_id in (7, 8, 41) 
  AND c.apr_recipient = 1</td><td></td><td>skip</td></tr>
   <tr><td>cron/apr/maintain_apr_recipients.php:60</td><td>CREATE TEMPORARY TABLE default_order_apr_recipients 
SELECT 
  DISTINCT c.contact_id 
FROM 
  (
    contacts c, accounts a, order_contacts oc, 
    orders o, order_details od
  ) 
  LEFT JOIN default_apr_recipients d ON (c.contact_id = d.contact_id) 
WHERE 
  a.account_id = c.account_id 
  AND c.contact_id = oc.contact_id 
  AND o.order_id = oc.order_id 
  AND o.status = 0 
  AND o.order_id = od.order_id 
  AND o.opportunity_product_id = 1 
  AND od.status = 0 
  AND now() between od.start_date 
  and od.end_date 
  AND od.price >= 0 
  AND oc.contact_type_id in (1, 2, 3) 
  AND d.contact_id IS NULL</td><td></td><td>skip</td></tr>
   <tr><td>cron/daily/update_amortization_prior_years.php:65</td><td>CREATE TEMPORARY TABLE interlink_prior_year_changes(
  notes VARCHAR(400) NOT NULL DEFAULT '', 
  status varchar(10) NOT NULL DEFAULT '', 
  KEY(
    order_id, order_detail_id, table_name, 
    column_name, is_valid, product_id
  ), 
  KEY(
    table_name, column_name, order_date, 
    status, is_valid, notes
  ), 
  id INT AUTO_INCREMENT PRIMARY KEY
) 
SELECT 
  DISTINCT pyo.order_id, 
  pyod.order_detail_id, 
  pyo.order_date, 
  'prior_years_order_details' table_name, 
  pyod.product_id, 
  od.end_date order_detail_end, 
  'account_id' column_name, 
  pyod.account_id amortization_value, 
  od.account_id interlink_value, 
  1 is_valid, 
  'pending' status, 
  '' notes 
FROM 
  amortization.prior_years_order_details pyod 
  INNER JOIN amortization.prior_years_orders pyo ON (pyod.order_id = pyo.order_id) 
  INNER JOIN interlink.order_details od ON (
    pyod.order_detail_id = od.order_detail_id
  ) 
WHERE 
  pyod.account_id <> od.account_id 
  AND pyo.order_date > '2010-01-01' 
UNION 
SELECT 
  pyo.order_id, 
  pyod.order_detail_id, 
  pyo.order_date, 
  'prior_years_order_details' table_name, 
  pyod.product_id, 
  od.end_date order_detail_end, 
  'academic_year_id' column_name, 
  pyod.academic_year_id amortization_value, 
  od.academic_year_id interlink_value, 
  1 is_valid, 
  'pending' status, 
  '' notes 
FROM 
  amortization.prior_years_order_details pyod 
  INNER JOIN amortization.prior_years_orders pyo ON (pyod.order_id = pyo.order_id) 
  INNER JOIN interlink.order_details od ON (
    pyod.order_detail_id = od.order_detail_id
  ) 
WHERE 
  pyod.academic_year_id <> od.academic_year_id 
  AND pyo.order_date > '2010-01-01' 
UNION 
SELECT 
  pyo.order_id, 
  pyod.order_detail_id, 
  pyo.order_date, 
  'prior_years_order_details' table_name, 
  pyod.product_id, 
  od.end_date order_detail_end, 
  'product_id' column_name, 
  pyod.product_id amortization_value, 
  od.product_id interlink_value, 
  1 is_valid, 
  'pending' status, 
  '' notes 
FROM 
  amortization.prior_years_order_details pyod 
  INNER JOIN amortization.prior_years_orders pyo ON (pyod.order_id = pyo.order_id) 
  INNER JOIN interlink.order_details od ON (
    pyod.order_detail_id = od.order_detail_id
  ) 
WHERE 
  pyod.product_id <> od.product_id 
  AND pyo.order_date > '2010-01-01' 
UNION 
SELECT 
  pyo.order_id, 
  0 order_detail_id, 
  pyo.order_date, 
  'prior_years_orders' table_name, 
  0 product_id, 
  o.end_date order_end, 
  'account_id' column_name, 
  pyo.account_id amortization_value, 
  a.account_id interlink_value, 
  1 is_valid, 
  'pending' status, 
  '' notes 
FROM 
  amortization.prior_years_orders pyo 
  INNER JOIN interlink.orders o ON (pyo.order_id = o.order_id) 
  INNER JOIN interlink.accounts a ON (o.account_id = a.account_id) 
WHERE 
  pyo.account_id <> a.account_id 
  AND pyo.order_date > '2010-01-01'</td><td></td><td>skip</td></tr>
   <tr><td>cron/daily/update_amortization_prior_years.php:117</td><td>CREATE TEMPORARY TABLE products_spread_revenue(
  PRIMARY KEY(product_id)
) 
SELECT 
  DISTINCT sp.product_id 
FROM 
  interlink.sub_products sp 
  INNER JOIN interlink.sub_product_types spt ON sp.sub_product_type_id = spt.sub_product_type_id 
WHERE 
  spt.my_spread_revenue = 'Y'</td><td></td><td>skip</td></tr>
   <tr><td>cron/daily/update_amortization_prior_years.php:187</td><td>CREATE TEMPORARY TABLE pd_quantity (
  PRIMARY KEY(quantity)
) 
SELECT 
  @row_num := @row_num + 1 quantity 
FROM 
  (
    SELECT 
      @row_num := 0
  ) a 
  JOIN orders b 
LIMIT 
  500</td><td></td><td>skip</td></tr>
   <tr><td>cron/daily/update_amortization_prior_years.php:199</td><td>CREATE TABLE interlink_products{$tmp_table_nm}(
  id INT AUTO_INCREMENT PRIMARY KEY, 
  INDEX(product_id, row_num)
) 
SELECT 
  CASE a.product_id WHEN @product_id THEN @row_num := @row_num + 1 ELSE @row_num := 1 
  AND @product_id := a.product_id END row_num, 
  a.product_id, 
  a.sku, 
  a.product_name, 
  a.student_licenses, 
  a.domain_id, 
  a.program_id, 
  a.product_group_id, 
  a.product_set_id, 
  a.partner_id, 
  a.sub_product_id, 
  a.sub_product_type_id, 
  a.pd_deliverable, 
  a.orig_list_price, 
  a.list_price, 
  1 quantity, 
  a.orig_quantity 
FROM 
  (
    SELECT 
      p.product_id, 
      p.sku, 
      p.product_name, 
      p.student_licenses, 
      p.domain_id, 
      p.program_id, 
      p.product_group_id, 
      p.product_set_id, 
      p.partner_id, 
      sp.sub_product_id, 
      sp.sub_product_type_id, 
      spt.pd_deliverable, 
      sp.list_price orig_list_price, 
      CASE WHEN spt.pd_deliverable = 'N' THEN sp.list_price * sp.sub_product_qty ELSE sp.list_price END list_price, 
      CASE WHEN spt.pd_deliverable = 'N' THEN 1 ELSE sp.sub_product_qty END orig_quantity 
    FROM 
      products p 
      INNER JOIN sub_products sp ON (p.product_id = sp.product_id) 
      INNER JOIN sub_product_types spt ON (
        sp.sub_product_type_id = spt.sub_product_type_id
      ) 
    ORDER BY 
      product_id, 
      sub_product_type_id, 
      list_price
  ) a 
  INNER JOIN pd_quantity q ON (q.quantity <= a.orig_quantity) CROSS 
  JOIN (
    SELECT 
      @product_id := 0, 
      @row_num := 0
  ) r 
ORDER BY 
  product_id, 
  sub_product_type_id, 
  list_price</td><td></td><td></td></tr>
   <tr><td>cron/pro_spk_ytd_mc_fields.php:13</td><td>CREATE TABLE tech.fm_ytd_user_summary (
  KEY(school_id), 
  KEY(user_id)
) 
SELECT 
  * 
FROM 
  summary.ytd_user_summary 
WHERE 
  school_id IN (
    3100, 20100, 19215, 22560, 6353, 6352, 
    20800, 17677, 15193, 17775, 17777, 
    17776, 17774, 17773, 17778, 17779, 
    18989, 19775, 21092, 22063
  ) 
  AND program_id IN (1, 12, 13, 14, 15)</td><td></td><td></td></tr>
   <tr><td>cron/pro_spk_ytd_mc_fields.php:25</td><td>CREATE TABLE tech.fm_user_dates (
  KEY(school_id), 
  KEY(user_id)
) 
SELECT 
  up.school_id, 
  up.user_id, 
  MIN(d.school_start) school_start, 
  MAX(d.school_end) school_end 
FROM 
  tech.wu_school_dates d, 
  tech.wu_user_programs up, 
  tech.wu_ls_users l, 
  mykidbiz.schools s 
WHERE 
  d.account_id = s.account_id 
  and s.school_id = up.school_id 
  AND s.school_id IN (
    3100, 20100, 19215, 22560, 6353, 6352, 
    20800, 17677, 15193, 17775, 17777, 
    17776, 17774, 17773, 17778, 17779, 
    18989, 19775, 21092, 22063
  ) 
  AND d.program_name in (
    'Language Arts', 'Boost', 'Access', 
    'EspaÃ±ol', 'Espanol', 'Pro'
  ) 
  AND up.program_id IN (1, 12, 13, 14, 15) 
  AND s.school_id = l.school_id 
  AND up.user_id = l.user_id 
  AND l.program_id IN (1, 12, 13, 14, 15) 
  AND up.subscriber_type = 1 
GROUP BY 
  s.school_id, 
  up.user_id</td><td></td><td></td></tr>
   <tr><td>cron/pro_spk_ytd_mc_fields.php:52</td><td>create table tech.fm_ytd_avg_activity_score(
  key(school_id)
) 
SELECT 
  s.school_id, 
  SUM(
    (
      s.average_basic_news_score * s.basic_news_activities
    ) + (
      s.average_biology_score * s.biology_activities
    )
  ) / SUM(
    s.basic_news_activities + s.biology_activities
  ) ytd_avg_activity_score_by_account 
FROM 
  tech.fm_ytd_user_summary s, 
  tech.fm_user_dates d 
WHERE 
  s.user_id = d.user_id 
  AND s.school_id = d.school_id 
  AND s.daily_date BETWEEN d.school_start 
  AND IF (
    d.school_end > '" . $report_end_date . "', 
    '" . $report_end_date . "', d.school_end
  ) 
GROUP BY 
  s.school_id</td><td></td><td></td></tr>
   <tr><td>cron/pro_spk_ytd_mc_fields.php:117</td><td>CREATE TABLE tech.fm_user_activities (
  KEY(school_id), 
  KEY(user_id)
) 
SELECT 
  s.school_id, 
  s.user_id, 
  SUM(
    s.basic_news_activities + s.biology_activities
  ) ytd_activities 
FROM 
  tech.fm_ytd_user_summary s, 
  tech.fm_user_dates d 
WHERE 
  s.user_id = d.user_id 
  AND s.school_id = d.school_id 
  AND s.daily_date BETWEEN d.school_start 
  AND IF (
    d.school_end > '" . $report_end_date ."', 
    '" . $report_end_date . "', d.school_end
  ) 
GROUP BY 
  s.school_id, 
  s.user_id</td><td></td><td></td></tr>
   <tr><td>cron/pro_spk_ytd_mc_fields.php:130</td><td>create table tech.fm_ytd_activities(
  key(school_id)
) 
SELECT 
  school_id, 
  COUNT(
    IF (
      ytd_activities BETWEEN 1 
      AND 19, 
      1, 
      NULL
    )
  ) ytd_1_19_activity_users, 
  COUNT(
    IF (ytd_activities = 0, 1, NULL)
  ) ytd_0_activity_users, 
  COUNT(
    IF (
      ytd_activities BETWEEN 1 
      AND 9, 
      1, 
      NULL
    )
  ) ytd_1_9_activity_users, 
  COUNT(
    IF (
      ytd_activities BETWEEN 10 
      AND 19, 
      1, 
      NULL
    )
  ) ytd_10_19_activity_users, 
  COUNT(
    IF (
      ytd_activities BETWEEN 20 
      AND 39, 
      1, 
      NULL
    )
  ) ytd_20_39_activity_users, 
  COUNT(
    IF (
      ytd_activities BETWEEN 40 
      AND 79, 
      1, 
      NULL
    )
  ) ytd_40_79_activity_users, 
  COUNT(
    IF (ytd_activities >= 80, 1, NULL)
  ) ytd_80_plus_activity_users 
FROM 
  tech.fm_user_activities 
GROUP BY 
  school_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:142</td><td>CREATE TABLE convert_pd_details (
  PRIMARY KEY (order_detail_id)
) 
SELECT 
  order_id, 
  order_detail_id, 
  MIN(parent_order_detail_id) parent_order_detail_id, 
  MAX(convert_time) convert_time 
FROM 
  amortization.order_detail_convert_parents 
WHERE 
  convert_time > '$last_run_date' 
  OR convert_time > '$report_start_month' 
GROUP BY 
  order_detail_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:156</td><td>CREATE TABLE prior_years_order_detail_edits (
  PRIMARY KEY (order_detail_id)
) 
SELECT 
  cpd.order_detail_id log_id, 
  cpd.order_id, 
  cpd.order_detail_id, 
  1 is_pd_conversion, 
  0 is_detail_update 
FROM 
  convert_pd_details cpd 
  INNER JOIN interlink.orders o ON o.order_id = cpd.order_id 
WHERE 
  o.order_date <= '$lock_year-12-31';</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:169</td><td>CREATE TABLE amortization.tmp_amort_prior_years_updated_orders (
  PRIMARY KEY (order_id)
) 
SELECT 
  od.order_id 
FROM 
  interlink.order_detail_update_log odl 
  INNER JOIN interlink.order_details od ON od.order_detail_id = odl.order_detail_id 
  INNER JOIN interlink.orders o ON o.order_id = od.order_id 
  INNER JOIN amortization.lock_month lm ON odl.date_modified > LAST_DAY(lm.lock_month) 
WHERE 
  o.order_date < '$report_year-01-01' 
GROUP BY 
  od.order_id;</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:188</td><td>CREATE TABLE amortization.tmp_amort_prior_years_updated_order_details (
  PRIMARY KEY (order_detail_id)
) 
SELECT 
  odl.log_id, 
  o.order_id, 
  odl.order_detail_id, 
  orn.order_total il_order_total, 
  oda.order_total amort_order_total, 
  CASE WHEN ABS(
    orn.order_total - oda.order_total
  )<.01 THEN 1 ELSE 0 END order_totals_match 
FROM 
  interlink.order_detail_update_log odl 
  INNER JOIN interlink.order_details od ON od.order_detail_id = odl.order_detail_id 
  INNER JOIN interlink.orders o ON o.order_id = od.order_id 
  INNER JOIN amortization.tmp_amort_prior_years_updated_orders upo ON upo.order_id = o.order_id 
  LEFT JOIN (
    SELECT 
      rn.order_id, 
      GREATEST(
        SUM(
          line_list_price + pro_rated_fees + pro_rated_discounts
        ), 
        0
      ) order_total 
    FROM 
      interlink.order_new_renewal_data rn 
      INNER JOIN amortization.tmp_amort_prior_years_updated_orders pyo ON pyo.order_id = rn.order_id 
    GROUP BY 
      order_id
  ) orn ON orn.order_id = o.order_id 
  LEFT JOIN (
    SELECT 
      oda.order_id, 
      SUM(period_total) order_total 
    FROM 
      amortization.order_detail_amortization_{$lock_year}1201 oda 
      INNER JOIN amortization.tmp_amort_prior_years_updated_orders pyo ON pyo.order_id = oda.order_id 
    WHERE 
      oda.cancel_id = 0 
    GROUP BY 
      order_id
  ) oda ON oda.order_id = o.order_id;</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:236</td><td>create table order_total_temp (
  PRIMARY KEY (order_id)
) 
select 
  o.order_id, 
  o.om_order_id, 
  sum(od.price * od.quantity) order_total 
from 
  $data_db.order_details od, 
  $data_db.orders o 
where 
  o.order_id = od.order_id 
group by 
  o.order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:250</td><td>create table include_om_orders (
  PRIMARY KEY (order_id)
) 
select 
  i.order_id, 
  i.om_order_id, 
  a.account_name, 
  t.order_total il_data_total, 
  a.order_total om_order_total, 
  a.om_total om_om_total 
from 
  (
    $old_amortization_db.orders a, order_total_temp t, 
    $data_db.orders i
  ) 
  left join multi_year_orders my on (i.order_id = my.order_id) 
where 
  a.order_id = i.om_order_id 
  and my.order_id is null 
  and i.order_id = t.order_id 
  and i.order_id not in (4502) 
  and i.order_date < '2009-08-11'</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:267</td><td>CREATE TABLE tmp_future_full_cancels (
  PRIMARY KEY (order_id)
) 
SELECT 
  o.order_id 
FROM 
  interlink.orders o 
  INNER JOIN interlink.order_cancels oc ON oc.order_id = o.order_id 
  AND oc.status = 0 
  AND oc.credit_type = 'f' 
  AND oc.cancel_date > '$report_end_date' 
WHERE 
  o.status = 1 
GROUP BY 
  o.order_id;</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:276</td><td>CREATE TABLE tmp_future_partial_cancels (
  PRIMARY KEY (order_detail_id)
) 
SELECT 
  od.order_detail_id 
FROM 
  interlink.orders o 
  INNER JOIN interlink.order_cancels oc ON oc.order_id = o.order_id 
  AND oc.status = 0 
  AND oc.credit_type = 'p' 
  AND oc.cancel_date > '$report_end_date' 
  INNER JOIN interlink.order_details od on od.order_id = o.order_id 
  and oc.cancel_id = od.cancel_id 
  and od.status = 1 
WHERE 
  1 
GROUP BY 
  od.order_detail_id;</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:291</td><td>create table orders (
  PRIMARY KEY (order_id)
) 
select 
  o.order_id, 
  o.om_order_id, 
  o.account_id, 
  a.state_code, 
  a.account_name, 
  o.order_date, 
  o.start_date, 
  o.end_date, 
  if(
    i.order_id, i.om_order_total, t.order_total
  ) order_total, 
  if(
    i.order_id, i.om_om_total, t.order_total
  ) orig_order_total, 
  if(
    o.status = 1 
    and fcn.order_id is null, 
    'Y', 
    ''
  ) cancel, 
  curdate() cancel_date, 
  9999999999.99 cancel_total, 
  9999999999.99 tax_cancel_total, 
  9999999999.99 cancel_total1, 
  9999999999.99 cancel_total2, 
  9999999999.99 cancel_total3, 
  curdate() last_cancel_date, 
  curdate() first_cancel_date, 
  if(
    a.account_level = 2, p.account_id, 
    ''
  ) district_account_id, 
  if(
    a.account_level = 2, p.account_name, 
    ''
  ) district, 
  if(
    bill.account_id is not null, bill.account_id, 
    a.account_id
  ) billing_account_id, 
  if(
    bill.account_id is not null, bill.account_name, 
    a.account_name
  ) billto, 
  o.ns_order_id, 
  o.order_length, 
  o.expansion_order_id, 
  o.replacement_order_id, 
  r.replacement_order_id second_replacement_order_id, 
  if(
    o.order_date >= '2010-01-01', 
    if(
      r2.order_date is not null, r2.order_date, 
      r.order_date
    ), 
    null
  ) replacement_order_date, 
  o.date_entered 
from 
  (
    $data_db.orders o, order_total_temp t
  ) 
  left join $data_db.accounts a on (o.account_id = a.account_id) 
  left join include_om_orders i on (o.order_id = i.order_id) 
  left join $data_db.accounts p on (
    a.parent_account_id = p.account_id
  ) 
  left join $data_db.accounts bill on (
    o.billing_account_id = bill.account_id
  ) 
  left join $data_db.orders r on (
    o.replacement_order_id = r.order_id
  ) 
  left join $data_db.orders r2 on (
    r.replacement_order_id = r2.order_id
  ) 
  left join tmp_future_full_cancels fcn on fcn.order_id = o.order_id 
where 
  1 
  and o.order_date != 0 
  and o.order_date > '$lock_year-12-31' #orders that yael recreated
  and o.order_id not in (
    select 
      ifnull(old_order_id, 0) 
    from 
      $data_db.recreate_orders_insert
  ) 
  and o.order_id = t.order_id 
order by 
  1</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:367</td><td>create table first_cancel_date (
  PRIMARY KEY (order_id)
) 
select 
  o.order_id, 
  min(oc.cancel_date) cancel_date 
from 
  (
    interlink.order_cancels oc, orders o
  ) 
  left join interlink.order_details od on od.cancel_id = oc.cancel_id 
  and od.order_id = oc.order_id 
where 
  oc.order_id = o.order_id 
  and oc.status = 0 
  AND (
    oc.credit_type = 'F' 
    OR od.cancel_id IS NOT NULL
  ) 
group by 
  oc.order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:400</td><td>create table order_no_discounts (
  PRIMARY KEY (order_id)
) 
select 
  i.order_id 
from 
  orders i, 
  $old_amortization_db.orders_remove_discount r 
where 
  i.om_order_id = r.order_id 
  and i.order_date < '2009-07-01' 
  and i.order_id not in (0)</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:411</td><td>create table od_quantities (id INT AUTO_INCREMENT PRIMARY KEY) 
select 
  distinct round(od.quantity * sp.sub_product_qty) quantity 
from 
  $data_db.order_details od, 
  $data_db.sub_products sp, 
  $data_db.sub_product_types spt 
where 
  od.product_id = sp.product_id 
  and sp.sub_product_type_id = spt.sub_product_type_id 
  and sp.sub_product_qty > 0 
  and spt.pd_deliverable = 'Y' 
union 
select 
  distinct round(od.quantity * sp.sub_product_qty) quantity 
from 
  $data_db.order_details od, 
  $data_db.order_detail_sub_products sp, 
  $data_db.sub_product_types spt 
where 
  od.order_detail_id = sp.order_detail_id 
  and sp.sub_product_type_id = spt.sub_product_type_id 
  and sp.sub_product_qty > 0 
  and spt.pd_deliverable = 'Y' 
union 
select 
  distinct ceil(closed_amount) 
from 
  $data_db.closed_deliverables d, 
  $data_db.sub_product_types spt 
where 
  d.sub_product_type_id = spt.sub_product_type_id 
  and spt.pd_deliverable = 'Y' 
order by 
  1</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:477</td><td>create table order_detail_sub_products_use (
  PRIMARY KEY (order_id)
) 
select 
  distinct order_id 
from 
  $data_db.order_detail_sub_products</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:486</td><td>create table products_non_discountable (
  PRIMARY KEY (product_id)
) 
select 
  distinct pp.product_id, 
  product_name, 
  product_group_id, 
  sku 
from 
  products pp 
where 
  pp.product_id not in (
    select 
      distinct p.product_id 
    from 
      products p, 
      sub_products sp, 
      sub_product_types spt 
    where 
      p.product_id = sp.product_id 
      and sp.sub_product_type_id = spt.sub_product_type_id 
      and spt.discountable = 'Y'
  )</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:503</td><td>create table order_detail_product_list (
  PRIMARY KEY (order_detail_id), 
  INDEX(product_id)
) 
select 
  od.order_id, 
  od.order_detail_id, 
  od.product_id, 
  od.price, 
  sum(
    COALESCE(
      odsp.list_price, slpc.price * sp.sub_product_qty, 
      sp.list_price * sp.sub_product_qty
    )
  ) list_price, 
  $fee_str fee_list_price, 
  od.price - sum(
    COALESCE(
      odsp.list_price, slpc.price * sp.sub_product_qty, 
      sp.list_price * sp.sub_product_qty
    )
  ) product_discount, 
  (od.price - $fee_str)/(
    sum(
      COALESCE(
        odsp.list_price, slpc.price * sp.sub_product_qty, 
        sp.list_price * sp.sub_product_qty
      )
    )- $fee_str
  ) product_discount_perc 
from 
  (
    $data_db.order_details od, $data_db.products p
  ) 
  left join $data_db.order_detail_sub_products odsp on (
    od.order_detail_id = odsp.order_detail_id
  ) 
  left join $data_db.sub_products sp on (
    od.product_id = sp.product_id 
    and sp.status = 0 
    and odsp.order_detail_id is null
  ) 
  left join $data_db.sub_product_types spt on (
    spt.sub_product_type_id in (
      odsp.sub_product_type_id, sp.sub_product_type_id
    )
  ) 
  left join products_non_discountable nd on (od.product_id = nd.product_id) 
  left join $data_db.sp_list_price_changes slpc on slpc.order_detail_id = od.order_detail_id 
  AND slpc.sub_product_id = sp.sub_product_id 
where 
  od.product_id = p.product_id 
group by 
  od.order_detail_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:524</td><td>create table order_details (
  line_id int not null primary key auto_increment, 
  INDEX(order_id, academic_year_id), 
  INDEX(
    order_id, account_id, sub_product_type_id, 
    student_licenses
  ), 
  INDEX(
    order_detail_id, sub_product_type_id
  ), 
  INDEX(order_id, orig_cancel_id), 
  INDEX(order_id, cancel)
) 
select 
  NULL line_id, 
  od.order_id, 
  od.om_order_id, 
  od.order_detail_id, 
  if(
    od.account_id, od.account_id, o.account_id
  ) account_id, 
  if(
    a.account_id is null, ao.account_name, 
    a.account_name
  ) account_name, 
  p.sku, 
  spt.sub_product_type_name, 
  if(
    nd.order_id 
    and odsp.order_id, 
    odsp.price, 
    COALESCE(
      odsp.list_price, slpc.price, sp.list_price
    )
  ) price, 
  if(
    odsp.order_id, odsp.price, od.price
  ) orig_price, 
  round(
    if(
      spt.pd_deliverable = 'Y' 
      and od.start_date >= spt.pd_deliverable_start_date, 
      if(
        odsp.order_id 
        and odsp.sub_product_qty < 1 
        and od.quantity = 1, 
        odsp.sub_product_qty, 
        1
      ), 
      od.quantity
    ), 
    1
  ) quantity, 
  if(
    nd.order_id 
    and odsp.order_id, 
    odsp.price, 
    COALESCE(
      odsp.list_price, slpc.price, sp.list_price
    )
  )* if(
    spt.pd_deliverable = 'Y' 
    and od.start_date >= spt.pd_deliverable_start_date, 
    if(
      odsp.order_id 
      and odsp.sub_product_qty < 1 
      and od.quantity = 1, 
      odsp.sub_product_qty, 
      1
    ), 
    od.quantity
  ) product_total, 
  999999999.99999999 after_prod_total, 
  999999999.99999999 after_my_total, 
  999999999.99999999 after_std_total, 
  999999999.99999999 discounted_total, 
  199 sort, 
  od.start_date, 
  od.end_date, 
  pl.list_price product_list_price, 
  COALESCE(
    odsp.list_price, slpc.price, sp.list_price
  ) list_price, 
  od.quantity orig_quantity, 
  if(
    odsp.order_id, odsp.sub_product_qty, 
    sp.sub_product_qty
  ) sub_product_qty, 
  spt.sub_product_type_id, 
  spt.amortization_group_id, 
  p.product_id, 
  if(
    odsp.order_id, null, sp.sub_product_id
  ) sub_product_id, 
  if(
    spt.pd_deliverable = 'Y' 
    and od.start_date < spt.pd_deliverable_start_date, 
    'N', 
    spt.pd_deliverable
  ) pd_deliverable, 
  pd_deliverable_start_date, 
  spt.pd_sort, 
  discountable, 
  if(
    o.order_date < '2009-07-01' 
    and spt.sub_product_type_id = 9, 
    'N', 
    std_discount
  ) std_discount, 
  p.product_name, 
  p.student_licenses, 
  ay.summer, 
  p.domain_id, 
  p.program_id, 
  p.product_group_id, 
  if(
    p.product_set_id = 11, 10, p.product_set_id
  ) product_set_id, 
  p.partner_id product_partner_id, 
  cancel_id orig_cancel_id, 
  if(
    (
      od.status = 1 
      AND fpc.order_detail_id is null
    ) 
    or o.cancel = 'Y', 
    'Y', 
    ''
  ) cancel, 
  99999 cancel_id1, 
  curdate() cancel_date1, 
  9999999999.99999999 cancel_total1, 
  99999 cancel_id2, 
  curdate() cancel_date2, 
  9999999999.99999999 cancel_total2, 
  99999 cancel_id3, 
  curdate() cancel_date3, 
  9999999999.99999999 cancel_total3, 
  99999 cancel_id4, 
  curdate() cancel_date4, 
  9999999999.99 cancel_total4, 
  99999 cancel_id5, 
  curdate() cancel_date5, 
  9999999999.99 cancel_total5, 
  9999999999 pd_event_id, 
  od.academic_year_id, 
  ay.academic_year_name academic_year, 
  ay.sort academic_year_sort, 
  CASE WHEN slpc.order_detail_id THEN 1 ELSE 0 END list_price_changed 
from 
  (
    orders o, $data_db.order_details od, 
    $data_db.products p, $data_db.product_groups pg, 
    pd_quantity q
  ) 
  left join $data_db.accounts a on (a.account_id = od.account_id) 
  left join $data_db.accounts ao on (ao.account_id = o.account_id) 
  left join order_detail_product_list pl on (
    od.order_detail_id = pl.order_detail_id
  ) 
  left join order_detail_sub_products_use odspu on (o.order_id = odspu.order_id) 
  left join order_no_discounts nd on (o.order_id = nd.order_id) 
  left join $data_db.order_detail_sub_products odsp on (
    od.order_detail_id = odsp.order_detail_id
  ) 
  left join $data_db.sub_products sp on (
    od.product_id = sp.product_id 
    and sp.status = 0 
    and odspu.order_id is null
  ) 
  left join $data_db.sub_product_types spt on (
    spt.sub_product_type_id in (
      odsp.sub_product_type_id, sp.sub_product_type_id
    )
  ) 
  left join $data_db.academic_years ay on (
    od.academic_year_id = ay.academic_year_id
  ) 
  left join $data_db.orders_before_oct06 co on (o.order_id = co.order_id) 
  left join tmp_future_partial_cancels fpc on fpc.order_detail_id = od.order_detail_id 
  left join prior_years_order_detail_edits convert_pd on convert_pd.order_detail_id = od.order_detail_id 
  AND convert_pd.order_id = od.order_id 
  left join $data_db.sp_list_price_changes slpc on slpc.order_detail_id = od.order_detail_id 
  and slpc.sub_product_id = sp.sub_product_id 
where 
  o.order_id = od.order_id 
  and (
    o.order_date > '$lock_year-12-31' 
    OR convert_pd.order_detail_id is not null
  ) 
  and if(
    if(
      odsp.order_id, odsp.sub_product_qty, 
      sp.sub_product_qty
    )* od.quantity <= 1 
    or spt.pd_deliverable != 'Y' 
    or od.start_date < spt.pd_deliverable_start_date, 
    1, 
    round(
      if(
        odsp.order_id, odsp.sub_product_qty, 
        sp.sub_product_qty
      )* od.quantity
    )
  ) = q.pd_quantity 
  and od.product_id = p.product_id 
  and p.product_id not in (2109) #remove pd
  and (
    o.order_id not in (1637) 
    or od.price != 0
  ) 
  and p.product_group_id = pg.product_group_id 
  and (
    sp.product_id is not null 
    or odsp.product_id is not null
  ) 
  and pg.discount = 0 
  and od.status != 2 
  and (
    co.order_id is null 
    or o.om_order_id = od.om_order_id
  ) 
order by 
  order_id, 
  order_detail_id, 
  spt.sub_product_type_id, 
  odsp.price</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:650</td><td>CREATE TABLE order_detail_parents (
  PRIMARY KEY (
    order_detail_id, parent_order_detail_id
  )
) 
SELECT 
  od.order_id, 
  log.order_detail_id, 
  log.old_order_detail_id parent_order_detail_id 
FROM 
  interlink.order_detail_update_log log 
  INNER JOIN interlink.order_details od ON od.order_detail_id = log.order_detail_id 
  INNER JOIN interlink.orders o ON o.order_id = od.order_id 
WHERE 
  log.old_order_detail_id > 0 
  AND o.order_date < '{$report_year}-01-01';</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:735</td><td>CREATE TABLE py_order_detail_conversion_sub_product_type_mapping (
  PRIMARY KEY (line_id)
) 
SELECT 
  od.line_id, 
  od.order_id, 
  od.order_detail_id, 
  od.sub_product_type_id, 
  MAX(
    COALESCE(
      pyd.sub_product_type_id, pyd2.sub_product_type_id, 
      pyd3.sub_product_type_id
    )
  ) mapping_sub_product_type_id, 
  MAX(
    COALESCE(
      pyd.amortization_group_id, pyd2.amortization_group_id, 
      pyd3.amortization_group_id
    )
  ) amortization_group_id, 
  MAX(
    COALESCE(
      pyd.start_date, pyd2.start_date, 
      pyd3.start_date
    )
  ) start_date, 
  MAX(
    COALESCE(
      pyd.end_date, pyd2.end_date, pyd3.end_date
    )
  ) end_date 
FROM 
  (
    SELECT 
      od.* 
    FROM 
      amortization.order_details od 
      INNER JOIN amortization.prior_years_order_detail_edits pyde ON pyde.order_detail_id = od.order_detail_id 
      LEFT JOIN amortization.prior_years_order_details pyd_orig ON pyd_orig.order_detail_id = pyde.order_detail_id 
    WHERE 
      pyd_orig.order_detail_id IS NULL 
      AND pyde.is_pd_conversion = 1
  ) od 
  INNER JOIN interlink.order_detail_min_convert_parent mcp ON mcp.order_detail_id = od.order_detail_id 
  INNER JOIN interlink.sub_product_types spt ON spt.sub_product_type_id = od.sub_product_type_id 
  LEFT JOIN interlink.sub_product_types spt2 ON spt2.pd_deliverable = 'y' 
  AND spt.pd_deliverable = 'y' 
  AND spt2.pd_sort = spt.pd_sort 
  LEFT JOIN interlink.sub_product_types spt3 ON spt3.pd_deliverable = 'y' 
  AND spt.pd_deliverable = 'y' 
  AND spt3.pd_sort > 0 
  LEFT JOIN amortization.prior_years_order_details pyd ON pyd.order_detail_id = mcp.parent_order_detail_id 
  AND pyd.sub_product_type_id = od.sub_product_type_id 
  LEFT JOIN amortization.prior_years_order_details pyd2 ON pyd2.order_detail_id = mcp.parent_order_detail_id 
  AND pyd2.sub_product_type_id = spt2.sub_product_type_id 
  LEFT JOIN amortization.prior_years_order_details pyd3 ON pyd3.order_detail_id = mcp.parent_order_detail_id 
  AND pyd3.sub_product_type_id = spt3.sub_product_type_id 
GROUP BY 
  od.line_id;</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:903</td><td>create table update_levelset_to_license (
  PRIMARY KEY (order_detail_id)
) 
select 
  o.order_id, 
  od.order_detail_id, 
  sku, 
  quantity, 
  sum(orig_price) orig_price, 
  sum(price) price, 
  sum(list_price) list_price 
from 
  order_details od, 
  orders o 
where 
  o.order_id = od.order_id 
  and od.sub_product_type_id in (16, 17, 18) 
  and o.order_date < '2010-07-01' 
  and (
    o.order_date < '2010-01-01' 
    or o.start_date < '2010-07-01'
  ) 
group by 
  order_detail_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:1174</td><td>create table my_license_order_details (
  id INT AUTO_INCREMENT PRIMARY KEY, 
  INDEX (order_id, line_id), 
  INDEX(
    order_id, account_id, student_licenses, 
    quantity
  )
) 
select 
  0 id, 
  od.order_id, 
  od.line_id, 
  od.order_detail_id, 
  od.account_id, 
  od.sub_product_type_id, 
  od.student_licenses, 
  od.summer, 
  od.sku, 
  od.quantity, 
  od.price, 
  od.after_prod_total, 
  m.per_month_total, 
  od.start_date, 
  od.end_date, 
  period_diff(
    date_format(
      if(
        day(od.end_date)< 6, 
        date_add(od.end_date, INTERVAL -1 MONTH), 
        od.end_date
      ), 
      '%Y%m'
    ), 
    date_format(
      if(
        o.order_date >= '2010-01-01', 
        if(
          date_format(o.order_date, '%Y%m') >= date_format(od.start_date, '%Y%m'), 
          od.start_date, 
          date_add(od.start_date, INTERVAL -1 MONTH)
        ), 
        od.start_date
      ), 
      '%Y%m'
    )
  )+ 1 total_months, 
  od.academic_year_id, 
  od.academic_year 
from 
  order_details od, 
  my_license_orders m, 
  orders o 
where 
  od.order_id = m.order_id 
  and m.order_id = o.order_id 
  and od.account_id = m.account_id 
  and od.student_licenses = m.student_licenses 
  and od.quantity = m.quantity 
  and od.summer = m.summer 
  and od.program_id = m.program_id 
  and od.sub_product_type_id = m.sub_product_type_id $licenseStr 
order by 
  order_id, 
  account_id, 
  m.sub_product_type_id, 
  student_licenses, 
  quantity, 
  academic_year</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:1207</td><td>create table order_details_sort (
  id INT AUTO_INCREMENT PRIMARY KEY, 
  INDEX(order_id, sub_product_type_id), 
  INDEX(total_records)
) 
select 
  0 id, 
  order_id, 
  academic_year_id, 
  if(
    pd_deliverable = 'Y', 
    if(
      sub_product_type_id in (4, 5), 
      4, 
      24
    ), 
    sub_product_type_id
  ) sub_product_type_id, 
  count(*) total_records, 
  group_concat(
    line_id 
    ORDER BY 
      IF(
        cancel = 'Y' 
        and pd_deliverable = 'Y', 
        1, 
        0
      ), 
      IF(academic_year_sort >= 15, 0, 1), 
      academic_year_sort, 
      pd_sort, 
      price DESC, 
      start_date, 
      line_id
  ) all_ids 
from 
  order_details 
group by 
  order_id, 
  academic_year_id, 
  if(
    pd_deliverable = 'Y', 
    if(
      sub_product_type_id in (4, 5), 
      4, 
      24
    ), 
    sub_product_type_id
  )</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:1256</td><td>CREATE TABLE order_details_sort2 (
  PRIMARY KEY (line_id), 
  INDEX (
    order_detail_id, order_id, ONLINE, 
    pd_sort, sort
  )
) 
SELECT 
  od.*, 
  (
    CASE CONCAT(
      od.order_detail_id, od.online, od.pd_sort
    ) WHEN @cur_detail_online_sort THEN @curRank := @curRank + 1 ELSE @curRank := 1 
    AND @cur_detail_online_sort := CONCAT(
      od.order_detail_id, od.online, od.pd_sort
    ) END
  ) sort 
FROM 
  (
    SELECT 
      od.line_id, 
      od.order_id, 
      od.order_detail_id, 
      od.online, 
      od.pd_sort 
    FROM 
      tmp_order_details_copy od 
    ORDER BY 
      order_detail_id, 
      online, 
      cancel, 
      pd_sort, 
      price DESC, 
      start_date, 
      line_id
  ) od CROSS 
  JOIN (
    SELECT 
      @cur_detail_online_sort := 0, 
      @curRank := 0
  ) r</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:1273</td><td>CREATE TABLE order_no_revenue (
  tax_credit_total decimal(10, 2), 
  primary key(order_id)
) 
SELECT 
  od.order_id, 
  sum(od.price * od.quantity) no_revenue_total, 
  0 tax_credit_total 
FROM 
  $data_db.order_details od, 
  $data_db.products p 
WHERE 
  od.product_id = p.product_id 
  AND p.revenue = 'N' 
GROUP BY 
  od.order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:1282</td><td>create table order_product_total (
  PRIMARY KEY (order_id)
) 
select 
  o.order_id, 
  o.order_total, 
  sum(od.discounted_total) product_total, 
  sum(
    if(
      od.std_discount = 'N', 0, od.discounted_total
    )
  ) no_stddiscount_total, 
  sum(
    if(
      od.discountable = 'N' 
      and (o.order_date >= '2009-07-01'), 
      0, 
      od.discounted_total
    )
  ) no_mfee_total, 
  sum(
    if(
      od.discountable = 'N' 
      and (o.order_date >= '2009-07-01'), 
      od.discounted_total, 
      0
    )
  ) mfee_total, 
  ifnull(r.no_revenue_total, 0) no_revenue_total, 
  o.order_total - sum(od.discounted_total)- IFNULL(r.no_revenue_total, 0) discount_total 
from 
  (orders o, order_details od) 
  left join order_no_revenue r on (o.order_id = r.order_id) 
where 
  o.order_id = od.order_id 
group by 
  1</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:1303</td><td>CREATE TABLE order_std_discounts_total(
  PRIMARY KEY(order_id)
) 
SELECT 
  od.order_id, 
  GROUP_CONCAT(DISTINCT p.product_name) product_name, 
  SUM(
    COALESCE(lpc.price, od.list_price)* quantity
  ) std_discount_on_order 
FROM 
  (
    orders o, $data_db.order_details od, 
    $data_db.products p, $data_db.product_groups pg, 
    $data_db.discounts d
  ) 
  LEFT JOIN $data_db.od_list_price_changes lpc ON lpc.order_detail_id = od.order_detail_id 
WHERE 
  o.order_id = od.order_id 
  AND od.product_id = p.product_id 
  AND p.product_id = d.product_id 
  AND p.product_group_id = pg.product_group_id 
  AND (
    od.status = 0 
    or o.cancel = 'Y'
  ) 
  AND p.product_id NOT IN (
    ".implode(", ",$NON_STD_DISCOUNT_PRODUCTS)."
  ) 
  AND pg.discount = 1 
GROUP BY 
  order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:1345</td><td>create table order_product_total (
  primary key (order_id)
) 
select 
  o.order_id, 
  o.order_total, 
  sum(od.discounted_total) product_total, 
  sum(
    if(
      od.std_discount = 'N', 0, od.discounted_total
    )
  ) no_stddiscount_total, 
  sum(
    if(
      od.discountable = 'N' 
      and (o.order_date >= '2009-07-01'), 
      0, 
      od.discounted_total
    )
  ) no_mfee_total, 
  sum(
    if(
      od.discountable = 'N' 
      and (o.order_date >= '2009-07-01'), 
      od.discounted_total, 
      0
    )
  ) mfee_total, 
  ifnull(r.no_revenue_total, 0) no_revenue_total, 
  o.order_total - sum(od.discounted_total)- IFNULL(r.no_revenue_total, 0) discount_total 
from 
  (orders o, order_details od) 
  left join order_no_revenue r on (o.order_id = r.order_id) 
where 
  o.order_id = od.order_id 
group by 
  o.order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:1401</td><td>create table order_std_discounts (
  PRIMARY KEY (order_id, order_detail_id), 
  INDEX(order_id)
) 
select 
  od.order_id, 
  od.order_detail_id, 
  p.product_id, 
  p.product_name, 
  round(discount_percent, 10) std_discount_percent, 
  round(discount_percent, 10) std_discount_perc_report, 
  (
    COALESCE(lpc.price, od.list_price)* quantity
  ) std_discount_on_order 
from 
  (
    orders o, $data_db.order_details od, 
    $data_db.products p, $data_db.product_groups pg, 
    $data_db.discounts d
  ) 
  left join $data_db.od_list_price_changes lpc on lpc.order_detail_id = od.order_detail_id 
where 
  o.order_id = od.order_id 
  and od.product_id = p.product_id 
  and p.product_id = d.product_id 
  and p.product_group_id = pg.product_group_id 
  and (
    od.status = 0 
    or o.cancel = 'Y'
  ) 
  and p.product_id NOT IN (
    ".implode(", ",$NON_STD_DISCOUNT_PRODUCTS)."
  ) 
  and pg.discount = 1 
order by 
  order_id, 
  order_detail_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:1428</td><td>create table om_std_discounts (
  PRIMARY KEY (order_id)
) 
select 
  o.order_id, 
  concat(
    first_discount_name, 
    if(
      trim(second_discount_name) != '', 
      concat('; ', second_discount_name), 
      ''
    )
  ) discounts, 
  ad.first_discount_perc, 
  ad.second_discount_perc, 
  ad.first_discount + ad.second_discount total_discounts, 
  ad.first_discount_perc + ad.second_discount_perc discount_perc_report, 
  t.order_total, 
  pt.no_mfee_total, 
  (
    (
      ad.first_discount + ad.second_discount
    )*-1
  )/ pt.no_mfee_total total_perc 
from 
  (
    orders o, $old_amortization_db.order_discounts ad, 
    $old_amortization_db.order_total t, 
    order_product_total pt
  ) 
  left join multi_year_orders m on (o.order_id = m.my_order_id) 
  left join order_std_discounts d on (o.order_id = d.order_id) 
where 
  d.order_id is null 
  and m.order_id is null 
  and o.om_order_id = ad.order_id #and o.om_order_id not in (55903)
  and o.date_entered < '2009-08-11' 
  and o.order_id = pt.order_id 
  and ad.order_id = t.order_id 
  and ad.first_discount != 0 
group by 
  o.order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:1492</td><td>create table order_discounts (
  PRIMARY KEY (order_id)
) 
select 
  t.order_id, 
  t.order_total, 
  t.product_total, 
  t.no_mfee_total, 
  t.mfee_total, 
  t.no_stddiscount_total, 
  t.discount_total, 
  sum(d.std_discount_perc_report) std_discount_perc_report, 
  group_concat(
    distinct product_name SEPARATOR ';'
  ) std_discount_name, 
  round($std_discount_str, 4) std_discount, 
  ifnull(
    round($std_discount_str, 4)/ if(
      no_stddiscount_total = 0, no_mfee_total, 
      no_stddiscount_total
    ), 
    0
  ) std_discount_perc, 
  if(
    nd.order_id, 
    0, 
    round(
      t.discount_total -($std_discount_str), 
      4
    )
  ) non_std_discount, 
  ifnull(
    if(
      nd.order_id, 
      0, 
      round(
        t.discount_total -($std_discount_str), 
        4
      )
    )/ if(
      (
        no_mfee_total + round($std_discount_str, 4)
      )= 0, 
      mfee_total, 
      (
        no_mfee_total + round($std_discount_str, 4)
      )
    ), 
    0
  ) non_std_discount_perc, 
  if (
    (
      no_mfee_total + round($std_discount_str, 4)
    )= 0 
    or no_mfee_total = 0, 
    1, 
    0
  ) use_mfee, 
  if (order_date < '2009-07-01', 1, 0) force_mfee 
from 
  (order_product_total t, orders o) 
  left join order_std_discounts d on (t.order_id = d.order_id) 
  left join order_no_discounts nd on (t.order_id = nd.order_id) 
where 
  t.order_id = o.order_id 
group by 
  t.order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:1635</td><td>create table cancels (
  id INT AUTO_INCREMENT PRIMARY KEY, 
  credit_perc decimal (25, 20), 
  INDEX(cancel_id), 
  INDEX(order_id), 
  INDEX(credit_om_order_id)
) 
select 
  0 id, 
  c.order_id, 
  c.cancel_id, 
  c.cancel_date, 
  c.credit_type, 
  delivered, 
  o.orig_order_total order_total, 
  c.credit_amount - c.tax_credit_amount credit_total, 
  c.tax_credit_amount tax_credit_total, 
  count(distinct od.order_detail_id) linked_lines, 
  count(distinct od2.order_detail_id) cancel_lines, 
  if(
    od.order_id is null, 
    if(
      od2.order_id is null, 
      sum(od3.discounted_total), 
      sum(od2.discounted_total)
    ), 
    sum(od.discounted_total)
  ) cancel_total, 
  (
    c.credit_amount - c.tax_credit_amount
  )/ if(
    od.order_id is null, 
    if(
      od2.order_id is null, 
      sum(od3.discounted_total), 
      sum(od2.discounted_total)
    ), 
    sum(od.discounted_total)
  ) credit_perc, 
  c.om_order_id credit_om_order_id, 
  0 sort 
from 
  (
    $data_db.order_cancels c, orders o
  ) 
  left join order_details od on (
    o.order_id = od.order_id 
    and od.orig_cancel_id = c.cancel_id
  ) #linked to cancel id
  left join order_details od2 on (
    o.order_id = od2.order_id 
    and od2.cancel = 'Y' 
    and od.order_id is null 
    and od2.orig_cancel_id = 0
  ) #cancel lines not linked to cancel_id
  left join order_details od3 on (
    o.order_id = od3.order_id 
    and od2.order_id is null 
    and od.order_id is null
  ) #spread over all order details
  left join order_product_total t on (o.order_id = t.order_id) 
where 
  c.order_id = o.order_id 
  and c.status = 0 
  and c.cancel_date <= '$report_end_date' 
group by 
  c.cancel_id 
order by 
  order_id, 
  c.cancel_date, 
  if (c.credit_amount < 0, 0, 1), 
  if(
    count(distinct od.order_detail_id)= 0, 
    1, 
    0
  ), 
  cancel_id;</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:1668</td><td>create table cancel_ids (
  PRIMARY KEY(id)
) 
select 
  min(c.id) id 
from 
  cancels c 
group by 
  c.order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:1728</td><td>CREATE TABLE tmp_cancel_total (
  PRIMARY KEY (order_id)
) 
SELECT 
  order_id, 
  SUM(c.tax_credit_total) tax_credit_total 
FROM 
  cancels c 
GROUP BY 
  order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:1803</td><td>create table $table_name (
  credit_perc decimal (25, 20), 
  id2 INT AUTO_INCREMENT PRIMARY KEY
) 
select 
  c.order_id, 
  c.id, 
  c.cancel_id, 
  c.cancel_date, 
  c.credit_total, 
  c.linked_lines, 
  c.cancel_lines, 
  sum(
    if($ctotal = 0, discounted_total, 0)
  ) rest_total, 
  sum(
    if(
      $cvalue, discounted_total - $ctotal, 
      0
    )
  ) remaining_total, 
  if(
    (
      (
        sum(
          if(
            $cvalue, discounted_total - $ctotal, 
            0
          )
        )<= credit_total 
        and credit_total < 0
      ) 
      or (
        sum(
          if(
            $cvalue, discounted_total - $ctotal, 
            0
          )
        )>= credit_total 
        and credit_total > 0
      )
    ) 
    or round(
      sum(
        if($ctotal = 0, discounted_total, 0)
      )
    ) = 0, 
    c.credit_total / sum(
      if(
        $cvalue, discounted_total - $ctotal, 
        0
      )
    ), 
    (
      c.credit_total - sum(
        if(
          $cvalue, discounted_total - $ctotal, 
          0
        )
      )
    )/(
      sum(
        if($ctotal = 0, discounted_total, 0)
      )
    )
  ) credit_perc, 
  if(
    (
      (
        sum(
          if(
            $cvalue, discounted_total - $ctotal, 
            0
          )
        )<= credit_total 
        and credit_total < 0
      ) 
      or (
        sum(
          if(
            $cvalue, discounted_total - $ctotal, 
            0
          )
        )>= credit_total 
        and credit_total > 0
      ) 
      or round(
        sum(
          if($ctotal = 0, discounted_total, 0)
        )
      ) = 0
    ), 
    'Y', 
    'N'
  ) only_remaining, 
  'N' use_all 
from 
  order_details od, 
  cancels c 
where 
  od.order_id = c.order_id 
  and (
    (
      c.credit_total > 0 
      and round($ctotal) < round(discounted_total)
    ) 
    or c.credit_total < 0
  ) 
  and c.sort = $loop 
  and (
    od.orig_cancel_id = c.cancel_id 
    or c.linked_lines = 0
  ) 
  and (
    (
      linked_lines = 0 
      and od.cancel = 'Y'
    ) 
    or cancel_lines = 0
  ) 
group by 
  c.id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:1907</td><td>CREATE TEMPORARY TABLE tmp_order_cancels_respread (
  PRIMARY KEY (order_id)
) 
SELECT 
  o.order_id, 
  o.order_date, 
  min(oc.cancel_date) min_cancel_date, 
  max(oc.cancel_date) max_cancel_date 
FROM 
  interlink.orders o 
  INNER JOIN interlink.order_cancels oc ON oc.order_id = o.order_id 
WHERE 
  o.order_date > '2016-01-01' -- discount application diff in IL and amort; fixed since
  AND o.order_id NOT IN (
    24427, 26874, 27333, 27704, 31579, 33156
  ) 
GROUP BY 
  o.order_id 
HAVING 
  min_cancel_date >= '2020-01-01';</td><td></td><td>skip</td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:1922</td><td>CREATE TEMPORARY TABLE tmp_amort_detail_totals (
  PRIMARY KEY (order_detail_id)
) 
SELECT 
  od.order_id, 
  od.order_detail_id, 
  sum(discounted_total) sum_discounted_total 
FROM 
  amortization.order_details od 
  INNER JOIN tmp_order_cancels_respread o ON od.order_id = o.order_id 
GROUP BY 
  od.order_detail_id;</td><td></td><td>skip</td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:1982</td><td>create table cancel_totals (
  PRIMARY KEY (order_id)
) 
select 
  order_id, 
  min(cancel_date) cancel_date, 
  max(cancel_date) max_cancel_date, 
  sum(credit_total) cancel_total, 
  sum(tax_credit_total) tax_cancel_total, 
  sum(
    if(sort = 1, credit_total, 0)
  ) cancel_total1, 
  sum(
    if(sort = 2, credit_total, 0)
  ) cancel_total2, 
  sum(
    if(sort = 3, credit_total, 0)
  ) cancel_total3 
from 
  cancels 
where 
  1 
group by 
  1</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:2009</td><td>create table standard_not_order_month_temp (
  PRIMARY KEY (om_order_id)
) 
select 
  distinct opt.order_id om_order_id 
from 
  $old_amortization_db.order_period_total opt, 
  $old_amortization_db.order_dates d 
where 
  opt.sub_product_type_id = 11 
  and opt.order_id = d.order_id 
  and opt.period_month != d.order_month 
  and d.order_date < '2009-01-01'</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:2020</td><td>create table standard_order_month (
  PRIMARY KEY (order_id)
) 
select 
  o.order_id 
from 
  interlink.orders o 
  left join standard_not_order_month_temp t on (o.om_order_id = t.om_order_id) 
where 
  o.order_date < '2009-01-01' 
  and t.om_order_id is null 
  and o.om_order_id != 0</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:2035</td><td>create table order_detail_dates (
  order_month DATE, 
  real_order_month DATE, 
  start_month DATE, 
  end_month DATE, 
  amortization_start_month DATE, 
  amortization_end_month DATE, 
  id INT AUTO_INCREMENT PRIMARY KEY, 
  INDEX(amortization_group_id)
) 
select 
  od.line_id, 
  od.order_id, 
  od.order_detail_id, 
  odis.sub_program_id sub_program_id, 
  odis.orig_program_id orig_program_id, 
  date_format(o.order_date, '%Y-%m-01') order_month, 
  date_format(o.order_date, '%Y-%m-01') real_order_month, 
  od.start_date, 
  od.end_date, 
  date_format(od.start_date, '%Y-%m-01') start_month, 
  date_format(
    if(
      day(od.end_date)< 6, 
      date_add(od.end_date, INTERVAL -1 MONTH), 
      od.end_date
    ), 
    '%Y-%m-01'
  ) end_month, 
  sub_product_type_id, 
  amortization_group_id, 
  pd_deliverable, 
  date_format(o.order_date, '%Y-%m-01') amortization_start_month, 
  date_format(o.order_date, '%Y-%m-01') amortization_end_month, 
  12 total_months, 
  discounted_total per_month_total, 
  o.om_order_id, 
  od.om_order_id line_om_order_id, 
  od.cancel, 
  od.cancel_date1 
from 
  (order_details od, orders o) 
  LEFT JOIN order_detail_info_summary odis ON odis.order_detail_id = od.order_detail_id 
where 
  o.order_id = od.order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:2073</td><td>create table order_detail_linked_cancels(
  PRIMARY KEY (order_detail_id, order_id)
) 
SELECT 
  od.order_id, 
  od.order_detail_id, 
  SUBSTRING_INDEX(
    MIN(
      CONCAT(c.cancel_date, '|', c.cancel_id)
    ), 
    '|', 
    -1
  ) linked_cancel_id, 
  MIN(c.cancel_date) linked_cancel_date 
FROM 
  (order_details od) 
  INNER JOIN cancels c on od.order_id = c.order_id 
  AND (
    od.orig_cancel_id = c.cancel_id 
    OR c.credit_type = 'F'
  ) #AND c.cancel_date>'2014-01-01'
WHERE 
  1 
  AND od.cancel = 'Y' 
GROUP BY 
  od.order_detail_id, 
  od.order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:2287</td><td>create table order_detail_amortization(
  id INT AUTO_INCREMENT PRIMARY KEY, 
  INDEX(order_detail_id, line_id), 
  INDEX(order_id, period_month), 
  INDEX(pd_event_id), 
  INDEX(period_month), 
  INDEX(
    sub_product_type_id, period_month
  ), 
  INDEX(line_id)
) 
select 
  line_id, 
  order_id, 
  order_detail_id, 
  amortization_group_id, 
  sub_product_type_id, 
  amortization_start_month period_month, 
  per_month_total period_total, 
  amortization_start_month orig_period_month, 
  per_month_total orig_period_total, 
  1000000000 pd_event_id, 
  100000 cancel_id, 
  100000 change_id, 
  'N' keep, 
  'N' projected, 
  om_order_id, 
  line_om_order_id 
from 
  order_detail_dates 
where 
  total_months = 1</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:2349</td><td>CREATE TEMPORARY TABLE tmp_py_event_order_details_refresh (
  PRIMARY KEY (order_detail_id)
) 
SELECT 
  pye.order_id, 
  pye.order_detail_id, 
  pye.is_pd_conversion, 
  pye.is_detail_update, 
  od.account_id, 
  od.academic_year_id, 
  1 is_original_detail 
FROM 
  amortization.prior_years_order_detail_edits pye 
  INNER JOIN interlink.order_details od ON od.order_detail_id = pye.order_detail_id;</td><td></td><td>skip</td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:2357</td><td>CREATE TEMPORARY TABLE tmp_py_event_order_details_refresh2 (
  PRIMARY KEY(order_detail_id)
) 
SELECT 
  * 
FROM 
  tmp_py_event_order_details_refresh;</td><td></td><td>skip</td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:2372</td><td>create table pd_events 
select 
  pe.* 
from 
  prior_years_pd_events pe 
  left join tmp_py_event_order_details_refresh pey on pey.order_detail_id = pe.order_detail_id 
where 
  pey.order_detail_id is null 
order by 
  pe.order_id, 
  pe.order_detail_id, 
  pe.event_date, 
  pe.event_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:2466</td><td>create table pd_events_sort (
  id INT AUTO_INCREMENT PRIMARY KEY, 
  INDEX(order_id), 
  INDEX(total_records)
) 
select 
  order_id, 
  academic_year_id, 
  online, 
  count(*) total_records, 
  group_concat(
    pd_event_id 
    ORDER BY 
      event_date, 
      pd_event_id
  ) all_ids 
from 
  pd_events 
group by 
  order_id, 
  academic_year_id, 
  online</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:2495</td><td>CREATE TABLE pd_events_sort2 (
  PRIMARY KEY (pd_event_id), 
  INDEX(
    order_detail_id, order_id, `online`, 
    pd_sort, sort
  )
) 
SELECT 
  pe.order_id, 
  pe.order_detail_id, 
  pe.`online`, 
  pe.pd_event_id, 
  pe.pd_sort, 
  (
    CASE concat(
      pe.order_detail_id, pe.online, pe.pd_sort
    ) WHEN @cur_detail_online_sort THEN @curRank := @curRank + 1 ELSE @curRank := 1 
    AND @cur_detail_online_sort := concat(
      pe.order_detail_id, pe.online, pe.pd_sort
    ) END
  ) sort 
FROM 
  (
    SELECT 
      * 
    FROM 
      pd_events 
    ORDER BY 
      order_id, 
      order_detail_id, 
      online, 
      pd_sort, 
      event_date, 
      pd_event_id
  ) pe 
  INNER JOIN orders o ON o.order_id = pe.order_id 
  LEFT JOIN amortization.pre_2015_pd_sort_orders exo ON exo.order_id = o.order_id CROSS 
  JOIN (
    SELECT 
      @cur_detail_online_sort := 0, 
      @curRank := 0
  ) r 
WHERE 
  pe.academic_year_id >= 27 
  AND exo.order_id IS NULL</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:2511</td><td>create table order_detail_pd_dates (
  id INT AUTO_INCREMENT PRIMARY KEY, 
  INDEX(order_detail_id, line_id), 
  INDEX(order_id), 
  INDEX(pd_event_id)
) 
select 
  od.line_id, 
  od.order_id, 
  od.order_detail_id, 
  e.pd_event_id, 
  e.event_date, 
  e.online 
from 
  (
    order_details od, pd_events e, orders o
  ) 
  left join amortization.pre_2015_pd_sort_orders exo ON exo.order_id = o.order_id 
where 
  od.order_id = e.order_id 
  AND o.order_id = od.order_id 
  AND od.academic_year_id = e.academic_year_id 
  and od.sort = e.sort 
  and (
    e.academic_year_id < 27 
    or exo.order_id IS NOT NULL
  ) 
  and e.online = if (
    od.sub_product_type_id in (4, 5), 
    'N', 
    'Y'
  ) 
  and od.pd_deliverable = 'Y'</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:2866</td><td>create table order_detail_cancels$loop (
  id INT AUTO_INCREMENT PRIMARY KEY, 
  INDEX(line_id, order_id, cancel_month), 
  INDEX(order_id), 
  INDEX(cancel_id)
) 
select 
  od.order_id, 
  od.order_detail_id, 
  od.line_id, 
  od.orig_cancel_id, 
  od.cancel_id$loop cancel_id, 
  concat(
    substring(od.cancel_date$loop, 1, 7), 
    '-01'
  ) cancel_month, 
  od.cancel_total$loop cancel_total, 
  $sum_str not_recognized_total, 
  ifnull(
    round(
      if(
        od.cancel_total$loop / $sum_str > 1, 
        1, od.cancel_total$loop / $sum_str
      ), 
      8
    ), 
    0
  ) cancel_perc, 
  round(
    if(
      od.cancel_total$loop - $sum_str > 0, 
      od.cancel_total$loop - $sum_str, 
      0
    ), 
    8
  ) cancel_remainder, 
  od.amortization_group_id, 
  od.sub_product_type_id, 
  a.om_order_id, 
  a.line_om_order_id, 
  c.credit_om_order_id 
from 
  order_details od, 
  order_detail_amortization a, 
  cancels c 
where 
  od.order_detail_id = a.order_detail_id 
  and c.cancel_id = od.cancel_id$loop 
  and od.cancel_total$loop != 0 
  and od.line_id = a.line_id 
group by 
  od.line_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:2956</td><td>create table keep_backup (id2 INT AUTO_INCREMENT PRIMARY KEY) 
select 
  oda.* 
from 
  order_detail_amortization oda, 
  keep_amortization k 
where 
  oda.order_id = k.order_id 
  and k.credit != 'Y'</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:3027</td><td>CREATE TABLE order_level_changes (
  PRIMARY KEY (order_id)
) 
SELECT 
  order_id 
FROM 
  amortization_orders_changed 
WHERE 
  status = 0 
  AND order_detail_id = 0 
  AND lock_month < '$lock_month' 
  AND order_id NOT IN (14227, 15451) 
  /*open '14 orders manually excluded by Nechama 09/30/2014*/
GROUP BY 
  order_id;</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:3048</td><td>create table locked_amortization_totals (
  primary key (
    order_detail_id, order_id, cancel_id, 
    sub_product_type_id, amortization_group_id
  ), 
  INDEX(order_id)
) 
SELECT 
  oda.order_id, 
  CASE WHEN ox.order_id IS NULL THEN oda.cancel_id ELSE 0 END cancel_id, 
  CASE WHEN ox.order_id IS NULL THEN order_detail_id ELSE 0 END order_detail_id, 
  CASE WHEN ox.order_id IS NULL THEN sub_product_type_id ELSE 1 END sub_product_type_id, 
  CASE WHEN ox.order_id IS NULL THEN amortization_group_id ELSE 1 END amortization_group_id, 
  sum(period_total) locked_total 
from 
  order_detail_amortization_lock oda 
  left join order_level_changes ox on ox.order_id = oda.order_id 
where 
  oda.period_month <= '$lock_month' 
GROUP BY 
  oda.order_id, 
  CASE WHEN ox.order_id IS NULL THEN oda.cancel_id ELSE 0 END, 
  CASE WHEN ox.order_id IS NULL THEN order_detail_id ELSE 0 END, 
  CASE WHEN ox.order_id IS NULL THEN sub_product_type_id ELSE 1 END, 
  CASE WHEN ox.order_id IS NULL THEN amortization_group_id ELSE 1 END;</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:3070</td><td>create table new_amortization_totals (
  primary key (
    order_detail_id, order_id, cancel_id, 
    sub_product_type_id, amortization_group_id
  ), 
  INDEX(order_id)
) 
SELECT 
  oda.order_id, 
  CASE WHEN ox.order_id IS NULL THEN oda.cancel_id ELSE 0 END cancel_id, 
  CASE WHEN ox.order_id IS NULL THEN order_detail_id ELSE 0 END order_detail_id, 
  CASE WHEN ox.order_id IS NULL THEN sub_product_type_id ELSE 1 END sub_product_type_id, 
  CASE WHEN ox.order_id IS NULL THEN amortization_group_id ELSE 1 END amortization_group_id, 
  sum(period_total) new_total 
from 
  order_detail_amortization oda 
  left join order_level_changes ox on ox.order_id = oda.order_id 
where 
  oda.period_month <= '$lock_month' 
GROUP BY 
  oda.order_id, 
  CASE WHEN ox.order_id IS NULL THEN oda.cancel_id ELSE 0 END, 
  CASE WHEN ox.order_id IS NULL THEN order_detail_id ELSE 0 END, 
  CASE WHEN ox.order_id IS NULL THEN sub_product_type_id ELSE 1 END, 
  CASE WHEN ox.order_id IS NULL THEN amortization_group_id ELSE 1 END;</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:3092</td><td>CREATE TEMPORARY TABLE tmp_order_diffs (
  PRIMARY KEY (order_id, cancel_id)
) 
SELECT 
  l.order_id, 
  l.cancel_id, 
  ABS(n.order_total - l.order_total) diff 
FROM 
  interlink.orders o 
  INNER JOIN (
    SELECT 
      order_id, 
      cancel_id, 
      SUM(locked_total) order_total 
    FROM 
      locked_amortization_totals 
    GROUP BY 
      order_id, 
      cancel_id
  ) l ON l.order_id = o.order_id 
  INNER JOIN (
    SELECT 
      order_id, 
      cancel_id, 
      sum(new_total) order_total 
    FROM 
      new_amortization_totals 
    GROUP BY 
      order_id, 
      cancel_id
  ) n ON n.order_id = l.order_id 
  AND n.cancel_id = l.cancel_id 
WHERE 
  CASE WHEN o.end_date < '$more_precise_catchup_date' THEN ABS(n.order_total - l.order_total)>.5 WHEN o.end_date >= '$more_precise_catchup_date' THEN ABS(n.order_total - l.order_total)>.1 END;</td><td></td><td>skip</td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:3205</td><td>create table recognized_summary (
  PRIMARY KEY (year, month)
) 
select 
  year(period_month) year, 
  month(period_month) month, 
  round(
    sum(period_total), 
    2
  ) recognized_total 
from 
  order_detail_amortization_lock a, 
  orders o 
where 
  a.order_id = o.order_id 
  and round(o.order_total) != 0 
group by 
  year(period_month), 
  month(period_month)</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:3272</td><td>CREATE TABLE tmp_prior_year_orders_edited_pd_totals_curr (
  PRIMARY KEY (order_id, month_year)
) 
SELECT 
  oda.order_id, 
  date_format(oda.period_month, '%m/%y') month_year, 
  COUNT(oda.pd_event_id) cnt_pd_events, 
  SUM(period_total) sum_revenue_total 
FROM 
  order_detail_amortization oda 
  INNER JOIN amortization.tmp_amort_prior_years_updated_orders upyo ON upyo.order_id = oda.order_id 
WHERE 
  oda.period_month < '{$report_year}-01-01' 
  AND oda.pd_event_id > 0 
GROUP BY 
  order_id, 
  date_format(oda.period_month, '%m/%y');</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_data.inc:3293</td><td>CREATE TABLE tmp_prior_year_orders_edited_pd_totals_past (
  PRIMARY KEY (order_id, month_year)
) 
SELECT 
  oda.order_id, 
  date_format(oda.period_month, '%m/%y') month_year, 
  COUNT(oda.pd_event_id) cnt_pd_events, 
  SUM(period_total) sum_revenue_total 
FROM 
  order_detail_amortization_{$lock_month_string} oda 
  INNER JOIN amortization.tmp_amort_prior_years_updated_orders upyo ON upyo.order_id = oda.order_id 
WHERE 
  oda.period_month < '{$report_year}-01-01' 
  AND oda.pd_event_id > 0 
GROUP BY 
  order_id, 
  date_format(oda.period_month, '%m/%y');</td><td></td><td></td></tr>
   <tr><td>orders/quote_summary.php:249</td><td>CREATE TEMPORARY TABLE product_sort (
  primary key (product_id)
) 
SELECT 
  qd.product_id, 
  min(spt.quote_sort) sort 
FROM 
  quote_details qd, 
  products p, 
  sub_products sp, 
  sub_product_types spt 
WHERE 
  p.product_id = qd.product_id 
  AND p.product_id = sp.product_id 
  AND spt.sub_product_type_id = sp.sub_product_type_id 
  AND qd.quote_id = '$q' 
GROUP BY 
  qd.product_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/expiring_account_values/generate_query_data.inc:26</td><td>CREATE TEMPORARY TABLE product_pd_percent(
  PRIMARY KEY(product_id)
) 
SELECT 
  p.product_id, 
  product_name, 
  SUM(
    sp.list_price * sp.sub_product_qty
  ) cost, 
  SUM(
    CASE WHEN sp.sub_product_type_id IN (4, 5, 14, 24, 6) THEN sp.list_price * sp.sub_product_qty ELSE 0 END
  ) pd_cost, 
  SUM(
    CASE WHEN sp.sub_product_type_id IN (4, 5, 14, 24, 6) THEN sp.list_price * sp.sub_product_qty ELSE 0 END
  )/ SUM(
    sp.list_price * sp.sub_product_qty
  ) pd_percent 
FROM 
  interlink.products p 
  INNER JOIN interlink.sub_products sp ON (p.product_id = sp.product_id) 
GROUP BY 
  p.product_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/expiring_account_values/generate_query_data.inc:48</td><td>CREATE TEMPORARY TABLE tmp_order_detail_pd (
  PRIMARY KEY (order_detail_id)
) 
SELECT 
  aos.order_detail_id, 
  od.account_id, 
  od.academic_year_id, 
  sum(purchased_pd) purchased_pd 
FROM 
  interlink.account_order_summary aos 
  INNER JOIN interlink.order_details od ON od.order_detail_id = aos.order_detail_id 
GROUP BY 
  order_detail_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/expiring_account_values/generate_query_data.inc:69</td><td>CREATE TEMPORARY TABLE tmp_ay_proposal_accounts_products (
  PRIMARY KEY (
    account_id, order_id, sub_program
  )
) 
SELECT 
  od.account_id, 
  a.account_name, 
  ay.academic_year_name, 
  CASE WHEN 
  /*Smarty Ants*/
  (
    p.program_id = 17 
    OR p.product_line_id = 19
  ) THEN 17 WHEN 
  /*BAE*/
  (
    p.program_id IN (12, 13, 14) 
    OR p.sku LIKE '%BAE%'
  ) THEN 12 WHEN 
  /*Science */
  p.product_line_id = 8 
  OR p.program_id = 2 
  OR o.opportunity_product_id = 2 THEN 2 ELSE 1 END sub_program_id, 
  CASE WHEN 
  /*Smarty Ants*/
  (
    p.program_id = 17 
    OR p.product_line_id = 19
  ) THEN 'Smarty Ants' WHEN 
  /*BAE*/
  (
    p.program_id IN (12, 13, 14) 
    OR p.sku LIKE '%BAE%'
  ) THEN 'BAE' WHEN 
  /*Science */
  p.product_line_id = 8 
  OR p.program_id = 2 
  OR o.opportunity_product_id = 2 THEN 'Science' ELSE 'Literacy' END sub_program, 
  SUM(
    (
      rn.line_list_price + rn.pro_rated_fees
    )*(1 - pd_percent)
  ) orig_booked_value_before_discounts, 
  SUM(
    rn.pro_rated_discounts *(1 - pd_percent)
  ) discounts, 
  SUM(
    rn.pro_rated_credits *(1 - pd_percent)
  ) credits, 
  SUM(
    (
      rn.line_list_price + rn.pro_rated_fees + rn.pro_rated_discounts
    )*(1 - pd_percent)
  ) orig_booked_value, 
  SUM(
    (
      rn.line_list_price + rn.pro_rated_fees + rn.pro_rated_discounts + rn.pro_rated_credits
    )*(1 - pd_percent)
  ) booked_value_after_credits, 
  SUM(
    CASE WHEN order_a.account_level = 1 THEN (
      rn.line_list_price + rn.pro_rated_fees + rn.pro_rated_discounts + rn.pro_rated_credits
    )*(1 - pd_percent) ELSE 0 END
  ) booked_at_district, 
  SUM(
    CASE WHEN order_a.account_level = 2 THEN (
      rn.line_list_price + rn.pro_rated_fees + rn.pro_rated_discounts + rn.pro_rated_credits
    )*(1 - pd_percent) ELSE 0 END
  ) booked_at_school, 
  od.order_id, 
  o.order_date, 
  MAX(1 - pd_percent) product_percent, 
  0 pd_count, 
  SUM(
    CASE WHEN aos.student_licenses = 9999 THEN 9999 ELSE aos.student_licenses END
  ) license_count 
FROM 
  interlink.order_details od 
  INNER JOIN interlink.products p ON p.product_id = od.product_id 
  INNER JOIN interlink.accounts a ON a.account_id = od.account_id 
  INNER JOIN interlink.orders o ON o.order_id = od.order_id 
  INNER JOIN interlink.accounts order_a ON (
    o.account_id = order_a.account_id
  ) 
  INNER JOIN interlink.order_new_renewal_data rn ON rn.order_detail_id = od.order_detail_id 
  INNER JOIN product_pd_percent ppd ON ppd.product_id = p.product_id 
  INNER JOIN interlink.order_summary os ON os.order_id = o.order_id 
  INNER JOIN interlink.academic_years ay ON ay.academic_year_id = od.academic_year_id 
  LEFT JOIN tmp_order_detail_pd odp ON odp.order_detail_id = od.order_detail_id 
  LEFT JOIN account_order_summary aos ON aos.order_detail_id = od.order_detail_id 
  AND aos.academic_year_id = od.academic_year_id 
  AND aos.reallocated = 0 
WHERE 
  (
    od.account_id = $district 
    OR a.parent_account_id = $district
  ) 
  AND od.academic_year_id = $academic_year 
GROUP BY 
  od.account_id, 
  sub_program_id, 
  od.order_id 
UNION ALL 
SELECT 
  od.account_id, 
  a.account_name, 
  ay.academic_year_name, 
  4 sub_program_id, 
  'PD' sub_program, 
  SUM(
    (
      rn.line_list_price + rn.pro_rated_fees
    )*(pd_percent)
  ) orig_booked_value_before_discounts, 
  SUM(
    rn.pro_rated_discounts *(pd_percent)
  ) discounts, 
  SUM(
    rn.pro_rated_credits *(pd_percent)
  ) credits, 
  SUM(
    (
      rn.line_list_price + rn.pro_rated_fees + rn.pro_rated_discounts
    )*(pd_percent)
  ) orig_booked_value, 
  SUM(
    (
      rn.line_list_price + rn.pro_rated_fees + rn.pro_rated_discounts + rn.pro_rated_credits
    )*(pd_percent)
  ) booked_value_after_credits, 
  SUM(
    CASE WHEN order_a.account_level = 1 THEN (
      rn.line_list_price + rn.pro_rated_fees + rn.pro_rated_discounts + rn.pro_rated_credits
    )*(pd_percent) ELSE 0 END
  ) booked_at_district, 
  SUM(
    CASE WHEN order_a.account_level = 2 THEN (
      rn.line_list_price + rn.pro_rated_fees + rn.pro_rated_discounts + rn.pro_rated_credits
    )*(pd_percent) ELSE 0 END
  ) booked_at_school, 
  od.order_id, 
  o.order_date, 
  MAX(pd_percent) product_percent, 
  SUM(odp.purchased_pd) pd_count, 
  0 license_count 
FROM 
  interlink.order_details od 
  INNER JOIN interlink.accounts a ON a.account_id = od.account_id 
  INNER JOIN interlink.products p ON p.product_id = od.product_id 
  INNER JOIN interlink.orders o ON o.order_id = od.order_id 
  INNER JOIN interlink.accounts order_a ON (
    o.account_id = order_a.account_id
  ) 
  INNER JOIN interlink.order_new_renewal_data rn ON rn.order_detail_id = od.order_detail_id 
  INNER JOIN product_pd_percent1 ppd ON ppd.product_id = p.product_id 
  INNER JOIN interlink.academic_years ay ON ay.academic_year_id = od.academic_year_id 
  LEFT JOIN tmp_order_detail_pd1 odp ON odp.order_detail_id = od.order_detail_id 
  LEFT JOIN account_order_summary aos ON aos.order_detail_id = od.order_detail_id 
  AND aos.academic_year_id = od.academic_year_id 
  AND aos.reallocated = 0 
WHERE 
  (
    od.account_id = $district 
    OR a.parent_account_id = $district
  ) 
  AND od.academic_year_id = $academic_year 
GROUP BY 
  od.account_id, 
  od.order_id 
HAVING 
  orig_booked_value_before_discounts > 0;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/expiring_account_values/generate_query_data.inc:149</td><td>CREATE TEMPORARY TABLE account_ay_value_data(
  PRIMARY KEY(account_id)
) 
SELECT 
  ba.account_id, 
  ba.account_name, 
  ba.academic_year_name academic_year, 
  SUM(
    ba.orig_booked_value_before_discounts
  ) original_order_value, 
  SUM(discounts) discounts, 
  SUM(credits) credits, 
  SUM(ba.booked_value_after_credits) net_order_value, 
  SUM(booked_at_district) booked_at_district, 
  SUM(booked_at_school) booked_at_school, 
  SUM(
    CASE WHEN sub_program = 'PD' THEN ba.booked_value_after_credits ELSE 0 END
  ) PD, 
  SUM(
    CASE WHEN sub_program = 'Literacy' THEN ba.booked_value_after_credits ELSE 0 END
  ) Literacy, 
  SUM(
    CASE WHEN sub_program = 'BAE' THEN ba.booked_value_after_credits ELSE 0 END
  ) BAE, 
  SUM(
    CASE WHEN sub_program = 'Smarty Ants' THEN ba.booked_value_after_credits ELSE 0 END
  ) SmartyAnts, 
  SUM(
    CASE WHEN sub_program = 'Science' THEN ba.booked_value_after_credits ELSE 0 END
  ) Science, 
  GROUP_CONCAT(
    DISTINCT CONCAT(ba.order_id, ' ', ba.order_date) 
    ORDER BY 
      order_id SEPARATOR ';  '
  ) orders, 
  SUM(ba.pd_count) pd_count, 
  SUM(
    CASE WHEN sub_program = 'Literacy' THEN license_count ELSE 0 END
  ) Literacy_license, 
  SUM(
    CASE WHEN sub_program = 'BAE' THEN license_count ELSE 0 END
  ) BAE_license, 
  SUM(
    CASE WHEN sub_program = 'Smarty Ants' THEN license_count ELSE 0 END
  ) SmartyAnts_license, 
  SUM(
    CASE WHEN sub_program = 'Science' THEN license_count ELSE 0 END
  ) Science_license 
FROM 
  tmp_ay_proposal_accounts_products ba 
GROUP BY 
  ba.account_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/expiring_account_values/generate_query_data.inc:180</td><td>CREATE TEMPORARY TABLE account_ay_value_report(
  PRIMARY KEY(account_id)
) 
SELECT 
  ba.account_id, 
  ba.account_name, 
  ba.academic_year, 
  ba.original_order_value, 
  ba.discounts, 
  ba.credits, 
  ba.net_order_value, 
  ba.booked_at_district, 
  ba.booked_at_school, 
  ba.PD 'PD/IMF', 
  ba.Literacy, 
  ba.BAE, 
  ba.SmartyAnts, 
  ba.Science, 
  ba.orders, 
  ba.pd_count, 
  ba.Literacy_license, 
  ba.BAE_license, 
  IF(
    ba.SmartyAnts_license >= 9999, 'UNLIMITED', 
    ba.SmartyAnts_license
  ) SmartyAnts_license, 
  ba.Science_license, 
  max(od.end_date) last_end_date 
FROM 
  account_ay_value_data ba 
  INNER JOIN interlink.order_details od ON od.account_id = ba.account_id 
  INNER JOIN interlink.accounts a ON a.account_id = od.account_id 
  INNER JOIN interlink.order_new_renewal_data rn ON rn.order_detail_id = od.order_detail_id 
WHERE 
  (
    od.account_id = $district 
    OR a.parent_account_id = $district
  ) 
  AND od.status = 0 
GROUP BY 
  ba.account_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/opportunities/closed_order_progress_index.php:240</td><td>CREATE TEMPORARY TABLE $ytd_tmp_table 
SELECT 
  distinct user_id, 
  $sum_group_by as grp, 
  00000000000000000000.00 ytd_new, 
  00000000000000000000.00 ytd_renew, 
  00000000000000000000.00 ytd_non_categorized, 
  00000000000000000000.00 ytd_quota_credit 
FROM 
  $report_tmp_table</td><td></td><td>skip</td></tr>
   <tr><td>reports/opportunities/closed_order_progress_index.php:404</td><td>CREATE TEMPORARY TABLE $LPTableName 
SELECT 
  SUM(sp.list_price * sub_product_qty) AS sp_list_price, 
  sp.product_id 
FROM 
  sub_products AS sp 
WHERE 
  product_id IN (
    select 
      distinct product_id 
    from 
      order_details AS od 
    WHERE 
      od.status <> 2 
      /* Exclude deleted records. */
      ) 
GROUP BY 
  sp.product_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/opportunities/closed_order_progress_index.php:421</td><td>CREATE TEMPORARY TABLE $report_tmp_table 
SELECT 
  u.first_name rep_first_name, 
  u.last_name rep_last_name, 
  u.user_id, 
  o.order_id, 
  ns_order_id, 
  order_length, 
  if(
    no_po > 0, 
    'Not Required', 
    group_concat(
      DISTINCT po.po 
      ORDER BY 
        1
    )
  ) po_number, 
  if (
    p.lead_source_id is not null, p.lead_source_id, 
    0
  ) lead_source_id, 
  space(50) lead_source_name, 
  a.state_code, 
  if(
    a.account_level = 2, d.account_name, 
    a.account_name
  ) district, 
  if(
    a.account_level = 2, a.account_name, 
    ''
  ) school, 
  region_name, 
  order_date, 
  00000000000000000000.00 total, 
  o.status as order_status, 
  oc.cancel_date, 
  oc.credit_type, 
  00000000000000000000.00 new_total, 
  00000000000000000000.00 renewal_total, 
  00000000000000000000.00 non_categorized_total, 
  00000000000000000000.00 quota_credit, 
  0 multiyear_total, 
  1 cancel_flag 
FROM 
  (
    orders o, accounts a, user_orders uo, 
    users u, region_states rs, regions r
  ) 
  LEFT JOIN opportunities p on (p.order_id = o.order_id) 
  LEFT JOIN order_cancels oc on (
    oc.order_id = o.order_id 
    AND oc.status = 0
  ) 
  LEFT JOIN accounts d on (
    a.parent_account_id = d.account_id
  ) 
  LEFT JOIN order_po po ON (
    o.order_id = po.order_id 
    AND po.status = 0
  ) 
  LEFT JOIN order_summary os ON (o.order_id = os.order_id) 
WHERE 
  o.account_id = a.account_id 
  AND o.order_id = uo.order_id 
  AND uo.role_id = '".$ROLE[$DEPARTMENT["sales"]]["sales_rep"]."' 
  AND uo.user_id = u.user_id 
  AND rs.state_code = a.state_code 
  AND rs.region_id = r.region_id 
  AND r.department_id = ".$DEPARTMENT[" sales "]." $whereStr 
GROUP BY 
  o.order_id $havingStr</td><td></td><td>skip</td></tr>
   <tr><td>reports/sales/purchase_order_status_options.inc:22</td><td>CREATE TEMPORARY TABLE user_sales_department(
  PRIMARY KEY(user_id)
) 
SELECT 
  u.user_id, 
  CASE WHEN a.area_name LIKE '%inside%' THEN 'Inside' WHEN a.area_name LIKE '%strategic%' THEN 'Strategic' WHEN a.area_name LIKE '%international%' THEN 'International' WHEN a.area_name LIKE '%renew%' THEN 'Renewal' ELSE 'Field' END rep_type 
FROM 
  commissions.users u 
  JOIN commissions.area_users au ON au.user_id = u.user_id 
  JOIN commissions.areas a ON a.area_id = au.area_id 
WHERE 
  IF(
    cp_termination_date, 
    DATE(cp_termination_date), 
    CURDATE()
  ) BETWEEN au.start_date 
  AND au.end_date 
GROUP BY 
  u.user_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/tbs/choose_order.php:611</td><td>CREATE TEMPORARY TABLE my_orders_A$a 
SELECT 
  DISTINCT o.order_id, 
  o.order_date, 
  d.academic_year_id, 
  o.expansion_order_id 
FROM 
  orders o, 
  order_details d 
WHERE 
  o.order_id = d.order_id 
  AND o.status = 0 
  AND o.draft = 0 #".($ay ? "AND d.academic_year_id IN (" . implode(",", $academic_years) . ")" : "")."
  AND d.account_id = '$a' ".($o ? " 
  AND '$o' IN (
    o.order_id, o.expansion_order_id
  ) " : "")." 
GROUP BY 
  o.order_id, 
  d.academic_year_id</td><td></td><td>skip</td></tr>
   <tr><td>util/classes/data_import/Contact_Import.php:635</td><td>CREATE TEMPORARY TABLE tmp_contacts_bak 
SELECT 
  c.* 
FROM 
  contacts c, 
  contacts_import ci 
WHERE 
  c.contact_id = ci.contact_id 
  AND ci.action = '" . IMPORT_ACTION_UPDATE . "' 
  AND ci.session_id = '$this->session_id'</td><td></td><td>skip</td></tr>
   <tr><td>util/classes/data_import/Contact_Import.php:729</td><td>CREATE TEMPORARY TABLE tmp_contacts_bak 
SELECT 
  c.* 
FROM 
  contacts c, 
  contacts_import ci 
WHERE 
  c.contact_id = ci.contact_id 
  AND ci.action = '" . IMPORT_ACTION_DELETE . "' 
  AND ci.session_id = '$this->session_id'</td><td></td><td>skip</td></tr>
   <tr><td>cron/apr/apr_log.php:233</td><td>CREATE TEMPORARY TABLE tmp_user_accounts 
SELECT 
  distinct account_id 
FROM 
  user_accounts 
WHERE 
  user_id = '$user_id' 
  AND account_owner = 1</td><td></td><td>skip</td></tr>
   <tr><td>cron/update_account_ns_id.php:19</td><td>CREATE TABLE tech.accounts_get_ns_id(
  KEY(account_id, new_ns_id)
) 
SELECT 
  DISTINCT a.account_id, 
  a.account_name, 
  a.state_code, 
  a.customer_status, 
  a.ns_id old_ns_id, 
  b.ns_id new_ns_id, 
  a.date_entered 
From 
  accounts a 
  join (
    select 
      account_name, 
      county_id, 
      state_code, 
      parent_account_id, 
      ns_id 
    From 
      MDR_accounts_to_delete 
    where 
      ns_id <> 0 
    group by 
      account_name, 
      county_id, 
      state_code 
    having 
      count(account_id) = 1
  ) b on (
    a.account_name = b.account_name 
    AND a.state_code = b.state_code 
    AND a.county_id = b.county_id
  ) 
  left join accounts c on c.account_name = a.account_name 
  and c.state_code = a.state_code 
  and c.county_id = a.county_id 
  and c.account_id <> a.account_id 
WHERE 
  a.date_entered > ADDDATE(
    CURDATE(), 
    INTERVAL -1 WEEK
  ) 
  AND a.ns_id = 0 
  and c.account_id is null</td><td></td><td></td></tr>
   <tr><td>finance/invoices/import/view_orders.php:127</td><td>CREATE TEMPORARY TABLE tmp_order_invoices 
SELECT 
  o.order_id, 
  GROUP_CONCAT(
    i.ns_invoice_id 
    ORDER BY 
      i.invoice_date, 
      i.ns_invoice_id SEPARATOR '<br>'
  ) ns_invoice_id, 
  GROUP_CONCAT(
    DATE_FORMAT(i.invoice_date, '%b-%y') 
    ORDER BY 
      i.invoice_date, 
      i.ns_invoice_id SEPARATOR '<br>'
  ) invoice_date, 
  GROUP_CONCAT(
    FORMAT(i.invoice_total, 0) 
    ORDER BY 
      i.invoice_date, 
      i.ns_invoice_id SEPARATOR '<br>'
  ) invoice_total, 
  GROUP_CONCAT(
    FORMAT(io.invoice_amount, 0) 
    ORDER BY 
      i.invoice_date, 
      i.ns_invoice_id SEPARATOR '<br>'
  ) invoice_amount, 
  FORMAT(
    SUM(io.invoice_amount), 
    0
  ) invoiced 
FROM 
  (
    orders o, billing.invoice_orders io, 
    billing.invoices i
  ) 
  LEFT JOIN order_cancels c on (
    io.cancel_id = c.cancel_id 
    and c.status = 0
  ) 
WHERE 
  o.order_id = io.order_id 
  AND io.invoice_id = i.invoice_id " . (!$allo ? " 
  AND YEAR(o.end_date) > '$lock_year' " : "") . " 
  AND o.account_id in (".implode(", ",$accounts).") 
GROUP BY 
  o.order_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/amortization/print_order.php:1035</td><td>CREATE TEMPORARY TABLE tmp_amortization_dates (id INT AUTO_INCREMENT PRIMARY KEY) 
SELECT 
  NULL id, 
  oda.order_id, 
  oda.line_id, 
  oda.cancel_id, 
  MIN(oda.period_month) first_month, 
  MAX(oda.period_month) last_month, 
  round(
    sum(oda.period_total), 
    2
  ) amortized_total, 
  projected, 
  "
                          .(isset($amort_backup_string)?
                                " period_diff(
    date_format(
      MAX(oda.period_month), 
      '%Y%m'
    ), 
    date_format(
      MIN(oda.period_month), 
      '%Y%m'
    )
  )+ 1 total_months, 
  0 per_month_total, 
  ":
                                " d.total_months, 
  d.per_month_total, 
  ")." oda.pd_event_id 
FROM 
  "
                        .(isset($amort_backup_string)?
                                " amortization_backup.order_detail_amortization{$amort_backup_string} oda ":
                                " $amortization_db.order_detail_amortization oda 
  INNER JOIN $amortization_db.order_detail_dates d ON oda.line_id = d.line_id " 
                                  ).
                        " 
WHERE 
  1 
  AND oda.order_id = '$tmp_order_id' 
GROUP BY 
  oda.order_id, 
  oda.line_id, 
  oda.cancel_id 
HAVING 
  (
    amortized_total <> 0 
    OR oda.cancel_id = 0
  )</td><td></td><td>skip</td></tr>
   <tr><td>reports/amortization/print_order.php:1062</td><td>CREATE TEMPORARY TABLE $table (id INT AUTO_INCREMENT PRIMARY KEY) 
SELECT 
  NULL id, 
  od.order_id, 
  od.orig_cancel_id, 
  a.cancel_id, 
  od.product_id, 
  sku, 
  od.sub_product_type_id, 
  od.sub_product_type_name, 
  od.start_date, 
  od.end_date, 
  od.academic_year, 
  od.price list_price, 
  round(
    od.discounted_total / od.quantity, 
    2
  ) price, 
  round(
    od.after_prod_total / od.quantity, 
    2
  ) premium_price, 
  ROUND(
    IFNULL(
      SUM(amortized_total)/(
        od.discounted_total / od.quantity
      ), 
      SUM(od.quantity)
    ), 
    1
  ) quantity, 
  first_month, 
  last_month, 
  SUM(amortized_total) amortized_total, 
  od.cancel, 
  od.pd_deliverable, 
  od.academic_year_sort, 
  a.total_months, 
  0 linked_pd 
FROM 
  "
                .(isset($amort_backup_string)?
                        " amortization_backup.order_details{$amort_backup_string} od " :
                        " $amortization_db.order_details od "  ).
                ", 
  tmp_amortization_dates a 
WHERE 
  od.order_id = '$tmp_order_id' 
  AND od.line_id = a.line_id 
  AND od.pd_deliverable = 'N' 
GROUP BY 
  od.order_id, 
  od.orig_cancel_id, 
  a.cancel_id, 
  od.product_id, 
  od.sub_product_type_id, 
  od.start_date, 
  od.end_date, 
  round(
    od.discounted_total / od.quantity
  ), 
  od.price, 
  a.total_months</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/annual_retention/annual_retention_index.php:60</td><td>CREATE TABLE interlink.$lock_table 
SELECT 
  '1' col1;</td><td></td><td></td></tr>
   <tr><td>reports/finance/change_notification/generate_data.php:41</td><td>CREATE TABLE commissions.tmp_cmr_last_log_order_review (
  PRIMARY KEY (order_id)
) 
SELECT 
  order_id, 
  MAX(date_reviewed) date_reviewed 
FROM 
  commissions.log_order_review 
WHERE 
  review_type = 'cancel_notify' 
GROUP BY 
  order_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/change_notification/generate_data.php:55</td><td>CREATE TABLE commissions.tmp_cmr_orders_need_review (
  PRIMARY KEY (order_id)
) 
SELECT 
  logc.order_id 
FROM 
  commissions.log_cancel_new_renew logc 
  INNER JOIN commissions.credits c on c.c_id = logc.c_id 
  AND c.cmonth = @cmonth 
  LEFT JOIN commissions.tmp_cmr_last_log_order_review lor ON lor.order_id = logc.order_id 
WHERE 
  date_entered > @log_start 
  AND (
    lor.order_id IS NULL 
    OR lor.date_reviewed < logc.date_entered
  ) 
  AND (
    c.ctype = 'cancel' 
    OR c.is_bad_debt = 1
  ) 
GROUP BY 
  logc.order_id 
HAVING 
  max(log_id)> @log_start;</td><td></td><td></td></tr>
   <tr><td>reports/finance/change_notification/generate_data.php:74</td><td>CREATE TABLE commissions.tmp_cmr_order_cancel_tcv_acv (
  PRIMARY KEY (order_id, cancel_id), 
  INDEX (cancel_id, order_id)
) 
SELECT 
  acv.order_id, 
  acv.cancel_id, 
  SUM(line_total) tcv_total, 
  SUM(new_total) tcv_new, 
  SUM(renew_total) tcv_renew, 
  SUM(sales_tax) tcv_sales_tax, 
  SUM(line_total_acv_no_tax) acv_total, 
  SUM(new_total_acv) acv_new, 
  SUM(renew_total_acv) acv_renew 
FROM 
  amortization.booking_total_acv acv 
GROUP BY 
  acv.order_id, 
  acv.cancel_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/change_notification/generate_data.php:97</td><td>CREATE TABLE commissions.tmp_cc_ntfy_cancels (
  PRIMARY KEY (c_id), 
  INDEX(order_id, cancel_id)
) 
SELECT 
  o.order_id, 
  CASE WHEN c.ctype = 'CANCEL' THEN 'Revenue Credit' WHEN c.is_bad_debt = 1 THEN 'Bad Debt Comm Credit' ELSE 'Commission Credit' END credit_type, 
  c.c_id, 
  c.cancel_id, 
  c.invoice_id, 
  c.cancel_date, 
  CASE WHEN c.ctype = 'cancel' THEN c.entry_date ELSE '' END date_entered, 
  c.credit *-1 credit, 
  c.credit *-1 tcv_total, 
  c.new_credit *-1 tcv_new, 
  c.renew_credit *-1 tcv_renew, 
  c.tax_credit *-1 tcv_sales_tax, 
  ot.acv_total acv_total, 
  ot.acv_new acv_new, 
  ot.acv_renew acv_renew, 
  GROUP_CONCAT(
    DISTINCT rebook_order_id 
    ORDER BY 
      rebook_order_id
  ) rebook_orders, 
  cr.cancel_reason_name, 
  oc.additional_notes cancel_notes 
FROM 
  commissions.credits c 
  INNER JOIN commissions.orders o ON o.order_id = c.order_id 
  AND o.cmonth = c.cmonth 
  INNER JOIN commissions.tmp_cmr_orders_need_review revo ON revo.order_id = o.order_id 
  LEFT JOIN commissions.tmp_cmr_order_cancel_tcv_acv ot ON ot.order_id = o.order_id 
  AND ot.cancel_id = c.cancel_id 
  LEFT JOIN interlink.order_cancel_rebook_summary rebooks ON rebooks.cancel_id = c.cancel_id 
  AND rebooks.order_id = c.order_id 
  LEFT JOIN interlink.order_cancels oc ON oc.order_id = o.order_id 
  AND oc.cancel_id = c.cancel_id 
  LEFT JOIN interlink.cancel_reasons cr ON cr.cancel_reason_id = oc.cancel_reason 
WHERE 
  c.cmonth = @cmonth 
GROUP BY 
  c.c_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/change_notification/generate_data.php:132</td><td>CREATE TABLE commissions.tmp_cc_ntfy_orders (
  PRIMARY KEY (order_id)
) 
SELECT 
  o.order_id, 
  o.account_id, 
  o.account_name, 
  o.order_date, 
  o.start_date, 
  o.end_date, 
  ot.tcv_total, 
  ot.tcv_new, 
  ot.tcv_renew, 
  ot.tcv_sales_tax, 
  ot.acv_total, 
  ot.acv_new, 
  ot.acv_renew, 
  oi.opportunity_owner `Opportunity Owner` 
FROM 
  commissions.orders o 
  INNER JOIN commissions.order_info oi ON oi.order_id = o.order_id 
  AND oi.cmonth = @cmonth 
  INNER JOIN commissions.tmp_cmr_order_cancel_tcv_acv ot ON ot.order_id = o.order_id 
  AND ot.cancel_id = 0 
  INNER JOIN commissions.tmp_cc_ntfy_cancels cc ON cc.order_id = o.order_id 
WHERE 
  o.cmonth = @cmonth 
GROUP BY 
  o.order_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/change_notification/generate_data.php:148</td><td>CREATE TABLE commissions.tmp_cc_ntfy_rebook_orders (
  PRIMARY KEY (rebook_order_id)
) 
SELECT 
  o.order_id rebook_order_id, 
  o.account_id, 
  o.account_name, 
  o.order_date, 
  o.start_date, 
  o.end_date, 
  o.order_total, 
  o.credit_total, 
  ot.tcv_total, 
  ot.tcv_new, 
  ot.tcv_renew, 
  ot.tcv_sales_tax, 
  ot.acv_total, 
  ot.acv_new, 
  ot.acv_renew, 
  oi.opportunity_owner `Opportunity Owner`, 
  cc.order_id orig_order_id 
FROM 
  commissions.tmp_cc_ntfy_cancels cc 
  INNER JOIN interlink.order_cancel_rebook_summary rebooks ON rebooks.cancel_id = cc.cancel_id 
  INNER JOIN commissions.orders o ON rebooks.rebook_order_id = o.order_id 
  INNER JOIN commissions.order_info oi ON rebooks.rebook_order_id = oi.order_id 
  AND oi.cmonth = @cmonth 
  INNER JOIN commissions.tmp_cmr_order_cancel_tcv_acv ot ON ot.order_id = o.order_id 
  AND ot.cancel_id = 0 
WHERE 
  o.cmonth = @cmonth 
GROUP BY 
  o.order_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/change_notification/generate_data.php:164</td><td>CREATE TABLE commissions.tmp_cc_ntfy_cancels_log (
  PRIMARY KEY (order_id)
) 
SELECT 
  cc.order_id, 
  MIN(log.date_entered) min_log_date_entered, 
  MAX(log.date_entered) max_log_date_entered 
FROM 
  commissions.tmp_cc_ntfy_cancels cc 
  INNER JOIN commissions.log_cancel_new_renew log ON log.c_id = cc.c_id 
GROUP BY 
  cc.order_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/change_notification/generate_data.php:176</td><td>CREATE TABLE commissions.tmp_cc_ntfy_order_qc_changes (
  PRIMARY KEY (order_id, user_id)
) 
SELECT 
  qc.order_id, 
  qc.user_id, 
  MAX(
    CASE WHEN qc.date_entered < c.min_log_date_entered 
    OR (
      qc.date_entered = c.min_log_date_entered 
      AND qc.date_entered = @log_start
    ) THEN log_id ELSE 0 END
  ) log_id_before_cancel, 
  MAX(
    CASE WHEN qc.date_entered >= c.min_log_date_entered 
    AND qc.date_entered > @log_start THEN log_id ELSE 0 END
  ) log_id_after_cancel 
FROM 
  commissions.log_order_user_qc qc 
  INNER JOIN commissions.tmp_cc_ntfy_cancels_log c ON c.order_id = qc.order_id 
GROUP BY 
  qc.order_id, 
  qc.user_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/change_notification/generate_data.php:190</td><td>CREATE TABLE commissions.tmp_cc_ntfy_order_user_qc (
  PRIMARY KEY (order_id, user_id)
) 
SELECT 
  order_id, 
  user_id, 
  SUBSTRING_INDEX(
    MAX(
      CONCAT(log_id, '|', quota_credit)
    ), 
    '|', 
    -1
  ) quota_credit 
FROM 
  commissions.log_order_user_qc qc 
GROUP BY 
  order_id, 
  user_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/change_notification/generate_data.php:203</td><td>CREATE TABLE commissions.tmp_cc_ntfy_order_users (
  PRIMARY KEY (order_id, user_id)
) 
SELECT 
  ou.order_id, 
  ou.user_id, 
  TRIM(
    CONCAT(u.first_name, ' ', u.last_name)
  ) user_name, 
  next_month_cp_termination_date termination_date, 
  ou.comp_plan_type, 
  ouqb.quota_credit QC_Before, 
  IFNULL(
    ouqaft.quota_credit, ouq.quota_credit
  ) QC_Current, 
  CASE WHEN IFNULL(
    ouqaft.quota_credit, ouq.quota_credit
  )- ouqb.quota_credit < 0 THEN IFNULL(
    ouqaft.quota_credit, ouq.quota_credit
  )- ouqb.quota_credit ELSE '' END QC_Reduction, 
  CASE WHEN ouqaft.quota_credit IS NULL THEN 'NO' ELSE 'YES' END Has_QC_Change_After_Credits, 
  CASE WHEN u.status = 0 
  AND next_month_cp_termination_date = 0 
  AND u.user_id <> 1484 
  AND ou.comp_plan_type NOT IN ('RESELLER', 'RENEW') THEN 1 ELSE 0 END user_notify 
FROM 
  commissions.order_users ou 
  INNER JOIN commissions.users u ON u.user_id = ou.user_id 
  INNER JOIN commissions.tmp_cc_ntfy_cancels cc ON cc.order_id = ou.order_id 
  INNER JOIN commissions.order_info oi ON oi.order_id = ou.order_id 
  AND oi.cmonth = @cmonth 
  LEFT JOIN commissions.tmp_cc_ntfy_order_qc_changes qc_change ON qc_change.order_id = ou.order_id 
  AND qc_change.user_id = ou.user_id 
  LEFT JOIN commissions.log_order_user_qc ouqb ON ouqb.log_id = qc_change.log_id_before_cancel 
  LEFT JOIN commissions.log_order_user_qc ouqaft ON ouqaft.log_id = qc_change.log_id_after_cancel 
  LEFT JOIN commissions.tmp_cc_ntfy_order_user_qc ouq ON ouq.order_id = ou.order_id 
  AND ouq.user_id = ou.user_id 
WHERE 
  ou.cmonth = @cmonth 
GROUP BY 
  ou.order_id, 
  ou.user_id #HAVING user_notify=1
  ;;</td><td></td><td></td></tr>
   <tr><td>reports/finance/change_notification/generate_data.php:233</td><td>CREATE TABLE commissions.tmp_cc_ntfy_rebook_order_users (
  PRIMARY KEY (rebook_order_id, user_id)
) 
SELECT 
  ou.order_id rebook_order_id, 
  ou.user_id, 
  CONCAT(u.first_name, ' ', u.last_name) user_name, 
  next_month_cp_termination_date termination_date, 
  ou.comp_plan_type, 
  ouq.quota_credit QC, 
  CASE WHEN u.status = 0 
  AND next_month_cp_termination_date = 0 
  AND u.user_id <> 1484 THEN 1 ELSE 0 END user_notify, 
  cc.order_id orig_order_id 
FROM 
  commissions.tmp_cc_ntfy_cancels cc 
  INNER JOIN interlink.order_cancel_rebook_summary rebooks ON rebooks.cancel_id = cc.cancel_id 
  INNER JOIN commissions.orders o ON rebooks.rebook_order_id = o.order_id 
  INNER JOIN commissions.order_users ou ON ou.order_id = o.order_id 
  AND ou.cmonth = o.cmonth 
  INNER JOIN commissions.users u ON u.user_id = ou.user_id 
  LEFT JOIN commissions.tmp_cc_ntfy_order_user_qc ouq ON ouq.order_id = ou.order_id 
  AND ouq.user_id = ou.user_id 
WHERE 
  o.cmonth = @cmonth 
GROUP BY 
  o.order_id, 
  ou.user_id;</td><td></td><td></td></tr>
   <tr><td>reports/opportunities/live_version/open_index.php:351</td><td>CREATE TEMPORARY TABLE $table_name 
SELECT 
  p.opportunity_id, 
  p.opportunity_name, 
  a.state_code, 
  if(
    a.account_level = 2, d.account_name, 
    a.account_name
  ) district, 
  if(
    a.account_level = 2, a.account_name, 
    ''
  ) school, 
  c.first_name, 
  c.middle_name, 
  c.last_name, 
  r.region_name, 
  p.close_date, 
  s.probability_percent, 
  p.total, 
  ifnull(no_po, 'N/A') no_po_flag, 
  if(
    no_po > 0, 
    'Not Required', 
    group_concat(po.po)
  ) po_number, 
  0 nonstandard_discount, 
  0 nonstandard_product, 
  0 has_final_quote, 
  p.lead_source_id, 
  space(50) lead_source_name, 
  if(
    instr(a.customer_status, 'Customer')> 0, 
    'Renew', 
    'New'
  ) new_renew, 
  substr(u.first_name, 1, 1) rep_first_name, 
  u.last_name rep_last_name, 
  left(p.notes, 200) notes 
FROM 
  (
    opportunities p, accounts a, user_orders o, 
    users u, opportunity_probabilities s, 
    region_states rs, regions r
  ) 
  LEFT JOIN accounts d on (
    a.parent_account_id = d.account_id
  ) 
  LEFT JOIN order_po po ON (
    p.opportunity_id = po.opportunity_id
  ) 
  LEFT JOIN order_contacts oc ON (
    o.opportunity_id = oc.opportunity_id 
    AND oc.contact_type_id = '" . $CONTACT_TYPES["buyer"] . "'
  ) 
  LEFT JOIN contacts c ON (c.contact_id = oc.contact_id) 
WHERE 
  p.account_id = a.account_id 
  AND p.opportunity_id = o.opportunity_id 
  AND o.role_id = '".$ROLE[$DEPARTMENT["sales"]]["sales_rep"]."' 
  AND o.user_id = u.user_id 
  AND p.probability_id = s.probability_id 
  AND rs.state_code = a.state_code 
  AND rs.region_id = r.region_id 
  AND r.department_id = ".$DEPARTMENT[" sales "]." $whereStr 
GROUP BY 
  p.opportunity_id, 
  region_name</td><td></td><td>skip</td></tr>
   <tr><td>reports/tbs/index.php:193</td><td>CREATE $temporary TABLE tbs_districts 
SELECT 
  DISTINCT d.account_id, 
  d.academic_year_id 
FROM 
  account_summary d, 
  accounts child, 
  account_summary s $fromStr 
WHERE 
  d.account_id = child.parent_account_id 
  AND child.account_id = s.account_id ".str_replace(" TABLE "," child ",$whereStr)." 
  AND s.reason_id > 0 
  AND curdate() BETWEEN date_add(s.order_start, INTERVAL -3 MONTH) 
  AND s.post_end 
  AND d.academic_year_id = s.academic_year_id 
  AND child.customer_status = 'Current Customer' 
  AND d.account_id <> 175985</td><td></td><td></td></tr>
   <tr><td>reports/tbs/index.php:234</td><td>CREATE $temporary TABLE tbs_account_orders 
SELECT 
  t.account_id, 
  if(
    t.account_level = 1, 0, d.academic_year_id
  ) new_academic_year_id, 
  group_concat(
    distinct o.order_id 
    order by 
      o.order_id
  ) order_ids 
FROM 
  (
    tbs_accounts t, orders o, order_details d
  ) 
  LEFT JOIN tbs_districts td ON (t.account_id = td.account_id) 
WHERE 
  (
    (
      t.account_level = 1 
      AND t.account_id = o.account_id
    ) 
    OR (
      t.account_level = 2 
      AND t.account_id = d.account_id
    )
  ) 
  AND o.order_id = d.order_id 
  AND o.status = 0 
  AND d.status = 0 
  AND o.draft = 0 
  AND d.academic_year_id = ifnull(
    td.academic_year_id, t.academic_year_id
  ) 
  AND o.order_id NOT IN (
    SELECT 
      DISTINCT o.order_id 
    FROM 
      orders o, 
      order_details od, 
      products p, 
      order_summary os 
    WHERE 
      o.order_id = od.order_id 
      AND p.product_id = od.product_id 
      AND o.order_id = os.order_id 
      AND os.order_total = 0 
      AND os.total_trainings = 0 
      AND p.sku like '%-SE-%' 
      AND month(o.order_date) = 7 
      AND year(o.order_date) = 2011
  ) 
GROUP BY 
  t.account_id, 
  new_academic_year_id</td><td></td><td></td></tr>
   <tr><td>reports/tbs/index.php:311</td><td>CREATE $temporary TABLE tbs_communications 
SELECT 
  a.account_id, 
  a.academic_year_id, 
  if (
    t.category_id IN (
      " . implode(", ", $launch_categories) . "
    ), 
    'Welcome', 
    t.template_type
  ) template_type, 
  m.communication_id, 
  m.communication_date, 
  round(
    datediff(
      a.order_start, m.communication_date
    )/ 30
  ) distance, 
  abs(
    round(
      datediff(
        a.order_start, m.communication_date
      )/ 30
    )
  ) priority, 
  round(
    datediff(a.order_end, a.order_start)/ 30
  ) order_length 
FROM 
  tbs_accounts a, 
  communications m, 
  templates t 
WHERE 
  t.template_id = m.template_id 
  AND (
    t.template_type in ('Welcome', 'Setup') 
    OR t.category_id IN (
      " . implode(", ", $launch_categories) . "
    )
  ) 
  AND (
    a.account_id = m.account_id 
    OR (
      a.parent_account_id = m.account_id 
      AND a.parent_account_id > 0
    )
  ) 
  AND a.order_date < m.communication_date 
  AND m.communication_date BETWEEN date_add(a.order_start, INTERVAL -3 MONTH) 
  AND a.post_end 
GROUP BY 
  a.account_id, 
  if (
    t.category_id IN (
      " . implode(", ", $launch_categories) . "
    ), 
    'Welcome', 
    t.template_type
  ), 
  m.communication_id</td><td></td><td></td></tr>
   <tr><td>reports/tbs/index.php:342</td><td>CREATE $temporary TABLE tbs_communications2 
SELECT 
  account_id, 
  academic_year_id, 
  template_type, 
  min(priority) priority 
FROM 
  tbs_communications 
GROUP BY 
  account_id, 
  academic_year_id, 
  template_type</td><td></td><td></td></tr>
   <tr><td>reports/tbs/index.php:351</td><td>CREATE $temporary TABLE tbs_communications3 
SELECT 
  c1.account_id, 
  c1.academic_year_id, 
  c1.template_type, 
  max(c1.communication_date) communication_date 
FROM 
  tbs_communications c1, 
  tbs_communications2 c2 
WHERE 
  c1.account_id = c2.account_id 
  AND c1.academic_year_id = c2.academic_year_id 
  AND c1.template_type = c2.template_type 
  AND c1.priority = c2.priority 
GROUP BY 
  c1.account_id, 
  c1.academic_year_id, 
  c1.template_type</td><td></td><td></td></tr>
   <tr><td>reports/tbs/index.php:364</td><td>CREATE $temporary TABLE tbs_contacts2 
SELECT 
  c.account_id, 
  c.academic_year_id, 
  c.contact_type_id, 
  group_concat(DISTINCT c.contact_id) contact_ids, 
  group_concat(
    DISTINCT c.contact_name 
    ORDER BY 
      c.contact_name SEPARATOR ';<br>'
  ) contact_names 
FROM 
  tbs_contacts c 
GROUP BY 
  c.account_id, 
  c.academic_year_id, 
  c.contact_type_id</td><td></td><td></td></tr>
   <tr><td>reports/tbs/index.php:459</td><td>CREATE $temporary TABLE tbs_accounts_filtered 
SELECT 
  DISTINCT t.account_id, 
  t.parent_account_id, 
  t.academic_year_id 
FROM 
  tbs_accounts t, 
  accounts a 
WHERE 
  a.account_level = '".$ACCOUNT_LEVEL["school"]."' 
  AND t.account_id = a.account_id $whereStr</td><td></td><td></td></tr>
   <tr><td>cron/daily/expiring_orders.php:13</td><td>CREATE TABLE $my_table 
SELECT 
  DISTINCT o.order_id, 
  a1.account_id, 
  a1.account_name, 
  CONCAT(
    month(o.start_date), 
    '/', 
    day(o.start_date), 
    '/', 
    year(o.start_date), 
    ' - ', 
    month(o.end_date), 
    '/', 
    day(o.end_date), 
    '/', 
    year(o.end_date)
  ) subscription_period 
FROM 
  renewal_opportunities ro, 
  orders o, 
  opportunities op, 
  accounts a1 
WHERE 
  ro.opportunity_id = op.opportunity_id 
  AND ro.order_id = o.order_id 
  and o.account_id = a1.account_id 
  AND DATE(o.end_date) = curdate() 
  /*AND DATE(o.end_date) = '2010-06-15'*/
  AND o.status = 0 
  AND op.order_id = 0</td><td></td><td></td></tr>
   <tr><td>cron/summary/account_roles.php:22</td><td>CREATE TEMPORARY TABLE tmp_user_account_changes (
  PRIMARY KEY (account_id, role_id)
) 
SELECT 
  uad.account_id, 
  uad.role_id, 
  uad.user_id old_user_id, 
  ua.user_id new_user_id, 
  ua.confirmed, 
  ua.date_modified 
FROM 
  user_account_dates uad 
  LEFT JOIN user_accounts ua ON ua.account_owner = 1 
  AND ua.account_id = uad.account_id 
  AND ua.role_id = uad.role_id 
WHERE 
  DATE(NOW()) BETWEEN uad.start_date 
  AND uad.end_date ".($account_id ? " 
  AND uad.account_id = $account_id " : "")." 
  AND uad.user_id <> IFNULL(ua.user_id, 0) 
  AND uad.role_id <> 0 
  AND uad.account_id <> 0;</td><td></td><td>skip</td></tr>
   <tr><td>cron/summary/new_renew.php:17</td><td>CREATE TABLE tmp_order_detail_new_renew_summary(
  new_total DECIMAL(30, 10), 
  renew_total DECIMAL(30, 10), 
  new_total_fin DECIMAL(30, 10), 
  renew_total_fin DECIMAL(30, 10), 
  PRIMARY KEY(order_detail_id), 
  INDEX(order_id, order_detail_id)
) ENGINE = InnoDB 
SELECT 
  nr.order_id, 
  nr.order_detail_id, 
  CASE WHEN os.order_total - os.sales_tax = 0 
  OR os.order_total = 0 THEN 0 ELSE nr.line_list_price + nr.pro_rated_fees + nr.pro_rated_discounts END price, 
  CASE WHEN os.order_total - os.sales_tax = 0 
  OR os.order_total = 0 THEN 0 ELSE nr.pro_rated_credits END pro_rated_credits, 
  COALESCE(
    odv.new_percent, ov.new_percent, 
    CASE WHEN order_renewal_status = 'New' THEN 1 ELSE 0 END
  ) new_percent, 
  COALESCE(
    odv.renew_percent, ov.renew_percent, 
    CASE WHEN order_renewal_status != 'New' THEN 1 ELSE 0 END
  ) renew_percent, 
  COALESCE(
    odv_fin.new_percent, ov.new_percent_fin, 
    CASE WHEN order_renewal_status = 'New' THEN 1 ELSE 0 END
  ) new_percent_fin, 
  COALESCE(
    odv_fin.renew_percent, ov.renew_percent_fin, 
    CASE WHEN order_renewal_status != 'New' THEN 1 ELSE 0 END
  ) renew_percent_fin, 
  CASE WHEN ov.order_id THEN 1 ELSE 0 END has_override, 
  0 new_total, 
  0 renew_total, 
  0 new_total_fin, 
  0 renew_total_fin 
FROM 
  order_new_renewal_data nr 
  LEFT JOIN (
    SELECT 
      v.order_id, 
      v.new_total, 
      v.renew_total, 
      ROUND(
        v.new_total /(v.new_total + v.renew_total), 
        20
      ) new_percent, 
      ROUND(
        v.renew_total /(v.new_total + v.renew_total), 
        20
      ) renew_percent, 
      CASE WHEN v.commissions_override_only = 1 THEN NULL ELSE ROUND(
        v.new_total /(v.new_total + v.renew_total), 
        20
      ) END new_percent_fin, 
      CASE WHEN v.commissions_override_only = 1 THEN NULL ELSE ROUND(
        v.renew_total /(v.new_total + v.renew_total), 
        20
      ) END renew_percent_fin 
    FROM 
      commissions.v_qc_overrides v 
      INNER JOIN interlink.order_summary os ON os.order_id = v.order_id 
      INNER JOIN interlink.orders o ON o.order_id = os.order_id 
    WHERE 
      1 
      AND ABS(
        v.new_total + v.renew_total + os.sales_tax - os.order_total
      )< 1 
      AND IFNULL(v.new_total, 0)+ IFNULL(v.renew_total, 0)> 0 
      AND v.user_id = 0 
      AND v.year = YEAR(o.order_date) 
    GROUP BY 
      v.order_id
  ) ov ON ov.order_id = nr.order_id 
  LEFT JOIN interlink.order_detail_new_renew_overrides odv ON nr.order_id = odv.order_id 
  AND nr.order_detail_id = odv.order_detail_id 
  LEFT JOIN interlink.order_detail_new_renew_overrides odv_fin ON nr.order_id = odv_fin.order_id 
  AND nr.order_detail_id = odv_fin.order_detail_id 
  AND odv_fin.commissions_override_only = 0 
  LEFT JOIN interlink.order_summary os ON nr.order_id = os.order_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/new_renew.php:91</td><td>CREATE TABLE tmp_order_detail_new_renew_fin_summary(
  new_total DECIMAL(30, 10), 
  renew_total DECIMAL(30, 10), 
  PRIMARY KEY(order_id, order_detail_id)
) ENGINE = InnoDB 
SELECT 
  nr.order_id, 
  nr.order_detail_id, 
  CASE WHEN os.order_total - os.sales_tax = 0 
  OR os.order_total = 0 THEN 0 ELSE nr.line_list_price + nr.pro_rated_fees + nr.pro_rated_discounts END price, 
  CASE WHEN os.order_total - os.sales_tax = 0 
  OR os.order_total = 0 THEN 0 ELSE nr.pro_rated_credits END pro_rated_credits, 
  COALESCE(
    odv.new_percent, ov.new_percent, 
    CASE WHEN order_renewal_status = 'New' THEN 1 ELSE 0 END
  ) new_percent, 
  COALESCE(
    odv.renew_percent, ov.renew_percent, 
    CASE WHEN order_renewal_status != 'New' THEN 1 ELSE 0 END
  ) renew_percent, 
  CASE WHEN ov.order_id THEN 1 ELSE 0 END has_override, 
  0 new_total, 
  0 renew_total 
FROM 
  order_new_renewal_data nr 
  LEFT JOIN (
    SELECT 
      v.order_id, 
      v.new_total, 
      v.renew_total, 
      ROUND(
        v.new_total /(os.order_total - os.sales_tax), 
        20
      ) new_percent, 
      ROUND(
        v.renew_total /(os.order_total - os.sales_tax), 
        20
      ) renew_percent 
    FROM 
      commissions.v_qc_overrides v 
      INNER JOIN interlink.order_summary os ON os.order_id = v.order_id 
      INNER JOIN interlink.orders o ON o.order_id = os.order_id 
    WHERE 
      1 
      AND ABS(
        v.new_total + v.renew_total + os.sales_tax - os.order_total
      )< 1 
      AND IFNULL(v.new_total, 0)+ IFNULL(v.renew_total, 0)> 0 
      AND v.user_id = 0 
      AND v.year = YEAR(o.order_date) 
      AND v.commissions_override_only = 0 
    GROUP BY 
      v.order_id
  ) ov ON ov.order_id = nr.order_id 
  LEFT JOIN interlink.order_detail_new_renew_overrides odv ON nr.order_id = odv.order_id 
  AND nr.order_detail_id = odv.order_detail_id 
  AND odv.commissions_override_only = 0 
  LEFT JOIN interlink.order_summary os ON nr.order_id = os.order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_commissions_report.inc:32</td><td>create table com_orders(
  order_total DECIMAL(15, 2), 
  PRIMARY KEY(order_id)
) 
select 
  distinct o.*, 
  r.revenue_total as order_revenue_total, 
  if(
    ifnull(c.salesreps, '')<> '', 
    c.salesreps, 
    r.salesreps
  ) salesrep, 
  c.invoice_commissions, 
  c.total_commissions, 
  accrued_commissions, 
  c.bonus_total, 
  c.accrued_bonus, 
  c.total_comm_bonus, 
  c.accrued_comm_bonus 
from 
  (
    orders o, order_detail_amortization_lock oda
  ) 
  left join order_commissions c on (o.order_id = c.order_id) 
  left join billing.commission_credits cc on (o.order_id = cc.il_order_id) 
  left join order_revenue r on (o.order_id = r.order_id) 
where 
  o.order_id = oda.order_id 
  and o.order_date >= '2010-01-01' 
  and round(o.order_total) <> 0 
  and (
    year(oda.period_month) >= '$report_year' 
    or year(
      ifnull(last_cancel_date, 0)
    ) >= '$report_year' 
    or year(
      ifnull(cc.invoice_date, 0)
    ) >= '$report_year' 
    or c.accrued_comm_bonus not between -.05 
    and.05
  ) 
  and order_date <= '$report_end_date'</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_commissions_report.inc:59</td><td>create table com_prev_year(
  prev_total DECIMAL(15, 2), 
  PRIMARY KEY(order_id)
) 
select 
  order_id, 
  round(
    sum(comm_bonus_period_total), 
    2
  ) prev_total 
from 
  order_commission_schedule 
where 
  (
    year(period_month) < '$report_year' 
    or period_month = 0
  ) 
group by 
  order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_commissions_report.inc:70</td><td>create table com_amort_prev_year(
  prev_total DECIMAL(15, 2), 
  PRIMARY KEY(order_id)
) 
select 
  order_id, 
  round(
    sum(period_total), 
    2
  ) prev_total 
from 
  order_revenue_schedule 
where 
  (
    year(period_month) < '$report_year' 
    or period_month = 0
  ) 
group by 
  order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_commissions_report.inc:82</td><td>create table com_this_year(
  this_year_total DECIMAL(15, 2), 
  PRIMARY KEY(order_id)
) 
select 
  order_id, 
  round(
    sum(comm_bonus_period_total), 
    2
  ) this_year_total 
from 
  order_commission_schedule 
where 
  year(period_month) = '$report_year' 
  and period_month <= '$report_end_date' 
group by 
  order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_commissions_report.inc:93</td><td>create table com_amort_this_year(
  this_year_total DECIMAL(15, 2), 
  PRIMARY KEY(order_id)
) 
select 
  order_id, 
  round(
    sum(period_total), 
    2
  ) this_year_total 
from 
  order_revenue_schedule 
where 
  year(period_month) = '$report_year' 
  and period_month <= '$report_end_date' 
group by 
  order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_commissions_report.inc:104</td><td>create table com_future_year(
  future_total DECIMAL(15, 2), 
  PRIMARY KEY(order_id)
) 
select 
  order_id, 
  round(
    sum(comm_bonus_period_total), 
    2
  ) future_total 
from 
  order_commission_schedule 
where 
  1 
  and period_month > '$report_end_date' 
group by 
  order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_commissions_report.inc:117</td><td>create table com_amort_future_year(
  future_total DECIMAL(15, 2), 
  PRIMARY KEY(order_id)
) 
select 
  order_id, 
  round(
    sum(period_total), 
    2
  ) future_total 
from 
  order_revenue_schedule 
where 
  1 
  and period_month > '$report_end_date' 
group by 
  order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_commissions_report.inc:128</td><td>create table com_revenue_defer(
  recognized_revenue DECIMAL(25, 8), 
  deferred_revenue DECIMAL(25, 8), 
  contracted_revenue DECIMAL(15, 2), 
  PRIMARY KEY(order_id)
) 
select 
  r.order_id, 
  sum(
    if(
      period_month <= '$report_end_date', 
      period_total, 0
    )
  ) recognized_revenue, 
  b.defer_total - sum(
    if(
      period_month <= '$report_end_date', 
      period_total, 0
    )
  ) deferred_revenue, 
  r.revenue_total - b.defer_total contracted_revenue 
from 
  order_revenue_schedule r, 
  order_billing b 
where 
  r.order_id = b.order_id 
group by 
  r.order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_commissions_report.inc:143</td><td>create table com_commissions_defer (
  recognized_commissions decimal(25, 10), 
  recognized_bonus decimal(25, 10), 
  recognized_comm_bonus decimal(25, 10), 
  deferred_commissions decimal(25, 10), 
  deferred_bonus decimal(25, 10), 
  deferred_comm_bonus decimal(25, 10), 
  short_term_defer_commissions decimal(25, 10), 
  short_term_defer_bonus decimal(25, 10), 
  short_term_defer_comm_bonus decimal(25, 10), 
  contracted_commissions decimal(15, 2), 
  PRIMARY KEY(order_id)
) 
select 
  c.order_id, 
  sum(
    if(
      period_month <= '$report_end_date', 
      commission_period_total, 0
    )
  ) recognized_commissions, 
  sum(
    if(
      period_month <= '$report_end_date', 
      bonus_period_total, 0
    )
  ) recognized_bonus, 
  sum(
    if(
      period_month <= '$report_end_date', 
      comm_bonus_period_total, 0
    )
  ) recognized_comm_bonus, 
  (oc.invoice_commissions)- sum(
    if(
      period_month <= '$report_end_date', 
      commission_period_total, 0
    )
  ) deferred_commissions, 
  (oc.bonus_total)- sum(
    if(
      period_month <= '$report_end_date', 
      bonus_period_total, 0
    )
  ) deferred_bonus, 
  (
    oc.invoice_commissions + oc.bonus_total
  )- sum(
    if(
      period_month <= '$report_end_date', 
      comm_bonus_period_total, 0
    )
  ) deferred_comm_bonus, 
  sum(
    if(
      period_month BETWEEN '$next_month_date' 
      AND '$next_year_date', 
      commission_period_total, 
      0
    )
  ) short_term_defer_commissions, 
  sum(
    if(
      period_month BETWEEN '$next_month_date' 
      AND '$next_year_date', 
      bonus_period_total, 
      0
    )
  ) short_term_defer_bonus, 
  sum(
    if(
      period_month BETWEEN '$next_month_date' 
      AND '$next_year_date', 
      comm_bonus_period_total, 
      0
    )
  ) short_term_defer_comm_bonus, 
  
  /*bonus is never contracted*/
  oc.total_commissions - oc.invoice_commissions contracted_commissions 
from 
  order_commission_schedule c 
  inner join order_commissions oc on oc.order_id = c.order_id 
where 
  1 
group by 
  c.order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_commissions_report.inc:201</td><td>CREATE TABLE $com_table_name (
  COLUMN_TYPE_STR PRIMARY KEY(order_id)
) 
SELECT 
  order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_commissions_report.inc:204</td><td>CREATE TABLE $amort_table_name (
  COLUMN_TYPE_STR PRIMARY KEY(order_id)
) 
SELECT 
  order_id</td><td></td><td></td></tr>
   <tr><td>reports/billing/payment_wo_po_index.php:111</td><td>CREATE TEMPORARY TABLE tmp_payment_terms (
  primary key (order_id)
) 
SELECT 
  o.order_id, 
  o.ns_order_id, 
  a.account_name, 
  a.state_code state, 
  o.order_date, 
  o.start_date, 
  o.end_date, 
  obs.order_total, 
  obs.cancel_total, 
  os.sales_tax, 
  SUM(
    IFNULL(payment_term_amount, 0)
  ) pmt_term, 
  SUM(
    CASE WHEN payment_term_status_id = 201 THEN payment_term_amount ELSE 0 END
  ) pmt_term_po_pending, 
  SUM(
    CASE WHEN payment_term_status_id = 202 THEN payment_term_amount ELSE 0 END
  ) pmt_term_po_not_req, 
  SUM(
    CASE WHEN payment_term_status_id = 200 THEN payment_term_amount ELSE 0 END
  ) po_rcvd, 
  SUM(
    CASE WHEN payment_term_status_id = 203 THEN payment_term_amount ELSE 0 END
  ) pmt_rcvd, 
  SUM(
    CASE WHEN payment_term_status_id NOT BETWEEN 200 
    AND 203 THEN payment_term_amount ELSE 0 END
  ) pmt_terms_other 
FROM 
  orders o 
  INNER JOIN accounts a ON a.account_id = o.account_id 
  INNER JOIN order_billing_summary obs ON o.order_id = obs.order_id 
  INNER JOIN order_summary os on os.order_id = o.order_id 
  LEFT JOIN payment_terms pt ON pt.order_id = o.order_id 
  LEFT JOIN payment_term_details ptd ON ptd.payment_term_id = pt.payment_term_id 
WHERE 
  1 $whereStr 
GROUP BY 
  o.order_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/event_impact/index.php:223</td><td>CREATE TEMPORARY TABLE school_usage (
  PRIMARY KEY (
    account_id, report_end_date, program_id
  )
) 
SELECT 
  account_id, 
  program_id, 
  program_name, 
  report_start_date, 
  report_end_date, 
  SUM(active_students) active_students, 
  SUM(total_students) total_students, 
  SUM(pre_test_comp) AS pre_test_comp, 
  SUM(total_students_ytd) as total_students_ytd, 
  SUM(active_students_ytd) as active_students_ytd 
FROM 
  school_usage_primary_report su2 
  INNER JOIN academic_years ay ON su2.report_end_date BETWEEN ay.start_date 
  AND ay.end_date 
WHERE 
  DATEDIFF(
    report_end_date, report_start_date
  )= 6 
  AND ay.academic_year_id = $academic_year_id 
  AND report_end_date between '$usage_range_start' 
  and '$usage_range_end' 
GROUP BY 
  account_id, 
  program_id, 
  report_start_date, 
  report_end_date</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/pd_data/index.php:60</td><td>CREATE $temporary TABLE tech.pd_standalone_initial(
  PRIMARY KEY(product_id)
) 
SELECT 
  sp.product_id, 
  product_name, 
  sku, 
  p.product_group_id, 
  MIN(
    CASE WHEN spt.sub_product_type_id IS NOT NULL THEN 1 ELSE 0 END
  ) is_pd_only, 
  MAX(
    CASE WHEN spt.pd_deliverable = 'Y' THEN 1 ELSE NULL END
  ) is_pd_product 
FROM 
  sub_products sp 
  INNER JOIN products p USING(product_id) 
  LEFT JOIN sub_product_types spt ON (
    sp.sub_product_type_id = spt.sub_product_type_id 
    AND (
      spt.pd_deliverable = 'Y' 
      OR spt.sub_product_type_id = 6
    )
  ) 
WHERE 
  sp.status = 0 
GROUP BY 
  sp.product_id 
HAVING 
  is_pd_only = 1 
  AND is_pd_product = 1;</td><td></td><td></td></tr>
   <tr><td>reports/finance/pd_data/index.php:78</td><td>CREATE $temporary TABLE tech.order_details_pd_standalone(
  PRIMARY KEY(order_id, order_detail_id)
) 
SELECT 
  DISTINCT order_id, 
  order_detail_id, 
  od.product_id 
FROM 
  amortization.order_details od 
  INNER JOIN tech.pd_standalone_initial pd ON (od.product_id = pd.product_id);</td><td></td><td></td></tr>
   <tr><td>reports/finance/pd_data/index.php:91</td><td>CREATE $temporary TABLE tech.pd_costs(
  we_care_event_id INT, 
  we_care_date DATE, 
  we_care_event_name varchar(100), 
  row_num INT, 
  PRIMARY KEY(
    line_id, order_id, order_detail_id, 
    sub_product_type_id
  ), 
  KEY(
    order_id, order_detail_id, sub_product_type_id, 
    academic_year_id
  )
) 
SELECT 
  od.*, 
  CASE WHEN e.event_name = 'Satisfied PD' THEN 'Expired' WHEN e.event_date <= CURDATE() THEN 'Delivered' WHEN e.event_date > CURDATE() THEN 'Projected' ELSE '' END AS del_state, 
  e.event_name, 
  0 we_care_event_id, 
  '' we_care_date, 
  '' we_care_event_name, 
  0 row_num 
FROM 
  (
    SELECT 
      line_id, 
      order_id, 
      order_detail_id, 
      od.end_date order_detail_end, 
      a.sub_product_type_id, 
      od.academic_year_id, 
      academic_year_name, 
      CASE WHEN spt.pd_sort = 1 THEN 'Initial' WHEN spt.pd_sort = 2 THEN 'Follow-up' ELSE '' END pd_type, 
      spt.sub_product_type_name, 
      MAX(
        CASE WHEN a.cancel_id = 0 THEN period_month ELSE NULL END
      ) period_month, 
      SUM(period_total) period_total, 
      MAX(pd_event_id) pd_event_id, 
      MAX(a.cancel_id) cancel_id, 
      CASE WHEN b.order_detail_id IS NOT NULL THEN 'Y' ELSE 'N' END pd_standalone 
    FROM 
      amortization.order_detail_amortization a 
      INNEr JOIN interlink.order_details od USING(order_id, order_detail_id) 
      INNER JOIN interlink.sub_product_types spt ON (
        a.sub_product_type_id = spt.sub_product_type_id
      ) 
      LEFT JOIN tech.order_details_pd_standalone b USING (order_id, order_detail_id) 
      LEFT JOIN interlink.academic_years ay ON od.academic_year_id = ay.academic_year_id 
    WHERE 
      a.sub_product_type_id IN (
        ".$SUB_PRODUCT_TYPES[" initial training "].", 
        ".$SUB_PRODUCT_TYPES[" followup training "].", 
        ".$SUB_PRODUCT_TYPES[" online training "].", 
        ".$SUB_PRODUCT_TYPES[" initial online training "]."
      ) 
      AND od.status = 0 
    GROUP BY 
      line_id, 
      order_id, 
      order_detail_id, 
      sub_product_type_id
  ) od 
  LEFT JOIN amortization.pd_events e ON (od.pd_event_id = e.pd_event_id);</td><td></td><td></td></tr>
   <tr><td>reports/finance/pd_data/index.php:125</td><td>CREATE $temporary TABLE tech.expired_events(
  PRIMARY KEY(
    order_id, order_detail_id, sub_product_type_id, 
    temp_row_num
  )
) 
SELECT 
  d.*, 
  CASE WHEN @row_id = CONCAT(
    order_id, order_detail_id, sub_product_type_id
  ) THEN @row_num := @row_num + 1 ELSE @row_num := 1 END temp_row_num, 
  CASE WHEN @row_id != CONCAT(
    order_id, order_detail_id, sub_product_type_id
  ) THEN @row_id := CONCAT(
    order_id, order_detail_id, sub_product_type_id
  ) ELSE @row_id := @row_id END set_row_id 
FROM 
  (
    SELECT 
      * 
    FROM 
      tech.pd_costs 
    WHERE 
      sub_product_type_id IN (
        ".$SUB_PRODUCT_TYPES[" initial training "].", 
        ".$SUB_PRODUCT_TYPES[" initial online training "]."
      ) 
      AND del_state = 'Expired' 
    ORDER BY 
      order_detail_id, 
      sub_product_type_id
  ) d CROSS 
  JOIN (
    SELECT 
      @row_id := '', 
      @row_num := 0
  ) a;</td><td></td><td></td></tr>
   <tr><td>reports/finance/pd_data/index.php:151</td><td>CREATE $temporary TABLE tech.we_care_days(
  PRIMARY KEY(
    order_id, order_detail_id, sub_product_type_id, 
    row_num
  )
) 
SELECT 
  d.*, 
  CASE WHEN @row_id = CONCAT(
    order_id, order_detail_id, `online`
  ) THEN @row_num := @row_num + 1 ELSE @row_num := 1 END row_num, 
  CASE WHEN @row_id != CONCAT(
    order_id, order_detail_id, `online`
  ) THEN @row_id := CONCAT(
    order_id, order_detail_id, `online`
  ) ELSE @row_id := @row_id END set_row_id 
FROM 
  (
    SELECT 
      e.event_id, 
      e.event_date, 
      e.event_name, 
      e.order_id, 
      e.order_detail_id, 
      e.online, 
      CASE WHEN `online` = 'N' THEN ".$SUB_PRODUCT_TYPES[" initial training "]." ELSE ".$SUB_PRODUCT_TYPES[" initial online training "]." END sub_product_type_id, 
      'Initial' pd_type 
    FROM 
      events e 
    WHERE 
      e.pd_type_id = ".$PD_TYPES[" we care initial "]." 
      AND e.status = 0 
      AND event_type_id = 1 
    ORDER BY 
      order_detail_id, 
      `online`
  ) d CROSS 
  JOIN (
    SELECT 
      @row_id := '', 
      @row_num := 0
  ) a;</td><td></td><td></td></tr>
   <tr><td>reports/finance/pd_data/index.php:180</td><td>CREATE $temporary TABLE tech.order_pd_info(
  PRIMARY KEY(order_id)
) 
SELECT 
  o.order_id, 
  o.order_date, 
  IFNULL(co.account_name, a.account_name) account_name, 
  IFNULL(co.state, a.state_code) state, 
  coi.opportunity_owner, 
  IFNULL(co.order_total, os.order_total) order_total, 
  co.credit_total, 
  o.start_date, 
  o.end_date, 
  SUM(
    CASE WHEN sub_product_type_id IN (
      ".$SUB_PRODUCT_TYPES[" initial training "].", 
      ".$SUB_PRODUCT_TYPES[" followup training "]."
    ) THEN 1 ELSE 0 END
  ) sum_onsite_days, 
  SUM(
    CASE WHEN sub_product_type_id IN (
      ".$SUB_PRODUCT_TYPES[" initial training "].", 
      ".$SUB_PRODUCT_TYPES[" followup training "]."
    ) THEN period_total ELSE 0 END
  ) price_onsite, 
  SUM(
    CASE WHEN sub_product_type_id IN (
      ".$SUB_PRODUCT_TYPES[" online training "].", 
      ".$SUB_PRODUCT_TYPES[" initial online training "]."
    ) THEN 1 ELSE 0 END
  ) sum_online_days, 
  SUM(
    CASE WHEN sub_product_type_id IN (
      ".$SUB_PRODUCT_TYPES[" online training "].", 
      ".$SUB_PRODUCT_TYPES[" initial online training "]."
    ) THEN period_total ELSE 0 END
  ) price_online 
FROM 
  interlink.order_details od 
  INNER JOIN interlink.orders o ON (o.order_id = od.order_id) 
  INNER JOIN tech.pd_costs ods ON (
    o.order_id = ods.order_id 
    AND od.order_detail_id = ods.order_detail_id
  ) 
  LEFT JOIN commissions.orders co ON (
    o.order_id = co.order_id 
    AND co.cmonth = '$cmonth'
  ) 
  LEFT JOIN commissions.order_info coi ON (
    o.order_id = coi.order_id 
    AND coi.cmonth = '$cmonth'
  ) 
  LEFT JOIN interlink.order_summary os ON (o.order_id = os.order_id) 
  LEFT JOIN interlink.accounts a ON (a.account_id = o.account_id) 
WHERE 
  od.status = 0 
  AND o.status = 0 
  AND o.order_date >= @min_order_date_start $whereStr 
GROUP BY 
  o.order_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/pd_data/index.php:215</td><td>CREATE $temporary TABLE tech.pd_data(
  id int auto_increment PRIMARY KEY, 
  KEY(order_id)
) 
SELECT 
  NULL id, 
  o.order_id, 
  o.order_date `Order Date`, 
  o.account_name `Account Name`, 
  o.state `State`, 
  o.opportunity_owner `Opportunity Owner`, 
  o.order_total `Order Total`, 
  o.credit_total `Credit Total`, 
  o.start_date `Start Date`, 
  o.end_date `End Date`, 
  o.sum_onsite_days `# of Onsite Days`, 
  o.price_onsite `Total Price Onsite PD`, 
  o.sum_online_days `# of Online Days`, 
  o.price_online `Total Price Online PD`, 
  od.pd_type `Type`, 
  CASE WHEN od.sub_product_type_id IN (
    ".$SUB_PRODUCT_TYPES[" initial training "].", 
    ".$SUB_PRODUCT_TYPES[" followup training "]."
  ) THEN 'N' WHEN od.sub_product_type_id IN (
    ".$SUB_PRODUCT_TYPES[" online training "].", 
    ".$SUB_PRODUCT_TYPES[" initial online training "]."
  ) THEN 'Y' ELSE '' END AS `Online`, 
  od.period_month `Date Of PD Recognition`, 
  CASE WHEN e.event_name = 'Satisfied PD' THEN 'Expired' WHEN e.event_date <= CURDATE() THEN 'Delivered' WHEN e.event_date > CURDATE() THEN 'Projected' ELSE '' END AS `Delivered/Expired`, 
  e.event_name `Event Name`, 
  od.order_detail_id, 
  od.academic_year_name `Academic Year`, 
  od.period_total `Price`, 
  od.pd_standalone `PD Standalone`, 
  od.order_detail_end `Order Detail End`, 
  od.we_care_event_name `We Care Event Name`, 
  CASE WHEN od.we_care_date = '0000-00-00' THEN '' ELSE od.we_care_date END `We Care Date` 
FROM 
  tech.order_pd_info o 
  INNER JOIN tech.pd_costs od ON (
    o.order_id = od.order_id 
    AND od.sub_product_type_id IN (
      ".$SUB_PRODUCT_TYPES[" initial training "].", 
      ".$SUB_PRODUCT_TYPES[" followup training "].", 
      ".$SUB_PRODUCT_TYPES[" online training "].", 
      ".$SUB_PRODUCT_TYPES[" initial online training "]."
    )
  ) 
  LEFT JOIN amortization.pd_events e ON (od.pd_event_id = e.pd_event_id) 
WHERE 
  1 $RevenueWhereStr;</td><td></td><td></td></tr>
   <tr><td>reports/opportunities/trend_index.php:235</td><td>CREATE TEMPORARY TABLE $table_name1 
SELECT 
  ot_id.opportunity_id, 
  ot_min.old_probability_id, 
  ot_max.new_probability_id, 
  last_change 
FROM 
  (
    SELECT 
      ot.opportunity_id, 
      min(opportunity_trend_id) start_id, 
      max(opportunity_trend_id) end_id, 
      max(date_entered) last_change 
    FROM 
      (
        opportunity_trend ot, opportunity_probabilities op_new
      ) 
      left join opportunity_probabilities op_old on (
        ot.old_probability_id = op_old.probability_id
      ) 
    WHERE 
      ot.new_probability_id = op_new.probability_id 
      AND (
        op_new.probability_percent >=.1 
        OR op_old.probability_percent >=.1 
        OR op_new.probability_percent <=.9 
        OR op_old.probability_percent <=.9
      ) $whereStr1 
    GROUP BY 
      opportunity_id
  ) ot_id, 
  opportunity_trend ot_min, 
  opportunity_trend ot_max 
WHERE 
  ot_min.opportunity_trend_id = ot_id.start_id 
  AND ot_max.opportunity_trend_id = ot_id.end_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/opportunities/trend_index.php:289</td><td>CREATE TEMPORARY TABLE $table_name 
SELECT 
  opportunity_name, 
  date_entered, 
  close_date, 
  total, 
  opportunity_id, 
  last_change, 
  probability_old, 
  probability_new, 
  rep_first_name, 
  rep_last_name, 
  region_name, 
  state_code, 
  district, 
  school, 
  if(
    (
      probability_old = probability_new 
      OR probability_old IS NULL
    ), 
    1, 
    0
  ) static, 
  if(
    probability_old > probability_new, 
    1, 0
  ) declined, 
  if(
    probability_old < probability_new, 
    1, 0
  ) advanced 
FROM 
  (
    SELECT 
      DISTINCT o.opportunity_id, 
      opportunity_name, 
      o.date_entered, 
      close_date, 
      total, 
      t.old_probability_id, 
      t.new_probability_id, 
      t.last_change, 
      op_old.probability_percent probability_old, 
      op_new.probability_percent probability_new, 
      u.first_name rep_first_name, 
      u.last_name rep_last_name, 
      region_name, 
      a.state_code, 
      if(
        a.account_level = 2, d.account_name, 
        a.account_name
      ) district, 
      if(
        a.account_level = 2, a.account_name, 
        ''
      ) school 
    FROM 
      (
        opportunities o, accounts a, user_orders uo, 
        users u, region_states rs, regions r
      ) 
      LEFT JOIN $table_name1 t ON (
        t.opportunity_id = o.opportunity_id
      ) 
      LEFT JOIN opportunity_probabilities op_old ON (
        t.old_probability_id = op_old.probability_id
      ) 
      LEFT JOIN opportunity_probabilities op_new ON (
        t.new_probability_id = op_new.probability_id
      ) 
      LEFT JOIN accounts d on (
        a.parent_account_id = d.account_id
      ) 
    WHERE 
      1 
      AND o.account_id = a.account_id 
      AND o.opportunity_id = uo.opportunity_id 
      AND uo.role_id = '".$ROLE[$DEPARTMENT["sales"]]["sales_rep"]."' 
      AND uo.user_id = u.user_id 
      AND r.department_id = '{$DEPARTMENT["sales"]}' 
      AND rs.region_id = r.region_id 
      AND rs.state_code = a.state_code 
      AND (
        t.opportunity_id IS NOT NULL 
        OR o.probability_id > 1
      ) 
      AND (
        t.opportunity_id IS NOT NULL 
        OR o.order_id = 0
      ) $whereStr
  ) tbl</td><td></td><td>skip</td></tr>
   <tr><td>util/function/new_renew.php:250</td><td>CREATE TEMPORARY TABLE $tmpTableName 
SELECT 
  o_data.*, 
  CASE WHEN @v_order_detail_id = o_data.order_detail_id THEN @row_id := @row_id + 1 ELSE @row_id := 1 END od_row_id, 
  @v_order_detail_id := o_data.order_detail_id v_order_detail_id 
FROM 
  (
    SELECT 
      o.order_id, 
      o.order_date, 
      o.status as order_cancel_flag, 
      o.start_date, 
      o.end_date, 
      od.start_date as od_start_date, 
      od.account_id, 
      od.order_detail_id, 
      od.product_id, 
      od.quantity, 
      sp.sub_product_type_id, 
      nr.financial_renewal_treatment, 
      nr.renewal_override_reason_id, 
      nr.pro_rated_fees, 
      nr.pro_rated_discounts, 
      od.price, 
      od.status as item_cancel_flag, 
      ay.summer, 
      ay.sort, 
      COALESCE(
        ls.new_renewal_override, 'Default'
      ) as ls_new_renew, 
      p.product_group_id, 
      a.school_start, 
      a.school_end, 
      nr.order_renewal_status, 
      od.price * od.quantity as gross_amount, 
      SUM(
        (
          CASE WHEN sp.pd_quantity_row = 1 THEN 1 ELSE od.quantity * sp.sub_product_qty END * IFNULL(slpc.price, sp.list_price)
        )
      ) AS list_price, 
      SUM(
        if (
          spt.std_discount = 'Y', 
          CASE WHEN sp.pd_quantity_row = 1 THEN 1 ELSE od.quantity * sp.sub_product_qty END * IFNULL(slpc.price, sp.list_price), 
          0
        )
      ) AS non_pd_price, 
      SUM(
        if (
          spt.discountable = 'Y', 
          CASE WHEN sp.pd_quantity_row = 1 THEN 1 ELSE od.quantity * sp.sub_product_qty END * IFNULL(slpc.price, sp.list_price), 
          0
        )
      ) AS discountable_price, 
      sp.pd_rank 
    FROM 
      orders as o 
      JOIN order_details AS od ON o.order_id = od.order_id 
      AND od.status <> 2 
      /* Exclude deleted records. */
      JOIN products AS p ON p.product_id = od.product_id 
      LEFT JOIN accounts AS a ON a.account_id = od.account_id 
      LEFT JOIN (
        SELECT 
          sp.*, 
          CASE WHEN (
            sp.pd_deliverable = 'Y' 
            OR sp.sub_product_type_id IN (
              ".$SUB_PRODUCT_TYPES[" imf "].", ".$SUB_PRODUCT_TYPES[" NLS "]."
            )
          ) THEN 1 ELSE 0 END pd_quantity_row, 
          @sp_row_id, 
          CASE WHEN CONCAT(
            order_detail_id, '|', product_id, 
            '|', sub_product_type_id
          ) = @sp_row_id THEN @pd_rank := @pd_rank + 1 ELSE @pd_rank := 1 END pd_rank, 
          @sp_row_id := CONCAT(
            order_detail_id, '|', product_id, 
            '|', sub_product_type_id
          ) set_row_id 
        FROM 
          (
            SELECT 
              sp.*, 
              spt.pd_deliverable, 
              od.order_detail_id 
            FROM 
              sub_products sp 
              INNER JOIN sub_product_types spt USING(sub_product_type_id) 
              INNER JOIN order_details od ON sp.product_id = od.product_id 
              LEFT JOIN interlink.number n ON n.number <= CASE WHEN (
                spt.pd_deliverable = 'Y' 
                OR spt.sub_product_type_id IN (
                  ".$SUB_PRODUCT_TYPES[" imf "].", ".$SUB_PRODUCT_TYPES[" NLS "]."
                )
              ) THEN sp.sub_product_qty * od.quantity ELSE 1 END 
            WHERE 
              od.order_id = $order_id 
              AND sp.status = 0 
            ORDER BY 
              order_detail_id, 
              product_id, 
              sub_product_type_id
          ) sp CROSS 
          JOIN (
            SELECT 
              @sp_row_id := '', 
              @pd_rank := 0
          ) v
      ) AS sp ON (
        sp.order_detail_id = od.order_detail_id 
        AND sp.product_id = od.product_id 
        and (
          sp.status = 0 
          or sp.sub_product_id < 9000
        )
      ) 
      LEFT JOIN sub_product_types AS spt ON spt.sub_product_type_id = sp.sub_product_type_id 
      LEFT JOIN academic_years AS ay ON ay.academic_year_id = od.academic_year_id 
      LEFT JOIN order_new_renewal_data AS nr ON (
        nr.order_detail_id = od.order_detail_id
      ) 
      LEFT JOIN (
        SELECT 
          order_id, 
          MIN(lead_source_id) lead_source_id 
        FROM 
          opportunities 
        WHERE 
          order_id > 0 
        GROUP BY 
          order_id
      ) AS op on (op.order_id = o.order_id) 
      LEFT JOIN interlink.lead_source_new_renew as ls on (
        ls.lead_source_id = op.lead_source_id 
        AND o.order_date BETWEEN ls.start_date 
        AND ls.end_date
      ) 
      LEFT JOIN sp_list_price_changes slpc ON slpc.order_detail_id = od.order_detail_id 
      and slpc.sub_product_id = sp.sub_product_id 
    WHERE 
      o.order_id = $order_id 
      AND o.order_date >= '2010-01-01' 
      AND p.revenue = 'Y' 
    GROUP BY 
      od.order_detail_id, 
      sp.sub_product_type_id, 
      pd_rank 
    ORDER BY 
      od.start_date, 
      od.order_detail_id
  ) AS o_data CROSS 
  JOIN (
    SELECT 
      @v_order_detail_id := 0, 
      @row_id := 0
  ) v</td><td></td><td>skip</td></tr>
   <tr><td>util/function/new_renew.php:611</td><td>CREATE TEMPORARY TABLE tmp_only_pd_prods (
  PRIMARY KEY (product_id)
) 
SELECT 
  p.product_id, 
  SUM(
    sp.list_price * sp.sub_product_qty
  ) list_price, 
  SUM(
    CASE WHEN sp.sub_product_type_id IN (4, 5) THEN 4 ELSE 1 END * sp.sub_product_qty
  ) sub_product_units 
FROM 
  products p 
  INNER JOIN sub_products sp ON p.product_id = sp.product_id 
  AND sp.status = 0 
  INNER JOIN sub_product_types spt ON spt.sub_product_type_id = sp.sub_product_type_id 
GROUP BY 
  p.product_id 
HAVING 
  MIN(pd_deliverable)= 'Y' 
  AND MAX(pd_deliverable)= 'Y';</td><td></td><td>skip</td></tr>
   <tr><td>util/function/new_renew.php:629</td><td>CREATE TABLE od_list_price_changes (
  PRIMARY KEY (order_detail_id)
) 
SELECT 
  od.order_detail_id, 
  od.product_id, 
  pdp.list_price orig_list_price, 
  od.price, 
  pdp.sub_product_units 
FROM 
  interlink.order_details od 
  INNER JOIN interlink.orders o ON od.order_id = o.order_id 
  INNER JOIN interlink.accounts a ON od.account_id = a.account_id 
  INNER JOIN interlink.locations l ON l.location_code = a.state_code 
  AND l.location_type = 's' 
  INNER JOIN tmp_only_pd_prods pdp ON pdp.product_id = od.product_id 
WHERE 
  l.is_domestic = 0 
  AND o.order_date >= '2014-01-01' 
  AND od.price > pdp.list_price;</td><td></td><td></td></tr>
   <tr><td>util/function/new_renew.php:646</td><td>CREATE TABLE sp_list_price_changes (
  PRIMARY KEY (order_detail_id, sub_product_id)
) 
SELECT 
  od.order_detail_id, 
  sp.sub_product_id, 
  sp.sub_product_type_id, 
  sp.sub_product_qty, 
  CASE WHEN sp.sub_product_type_id IN (4, 5) THEN 4 ELSE 1 END *(od.price - od.orig_list_price)/ sub_product_units + sp.list_price price 
FROM 
  od_list_price_changes od 
  INNER JOIN interlink.sub_products sp ON (
    od.product_id = sp.product_id 
    AND sp.status = 0
  ) 
  INNER JOIN interlink.sub_product_types spt ON (
    spt.sub_product_type_id = sp.sub_product_type_id
  ) 
WHERE 
  1;</td><td></td><td></td></tr>
   <tr><td>cron/daily/new_orders_yest.php:20</td><td>create table tech.finalAmount 
select 
  distinct oc.cancel_id, 
  o.order_id, 
  sum(os.order_total) - sum(
    ifnull(oc.credit_amount, 0)
  ) 'final' 
from 
  orders o 
  join order_summary os on o.order_id = os.order_id 
  left join order_cancels oc on o.order_id = oc.order_id 
  and oc.status = 0 
where 
  $dateRange 
  and o.status = 0 
group by 
  o.order_id</td><td></td><td></td></tr>
   <tr><td>cron/daily/new_orders_yest.php:39</td><td>create table tech.prices 
select 
  distinct o.date_entered, 
  o.order_id, 
  SUM(
    IF(
      p.product_group_id NOT IN(28, 32), 
      d.quantity * d.price, 
      NULL
    )
  ) sub_total, 
  SUM(
    IF(
      p.product_group_id = 28 
      AND d.status = 0, 
      d.quantity * d.price, 
      NULL
    )
  ) discount 
from 
  orders o 
  join order_details d on d.order_id = o.order_id 
  join products p on p.product_id = d.product_id 
where 
  $dateRange 
  and o.status = 0 
group by 
  o.order_id</td><td></td><td></td></tr>
   <tr><td>cron/daily/new_orders_yest.php:59</td><td>create table tech.hl_00645622 
select 
  replace(
    concat_ws(' ', u.first_name, u.last_name), 
    ',', 
    ''
  ) EnteredBy, 
  o.order_id, 
  group_concat(
    distinct replace(a.account_name, ',', '') 
    order by 
      a.account_name separator '/'
  ) account_name, 
  group_concat(
    distinct replace(b.account_name, ',', '') 
    order by 
      b.account_name separator '/'
  ) parent_account_name, 
  group_concat(
    distinct replace(p.product_name, ',', '') 
    order by 
      p.product_name separator '/'
  ) product_name, 
  tp.sub_total, 
  tp.discount, 
  f.final, 
  replace(
    concat_ws(' ', us.first_name, us.last_name), 
    ',', 
    ''
  ) SalesRep, 
  o.date_entered 
from 
  orders o 
  join order_details od on od.order_id = o.order_id 
  join accounts a on a.account_id = od.account_id 
  left join accounts b on b.account_id = a.parent_account_id 
  left join order_details d on d.order_id = o.order_id 
  and d.product_id = 2 
  join users u on u.user_id = o.entered_by 
  left join user_orders ua 
  join users us on ua.user_id = us.user_id on ua.order_id = o.order_id 
  and ua.role_id = 6 
  join products p on p.product_id = od.product_id 
  left join tech.finalAmount f on f.order_id = o.order_id 
  left join tech.prices tp on tp.order_id = o.order_id 
where 
  $dateRange 
  and p.product_group_id not in (28, 32) 
  and p.sku not regexp 'spt|imp' 
  and od.status = 0 
  and o.status = 0 
group by 
  o.order_id</td><td></td><td></td></tr>
   <tr><td>cron/expire_pd.php:9</td><td>CREATE TEMPORARY TABLE expire_pd 
SELECT 
  aos.order_id, 
  aos.order_detail_id, 
  aos.account_id, 
  aos.academic_year_id, 
  aosd.online, 
  aos.initial_purchased_pd, 
  aos.followup_purchased_pd, 
  aos.online_purchased_pd, 
  aos.initial_online_purchased_pd, 
  aosd.fulfilled_pd + aosd.scheduled_pd delivered_pd, 
  0.0 initial_outstanding, 
  0.0 followup_outstanding, 
  0.0 online_outstanding, 
  0.0 initial_online_outstanding, 
  0.0 total_outstanding, 
  aosd.reallocated, 
  od.end_date 
from 
  account_order_summary aos, 
  account_order_summary_details aosd, 
  order_details od 
where 
  od.order_detail_id = aos.order_detail_id 
  AND od.order_detail_id = aosd.order_detail_id 
  AND aos.account_id = aosd.account_id 
  AND aos.reallocated = aosd.reallocated 
  AND aos.academic_year_id = aosd.academic_year_id 
  and aosd.purchased_pd > (
    aosd.scheduled_pd + aosd.fulfilled_pd
  ) 
  and od.status = 0 
  AND od.end_date BETWEEN '2012-01-01' 
  AND now()</td><td></td><td>skip</td></tr>
   <tr><td>cron/quarterly_pd_utilization.php:12</td><td>CREATE TEMPORARY TABLE ".$rand." _pd_cims (
  KEY(user_id)
) 
SELECT 
  u.user_id, 
  COUNT(
    DISTINCT IF(
      a.account_level = 2, a.account_id, 
      NULL
    )
  ) 'school', 
  COUNT(
    DISTINCT IF(
      a.account_level = 1, a.account_id, 
      NULL
    )
  ) 'district' 
FROM 
  users u 
  JOIN user_accounts ua ON ua.user_id = u.user_id 
  AND ua.account_owner = 1 
  AND ua.role_id = 4 
  JOIN accounts a ON a.account_id = ua.account_id 
  AND a.customer_status = 'current customer' 
GROUP BY 
  u.user_id</td><td></td><td>skip</td></tr>
   <tr><td>cron/quarterly_pd_utilization.php:22</td><td>CREATE TEMPORARY TABLE ".$rand." _pd_rvp_regions (
  KEY(user_id)
) 
SELECT 
  DISTINCT ul.user_id, 
  r.region_id 
FROM 
  user_regions ul 
  JOIN user_roles ur ON ul.user_id = ur.user_id 
  JOIN department_roles dr USING(role_id) 
  JOIN users u ON u.user_id = ur.user_id 
  JOIN regions r ON r.region_id = ul.region_id 
  AND r.department_id = 1 
WHERE 
  role_name = 'rvp' 
  AND dr.department_id = 1 
  AND u.status = 0 
  AND ur.display_flag = 'Y' 
UNION 
SELECT 
  DISTINCT r.user_id, 
  regions.region_id 
FROM 
  user_regions r 
  JOIN user_roles rl ON r.user_id = rl.user_id 
  AND rl.role_id = 7 
  AND rl.display_flag = 'n' 
  AND rl.department_id = 1 
  JOIN users us ON us.user_id = rl.user_id 
  AND us.status = 0 
  LEFT JOIN user_regions ul 
  JOIN user_roles ur ON ul.user_id = ur.user_id 
  AND ur.role_id = 7 
  AND ur.department_id = 1 
  AND ur.display_flag = 'y' 
  JOIN users u ON u.user_id = ur.user_id 
  AND u.status = 0 ON ul.region_id = r.region_id 
  JOIN regions ON regions.region_id = r.region_id 
  AND regions.department_id = 1 
WHERE 
  ul.region_id IS NULL</td><td></td><td>skip</td></tr>
   <tr><td>cron/quarterly_pd_utilization.php:42</td><td>CREATE TEMPORARY TABLE ".$rand." _pd_rvp_manager (
  KEY(user_id)
) 
SELECT 
  u.user_id, 
  COALESCE(
    GROUP_CONCAT(
      DISTINCT IF(
        ur.role_id = 7 
        AND ur.display_flag = 'y', 
        ur.user_id, 
        NULL
      )
    ), 
    GROUP_CONCAT(
      DISTINCT IF(
        mur.role_id = 7 
        AND mur.display_flag = 'y', 
        mur.user_id, 
        NULL
      )
    ), 
    GROUP_CONCAT(DISTINCT mmur.user_id)
  ) rvp 
FROM 
  users u 
  JOIN user_roles a ON a.user_id = u.user_id 
  LEFT JOIN user_roles ur ON ur.user_id = u.user_id 
  LEFT JOIN users mu ON mu.user_id = u.manager_id 
  LEFT JOIN user_roles mur ON mur.user_id = mu.user_id 
  LEFT JOIN user_roles mmur ON mmur.user_id = mu.manager_id 
  AND mmur.role_id = 7 
WHERE 
  a.department_id = 1 
  AND a.display_flag = 'Y' 
  AND a.role_id IN(4, 5) 
GROUP BY 
  u.user_id</td><td></td><td>skip</td></tr>
   <tr><td>cron/quarterly_pd_utilization.php:60</td><td>CREATE TEMPORARY TABLE ".$rand." _pd_events (
  KEY(quarter, user_id)
) 
SELECT 
  CONCAT(
    YEAR(e.event_date), 
    '-', 
    CEILING(
      MONTH(e.event_date)/ 3
    )
  ) quarter, 
  e.user_id, 
  COUNT(
    DISTINCT IF(
      (
        e.event_type_id = 1 
        AND e.pd_type_id <> 5 
        AND e.online = 'n' 
        AND p.program_id <> ".SMARTY_ANTS_PROGRAM."
      ), 
      e.event_date, 
      NULL
    )
  ) 'onsite_pro_billable_count', 
  SEC_TO_TIME(
    SUM(
      IF(
        (
          e.event_type_id = 1 
          AND e.pd_type_id <> 5 
          AND e.online = 'n' 
          AND p.program_id <> ".SMARTY_ANTS_PROGRAM."
        ), 
        TIME_TO_SEC(
          TIMEDIFF(e.end_time, e.start_time)
        ), 
        0
      )
    )
  ) 'onsite_pro_billable_hours', 
  COUNT(
    DISTINCT IF(
      (
        e.event_type_id = 1 
        AND e.pd_type_id <> 5 
        AND e.online = 'y' 
        AND p.program_id <> ".SMARTY_ANTS_PROGRAM."
      ), 
      e.event_id, 
      NULL
    )
  ) 'online_pro_billable_count', 
  SEC_TO_TIME(
    SUM(
      IF(
        (
          e.event_type_id = 1 
          AND e.pd_type_id <> 5 
          AND e.online = 'y' 
          AND p.program_id <> ".SMARTY_ANTS_PROGRAM."
        ), 
        TIME_TO_SEC(
          TIMEDIFF(e.end_time, e.start_time)
        ), 
        0
      )
    )
  ) 'online_pro_billable_hours', 
  COUNT(
    DISTINCT IF(
      (
        e.event_type_id = 1 
        AND e.pd_type_id <> 5 
        AND e.online = 'n' 
        AND p.program_id = ".SMARTY_ANTS_PROGRAM."
      ), 
      e.event_date, 
      NULL
    )
  ) 'onsite_smartyants_billable_count', 
  SEC_TO_TIME(
    SUM(
      IF(
        (
          e.event_type_id = 1 
          AND e.pd_type_id <> 5 
          AND e.online = 'n' 
          AND p.program_id = ".SMARTY_ANTS_PROGRAM."
        ), 
        TIME_TO_SEC(
          TIMEDIFF(e.end_time, e.start_time)
        ), 
        0
      )
    )
  ) 'onsite_smartyants_billable_hours', 
  COUNT(
    DISTINCT IF(
      (
        e.event_type_id = 1 
        AND e.pd_type_id <> 5 
        AND e.online = 'y' 
        AND p.program_id = ".SMARTY_ANTS_PROGRAM."
      ), 
      e.event_id, 
      NULL
    )
  ) 'online_smartyants_billable_count', 
  SEC_TO_TIME(
    SUM(
      IF(
        (
          e.event_type_id = 1 
          AND e.pd_type_id <> 5 
          AND e.online = 'y' 
          AND p.program_id = ".SMARTY_ANTS_PROGRAM."
        ), 
        TIME_TO_SEC(
          TIMEDIFF(e.end_time, e.start_time)
        ), 
        0
      )
    )
  ) 'online_smartyants_billable_hours', 
  COUNT(
    DISTINCT IF(
      (
        e.pd_type_id = 5 
        AND e.online = 'n' 
        AND p.program_id <> ".SMARTY_ANTS_PROGRAM."
      ), 
      e.event_date, 
      NULL
    )
  ) 'onsite_pro_we-care_count', 
  SEC_TO_TIME(
    SUM(
      IF(
        (
          e.pd_type_id = 5 
          AND e.online = 'n' 
          AND p.program_id <> ".SMARTY_ANTS_PROGRAM."
        ), 
        TIME_TO_SEC(
          TIMEDIFF(e.end_time, e.start_time)
        ), 
        0
      )
    )
  ) 'onsite_pro_we-care_hours', 
  COUNT(
    DISTINCT IF(
      (
        e.pd_type_id = 5 
        AND e.online = 'y' 
        AND p.program_id <> ".SMARTY_ANTS_PROGRAM."
      ), 
      e.event_id, 
      NULL
    )
  ) 'online_pro_we-care_count', 
  SEC_TO_TIME(
    SUM(
      IF(
        (
          e.pd_type_id = 5 
          AND e.online = 'y' 
          AND p.program_id <> ".SMARTY_ANTS_PROGRAM."
        ), 
        TIME_TO_SEC(
          TIMEDIFF(e.end_time, e.start_time)
        ), 
        0
      )
    )
  ) 'online_pro_we-care_hours', 
  COUNT(
    DISTINCT IF(
      (
        e.pd_type_id = 5 
        AND e.online = 'n' 
        AND p.program_id = ".SMARTY_ANTS_PROGRAM."
      ), 
      e.event_date, 
      NULL
    )
  ) 'onsite_smartyants_we-care_count', 
  SEC_TO_TIME(
    SUM(
      IF(
        (
          e.pd_type_id = 5 
          AND e.online = 'n' 
          AND p.program_id = ".SMARTY_ANTS_PROGRAM."
        ), 
        TIME_TO_SEC(
          TIMEDIFF(e.end_time, e.start_time)
        ), 
        0
      )
    )
  ) 'onsite_smartyants_we-care_hours', 
  COUNT(
    DISTINCT IF(
      (
        e.pd_type_id = 5 
        AND e.online = 'y' 
        AND p.program_id = ".SMARTY_ANTS_PROGRAM."
      ), 
      e.event_id, 
      NULL
    )
  ) 'online_smartyants_we-care_count', 
  SEC_TO_TIME(
    SUM(
      IF(
        (
          e.pd_type_id = 5 
          AND e.online = 'y' 
          AND p.program_id = ".SMARTY_ANTS_PROGRAM."
        ), 
        TIME_TO_SEC(
          TIMEDIFF(e.end_time, e.start_time)
        ), 
        0
      )
    )
  ) 'online_smartyants_we-care_hours', 
  SEC_TO_TIME(
    SUM(
      IF(
        (e.event_type_id = 1), 
        TIME_TO_SEC(
          TIMEDIFF(e.end_time, e.start_time)
        ), 
        0
      )
    )
  ) 'total_billable_hours', 
  COUNT(
    DISTINCT IF(
      (
        e.event_type_id IN (13, 17)
      ), 
      e.event_date, 
      NULL
    )
  ) 'project_management', 
  COUNT(
    DISTINCT IF(
      (e.event_type_id = 11), 
      e.event_date, 
      NULL
    )
  ) 'internal_training', 
  COUNT(
    DISTINCT IF(
      (e.event_type_id = 10), 
      e.event_date, 
      NULL
    )
  ) 'sales_support', 
  COUNT(
    DISTINCT IF(
      (e.event_type_id = 4), 
      e.event_date, 
      NULL
    )
  ) 'office_days', 
  COUNT(
    DISTINCT IF(
      (e.event_type_id = 3), 
      e.event_date, 
      NULL
    )
  ) 'holds', 
  COUNT(
    DISTINCT IF(
      (e.event_type_id = 5), 
      e.event_date, 
      NULL
    )
  ) 'travels', 
  COUNT(
    DISTINCT IF(
      (e.event_type_id = 20), 
      e.event_date, 
      NULL
    )
  ) 'preps', 
  COUNT(
    DISTINCT IF(
      e.notes REGEXP '^sick| ^ sick|sick day', 
      e.event_date, NULL
    )
  ) 'sick_days', 
  COUNT(
    DISTINCT IF(
      (
        e.notes NOT REGEXP '^sick| ^ sick|sick day' 
        AND e.event_type_id = 6
      ), 
      e.event_date, 
      NULL
    )
  ) 'unavailable', 
  COUNT(
    DISTINCT IF(
      (
        e.notes NOT REGEXP '^sick| ^ sick|sick day' 
        AND e.event_type_id = 2
      ), 
      e.event_date, 
      NULL
    )
  ) 'vacation', 
  COUNT(
    DISTINCT IF(
      e.event_type_id NOT IN (1, 2, 4, 3, 5, 6, 20, 13, 17, 11, 10) 
      AND e.notes NOT REGEXP '^sick| ^ sick|sick day', 
      e.event_date, 
      NULL
    )
  ) 'other_non_billable' 
  /*
  , COUNT(DISTINCT IF((e.event_type_id = 1 AND nr.financial_renewal_treatment = 'new'), e.event_date, NULL)) 'new_order_event_days'
  , COUNT(DISTINCT IF((e.event_type_id = 1 AND nr.financial_renewal_treatment = 'renewal'), e.event_date, NULL)) 'renewal_order_event_days'
  */
FROM 
  (
    SELECT 
      beu.user_id, 
      be.* 
    FROM 
      event_users beu 
      JOIN events be ON be.event_id = beu.event_id 
      AND beu.is_primary = 1 
      AND be.event_type_id = 1 
    UNION 
    SELECT 
      eu.user_id, 
      e.* 
    FROM 
      event_users eu 
      JOIN events e ON e.event_id = eu.event_id 
      JOIN user_roles ur ON ur.user_id = eu.user_id 
      AND ur.role_id IN (4, 5) 
      AND ur.display_flag = 'y' 
      LEFT JOIN event_users eu2 
      JOIN events e2 ON e2.event_id = eu2.event_id 
      AND e2.event_type_id IN (1) 
      AND e2.status = 0 
      AND e2.event_status <> 'X' 
      AND e2.online = 'n' ON eu2.user_id = eu.user_id 
      AND e2.event_date = e.event_date 
    WHERE 
      (
        e.event_type_id <> 1 
        OR e.notes REGEXP '^sick| ^ sick|sick day'
      ) 
      AND e2.event_id IS NULL
  ) e 
  LEFT JOIN order_details od ON od.order_detail_id = e.order_detail_id 
  LEFT JOIN order_new_renewal_data nr ON nr.order_detail_id = od.order_detail_id 
  LEFT JOIN products p ON p.product_id = od.product_id 
WHERE 
  e.status = 0 
  AND e.event_status NOT IN ('x', 't') 
  AND e.status = 0 
  AND e.event_status NOT IN ('x', 't') 
  AND e.event_date BETWEEN '$start_date' 
  AND $end_date 
GROUP BY 
  e.user_id, 
  quarter 
ORDER BY 
  quarter, 
  user_id</td><td></td><td>skip</td></tr>
   <tr><td>cron/quarterly_pd_utilization.php:114</td><td>CREATE TEMPORARY TABLE ".$rand." _pd_start (
  KEY(user_id)
) 
SELECT 
  eu.user_id, 
  MIN(
    IF(
      e.event_date <> '0000-00-00', e.event_date, 
      NULL
    )
  ) 'first_event' 
FROM 
  events e 
  JOIN event_users eu ON eu.event_id = e.event_id 
  JOIN ".$rand." _pd_events t ON eu.user_id = t.user_id 
WHERE 
  e.status = 0 
  AND e.event_status NOT IN ('x', 't') 
  AND YEAR(e.event_date) > 2000 
GROUP BY 
  eu.user_id</td><td></td><td>skip</td></tr>
   <tr><td>finance/invoices/import/after_import_summary.php:41</td><td>CREATE TEMPORARY TABLE recent_billing_orders (
  primary key (order_id)
) 
SELECT 
  DISTINCT io.order_id, 
  o.order_date 
FROM 
  invoice_orders io, 
  invoices i, 
  interlink.orders o 
WHERE 
  io.invoice_id = i.invoice_id 
  AND io.order_id = o.order_id 
  AND YEAR(i.invoice_date) > '$lock_year'</td><td></td><td>skip</td></tr>
   <tr><td>finance/invoices/import/after_import_summary.php:68</td><td>create temporary table min_dates (
  PRIMARY KEY (order_id)
) 
select 
  io.order_id, 
  min(invoice_date) min_invoice_date, 
  min(order_date) min_order_date 
from 
  invoice_orders io, 
  invoices i, 
  interlink.orders o 
where 
  io.invoice_id = i.invoice_id 
  and io.order_id = o.order_id 
group by 
  io.order_id</td><td></td><td></td></tr>
   <tr><td>finance/invoices/import/after_import_summary.php:130</td><td>CREATE TABLE billing_summary (
  PRIMARY KEY (year, month)
) 
select 
  year(i.invoice_date) year, 
  month(i.invoice_date) month, 
  sum(io.invoice_amount - i.sales_tax) billing_total 
from 
  invoice_orders io, 
  invoices i 
where 
  io.invoice_id = i.invoice_id 
group by 
  year(i.invoice_date), 
  month(i.invoice_date)</td><td></td><td></td></tr>
   <tr><td>finance/invoices/import/insert_invoices_do.php:74</td><td>CREATE TABLE map_invoices (id INT AUTO_INCREMENT PRIMARY KEY) 
SELECT 
  i.invoice_id, 
  i.type, 
  i.ns_invoice_id, 
  i.invoice_date, 
  i.om_order_ids, 
  i.il_order_id, 
  ns_account_name, 
  i.invoice_total, 
  i.sales_tax, 
  ROUND(
    SUM(
      IFNULL(io.invoice_amount, 0)
    ), 
    2
  ) invoiced, 
  invoice_total - ROUND(
    SUM(
      IFNULL(io.invoice_amount, 0)
    ), 
    2
  ) remainder, 
  0 cancel_id 
FROM 
  invoices i 
  LEFT JOIN invoice_orders io ON (
    i.ns_invoice_id = io.ns_invoice_id 
    and i.invoice_id = io.invoice_id
  ) 
WHERE 
  (
    i.ns_invoice_id NOT IN (
      236, 6438, 5546, 214, 10071281, 71369, 
      245, 6537, 244, 6535, 5373, 200, 10071949, 
      71985, 804111, 10070651, 932, 936, 
      6392, 119, 10071567, 71735, 10081039, 
      10070153, 10070103, 6254, 10070127
    ) 
    OR i.date_entered > '2010-01-01'
  ) 
GROUP BY 
  i.invoice_id 
HAVING 
  ROUND(
    SUM(
      IFNULL(io.invoice_amount, 0)
    )
  ) NOT BETWEEN i.invoice_total - 1 
  AND i.invoice_total + 1 
ORDER BY 
  ns_account_name</td><td></td><td></td></tr>
   <tr><td>reports/finance/ay_product_line_values/index.php:184</td><td>CREATE TEMPORARY TABLE tech.ay_product_line_values2 (
  PRIMARY KEY (
    order_id, cancel_id ".($show_detail_account ? ", 
    `detail account id` " : "")."
  )
) 
SELECT 
  * 
FROM 
  tech.ay_product_line_values;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals_report.php:61</td><td>CREATE TEMPORARY TABLE amortization.tmp_acv_totals (
  PRIMARY KEY (order_id, cancel_id)
) 
SELECT 
  acv.order_id, 
  acv.cancel_id, 
  sum(acv.line_total) line_total, 
  sum(acv.new_total) new_total, 
  sum(acv.renew_total) renew_total, 
  sum(acv.sales_tax) sales_tax, 
  GROUP_CONCAT(
    DISTINCT rebook_order_id 
    ORDER BY 
      rebook_order_id DESC SEPARATOR ';'
  ) rebook_order 
FROM 
  $tbl_booking_total_acv acv 
  LEFT JOIN interlink.order_cancel_rebook_summary ocs ON ocs.order_id = acv.order_id 
  AND ocs.cancel_id = acv.cancel_id 
GROUP BY 
  order_id, 
  cancel_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals_report.php:74</td><td>CREATE TEMPORARY TABLE amortization.booking_orders (
  PRIMARY KEY (order_id)
) 
SELECT 
  o.order_id, 
  o.account_id, 
  a.state_code, 
  a.account_name, 
  o.order_date, 
  o.start_date, 
  o.end_date, 
  t.order_total order_total, 
  IF(
    a.account_level = 1, a.account_id, 
    p.account_id
  ) district_account_id, 
  IF(
    a.account_level = 1, a.account_name, 
    p.account_name
  ) district, 
  IF(
    a.account_level = 1, oa_t.tier_name, 
    oad_t.tier_name
  ) district_tier, 
  IF(
    a.account_level = 2, oa.account_id, 
    ''
  ) school_account_id, 
  IF(
    a.account_level = 2, oa.account_name, 
    ''
  ) school, 
  IF(
    a.account_level = 2, oa_t.tier_name, 
    ''
  ) school_tier, 
  IF(
    bill.account_id IS NOT NULL, bill.account_id, 
    a.account_id
  ) billing_account_id, 
  IF(
    IFNULL(bill.parent_account_id, 0) > 0, 
    bill.parent_account_id, 
    0
  ) billing_district_account_id, 
  IF(
    bill.account_id IS NOT NULL, bill.account_name, 
    a.account_name
  ) billto, 
  CASE WHEN o.ns_order_id = 'SO000001' THEN 0 ELSE o.ns_order_id END ns_order_id, 
  o.order_length, 
  o.expansion_order_id, 
  CASE WHEN o.replacement_order_id > 0 THEN o.replacement_order_id ELSE '' END replacement_order_id, 
  o.date_entered 
FROM 
  interlink.orders o 
  INNER JOIN interlink.order_summary t ON o.order_id = t.order_id 
  LEFT JOIN interlink.accounts a ON (o.account_id = a.account_id) 
  LEFT JOIN interlink.accounts p ON (
    a.parent_account_id = p.account_id
  ) 
  LEFT JOIN interlink.accounts bill ON (
    o.billing_account_id = bill.account_id
  ) 
  LEFT JOIN interlink.accounts oa ON oa.account_id = o.account_id 
  LEFT JOIN interlink.tiers oa_t ON oa_t.tier_id = oa.tier_id 
  LEFT JOIN interlink.accounts oad ON oad.account_id = IF(
    a.account_level = 2, p.account_id, 
    NULL
  ) 
  LEFT JOIN interlink.tiers oad_t ON oad_t.tier_id = oad.tier_id 
WHERE 
  1 
  AND o.order_date BETWEEN '$report_start_date' 
  AND '$report_end_date' 
GROUP BY 
  o.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals_report.php:111</td><td>CREATE TEMPORARY TABLE amortization.booking_order_type (
  PRIMARY KEY (order_id)
) 
SELECT 
  oi.order_id, 
  CASE WHEN l.is_domestic = 1 
  OR l.location_code IS NULL THEN 'Domestic' ELSE 'International' END domestic, 
  CASE WHEN oi.order_date > '2020-01-01' THEN 0 WHEN oi.opportunity_product_id IS NULL 
  OR oi.opportunity_product_id = 3 THEN 1 ELSE oi.opportunity_product_id END program_id, 
  CASE WHEN oi.order_date > '2020-01-01' THEN '' WHEN onames.opportunity_product_name IS NULL 
  OR onames.opportunity_product_id = 3 THEN 'Literacy' ELSE onames.opportunity_product_name END program 
FROM 
  interlink.orders oi 
  LEFT JOIN interlink.accounts a ON oi.account_id = a.account_id 
  LEFT JOIN interlink.locations l ON a.state_code = l.location_code 
  AND l.location_type = 's' 
  LEFT JOIN interlink.opportunity_products onames ON onames.opportunity_product_id = oi.opportunity_product_id 
WHERE 
  1 
GROUP BY 
  oi.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals_report.php:133</td><td>CREATE TEMPORARY TABLE tmp_order_discounts (
  PRIMARY KEY (order_id)
) 
SELECT 
  od.order_id, 
  MAX(
    CASE WHEN p.product_id = 2 THEN 'TRUE' ELSE 'FALSE' END
  ) has_discount, 
  TRIM(
    ';' 
    FROM 
      GROUP_CONCAT(
        DISTINCT CASE WHEN aprv.user_id THEN CONCAT(
          aprv.first_name, ' ', aprv.last_name
        ) ELSE NULL END 
        ORDER BY 
          di.id SEPARATOR ';'
      )
  ) approver, 
  TRIM(
    ';' 
    FROM 
      GROUP_CONCAT(
        DISTINCT NULLIF(di.approval_reason, '') 
        ORDER BY 
          di.id SEPARATOR ';'
      )
  ) approval_reasons, 
  TRIM(
    ';' 
    FROM 
      GROUP_CONCAT(
        DISTINCT NULLIF(di.business_effect, '') 
        ORDER BY 
          di.id SEPARATOR ';'
      )
  ) business_effect, 
  MAX(
    CASE WHEN IFNULL(di.adjust_reason, 0)<> 0 
    AND od.price > od.list_price 
    AND od.academic_year_id <> 0 THEN 'TRUE' ELSE 'FALSE' END
  ) has_price_increase, 
  TRIM(
    ';' 
    FROM 
      GROUP_CONCAT(
        DISTINCT CASE WHEN IFNULL(di.adjust_reason, 0)<> 0 
        AND od.price > od.list_price 
        AND od.academic_year_id <> 0 THEN CONCAT(
          adj.adjust_reason_name, 
          CASE WHEN TRIM(
            IFNULL(di.adjust_reason_notes, '')
          ) > '' THEN ' : ' ELSE '' END, 
          IFNULL(di.adjust_reason_notes, '')
        ) ELSE '' END 
        ORDER BY 
          di.id SEPARATOR ';'
      )
  ) price_adjust_reason 
FROM 
  interlink.order_details od 
  INNER JOIN interlink.orders o ON o.order_id = od.order_id 
  LEFT JOIN interlink.products p ON p.product_id = od.product_id 
  LEFT JOIN interlink.discount_approval_info di ON di.order_id = od.order_id #AND (od.product_id=di.product_id OR di.adjust_reason<>0)
  LEFT JOIN interlink.users aprv ON aprv.user_id = di.approved_by 
  LEFT JOIN interlink.price_adjust_reasons adj ON adj.adjust_reason_id = di.adjust_reason 
WHERE 
  1 
  AND o.order_date BETWEEN '$report_start_date' 
  AND '$report_end_date' 
GROUP BY 
  od.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/iplans/index.php:173</td><td>CREATE TABLE $ip_info_table(
  KEY(account_id)
) 
SELECT 
  a.account_id, 
  ip.iplan_id, 
  ip.reporting_group_id, 
  g.group_name reporting_group_name, 
  if (
    a.account_level = 1 
    and a.parent_account_id = 0, 
    a.account_id, 
    a.parent_account_id
  ) district_id, 
  if (
    a.account_level = 1 
    and a.parent_account_id = 0, 
    a.account_name, 
    pa.account_name
  ) district_name, 
  if (
    a.account_level = 1, '', a.account_name
  ) school_name, 
  a.state_code, 
  if (
    ip.iplan_id is null, 'Create', 'Exists'
  ) iplan_status, 
  ip.doc_type, 
  ip.iplan_version, 
  if(ip.uploaded = 1, 'Yes', '') uploaded, 
  ip.roster_upload_classes, 
  ip.roster_upload_notes, 
  if(
    ip.publish_roster_notes = 1, 'Yes', 
    'No'
  ) publish_roster_notes, 
  if (
    u.user_id is not null, 
    concat(u.first_name, ' ', u.last_name), 
    ''
  ) trainer, 
  ip.addtl_contact_name, 
  ip.addtl_contact_email, 
  ip.addtl_contact_phone, 
  ip.academic_year_id, 
  ip.school_start_date, 
  ip.school_end_date, 
  ip.teacher_school_start_date, 
  ip.teacher_school_end_date, 
  ip.school_start_time, 
  ip.school_end_time, 
  ip.semester_end_dates, 
  ip.teacher_only_dates, 
  ip.pre_test_start, 
  ip.pre_test_end, 
  ip.interim_test_start, 
  ip.interim_test_end, 
  if(
    ip.dev_reader_interim = 1, 'Yes', 'No'
  ) dev_reader_interim, 
  if(
    ip.interim_test_none = 1, 'Yes', 'No'
  ) interim_test_none, 
  ip.post_test_start, 
  ip.post_test_end, 
  if(ip.post_test_none = 1, 'Yes', 'No') post_test_none, 
  ip.target_teachers, 
  ip.instructional_day_structure, 
  ip.school_focus, 
  ip.student_usage_goal, 
  ip.teacher_goal, 
  ip.leadership_actions, 
  ip.college_readiness_goal, 
  ip.parent_goal, 
  ip.incentive_goal, 
  ip.centralized_notes, 
  ip.pls_notes 
FROM 
  (accounts a $addtl_tables) 
  LEFT JOIN accounts pa on pa.account_id = a.parent_account_id 
  LEFT JOIN iplans ip on ip.account_id = a.account_id 
  and ip.academic_year_id in ('$ay_filter') 
  LEFT JOIN $db_pick.reporting_groups g ON g.reporting_group_id = ip.reporting_group_id 
  AND g.status = 0 
  LEFT JOIN user_accounts au on au.account_id = a.account_id 
  and au.role_id in (
    " . $ROLE[$DEPARTMENT[" implementation "]][" trainer "] . "
  ) 
  and au.account_owner = 1 
  LEFT JOIN user_accounts c on c.account_id = a.account_id 
  and c.role_id in (
    " . $ROLE[$DEPARTMENT[" implementation "]][" area_manager "] . "
  ) 
  and c.account_owner = 1 
  LEFT JOIN user_accounts ua on ua.account_id = a.account_id 
  and ua.role_id in (
    " . $ROLE[$DEPARTMENT[" implementation "]][" rvp "] . "
  ) 
  and ua.account_owner = 1 
  LEFT JOIN users u on u.user_id = au.user_id 
  LEFT JOIN users rvp on rvp.user_id = ua.user_id 
  and u.status = 0 
  LEFT JOIN academic_years ay on ay.academic_year_id = ip.academic_year_id 
WHERE 
  a.customer_status = 'Current Customer' $filter_string 
GROUP BY 
  a.account_id, 
  IFNULL(g.reporting_group_id, 0) 
ORDER BY 
  a.account_name</td><td></td><td></td></tr>
   <tr><td>reports/opportunities/top_20_index.php:268</td><td>CREATE TABLE $history_log_table 
SELECT 
  * 
FROM 
  history_log 
WHERE 
  table_name = 'opportunities'</td><td></td><td></td></tr>
   <tr><td>reports/opportunities/top_20_index.php:278</td><td>CREATE TEMPORARY TABLE $table_name 
SELECT 
  DISTINCT p.opportunity_id, 
  p.opportunity_name, 
  a.state_code, 
  r.region_name, 
  p.close_date, 
  s.probability_percent, 
  p.total, 
  p.date_entered, 
  max(hl.date_entered) last_updated, 
  max(hlp.date_entered) probability_last_updated, 
  substr(u.first_name, 1, 1) rep_first_name, 
  u.last_name rep_last_name, 
  left(p.notes, 200) notes, 
  max(q.quote_id) quote_id 
FROM 
  (
    opportunities p, accounts a, user_orders o, 
    users u, opportunity_probabilities s, 
    region_states rs, regions r
  ) 
  LEFT JOIN quotes q ON (
    p.opportunity_id = q.opportunity_id
  ) 
  LEFT JOIN $history_log_table hl ON (p.opportunity_id = hl.record_id) 
  LEFT JOIN $history_log_table hlp ON (
    p.opportunity_id = hlp.record_id 
    AND hlp.column_name = 'probability_id'
  ) 
WHERE 
  p.account_id = a.account_id 
  AND p.opportunity_id = o.opportunity_id 
  AND o.role_id = '".$ROLE[$DEPARTMENT["sales"]]["sales_rep"]."' 
  AND o.user_id = u.user_id 
  AND p.probability_id = s.probability_id 
  AND rs.state_code = a.state_code 
  AND rs.region_id = r.region_id 
  AND r.department_id = ".$DEPARTMENT[" sales "]." $whereStr 
  AND p.top_20 = 1 
GROUP BY 
  p.opportunity_id, 
  region_name</td><td></td><td>skip</td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_2018.php:121</td><td>CREATE $temporary TABLE interlink.temp_renew_qcpr_user_data_source (
  PRIMARY KEY(renewal_user_id), 
  KEY(il_user_id), 
  INDEX(nvp_id), 
  INDEX(vp_id), 
  INDEX(rvp_id)
) 
SELECT 
  
  /*Manager/User Group Data*/
  CAST(
    COALESCE(
      NULLIF(u.nvp_id, ''), 
      1
    ) as CHAR(8)
  ) nvp_id, 
  COALESCE(
    NULLIF(u.nvp, ''), 
    'No NVP'
  ) nvp, 
  COALESCE(
    NULLIF(u.nvp_area_sort, ''), 
    1
  ) nvp_area_sort, 
  CAST(
    COALESCE(
      NULLIF(u.vp_id, ''), 
      1
    ) as CHAR(8)
  ) vp_id, 
  COALESCE(
    NULLIF(u.vp, ''), 
    'No VP'
  ) vp, 
  COALESCE(
    NULLIF(u.vp_area_sort, ''), 
    1
  ) vp_area_sort, 
  CAST(
    COALESCE(
      NULLIF(u.rvp_id, ''), 
      1
    ) as CHAR(8)
  ) rvp_id, 
  COALESCE(
    NULLIF(u.rvp, ''), 
    'No RVP'
  ) rvp, 
  COALESCE(
    NULLIF(u.rvp_area_sort, ''), 
    1
  ) rvp_area_sort, 
  a.area_id, 
  u.`area`, 
  u.user_id il_user_id, 
  u.comp_plan_id, 
  u.comp_plan_id renewal_user_id, 
  u.user_f_last renewal_user, 
  u.last_name, 
  u.status user_status, 
  u.renewal_qcpr_status, 
  cp.termination_date termination_date, 
  CASE WHEN u.area_comp_plan_type IN ('nvp', 'vp', 'rvp', 'dm', 'a3k') THEN u.area_comp_plan_type ELSE 'renewal_user' END comp_plan_type 
FROM 
  commissions.users_cp u 
  LEFT JOIN commissions.compensation_plans cp ON cp.comp_plan_id = u.comp_plan_id 
  AND cp.cmonth = '$report_month_filter' 
  and cp.year = $year 
  LEFT JOIN commissions.areas a on a.area_id = cp.area_id 
  LEFT JOIN commissions.qcpr_manager_permissions m ON m.manager_id = '$curr_user_id' 
  AND m.user_id = u.user_id 
  AND m.cmonth = '$report_month_filter' 
WHERE 
  1 
  AND u.year = $year 
  AND u.cmonth = '$report_month_filter' 
  and u.renewal_qcpr_status = 0 #Has current year order/QC/credit OR non-terminated rep with quota
  $user_where 
GROUP BY 
  u.sales_user_id, 
  u.comp_plan_id;</td><td></td><td></td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_2018.php:167</td><td>CREATE $temporary TABLE interlink.temp_renew_qcpr_user_data_source_copy (
  PRIMARY KEY(renewal_user_id)
) 
SELECT 
  * 
FROM 
  interlink.temp_renew_qcpr_user_data_source</td><td></td><td></td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_2018.php:180</td><td>CREATE $temporary TABLE tmp_account_trainers (
  PRIMARY KEY (account_id), 
  trainer_user_name VARCHAR(250), 
  imp_rvp_user_name VARCHAR(250)
) 
SELECT 
  uad.account_id, 
  SUBSTRING_INDEX(
    MIN(
      CONCAT(
        CASE WHEN uad.role_id IN (4, 5) THEN uad.role_id ELSE NULL END, 
        '|', 
        uad.user_id
      )
    ), 
    '|', 
    -1
  ) trainer_user_id, 
  '' trainer_user_name, 
  MAX(
    CASE WHEN uad.role_id = 7 THEN uad.user_id ELSE NULL END
  ) imp_rvp_user_id, 
  '' imp_rvp_user_name 
FROM 
  interlink.user_account_dates uad 
  INNER JOIN commissions.renewal_report_base rb ON rb.account_id = uad.account_id 
  AND rb.cmonth = '$report_month_filter' 
  AND rb.rank = 1 
  INNER JOIN commissions.users u ON u.user_id = uad.user_id 
WHERE 
  @month_end BETWEEN uad.start_date 
  AND uad.end_date 
  AND uad.account_owner = 1 
  AND uad.role_id IN (7, 4, 5) 
GROUP BY 
  uad.account_id;</td><td></td><td></td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_2018.php:211</td><td>CREATE $temporary TABLE tmp_account_districts (
  PRIMARY KEY (account_id)
) 
SELECT 
  a.account_id, 
  a.account_name, 
  a.state_code, 
  a.account_level, 
  COALESCE(
    d1.account_id, CASE WHEN a.account_level = 1 THEN a.account_id ELSE -1 END
  ) district_account_id, 
  COALESCE(
    d1.account_name, CASE WHEN a.account_level = 1 THEN a.account_name ELSE '-- No District --' END
  ) district_account_name, 
  COALESCE(d1.state_code, a.state_code) district_state_code, 
  CASE WHEN d1.account_id 
  OR a.account_level = 1 THEN 1 ELSE 0 END has_district, 
  tat.trainer_user_name account_trainer, 
  tat.imp_rvp_user_name account_imp_rvp 
FROM 
  interlink.accounts a 
  INNER JOIN commissions.renewal_report_base rb ON rb.account_id = a.account_id 
  LEFT JOIN interlink.accounts d1 ON d1.account_id = a.parent_account_id 
  AND d1.account_level = 1 
  AND a.account_level = 2 
  LEFT JOIN tmp_account_trainers tat ON tat.account_id = a.account_id 
WHERE 
  rb.cmonth = '$report_month_filter' 
  AND rb.rank = 1 
GROUP BY 
  a.account_id;</td><td></td><td></td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_2018.php:235</td><td>CREATE $temporary TABLE tmp_account_renewal_quotas(
  PRIMARY KEY(
    account_id, user_id, base_user_id, 
    program_id
  )
) 
SELECT 
  account_id, 
  user_id, 
  base_user_id, 
  program_id, 
  renewal_quota 
FROM 
  commissions.renewal_order_users 
WHERE 
  cmonth = '$report_month_filter' 
  AND rank = 1 
GROUP BY 
  account_id, 
  user_id, 
  base_user_id, 
  program_id</td><td></td><td></td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_2018.php:252</td><td>CREATE $temporary TABLE interlink.temp_renew_qcpr_qc_data_source (
  row_id INT UNSIGNED not null auto_increment PRIMARY KEY, 
  INDEX(renewal_user_id)
) 
SELECT 
  
  /*******USER INFO*******/
  cp.user_id, 
  cp.comp_plan_id renewal_user_id, 
  base.orig_user_id, 
  base.is_primary_user, 
  
  /*******ACCOUNT PROGRAM INFO*******/
  tad.account_level, 
  tad.district_account_id district_account_id, 
  tad.district_account_name district_account, 
  tad.district_state_code district_state, 
  tad.district_state_code district_state_id, 
  tad.has_district, 
  tad.account_id, 
  tad.account_name account_name, 
  tad.state_code state_id, 
  tad.state_code state, 
  CASE WHEN tad.account_level = 1 THEN 'z' WHEN base.on_target = 1 
  AND base.user_quota_include = 1 THEN 'y' ELSE 'n' END on_target_id, 
  CASE WHEN tad.account_level = 1 THEN 'District' WHEN base.on_target = 1 
  AND base.user_quota_include = 1 THEN 'Within Quota' ELSE 'Not Within Quota' END on_target, 
  CASE WHEN base.on_target = 1 
  AND base.user_quota_include = 1 THEN 1 ELSE 0 END orig_on_target, 
  base.purchaser_level purchaser_level_id, 
  CASE WHEN base.purchaser_level = 1 THEN 'District Purchase' ELSE 'School Purchase' END purchaser_level, 
  base.program_id, 
  op.opportunity_product_name program, 
  
  /*******EXPIRING ACCOUNT*******/
  CONCAT(
    tad.account_id, 'p', base.program_id, 
    'o', base.order_id
  ) expiring_account_id, 
  tad.account_name expiring_account, 
  CASE WHEN base.on_target = 1 
  AND base.user_quota_include = 1 
  AND tad.account_level = 2 THEN 1 ELSE 0 END orig_expiring_school_count, 
  CASE WHEN base.on_target = 1 
  AND base.user_quota_include = 1 
  AND base.school_rank = 1 
  AND tad.account_level = 2 THEN 1 ELSE 0 END expiring_school_count, 
  0 expiring_license_count, 
  rb.renewal_quota_updated orig_expiring_order_account_value, 
  (base.renewal_quota_updated) expiring_order_account_value, 
  base.non_quota_account, 
  district_re_allocated, 
  
  /*******NEW ORDER*******/
  base.rank, 
  base.school_rank, 
  base.order_id booked_order_id, 
  base.order_id booked_order, 
  co.cancel, 
  IFNULL(base.orig_school_count, 0) orig_booked_school_count, 
  IFNULL(base.school_count, 0) booked_school_count, 
  IFNULL(
    base.school_count / LEAST(
      base.user_quota_include, base.on_target
    ), 
    0
  ) booked_school_percent, 
  CASE WHEN rqt.booked_target_year = 0 THEN single_year_value ELSE base.all_yr_value END booked_order_account_value, 
  
  /******QC******/
  qc_total, 
  IFNULL(
    base.qc_total / rq.renewal_quota, 
    0
  ) qc_percent, 
  upsell_qc_total, 
  qc_total + upsell_qc_total acv_upsell_qc_total, 
  IFNULL(
    (qc_total + upsell_qc_total)/ rq.renewal_quota, 
    0
  ) acv_upsell_qc_percent, 
  
  /******ACV******/
  base.single_year_value, 
  acv_total acv_total, 
  IFNULL(
    base.acv_total / rq.renewal_quota, 
    0
  ) acv_percent, 
  
  /******Target Expansion******/
  target_more_years + more_products_more_years target_more_years, 
  (
    single_year_value + more_products_yr_1
  )-(
    single_year_acv + more_products_acv
  ) target_school_upsell, 
  GREATEST(
    more_schools_yr_1 - more_schools_acv, 
    0
  )+ more_schools_more_years more_schools_all_yr, 
  (
    single_year_value + more_products_yr_1 + more_schools_yr_1 + target_more_years + more_products_more_years + more_schools_more_years
  ) - (acv_total) total_expansion, 
  expansion_qc_total expansion_qc, 
  
  /*******ACCOUNT LEVEL ADDTL INFO*******/
  aps.year_value booked_account_value, 
  aps.percent_target percent_account_target, 
  CASE WHEN base.on_target = 1 
  AND base.user_quota_include = 1 THEN aps.expiring_orders ELSE '' END expiring_orders, 
  tad.account_trainer, 
  tad.account_imp_rvp 
FROM 
  commissions.renewal_order_users base 
  INNER JOIN interlink.accounts a ON a.account_id = base.account_id 
  INNER JOIN commissions.renewal_report_base rb ON rb.cmonth = '$report_month_filter' 
  AND rb.account_id = base.account_id 
  AND rb.order_id = base.order_id 
  AND rb.user_id = base.user_id 
  AND rb.program_id = base.program_id 
  LEFT JOIN commissions.orders co ON co.order_id = base.order_id 
  AND co.cmonth = '$report_month_filter' 
  LEFT JOIN interlink.opportunity_products op ON op.opportunity_product_id = base.program_id 
  LEFT JOIN tmp_account_districts tad ON tad.account_id = base.account_id 
  LEFT JOIN commissions.users_cp cp ON cp.user_id = base.user_id 
  AND cp.cmonth = '$report_month_filter' 
  AND cp.year = $year 
  LEFT JOIN commissions.renewal_quota_types rqt ON rqt.renewal_user_id = base.base_user_id 
  LEFT JOIN commissions.renewal_account_program_summary aps ON aps.account_id = base.account_id 
  and aps.program_id = base.program_id 
  AND aps.cmonth = '$report_month_filter' 
  AND CASE WHEN rqt.renewal_user_id THEN aps.renewal_type_id = rqt.renewal_type_id ELSE aps.renewal_type_id = 1 END 
  LEFT JOIN tmp_account_renewal_quotas rq ON base.account_id = rq.account_id 
  AND base.user_id = rq.user_id 
  AND base.base_user_id = rq.base_user_id 
  AND base.program_id = rq.program_id 
WHERE 
  base.cmonth = '$report_month_filter' 
  AND base.user_id = base.base_user_id #TESTING
  #LIMIT 100
  ;</td><td></td><td></td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_2018.php:348</td><td>CREATE $temporary TABLE interlink.temp_renew_qcpr_qc_data_source_copy (
  row_id INT UNSIGNED not null auto_increment PRIMARY KEY, 
  INDEX(renewal_user_id)
) 
SELECT 
  * 
FROM 
  interlink.temp_renew_qcpr_qc_data_source</td><td></td><td></td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_2018.php:568</td><td>CREATE $temporary TABLE tmp_account_sales_rep (
  PRIMARY KEY (account_id)
) 
SELECT 
  a.account_id, 
  ua.user_id, 
  CONCAT(u.first_name, ' ', u.last_name) account_sales_rep, 
  an.area_name 
FROM 
  interlink.accounts a 
  INNER JOIN interlink.user_account_dates ua ON ua.account_id = a.account_id 
  AND ua.role_id = 6 
  AND ua.account_owner = 1 
  AND '$cmonth_end' BETWEEN ua.start_date 
  AND ua.end_date 
  INNER JOIN commissions.renewal_report_base rb ON rb.account_id = a.account_id 
  AND rb.cmonth = '$report_month_filter' 
  INNER JOIN commissions.users u ON u.user_id = ua.user_id 
  LEFT JOIN commissions.area_users au ON au.user_id = ua.user_id 
  AND '$cmonth_end' BETWEEN au.start_date 
  AND au.end_date 
  LEFT JOIN commissions.areas an ON an.area_id = au.area_id 
GROUP BY 
  a.account_id;</td><td></td><td></td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_2018.php:588</td><td>CREATE $temporary TABLE tmp_renewal_export_table (
  KEY(
    user, `account id`, `booked order`
  )
) 
SELECT 
  rou.last_name `User`, 
  u.last_name `Renewal Rep User`, 
  qc.district_account_id `District ID`, 
  qc.district_account `District`, 
  qc.district_state `District State`, 
  qc.account_id `Account ID`, 
  qc.account_name `Account`, 
  COALESCE(
    tier.tier_name, d_tier.tier_name, 
    ''
  ) `Account Tier Jan $year`, 
  qc.state `State`, 
  CASE WHEN qc.account_level = 1 THEN 'District' WHEN qc.account_level = 2 THEN 'School' ELSE '' END `Account Type`, 
  qc.program `Program`, 
  qc.purchaser_level `Purchaser Level`, 
  # qc.orig_expiring_order_account_value  `Expiring Renewal Quota`,
  CASE WHEN $distinct_expiring_filter THEN rou.renewal_quota_updated ELSE '' END `Expiring Renewal Quota`, 
  qc.expiring_orders `Expiring Orders`, 
  CASE WHEN $distinct_expiring_filter THEN qc.orig_expiring_school_count ELSE '' END `Expiring # Schools`, 
  CASE WHEN $distinct_expiring_filter THEN qc.orig_booked_school_count ELSE '' END `Booked # Schools`, 
  
  /*school count can be overridden to 1 even if not on target*/
  CASE WHEN (
    qc.orig_on_target = 0 
    AND qc.booked_school_count = 0
  ) THEN '' WHEN (
    (
      rou.user_id = rou.base_user_id 
      AND qcu.comp_plan_type = 'renewal_user'
    ) 
    OR rou.is_primary_user = 1
  ) 
  AND rou.user_quota_include = 1 THEN qc.rank ELSE 
  /*non primary rank*/
  '1+' END `Order Count (Target Acct)`, 
  CASE WHEN rou.on_target = 1 
  AND rou.user_quota_include = 1 
  AND rou.school_rank = 1 
  AND a.account_level = 2 
  AND (
    (
      rou.user_id = rou.base_user_id 
      AND qcu.comp_plan_type = 'renewal_user'
    ) 
    OR rou.is_primary_school_rank = 1
  ) 
  AND rou.user_quota_include = 1 THEN 1 ELSE '' END `School Count (Target Acct)`, 
  rou.single_year_acv `Target ACV`, 
  rou.more_products_acv `More Products ACV`, 
  rou.more_schools_acv `More Schools ACV`, 
  qc.acv_total `ACV Total`, 
  CASE WHEN (
    rou.user_id = rou.base_user_id 
    AND qcu.comp_plan_type = 'renewal_user'
  ) 
  OR rou.is_primary_user = 1 THEN qc.acv_percent ELSE 0 END `ACV Total %`, 
  qc.qc_total `QC Total`, 
  qc.qc_percent `QC %`, 
  rou.single_year_value - rou.single_year_acv `Target Acct Upsell  $year - $year_to`, 
  rou.more_products_yr_1 - rou.more_products_acv `More Products Upsell  $year - $year_to Year`, 
  rou.target_more_years `Target Acct Addt'l Years`, 
  rou.more_products_more_years `More Products Addt'l Years`, 
  rou.more_schools_yr_1 - rou.more_schools_acv `More Schools  $year - $year_to Year`, 
  rou.more_schools_more_years `More Schools Addt'l Years`, 
  ".($year >= 2019 ?
                    " rou.upsell_qc_total `Target School Upsell QC`, 
  rou.qc_total + rou.upsell_qc_total `ACV + Upsell QC`, 
  qc.acv_upsell_qc_percent `ACV + Upsell QC %`, 
  "
                :
                    " rou.expansion_qc_total `Expansion QC Total`, 
  "
            )." qc.booked_order_account_value `Booked Order Account Total`, 
  qc.booked_order_id `Booked Order`, 
  qc.on_target `Quota Bucket`, 
  o.order_date `Order Date`, 
  o.start_date `Start Date`, 
  o.end_date `End Date`, 
  ". ( $year >= 2019 ? " CASE WHEN o.increase_due_to_overage = 1 THEN 1 ELSE '' END `Increase due to Overage`, 
  " : "" ) ." CASE WHEN o.Cancel = 'Y' THEN 1 ELSE '' END `Is Cancelled`, 
  o.order_total `Order Total`, 
  oi.credit_revenue_total + oi.bad_debt_total `Credits (Cancels/Bad Debt)`, 
  o.sales_rep `Opportunity Owner`, 
  oi.order_renewal_rep `Renewal Rep`, 
  COALESCE(
    NULLIF(oi.order_field_rep, ''), 
    asr.account_sales_rep
  ) `Field Rep`, 
  COALESCE(
    NULLIF(
      oi.order_field_region, 'National Renewal Region'
    ), 
    asr.area_name, 
    ''
  ) `Region`, 
  qc.account_trainer `Account Trainer`, 
  qc.account_imp_rvp `Account Imp. RVP`, 
  rou.po_total `PO Total`, 
  rou.year_po_total `$year - $year_to PO Total` "
            .($corporate_report?
            ", 
  CASE WHEN l.is_domestic = 1 
  OR l.location_code IS NULL THEN 0 ELSE 1 END international -- EXPIRING
  , 
  CASE WHEN $distinct_expiring_filter THEN rxb.literacy ELSE '' END `Expiring Literacy`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.levelset ELSE '' END `Expiring Levelset`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.bae ELSE '' END `Expiring BAE`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.smarty_ants ELSE '' END `Expiring Smarty Ants`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.actively_learn ELSE '' END `Expiring Actively Learn`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.nls_conf ELSE '' END `Expiring NLS Conf`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.nls_pre_conf ELSE '' END `Expiring NLS Pre-Conf`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.literacy_misc ELSE '' END `Expiring Literacy Misc`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.smarty_ants_misc ELSE '' END `Expiring Smarty Ants Misc`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.actively_learn_misc ELSE '' END `Expiring Actively Learn Misc`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.science ELSE '' END `Expiring Science`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.onsite_pd + rxb.imf ELSE '' END `Expiring Onsite PD`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.online_pd ELSE '' END `Expiring Online PD`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.pm ELSE '' END `Expiring PM`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.literacy_summer ELSE '' END `Expiring Literacy Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.levelset_summer ELSE '' END `Expiring Levelset Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.bae_summer ELSE '' END `Expiring BAE Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.smarty_ants_summer ELSE '' END `Expiring Smarty Ants Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.actively_learn_summer ELSE '' END `Expiring Actively Learn Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.literacy_misc_summer ELSE '' END `Expiring Literacy Misc Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.smarty_ants_misc_summer ELSE '' END `Expiring Smarty Ants Misc Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.actively_learn_misc_summer ELSE '' END `Expiring Actively Learn Misc Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.science_summer ELSE '' END `Expiring Science Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.onsite_pd_summer + rxb.imf_summer ELSE '' END `Expiring Onsite PD Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.online_pd_summer ELSE '' END `Expiring Online PD Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.pm_summer ELSE '' END `Expiring PM Summer`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.literacy_count ELSE '' END `Expiring Literacy License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.levelset_count ELSE '' END `Expiring Levelset License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.bae_count ELSE '' END `Expiring BAE License Count`, 
  CASE WHEN $distinct_expiring_filter THEN CASE WHEN rxb.smarty_ants_count = 'UNLIMITED' THEN $SA_Unlimited_License_Count ELSE rxb.smarty_ants_count END ELSE '' END `Expiring Smarty Ants License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.actively_learn_count ELSE '' END `Expiring Actively Learn License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.nls_conf_count ELSE '' END `Expiring NLS Conf Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.nls_pre_conf_count ELSE '' END `Expiring NLS Pre-Conf Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.literacy_misc_count ELSE '' END `Expiring Literacy Misc Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.smarty_ants_misc_count ELSE '' END `Expiring Smarty Ants Misc Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.actively_learn_misc_count ELSE '' END `Expiring Actively Learn Misc Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.science_count ELSE '' END `Expiring Science License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.onsite_pd_count ELSE '' END `Expiring Onsite PD Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.online_pd_count ELSE '' END `Expiring Online PD Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.pm_count ELSE '' END `Expiring PM Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.literacy_summer_count ELSE '' END `Expiring Literacy Summer License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.levelset_summer_count ELSE '' END `Expiring Levelset Summer License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.bae_summer_count ELSE '' END `Expiring BAE Summer License Count`, 
  CASE WHEN $distinct_expiring_filter THEN CASE WHEN rxb.smarty_ants_summer_count = 'UNLIMITED' THEN $SA_Unlimited_License_Count ELSE rxb.smarty_ants_summer_count END ELSE '' END `Expiring Smarty Ants Summer License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.actively_learn_summer_count ELSE '' END `Expiring Actively Learn Summer License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.literacy_misc_summer_count ELSE '' END `Expiring Literacy Misc Summer License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.smarty_ants_misc_summer_count ELSE '' END `Expiring Smarty Ants Misc Summer License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.actively_learn_misc_summer_count ELSE '' END `Expiring Actively Learn Misc Summer License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.science_summer_count ELSE '' END `Expiring Science Summer License Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.onsite_pd_summer_count ELSE '' END `Expiring Onsite PD Summer Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.online_pd_summer_count ELSE '' END `Expiring Online PD Summer Count`, 
  CASE WHEN $distinct_expiring_filter THEN rxb.pm_summer_count ELSE '' END `Expiring PM Summer Count` -- BOOKED
  , 
  rbb.literacy `Literacy`, 
  rbb.levelset `Levelset`, 
  rbb.bae `BAE`, 
  rbb.smarty_ants `Smarty Ants`, 
  rbb.actively_learn `Actively Learn`, 
  rbb.nls_conf `NLS Conf`, 
  rbb.nls_pre_conf `NLS Pre-Conf`, 
  rbb.literacy_misc `Literacy Misc`, 
  rbb.smarty_ants_misc `Smarty Ants Misc`, 
  rbb.actively_learn_misc `Actively Learn Misc`, 
  rbb.science `Science`, 
  rbb.onsite_pd + rbb.imf `Onsite PD`, 
  rbb.online_pd `Online PD`, 
  rbb.pm `PM`, 
  rbb.literacy_summer `Literacy Summer`, 
  rbb.levelset_summer `Levelset Summer`, 
  rbb.bae_summer `BAE Summer`, 
  rbb.smarty_ants_summer `Smarty Ants Summer`, 
  rbb.actively_learn_summer `Actively Learn Summer`, 
  rbb.literacy_misc_summer `Literacy Misc Summer`, 
  rbb.smarty_ants_misc_summer `Smarty Ants Misc Summer`, 
  rbb.actively_learn_misc_summer `Actively Learn Misc Summer`, 
  rbb.science_summer `Science Summer`, 
  rbb.onsite_pd_summer + rbb.imf_summer `Onsite PD Summer`, 
  rbb.online_pd_summer `Online PD Summer`, 
  rbb.pm_summer `PM Summer`, 
  rbb.literacy_count `Literacy License Count`, 
  rbb.levelset_count `Levelset License Count`, 
  rbb.bae_count `BAE License Count`, 
  CASE WHEN rbb.smarty_ants_count = 'UNLIMITED' THEN $SA_Unlimited_License_Count ELSE rbb.smarty_ants_count END `Smarty Ants License Count`, 
  rbb.actively_learn_count `Actively Learn License Count`, 
  rbb.nls_conf_count `NLS Conf Count`, 
  rbb.nls_pre_conf_count `NLS Pre-Conf Count`, 
  rbb.literacy_misc_count `Literacy Misc Count`, 
  rbb.smarty_ants_misc_count `Smarty Ants Misc Count`, 
  rbb.actively_learn_misc_count `Actively Learn Misc Count`, 
  rbb.science_count `Science License Count`, 
  rbb.onsite_pd_count `Onsite PD Count`, 
  rbb.online_pd_count `Online PD Count`, 
  rbb.pm_count `PM Count`, 
  rbb.literacy_summer_count `Literacy Summer License Count`, 
  rbb.levelset_summer_count `Levelset Summer License Count`, 
  rbb.bae_summer_count `BAE Summer License Count`, 
  CASE WHEN rbb.smarty_ants_summer_count = 'UNLIMITED' THEN $SA_Unlimited_License_Count ELSE rbb.smarty_ants_summer_count END `Smarty Ants Summer License Count`, 
  rbb.actively_learn_summer_count `Actively Learn Summer License Count`, 
  rbb.literacy_misc_summer_count `Literacy Misc Summer Count`, 
  rbb.smarty_ants_misc_summer_count `Smarty Ants Misc Summer Count`, 
  rbb.actively_learn_misc_summer_count ` Actively Learn Misc Summer Count`, 
  rbb.science_summer_count `Science Summer License Count`, 
  rbb.onsite_pd_summer_count `Onsite PD Summer Count`, 
  rbb.online_pd_summer_count `Online PD Summer Count`, 
  rbb.pm_summer_count `PM Summer Count` "
            : "")
            ." 
FROM 
  commissions.renewal_order_users rou 
  INNER JOIN interlink.accounts a ON a.account_id = rou.account_id 
  LEFT JOIN commissions.account_tiers tier ON a.account_id = tier.account_id 
  AND tier.cmonth = CONCAT('$year-01-01') 
  LEFT JOIN commissions.account_tiers d_tier ON a.parent_account_id = d_tier.account_id 
  AND a.account_level = 2 
  AND d_tier.cmonth = CONCAT('$year-01-01') 
  LEFT JOIN interlink.temp_renew_qcpr_qc_data_source qc ON rou.order_id = qc.booked_order_id 
  AND rou.account_id = qc.account_id 
  AND rou.program_id = qc.program_id 
  AND rou.base_user_id = qc.user_id 
  INNER JOIN commissions.users u ON rou.base_user_id = u.user_id 
  INNER JOIN interlink.temp_renew_qcpr_user_data_source qcu ON rou.user_id = qcu.il_user_id 
  LEFT JOIN commissions.orders o ON o.order_id = rou.order_id 
  AND o.cmonth = '$report_month_filter' 
  LEFT JOIN commissions.order_info oi ON oi.order_id = rou.order_id 
  AND oi.cmonth = '$report_month_filter' 
  LEFT JOIN interlink.tmp_account_sales_rep asr ON asr.account_id = rou.account_id 
  LEFT JOIN interlink.locations l ON a.state_code = l.location_code 
  AND l.location_type = 's' ".($corporate_report?
            " 
  LEFT JOIN commissions.renewal_user_order_booked_buckets rbb ON rbb.order_id = rou.order_id 
  AND rbb.account_id = rou.account_id 
  AND rbb.user_id = rou.user_id 
  AND rbb.program_id = rou.program_id 
  AND rbb.base_user_id = rou.base_user_id 
  AND rbb.ay_bucket_id = 1 
  AND rbb.cmonth = rou.cmonth 
  LEFT JOIN commissions.renewal_user_account_expiring_buckets rxb ON rxb.account_id = rou.account_id 
  AND rxb.user_id = rou.user_id 
  AND rxb.program_id = rou.program_id 
  AND rxb.base_user_id = rou.base_user_id 
  AND rxb.cmonth = rou.cmonth ": " ").
            " 
WHERE 
  rou.cmonth = '$report_month_filter' 
ORDER BY 
  u.last_name, 
  qc.district_state_id, 
  qc.has_district DESC, 
  qc.district_account, 
  qc.on_target_id DESC, 
  qc.account_name, 
  qc.program_id, 
  qc.rank, 
  qc.booked_order_id</td><td></td><td></td></tr>
   <tr><td>reports/sales/purchase_order_status_index.php:106</td><td>CREATE TEMPORARY TABLE user_sales_department(
  PRIMARY KEY(user_id)
) 
SELECT 
  u.user_id, 
  CASE WHEN a.area_name LIKE '%inside%' THEN 'Inside' WHEN a.area_name LIKE '%strategic%' THEN 'Strategic' WHEN a.area_name LIKE '%international%' THEN 'International' WHEN a.area_name LIKE '%renew%' THEN 'Renewal' ELSE 'Field' END rep_type 
FROM 
  commissions.users u 
  JOIN commissions.area_users au ON au.user_id = u.user_id 
  JOIN commissions.areas a ON a.area_id = au.area_id 
WHERE 
  IF(
    cp_termination_date, 
    DATE(cp_termination_date), 
    CURDATE()
  ) BETWEEN au.start_date 
  AND au.end_date 
GROUP BY 
  u.user_id</td><td></td><td>skip</td></tr>
   <tr><td>util/classes/Advanced_Search.php:751</td><td>CREATE TEMPORARY TABLE renewal_orders 
SELECT 
  od.*, 
  p.summer_type_id 
FROM 
  order_details od, 
  orders o, 
  products p 
WHERE 
  p.product_id = od.product_id 
  AND od.start_date > '".date(Y)."-05-01' 
  AND p.summer_type_id = 0 
  AND od.status = 0 
  AND o.order_id = od.order_id 
  AND o.status = 0</td><td></td><td>skip</td></tr>
   <tr><td>util/classes/Advanced_Search.php:783</td><td>CREATE TEMPORARY TABLE summer_orders 
SELECT 
  od.* 
FROM 
  order_details od, 
  orders o, 
  products p 
WHERE 
  p.product_id = od.product_id 
  AND od.start_date > '".date(Y)."-05-01' 
  AND od.end_date < '" . date(Y) . "-12-31' 
  AND p.summer_type_id > 0 
  AND od.status = 0 
  AND o.order_id = od.order_id 
  AND o.status = 0</td><td></td><td>skip</td></tr>
   <tr><td>util/classes/Advanced_Search.php:1065</td><td>CREATE TEMPORARY TABLE opp_contacts 
SELECT 
  q.opportunity_id, 
  c.contact_id 
FROM 
  (
    quotes q, quote_details qd, contacts c
  ) 
  LEFT JOIN order_contacts oc ON (
    q.opportunity_id = oc.opportunity_id 
    AND oc.contact_type_id = '" . $CONTACT_TYPES["buyer"] . "' 
    AND c.contact_id = oc.contact_id
  ) 
WHERE 
  q.quote_id = qd.quote_id 
  AND q.final = 1 
  AND qd.account_id = c.account_id 
  AND q.opportunity_id " . $this->format_operator_and_value($operator, $value) . " 
  AND oc.opportunity_id IS NULL</td><td></td><td>skip</td></tr>
   <tr><td>util/classes/Advanced_Search.php:1080</td><td>CREATE TEMPORARY TABLE opp_contacts 
SELECT 
  oc.opportunity_id, 
  oc.contact_id 
FROM 
  order_contacts oc 
WHERE 
  oc.contact_type_id = '" . $CONTACT_TYPES["buyer"] . "' 
  AND oc.opportunity_id " . $this->format_operator_and_value($operator, $value)</td><td></td><td>skip</td></tr>
   <tr><td>util/db/pd_queries.php:124</td><td>CREATE TABLE $tmp_pd 
select 
  od.order_id, 
  od.order_detail_id, 
  a.account_id, 
  a.account_name, 
  a.state_code, 
  if (
    sp.sub_product_type_id in (4, 5), 
    'N', 
    'Y'
  ) online, 
  sum(od.quantity * sp.sub_product_qty) pd_purchased 
FROM 
  orders o, 
  order_details od, 
  sub_products sp, 
  accounts a 
where 
  a.account_id = od.account_id 
  and od.product_id = sp.product_id 
  and od.academic_year_id IN (
    " . implode(", ", $academic_years) . "
  ) 
  AND sp.sub_product_type_id in (
    " . implode(", ", $pd_sub_product_types) . "
  ) 
  AND o.order_id = od.order_iD 
  and o.status = 0 
  AND od.status = 0 
GROUP BY 
  od.order_detail_id, 
  online</td><td></td><td></td></tr>
   <tr><td>util/db/pd_queries.php:159</td><td>CREATE TEMPORARY TABLE tmp_events 
SELECT 
  e.order_id, 
  e.order_detail_id, 
  e.online, 
  SUM(
    IF(
      e.shared_day = 1, 
      if(
        e.shared_event_id = 0 
        and s.event_id IS NULL 
        AND e.event_date <= CURDATE() 
        AND e.pd_type_id = 1, 
        1, 
        .5
      ), 
      1
    )
  ) num_events 
FROM 
  (
    events e, event_users eu, order_details od, 
    orders o
  ) 
  LEFT JOIN events s ON (
    e.event_id = s.shared_event_id 
    and s.status = 0 
    AND s.event_type_id = 1
  ) 
WHERE 
  od.order_detail_id = e.order_detail_id 
  AND od.status = 0 
  AND o.order_id = od.order_id 
  AND o.status = 0 
  AND (
    e.order_detail_id IN (
      SELECT 
        DISTINCT order_detail_id 
      FROM 
        $tmp_pd
    ) 
    OR od.academic_year_id IN (
      " . implode(", ", $academic_years) . "
    )
  ) 
  AND e.status = 0 
  AND e.event_id = eu.event_id 
  AND e.event_type_id = 1 
GROUP BY 
  e.order_detail_id, 
  e.online</td><td></td><td>skip</td></tr>
   <tr><td>util/db/pd_queries.php:179</td><td>CREATE TEMPORARY TABLE tmp_expired 
SELECT 
  cd.order_id, 
  cd.order_detail_id, 
  if (
    cd.sub_product_type_id in (4, 5), 
    'N', 
    'Y'
  ) online, 
  sum(
    cd.closed_amount - cd.we_care_amount
  ) total_expired 
FROM 
  closed_deliverables cd, 
  order_details od, 
  orders o 
WHERE 
  od.order_detail_id = cd.order_detail_id 
  AND od.status = 0 
  AND o.order_id = od.order_id 
  AND o.status = 0 
  AND (
    cd.order_detail_id IN (
      SELECT 
        DISTINCT order_detail_id 
      FROM 
        $tmp_pd
    ) 
    OR od.academic_year_id IN (
      " . implode(", ", $academic_years) . "
    )
  ) 
GROUP BY 
  order_detail_id, 
  online 
HAVING 
  total_expired > 0</td><td></td><td>skip</td></tr>
   <tr><td>util/db/pd_queries.php:405</td><td>CREATE TEMPORARY TABLE tmp_reallocations 
SELECT 
  group_concat(distinct ore.reallocation_id) reallocation_id, 
  od.order_detail_id, 
  ore.new_account_id account_id, 
  ore.new_academic_year_id academic_year_id, 
  ore.online, 
  sum(ore.quantity) quantity 
FROM 
  order_reallocations ore, 
  order_details od 
WHERE 
  od.order_detail_id = ore.old_order_detail_id 
  AND (
    od.academic_year_id IN (
      " . implode(", ", $academic_years) . "
    ) 
    OR ore.new_academic_year_id IN (
      " . implode(", ", $academic_years) . "
    )
  ) 
GROUP BY 
  od.order_detail_id, 
  ore.new_account_id, 
  ore.new_academic_year_id, 
  ore.online</td><td></td><td>skip</td></tr>
   <tr><td>util/db/pd_queries.php:685</td><td>CREATE TEMPORARY TABLE tmp_expired 
SELECT 
  od.order_id, 
  cd.order_detail_id, 
  if (
    cd.sub_product_type_id in (4, 5), 
    'N', 
    'Y'
  ) online, 
  cd.account_id, 
  sum(cd.we_care_amount) we_care_amount 
FROM 
  closed_deliverables cd, 
  order_details od, 
  orders o 
WHERE 
  od.order_detail_id = cd.order_detail_id 
  AND od.academic_year_id IN (
    " . implode(", ", $academic_years) . "
  ) 
  AND o.order_id = od.order_id 
  AND o.status = 0 
  AND od.status = 0 
GROUP BY 
  cd.order_detail_id, 
  online</td><td></td><td>skip</td></tr>
   <tr><td>util/function/new_renew_overrides.php:26</td><td>CREATE TEMPORARY TABLE tmp_order_cancel_mod_history (
  PRIMARY KEY (cancel_id)
) 
SELECT 
  record_id cancel_id, 
  max(date_entered) date_modified 
FROM 
  interlink.history_log 
WHERE 
  TABLE_NAME = 'order_cancels' 
  AND COLUMN_NAME IN ('new_amount', 'renewal_amount') 
  AND old_value <> new_value 
GROUP BY 
  record_id;</td><td></td><td>skip</td></tr>
   <tr><td>util/function/new_renew_overrides.php:42</td><td>CREATE TEMPORARY TABLE tmp_order_cancel_last_mod (
  PRIMARY KEY (order_id)
) 
SELECT 
  oc.order_id, 
  MAX(
    GREATEST(
      oc.date_entered, 
      IFNULL(c_hist.date_modified, '0')
    )
  ) date_modified 
FROM 
  interlink.order_cancels oc 
  LEFT JOIN tmp_order_cancel_mod_history c_hist ON c_hist.cancel_id = oc.cancel_id 
GROUP BY 
  oc.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>util/function/new_renew_overrides.php:56</td><td>CREATE TEMPORARY TABLE tmp_order_new_renew_last_reviewed (
  PRIMARY KEY (order_id)
) 
SELECT 
  o.order_id, 
  MAX(
    GREATEST(
      IFNULL(ov_man.date_entered, '0'), 
      IFNULL(ovd_man.date_entered, '0'), 
      IFNULL(ov.date_reviewed, '0'), 
      IFNULL(ovd.date_reviewed, '0')
    )
  ) date_reviewed 
FROM 
  interlink.orders o 
  LEFT JOIN commissions.quota_credit_overrides_yearly ov ON ov.order_id = o.order_id 
  LEFT JOIN interlink.order_detail_new_renew_overrides ovd ON ovd.order_id = o.order_id 
  LEFT JOIN commissions.quota_credit_overrides_yearly ov_man ON ov_man.order_id = o.order_id 
  AND ov_man.system_generated = 0 
  AND ov_man.user_id = ov.user_id 
  AND ov_man.year = ov.year 
  LEFT JOIN interlink.order_detail_new_renew_overrides ovd_man ON ovd_man.order_id = o.order_id 
  AND ovd_man.system_generated = 0 
  AND ovd_man.order_detail_id = ovd.order_detail_id 
WHERE 
  1 
  AND (
    ov.order_id IS NOT NULL 
    OR ovd.order_id IS NOT NULL
  ) 
GROUP BY 
  o.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>util/function/new_renew_overrides.php:80</td><td>CREATE TEMPORARY TABLE tmp_order_new_renew_last_mod (
  PRIMARY KEY (order_id)
) 
SELECT 
  o.order_id, 
  co.account_name, 
  co.order_total, 
  co.credit_total, 
  co.new_total + co.renew_total net_order_total, 
  co.new_total net_new_total, 
  co.renew_total net_renew_total, 
  MAX(
    GREATEST(
      IFNULL(ov.date_modified, '0'), 
      IFNULL(ovd.date_modified, '0')
    )
  ) date_modified, 
  MAX(
    CASE WHEN ov.system_generated = 1 THEN ov.date_modified ELSE 0 END
  ) system_order_override_date, 
  CONCAT(
    CASE WHEN MAX(ov.quota_credit_adj_total) IS NOT NULL THEN 'QC; ' ELSE '' END, 
    CASE WHEN MAX(ov.system_generated)= 1 
    AND MAX(
      ov.new_total IS NOT NULL 
      OR ov.renew_total IS NOT NULL
    ) THEN 'System Order Level New/Renew; ' ELSE '' END, 
    CASE WHEN MAX(ov.system_generated)= 0 
    AND MAX(
      ov.new_total IS NOT NULL 
      OR ov.renew_total IS NOT NULL
    ) THEN 'Manual Order Level New/Renew; ' ELSE '' END, 
    CASE WHEN MAX(ovd.system_generated)= 1 THEN 'System Detail Level New/Renew; ' ELSE '' END, 
    CASE WHEN MAX(ovd.system_generated)= 0 THEN 'Manual Detail Level New/Renew; ' ELSE '' END
  ) override_types 
FROM 
  interlink.orders o 
  INNER JOIN commissions.orders co ON co.order_id = o.order_id 
  AND co.cmonth = '$cmonth' 
  LEFT JOIN commissions.quota_credit_overrides_yearly ov ON ov.order_id = o.order_id 
  LEFT JOIN interlink.order_detail_new_renew_overrides ovd ON ovd.order_id = o.order_id 
  AND NOT(
    ovd.system_generated = 1 
    AND ovd.date_modified > @amort_locked_year_end
  ) 
WHERE 
  1 
  AND (
    ov.order_id IS NOT NULL 
    OR ovd.order_id IS NOT NULL
  ) 
GROUP BY 
  o.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>util/function/qcpr.php:298</td><td>CREATE TEMPORARY TABLE interlink.temp_qcpr_user_data_source (
  PRIMARY KEY(comp_plan_id)
) 
SELECT 
  
  /*Manager/User Group Data*/
  CAST(
    COALESCE(
      NULLIF(u.nvp_id, ''), 
      99999
    ) as CHAR(8)
  ) nvp_id, 
  COALESCE(
    NULLIF(u.nvp, ''), 
    'No NVP'
  ) nvp, 
  nvp_area_sort, 
  CAST(
    COALESCE(
      NULLIF(u.vp_id, ''), 
      99999
    ) as CHAR(8)
  ) vp_id, 
  COALESCE(
    NULLIF(u.vp, ''), 
    'No VP'
  ) vp, 
  vp_area_sort, 
  CAST(
    COALESCE(
      NULLIF(u.rvp_id, ''), 
      99999
    ) as CHAR(8)
  ) rvp_id, 
  COALESCE(
    NULLIF(u.rvp, ''), 
    'No RVP'
  ) rvp, 
  rvp_area_sort, 
  CAST(
    COALESCE(
      NULLIF(u.dm_id, ''), 
      99999
    ) as CHAR(8)
  ) dm_id, 
  COALESCE(
    NULLIF(u.dm, ''), 
    'No DM'
  ) dm, 
  dm_area_sort, 
  a.area_id, 
  a.parent_area_id, 
  u.`area`, 
  u.comp_plan_id, 
  u.user_f_last comp_plan, 
  u.last_name, 
  u.user_f_last sales_user, 
  u.status user_status, 
  u.field_qcpr_status, 
  u.user_id il_user_id, 
  CAST(
    CASE WHEN u.sales_user_id > 0 THEN u.sales_user_id ELSE -1 END as CHAR(8)
  ) sales_user_id, 
  cp.termination_date termination_date, 
  u.sales_role_id, 
  CASE WHEN u.area_comp_plan_type IN ('nvp', 'vp', 'rvp', 'dm', 'a3k') THEN u.area_comp_plan_type ELSE 'user' END comp_plan_type, 
  cp.renewal_rate, 
  cp.renewal_rep, 
  CASE WHEN cp.annual_quota > 1 THEN cp.annual_quota ELSE 0 END Quota 
FROM 
  commissions.users_cp u 
  LEFT JOIN commissions.compensation_plans cp ON cp.comp_plan_id = u.comp_plan_id 
  AND cp.cmonth = '$report_month_filter' 
  and cp.year = $year 
  LEFT JOIN commissions.areas a on a.area_id = cp.area_id 
  LEFT JOIN commissions.qcpr_manager_permissions m ON m.manager_comp_plan_id = $report_user_filter 
  AND m.user_id = u.user_id 
  AND m.cmonth = '$report_month_filter' 
WHERE 
  1 
  AND u.year = $year 
  AND u.cmonth = '$report_month_filter' 
  and u.field_qcpr_status = 0 #Has current year order/QC/credit OR non-terminated rep with quota
  $user_where 
GROUP BY 
  u.sales_user_id, 
  u.comp_plan_id;</td><td></td><td>skip</td></tr>
   <tr><td>util/function/qcpr.php:337</td><td>CREATE TEMPORARY TABLE interlink.temp_qcpr_user_data_source_copy (
  PRIMARY KEY(comp_plan_id)
) 
SELECT 
  * 
FROM 
  interlink.temp_qcpr_user_data_source</td><td></td><td>skip</td></tr>
   <tr><td>util/function/qcpr.php:340</td><td>CREATE TEMPORARY TABLE interlink.temp_qcpr_user_data_source_copy2 (
  PRIMARY KEY(comp_plan_id)
) 
SELECT 
  * 
FROM 
  interlink.temp_qcpr_user_data_source</td><td></td><td>skip</td></tr>
   <tr><td>util/function/qcpr.php:349</td><td>CREATE TEMPORARY TABLE interlink.temp_qcpr_qc_data_source (
  row_id INT UNSIGNED not null auto_increment PRIMARY KEY
) 
SELECT 
  CAST(
    uo.sales_user_id as CHAR(8)
  ) sales_user_id, 
  cp.comp_plan_id comp_plan_id, 
  u.Quota, 
  
  /*Month */
  CAST(
    '' as char(14)
  ) `month`, 
  CAST('' as SIGNED) month_id, 
  
  /*Order Level Info*/
  uo.order_id `order`, 
  uo.order_id order_id, 
  'N' as cancel, 
  CAST(
    '' as DECIMAL(12, 2)
  ) order_total, 
  CAST(
    '' as DECIMAL(12, 2)
  ) tax_total, 
  CAST(
    '' as DECIMAL(12, 2)
  ) tax_credit_total, 
  CAST(
    '' as DECIMAL(12, 2)
  ) credit_total, 
  CAST(
    '' as DECIMAL(12, 2)
  ) comm_credit_total, 
  CAST(
    '' as DECIMAL(12, 2)
  ) new_total, 
  CAST(
    '' as DECIMAL(12, 2)
  ) renew_total, 
  CAST(
    '' as DECIMAL(12, 2)
  ) comm_new_total, 
  CAST(
    '' as DECIMAL(12, 2)
  ) comm_renew_total, 
  CAST(
    '' as char(10)
  ) start_date, 
  CAST(
    '' as char(10)
  ) end_date, 
  CAST(
    '' as char(10)
  ) order_date, 
  CAST(
    '' as char(8)
  ) account_id, 
  CAST(
    '' as char(255)
  ) account_name, 
  CAST(
    '' as char(5)
  ) account_state, 
  CAST(
    '' as char(250)
  ) account_county, 
  CAST(
    '' as char(250)
  ) account_city, 
  CAST(
    '' as char(5)
  ) sold_by_user_id, 
  CAST(
    '' as char(50)
  ) `sold_by_user`, 
  CAST(
    '' as char(5)
  ) account_owner_id, 
  CAST(
    '' as char(50)
  ) `owned_by_user`, 
  CAST(
    '' as char(50)
  ) `order_field_rep`, 
  CAST(
    '' as char(50)
  ) `order_renewal_rep`, 
  CAST(
    '' as char(50)
  ) `order_inside_rep`, 
  CAST(
    '' as char(50)
  ) `order_strategic_rep`, 
  
  /*YTD  Order Cols*/
  CAST(
    '' as DECIMAL(12, 2)
  ) `Order Total`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Order Total Sold`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Tax Total`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Literacy Total`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Science Total`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `New`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `New Own`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Rep New`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Renew`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Rep Renew`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `New ACV`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Renew ACV`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Order New ACV`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Order Renew ACV`, 
  
  /*YTD QC Cols*/
  CAST(
    '' as DECIMAL(12, 2)
  ) `QC Sold`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `QC Own`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `QC Other`, 
  CAST(
    uo.qc_type as CHAR(100)
  ) qc_type, 
  uo.mgmt as qc_type_managed, 
  uo.extra_qc_types, 
  uo.percentage, 
  CAST(
    '' as CHAR(180)
  ) adjustment_reason, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Total QC`, 
  CAST(
    '' as char(10)
  ) `% Quota`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Projected QC`, 
  CAST(
    '' as char(10)
  ) `% Projected Quota`, 
  CASE WHEN uo.qc_type = 'SOLD' THEN 1 WHEN uo.qc_type = 'Own' THEN 2 WHEN uo.qc_type = 'Other' THEN 3 ELSE 3 END qc_type_id 
  /*Current Quarter Order COLS*/
  , 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Order Total CC`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Order Total Sold CC`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Tax Total CC`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Literacy Total CC`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Science Total CC`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `New CC`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `New Own CC`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Rep New CC`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Renew CC`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Rep Renew CC`, 
  
  /*Current Quarter QC COLS*/
  CAST(
    '' as DECIMAL(12, 2)
  ) `QC Sold CC`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `QC Own CC`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `QC Other CC`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Total QC CC`, 
  CAST(
    '' as char(10)
  ) `% Quota CC`, 
  CAST(
    '' as DECIMAL(12, 2)
  ) `Projected QC CC`, 
  CAST(
    '' as char(10)
  ) `% Projected Quota CC`, 
  0 mapped_sales_user_id, 
  0 pending_status_id, 
  CAST(
    '' as char(50)
  ) pending_status, 
  CAST(
    '' as char(15)
  ) pending_status_color 
FROM 
  commissions.orders o 
  LEFT JOIN commissions.order_users uo on o.order_id = uo.order_id 
  and uo.cmonth = '$report_month_filter' 
  LEFT JOIN commissions.order_user_curr_comp_plans cp on cp.cmonth = '$report_month_filter' 
  and uo.order_id = cp.order_id 
  and uo.user_id = cp.user_id 
  LEFT JOIN interlink.temp_qcpr_user_data_source u on cp.comp_plan_id = u.comp_plan_id 
WHERE 
  1 
  AND o.cmonth = '$report_month_filter' 
GROUP BY 
  u.sales_user_id, 
  cp.comp_plan_id, 
  o.cmonth, 
  o.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>util/function/qcpr.php:661</td><td>CREATE TEMPORARY TABLE monthly_qc (
  PRIMARY KEY(order_id, comp_plan_id)
) 
SELECT 
  qcm.order_id, 
  qcm.comp_plan_id, 
  qcm.sales_user_id, 
  SUM(qcm.quota_credit) quota_credit, 
  SUM(
    CASE WHEN ou.qc_type = 'SOLD' THEN qcm.quota_credit ELSE 0 END
  ) qc_sold, 
  SUM(
    CASE WHEN ou.qc_type = 'OWN' THEN qcm.quota_credit ELSE 0 END
  ) qc_own, 
  SUM(
    CASE WHEN ou.qc_type NOT IN ('SOLD', 'OWN') THEN qcm.quota_credit ELSE 0 END
  ) qc_other 
FROM 
  commissions.quota_credit_user_months_lock qcm 
  LEFT JOIN commissions.order_users ou on qcm.order_id = ou.order_id 
  and qcm.user_id = ou.user_id 
  and qcm.cmonth = ou.cmonth 
WHERE 
  1 
  AND qcm.cmonth = '$report_month_filter' 
  AND qcm.qc_month BETWEEN '$first_day_of_quarter' 
  AND '$last_day_of_quarter' 
GROUP BY 
  qcm.order_id, 
  qcm.comp_plan_id</td><td></td><td>skip</td></tr>
   <tr><td>util/function/qcpr.php:681</td><td>CREATE TEMPORARY TABLE monthly_qc_projected (
  PRIMARY KEY(order_id, comp_plan_id)
) 
SELECT 
  qcm.order_id, 
  qcm.comp_plan_id, 
  qcm.sales_user_id, 
  SUM(qcm.quota_credit) quota_credit 
FROM 
  commissions.quota_credit_user_months_lock qcm 
WHERE 
  1 
  AND qcm.cmonth = '$projected_qc_month' 
  AND qcm.qc_month BETWEEN '$first_day_of_quarter' 
  AND '$last_day_of_quarter' 
GROUP BY 
  qcm.order_id, 
  qcm.comp_plan_id</td><td></td><td>skip</td></tr>
   <tr><td>util/function/qcpr.php:790</td><td>CREATE TEMPORARY TABLE interlink.temp_qcpr_qc_data_source_copy 
SELECT 
  * 
FROM 
  interlink.temp_qcpr_qc_data_source</td><td></td><td>skip</td></tr>
   <tr><td>util/function/qcpr.php:1179</td><td>CREATE TEMPORARY TABLE tmp_cancels (
  PRIMARY KEY (order_id)
) 
SELECT 
  order_id, 
  GROUP_CONCAT(
    CASE WHEN ctype = 'cancel' THEN CONCAT(
      'IL Credit ', cancel_id, ': Cancel Date: ', 
      cancel_date, '; Amount: ', credit, 
      ';'
    ) WHEN ctype = 'credit' THEN CONCAT(
      'Comm Credit ', invoice_id, ': Cancel Date: ', 
      cancel_date, '; Amount: ', credit, 
      ';'
    ) END 
    ORDER BY 
      cancel_date SEPARATOR '  ||  '
  ) credits 
FROM 
  commissions.credits 
WHERE 
  cmonth = '$report_month_filter' 
  AND '$admin_view' = 1 
GROUP BY 
  order_id;</td><td></td><td>skip</td></tr>
   <tr><td>util/function/qcpr.php:1194</td><td>CREATE TEMPORARY TABLE tmp_cancels2 (
  PRIMARY KEY (order_id)
) 
SELECT 
  * 
FROM 
  tmp_cancels;</td><td></td><td>skip</td></tr>
   <tr><td>cron/monthly/renewals.php:126</td><td>CREATE TABLE pd_only_products(
  KEY(product_id)
) 
SELECT 
  p.* 
FROM 
  products p 
  JOIN sub_products sp ON sp.product_id = p.product_id 
  AND sp.sub_product_type_id IN (4, 5, 14, 24) 
  JOIN sub_product_types spt USING(sub_product_type_id) 
  LEFT JOIN sub_products sp2 ON sp2.product_id = p.product_id 
  AND sp2.sub_product_type_id NOT IN (4, 5, 14, 24, 6) 
WHERE 
  sp2.product_id IS NULL</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:135</td><td>CREATE TABLE renewal_future_orders (
  PRIMARY KEY(
    account_id, opportunity_product_id, 
    product_line_str
  )
) 
SELECT 
  distinct od.account_id, 
  o.opportunity_product_id, 
  IF(
    (
      IFNULL(
        IFNULL(
          pr.program_name, pl.product_line_str
        ), 
        ''
      ) <> '' 
      AND pop.product_id IS NULL
    ), 
    IFNULL(
      pr.program_name, pl.product_line_str
    ), 
    IF(
      pop.product_id IS NOT NULL, 
      'PD', 
      IF(p.product_group_id = 31, 'PM', '')
    )
  ) product_line_str, 
  MAX(o.order_date) max_booked_order_date, 
  group_concat(o.order_id) order_string, 
  max(os.order_total) max_order_total 
FROM 
  (
    orders o, order_details od, products p, 
    account_order_summary aos
  ) 
  INNER JOIN tmp_fin_bob_order_details bod ON bod.order_detail_id = od.order_detail_id 
  INNER JOIN interlink.order_summary os on os.order_id = o.order_id 
  LEFT JOIN order_reportable_excludes x ON (o.order_id = x.order_id) 
  LEFT JOIN product_lines pl ON pl.product_line_id = p.product_line_id 
  LEFT JOIN programs pr ON pr.program_id = p.program_id 
  AND pl.product_line_id IN(3, 4, 11) 
  LEFT JOIN pd_only_products pop ON pop.product_id = p.product_id 
WHERE 
  o.order_id = od.order_id 
  AND o.status = 0 
  AND od.status = 0 
  AND od.product_id = p.product_id 
  AND od.order_detail_id = aos.order_detail_id 
  AND p.sku NOT LIKE '%IMP%' 
  AND p.sku NOT LIKE '%SPT%' #AND (aos.student_licenses > 0 OR p.sku LIKE '%site%' OR (p.product_group_id = '" . $PRODUCT_GROUPS["program pricing"] . "' AND p.sku NOT LIKE '%PD%'))
  AND p.summer_type_id = 0 
  /* avoid these products so that summer orders won't prevent a renewal */
  AND bod.expiring_year = $next_year 
  AND o.end_date > '$today' 
  AND o.se_0_order = 0 
  AND x.order_id IS NULL #AND pop.product_id IS NULL
  #AND IFNULL(pr.program_name, pl.product_line_str) IS NOT NULL
  AND IF(
    (
      IFNULL(
        IFNULL(
          pr.program_name, pl.product_line_str
        ), 
        ''
      ) <> '' 
      AND pop.product_id IS NULL
    ), 
    IFNULL(
      pr.program_name, pl.product_line_str
    ), 
    IF(
      pop.product_id IS NOT NULL, 
      'PD', 
      IF(p.product_group_id = 31, 'PM', '')
    )
  ) <> '' 
GROUP BY 
  account_id, 
  opportunity_product_id, 
  IF(
    (
      IFNULL(
        IFNULL(
          pr.program_name, pl.product_line_str
        ), 
        ''
      ) <> '' 
      AND pop.product_id IS NULL
    ), 
    IFNULL(
      pr.program_name, pl.product_line_str
    ), 
    IF(
      pop.product_id IS NOT NULL, 
      'PD', 
      IF(p.product_group_id = 31, 'PM', '')
    )
  )</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:176</td><td>CREATE TABLE renewal_future_opps 
SELECT 
  DISTINCT qd.account_id, 
  ro.order_id expiring_order_id, 
  opm.opportunity_product_id, 
  IF(
    (
      IFNULL(
        IFNULL(
          pr.program_name, pl.product_line_str
        ), 
        ''
      ) <> '' 
      AND pop.product_id IS NULL
    ), 
    IFNULL(
      pr.program_name, pl.product_line_str
    ), 
    IF(
      pop.product_id IS NOT NULL, 
      'PD', 
      IF(
        products.product_group_id = 31, 'PM', 
        ''
      )
    )
  ) product_line_str 
FROM 
  (
    opportunities p, quotes q, quote_details qd, 
    renewal_opportunities ro, opportunity_product_map opm, 
    products
  ) 
  LEFT JOIN product_lines pl ON pl.product_line_id = products.product_line_id 
  LEFT JOIN programs pr ON pr.program_id = products.program_id 
  AND pl.product_line_id IN(3, 4, 11) 
  LEFT JOIN pd_only_products pop ON pop.product_id = products.product_id 
WHERE 
  p.opportunity_id = q.opportunity_id 
  AND q.quote_id = qd.quote_id 
  AND products.product_id = qd.product_id 
  AND p.opportunity_id = ro.opportunity_id 
  AND p.opportunity_id = opm.opportunity_id 
  AND (
    p.probability_id > 1 
    OR year(p.date_entered) = '" . date(Y,strtotime($today)) . "'
  ) 
  AND p.order_id = 0 
  AND (
    qd.academic_year_id = '$next_academic_year_id' 
    OR qd.academic_year_id = '$current_academic_year_id_summer' 
    OR qd.end_date > '$expire_end_date'
  ) 
  AND products.sku NOT LIKE '%IMP%' 
  AND products.sku NOT LIKE '%SPT%' 
  AND IF(
    (
      IFNULL(
        IFNULL(
          pr.program_name, pl.product_line_str
        ), 
        ''
      ) <> '' 
      AND pop.product_id IS NULL
    ), 
    IFNULL(
      pr.program_name, pl.product_line_str
    ), 
    IF(
      pop.product_id IS NOT NULL, 
      'PD', 
      IF(
        products.product_group_id = 31, 'PM', 
        ''
      )
    )
  ) <> ''</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:207</td><td>CREATE TABLE expiring_order_details 
SELECT 
  DISTINCT o.order_id, 
  o.account_id, 
  if(
    c2.contact_id is not null, c2.contact_id, 
    0
  ) contact_id, 
  c2.status contact_status, 
  if(
    ac2.contact_id is not null, ac2.contact_id, 
    0
  ) activation_contact_id, 
  od.end_date expiration_date, 
  '" . $USERS["renewal_sales"] . "' sales_rep, 
  od.account_id detail_account_id, 
  od.product_id, 
  o.no_renewal_group, 
  o.order_length, 
  o.opportunity_product_id, 
  p.summer_type_id, 
  op.lead_source_id, 
  a.parent_account_id, 
  IF(p.sku LIKE '%BAE%', 1, 0) bae 
FROM 
  (
    orders o, order_details od, accounts a, 
    products p
  ) 
  INNER JOIN order_summary os ON os.order_id = o.order_id 
  INNER JOIN tmp_fin_bob_order_details bod ON bod.order_detail_id = od.order_detail_id 
  LEFT JOIN product_lines pl ON pl.product_line_id = p.product_line_id 
  LEFT JOIN programs pr ON p.program_id = pr.program_id 
  AND pl.product_line_id IN(3, 4, 11) 
  LEFT JOIN pd_only_products pop ON p.product_id = pop.product_id 
  LEFT JOIN renewal_future_orders r on (
    od.account_id = r.account_id 
    and o.opportunity_product_id = r.opportunity_product_id 
    AND IF(
      (
        IFNULL(
          IFNULL(
            pr.program_name, pl.product_line_str
          ), 
          ''
        ) <> '' 
        AND pop.product_id IS NULL
      ), 
      IFNULL(
        pr.program_name, pl.product_line_str
      ), 
      IF(
        pop.product_id IS NOT NULL, 
        'PD', 
        IF(p.product_group_id = 31, 'PM', '')
      )
    ) = r.product_line_str 
    AND r.max_booked_order_date >= o.order_date 
    AND (
      r.max_order_total > 0 
      OR os.order_total = 0
    )
  ) 
  LEFT JOIN order_contacts c ON (
    o.order_id = c.order_id 
    AND c.contact_type_id = 3
  ) 
  LEFT JOIN contacts c2 ON (
    c.contact_id = c2.contact_id 
    /*AND c2.account_id = o.account_id*/
    AND c2.status = 0
  ) 
  LEFT JOIN order_contacts ac ON (
    o.order_id = ac.order_id 
    AND ac.contact_type_id = 5
  ) 
  LEFT JOIN contacts ac2 ON (
    ac.contact_id = ac2.contact_id 
    /*AND ac2.account_id = o.account_id*/
    AND ac2.status = 0
  ) 
  LEFT JOIN renewal_future_opps rp ON (
    o.order_id = rp.expiring_order_id 
    AND od.account_id = rp.account_id 
    AND o.opportunity_product_id = rp.opportunity_product_id 
    AND IF(
      (
        IFNULL(
          IFNULL(
            pr.program_name, pl.product_line_str
          ), 
          ''
        ) <> '' 
        AND pop.product_id IS NULL
      ), 
      IFNULL(
        pr.program_name, pl.product_line_str
      ), 
      IF(
        pop.product_id IS NOT NULL, 
        'PD', 
        IF(p.product_group_id = 31, 'PM', '')
      )
    ) = rp.product_line_str
  ) 
  LEFT JOIN order_reportable_excludes x ON (o.order_id = x.order_id) 
  LEFT JOIN opportunities op ON (o.order_id = op.order_id) 
WHERE 
  o.order_id = od.order_id 
  AND od.account_id = a.account_id 
  AND od.product_id = p.product_id 
  AND bod.expiring_year = $year 
  AND r.account_id IS NULL 
  AND rp.account_id IS NULL 
  AND o.status = 0 
  AND od.status = 0 
  AND p.product_group_id NOT IN(
    " . $PRODUCT_GROUPS[" discount "] . ", 
    " . $PRODUCT_GROUPS[" fee "] . "
  ) 
  AND o.se_0_order = 0 
  /*AND o.billing_account_id = 4437*/
  AND x.order_id IS NULL 
  AND a.closed <> 1</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:279</td><td>CREATE TABLE expiring_details_non_pd_non_pm 
SELECT 
  DISTINCT order_id 
FROM 
  expiring_order_details e 
  JOIN products p ON e.product_id = p.product_id 
  LEFT JOIN pd_only_products po ON p.product_id = po.product_id 
WHERE 
  po.product_id IS NULL #not a PD product
  AND p.sku NOT REGEXP('IMP|SPT') #not fees
  AND p.product_group_id <> 31 #not a project management product
  AND p.product_group_id NOT IN(
    " . $PRODUCT_GROUPS[" discount "] . ", 
    " . $PRODUCT_GROUPS[" fee "] . "
  )</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:311</td><td>CREATE TABLE expiring_details_hold_products 
SELECT 
  DISTINCT d.order_id 
FROM 
  expiring_order_details d, 
  renewal_hold_products h 
WHERE 
  d.product_id = h.product_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:326</td><td>CREATE TABLE expiring_orders 
SELECT 
  DISTINCT order_id, 
  account_id, 
  contact_id, 
  contact_status, 
  activation_contact_id, 
  sales_rep, 
  no_renewal_group, 
  order_length expiring_order_length, 
  opportunity_product_id, 
  MAX(bae) bae 
FROM 
  expiring_order_details 
GROUP BY 
  order_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:376</td><td>CREATE TEMPORARY TABLE expiring_order_dates (
  key(order_id)
) 
SELECT 
  o.order_id, 
  MIN(o.order_date) expiring_order_date, 
  MIN(
    IF(
      ptd.payment_term_id IS NOT NULL, ptd.payment_term_date, 
      0
    )
  ) expiring_order_po_date 
FROM 
  (expiring_orders e, orders o) 
  LEFT JOIN payment_terms pt ON (
    o.order_id = pt.order_id 
    AND pt.status = 0
  ) 
  LEFT JOIN payment_term_details ptd ON (
    pt.payment_term_id = ptd.payment_term_id 
    AND ptd.status = 0 
    AND ptd.payment_term_date > 0
  ) 
WHERE 
  o.order_id = e.order_id 
GROUP BY 
  o.order_id</td><td></td><td>skip</td></tr>
   <tr><td>cron/monthly/renewals.php:400</td><td>CREATE TABLE expiring_orders_summer_only 
SELECT 
  e.order_id 
FROM 
  (
    expiring_orders e, order_details od, 
    products p
  ) 
WHERE 
  e.order_id = od.order_id 
  and p.product_id = od.product_id 
  AND od.status = 0 
  AND p.product_group_id NOT IN(
    " . $PRODUCT_GROUPS[" discount "] . ", 
    " . $PRODUCT_GROUPS[" fee "] . "
  ) 
GROUP BY 
  e.order_id 
having 
  group_concat(distinct summer_type_id) not like '%0%';</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:412</td><td>CREATE TABLE expiring_dates 
SELECT 
  order_id, 
  account_id, 
  max(expiration_date) expiration_date 
FROM 
  expiring_order_details 
GROUP BY 
  order_id, 
  account_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:431</td><td>CREATE TABLE renewal_order_2_buyers 
SELECT 
  eo.order_id, 
  COUNT(DISTINCT oc.contact_id) num_contacts 
FROM 
  expiring_orders eo, 
  order_contacts oc, 
  contacts c 
WHERE 
  eo.order_id = oc.order_id 
  AND oc.contact_id = c.contact_id 
  AND contact_type_id = 3 
  AND c.status = 0 
GROUP BY 
  eo.order_id 
HAVING 
  num_contacts > 1</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:449</td><td>CREATE TABLE renewal_order_2_act_contacts 
SELECT 
  eo.order_id, 
  COUNT(DISTINCT oc.contact_id) num_contacts 
FROM 
  expiring_orders eo, 
  order_contacts oc, 
  contacts c 
WHERE 
  eo.order_id = oc.order_id 
  AND oc.contact_id = c.contact_id 
  AND contact_type_id = 5 
  AND c.status = 0 
GROUP BY 
  eo.order_id 
HAVING 
  num_contacts > 1</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:552</td><td>CREATE TABLE renewal_total_schools 
SELECT 
  expiring_orders.account_id, 
  expiring_orders.opportunity_product_id, 
  COUNT(DISTINCT accounts.account_id) total_schools 
FROM 
  expiring_orders, 
  accounts 
WHERE 
  expiring_orders.account_id = accounts.parent_account_id 
  AND summer = 0 
GROUP BY 
  expiring_orders.account_id, 
  expiring_orders.opportunity_product_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:570</td><td>CREATE TABLE expiring_pp_orders 
SELECT 
  distinct eo.order_id 
FROM 
  expiring_orders eo, 
  order_details od, 
  products p, 
  sub_products sp 
WHERE 
  eo.order_id = od.order_id 
  AND od.status = 0 
  AND od.end_date BETWEEN '$expire_start_date' 
  AND '$expire_end_date' 
  AND p.product_id = od.product_id 
  AND p.product_group_id in (26, 44) 
  AND p.product_id = sp.product_id 
  AND sp.sub_product_type_id = 1</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:638</td><td>CREATE TABLE expiring_account_usage 
SELECT 
  account_id, 
  if (program_id = 2, 2, 1) opportunity_product_id, 
  round(
    (
      sum(total_students)/ sum(student_licenses)* 100
    )
  ) perc_usage 
FROM 
  school_usage_primary_report 
WHERE 
  report_start_date = '$report_start_date' 
  and report_end_date = '$report_end_date' 
GROUP BY 
  account_id, 
  opportunity_product_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:695</td><td>CREATE TABLE expiring_order_account_usage 
SELECT 
  DISTINCT od.order_id, 
  od.account_id, 
  u.perc_usage 
FROM 
  orders o, 
  order_details od, 
  expiring_account_usage u 
WHERE 
  u.account_id = od.account_id 
  AND od.status = 0 
  AND od.end_date BETWEEN '$expire_start_date' 
  AND '$expire_end_date' 
  AND o.order_id = od.order_id 
  AND o.opportunity_product_id = u.opportunity_product_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:709</td><td>CREATE TABLE expiring_order_usage 
SELECT 
  o.order_id, 
  avg(u.perc_usage) perc_usage 
FROM 
  (
    expiring_orders o, expiring_order_account_usage u
  ) 
WHERE 
  o.no_usage_data = 0 
  AND o.order_id = u.order_id 
GROUP BY 
  o.order_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:838</td><td>CREATE TABLE rwl_opportunity_details 
SELECT 
  e.order_id, 
  od.account_id, 
  e.opportunity_product_id, 
  a.account_level, 
  a.year_round, 
  p1.product_id expiring_product_id, 
  p2.product_group_id, 
  p2.product_id, 
  if (
    p2.summer_type_id is not null, p2.summer_type_id, 
    p1.summer_type_id
  ) summer_type_id, 
  od.quantity, 
  od.price, 
  od.academic_year_id, 
  if (
    p2.summer_type_id is not null, 
    if (
      p2.summer_type_id IN(0, 1), 
      subscription_start, 
      subscription_end
    ), 
    if (
      p1.summer_type_id IN(0, 1), 
      subscription_start, 
      subscription_end
    )
  ) subscription_start, 
  if (
    p2.summer_type_id is not null, 
    if (
      p2.summer_type_id IN(0, 1), 
      subscription_end, 
      subscription_start
    ), 
    if (
      p1.summer_type_id IN(0, 1), 
      subscription_end, 
      subscription_start
    )
  ) subscription_end, 
  '0000-00-00' start_date, 
  '0000-00-00' end_date, 
  concat(
    year(
      curdate()
    ), 
    '-', 
    subscription_start
  ) next_subscription_start, 
  0 new_opportunity_id, 
  IF(
    (
      IFNULL(
        IFNULL(
          pr.program_name, pl.product_line_str
        ), 
        ''
      ) <> '' 
      AND pop.product_id IS NULL
    ), 
    IFNULL(
      pr.program_name, pl.product_line_str
    ), 
    IF(
      pop.product_id IS NOT NULL, 
      'PD', 
      IF(p1.product_group_id = 31, 'PM', '')
    )
  ) product_line_str, 
  bod.expiring_year 
FROM 
  (
    expiring_orders e, order_details od, 
    products p1, accounts a, order_details current_details
  ) 
  LEFT JOIN tmp_fin_bob_order_details bod ON bod.order_detail_id = od.order_detail_id 
  LEFT JOIN pd_only_products pop ON pop.product_id = p1.product_id 
  LEFT JOIN product_lines pl ON pl.product_line_id = p1.product_line_id 
  LEFT JOIN programs pr ON pr.program_id = p1.program_id 
  AND pl.product_line_id IN(3, 4, 11) 
  LEFT JOIN renewal_future_orders r ON (
    od.account_id = r.account_id 
    AND e.opportunity_product_id = r.opportunity_product_id 
    AND IF(
      (
        IFNULL(
          IFNULL(
            pr.program_name, pl.product_line_str
          ), 
          ''
        ) <> '' 
        AND pop.product_id IS NULL
      ), 
      IFNULL(
        pr.program_name, pl.product_line_str
      ), 
      IF(
        pop.product_id IS NOT NULL, 
        'PD', 
        IF(p1.product_group_id = 31, 'PM', '')
      )
    ) = r.product_line_str 
    AND r.max_booked_order_date >= e.expiring_order_date 
    AND r.max_order_total > 0
  ) 
  LEFT JOIN product_mapping pm ON p1.product_id = pm.old_product_id 
  and pm.status = 0 
  LEFT JOIN products p2 on p2.product_id = pm.new_product_id 
  LEFT JOIN product_groups pg ON (
    p2.product_group_id = pg.product_group_id
  ) 
  LEFT JOIN renewal_future_opps rp ON (
    e.order_id = rp.expiring_order_id 
    AND od.account_id = rp.account_id 
    AND e.opportunity_product_id = rp.opportunity_product_id 
    AND IF(
      (
        IFNULL(
          IFNULL(
            pr.program_name, pl.product_line_str
          ), 
          ''
        ) <> '' 
        AND pop.product_id IS NULL
      ), 
      IFNULL(
        pr.program_name, pl.product_line_str
      ), 
      IF(
        pop.product_id IS NOT NULL, 
        'PD', 
        IF(p1.product_group_id = 31, 'PM', '')
      )
    ) = rp.product_line_str
  ) 
  LEFT JOIN tmp_fin_bob_order_details bod2 ON bod2.order_detail_id = current_details.order_detail_id 
WHERE 
  e.order_id = od.order_id 
  AND od.product_id = p1.product_id 
  AND od.account_id = a.account_id 
  AND od.account_id = current_details.account_id 
  AND (
    '$today' BETWEEN current_details.start_date 
    AND current_details.end_date 
    OR current_details.academic_year_id = '$current_academic_year_id' 
    OR (
      bod2.expiring_year = '$year' 
      AND bod2.summer = 1
    )
  ) 
  AND p1.product_group_id NOT IN(
    '". $PRODUCT_GROUPS["fee"] . "', 
    '". $PRODUCT_GROUPS["discount"] . "'
  ) 
  AND p1.sku NOT LIKE '%IMP%' 
  AND p1.sku NOT LIKE '%SPT%' 
  AND p1.sku NOT LIKE '%JMP%' 
  AND p1.sku NOT LIKE '%-UPSE-%' 
  AND od.status = 0 
  /*AND e.no_quote_reasons = 0*/
  AND (
    pg.status IS NULL 
    OR pg.status = 0
  ) 
  AND r.account_id IS NULL 
  AND rp.account_id IS NULL 
  AND od.product_id != '" . $PRODUCTS["remove pd"] . "' 
  AND a.closed <> 1 
GROUP BY 
  od.order_detail_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:907</td><td>CREATE TABLE renewal_program_pricing 
SELECT 
  e.account_id, 
  e.contact_id, 
  e.opportunity_product_id, 
  0 order_id, 
  max(
    if (
      p.product_group_id in (26, 44), 
      1, 
      0
    )
  ) program_pricing 
FROM 
  expiring_orders e, 
  rwl_opportunity_details r, 
  products p 
WHERE 
  e.order_id = r.order_id 
  AND e.no_renewal_group = 0 
  AND p.product_id = r.expiring_product_id 
GROUP BY 
  e.account_id, 
  e.contact_id, 
  e.opportunity_product_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:939</td><td>CREATE TABLE pp_lit_licenses (
  key(order_id)
) 
SELECT 
  DISTINCT o.order_id 
FROM 
  rwl_opportunity_details d, 
  products p1, 
  rwl_opportunity_details d2, 
  products p2, 
  sub_products sp2, 
  expiring_orders o, 
  expiring_orders o2 
WHERE 
  p1.product_id = d.expiring_product_id 
  AND p1.product_group_id = 26 
  AND p2.product_id = d2.product_id 
  AND p2.product_id = sp2.product_id 
  AND p2.student_licenses > 0 
  AND p2.product_id = sp2.product_id 
  AND sp2.sub_product_type_id in (1, 22, 25) 
  AND o.order_id = d.order_id 
  AND o2.order_id = d2.order_id 
  AND o.no_renewal_group = o2.no_renewal_group 
  AND (
    (
      o.no_renewal_group = 1 
      AND d.order_id = d2.order_id
    ) 
    OR (
      o.no_renewal_group = 0 
      AND o.account_id = o2.account_id 
      AND o.opportunity_product_id = o2.opportunity_product_id 
      AND o.contact_id = o2.contact_id
    )
  )</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:988</td><td>CREATE TABLE orders_no_mapping 
SELECT 
  distinct d.* 
FROM 
  rwl_opportunity_details d, 
  renewal_opportunities ro, 
  opportunities p 
WHERE 
  d.product_id is null 
  AND d.order_id = ro.order_id 
  AND p.opportunity_id = ro.opportunity_id 
  AND p.probability_id > 1</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:1051</td><td>CREATE TABLE renewal_unique_products 
SELECT 
  DISTINCT product_id 
FROM 
  rwl_opportunity_details 
WHERE 
  product_group_id NOT IN(28, 32) 
  AND product_id > 0</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:1059</td><td>CREATE TABLE renewal_product_prices 
SELECT 
  r.product_id, 
  SUM(
    sp.list_price * sp.sub_product_qty
  ) price, 
  SUM(
    if (
      spt.discountable = 'Y', 
      (list_price * sub_product_qty), 
      0
    )
  ) price_discountable 
FROM 
  renewal_unique_products r, 
  sub_products sp, 
  sub_product_types spt 
WHERE 
  r.product_id = sp.product_id 
  AND sp.sub_product_type_id = spt.sub_product_type_id 
  AND sp.status = 0 
GROUP BY 
  r.product_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:1070</td><td>CREATE TABLE rwl_expiring_products 
SELECT 
  DISTINCT expiring_product_id 
FROM 
  rwl_opportunity_details</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:1076</td><td>CREATE TABLE rwl_expiring_product_prices 
SELECT 
  r.opportunity_detail_id, 
  r.expiring_product_id, 
  IF(
    fee_price.price IS NULL, 
    r.price, 
    (r.price + fee_price.price)
  ) AS total_price 
FROM 
  rwl_opportunity_details r 
  LEFT JOIN (
    SELECT 
      expiring_product_id, 
      SUM(sp.list_price * sub_product_qty) price 
    FROM 
      rwl_expiring_products e 
      INNER JOIN products p ON e.expiring_product_id = p.product_id 
      INNER JOIN sub_products sp ON sp.product_id IN (
        p.imf_product_id, p.support_product_id
      ) 
    GROUP BY 
      e.expiring_product_id
  ) fee_price USING (expiring_product_id)</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:1130</td><td>CREATE TABLE tmp_opportunity_min_dates 
SELECT 
  e.order_id, 
  substr(
    min(
      concat(a.start_date, '|', summer)
    ), 
    1, 
    10
  ) min_start, 
  substr(
    min(
      concat(a.start_date, '|', summer)
    ), 
    12, 
    1
  ) summer 
FROM 
  expiring_orders e, 
  rwl_opportunity_details r, 
  academic_years a 
WHERE 
  e.order_id = r.order_id 
  AND r.academic_year_id = a.academic_year_id 
  AND r.product_id is not null 
GROUP BY 
  e.order_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:1148</td><td>CREATE TABLE tmp_opportunity_next_start 
SELECT 
  e.order_id, 
  min(a.start_date) min_next_start 
FROM 
  expiring_orders e, 
  tmp_opportunity_min_dates t, 
  rwl_opportunity_details r, 
  academic_years a 
WHERE 
  e.order_id = t.order_id 
  AND e.order_id = r.order_id 
  AND r.next_subscription_start between a.start_date 
  and a.end_date 
  AND r.product_id is not null 
  AND t.summer = a.summer 
  AND r.year_round = 0 
GROUP BY 
  e.order_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:1175</td><td>CREATE TABLE tmp_opportunity_next_start2 
SELECT 
  order_id, 
  MIN(min_next_start) min_next_start 
FROM 
  tmp_opportunity_next_start 
GROUP BY 
  order_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:1230</td><td>CREATE TABLE rwl_year_round_dates 
SELECT 
  e.account_id, 
  e.contact_id, 
  e.opportunity_product_id, 
  0 order_id, 
  min(r.start_date) min_start 
FROM 
  expiring_orders e, 
  rwl_opportunity_details r 
WHERE 
  e.order_id = r.order_id 
  AND r.year_round = 0 
  AND e.no_renewal_group = 0 
GROUP BY 
  e.account_id, 
  e.contact_id, 
  e.opportunity_product_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:1316</td><td>CREATE TABLE rwl_delete_details 
SELECT 
  DISTINCT r.* #r.opportunity_detail_id
FROM 
  (
    rwl_opportunity_details r, order_details od, 
    orders o, products p
  ) 
  LEFT JOIN product_lines pl ON pl.product_line_id = p.product_line_id 
  LEFT JOIN programs pr ON pr.program_id = p.program_id 
  AND pl.product_line_id IN(3, 4, 11) 
  LEFT JOIN order_reportable_excludes x ON (o.order_id = x.order_id) 
  LEFT JOIN pd_only_products pop ON pop.product_id = p.product_id 
WHERE 
  r.account_id = od.account_id 
  AND od.order_id = o.order_id 
  AND od.product_id = p.product_id 
  AND r.account_id = od.account_id 
  AND r.new_academic_year_id = od.academic_year_id 
  AND o.status = 0 
  AND od.status = 0 
  AND x.order_id IS NULL 
  AND r.product_line_str = IF(
    (
      IFNULL(
        IFNULL(
          pr.program_name, pl.product_line_str
        ), 
        ''
      ) <> '' 
      AND pop.product_id IS NULL
    ), 
    IFNULL(
      pr.program_name, pl.product_line_str
    ), 
    IF(
      pop.product_id IS NOT NULL, 
      'PD', 
      IF(p.product_group_id = 31, 'PM', '')
    )
  ) 
  AND IF(
    (
      IFNULL(
        IFNULL(
          pr.program_name, pl.product_line_str
        ), 
        ''
      ) <> '' 
      AND pop.product_id IS NULL
    ), 
    IFNULL(
      pr.program_name, pl.product_line_str
    ), 
    IF(
      pop.product_id IS NOT NULL, 
      'PD', 
      IF(p.product_group_id = 31, 'PM', '')
    )
  ) <> '' #AND (p.student_licenses > 0 OR p.sku LIKE '%site%' OR (p.product_group_id = '26' AND p.sku NOT LIKE '%PD%'))
  AND o.opportunity_product_id = r.opportunity_product_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:1436</td><td>CREATE TABLE rwl_orders_expiring_products 
SELECT 
  DISTINCT r.order_id 
FROM 
  (
    rwl_opportunity_details r, order_details od
  ) 
  LEFT JOIN tmp_fin_bob_order_details bod ON bod.order_detail_id = od.order_detail_id 
WHERE 
  r.order_id = od.order_id 
  AND od.status = 0 
  AND r.account_id = od.account_id 
  AND r.academic_year_id = od.academic_year_id 
  AND r.expiring_product_id = od.product_id 
  AND (
    (
      od.end_date BETWEEN '$expire_start_date' 
      AND '$expire_end_date'
    ) 
    OR (
      bod.expiring_year = $year 
      AND bod.summer = 1
    )
  )</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:1466</td><td>CREATE TABLE rwl_after_next_year 
SELECT 
  DISTINCT r.order_id 
FROM 
  rwl_opportunity_details r, 
  academic_years ay1, 
  academic_years ay2 
WHERE 
  ay1.academic_year_id = r.new_academic_year_id 
  AND ay2.academic_year_id = '$next_academic_year_id' 
GROUP BY 
  r.order_id, 
  ay2.end_date 
HAVING 
  min(ay1.start_date) >= ay2.end_date</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:1552</td><td>CREATE TABLE rwl_opp_details_licenses 
SELECT 
  DISTINCT r.order_id 
FROM 
  rwl_opportunity_details r 
  JOIN products p ON r.product_id = p.product_id 
  LEFT JOIN pd_only_products po ON p.product_id = po.product_id 
WHERE 
  po.product_id IS NULL #not a PD product
  AND p.sku NOT REGEXP('IMP|SPT') #not fees
  AND p.product_group_id <> 31 #not a project management product
  AND p.product_group_id NOT IN(
    " . $PRODUCT_GROUPS[" discount "] . ", 
    " . $PRODUCT_GROUPS[" fee "] . "
  )</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:1621</td><td>CREATE TABLE renewal_opportunity_length 
SELECT 
  order_id, 
  COUNT(DISTINCT new_academic_year_id) contract_length 
FROM 
  rwl_opportunity_details r 
  JOIN academic_years ay on r.new_academic_year_id = ay.academic_year_id 
WHERE 
  r.price IS NOT NULL 
  AND ay.summer = 0 
GROUP BY 
  order_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:1644</td><td>CREATE TABLE renewal_opportunity_length2 
SELECT 
  e.account_id, 
  e.contact_id, 
  e.opportunity_product_id, 
  0 order_id, 
  MAX(r.contract_length) contract_length 
FROM 
  expiring_orders e, 
  renewal_opportunity_length r 
WHERE 
  e.order_id = r.order_id 
  AND e.no_renewal_group = 0 
GROUP BY 
  e.account_id, 
  e.contact_id, 
  e.opportunity_product_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:1705</td><td>CREATE TABLE renewal_quote_dates 
SELECT 
  order_id, 
  MIN(start_date) start_date, 
  MAX(end_date) end_date 
FROM 
  rwl_opportunity_details 
WHERE 
  start_date <> '' 
  AND end_date <> '' 
GROUP BY 
  order_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:1754</td><td>CREATE TABLE rwl_opportunity_total_schools 
SELECT 
  DISTINCT e.account_id, 
  e.contact_id, 
  e.opportunity_product_id, 
  0 order_id, 
  COUNT(distinct od.account_id) opp_total_schools 
FROM 
  expiring_orders e, 
  orders o, 
  order_details od, 
  accounts a 
WHERE 
  e.order_id = o.order_id 
  AND o.order_id = od.order_id 
  AND od.account_id = a.account_id 
  AND a.account_level = 2 
  /*AND no_quote_reasons > 0*/
  AND e.no_renewal_group = 0 
GROUP BY 
  e.account_id, 
  e.contact_id, 
  e.opportunity_product_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:1795</td><td>CREATE TABLE renewal_opportunity_num_schools 
SELECT 
  DISTINCT e.account_id, 
  e.contact_id, 
  e.opportunity_product_id, 
  0 order_id, 
  COUNT(distinct r.account_id) num_schools 
FROM 
  expiring_orders e, 
  rwl_opportunity_details r, 
  accounts a 
WHERE 
  e.order_id = r.order_id 
  AND r.account_id = a.account_id 
  AND a.parent_account_id = e.account_id 
  AND r.price IS NOT NULL 
  AND r.account_level = 2 
  AND e.no_renewal_group = 0 
GROUP BY 
  e.account_id, 
  e.contact_id, 
  e.opportunity_product_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:1870</td><td>CREATE TABLE renewal_payment_terms 
SELECT 
  expiring_orders.account_id, 
  expiring_orders.contact_id, 
  expiring_orders.opportunity_product_id, 
  0 order_id, 
  MIN(
    pmap.mapped_payment_term_option_id
  ) payment_term 
FROM 
  (expiring_orders, orders) 
  LEFT JOIN interlink.renewal_payment_term_option_mapping pmap ON pmap.payment_term_option_id = orders.payment_term 
WHERE 
  expiring_orders.order_id = orders.order_id 
  AND orders.payment_term != '' 
  AND expiring_orders.no_renewal_group = 0 
GROUP BY 
  expiring_orders.account_id, 
  expiring_orders.contact_id, 
  expiring_orders.opportunity_product_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:2078</td><td>CREATE TABLE rwl_tax_rates (
  KEY(order_id), 
  KEY(account_id), 
  KEY(contact_id), 
  KEY(opportunity_product_id)
) 
SELECT 
  0 order_id, 
  o.account_id, 
  o.contact_id, 
  o.opportunity_product_id, 
  a.state_code, 
  t.tax_rate, 
  t.sales_tax_id, 
  SUM(
    IFNULL(d.discount_percent, 0)
  ) discount_percent, 
  o.no_renewal_group 
FROM 
  (
    accounts a, expiring_orders o, sales_tax t, 
    account_address aa
  ) 
  LEFT JOIN rwl_opportunity_details od ON (
    o.order_id = od.order_id 
    AND od.product_group_id = '". $PRODUCT_GROUPS["discount"] . "'
  ) 
  LEFT JOIN discounts d 
  JOIN products p ON d.product_id = p.product_id 
  AND p.status = 0 
  AND '$expire_start_date' BETWEEN p.start_date 
  AND p.end_date ON (d.product_id = od.product_id) 
WHERE 
  a.account_id = o.account_id 
  AND a.state_code = t.state_code 
  AND (
    (
      t.county_id = a.county_id 
      AND (
        REPLACE(t.city, ' T.B.D.', '') = aa.city 
        OR t.city = ''
      )
    ) 
    OR (
      t.city = '' 
      AND t.county_id = 0
    )
  ) 
  AND NOW() BETWEEN t.start_date 
  AND t.end_date 
  AND a.account_id = aa.account_id 
  AND aa.address_type = 'M' 
  AND o.no_renewal_group = 0 
GROUP BY 
  o.account_id, 
  o.contact_id, 
  o.opportunity_product_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:2179</td><td>CREATE TABLE renewal_opportunity_totals 
SELECT 
  order_id, 
  SUM(price * quantity) total 
FROM 
  rwl_opportunity_details 
WHERE 
  price IS NOT NULL 
GROUP BY 
  order_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:2215</td><td>CREATE TABLE rwl_opportunities 
SELECT 
  GROUP_CONCAT(
    DISTINCT expiring_orders.order_id 
    order by 
      expiring_orders.order_id
  ) order_ids, 
  MAX(bae) bae, 
  concat(
    '" . $expire_year . " RENEWAL ', 
    if (
      op.opportunity_product_id IS NOT NULL, 
      concat(
        op.opportunity_product_name, ' '
      ), 
      ''
    ), 
    account_name, 
    ' ', 
    date_format(
      curdate(), 
      '%m%d%y'
    )
  ) opportunity_name, 
  expiring_orders.account_id, 
  expiring_orders.billing_account_id, 
  expiring_orders.contact_id, 
  expiring_orders.activation_contact_id, 
  expiring_orders.opportunity_product_id, 
  sales_rep, 
  16 probability_id, 
  SUM(projected_total) projected_total, 
  total_district_schools, 
  num_schools, 
  opp_total_schools, 
  expiring_order_length, 
  MAX(contract_length) contract_length, 
  payment_term, 
  MIN(
    NULLIF(expiring_orders.start_date, 0)
  ) start_date, 
  MAX(expiring_orders.end_date) end_date, 
  date_add(
    MIN(expiration_date), 
    interval -1 month
  ) expected_close, 
  7 lead_source_id, 
  door_opener, 
  customer_advocacy_executive, 
  sales_associate, 
  reseller, 
  MAX(non_standard_order) non_standard_order, 
  MAX(old_products) old_products, 
  MAX(future_order) future_order, 
  MAX(partial_expire) partial_expire, 
  MAX(overage) overage, 
  MAX(upgrade_products) upgrade_products, 
  MAX(summer_order) summer_order, 
  MAX(no_usage_data) no_usage_data, 
  MAX(kb100_old_order) kb100_old_order, 
  MAX(famis_order) famis_order, 
  MAX(no_license_products_no_contact) no_license_products_no_contact, 
  MAX(products_reallocated) products_reallocated, 
  MAX(no_quote_details) no_quote_details, 
  max(program_pricing) program_pricing, 
  min(program_pricing_only) program_pricing_only, 
  max(small_district_pricing) small_district_pricing, 
  min(expiring_order_date) expiring_order_date, 
  IFNULL(
    MIN(
      IF(
        expiring_order_po_date > 0, expiring_order_po_date, 
        NULL
      )
    ), 
    0
  ) expiring_order_po_date, 
  IFNULL(t.tax_rate, 0) tax_rate, 
  IFNULL(t.sales_tax_id, 0) sales_tax_id, 
  0 new_opportunity_id 
FROM 
  (expiring_orders, accounts) 
  LEFT JOIN opportunity_products op ON (
    op.opportunity_product_id = expiring_orders.opportunity_product_id 
    AND op.opportunity_product_id > 1
  ) 
  LEFT JOIN rwl_tax_rates t ON (
    t.no_renewal_group = 0 
    AND t.account_id = expiring_orders.account_id 
    AND t.contact_id = expiring_orders.contact_id 
    AND t.opportunity_product_id = expiring_orders.opportunity_product_id
  ) 
WHERE 
  expiring_orders.account_id = accounts.account_id 
  AND expiring_orders.no_renewal_group = 0 
GROUP BY 
  expiring_orders.account_id, 
  expiring_orders.contact_id, 
  expiring_orders.opportunity_product_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:2284</td><td>CREATE table rwl_opps_no_quote 
SELECT 
  p.order_ids expiring_orders 
FROM 
  rwl_opportunities p 
WHERE 
  
  /*upgrade_products > 0
      OR*/
  summer_order > 0 
  OR kb100_old_order > 0 
  OR no_quote_details > 0 
  OR no_license_products_no_contact > 0 
  OR projected_total = 0</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:2296</td><td>CREATE TABLE old_opps_no_quote 
SELECT 
  p.opportunity_id, 
  group_concat(
    distinct ro.order_id 
    order by 
      ro.order_id
  ) expiring_orders 
FROM 
  (
    opportunities p, renewal_opportunities ro
  ) 
  LEFT JOIN quotes q ON (
    p.opportunity_id = q.opportunity_id
  ) 
  LEFT JOIN rwl_opportunities p2 ON (
    p.opportunity_id = p2.new_opportunity_id
  ) 
WHERE 
  ro.opportunity_id = p.opportunity_id 
  AND q.opportunity_id is null 
  AND p2.new_opportunity_id is null 
  AND (
    p.probability_id > 1 
    OR year(p.date_entered) = '" . date(Y) . "'
  ) 
  AND year(p.close_date) = '$expire_year' 
  AND p.order_id = 0 
GROUP BY 
  p.opportunity_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:2505</td><td>CREATE TABLE renewal_quotes 
SELECT 
  0 new_quote_id, 
  new_opportunity_id, 
  account_id, 
  contact_id, 
  now() quote_date, 
  start_date, 
  end_date, 
  contract_length, 
  payment_term, 
  total_district_schools, 
  num_schools, 
  IF(
    old_products = 1 
    OR overage = 1 
    OR partial_expire = 1, 
    0, 
    1
  ) final, 
  famis_order, 
  opportunity_product_id, 
  sales_tax_id 
FROM 
  rwl_opportunities 
WHERE 
  new_opportunity_id > 0 
  /*AND upgrade_products = 0*/
  AND summer_order = 0 
  AND kb100_old_order = 0 
  AND no_quote_details = 0 
  AND no_license_products_no_contact = 0 
  AND projected_total > 0</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:2590</td><td>CREATE TABLE renewal_quotes_3year 
SELECT 
  q.opportunity_id, 
  r.new_quote_id single_year_quote_id, 
  q.account_id, 
  q.quote_date, 
  q.start_date, 
  date_add(q.end_date, interval 2 year) end_date, 
  '".$PAYMENT_TERMS["payment_plan"]."' payment_term, 
  r.sales_tax_id, 
  0 new_quote_id 
FROM 
  renewal_quotes r, 
  quotes q 
WHERE 
  r.new_quote_id = q.quote_id 
  AND contract_length = 1 
  AND r.final = 1 
  AND r.opportunity_product_id <> 2</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:2655</td><td>CREATE TABLE renewal_quote_details_3year 
SELECT 
  r1.new_quote_id, 
  r1.opportunity_id, 
  r2.account_id, 
  r2.product_id, 
  r2.summer_type_id, 
  r2.quantity, 
  r2.price, 
  r2.price_discountable, 
  r2.new_academic_year_id academic_year_id, 
  r2.start_date, 
  r2.end_date, 
  0 add_years, 
  CAST(
    0 as decimal(17, 8)
  ) discount_percent 
FROM 
  renewal_quotes_3year r1, 
  rwl_opportunity_details r2 
WHERE 
  r1.opportunity_id = r2.new_opportunity_id 
  AND r2.product_id > 0 
  AND r2.product_group_id NOT IN(28) 
  AND r2.product_id <> '" . SALES_TAX . "'</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:2700</td><td>CREATE TABLE renewal_quotes_3year_dates 
SELECT 
  new_quote_id, 
  MIN(start_date) quote_start, 
  max(end_date) quote_end 
FROM 
  renewal_quotes_3year 
GROUP BY 
  new_quote_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:2805</td><td>CREATE TABLE renewal_quotes_1year 
SELECT 
  q.opportunity_id, 
  r.new_quote_id multi_year_quote_id, 
  q.account_id, 
  q.quote_date, 
  q.start_date, 
  date_sub(
    q.end_date, 
    interval (contract_length - 1) year
  ) end_date, 
  0 payment_term, 
  r.sales_tax_id, 
  contract_length multi_year_contract_length, 
  min(
    if (
      ay.summer = 0, qd.academic_year_id, 
      null
    )
  ) min_academic_year, 
  max(
    if (
      ay.summer = 0, qd.academic_year_id, 
      null
    )
  ) max_academic_year, 
  max(
    if (
      ay.summer = 1, qd.academic_year_id, 
      null
    )
  ) max_summer_academic_year, 
  0 new_quote_id 
FROM 
  renewal_quotes r, 
  quotes q, 
  quote_details qd, 
  products p, 
  academic_years ay 
WHERE 
  r.new_quote_id = q.quote_id 
  AND contract_length > 1 
  /*AND r.final = 1*/
  AND q.quote_id = qd.quote_id 
  AND qd.academic_year_id > 0 
  AND p.product_id = qd.product_id 
  AND qd.academic_year_id = ay.academic_year_id 
GROUP BY 
  q.quote_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:2877</td><td>CREATE TABLE renewal_quote_details_1year 
SELECT 
  r1.new_quote_id, 
  r1.opportunity_id, 
  r2.account_id, 
  r2.product_id, 
  r2.summer_type_id, 
  r2.quantity, 
  r2.price, 
  r2.price_discountable, 
  r1.min_academic_year academic_year_id, 
  date_sub(
    r2.start_date, 
    interval (multi_year_contract_length - 1) year
  ) start_date, 
  date_sub(
    r2.end_date, 
    interval (multi_year_contract_length - 1) year
  ) end_date, 
  CAST(
    0 as decimal(17, 8)
  ) discount_percent 
FROM 
  renewal_quotes_1year r1, 
  rwl_opportunity_details r2 
WHERE 
  r1.opportunity_id = r2.new_opportunity_id 
  AND r2.product_id > 0 
  AND r2.product_group_id NOT IN(28) 
  AND r2.new_academic_year_id = r1.max_academic_year 
  AND r2.product_id <> '" . SALES_TAX . "'</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:2892</td><td>CREATE TABLE renewal_summer_years 
SELECT 
  DISTINCT ay.academic_year_id, 
  ay1.academic_year_id summer_year_before, 
  ay2.academic_year_id summer_year_after 
FROM 
  (academic_years ay) 
  LEFT JOIN academic_years ay1 ON (
    ay1.summer = 1 
    and ay1.start_date < ay.end_date 
    and ay1.end_date > ay.start_date 
    and ay1.end_date < ay.end_date
  ) 
  LEFT JOIN academic_years ay2 ON (
    ay2.summer = 1 
    and ay2.start_date < ay.end_date 
    and ay2.end_date > ay.start_date 
    and ay2.end_date > ay.end_date
  ) 
WHERE 
  ay.summer = 0</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:2925</td><td>CREATE TABLE renewal_quotes_1year_dates 
SELECT 
  new_quote_id, 
  MIN(start_date) quote_start, 
  max(end_date) quote_end 
FROM 
  renewal_quotes_1year 
GROUP BY 
  new_quote_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:3054</td><td>CREATE TABLE rwl_opportunity_totals 
SELECT 
  p.new_opportunity_id opportunity_id, 
  sum(qd.quantity * qd.price) quote_total 
FROM 
  rwl_opportunities p, 
  quotes q, 
  quote_details qd 
WHERE 
  p.new_opportunity_id = q.opportunity_id 
  AND q.final = 1 
  AND q.quote_id = qd.quote_id 
GROUP BY 
  opportunity_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/renewals.php:3089</td><td>CREATE TABLE rwl_opp_notes_special 
SELECT 
  DISTINCT ro.opportunity_id, 
  ro.order_id, 
  group_concat(distinct p.summer_type_id) summer_types, 
  a.account_id, 
  a.summer, 
  if (
    p.summer_type_id = 6, 
    'Summer products were on expiring order for a summer school, there are no summer products on this quote', 
    if (
      p.summer_type_id > 0 
      and p.summer_type_id < 6, 
      'Summer extension was part of expiring order, there are no summer products on this quote', 
      ''
    )
  ) notes 
FROM 
  (
    interlink.renewal_opportunities ro 
    INNER JOIN interlink.order_details od ON (ro.order_id = od.order_id)
  ) 
  INNER JOIN interlink.products p ON (
    od.product_id = p.product_id 
    and p.summer_type_id > 0
  ) 
  inner join accounts a on a.account_id = od.account_id 
  left join quotes q on q.opportunity_id = ro.opportunity_id 
  left join quote_details qd on qd.quote_id = q.quote_id 
  left join products p2 on p2.product_id = qd.product_id 
WHERE 
  (
    ro.date_entered > '$today' 
    and ro.entered_by = ".$USERS[" system_generated "]."
  ) 
  AND q.quote_id is not null 
group by 
  ro.opportunity_id 
having 
  count(distinct p2.summer_type_id) = 1</td><td></td><td></td></tr>
   <tr><td>reports/admin/usage_index.php:128</td><td>CREATE TEMPORARY TABLE temp_ ".$table_name." 
SELECT 
  entered_by, 
  count(distinct $id_field) total_ ".$table_name." 
FROM 
  $table_name 
WHERE 
  entered_by IN (".implode(", ", $user_list).") $whereStr 
  AND date_entered BETWEEN '$start_date' 
  AND '$end_date 23:59:59' 
GROUP BY 
  entered_by</td><td></td><td>skip</td></tr>
   <tr><td>reports/admin/usage_index.php:140</td><td>CREATE TEMPORARY TABLE temp_ytd 
SELECT 
  u.user_id, 
  COUNT(DISTINCT ytd.log_id) ytd_logins, 
  MAX(ytd.log_date) last_login 
FROM 
  login_log ytd 
  INNER JOIN users u ON u.user_id = ytd.user_id 
WHERE 
  ytd.log_date > CONCAT(
    YEAR(
      CURDATE()
    ), 
    '-01-01'
  ) 
  AND u.user_id IN (".implode(", ", $user_list).") 
  AND u.status = 0 
GROUP BY 
  u.user_id 
ORDER BY 
  u.user_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/amortization/view_amort_il_monthly_differences.php:19</td><td>CREATE TEMPORARY TABLE interlink.tmp_order_deferred (
  PRIMARY KEY(order_id)
) 
SELECT 
  CAST(
    SUBSTRING_INDEX(order_id, '-', 1) AS SIGNED
  ) order_id, 
  SUM(`Deferred Revenue`) deferred_revenue, 
  SUM(`This Month Billing`) this_month_billing 
FROM 
  amortization.{$report[ 'amortize_defer_table' ]} a 
GROUP BY 
  SUBSTRING_INDEX(order_id, '-', 1);</td><td></td><td>skip</td></tr>
   <tr><td>reports/amortization/view_amort_il_monthly_differences.php:26</td><td>CREATE TEMPORARY TABLE interlink.tmp_order_billed (
  PRIMARY KEY(order_id)
) 
SELECT 
  order_id, 
  SUM(month_billing) billed 
FROM 
  billing.billing_monthly 
WHERE 
  month_date = '$report_month' 
GROUP BY 
  1;</td><td></td><td>skip</td></tr>
   <tr><td>reports/billing/order_review_index.php:359</td><td>CREATE TEMPORARY TABLE tech.non_license_programs(
  PRIMARY KEY(order_id, program_id)
) 
SELECT 
  DISTINCT a.order_id, 
  IFNULL(p2.program_id, p.program_id) program_id, 
  IFNULL(p2.program_name, p.program_name) program_name 
FROM 
  interlink.order_detail_info_summary a 
  INNER JOIN interlink.programs p ON a.sub_program_id = p.program_id 
  LEFT JOIN interlink.programs p2 ON p.parent_id = p2.program_id 
WHERE 
  license_percent = 0</td><td></td><td>skip</td></tr>
   <tr><td>reports/billing/order_review_index.php:371</td><td>CREATE TEMPORARY TABLE tech.license_programs(
  PRIMARY KEY(order_id, program_id)
) 
SELECT 
  DISTINCT a.order_id, 
  IFNULL(p2.program_id, p.program_id) program_id, 
  IFNULL(p2.program_name, p.program_name) program_name 
FROM 
  interlink.order_detail_info_summary a 
  INNER JOIN interlink.programs p ON a.sub_program_id = p.program_id 
  LEFT JOIN interlink.programs p2 ON p.parent_id = p2.program_id 
WHERE 
  a.license_percent > 0 
  AND a.orig_program_id != 0</td><td></td><td>skip</td></tr>
   <tr><td>reports/billing/order_review_index.php:384</td><td>CREATE TEMPORARY TABLE tech.license_programs_by_order(
  PRIMARY KEY(order_id)
) 
SELECT 
  order_id, 
  GROUP_CONCAT(program_name) license_programs 
FROM 
  tech.license_programs 
GROUP BY 
  order_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/billing/order_review_index.php:462</td><td>CREATE TEMPORARY TABLE account_executive_user(
  PRIMARY KEY(
    account_executive_user_id, field_rvp_user_id
  )
) 
SELECT 
  a.user_id account_executive_user_id, 
  au.user_id field_rvp_user_id, 
  CONCAT(u.first_name, ' ', u.last_name) `field_rvp` 
FROM 
  commissions.account_executive_field_area a 
  INNER JOIN commissions.area_users au ON (
    a.area_id = au.area_id 
    AND LAST_DAY('$cmonth') BETWEEN au.start_date 
    AND au.end_date 
    AND au.mgmt = 1
  ) 
  INNER JOIN users u ON (au.user_id = u.user_id) 
WHERE 
  '$cmonth' >= '2020-01-01' 
  AND LAST_DAY('$cmonth') BETWEEN a.start_date 
  AND a.end_date;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/ay_product_line_values/generate_query_data.inc:17</td><td>CREATE $temporary TABLE tmp_pl_ay_order_detail_linked_cancels (
  PRIMARY KEY (order_detail_id) ".($show_detail_account ? ", 
  KEY(
    order_id, detail_account_id, cancel_id
  ) " : "")."
) 
SELECT 
  o.order_id, 
  od.order_detail_id, 
  ".($show_detail_account ? " od.account_id detail_account_id, 
  " : "")." MAX(
    COALESCE(ocd.cancel_id, ocf.cancel_id)
  ) cancel_id, 
  MAX(
    COALESCE(
      ocd.cancel_date, ocf.cancel_date
    )
  ) cancel_date 
FROM 
  interlink.orders o 
  INNER JOIN interlink.order_details od ON od.order_id = o.order_id 
  LEFT JOIN interlink.order_cancels ocf ON ocf.order_id = o.order_id 
  AND ocf.credit_type = 'F' 
  AND o.status = 1 
  AND ocf.cancel_date <= @end_date 
  LEFT JOIN interlink.order_cancels ocd ON ocd.cancel_id = od.cancel_id 
  AND ocd.cancel_date <= @end_date 
  LEFT JOIN interlink.mh_orders mho ON mho.order_id = o.order_id 
  AND mho.is_post_integration_order = 1 
WHERE 
  (
    ocf.cancel_id IS NOT NULL 
    OR ocd.cancel_id IS NOT NULL
  ) 
  AND mho.order_id IS NULL 
GROUP BY 
  od.order_detail_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/ay_product_line_values/generate_query_data.inc:35</td><td>CREATE $temporary TABLE tmp_pl_ay_amort_revenue_by_component (
  PRIMARY KEY (order_detail_id, cancel_id), 
  INDEX (order_id)
) 
SELECT 
  order_id, 
  cancel_id, 
  order_detail_id, 
  SUM(period_total) revenue_total, 
  SUM(
    CASE WHEN sub_product_type_id NOT IN (4, 5, 14, 24, 6, 7, 8) THEN period_total ELSE 0 END
  ) license_revenue, 
  SUM(
    CASE WHEN sub_product_type_id IN (4, 5) THEN period_total ELSE 0 END
  ) onsite_pd_revenue, 
  SUM(
    CASE WHEN sub_product_type_id IN (14, 24) THEN period_total ELSE 0 END
  ) online_pd_revenue, 
  SUM(
    CASE WHEN sub_product_type_id IN (6) THEN period_total ELSE 0 END
  ) imf_revenue, 
  SUM(
    CASE WHEN sub_product_type_id IN (7, 8) THEN period_total ELSE 0 END
  ) pm_revenue 
FROM 
  amortization.order_detail_amortization 
GROUP BY 
  order_detail_id, 
  cancel_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/ay_product_line_values/generate_query_data.inc:94</td><td>CREATE $temporary TABLE tmp_pl_ay_bae_order_site_counts (
  PRIMARY KEY (
    order_id, academic_year_id ".($show_detail_account ? ", 
    detail_account_id " : "")."
  )
) 
SELECT 
  odi.order_id, 
  ".($show_detail_account ? " od.account_id detail_account_id, 
  " : "")." revised_academic_year_id academic_year_id, 
  0 cancel_id, 
  COUNT(DISTINCT account_id) bae_site_count 
FROM 
  interlink.order_detail_info_summary odi 
  INNER JOIN interlink.order_details od ON od.order_detail_id = odi.order_detail_id 
WHERE 
  odi.sub_program_id = 12 
GROUP BY 
  odi.order_id, 
  revised_academic_year_id ".($show_detail_account ? ", 
  detail_account_id " : "").";</td><td></td><td></td></tr>
   <tr><td>reports/finance/ay_product_line_values/generate_query_data.inc:106</td><td>CREATE $temporary TABLE tmp_pl_ay_order_bae_linked_cancels (
  PRIMARY KEY (
    order_id, academic_year_id, cancel_id ".($show_detail_account ? ", 
    detail_account_id " : "")."
  ), 
  INDEX (row_num)
) 
SELECT 
  b.*, 
  @n := @n + 1 row_num, 
  0 site_cancel_count 
FROM 
  (
    SELECT 
      od.order_id, 
      ".($show_detail_account ? " od.detail_account_id, 
      " : "")." revised_academic_year_id academic_year_id, 
      cancel_id, 
      cancel_date 
    FROM 
      tmp_pl_ay_order_detail_linked_cancels od 
      INNER JOIN interlink.order_detail_info_summary odi ON odi.order_detail_id = od.order_detail_id CROSS 
      JOIN (
        SELECT 
          @n := 0
      ) r 
    WHERE 
      odi.sub_program_id = 12 
    GROUP BY 
      order_id, 
      academic_year_id, 
      cancel_id ".($show_detail_account ? ", 
      detail_account_id " : "")." 
    ORDER BY 
      cancel_date, 
      cancel_id
  ) b;</td><td></td><td></td></tr>
   <tr><td>reports/finance/ay_product_line_values/generate_query_data.inc:123</td><td>CREATE TEMPORARY TABLE tmp_pl_ay_order_bae_account_cancels (
  PRIMARY KEY (
    order_id, academic_year_id, cancel_id ".($show_detail_account ? ", 
    detail_account_id " : "")."
  )
) 
SELECT 
  bc.order_id, 
  bc.cancel_id, 
  ".($show_detail_account ? " od2.account_id detail_account_id, 
  " : "")." bc.academic_year_id, 
  bc.cancel_date, 
  COUNT(DISTINCT od2.account_id) accounts_uncancelled 
FROM 
  tmp_pl_ay_order_bae_linked_cancels bc -- bae details uncancelled after odc cancel date
  INNER JOIN interlink.order_detail_info_summary odi2 ON odi2.order_id = bc.order_id 
  AND odi2.revised_academic_year_id = bc.academic_year_id 
  INNER JOIN interlink.order_details od2 ON od2.order_detail_id = odi2.order_detail_id 
  LEFT JOIN tmp_pl_ay_order_detail_linked_cancels odc ON odc.order_detail_id = od2.order_detail_id 
WHERE 
  odi2.sub_program_id = 12 
  AND (
    odc.cancel_id IS NULL 
    OR odc.cancel_date > bc.cancel_date
  ) 
GROUP BY 
  bc.order_id, 
  bc.academic_year_id, 
  bc.cancel_id ".($show_detail_account ? ", 
  detail_account_id " : "").";;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/ay_product_line_values/generate_query_data.inc:141</td><td>CREATE TEMPORARY TABLE tmp_pl_ay_order_bae_account_cancels_before (
  PRIMARY KEY (
    order_id, academic_year_Id, cancel_id ".($show_detail_account ? ", 
    detail_account_id " : "")."
  )
) 
SELECT 
  bc.order_id, 
  bc.cancel_id, 
  ".($show_detail_account ? " od2.account_id detail_account_id, 
  " : "")." bc.academic_year_id, 
  bc.cancel_date, 
  COUNT(DISTINCT od2.account_id) accounts_uncancelled 
FROM 
  tmp_pl_ay_order_bae_linked_cancels bc -- bae details uncancelled before odc cancel date
  INNER JOIN interlink.order_detail_info_summary odi2 ON odi2.order_id = bc.order_id 
  AND odi2.revised_academic_year_id = bc.academic_year_id 
  INNER JOIN interlink.order_details od2 ON od2.order_detail_id = odi2.order_detail_id 
  LEFT JOIN tmp_pl_ay_order_detail_linked_cancels odc ON odc.order_detail_id = od2.order_detail_id 
WHERE 
  odi2.sub_program_id = 12 
  AND (
    odc.cancel_id IS NULL 
    OR (
      odc.cancel_date >= bc.cancel_date 
      AND NOT(
        odc.cancel_date = bc.cancel_date 
        AND odc.cancel_id < bc.cancel_id
      )
    )
  ) 
GROUP BY 
  order_id, 
  academic_year_id, 
  cancel_id ".($show_detail_account ? ", 
  od2.account_id " : "").";</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/ay_product_line_values/generate_query_data.inc:171</td><td>CREATE $temporary TABLE tmp_pl_ay_bae_lit_license_counts (
  PRIMARY KEY (
    order_id, account_id, academic_year_id
  )
) 
SELECT 
  odi.order_id, 
  od.account_id, 
  revised_academic_year_id academic_year_id, 
  SUM(
    CASE WHEN sub_program_id = 1 THEN license_count ELSE 0 END
  ) literacy_license_count, 
  SUM(
    CASE WHEN sub_program_id = 12 THEN license_count ELSE 0 END
  ) bae_license_count, 
  MAX(
    CASE WHEN sub_program_id = 1 THEN 1 ELSE 0 END
  ) has_literacy, 
  MAX(
    CASE WHEN sub_program_id = 12 THEN 1 ELSE 0 END
  ) has_bae, 
  MAX(
    CASE WHEN sub_program_id = 12 
    AND expander_type = 'expander' 
    AND odc.order_detail_id IS NULL THEN 1 ELSE 0 END
  ) has_bae_student_site_expander, 
  MAX(
    CASE WHEN sub_program_id = 12 
    AND expander_type = 'teacher expander' 
    AND odc.order_detail_id IS NULL THEN 1 ELSE 0 END
  ) has_bae_teacher_expander, 
  MAX(
    CASE WHEN sub_program_id = 12 
    AND expander_type = 'teacher expander' 
    AND odc.order_detail_id IS NULL THEN od.quantity ELSE 0 END
  ) bae_teacher_expander_qty 
FROM 
  interlink.order_detail_info_summary odi 
  INNER JOIN interlink.order_details od ON od.order_detail_id = odi.order_detail_id 
  INNER JOIN interlink.orders o ON o.order_id = od.order_id 
  LEFT JOIN tmp_pl_ay_order_detail_linked_cancels odc ON odc.order_detail_id = odi.order_detail_id 
WHERE 
  1 
GROUP BY 
  odi.order_id, 
  account_id, 
  revised_academic_year_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/ay_product_line_values/generate_query_data.inc:192</td><td>CREATE TEMPORARY TABLE tmp_pl_ay_copy_bae_license_to_literacy (
  PRIMARY KEY (order_detail_id)
) 
SELECT 
  od.order_detail_id 
FROM 
  tmp_pl_ay_bae_lit_license_counts lc 
  INNER JOIN interlink.order_detail_info_summary odi ON odi.revised_academic_year_id = lc.academic_year_id 
  AND odi.order_id = lc.order_id 
  INNER JOIN interlink.order_details od ON od.order_detail_id = odi.order_detail_id 
  AND od.account_id = lc.account_id 
  AND od.order_id = lc.order_id 
WHERE 
  lc.bae_license_count > 0 
  AND odi.expander_type <> 'tiered pricing' 
GROUP BY 
  od.order_detail_id;;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/ay_product_line_values/generate_query_data.inc:214</td><td>CREATE TEMPORARY TABLE tmp_pl_ay_cross_order_license_counts (
  PRIMARY KEY (account_id, academic_year_id)
) 
SELECT 
  od.account_id, 
  revised_academic_year_id academic_year_id, 
  SUM(
    CASE WHEN sub_program_id = 1 THEN license_count ELSE 0 END
  ) literacy_license_count #,
  #SUM(CASE WHEN sub_program_id=12 THEN license_count ELSE 0 END ) bae_license_count
FROM 
  interlink.order_detail_info_summary odi 
  INNER JOIN interlink.order_details od ON od.order_detail_id = odi.order_detail_id 
  INNER JOIN interlink.orders o ON o.order_id = odi.order_id 
  LEFT JOIN tmp_pl_ay_order_detail_linked_cancels odc ON odc.order_detail_id = odi.order_detail_id 
WHERE 
  o.order_date <= @end_date 
  AND odc.order_detail_id IS NULL 
GROUP BY 
  account_id, 
  revised_academic_year_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/ay_product_line_values/generate_query_data.inc:231</td><td>CREATE TEMPORARY TABLE tmp_pl_ay_bae_expander_license_count (
  PRIMARY KEY (
    order_id, academic_year_id ".($show_detail_account ? ", 
    detail_account_id " : "")."
  )
) 
SELECT 
  b.academic_year_id, 
  b.order_id, 
  ".($show_detail_account ? " b.account_id detail_account_id, 
  " : "")." SUM(
    CASE WHEN b.bae_license_count = 0 
    AND b.has_bae_student_site_expander = 1 THEN c.literacy_license_count WHEN b.bae_license_count = 0 
    AND b.has_bae_teacher_expander = 1 THEN 20 * b.bae_teacher_expander_qty ELSE 0 END
  ) license_count 
FROM 
  tmp_pl_ay_bae_lit_license_counts b 
  INNER JOIN tmp_pl_ay_cross_order_license_counts c ON c.account_id = b.account_id 
  AND c.academic_year_id = b.academic_year_id 
GROUP BY 
  order_id, 
  academic_year_id ".($show_detail_account ? ", 
  b.account_id " : "").";</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/ay_product_line_values/generate_query_data.inc:342</td><td>CREATE TEMPORARY TABLE tech.detail_account_order_info(
  PRIMARY KEY(
    order_id, cancel_id, `Detail Account ID`
  )
) 
SELECT 
  order_id, 
  cancel_id, 
  `Detail Account ID`, 
  SUM(`List Total`) `List Total`, 
  SUM(`Standard Discount`) `Standard Discount`, 
  SUM(`Non Standard Discount`) `Non Standard Discount`, 
  SUM(`TCV Detail Total Less Tax`) `TCV Detail Total Less Tax`, 
  SUM(`TCV Detail Total`) `TCV Detail Total`, 
  SUM(`TCV New Total`) `TCV New Total`, 
  SUM(`TCV Renew Total`) `TCV Renew Total`, 
  SUM(`TCV Sales Tax`) `TCV Sales Tax` 
FROM 
  amortization.booking_report_order_accounts 
GROUP BY 
  order_id, 
  cancel_id, 
  `Detail Account ID`;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/ay_product_line_values/generate_query_data.inc:427</td><td>CREATE $temporary TABLE tmp_pl_filtered_order_list (
  PRIMARY KEY (order_id)
) 
SELECT 
  odi.order_id 
FROM 
  interlink.order_detail_info_summary odi 
  INNER JOIN interlink.order_details od ON od.order_detail_id = odi.order_detail_id 
  INNER JOIN interlink.orders o ON o.order_id = odi.order_id 
  INNER JOIN interlink.accounts oa ON oa.account_id = o.account_id 
  INNER JOIN interlink.accounts od_a ON od_a.account_id = od.account_id 
  LEFT JOIN interlink.accounts ob_a ON ob_a.account_id = o.billing_account_id 
  INNER JOIN interlink.academic_years ay ON ay.academic_year_id = odi.revised_academic_year_id 
  INNER JOIN amortization.booking_report_order_w_discounts bo ON bo.order_id = odi.order_id 
  AND bo.cancel_id = 0 
WHERE 
  1 $selected_academic_year_where $selected_district_where $selected_sub_programs_components_where ".(($orders > "") ? " 
  AND o.order_id IN ($orders) " : "")." 
GROUP BY 
  order_id;</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:207</td><td>CREATE $temp TABLE renewal_targets_$table_suffix 
SELECT 
  t.account_id, 
  t.order_id, 
  t.opportunity_product_id, 
  concat(u.first_name, ' ', u.last_name) account_owner, 
  t.renewal_quota, 
  max(od.end_date) order_end_date, 
  if (
    p.account_id is not null, p.account_id, 
    a.account_id
  ) district_account_id 
FROM 
  (
    renewal_targets_old t, order_details od, 
    accounts a
  ) 
  LEFT JOIN region_states rs on (
    rs.state_code = a.state_code 
    AND rs.region_id IN (
      " . implode(", ", array_keys(get_region_list($DEPARTMENT[" sales "]))) . "
    )
  ) 
  LEFT JOIN accounts p ON (
    p.account_id = a.parent_account_id
  ) 
  LEFT JOIN users u ON (
    u.user_id = t.account_owner_user_id
  ) 
WHERE 
  t.date_entered = '$target_version' 
  AND t.order_id = od.order_id 
  AND od.status = 0 
  AND a.account_id = t.account_id $whereStr 
GROUP BY 
  t.account_id, 
  t.order_id, 
  t.opportunity_product_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:233</td><td>CREATE $temp TABLE has_licenses_$table_suffix 
SELECT 
  a.account_id, 
  a.order_id, 
  max(
    if (sp.sub_product_type_id = 1, 1, 0)
  ) licenses 
FROM 
  renewal_targets_$table_suffix a, 
  order_details b, 
  products p, 
  sub_products sp 
WHERE 
  a.order_id = b.order_id 
  AND a.account_id = b.account_id 
  AND b.status = 0 
  AND year(b.end_date) = '$target_year' 
  AND p.product_id = b.product_id 
  AND p.product_group_id <> '" . $PRODUCT_GROUPS["discount"] . "' 
  AND p.product_id = sp.product_id 
GROUP BY 
  a.account_id, 
  a.order_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:257</td><td>CREATE $temp TABLE non_license_products_$table_suffix 
SELECT 
  DISTINCT o.account_id, 
  o.order_id, 
  p.product_group_id 
FROM 
  products p, 
  order_details od, 
  renewal_targets_$table_suffix o 
WHERE 
  o.order_id = od.order_id 
  AND o.licenses = 0 
  AND o.account_id = od.account_id 
  AND p.product_id = od.product_id 
  AND od.status = 0 
  AND year(od.end_date) = '$target_year' 
  AND p.product_group_id <> '" . $PRODUCT_GROUPS["discount"] . "'</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:275</td><td>CREATE $temp table target_renewal_opportunities_$table_suffix 
SELECT 
  DISTINCT t.order_id, 
  t.account_id, 
  ro.opportunity_id 
FROM 
  renewal_targets_$table_suffix t, 
  renewal_opportunities ro 
WHERE 
  t.order_id = ro.order_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:299</td><td>CREATE 
/*$temp*/
table quotes_future_$table_suffix 
SELECT 
  DISTINCT b.account_id, 
  o.order_id, 
  c.opportunity_id, 
  c.probability_id, 
  c.order_id renewal_order_id, 
  opm.opportunity_product_id, 
  a.quote_id, 
  a.final, 
  a.date_entered 
FROM 
  (
    quotes a, quote_details b, opportunities c, 
    opportunity_product_map opm, products p, 
    sub_products sp, renewal_targets_$table_suffix o
  ) 
  LEFT JOIN non_license_products_$table_suffix nl ON (
    o.order_id = nl.order_id 
    AND o.account_id = nl.account_id
  ) 
  LEFT JOIN renewal_opportunities ro ON (
    c.opportunity_id = ro.opportunity_id 
    AND ro.order_id = o.order_id
  ) 
  LEFT JOIN target_renewal_opportunities_$table_suffix tro ON (
    c.opportunity_id = tro.opportunity_id 
    AND o.account_id = tro.account_id
  ) 
  LEFT JOIN user_orders uo ON (
    c.opportunity_id = uo.opportunity_id 
    AND uo.role_id = 6
  ) 
  LEFT JOIN user_accounts ua ON (
    uo.user_id = ua.user_id 
    AND ua.account_id = b.account_id 
    AND ua.role_id = 25
  ) 
  LEFT JOIN orders o2 ON (
    o2.order_id = c.order_id 
    AND o2.date_entered <= '$run_date'
  ) 
WHERE 
  a.quote_id = b.quote_id 
  AND c.opportunity_id = a.opportunity_id 
  AND p.product_id = b.product_id 
  AND p.product_id = sp.product_id 
  /*AND ((o.licenses = 1 AND sp.sub_product_type_id = 1)
                  OR (o.licenses = 0 AND nl.product_group_id = p.product_group_id))*/
  AND (
    c.lead_source_id = 7 
    OR ua.user_id IS NOT NULL
  ) 
  AND o.account_id = b.account_id 
  AND b.academic_year_id = '$next_academic_year_id' 
  AND c.opportunity_id = opm.opportunity_id 
  AND o.opportunity_product_id = opm.opportunity_product_id 
  AND (
    ro.opportunity_id IS NOT NULL 
    OR tro.opportunity_id IS NULL
  ) 
  AND o.order_id <> c.order_id 
  AND a.date_entered <= '$run_date' 
  and o2.order_id IS NULL</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:380</td><td>CREATE $temp TABLE probability_history1_$table_suffix (
  key(opportunity_id)
) 
SELECT 
  q.opportunity_id, 
  SUBSTRING_INDEX(
    MAX(
      CONCAT(h.date_entered, '|', h.new_value)
    ), 
    '|', 
    -1
  ) probability_id 
FROM 
  quotes_future_$table_suffix q, 
  history_log h 
WHERE 
  q.opportunity_id = h.record_id 
  AND h.table_name = 'opportunities' 
  AND h.column_name = 'probability_id' 
  AND h.date_entered <= '$run_date' 
GROUP BY 
  q.opportunity_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:397</td><td>CREATE $temp TABLE probability_history2_$table_suffix (
  key(opportunity_id)
) 
SELECT 
  q.opportunity_id, 
  SUBSTRING_INDEX(
    MIN(
      CONCAT(h.date_entered, '|', h.old_value)
    ), 
    '|', 
    -1
  ) probability_id 
FROM 
  quotes_future_$table_suffix q, 
  history_log h 
WHERE 
  q.opportunity_id = h.record_id 
  AND h.table_name = 'opportunities' 
  AND h.column_name = 'probability_id' 
  AND h.date_entered > '$run_date' 
GROUP BY 
  q.opportunity_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:417</td><td>CREATE $temp table opps_future_$table_suffix 
SELECT 
  q.account_id, 
  q.order_id, 
  q.opportunity_id, 
  q.opportunity_product_id, 
  group_concat(
    distinct if (
      op.probability_percent = 1 
      and od.order_id IS NULL, 
      10, 
      round(op.probability_percent * 100)
    ) separator '; '
  ) status, 
  od.order_id renewal_order_id, 
  od.order_date renewal_order_date 
FROM 
  (
    quotes_future_$table_suffix q, opportunity_probabilities op
  ) 
  LEFT JOIN orders od on (
    od.order_id = q.renewal_order_id 
    AND od.status = 0
  ) 
WHERE 
  op.probability_id = q.probability_id 
  AND (
    q.final = 1 
    or q.date_entered >= '" . date("Y-m-d", mktime(0,0,0,date(m,strtotime($run_date))-3, 1, date(Y,strtotime($run_date)))) . "'
  ) 
GROUP BY 
  q.account_id, 
  q.order_id, 
  q.opportunity_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:467</td><td>CREATE $temp table opps_to_delete_$table_suffix 
SELECT 
  account_id, 
  order_id, 
  opportunity_id 
FROM 
  opps_future_$table_suffix 
WHERE 
  status = '0'</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:517</td><td>CREATE $temp TABLE district_school_opps_$table_suffix 
SELECT 
  t.account_id, 
  t.order_id, 
  max(p.status) school_opp_status 
FROM 
  renewal_targets_$table_suffix t, 
  opps_future_$table_suffix p, 
  accounts a1, 
  accounts a2 
WHERE 
  t.order_id = p.order_id 
  AND a1.account_id = t.account_id 
  AND a1.account_level = 1 
  AND a2.account_id = p.account_id 
  AND a2.account_level = 2 
  AND t.opportunity_product_id = p.opportunity_product_id 
GROUP BY 
  t.account_id, 
  t.order_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:541</td><td>CREATE $temp TABLE district_opps_future_$table_suffix 
SELECT 
  DISTINCT d.account_id, 
  d.order_id, 
  p.opportunity_id, 
  p.opportunity_product_id, 
  p.status, 
  p.renewal_order_id, 
  p.renewal_order_date, 
  p.quote_id 
FROM 
  opps_future_$table_suffix p, 
  district_school_opps_$table_suffix d 
WHERE 
  d.order_id = p.order_id 
  AND d.school_opp_status = p.status</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:556</td><td>CREATE $temp table projected_totals_$table_suffix 
SELECT 
  DISTINCT qd.quote_id, 
  qd.account_id, 
  p.renewal_order_id, 
  (
    sum(qd.price * qd.quantity)
  ) quote_total, 
  (
    sum(qd.price * qd.quantity)
  ) multi_year_quote_total 
FROM 
  opps_future_$table_suffix p, 
  quote_details qd, 
  products pr, 
  academic_years ay 
WHERE 
  p.quote_id = qd.quote_id 
  AND p.account_id = qd.account_id 
  AND pr.product_id = qd.product_id 
  AND ay.academic_year_id = qd.academic_year_id 
  AND pr.product_group_id <> '" . $PRODUCT_GROUPS["discount"] . "' " . ($report_id == $REPORTS[" renewal_progress "] ? "" : " 
  AND p.status > 10 ") . " 
  AND p.renewal_order_id IS NULL 
GROUP BY 
  p.order_id, 
  qd.quote_id, 
  qd.account_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:590</td><td>CREATE $temp table projected_totals_1_year_$table_suffix 
SELECT 
  qd.quote_id, 
  qd.account_id, 
  (
    sum(qd.price * qd.quantity)
  ) quote_total 
FROM 
  projected_totals_$table_suffix t, 
  quote_details qd, 
  products pr 
WHERE 
  t.quote_id = qd.quote_id 
  AND t.account_id = qd.account_id 
  AND pr.product_id = qd.product_id 
  AND pr.product_group_id <> '" . $PRODUCT_GROUPS["discount"] . "' 
  AND qd.academic_year_id = '$next_academic_year_id' 
  AND t.renewal_order_id is null 
GROUP BY 
  qd.quote_id, 
  qd.account_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:631</td><td>CREATE $temp table quotes_$table_suffix 
SELECT 
  DISTINCT quote_id, 
  renewal_order_id 
FROM 
  opps_future_$table_suffix 
WHERE 
  quote_id > 0</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:641</td><td>CREATE $temp table quote_totals_$table_suffix 
SELECT 
  qd.quote_id, 
  q.renewal_order_id, 
  (
    sum(qd.price * qd.quantity)
  ) quote_total 
FROM 
  quotes_$table_suffix q, 
  quote_details qd, 
  products pr 
WHERE 
  q.quote_id = qd.quote_id 
  AND pr.product_id = qd.product_id 
  AND pr.product_group_id <> '" . $PRODUCT_GROUPS["discount"] . "' 
  AND q.renewal_order_id IS NULL 
GROUP BY 
  qd.quote_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:665</td><td>CREATE $temp table discounts_$table_suffix 
SELECT 
  distinct q.quote_id, 
  q.quote_total, 
  (
    sum(qd.price)*-1
  ) total_discount, 
  (
    (
      sum(qd.price)*-1
    )/(q.quote_total)
  ) discount_percent 
FROM 
  quote_totals_$table_suffix q, 
  quote_details qd, 
  products pr 
WHERE 
  q.quote_id = qd.quote_id 
  AND pr.product_id = qd.product_id 
  AND pr.product_group_id = '" . $PRODUCT_GROUPS["discount"] . "' 
  AND q.renewal_order_id IS NULL 
GROUP BY 
  q.quote_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:696</td><td>CREATE $temp TABLE credits_$table_suffix 
SELECT 
  q.quote_id, 
  q.quote_total, 
  sum(oc.credit_amount) credit_amount, 
  d.total_discount 
FROM 
  (
    quote_totals_$table_suffix q, order_cancels oc
  ) 
  LEFT JOIN discounts_$table_suffix d ON (q.quote_id = d.quote_id) 
WHERE 
  q.renewal_order_id = oc.order_id 
GROUP BY 
  q.quote_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:722</td><td>CREATE $temp table projected_totals_discounts_$table_suffix 
SELECT 
  pt.quote_id, 
  pt.account_id, 
  d.quote_total, 
  d.total_discount, 
  d.discount_percent, 
  pt.quote_total account_total, 
  if (
    pt.quote_id IS NOT NULL, 
    if (
      d.discount_percent, 
      (
        pt.quote_total -(
          pt.quote_total * d.discount_percent
        )
      ), 
      pt.quote_total
    ), 
    ''
  ) projected_total, 
  if (
    pt.quote_id IS NOT NULL 
    AND pt.quote_total <> pt.multi_year_quote_total, 
    if (
      d.discount_percent, 
      (
        pt.multi_year_quote_total -(
          pt.multi_year_quote_total * d.discount_percent
        )
      ), 
      pt.multi_year_quote_total
    ), 
    'N/A'
  ) multi_year_projected_total 
FROM 
  projected_totals_$table_suffix pt 
  LEFT JOIN discounts_$table_suffix d ON (d.quote_id = pt.quote_id)</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:737</td><td>CREATE $temp table projected_totals_by_status_$table_suffix 
SELECT 
  t.account_id, 
  t.order_id, 
  op.status, 
  substring_index(
    min(
      concat(
        if (
          op.renewal_order_id is not null, 0, 
          1
        ), 
        '|', 
        pt.projected_total, 
        '|', 
        pt.quote_id
      )
    ), 
    '|', 
    -1
  ) quote_id 
FROM 
  renewal_targets_$table_suffix t, 
  opps_future_$table_suffix op, 
  projected_totals_discounts_$table_suffix pt 
WHERE 
  t.account_id = op.account_id 
  AND t.order_id = op.order_id 
  AND op.quote_id = pt.quote_id 
  AND op.account_id = pt.account_id 
GROUP BY 
  t.account_id, 
  t.order_id, 
  op.status</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:753</td><td>CREATE $temp TABLE user_accounts_renewal_rep_$table_suffix 
SELECT 
  DISTINCT ua.account_id, 
  u.user_id, 
  concat(u.first_name, ' ', u.last_name) renewal_rep 
FROM 
  user_accounts ua, 
  users u, 
  renewal_targets_$table_suffix t 
WHERE 
  t.account_id = ua.account_id 
  AND u.user_id = ua.user_id 
  AND ua.role_id = '" . $ROLE[$DEPARTMENT["sales"]]["renewal_rep"] . "'</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:764</td><td>CREATE $temp TABLE user_accounts_sales_rep_$table_suffix 
SELECT 
  DISTINCT ua.account_id, 
  u.user_id, 
  concat(u.first_name, ' ', u.last_name) sales_rep 
FROM 
  user_accounts ua, 
  users u, 
  renewal_targets_$table_suffix t 
WHERE 
  t.account_id = ua.account_id 
  AND u.user_id = ua.user_id 
  AND ua.role_id = '" . $ROLE[$DEPARTMENT["sales"]]["sales_rep"] . "'</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:871</td><td>CREATE $temp TABLE renewal_progress_data_$table_suffix 
SELECT 
  d.state_code, 
  d.renewal_rep, 
  d.district_account_id, 
  d.school_account_id, 
  sum(d.renewal_target) renewal_target, 
  d.opportunity_id, 
  d.max_opportunity_status, 
  max(
    if(d.renewal_order_id is null, 0, 1)
  ) renewal_order, 
  d.projected_total_quote_id, 
  min(d.projected_total) projected_total 
FROM 
  renewal_candidate_data_$table_suffix d 
GROUP BY 
  d.state_code, 
  d.district_account_id, 
  d.school_account_id, 
  d.opportunity_id, 
  d.projected_total_quote_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:884</td><td>CREATE $temp table renewal_orders_$table_suffix 
SELECT 
  DISTINCT op.renewal_order_id order_id 
FROM 
  renewal_candidate_data_$table_suffix o, 
  opps_future_$table_suffix op 
WHERE 
  op.account_id = o.account_id 
  AND op.order_id = o.order_id 
  AND op.renewal_order_id > 0</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:895</td><td>CREATE $temp table expansion_orders_$table_suffix 
SELECT 
  DISTINCT od.order_id 
FROM 
  (
    orders o, order_details od, accounts a, 
    renewal_targets_$table_suffix t, 
    user_orders uo, user_accounts ua
  ) 
  LEFT JOIN renewal_orders_$table_suffix ro ON (o.order_id = ro.order_id) 
  LEFT JOIN accounts p ON (
    p.account_id = a.parent_account_id
  ) 
WHERE 
  o.order_id = od.order_id 
  AND o.status = 0 
  AND od.status = 0 
  AND od.academic_year_id = '$next_academic_year_id' 
  AND a.account_id = od.account_id 
  AND IF (
    p.account_id IS NOT NULL, p.account_id, 
    a.account_id
  ) = t.district_account_id 
  AND ro.order_id IS NULL 
  AND o.order_id = uo.order_id 
  AND uo.role_id = 6 
  AND o.account_id = ua.account_id 
  AND ua.role_id = 25 
  AND uo.user_id = ua.user_id 
  AND year(o.order_date) >= '$target_year' 
  AND o.date_entered <= '$run_date'</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:922</td><td>CREATE $temp table order_account_totals_$table_suffix 
SELECT 
  od.order_id, 
  od.account_id, 
  (
    sum(od.price * od.quantity)
  ) order_total 
FROM 
  renewal_orders_$table_suffix o, 
  order_details od, 
  products pr 
WHERE 
  o.order_id = od.order_id 
  AND pr.product_id = od.product_id 
  AND pr.product_group_id <> '" . $PRODUCT_GROUPS["discount"] . "' 
  AND od.status = 0 
GROUP BY 
  od.order_id, 
  od.account_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:938</td><td>CREATE $temp table order_totals_$table_suffix 
SELECT 
  od.order_id, 
  (
    sum(od.price * od.quantity)
  ) order_total 
FROM 
  renewal_orders_$table_suffix o, 
  order_details od, 
  products pr 
WHERE 
  o.order_id = od.order_id 
  AND pr.product_id = od.product_id 
  AND pr.product_group_id <> '" . $PRODUCT_GROUPS["discount"] . "' 
GROUP BY 
  od.order_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:950</td><td>CREATE $temp table order_discounts_$table_suffix (
  discount_percent decimal(25, 23)
) 
SELECT 
  distinct o.order_id, 
  o.order_total, 
  (
    sum(od.price)*-1
  ) total_discount, 
  (
    (
      sum(od.price)*-1
    )/(o.order_total)
  ) discount_percent 
FROM 
  order_totals_$table_suffix o, 
  order_details od, 
  products pr 
WHERE 
  o.order_id = od.order_id 
  AND pr.product_id = od.product_id 
  AND pr.product_group_id = '" . $PRODUCT_GROUPS["discount"] . "' 
GROUP BY 
  o.order_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:966</td><td>CREATE $temp TABLE order_credits_$table_suffix 
SELECT 
  o.order_id, 
  o.order_total, 
  sum(oc.credit_amount) credit_amount, 
  d.total_discount 
FROM 
  (
    order_totals_$table_suffix o, order_cancels oc
  ) 
  LEFT JOIN order_discounts_$table_suffix d ON (o.order_id = d.order_id) 
WHERE 
  o.order_id = oc.order_id 
GROUP BY 
  o.order_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:992</td><td>CREATE $temp table order_totals_discounts_$table_suffix 
SELECT 
  DISTINCT d.renewal_rep, 
  d.state_code, 
  ot.order_id, 
  ot.account_id, 
  od.total_discount, 
  od.discount_percent, 
  ot.order_total account_total, 
  if (
    od.discount_percent, 
    (
      ot.order_total -(
        ot.order_total * od.discount_percent
      )
    ), 
    ot.order_total
  ) order_total 
FROM 
  order_account_totals_$table_suffix ot 
  LEFT JOIN order_discounts_$table_suffix od ON (od.order_id = ot.order_id) 
  LEFT JOIN renewal_progress_data_$table_suffix d ON (
    if (
      d.school_account_id, d.school_account_id, 
      d.district_account_id
    ) = ot.account_id
  )</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:1024</td><td>CREATE $temp TABLE order_totals_grp_$table_suffix 
SELECT 
  renewal_rep, 
  state_code, 
  sum(order_total) order_total 
FROM 
  order_totals_discounts_$table_suffix 
GROUP BY 
  $group_by_str</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:1040</td><td>CREATE $temp TABLE expansion_schools_$table_suffix 
SELECT 
  ot.renewal_rep, 
  ot.state_code, 
  count(DISTINCT ot.account_id) total_schools 
FROM 
  (
    order_totals_discounts_$table_suffix ot, 
    accounts a
  ) 
  LEFT JOIN renewal_targets_$table_suffix t ON (a.account_id = t.account_id) 
WHERE 
  a.account_id = ot.account_id 
  AND a.account_level = 2 
  AND t.account_id IS NULL 
GROUP BY 
  $group_by_str</td><td></td><td></td></tr>
   <tr><td>reports/renewal/candidate_index.php:1061</td><td>CREATE 
/*$temp*/
TABLE renewal_progress_grp_$table_suffix 
SELECT 
  renewal_rep, 
  d.state_code, 
  count(distinct district_account_id) total_districts, 
  count(
    distinct if (
      school_account_id <> '', school_account_id, 
      null
    )
  ) total_schools, 
  sum(renewal_target) total_renewal_target, 
  sum(
    if (
      renewal_order = 0 
      and opportunity_id IS NOT NULL 
      and max_opportunity_status > 10, 
      projected_total, 
      0
    )
  ) opportunity_total, 
  sum(
    if (
      opportunity_id IS NOT NULL 
      and max_opportunity_status = 10, 
      projected_total, 
      0
    )
  ) lost_total, 
  count(
    distinct if (
      renewal_order = 1, district_account_id, 
      null
    )
  ) total_order_districts, 
  count(
    distinct if (
      renewal_order = 1 
      and school_account_id <> '', 
      school_account_id, 
      null
    )
  ) total_order_schools 
FROM 
  renewal_progress_data_$table_suffix d 
GROUP BY 
  $group_by_str</td><td></td><td></td></tr>
   <tr><td>util/classes/Communication.php:722</td><td>CREATE TEMPORARY TABLE $table_name 
SELECT 
  e.event_id, 
  t.workshop_type_id, 
  t.workshop_type_name, 
  GROUP_CONCAT(
    DISTINCT w.workshop_name SEPARATOR '<br />'
  ) training_titles 
FROM 
  events e 
  JOIN event_workshops ew ON ew.event_id = e.event_id 
  JOIN workshops w ON w.workshop_id = ew.workshop_id 
  JOIN workshop_types t ON t.workshop_type_id = w.workshop_type_id 
WHERE 
  e.event_id = '" . ($this->te ? $this->te : $this->event_id) . "' 
GROUP BY 
  e.event_id, 
  t.workshop_type_id</td><td></td><td>skip</td></tr>
   <tr><td>util/classes/Communication.php:884</td><td>CREATE TEMPORARY TABLE tmp_account_pd_days1 
SELECT 
  aos.account_id, 
  sum(aos.onsite_remaining_pd) onsite_remaining_pd, 
  sum(aos.online_remaining_pd) online_remaining_pd 
FROM 
  account_order_summary aos 
WHERE 
  aos.academic_year_id = '$tmp_academic_year' 
GROUP BY 
  aos.account_id</td><td></td><td>skip</td></tr>
   <tr><td>util/classes/Communication.php:909</td><td>CREATE TEMPORARY TABLE tmp_account_pd_days 
SELECT 
  account_id, 
  if (
    sum(onsite_remaining_pd) = round(
      sum(onsite_remaining_pd)
    ), 
    cast(
      round(
        sum(onsite_remaining_pd)
      ) as char
    ), 
    sum(onsite_remaining_pd)
  ) onsite_remaining_pd, 
  if (
    sum(online_remaining_pd) = round(
      sum(online_remaining_pd)
    ), 
    cast(
      round(
        sum(online_remaining_pd)
      ) as char
    ), 
    sum(online_remaining_pd)
  ) online_remaining_pd 
FROM 
  tmp_account_pd_days1 
GROUP BY 
  account_id</td><td></td><td>skip</td></tr>
   <tr><td>util/classes/Communication.php:986</td><td>CREATE TEMPORARY TABLE tmp_account_licenses $select</td><td></td><td>skip</td></tr>
   <tr><td>util/classes/Communication.php:1017</td><td>CREATE TEMPORARY TABLE tmp_order_licenses 
SELECT 
  od.order_id, 
  ay.academic_year_name, 
  ay.start_date academic_year_start_date, 
  sum(p.student_licenses * od.quantity) licenses 
FROM 
  products p, 
  order_details od, 
  orders o, 
  sub_products sp, 
  academic_years ay 
WHERE 
  p.product_id = od.product_id 
  AND o.order_id = od.order_id 
  AND o.status = 0 
  AND od.status = 0 
  /*AND od.academic_year_id = '$tmp_academic_year'*/
  AND p.product_id = sp.product_id 
  AND sp.sub_product_type_id = 1 
  AND p.student_licenses > 0 
  AND o.se_0_order = 0 
  and p.sku not like '%-SPT-%' 
  and p.sku not like '%-BIO-%' 
  and p.product_name not like '%Special Upgrade%' 
  and ay.academic_year_id = od.academic_year_id 
GROUP BY 
  od.order_id, 
  od.academic_year_id</td><td></td><td>skip</td></tr>
   <tr><td>util/classes/data_import/Opportunity_Import.php:546</td><td>CREATE TEMPORARY TABLE tmp_opportunity_products 
SELECT 
  distinct oi.opportunity_product, 
  group_concat(op.opportunity_product_id) product_ids 
FROM 
  opportunities_import oi, 
  opportunity_products op 
WHERE 
  locate(
    op.opportunity_product_name, oi.opportunity_product
  ) > 0 
GROUP BY 
  oi.temp_import_id</td><td></td><td>skip</td></tr>
   <tr><td>util/function/iplans.php:153</td><td>CREATE TEMPORARY TABLE tmp_centralized_pd (
  key(order_id), 
  key(account_id)
) 
SELECT 
  od.order_id, 
  od.account_id, 
  sum(
    aos.initial_purchased_pd + aos.followup_purchased_pd
  ) onsite_pd, 
  sum(
    aos.initial_online_purchased_pd + aos.online_purchased_pd
  ) online_pd 
FROM 
  account_order_summary aos, 
  order_details od, 
  accounts a 
WHERE 
  od.order_detail_id = aos.order_detail_id 
  AND od.academic_year_id = '$academic_year_id' 
  AND a.account_id = od.account_id 
  AND a.account_level = 1 
GROUP BY 
  od.order_id, 
  od.account_id</td><td></td><td>skip</td></tr>
   <tr><td>util/function/iplans.php:198</td><td>CREATE TEMPORARY TABLE tmp_standalone_centralized_pd (
  key(account_id)
) 
SELECT 
  c.* 
FROM 
  tmp_centralized_pd c, 
  order_details od, 
  accounts a 
WHERE 
  c.order_id = od.order_id 
  AND od.status = 0 
  AND od.academic_year_id = '$academic_year_id' 
  AND a.account_id = od.account_id 
GROUP BY 
  c.order_id, 
  c.account_id 
HAVING 
  MAX(a.account_level) = 1</td><td></td><td>skip</td></tr>
   <tr><td>admin/lms/provision_accounts.php:37</td><td>CREATE TEMPORARY TABLE current_accounts (
  KEY(account_id)
) 
SELECT 
  DISTINCT od.account_id 
FROM 
  orders o, 
  order_details od 
WHERE 
  o.order_id = od.order_id 
  AND o.status = 0 
  AND od.status = 0 
  AND od.cancel_id = 0 
  AND CURRENT_DATE BETWEEN o.order_date 
  AND o.end_date</td><td></td><td>skip</td></tr>
   <tr><td>admin/lms/provision_accounts.php:62</td><td>CREATE TEMPORARY TABLE school_provisions (
  KEY(parent_account_id)
) 
SELECT 
  DISTINCT parent_account_id 
FROM 
  lms_acct_provision_records</td><td></td><td>skip</td></tr>
   <tr><td>cron/il_sync/orders.php:184</td><td>CREATE TABLE {$sync_type}_sync_new_orders 
SELECT 
  d.order_id, 
  d.order_detail_id, 
  d.account_id, 
  a.account_level, 
  a.$id, 
  d.start_date, 
  d.end_date, 
  d.pre_start, 
  d.post_end, 
  o.order_date, 
  (
    d.quantity * min(p.student_licenses)
  ) student_licenses, 
  (
    if (
      p.product_group_id = '" . $PRODUCT_GROUPS["program pricing"] . "' 
      and year(p.start_date) >= 2013, 
      ceil(d.quantity / 20), 
      d.quantity
    )* min(p.teacher_licenses)
  ) teacher_licenses, 
  (
    d.quantity * min(p.parent_licenses)
  ) parent_licenses, 
  p.summer_type_id, 
  p.domain_id, 
  p.program_id, 
  p.partner_id, 
  GROUP_CONCAT(
    DISTINCT pe.edition_id 
    ORDER BY 
      pe.edition_id
  ) edition_ids, 
  GROUP_CONCAT(
    DISTINCT pc.course_id 
    ORDER BY 
      pc.course_id
  ) course_ids, 
  d.academic_year_id 
FROM 
  (
    orders o, order_details d, products p, 
    sub_products sp, accounts a
  ) 
  LEFT JOIN product_editions pe ON (p.product_id = pe.product_id) 
  LEFT JOIN product_courses pc ON (p.product_id = pc.product_id) 
WHERE 
  o.order_id = d.order_id 
  AND d.product_id = p.product_id 
  AND p.product_id = sp.product_id 
  AND d.account_id = a.account_id 
  AND sp.sub_product_type_id IN (
    " . implode(", ", $sub_products) . "
  ) 
  AND o.status = 0 
  AND o.draft = 0 
  AND d.status = 0 
  AND d.om_order_id = 0 
  AND d.date_entered > '$last_start_time' 
  AND d.date_entered <= '$start_time' 
GROUP BY 
  d.order_detail_id</td><td></td><td></td></tr>
   <tr><td>cron/il_sync/orders.php:290</td><td>CREATE TABLE {$sync_type}_sync_cancel_orders 
SELECT 
  d.order_id, 
  d.order_detail_id, 
  d.account_id, 
  a.$id 
FROM 
  orders o, 
  order_details d, 
  products p, 
  sub_products sp, 
  accounts a 
WHERE 
  o.order_id = d.order_id 
  AND d.product_id = p.product_id 
  AND p.product_id = sp.product_id 
  AND a.account_id = d.account_id 
  AND sp.sub_product_type_id IN (
    " . implode(", ", $sub_products) . "
  ) 
  AND o.status = 1 
  AND o.draft = 0 
  AND o.date_modified > '$last_start_time' 
  AND o.date_modified <= '$start_time' 
  AND d.date_entered <= '$order_last_start' 
GROUP BY 
  d.order_detail_id</td><td></td><td></td></tr>
   <tr><td>cron/il_sync/orders.php:365</td><td>CREATE TABLE {$sync_type}_sync_update_orders 
SELECT 
  d.order_id, 
  d.order_detail_id, 
  d.account_id, 
  a.$id, 
  a.account_level, 
  d.start_date, 
  d.end_date, 
  d.pre_start, 
  d.post_end, 
  o.order_date, 
  (
    d.quantity * min(p.student_licenses)
  ) student_licenses, 
  (
    if (
      p.product_group_id = '" . $PRODUCT_GROUPS["program pricing"] . "' 
      and year(p.start_date) >= 2013, 
      ceil(d.quantity / 20), 
      d.quantity
    )* min(p.teacher_licenses)
  ) teacher_licenses, 
  (
    d.quantity * min(p.parent_licenses)
  ) parent_licenses, 
  p.summer_type_id, 
  h.column_name, 
  p.domain_id, 
  p.program_id, 
  group_concat(
    distinct pe.edition_id 
    ORDER BY 
      pe.edition_id
  ) edition_ids, 
  GROUP_CONCAT(
    DISTINCT pc.course_id 
    ORDER BY 
      pc.course_id
  ) course_ids, 
  d.academic_year_id, 
  p.partner_id, 
  SUBSTRING_INDEX(
    MIN(
      CONCAT(h.date_entered, '|', h.old_value)
    ), 
    '|', 
    -1
  ) old_value, 
  SUBSTRING_INDEX(
    MAX(
      CONCAT(h.date_entered, '|', h.new_value)
    ), 
    '|', 
    -1
  ) new_value 
FROM 
  (
    orders o, order_details d, products p, 
    sub_products sp, accounts a, history_log h
  ) 
  LEFT JOIN sub_products sp2 ON (
    h.column_name = 'product_id' 
    AND h.old_value = sp2.product_id 
    AND sp2.sub_product_type_id IN (
      " . implode(", ", $sub_products) . "
    )
  ) 
  LEFT JOIN product_editions pe ON (p.product_id = pe.product_id) 
  LEFT JOIN product_courses pc ON (p.product_id = pc.product_id) 
WHERE 
  o.order_id = d.order_id 
  AND d.product_id = p.product_id 
  AND p.product_id = sp.product_id 
  AND d.account_id = a.account_id 
  AND h.table_name = 'order_details' 
  AND h.column_name NOT IN ('price', 'status') 
  AND d.order_detail_id = h.record_id 
  AND sp.sub_product_type_id IN (
    " . implode(", ", $sub_products) . "
  ) 
  AND o.status = 0 
  AND o.draft = 0 
  AND d.status = 0 
  AND h.date_entered > '$order_last_start' 
  AND h.date_entered <= '$start_time' 
  AND o.date_entered <= '$last_start_time' 
  AND (
    sp2.product_id IS NOT NULL 
    OR h.column_name != 'product_id'
  ) " . ($sync_type == " sa " ? " 
  AND h.column_name IN(
    'end_date', 'post_end', 'account_id'
  ) " : "") . " 
GROUP BY 
  d.order_detail_id, 
  h.column_name 
ORDER BY 
  h.date_entered</td><td></td><td></td></tr>
   <tr><td>misc/tabs/activity_grid.php:65</td><td>CREATE TEMPORARY TABLE tmp_communications 
SELECT 
  DISTINCT c.communication_id, 
  c.communication_type, 
  c.category_id, 
  c.subject, 
  c.date_entered, 
  c.account_id, 
  c.entered_by 
FROM 
  communications c, 
  communication_users cu 
WHERE 
  c.communication_id = cu.communication_id $whereStr</td><td></td><td>skip</td></tr>
   <tr><td>misc/tabs/activity_grid.php:89</td><td>CREATE TEMPORARY TABLE tmp_comm_users 
SELECT 
  communications.communication_id, 
  direction, 
  concat(
    substr(users.first_name, 1, 1), 
    ' ', 
    users.last_name
  ) user_name 
FROM 
  communications, 
  communication_users, 
  users, 
  tmp_communications 
WHERE 
  communications.communication_id = communication_users.communication_id 
  AND communications.communication_id = tmp_communications.communication_id 
  AND users.user_id = communication_users.user_id</td><td></td><td>skip</td></tr>
   <tr><td>misc/tabs/activity_grid.php:116</td><td>CREATE TEMPORARY TABLE tmp_from_users 
SELECT 
  communication_id, 
  user_name 
FROM 
  tmp_comm_users 
WHERE 
  direction = '" . DIRECTION_FROM . "'</td><td></td><td>skip</td></tr>
   <tr><td>misc/tabs/activity_grid.php:125</td><td>CREATE TEMPORARY TABLE tmp_to_users 
SELECT 
  communication_id, 
  user_name 
FROM 
  tmp_comm_users 
WHERE 
  direction = '" . DIRECTION_TO . "'</td><td></td><td>skip</td></tr>
   <tr><td>reports/billing/reseller_fee_index.php:142</td><td>CREATE TEMPORARY TABLE tmp_reseller_orders (
  PRIMARY KEY (order_id)
) 
SELECT 
  o.order_id, 
  COALESCE(
    ou.user_id, ua.user_id, uab.user_id
  ) user_id, 
  CASE WHEN ua.user_id 
  OR uab.user_id THEN 1 ELSE 0 END on_account, 
  CASE WHEN ou.user_id THEN 1 ELSE 0 END on_order 
FROM 
  interlink.orders o 
  LEFT JOIN interlink.user_accounts ua ON o.account_id = ua.account_id 
  AND ua.user_id <> 0 
  AND ua.role_id = 42 #ordering account users
  LEFT JOIN interlink.users u ON u.user_id = ua.user_id 
  LEFT JOIN interlink.user_accounts uab ON o.billing_account_id = uab.account_id 
  AND uab.user_id <> 0 
  AND uab.role_id = 42 #billing account users
  LEFT JOIN interlink.users ub ON ub.user_id = uab.user_id 
  LEFT JOIN interlink.user_orders ou ON ou.order_id = o.order_id 
  AND ou.role_id = 42 
  AND ou.user_id <> 0 #order users
WHERE 
  #Ordering Account Reseller
  (
    ua.user_id IS NOT NULL 
    AND (
      ua.account_owner = 1 
      OR o.order_date BETWEEN u.start_date 
      AND u.end_date
    ) 
    AND (
      (
        o.order_date > u.start_date 
        OR u.start_date = 0
      ) 
      AND (
        o.order_date < u.end_date 
        OR u.end_date = 0
      )
    )
  ) #OR Billing Account Reseller
  OR (
    uab.user_id IS NOT NULL 
    AND (
      uab.account_owner = 1 
      OR o.order_date BETWEEN ub.start_date 
      AND ub.end_date
    ) 
    AND (
      (
        o.order_date > ub.start_date 
        OR ub.start_date = 0
      ) 
      AND (
        o.order_date < ub.end_date 
        OR ub.end_date = 0
      )
    )
  ) #OR Order Reseller
  OR ou.user_id IS NOT NULL 
GROUP BY 
  o.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/billing/reseller_fee_index.php:173</td><td>CREATE TEMPORARY TABLE tmp_comm_credits (
  PRIMARY KEY(order_id)
) 
SELECT 
  il_order_id order_id, 
  sum(invoice_total *-1) credit_total 
FROM 
  billing.commission_credits cc 
  INNER JOIN tmp_reseller_orders ro ON ro.order_id = cc.il_order_id 
WHERE 
  credit_memo NOT LIKE '%bad%debt%' 
GROUP BY 
  order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/billing/reseller_fee_index.php:186</td><td>CREATE TEMPORARY TABLE tmp_invoices (
  PRIMARY KEY(order_id)
) 
SELECT 
  il_order_id order_id, 
  sum(invoice_total) invoice_total 
FROM 
  billing.invoices i 
  INNER JOIN tmp_reseller_orders ro ON ro.order_id = i.il_order_id 
GROUP BY 
  order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/billing/reseller_fee_index.php:198</td><td>CREATE TEMPORARY TABLE tmp_bad_debt (
  PRIMARY KEY(order_id)
) 
SELECT 
  il_order_id order_id, 
  sum(invoice_total *-1) credit_total, 
  sum(c.new_credit) new_credit, 
  sum(c.renew_credit) renew_credit 
FROM 
  billing.commission_credits cc 
  INNER JOIN tmp_reseller_orders ro ON ro.order_id = cc.il_order_id 
  LEFT JOIN commissions.credits c ON c.order_id = cc.il_order_id 
  AND c.invoice_id = cc.ns_invoice_id 
  AND c.cmonth = '$cmonth' 
WHERE 
  credit_memo LIKE '%bad%debt%' 
GROUP BY 
  order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/billing/reseller_fee_index.php:213</td><td>CREATE TEMPORARY TABLE tmp_invoice_history (
  PRIMARY KEY (order_id, ns_invoice_id)
) 
SELECT 
  cc.il_order_id order_id, 
  cc.ns_invoice_id, 
  cc.invoice_date, 
  cc.invoice_total *-1 invoice_total, 
  'Credit' `type` 
FROM 
  billing.commission_credits cc 
  INNER JOIN tmp_comm_credits ro ON ro.order_id = cc.il_order_id 
WHERE 
  credit_memo NOT LIKE '%bad%debt%' 
UNION ALL 
SELECT 
  cc.il_order_id order_id, 
  cc.ns_invoice_id, 
  cc.invoice_date, 
  cc.invoice_total *-1 invoice_total, 
  'Bad debt' `type` 
FROM 
  billing.commission_credits cc 
  INNER JOIN tmp_bad_debt ro ON ro.order_id = cc.il_order_id 
WHERE 
  credit_memo LIKE '%bad%debt%' 
UNION ALL 
SELECT 
  iv.il_order_id, 
  iv.ns_invoice_id, 
  iv.invoice_date, 
  iv.invoice_total, 
  'Invoice' `type` 
FROM 
  billing.invoices iv 
  INNER JOIN tmp_invoices ro ON ro.order_id = iv.il_order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/billing/reseller_fee_index.php:235</td><td>CREATE TEMPORARY TABLE tmp_reseller_order_report(
  PRIMARY KEY(
    `Order ID`, user_id, `Invoice ID`
  )
) 
SELECT 
  u.user_f_last `Reseller Name`, 
  CASE WHEN urf.percent_total <> 0 THEN CONCAT('% Total: ', urf.percent_total) WHEN urf.percent_new > 0 || urf.percent_renew > 0 THEN CONCAT(
    '% NEW: ', urf.percent_new, ', % Renew: ', 
    urf.percent_renew
  ) ELSE '' END `Fees`, 
  IFNULL(
    CONCAT(
      DATE_FORMAT(urf.start_date, '%b'), 
      ' ', 
      YEAR(urf.start_date)
    ), 
    ''
  ) `Fee Starting`, 
  u.user_id, 
  CONCAT(
    'ID-', 
    u.user_id, 
    IFNULL(urf.start_date, 0)
  ) `Reseller ID`, 
  CONCAT(
    '<b>', 
    u.user_f_last, 
    '</b>- <i><u>Fees:</u></i> ', 
    CASE WHEN urf.percent_total <> 0 THEN CONCAT('% Total: ', urf.percent_total) WHEN urf.percent_new > 0 || urf.percent_renew > 0 THEN CONCAT(
      '% NEW: ', urf.percent_new, ', % Renew: ', 
      urf.percent_renew
    ) ELSE 'None Entered' END, 
    IFNULL(
      CONCAT(
        '<div style=margin-top:2px;padding:4px;font-style:italic> (Rates as of ', 
        DATE_FORMAT(urf.start_date, '%b'), 
        ' ', 
        YEAR(urf.start_date), 
        ')</div>'
      ), 
      ''
    )
  ) `Reseller`, 
  o.order_id `Order ID`, 
  a.account_id `Account ID`, 
  a.account_name `Account`, 
  a.state_code `State`, 
  o.order_date `Order <br>Date`, 
  o.start_date `Start <br>Date`, 
  o.end_date `End <br>Date`, 
  ro.on_order `On Order`, 
  ro.on_account `On Account`, 
  CONCAT(
    '<span style=color:red>', CASE WHEN ro.on_account = 0 THEN 'Order, Not Acct' WHEN ro.on_order = 0 THEN 'Acct, Not Order' ELSE 'Acct & Order' END, 
    '</span>'
  ) `Reseller On`, 
  co.Cancel, 
  CASE WHEN os.order_total = 0 THEN 0 ELSE oi.order_revenue_total END `Order <br>Total`, 
  oi.credit_revenue_total + IFNULL(bad_debt.credit_total, 0) `Credit <br>Total`, 
  CASE WHEN os.order_total = 0 THEN 0 ELSE oi.order_revenue_total - oi.credit_revenue_total - IFNULL(bad_debt.credit_total, 0)- oi.order_tax_total END `Net <br>Total`, 
  oi.new_revenue_total - IFNULL(bad_debt.new_credit, 0) `New <br>Total`, 
  oi.renew_revenue_total - IFNULL(bad_debt.renew_credit, 0) `Renew <br>Total`, 
  IFNULL(cc.credit_total, 0) `Order Reseller <br>Credits Booked`, 
  CASE WHEN orf.order_id THEN orf.fee_amount WHEN urf.percent_total <> 0 THEN (
    oi.order_revenue_total - oi.credit_revenue_total - IFNULL(bad_debt.credit_total, 0)- oi.order_tax_total
  )* urf.percent_total WHEN os.order_total = 0 THEN 0 ELSE (
    (
      oi.new_revenue_total - IFNULL(bad_debt.new_credit, 0)
    )* urf.percent_new
  )+(
    (
      oi.renew_revenue_total - IFNULL(bad_debt.renew_credit, 0)
    )* urf.percent_renew
  ) END `Order Reseller <br>Credits Due`, 
  CASE WHEN orf.order_id THEN 1 ELSE 0 END `Override`, 
  hist.ns_invoice_id `Invoice ID`, 
  hist.invoice_date `Trans. <br> Date`, 
  hist.invoice_total `Trans. <br> Total`, 
  hist.type `Trans. <br>Type`, 
  CASE WHEN hist.type <> 'invoice' THEN '' WHEN urf.percent_total <> 0 THEN urf.percent_total * hist.invoice_total WHEN urf.percent_new > 0 
  AND os.new_total > 0 
  AND os.renew_total = 0 THEN urf.percent_new * hist.invoice_total WHEN urf.percent_renew > 0 
  AND os.renew_total > 0 
  AND os.new_total = 0 THEN urf.percent_renew * hist.invoice_total ELSE '' END `Invoice <br>Fees Due`, 
  CASE WHEN hist.order_id IS NULL THEN 'Not Invoiced' WHEN hist.type = 'invoice' 
  AND (
    urf.percent_new > 0 || urf.percent_renew > 0
  ) 
  AND (
    os.new_total > 0 
    AND os.renew_total > 0
  ) #mixed order
  THEN 'mixed order <br> mixed rate' WHEN hist.type = 'invoice' 
  AND (
    urf.percent_new + urf.percent_renew + urf.percent_total = 0 
    OR urf.user_id IS NULL
  ) THEN 'reseller <br>missing rates' ELSE '' END `Inv Note` 
FROM 
  interlink.orders o 
  INNER JOIN interlink.order_summary os ON os.order_id = o.order_id 
  INNER JOIN tmp_reseller_orders ro ON ro.order_id = o.order_id 
  LEFT JOIN tmp_comm_credits cc ON cc.order_id = o.order_id 
  LEFT JOIN commissions.orders co ON co.order_id = o.order_id 
  AND co.cmonth = '$cmonth' 
  LEFT JOIN commissions.order_info oi ON oi.cmonth = '$cmonth' 
  AND oi.order_id = o.order_id 
  LEFT JOIN interlink.accounts a ON a.account_id = o.account_id 
  LEFT JOIN commissions.users u ON u.user_id = ro.user_id 
  LEFT JOIN interlink.user_reseller_fees urf ON urf.user_id = u.user_id 
  AND o.order_date BETWEEN urf.start_date 
  AND urf.end_date 
  LEFT JOIN tmp_invoice_history hist ON hist.order_id = o.order_id 
  LEFT JOIN tmp_bad_debt bad_debt ON bad_debt.order_id = o.order_id 
  LEFT JOIN interlink.order_reseller_fees orf ON orf.order_id = o.order_id 
  AND orf.user_id = ro.user_id 
WHERE 
  1 
  AND o.order_date >= '2010-01-01' $whereStr 
GROUP BY 
  o.order_id, 
  u.user_id, 
  hist.ns_invoice_id 
HAVING 
  1 $havingStr 
ORDER BY 
  u.user_id, 
  urf.start_date, 
  a.account_name, 
  o.order_date, 
  o.order_id, 
  hist.invoice_date, 
  hist.ns_invoice_id, 
  hist.type DESC;</td><td></td><td>skip</td></tr>
   <tr><td>reports/commissions/combined/generate_query_data.inc:87</td><td>CREATE TEMPORARY TABLE $temp_join_table_name (
  user_id INTEGER NOT NULL, 
  order_id INTEGER NOT NULL, 
  INDEX(order_id), 
  INDEX(user_id), 
  INDEX(order_id, user_id), 
  PRIMARY KEY(order_id, user_id)
) 
SELECT 
  user_id, 
  order_id 
FROM 
  commissions.rep_payroll_transactions 
WHERE 
  cmonth = @cmonth 
  AND payroll_date = @payroll_month 
GROUP BY 
  order_id, 
  user_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/commissions/combined/generate_query_data.inc:149</td><td>CREATE TEMPORARY TABLE $table (
  order_id INTEGER NOT NULL, 
  user_id INTEGER NOT NULL, 
  INDEX(order_id), 
  INDEX(user_id), 
  PRIMARY KEY(order_id, user_id)
) 
SELECT 
  order_id, 
  user_id 
FROM 
  order_users ou 
WHERE 
  ou.cmonth = @cmonth 
UNION 
SELECT 
  order_id, 
  user_id 
FROM 
  payroll_lock;</td><td></td><td>skip</td></tr>
   <tr><td>reports/commissions/combined/generate_query_data.inc:166</td><td>CREATE TEMPORARY TABLE $temp_paid_table_name (
  order_id INTEGER NOT NULL, 
  user_id INTEGER NOT NULL, 
  paid decimal(12, 2) NOT NULL, 
  -- change
  INDEX(order_id), 
  INDEX(user_id), 
  PRIMARY KEY(order_id, user_id)
) 
SELECT 
  order_id, 
  user_id, 
  SUM(
    IFNULL(payroll.new_paid, 0)+ payroll.new_acv_paid + payroll.new_myo_paid + IFNULL(payroll.renew_paid, 0) + IFNULL(payroll.new_tier_paid, 0) + IFNULL(payroll.new_tier2_paid, 0) + payroll.new_tier3_paid
  ) paid 
FROM 
  rep_payroll_transactions payroll 
WHERE 
  cmonth = @cmonth 
GROUP BY 
  order_id, 
  user_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/commissions/combined/generate_query_data.inc:185</td><td>CREATE TEMPORARY TABLE main (
  PRIMARY KEY (
    user_id, order_id, transaction_id, 
    payroll_date
  ), 
  payroll_date DATE, 
  INDEX(area_id), 
  territory VARCHAR(100)
) 
SELECT 
  u.user_id, 
  su.sales_user_id, 
  TRIM(
    concat_ws(' ', u.first_name, u.last_name)
  ) sales_user_name, 
  cp.base_rate as user_base_rate, 
  cp.myo_rate as user_myo_rate, 
  CONCAT(
    ROUND(cp.renewal_rate * 100, 2), 
    '%', 
    CASE WHEN cp.renewal_rate != cp.renewal_rate_high_rank 
    AND cp.renewal_rate_high_rank != 0 THEN CONCAT(
      ' / ', 
      ROUND(
        cp.renewal_rate_high_rank * 100, 2
      ), 
      '%'
    ) ELSE '' END
  ) as user_renewal_rate, 
  areas.area_id, 
  au.mgmt area_mgmt, 
  # will update in next query-for performance
  '' territory, 
  IF(
    IFNULL(cu.cp_termination_date, 0) > 0, 
    cu.cp_termination_date, 
    ''
  ) termination_date, 
  o.order_id, 
  a.account_name, 
  o.state, 
  ioc.orig_order_date order_date, 
  o.start_date, 
  o.end_date, 
  o.sales_rep sold_by, 
  CASE WHEN YEAR(o.order_date) < @year THEN 0 ELSE o.order_total END order_total, 
  CASE WHEN YEAR(o.order_date) < @year THEN 0 ELSE o.sales_tax END sales_tax, 
  CASE WHEN oc.credit_type IS NULL THEN null WHEN oc.credit_type = 'P' THEN 'Partial' ELSE 'Full' END order_cancelled, 
  CASE WHEN oc.cancel_date IS NOT NULL 
  AND oc.credit_type = 'F' THEN oc.cancel_date ELSE NULL END order_cancel_date, 
  CASE WHEN YEAR(o.order_date) < @year THEN p_oi.credit_revenue_total_ytd ELSE oi.credit_revenue_total END * -1 order_revenue_credits, 
  CASE WHEN YEAR(o.order_date) < @year THEN (
    p_oi.credit_total_ytd - p_oi.credit_revenue_total_ytd
  ) * -1 ELSE (
    o.credit_total - oi.credit_revenue_total
  ) * -1 END order_commissionable_credits, 
  CASE WHEN ou.order_id IS NOT NULL 
  AND YEAR(o.order_date) < @year THEN p_oi.order_revenue_total_ytd - p_oi.credit_total_ytd - p_oi.order_tax_total_ytd WHEN ou.order_id IS NOT NULL 
  AND YEAR(o.order_date) >= @year THEN o.order_total - o.sales_tax - o.credit_total ELSE 0 END order_net_total, 
  oi.order_revenue_total_ytd as order_net_total_ytd, 
  CASE WHEN ou.order_id IS NOT NULL 
  AND YEAR(o.order_date) < @year THEN p_oi.new_total_ytd WHEN ou.order_id IS NOT NULL 
  AND YEAR(o.order_date) >= @year THEN o.new_total ELSE 0 END order_new_total, 
  CASE WHEN ou.order_id IS NOT NULL 
  AND YEAR(o.order_date) < @year THEN p_oi.renew_total_ytd WHEN ou.order_id IS NOT NULL 
  AND YEAR(o.order_date) >= @year THEN o.renew_total ELSE 0 END order_renewal_total, 
  CASE WHEN ou.order_id IS NOT NULL 
  AND YEAR(o.order_date) < @year THEN p_acv.new_acv_ytd WHEN ou.order_id IS NOT NULL 
  AND YEAR(o.order_date) >= @year THEN acv.new_acv ELSE 0 END order_new_acv, 
  CASE WHEN ou.order_id IS NOT NULL 
  AND YEAR(o.order_date) < @year THEN p_acv.renew_acv_ytd WHEN ou.order_id IS NOT NULL 
  AND YEAR(o.order_date) >= @year THEN acv.renew_acv ELSE 0 END order_renew_acv, 
  qcu.quota_credit, 
  qcu.ytd_qc, 
  CASE WHEN cp.annual_quota > 1 THEN qcu.ytd_qc / cp.annual_quota ELSE '' END percent_quota_met, 
  CASE WHEN cp.annual_quota > 1 THEN cp.annual_quota ELSE 0 END annual_quota, 
  CASE WHEN cp.threshold = 0 THEN CONCAT(@year, '-01-01') WHEN cp.threshold_reached_date IS NULL 
  OR cp.threshold_reached_date = '0000-00-00' THEN '' ELSE cp.threshold_reached_date END as hit_threshold, 
  COALESCE(
    NULLIF(
      CONCAT_WS(
        ' ', dou.first_name, dou.last_name
      ), 
      ''
    ), 
    oi.order_strategic_rep
  ) as door_opener_strategic, 
  CASE WHEN (nc.rate * nc.percentage) != (nacvc.rate * nacvc.percentage) THEN CONCAT(
    ROUND(
      (nc.rate * nc.percentage)* 100, 
      2
    ), 
    '% / ', 
    ROUND(
      (nacvc.rate * nacvc.percentage)* 100, 
      2
    ), 
    '%'
  ) ELSE CONCAT(
    ROUND(
      IFNULL(
        NULLIF(nc.rate * nc.percentage, 0), 
        nacvc.rate * nacvc.percentage
      )* 100, 
      2
    ), 
    '%'
  ) END as new_business_commission_rate, 
  nmyoc.rate * nmyoc.percentage as new_myo_business_commission_rate, 
  CONCAT(
    ROUND(rc.rate * rc.percentage * 100, 2), 
    '%'
  ) as renewal_business_commission_rate, 
  CONCAT(
    CASE WHEN IFNULL(ntc.rate * ntc.percentage, 0) + IFNULL(ntc2.rate * ntc2.percentage, 0) + IFNULL(ntc3.rate * ntc3.percentage, 0)= 0 THEN NULL ELSE ROUND(
      (
        IFNULL(ntc.rate * ntc.percentage, 0) + IFNULL(ntc2.rate * ntc2.percentage, 0) + IFNULL(ntc3.rate * ntc3.percentage, 0)
      )* 100, 
      2
    ) END, 
    '%', 
    CASE WHEN (
      nc.mid1 = 1 
      OR nc.mid2 = 1
    ) 
    AND o.order_date >= '2015-01-01' 
    AND o.order_date <= '2019-01-01' THEN CONCAT(
      ' / ', 
      ROUND(
        (
          CASE WHEN nc.mid1 = 1 THEN IFNULL(
            (
              ntc.commissionable / nc.commissionable
            )*(ntc.rate * ntc.percentage), 
            0
          ) WHEN nc.reach1 = 1 THEN IFNULL(ntc.rate * ntc.percentage, 0) ELSE 0 END + CASE WHEN nc.mid2 = 1 THEN IFNULL(
            (
              ntc2.commissionable / nc.commissionable
            )*(ntc2.rate * ntc2.percentage), 
            0
          ) WHEN nc.reach2 = 1 THEN IFNULL(ntc.rate * ntc.percentage, 0) ELSE 0 END
        )* 100, 
        2
      ), 
      '%'
    ) WHEN (
      nc.mid1 = 1 
      OR nc.mid2 = 1 
      OR nc.mid3 = 1
    ) 
    AND o.order_date >= '2019-01-01' THEN CONCAT(
      ' / ', 
      ROUND(
        (
          CASE WHEN nc.mid1 = 1 THEN IFNULL(
            (
              ntc.commissionable / nacvc.commissionable
            )*(ntc.rate * ntc.percentage), 
            0
          ) WHEN nc.reach1 = 1 THEN IFNULL(ntc.rate * ntc.percentage, 0) ELSE 0 END + CASE WHEN nc.mid2 = 1 THEN IFNULL(
            (
              ntc2.commissionable / nacvc.commissionable
            )*(ntc2.rate * ntc2.percentage), 
            0
          ) WHEN nc.reach2 = 1 THEN IFNULL(ntc2.rate * ntc2.percentage, 0) ELSE 0 END + CASE WHEN nc.mid3 = 1 THEN IFNULL(
            (
              ntc3.commissionable / nacvc.commissionable
            )*(ntc3.rate * ntc3.percentage), 
            0
          ) WHEN nc.reach3 = 1 THEN IFNULL(ntc3.rate * ntc3.percentage, 0) ELSE 0 END
        )* 100, 
        2
      ), 
      '%'
    ) ELSE '' END
  ) as new_tier_commission_rate, 
  COALESCE(nc.total_commissions, 0) + COALESCE(nacvc.total_commissions, 0) + COALESCE(nmyoc.total_commissions, 0) + COALESCE(rc.total_commissions, 0) + COALESCE(ntc.total_commissions, 0) + COALESCE(ntc2.total_commissions, 0)+ COALESCE(ntc3.total_commissions, 0) + COALESCE(rfc.total_commissions, 0) as projected_commission_total, 
  COALESCE(nc.invoice_commissions, 0) + COALESCE(nacvc.invoice_commissions, 0) + COALESCE(nmyoc.invoice_commissions, 0) + COALESCE(rc.invoice_commissions, 0) + COALESCE(ntc.invoice_commissions, 0) + COALESCE(ntc2.invoice_commissions, 0) + COALESCE(ntc3.invoice_commissions, 0) + COALESCE(rfc.invoice_commissions, 0) as invoiced_commission_total, 
  (
    COALESCE(nc.invoice_commissions, 0) + COALESCE(nacvc.invoice_commissions, 0) + COALESCE(nmyoc.invoice_commissions, 0) + COALESCE(rc.invoice_commissions, 0) + COALESCE(ntc.invoice_commissions, 0) + COALESCE(ntc2.invoice_commissions, 0) + COALESCE(ntc3.invoice_commissions, 0) + COALESCE(rfc.invoice_commissions, 0)
  )- COALESCE(poo.paid, 0) pending_commission_total, 
  t.id transaction_id, 
  " . ($rep_view ? " CASE WHEN t.type = 'Comm. Credit' THEN 'Credit' ELSE t.type END as transaction_type " : " t.type transaction_type ") . ", 
  t.date transaction_date, 
  t.ns_payment_id payment_id, 
  t.ns_invoice_id invoice_id, 
  t.invoice_date, 
  t.credit_id as cancel_id, 
  oc.cancel_date, 
  COALESCE(t.payment_total, t.credit_total) as transaction_amount, 
  COALESCE(t.new_paid, t.credit_new) as new_transaction_amount, 
  COALESCE(t.renew_paid, t.credit_renew) as renewal_transaction_amount, 
  COALESCE(
    t.payment_tax_portion, t.credit_tax_portion
  ) as tax_transaction_amount, 
  ROUND(
    (
      payroll.new_tier_due + payroll.new_tier2_due + payroll.new_tier3_due
    )/(
      IFNULL(ntc.rate * ntc.percentage, 0) + IFNULL(ntc2.rate * ntc2.percentage, 0)+ IFNULL(ntc3.rate * ntc3.percentage, 0)
    ), 
    0
  ) new_tier_transaction_amount, 
  IFNULL(payroll.new_due, 0) + IFNULL(payroll.new_acv_due, 0) AS new_commission_earned, 
  payroll.new_myo_due AS new_myo_commission_earned, 
  payroll.renew_due AS renewal_commission_earned, 
  payroll.new_tier_due + payroll.new_tier2_due + payroll.new_tier3_due AS new_tier_commission_earned, 
  IFNULL(payroll.new_due, 0) + IFNULL(payroll.new_acv_due, 0)+ IFNULL(payroll.new_myo_due, 0)+ IFNULL(payroll.renew_due, 0) + IFNULL(payroll.new_tier_due, 0) + IFNULL(payroll.new_tier2_due, 0)+ IFNULL(payroll.new_tier3_due, 0) AS total_commission_earned, 
  payroll.new_paid + payroll.new_acv_paid AS new_commission_paid, 
  payroll.new_myo_paid AS new_myo_commission_paid, 
  payroll.renew_paid AS renewal_commission_paid, 
  payroll.new_tier_paid + payroll.new_tier2_paid + payroll.new_tier3_paid AS new_tier_commission_paid, 
  IFNULL(payroll.new_paid, 0) + IFNULL(payroll.new_acv_paid, 0)+ IFNULL(payroll.new_myo_paid, 0) + IFNULL(payroll.renew_paid, 0) + IFNULL(payroll.new_tier_paid, 0) + IFNULL(payroll.new_tier2_paid, 0)+ IFNULL(payroll.new_tier3_paid, 0) AS total_commission_paid, 
  CASE payroll.payroll_date WHEN 'Unpaid' THEN @payroll_month ELSE payroll.payroll_date END payroll_date 
FROM 
  $temp_base_table_name base 
  LEFT JOIN commissions.interlink_orders_copy ioc ON ioc.order_id = base.order_id 
  LEFT JOIN (
    (
      SELECT 
        * 
      FROM 
        commissions.payment_credit_transactions 
      WHERE 
        cmonth = @cmonth
    ) t 
    LEFT JOIN {$temp_base_table_name}1 base2 ON base2.order_id = t.order_id 
    LEFT JOIN commissions.users cbu ON cbu.user_id = base2.user_id 
    LEFT JOIN commissions.rep_payroll_transactions payroll ON base2.order_id = payroll.order_id 
    AND base2.user_id = payroll.user_id 
    AND t.payment_id = payroll.payment_id 
    AND payroll.cmonth = @cmonth
  ) ON base.order_id = t.order_id 
  AND t.cmonth = @cmonth 
  AND (
    t.date <= LAST_DAY(@cmonth) 
    OR (
      MONTH(@cmonth)= 12 
      AND t.date <= date_add(
        last_day(@cmonth), 
        INTERVAL 1 QUARTER
      ) 
      AND YEAR(ioc.orig_order_date)>= 2022
    )
  ) 
  AND base2.user_id = base.user_id 
  AND (
    t.type <> 'Renew Bonus' 
    OR payroll.user_id IS NOT NULL
  ) $tran_where 
  LEFT JOIN interlink.users u ON base.user_id = u.user_id 
  LEFT JOIN $temp_paid_table_name poo ON base.order_id = poo.order_id 
  AND base.user_id = poo.user_id 
  LEFT JOIN interlink.sales_users su ON u.user_id = su.user_id 
  LEFT JOIN order_users ou ON ou.cmonth = @cmonth 
  AND ou.order_id = base.order_id 
  AND ou.user_id = base.user_id 
  LEFT JOIN commissions.orders o ON base.order_id = o.order_id 
  AND o.cmonth = @cmonth 
  LEFT JOIN commissions.order_info oi ON o.order_id = oi.order_id 
  AND oi.cmonth = @cmonth 
  LEFT JOIN commissions.order_info p_oi ON o.order_id = p_oi.order_id 
  AND p_oi.cmonth = CASE WHEN @year <> YEAR(@cmonth) THEN CONCAT_WS('-', @year, '12', '01') ELSE @cmonth END 
  LEFT JOIN commissions.order_acv acv ON o.order_id = acv.order_id 
  AND acv.cmonth = @cmonth 
  LEFT JOIN commissions.order_acv p_acv ON o.order_id = p_acv.order_id 
  AND p_acv.cmonth = CASE WHEN @year <> YEAR(@cmonth) THEN CONCAT_WS('-', @year, '12', '01') ELSE @cmonth END 
  LEFT JOIN interlink.accounts a ON o.account_id = a.account_id 
  LEFT JOIN commissions.compensation_plans cp ON u.user_id = cp.user_id 
  AND cp.cmonth = @cmonth 
  AND cp.year = @year 
  AND (
    o.order_date BETWEEN cp.start_date 
    AND cp.end_date
  ) 
  LEFT JOIN commissions.compensation_plans cpo ON ou.comp_plan_id = cpo.comp_plan_id 
  AND ou.user_id = cpo.user_id 
  AND ou.cmonth = cpo.cmonth 
  AND YEAR(ou.order_date)= cpo.year 
  LEFT JOIN commissions.users cu on cu.user_id = u.user_id 
  LEFT JOIN commissions.area_users au ON u.user_id = au.user_id 
  and o.order_date between au.start_date 
  and au.end_date 
  LEFT JOIN commissions.areas ON au.area_id = areas.area_id 
  LEFT JOIN commissions.quota_credit_users qcu ON u.user_id = qcu.user_id 
  AND o.order_id = qcu.order_id 
  AND qcu.cmonth = CASE WHEN @year <> YEAR(NOW()) THEN CONCAT_WS('-', @year, '12', '01') ELSE @cmonth END 
  LEFT JOIN interlink.user_orders_lock uol ON o.order_id = uol.order_id 
  AND uol.role_id = 10 
  LEFT JOIN commissions.users dou ON uol.user_id = dou.user_id 
  LEFT JOIN commissions.commissions nc ON o.order_id = nc.order_id 
  AND nc.cmonth = @cmonth 
  AND cp.comp_plan_id = nc.comp_plan_id 
  AND nc.rate_type = 'NEW' 
  LEFT JOIN commissions.commissions nacvc ON o.order_id = nacvc.order_id 
  AND nacvc.cmonth = @cmonth 
  AND cp.comp_plan_id = nacvc.comp_plan_id 
  AND nacvc.rate_type = 'NEW ACV' 
  LEFT JOIN commissions.commissions nmyoc ON o.order_id = nmyoc.order_id 
  AND nmyoc.cmonth = @cmonth 
  AND cp.comp_plan_id = nmyoc.comp_plan_id 
  AND nmyoc.rate_type = 'NEW MYO' 
  LEFT JOIN commissions.commissions rc ON o.order_id = rc.order_id 
  AND rc.cmonth = @cmonth 
  AND cp.comp_plan_id = rc.comp_plan_id 
  AND rc.rate_type = 'RENEW' 
  LEFT JOIN commissions.commissions ntc ON o.order_id = ntc.order_id 
  AND ntc.cmonth = @cmonth 
  AND cp.comp_plan_id = ntc.comp_plan_id 
  AND ntc.rate_type = 'NEW TIER 1' 
  LEFT JOIN commissions.commissions ntc2 ON o.order_id = ntc2.order_id 
  AND ntc2.cmonth = @cmonth 
  AND cp.comp_plan_id = ntc2.comp_plan_id 
  AND ntc2.rate_type = 'NEW TIER 2' 
  LEFT JOIN commissions.commissions ntc3 ON o.order_id = ntc3.order_id 
  AND ntc3.cmonth = @cmonth 
  AND cp.comp_plan_id = ntc3.comp_plan_id 
  AND ntc3.rate_type = 'NEW TIER 3' 
  LEFT JOIN commissions.commissions rfc ON o.order_id = rfc.order_id 
  AND rfc.cmonth = @cmonth 
  AND cp.comp_plan_id = rfc.comp_plan_id 
  AND rfc.rate_type = 'RESELLER' 
  LEFT JOIN interlink.order_cancels oc ON o.order_id = oc.order_id 
  LEFT JOIN commissions.rep_payroll_transactions current_payroll ON base.order_id = current_payroll.order_id 
  AND base.user_id = current_payroll.user_id 
  AND current_payroll.cmonth = @cmonth 
  AND current_payroll.payroll_date = @payroll_month $joins 
WHERE 
  1 
  AND (
    payroll.payroll_date <= @payroll_month 
    OR payroll.payroll_date IS NULL
  ) 
  AND (
    (
      o.order_date >= @report_start 
      AND o.order_date <= @report_end
    ) 
    OR (
      qcu.year >= @report_start 
      AND qcu.year <= @report_end
    ) 
    OR (
      " . ($rep_view ? " CASE WHEN @year = YEAR(@cmonth) THEN p_oi.order_revenue_total_ytd - p_oi.credit_total_ytd != 0 ELSE 0 END " : " p_oi.order_revenue_total_ytd - p_oi.credit_total_ytd != 0 " ) ."
    )
  ) $where $renew_order_filter 
GROUP BY 
  u.user_id, 
  o.order_id, 
  t.id, 
  payroll.payroll_date;</td><td></td><td>skip</td></tr>
   <tr><td>reports/commissions/combined/generate_query_data.inc:383</td><td>CREATE TEMPORARY TABLE previous_orders (
  PRIMARY KEY (user_id, order_id)
) 
SELECT 
  o.order_id, 
  CASE WHEN YEAR(o.order_date) < @year THEN p_oi.order_revenue_total_ytd - p_oi.credit_total_ytd - p_oi.order_tax_total_ytd ELSE o.order_total - o.sales_tax - o.credit_total END net_order_total, 
  ioc.orig_order_date order_date, 
  ou.user_id 
FROM 
  commissions.order_users ou 
  INNER JOIN commissions.orders o ON ou.order_id = o.order_id 
  INNER JOIN commissions.order_info oi ON o.order_id = oi.order_id 
  INNER JOIN order_totals ot ON ot.order_id = ou.order_id 
  INNER JOIN compensation_plans cpo ON ou.comp_plan_id = cpo.comp_plan_id 
  AND ou.user_id = cpo.user_id 
  AND ou.cmonth = cpo.cmonth 
  AND YEAR(ou.order_date)= cpo.year 
  LEFT JOIN commissions.order_info p_oi ON o.order_id = p_oi.order_id 
  AND p_oi.cmonth = CASE WHEN @year <> YEAR(@cmonth) THEN CONCAT_WS('-', @year, '12', '01') ELSE @cmonth END 
  LEFT JOIN area_users au ON au.area_id = cpo.area_id 
  AND au.user_id = ou.user_id 
  LEFT JOIN commissions.interlink_orders_copy ioc ON ioc.order_id = o.order_id $joins 
WHERE 
  o.cmonth = @cmonth 
  AND oi.cmonth = @cmonth 
  AND ou.cmonth = @cmonth 
  AND (
    YEAR(o.order_date) = @year 
    OR (
      p_oi.order_revenue_total_ytd - p_oi.credit_total_ytd != 0
    )
  ) $renew_order_total_filter 
GROUP BY 
  user_id, 
  order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:62</td><td>CREATE TEMPORARY TABLE tech.tmp_order_sales_tax (
  PRIMARY KEY (order_id)
) 
SELECT 
  o.order_id, 
  YEAR(o.order_date) fiscal_year, 
  0 academic_year_id, 
  'Sales Tax' academic_year, 
  o.account_id, 
  SUM(od.price * od.quantity) sales_tax 
FROM 
  interlink.orders o 
  INNER JOIN interlink.order_summary os ON os.order_id = o.order_id 
  INNER JOIN interlink.order_details od ON o.order_id = od.order_id 
  AND product_id = 9969 
WHERE 
  o.order_date BETWEEN '$start_date' 
  AND '$end_date' 
  AND os.order_total <> 0 
GROUP BY 
  o.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:81</td><td>CREATE TEMPORARY TABLE tech.order_account_ay_totals_unmatched (
  PRIMARY KEY (order_id)
) 
SELECT 
  od.order_id, 
  YEAR(o.order_date) fiscal_year, 
  o.account_id, 
  SUM(product_total) list_total, 
  SUM(after_my_total - product_total) my_spread_total, 
  SUM(after_std_total - after_my_total) std_discount_total, 
  SUM(
    discounted_total - after_std_total
  ) non_std_discount_total, 
  SUM(discounted_total) order_line_total, 
  GROUP_CONCAT(DISTINCT od.sku) sku 
FROM 
  order_details od 
  LEFT JOIN interlink.order_details oid ON od.order_detail_id = oid.order_detail_id 
  INNER JOIN interlink.orders o ON o.order_id = od.order_id 
WHERE 
  oid.order_detail_id IS NULL 
  AND YEAR(o.order_date)>= 2009 
  AND discounted_total <> 0 
  AND o.order_date BETWEEN '$start_date' 
  AND '$end_date' 
  AND od.order_detail_id = 0 
GROUP BY 
  od.order_id 
ORDER BY 
  fiscal_year;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:103</td><td>CREATE TEMPORARY TABLE tech.unmatched_order_ays (
  PRIMARY KEY (order_id)
) 
SELECT 
  ayu.order_id, 
  MAX(ayd.academic_year_id) max_ay_id, 
  MIN(ayd.academic_year_id) min_ay_id, 
  COUNT(DISTINCT ayd.academic_year_id) count_ay 
FROM 
  tech.order_account_ay_totals_unmatched ayu 
  LEFT JOIN interlink.order_details ayd ON ayd.order_id = ayu.order_id 
  AND ayd.academic_year_id <> 0 
GROUP BY 
  ayu.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:132</td><td>CREATE TEMPORARY TABLE tech.order_account_ay_totals_unmatched_ay(
  PRIMARY KEY (order_id, academic_year_id)
) 
SELECT 
  u.order_id, 
  account_id, 
  fiscal_year, 
  GREATEST(max_ay_id, min_ay_id) academic_year_id, 
  ay.academic_year_name, 
  list_total / count_ay list_total, 
  my_spread_total / count_ay my_spread_total, 
  std_discount_total / count_ay std_discount_total, 
  non_std_discount_total / count_ay non_std_discount_total, 
  order_line_total / count_ay order_line_total 
FROM 
  tech.order_account_ay_totals_unmatched u 
  INNER JOIN tech.unmatched_order_ays ayu ON ayu.order_id = u.order_id 
  LEFT JOIN interlink.academic_years ay ON ayu.max_ay_id = ay.academic_year_id 
UNION ALL 
SELECT 
  u.order_id, 
  account_id, 
  fiscal_year, 
  LEAST(
    CASE WHEN max_ay_id = min_ay_id THEN NULL ELSE max_ay_id END, 
    min_ay_id
  ) academic_year_id, 
  ay.academic_year_name, 
  list_total / count_ay list_total, 
  my_spread_total / count_ay my_spread_total, 
  std_discount_total / count_ay std_discount_total, 
  non_std_discount_total / count_ay non_std_discount_total, 
  order_line_total / count_ay order_line_total 
FROM 
  tech.order_account_ay_totals_unmatched2 u 
  INNER JOIN tech.unmatched_order_ays2 ayu ON ayu.order_id = u.order_id 
  LEFT JOIN interlink.academic_years ay ON ayu.min_ay_id = ay.academic_year_id 
HAVING 
  academic_year_id IS NOT NULL;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:181</td><td>CREATE TABLE tech.tmp_booking_detail_product_lines (
  PRIMARY KEY (order_detail_id), 
  INDEX (
    order_id, account_id, academic_year_id
  )
) 
SELECT 
  od.order_detail_id, 
  o.order_id, 
  od.account_id, 
  od.academic_year_id, 
  IFNULL(
    pr.program_name, pl.product_line_str
  ) product_line_str, 
  CASE WHEN odis.sub_program_id IN (10, 12) THEN 1 ELSE COALESCE(odis.sub_program_id, 0) END sub_program_id 
FROM 
  interlink.orders o 
  INNER JOIN interlink.order_details od ON od.order_id = o.order_id 
  LEFT JOIN interlink.products p ON p.product_id = od.product_id 
  LEFT JOIN interlink.product_lines pl ON pl.product_line_id = p.product_line_id 
  LEFT JOIN interlink.programs pr ON pr.program_id = p.program_id 
  AND pl.product_line_id IN(3, 4, 11) 
  LEFT JOIN interlink.order_detail_info_summary odis ON odis.order_detail_id = od.order_detail_id 
WHERE 
  o.order_date >= '2010-01-01' 
  AND od.academic_year_id <> 0 
GROUP BY 
  od.order_detail_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/booking_totals.php:212</td><td>CREATE TEMPORARY TABLE tech.zero_dollar_order_discounts (
  PRIMARY KEY(order_id)
) 
SELECT 
  os.order_id, 
  o.order_date, 
  SUM(
    CASE WHEN p.product_group_id = 28 
    AND p.product_id = 2 THEN price ELSE 0 END
  ) non_std_discounts, 
  SUM(
    CASE WHEN p.product_group_id = 28 
    AND p.product_id <> 2 THEN price ELSE 0 END
  ) std_discounts, 
  SUM(
    CASE WHEN p.product_group_id = 32 
    AND p.product_id <> 9969 THEN price ELSE 0 END
  ) fees, 
  SUM(
    CASE WHEN p.product_group_id <> 28 
    AND od.academic_year_id <> 0 
    AND p.product_id <> 9969 THEN list_price * quantity ELSE 0 END
  ) list_price, 
  SUM(
    CASE WHEN p.product_group_id <> 28 
    AND od.academic_year_id <> 0 
    AND p.product_id <> 9969 THEN price * quantity ELSE 0 END
  ) price, 
  SUM(
    CASE WHEN p.product_group_id = 28 
    AND p.product_id = 2 THEN price ELSE 0 END
  ) #non-standard-discoutns
  + SUM(
    CASE WHEN p.product_group_id = 32 
    AND p.product_id <> 9969 THEN price ELSE 0 END
  ) #fees
  + SUM(
    CASE WHEN p.product_group_id <> 28 
    AND od.academic_year_id <> 0 
    AND p.product_id <> 9969 THEN (price - list_price)* quantity ELSE 0 END
  ) #price_adjust
  total_non_std_discount 
FROM 
  interlink.order_details od 
  INNER JOIN interlink.orders o ON o.order_id = od.order_id 
  INNER JOIN interlink.products p ON p.product_id = od.product_id 
  INNER JOIN interlink.order_summary os ON os.order_id = od.order_id 
WHERE 
  os.order_total = 0 
  AND o.order_date BETWEEN '$start_date' 
  AND '$end_date' 
GROUP BY 
  od.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:238</td><td>CREATE TEMPORARY TABLE tech.zero_dollar_order_details (
  PRIMARY KEY(order_detail_id)
) 
SELECT 
  od.order_id, 
  od.order_detail_id, 
  od.list_price * od.quantity detail_list_price, 
  (
    (od.list_price * od.quantity)/ zo.list_price
  )* std_discounts std_discounts, 
  (
    (od.list_price * od.quantity)/ zo.list_price
  )* total_non_std_discount non_std_discounts 
FROM 
  interlink.order_details od 
  INNER JOIN interlink.products p ON p.product_id = od.product_Id 
  INNER JOIN tech.zero_dollar_order_discounts zo ON zo.order_id = od.order_id 
WHERE 
  p.product_group_id NOT IN (28, 32);</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:255</td><td>CREATE TABLE amortization.booking_detail_totals (
  PRIMARY KEY (order_detail_id)
) 
SELECT 
  od.order_id, 
  od.order_detail_id, 
  YEAR(o.order_date) fiscal_year, 
  COALESCE(
    oid.account_id, od.account_id, o.account_id
  ) account_id, 
  COALESCE(
    oid.academic_year_id, od.academic_year_id
  ) academic_year_id, 
  COALESCE(
    ay.academic_year_name, od.academic_year
  ) academic_year, 
  SUM(product_total) list_total, 
  SUM(after_my_total - product_total) my_spread_total, 
  SUM(after_std_total - after_my_total) std_discount_total, 
  SUM(
    discounted_total - after_std_total
  ) non_std_discount_total, 
  SUM(discounted_total) order_line_total, 
  SUM(
    CASE WHEN spt.recurring_yearly = 'N' THEN discounted_total ELSE 0 END
  ) non_recurring_line_total, 
  SUM(
    CASE WHEN spt.pd_deliverable = 'Y' THEN discounted_total ELSE 0 END
  ) pd_line_total 
FROM 
  order_details od 
  LEFT JOIN interlink.order_details oid ON od.order_detail_id = oid.order_detail_id 
  LEFT JOIN interlink.academic_years ay on ay.academic_year_id = oid.academic_year_id 
  INNER JOIN interlink.orders o ON o.order_id = od.order_id 
  LEFT JOIN interlink.sub_product_types spt ON spt.sub_product_type_id = od.sub_product_type_id 
  LEFT JOIN tech.zero_dollar_order_discounts zo ON zo.order_id = od.order_id 
WHERE 
  1 
  AND o.order_date BETWEEN '$start_date' 
  AND '$end_date' 
  AND zo.order_id is NULL 
  AND od.order_detail_id <> 0 
GROUP BY 
  order_detail_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/booking_totals.php:298</td><td>CREATE TEMPORARY TABLE tech.tmp_cancels_merge (
  PRIMARY KEY (
    line_id, cancel_id, order_detail_id
  ), 
  INDEX(order_detail_id, cancel_id), 
  INDEX (
    order_id, account_id, academic_year_id
  ), 
  INDEX(order_id, cancel_id)
) 
SELECT 
  odc1.line_id, 
  odc1.order_detail_id, 
  odc1.order_id, 
  od.account_id, 
  od.academic_year_id, 
  odc1.academic_year, 
  odc1.cancel_id1 cancel_id, 
  odc1.cancel_date1 cancel_date, 
  odc1.cancel_total1 cancel_total 
FROM 
  order_details odc1 
  LEFT JOIN interlink.order_details od ON odc1.order_detail_id = od.order_detail_id 
WHERE 
  odc1.cancel_id1 > 0 
  AND odc1.cancel_date1 BETWEEN '$start_date' 
  AND '$end_date' 
UNION ALL 
SELECT 
  odc2.line_id, 
  odc2.order_detail_id, 
  odc2.order_id, 
  od.account_id, 
  od.academic_year_id, 
  odc2.academic_year, 
  odc2.cancel_id2, 
  odc2.cancel_date2, 
  odc2.cancel_total2 
FROM 
  order_details odc2 
  LEFT JOIN interlink.order_details od ON odc2.order_detail_id = od.order_detail_id 
WHERE 
  odc2.cancel_id2 > 0 
  AND odc2.cancel_date2 BETWEEN '$start_date' 
  AND '$end_date' 
UNION ALL 
SELECT 
  odc3.line_id, 
  odc3.order_detail_id, 
  odc3.order_id, 
  od.account_id, 
  od.academic_year_id, 
  odc3.academic_year, 
  odc3.cancel_id3, 
  odc3.cancel_date3, 
  odc3.cancel_total3 
FROM 
  order_details odc3 
  LEFT JOIN interlink.order_details od ON odc3.order_detail_id = od.order_detail_id 
WHERE 
  odc3.cancel_id3 > 0 
  AND odc3.cancel_date3 BETWEEN '$start_date' 
  AND '$end_date' 
UNION ALL 
SELECT 
  odc4.line_id, 
  odc4.order_detail_id, 
  odc4.order_id, 
  od.account_id, 
  od.academic_year_id, 
  odc4.academic_year, 
  odc4.cancel_id4, 
  odc4.cancel_date4, 
  odc4.cancel_total4 
FROM 
  order_details odc4 
  LEFT JOIN interlink.order_details od ON odc4.order_detail_id = od.order_detail_id 
WHERE 
  odc4.cancel_id4 > 0 
  AND odc4.cancel_date4 BETWEEN '$start_date' 
  AND '$end_date' 
UNION ALL 
SELECT 
  odc5.line_id, 
  odc5.order_detail_id, 
  odc5.order_id, 
  od.account_id, 
  od.academic_year_id, 
  odc5.academic_year, 
  odc5.cancel_id5, 
  odc5.cancel_date5, 
  odc5.cancel_total5 
FROM 
  order_details odc5 
  LEFT JOIN interlink.order_details od ON odc5.order_detail_id = od.order_detail_id 
WHERE 
  odc5.cancel_id5 > 0 
  AND odc5.cancel_date5 BETWEEN '$start_date' 
  AND '$end_date';</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:345</td><td>CREATE TEMPORARY TABLE tech.tmp_cancels_zero_insert (
  INDEX(order_detail_id, cancel_id), 
  id INT AUTO_INCREMENT PRIMARY KEY
) 
SELECT 
  oc.order_id, 
  oc.cancel_id, 
  od.order_detail_id, 
  od.account_id, 
  od.academic_year_id, 
  ay.academic_year_name academic_year, 
  oc.credit_amount cancel_total 
FROM 
  interlink.order_cancels oc 
  LEFT JOIN tech.tmp_cancels_merge c ON c.cancel_id = oc.cancel_id 
  AND c.order_id = oc.order_id 
  INNER JOIN interlink.order_details od ON od.cancel_id = oc.cancel_id 
  LEFT JOIN interlink.academic_years ay ON ay.academic_year_id = od.academic_year_id 
WHERE 
  oc.cancel_date BETWEEN '$start_date' 
  AND '$end_date' 
  AND c.cancel_id IS NULL 
  AND NOT(
    oc.credit_amount = 0 
    AND od.academic_year_id = 0
  );</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:368</td><td>CREATE TEMPORARY TABLE tech.tmp_cancels_zero_insert (
  INDEX(order_detail_id, cancel_id), 
  id INT AUTO_INCREMENT PRIMARY KEY
) 
SELECT 
  oc.order_id, 
  oc.cancel_id, 
  od.order_detail_id, 
  od.account_id, 
  od.academic_year_id, 
  ay.academic_year_name academic_year, 
  oc.credit_amount cancel_total 
FROM 
  interlink.order_cancels oc 
  LEFT JOIN tech.tmp_cancels_merge c ON c.cancel_id = oc.cancel_id 
  AND c.order_id = oc.order_id 
  INNER JOIN interlink.order_details od ON od.cancel_id = 0 
  AND od.order_id = oc.order_id 
  AND od.academic_year_id <> 0 
  LEFT JOIN interlink.academic_years ay ON ay.academic_year_id = od.academic_year_id 
WHERE 
  oc.cancel_date BETWEEN '$start_date' 
  AND '$end_date' 
  AND c.cancel_id IS NULL 
  AND oc.credit_amount = 0 
  AND oc.credit_type = 'F';</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:389</td><td>CREATE TABLE amortization.booking_cancel_detail_totals (
  PRIMARY KEY (order_detail_id, cancel_id)
) 
SELECT 
  m.order_detail_id, 
  m.cancel_id, 
  m.order_id, 
  m.account_id, 
  m.academic_year_id, 
  m.academic_year, 
  YEAR(m.cancel_date) yr, 
  (
    CASE WHEN oid.cancel_id = m.cancel_id 
    OR (
      o.status = 1 
      AND oc.credit_type = 'F' 
      AND oid.cancel_id = 0
    ) THEN odt.list_total *-1 ELSE 0 END
  ) list_cancel_total, 
  (
    CASE WHEN oid.cancel_id = m.cancel_id 
    OR (
      o.status = 1 
      AND oc.credit_type = 'F' 
      AND oid.cancel_id = 0
    ) THEN odt.std_discount_total *-1 ELSE 0 END
  ) std_discount_cancel_total, 
  (
    CASE WHEN oid.cancel_id = m.cancel_id 
    OR (
      o.status = 1 
      AND oc.credit_type = 'F' 
      AND oid.cancel_id = 0
    ) THEN (
      SUM(m.cancel_total)-(
        odt.list_total + odt.std_discount_total
      )
    )*-1 ELSE SUM(m.cancel_total)*-1 END
  ) non_std_discount_cancel_total, 
  SUM(m.cancel_total *-1) cancel_total, 
  SUM(
    CASE WHEN spt.recurring_yearly = 'N' THEN cancel_total *-1 ELSE 0 END
  ) non_recurring_cancel_total, 
  SUM(
    CASE WHEN spt.pd_deliverable = 'Y' THEN cancel_total *-1 ELSE 0 END
  ) pd_cancel_total 
FROM 
  tech.tmp_cancels_merge m 
  LEFT JOIN order_details od ON od.line_id = m.line_id 
  LEFT JOIN interlink.sub_product_types spt ON spt.sub_product_type_id = od.sub_product_type_id 
  LEFT JOIN interlink.orders o ON o.order_id = m.order_id 
  LEFT JOIN interlink.order_details oid ON oid.order_detail_id = m.order_detail_id 
  LEFT JOIN interlink.order_cancels oc ON oc.cancel_id = m.cancel_id 
  AND oc.order_id = m.order_id 
  LEFT JOIN amortization.booking_detail_totals odt ON odt.order_detail_id = m.order_detail_id 
GROUP BY 
  order_detail_id, 
  cancel_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/booking_totals.php:434</td><td>CREATE TEMPORARY TABLE tech.tmp_merge_all_order_level_pre (
  PRIMARY KEY (
    order_id, cancel_id, account_id, fiscal_year, 
    academic_year_id, sub_program_id
  )
) 
SELECT 
  od.order_id, 
  0 cancel_id, 
  od.account_id, 
  od.academic_year_id, 
  od.academic_year, 
  od.fiscal_year, 
  IFNULL(pl.sub_program_id, 0) sub_program_id, 
  SUM(list_total) list_total, 
  SUM(my_spread_total) my_spread_total, 
  SUM(std_discount_total) std_discount_total, 
  SUM(non_std_discount_total) non_std_discount_total, 
  SUM(order_line_total) line_total, 
  SUM(non_recurring_line_total) non_recurring_line_total, 
  SUM(pd_line_total) pd_line_total, 
  GROUP_CONCAT(
    DISTINCT pl.product_line_str 
    ORDER BY 
      pl.product_line_str SEPARATOR ';'
  ) product_details 
FROM 
  amortization.booking_detail_totals od 
  LEFT JOIN tech.tmp_booking_detail_product_lines pl ON od.order_detail_id = pl.order_detail_id 
GROUP BY 
  order_id, 
  account_id, 
  fiscal_year, 
  academic_year_id, 
  IFNULL(pl.sub_program_id, 0) 
UNION ALL 
SELECT 
  od.order_id, 
  od.cancel_id, 
  od.account_id, 
  od.academic_year_id, 
  academic_year, 
  od.yr fiscal_year, 
  IFNULL(pl.sub_program_id, 0), 
  SUM(list_cancel_total) list_cancel_total, 
  0 my_spread_total, 
  SUM(std_discount_cancel_total) std_discount_cancel_total, 
  SUM(non_std_discount_cancel_total) non_std_discount_cancel_total, 
  SUM(cancel_total) line_total, 
  SUM(non_recurring_cancel_total) non_recurring_line_total, 
  SUM(pd_cancel_total) pd_line_total, 
  GROUP_CONCAT(
    DISTINCT pl.product_line_str 
    ORDER BY 
      pl.product_line_str SEPARATOR ';'
  ) product_details 
FROM 
  amortization.booking_cancel_detail_totals od 
  LEFT JOIN tech.tmp_booking_detail_product_lines pl ON od.order_detail_id = pl.order_detail_id 
GROUP BY 
  order_id, 
  cancel_id, 
  account_id, 
  fiscal_year, 
  academic_year_id, 
  IFNULL(pl.sub_program_id, 0) 
UNION ALL 
SELECT 
  order_id, 
  0 cancel_id, 
  account_id, 
  academic_year_id, 
  academic_year, 
  fiscal_year, 
  0 sub_program_id, 
  0 list_total, 
  0 my_spread_total, 
  0 std_discount_total, 
  0 non_std_discount_total, 
  SUM(sales_tax) line_total, 
  0 non_recurring_line_total, 
  0 pd_line_total, 
  '' product_details 
FROM 
  tech.tmp_order_sales_tax 
GROUP BY 
  order_id, 
  account_id, 
  fiscal_year, 
  academic_year_id 
UNION ALL 
SELECT 
  order_id, 
  0 cancel_id, 
  account_id, 
  academic_year_id, 
  academic_year_name, 
  fiscal_year, 
  1 sub_program_id, 
  SUM(list_total) list_total, 
  SUM(my_spread_total) my_spread_total, 
  SUM(std_discount_total) std_discount_total, 
  SUM(non_std_discount_total) non_std_discount_total, 
  SUM(order_line_total) line_total, 
  0 non_recurring_line_total, 
  0 pd_line_total, 
  '' product_details 
FROM 
  tech.order_account_ay_totals_unmatched_ay 
GROUP BY 
  order_id, 
  account_id, 
  fiscal_year, 
  academic_year_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:474</td><td>CREATE TABLE amortization.booking_order_account_base (
  PRIMARY KEY (
    order_id, cancel_id, account_id, academic_year_id, 
    fiscal_year, sub_program_id
  )
) 
SELECT 
  order_id, 
  cancel_id, 
  account_id, 
  academic_year_id, 
  academic_year, 
  fiscal_year, 
  sub_program_id, 
  SUM(list_total) list_total, 
  SUM(my_spread_total) my_spread_total, 
  SUM(std_discount_total) std_discount_total, 
  SUM(non_std_discount_total) non_std_discount_total, 
  SUM(line_total) line_total, 
  SUM(non_recurring_line_total) non_recurring_line_total, 
  SUM(pd_line_total) pd_line_total, 
  IFNULL(product_details, '') product_details 
FROM 
  tech.tmp_merge_all_order_level_pre 
GROUP BY 
  order_id, 
  cancel_id, 
  account_id, 
  academic_year_id, 
  fiscal_year, 
  sub_program_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/booking_totals.php:488</td><td>CREATE TABLE amortization.booking_total_product_details (
  PRIMARY KEY (order_id, cancel_id)
) 
SELECT 
  od.order_id, 
  0 cancel_id, 
  GROUP_CONCAT(
    DISTINCT pl.product_line_str 
    ORDER BY 
      pl.product_line_str SEPARATOR ';'
  ) product_details 
FROM 
  amortization.booking_detail_totals od 
  LEFT JOIN tech.tmp_booking_detail_product_lines pl ON od.order_detail_id = pl.order_detail_id 
GROUP BY 
  order_id, 
  cancel_id 
UNION ALL 
SELECT 
  od.order_id, 
  od.cancel_id, 
  GROUP_CONCAT(
    DISTINCT pl.product_line_str 
    ORDER BY 
      pl.product_line_str SEPARATOR ';'
  ) product_details 
FROM 
  amortization.booking_cancel_detail_totals od 
  LEFT JOIN tech.tmp_booking_detail_product_lines pl ON od.order_detail_id = pl.order_detail_id 
GROUP BY 
  order_id, 
  cancel_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/booking_totals.php:532</td><td>CREATE TEMPORARY TABLE tmp_order_level_info (
  PRIMARY KEY (order_id)
) 
SELECT 
  o.order_id, 
  op.lead_source_id, 
  ls.lead_source_name, 
  CASE WHEN op.lead_source_id = 31 THEN 1 ELSE 0 END is_pilot, 
  rsl.user_id reseller_id, 
  CONCAT(
    rsl.first_name, ' ', rsl.last_name
  ) reseller_name 
FROM 
  interlink.orders o 
  INNER JOIN interlink.order_summary os ON os.order_id = o.order_id 
  INNER JOIN interlink.opportunities op ON op.order_id = o.order_id 
  LEFT JOIN interlink.lead_sources ls ON ls.lead_source_id = op.lead_source_id 
  LEFT JOIN interlink.user_orders uolr ON uolr.order_id = o.order_id 
  AND uolr.role_id = 42 
  LEFT JOIN interlink.users rsl on rsl.user_id = uolr.user_id 
WHERE 
  o.order_date BETWEEN '$start_date' 
  AND '$end_date' 
GROUP by 
  o.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:555</td><td>CREATE TABLE amortization.booking_order_detail_new_renew_percent_unlocked (
  PRIMARY KEY (
    order_detail_id, cancel_id, order_id
  ), 
  percent_new DECIMAL (20, 18), 
  percent_renew DECIMAL(20, 18)
) 
SELECT 
  a.order_id, 
  a.cancel_id, 
  a.order_detail_id, 
  IFNULL(
    ROUND(r.new_percent_fin, 18), 
    os.new_total /(os.new_total + os.renew_total)
  ) percent_new, 
  IFNULL(
    ROUND(r.renew_percent_fin, 18), 
    os.renew_total /(os.new_total + os.renew_total)
  ) percent_renew, 
  SUM(a.period_total) detail_period_total, 
  SUM(
    CASE WHEN spt.recurring_yearly = 'N' THEN a.period_total ELSE 0 END
  ) non_recurring_detail_period_total, 
  SUM(
    CASE WHEN spt.pd_deliverable = 'Y' THEN a.period_total ELSE 0 END
  ) pd_detail_period_total 
FROM 
  amortization.order_detail_amortization a 
  INNER JOIN interlink.order_summary os ON os.order_id = a.order_id 
  INNER JOIN interlink.orders o ON os.order_id = o.order_id 
  LEFT JOIN interlink.order_detail_new_renew_summary r ON a.order_detail_id = r.order_detail_id 
  AND a.order_id = r.order_id 
  LEFT JOIN interlink.sub_product_types spt ON spt.sub_product_type_id = a.sub_product_type_id 
WHERE 
  o.order_date >= '2010-01-01' 
GROUP BY 
  a.order_id, 
  a.cancel_id, 
  a.order_detail_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/booking_totals.php:574</td><td>CREATE TEMPORARY TABLE tmp_account_ay_new_renew (
  PRIMARY KEY (
    order_id, cancel_id, academic_year_id, 
    account_id, sub_program_id
  )
) 
SELECT 
  nr.order_id, 
  nr.cancel_id, 
  COALESCE(
    od.academic_year_id, aod.academic_year_id
  ) academic_year_id, 
  COALESCE(od.account_id, aod.account_id) account_id, 
  COALESCE(pl.sub_program_id, 0) sub_program_id, 
  sum(nr.detail_period_total) line_total, 
  sum(
    nr.detail_period_total * nr.percent_new
  ) line_new_total, 
  sum(
    nr.detail_period_total * nr.percent_renew
  ) line_renew_total, 
  sum(
    nr.non_recurring_detail_period_total
  ) non_recurring_line_total, 
  sum(
    nr.non_recurring_detail_period_total * nr.percent_new
  ) non_recurring_new_total, 
  sum(
    nr.non_recurring_detail_period_total * nr.percent_renew
  ) non_recurring_renew_total, 
  sum(nr.pd_detail_period_total) pd_line_total, 
  sum(
    nr.pd_detail_period_total * nr.percent_new
  ) pd_new_total, 
  sum(
    nr.pd_detail_period_total * nr.percent_renew
  ) pd_renew_total 
FROM 
  amortization.booking_order_detail_new_renew_percent_unlocked nr 
  INNER JOIN amortization.booking_detail_totals aod ON aod.order_detail_id = nr.order_detail_id 
  LEFT JOIN interlink.order_details od ON nr.order_detail_id = od.order_detail_id 
  AND nr.order_id = od.order_id 
  LEFT JOIN tech.tmp_booking_detail_product_lines pl ON pl.order_detail_id = nr.order_detail_id 
WHERE 
  1 
GROUP BY 
  nr.order_id, 
  nr.cancel_id, 
  academic_year_id, 
  account_id, 
  COALESCE(pl.sub_program_id, 0);</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:600</td><td>CREATE TEMPORARY TABLE order_min_details (
  PRIMARY KEY (order_id, cancel_id)
) 
SELECT 
  order_id, 
  cancel_id, 
  MIN(account_id) min_account_id, 
  SUBSTRING_INDEX(
    MIN(
      CONCAT(
        LPAD(account_id, 10, 0), 
        '|', 
        academic_year_id
      )
    ), 
    '|', 
    -1
  ) min_ay_id, 
  MIN(sub_program_id) min_sub_program_id 
FROM 
  amortization.booking_order_account_base 
WHERE 
  academic_year_id <> 0 
GROUP BY 
  order_id, 
  cancel_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:614</td><td>CREATE TABLE booking_total_account_districts (
  PRIMARY KEY (account_id)
) 
SELECT 
  a.account_id, 
  a.account_name, 
  a.state_code, 
  a.account_level, 
  COALESCE(d1.account_id, a.account_id) district_account_id, 
  CASE WHEN d1.account_id 
  OR a.account_level = 1 THEN 1 ELSE 0 END has_district, 
  CASE WHEN a.account_type = 16 
  OR a.account_id = $HSBC_ID 
  OR d1.account_id = $HSBC_ID THEN 1 ELSE 0 END is_individual 
FROM 
  interlink.accounts a 
  LEFT JOIN interlink.accounts d1 ON d1.account_id = a.parent_account_id 
  AND d1.account_level = 1 
  AND a.account_level = 2 
GROUP by 
  a.account_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/booking_totals.php:629</td><td>CREATE TABLE amortization.booking_total_acv (
  PRIMARY KEY (
    order_id, cancel_id, account_id, academic_year_id, 
    sub_program_id, is_first_acv
  ), 
  INDEX (
    ordering_account_id, non_summer_academic_year_id
  ), 
  INDEX (
    order_id, cancel_id, non_summer_academic_year_id, 
    account_id
  ), 
  INDEX (
    account_id, non_summer_academic_year_id
  ), 
  INDEX (
    district_account_id, non_summer_academic_year_id
  ), 
  sales_tax DECIMAL (22, 14), 
  sales_tax_acv DECIMAL (22, 14), 
  non_recurring_sales_tax DECIMAL (22, 14), 
  non_recurring_sales_tax_acv DECIMAL (22, 14), 
  acv_annualized_factor decimal(4, 2)
) 
SELECT 
  base.order_id, 
  base.cancel_id, 
  o.account_id ordering_account_id, 
  tad.district_account_id ordering_district_account_id, 
  o.order_date orig_order_date, 
  IFNULL(c.cancel_date, o.order_date) booking_date, 
  tad_detail.district_account_id, 
  base.account_id, 
  base.academic_year_id, 
  base.academic_year, 
  ay.summer, 
  COALESCE(
    ay_ext.academic_year_id, ay.academic_year_id
  ) non_summer_academic_year_id, 
  COALESCE(
    ay_ext.academic_year_name, ay.academic_year_name
  ) non_summer_academic_year, 
  COALESCE(ay_ext.sort, ay.sort) non_summer_academic_year_sort, 
  CASE WHEN ay.summer = 1 THEN 1 ELSE toay.is_partial END is_partial, 
  toay.is_leading_partial, 
  toay.is_od_il_partial, 
  base.sub_program_id, 
  pg.program_name sub_program_name, 
  CASE WHEN acvy.order_id 
  AND acvy.is_first_acv = 1 THEN 1 ELSE 0 END is_first_acv, 
  CASE WHEN acvy.order_id 
  AND acvy.is_first_acv = 0 THEN 1 ELSE 0 END is_first_acv_no_credit, 
  0 is_arr_acv, 
  0 is_myo, 
  CASE WHEN md.order_id IS NOT NULL THEN 1 ELSE 0 END is_first_detail, 
  IFNULL(base.list_total, 0) list_total, 
  IFNULL(base.my_spread_total, 0) my_spread_total, 
  IFNULL(base.std_discount_total, 0) std_discount_total, 
  IFNULL(base.non_std_discount_total, 0) non_std_discount_total, 
  IFNULL(base.non_std_discount_total, 0)+ IFNULL(base.my_spread_total, 0) adjusted_non_std_discount_total, 
  IFNULL(base.line_total, 0) line_total_no_tax, 
  IFNULL(base.line_total, 0) line_total, 
  IFNULL(nr.line_new_total, 0) new_total, 
  IFNULL(nr.line_renew_total, 0) renew_total, 
  0 sales_tax, 
  IFNULL(base.line_total, 0) / CASE WHEN pyo.order_id 
  AND base.academic_year_id <> 0 THEN.7 ELSE 1 END line_total_acv_no_tax, 
  IFNULL(base.line_total, 0) / CASE WHEN pyo.order_id 
  AND base.academic_year_id <> 0 THEN.7 ELSE 1 END line_total_acv, 
  IFNULL(nr.line_new_total, 0) / CASE WHEN pyo.order_id 
  AND base.academic_year_id <> 0 THEN.7 ELSE 1 END new_total_acv, 
  IFNULL(nr.line_renew_total, 0) / CASE WHEN pyo.order_id 
  AND base.academic_year_id <> 0 THEN.7 ELSE 1 END renew_total_acv, 
  0 sales_tax_acv, 
  base.non_recurring_line_total non_recurring_line_total, 
  IFNULL(nr.non_recurring_new_total, 0) non_recurring_new_total, 
  IFNULL(nr.non_recurring_renew_total, 0) non_recurring_renew_total, 
  0 non_recurring_sales_tax, 
  base.non_recurring_line_total / CASE WHEN pyo.order_id 
  AND base.academic_year_id <> 0 THEN.7 ELSE 1 END non_recurring_line_total_acv, 
  IFNULL(nr.non_recurring_new_total, 0) / CASE WHEN pyo.order_id 
  AND base.academic_year_id <> 0 THEN.7 ELSE 1 END non_recurring_new_total_acv, 
  IFNULL(nr.non_recurring_renew_total, 0) / CASE WHEN pyo.order_id 
  AND base.academic_year_id <> 0 THEN.7 ELSE 1 END non_recurring_renew_total_acv, 
  0 non_recurring_sales_tax_acv, 
  base.pd_line_total pd_line_total_tcv, 
  IFNULL(nr.pd_new_total, 0) pd_new_total_tcv, 
  IFNULL(nr.pd_renew_total, 0) pd_renew_total_tcv, 
  base.pd_line_total / CASE WHEN pyo.order_id 
  AND base.academic_year_id <> 0 THEN.7 ELSE 1 END pd_line_total_acv, 
  IFNULL(nr.pd_new_total, 0) / CASE WHEN pyo.order_id 
  AND base.academic_year_id <> 0 THEN.7 ELSE 1 END pd_new_total_acv, 
  IFNULL(nr.pd_renew_total, 0) / CASE WHEN pyo.order_id 
  AND base.academic_year_id <> 0 THEN.7 ELSE 1 END pd_renew_total_acv, 
  CASE WHEN pyo.order_id 
  AND base.academic_year_id <> 0 THEN.7 ELSE 1 END acv_annualized_factor, 
  
  /*2 columns for archived but stored retention report does not include tax*/
  IFNULL(base.line_total, 0) / CASE WHEN pyo.order_id 
  AND base.academic_year_id <> 0 THEN.7 ELSE 1 END line_total_w_acv_factor_no_tax, 
  IFNULL(nr.non_recurring_line_total, 0)/ CASE WHEN pyo.order_id 
  AND base.academic_year_id <> 0 THEN.7 ELSE 1 END non_recurring_line_total_w_acv_factor, 
  IFNULL(ls.lead_source_name, '') lead_source, 
  IFNULL(ls.is_pilot, 0) is_pilot, 
  tad_detail.is_individual, 
  CASE WHEN ls.is_pilot = 1 
  OR tad_detail.is_individual = 1 THEN 1 ELSE 0 END retention_exclude, 
  IFNULL(ls.reseller_name, '') reseller_name, 
  base.product_details 
FROM 
  amortization.booking_order_account_base base 
  INNER JOIN interlink.orders o ON o.order_id = base.order_id 
  LEFT JOIN booking_total_account_districts tad ON tad.account_id = o.account_id 
  LEFT JOIN booking_total_account_districts tad_detail ON tad_detail.account_id = base.account_id 
  INNER JOIN interlink.order_summary os ON os.order_id = base.order_id 
  LEFT JOIN interlink.academic_years ay ON ay.academic_year_id = base.academic_year_id 
  LEFT JOIN interlink.academic_years ay_ext ON ay.summer = 1 
  AND ay_ext.sort = ay.sort + 1 
  LEFT JOIN amortization.tmp_bookings_order_ay toay ON base.order_id = toay.order_id 
  AND base.academic_year_id = toay.academic_year_id 
  AND toay.account_id = base.account_id 
  LEFT JOIN amortization.tmp_partial_year_orders pyo ON pyo.order_id = base.order_id 
  LEFT JOIN amortization.booking_total_acv_year acvy ON acvy.order_id = base.order_id 
  AND acvy.academic_year_id = base.academic_year_id 
  LEFT JOIN tmp_account_ay_new_renew nr ON nr.order_id = base.order_id 
  AND nr.academic_year_id = base.academic_year_id 
  AND nr.account_id = base.account_id 
  AND nr.cancel_id = base.cancel_id 
  AND nr.sub_program_id = base.sub_program_id 
  LEFT JOIN order_min_details md ON md.order_id = base.order_id 
  AND base.cancel_id = md.cancel_id 
  AND base.account_id = md.min_account_id 
  AND base.academic_year_id = md.min_ay_id 
  AND base.sub_program_id = md.min_sub_program_id 
  LEFT JOIN interlink.order_cancels c ON c.cancel_id = base.cancel_id 
  AND c.order_id = base.order_id 
  LEFT JOIN tmp_order_level_info ls ON ls.order_id = base.order_id 
  LEFT JOIN interlink.programs pg ON pg.program_id = base.sub_program_id 
  LEFT JOIN interlink.mh_orders mh ON mh.order_id = o.order_id 
  AND mh.is_post_integration_order = 1 
WHERE 
  1 
  AND mh.order_id IS NULL # AND os.order_total>0    
  # AND IFNULL(c.cancel_date,o.order_date)>='2010-01-01'                                       
  ;</td><td></td><td></td></tr>
   <tr><td>reports/finance/booking_totals.php:746</td><td>CREATE TEMPORARY TABLE tmp_order_acv_values (
  PRIMARY KEY (order_id)
) 
SELECT 
  a.order_id, 
  MIN(is_first_acv) fully_acv_order, 
  COUNT(
    DISTINCT non_summer_academic_year_id
  ) count_academic_years, 
  CASE WHEN override.order_id IS NOT NULL THEN 1 ELSE 0 END myo 
FROM 
  amortization.booking_total_acv a 
  LEFT JOIN commissions.order_acv_overrides override ON (
    a.order_id = override.order_id 
    AND override.remove_booking_acv = 1 
    AND override.is_non_primary = 1 
    /* MYO booked as multiple different orders */
    ) 
WHERE 
  academic_year_id <> 0 
GROUP BY 
  a.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:770</td><td>CREATE TEMPORARY TABLE tmp_order_tax (
  PRIMARY KEY (order_id, cancel_id), 
  percent_tax DECIMAL (28, 22)
) 
SELECT 
  order_id, 
  cancel_id, 
  SUM(
    CASE WHEN academic_year_id <> 0 THEN line_total ELSE 0 END
  ) order_total, 
  SUM(
    CASE WHEN academic_year_id = 0 THEN line_total ELSE 0 END
  ) order_sales_tax, 
  0 percent_tax 
FROM 
  amortization.booking_total_acv 
GROUP BY 
  order_id, 
  cancel_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:781</td><td>CREATE TEMPORARY TABLE tmp_fully_tax_cancels (
  PRIMARY KEY (order_id, cancel_id)
) 
SELECT 
  acv.order_id, 
  acv.cancel_id, 
  sum(acv.line_total) tax_total, 
  ot.order_total 
FROM 
  amortization.booking_total_acv acv 
  INNER JOIN tmp_order_tax ot ON ot.order_id = acv.order_id 
  AND ot.cancel_id = acv.cancel_id 
GROUP BY 
  acv.order_id, 
  acv.cancel_id 
HAVING 
  MAX(acv.academic_year_id)= 0;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:979</td><td>CREATE TEMPORARY TABLE tmp_sales_tax_acv(
  PRIMARY KEY(order_id)
) 
SELECT 
  acv.order_id, 
  SUM(acv.sales_tax) sales_tax, 
  SUM(acv.sales_tax_acv) sales_tax_acv, 
  SUM(acv.sales_tax_acv)/ SUM(acv.sales_tax) acv_tax_perc 
FROM 
  amortization.booking_total_acv st_credit 
  INNER JOIN amortization.booking_total_acv acv ON st_credit.order_id = acv.order_id 
WHERE 
  acv.cancel_id = 0 
  AND st_credit.academic_year = 'Sales Tax' 
  AND st_credit.cancel_id > 0 
GROUP BY 
  acv.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:1061</td><td>CREATE TEMPORARY TABLE amortization.tmp_single_year_orders (
  PRIMARY KEY (order_id)
) 
SELECT 
  o.order_id, 
  o.order_date, 
  o.order_length, 
  o.start_date, 
  o.end_date, 
  MIN(od.start_date) min_detail_start_date, 
  MAX(od.end_date) max_detail_end_date, 
  DATEDIFF(
    MAX(od.end_date), 
    MIN(od.start_date)
  ) detail_date_diff, 
  COUNT(DISTINCT ay.academic_year_id) academic_year_count, 
  MIN(
    CASE WHEN ay.summer = 1 THEN 1 ELSE od.partial END
  ) all_partial_products, 
  COUNT(
    DISTINCT CASE WHEN ay.summer = 1 THEN ay.academic_year_id ELSE NULL END
  ) count_summers 
FROM 
  interlink.orders o 
  LEFT JOIN interlink.order_details od ON o.order_id = od.order_id 
  AND od.academic_year_id <> 0 
  AND price > 0 #(Only ay details should impact detail dates)
  LEFT JOIN interlink.academic_years ay ON ay.academic_year_id = od.academic_year_id #(LEFT JOIN, QC:15409 )
  INNER JOIN interlink.order_summary os ON os.order_id = o.order_id 
WHERE 
  1 # AND os.order_total>0
GROUP BY 
  o.order_id 
HAVING 
  (
    DATEDIFF(
      max_detail_end_date, min_detail_start_date
    )<= 365 
    OR all_partial_products = 1 
    OR academic_year_count IN (1, 0)
  ) 
  AND o.order_length <= 1 
  AND count_summers <= 1;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:1093</td><td>CREATE TEMPORARY TABLE amortization.tmp_order_dates (
  PRIMARY KEY (order_id)
) 
SELECT 
  order_id, 
  MIN(start_date) order_start_date, 
  MAX(end_date) order_end_date 
FROM 
  interlink.order_details 
GROUP BY 
  order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:1101</td><td>CREATE TABLE amortization.tmp_bookings_order_ay (
  PRIMARY KEY (
    order_id, account_id, academic_year_id
  ), 
  INDEX(order_id, ay_sort, ay_summer)
) 
SELECT 
  o.order_id, 
  od.academic_year_id, 
  od.account_id, 
  MIN(od.start_date) min_od_start, 
  MAX(od.end_date) max_od_end, 
  ay.academic_year_name, 
  ay.start_date ay_start_date, 
  ay.end_date ay_end_date, 
  ay.summer ay_summer, 
  ay.sort ay_sort, 
  CASE WHEN YEAR(
    MIN(od.start_date)
  )> YEAR(ay.start_date) 
  AND DATEDIFF(
    MAX(od.end_date), 
    MIN(od.start_date)
  )<= 212 
  AND sy.order_id IS NULL 
  AND MIN(od.start_date)= ood.order_start_date THEN 1 ELSE 0 END is_leading_partial, 
  CASE WHEN YEAR(
    MIN(od.start_date)
  )> YEAR(ay.start_date) 
  AND DATEDIFF(
    MAX(od.end_date), 
    MIN(od.start_date)
  )<= 212 THEN 1 ELSE 0 END is_partial, 
  CASE WHEN DATEDIFF(
    MAX(od.end_date), 
    MIN(od.start_date)
  )<= 212 THEN 1 ELSE 0 END is_partial_span, 
  MAX(od.partial) is_od_il_partial 
FROM 
  interlink.orders o 
  INNER JOIN amortization.tmp_order_dates ood ON o.order_id = ood.order_id 
  INNER JOIN interlink.order_details od ON o.order_id = od.order_id 
  INNER JOIN interlink.academic_years ay ON od.academic_year_id = ay.academic_year_id 
  INNER JOIN interlink.order_summary os ON os.order_id = o.order_id 
  LEFT JOIN amortization.tmp_single_year_orders sy ON sy.order_id = o.order_id 
WHERE 
  1 # AND os.order_total>0
GROUP BY 
  o.order_id, 
  od.account_id, 
  od.academic_year_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/booking_totals.php:1132</td><td>CREATE TEMPORARY TABLE amortization.tmp_partial_year_orders (
  PRIMARY KEY (order_id)
) 
SELECT 
  boa.order_id, 
  boa.academic_year_id, 
  boa.is_partial_span, 
  boa.ay_summer 
FROM 
  amortization.tmp_bookings_order_ay boa 
  INNER JOIN interlink.order_details od ON od.order_id = boa.order_id 
  AND od.academic_year_id = boa.academic_year_id 
  AND boa.account_id = od.account_id 
  INNER JOIN interlink.products p ON p.product_id = od.product_id 
  INNER JOIN interlink.sub_products sp ON p.product_id = sp.product_id 
  AND sp.status = 0 
  INNER JOIN interlink.sub_product_types spt ON spt.sub_product_type_id = sp.sub_product_type_id 
  INNER JOIN interlink.order_summary os ON os.order_id = boa.order_id 
WHERE 
  1 
  AND os.order_total - os.sales_tax > 0 
GROUP BY 
  order_id 
HAVING 
  COUNT(DISTINCT boa.academic_year_id)= 1 
  AND MIN(boa.is_partial_span)= 1 
  AND boa.ay_summer = 0 
  AND NOT (
    MIN(spt.pd_deliverable)= 'Y' 
    AND MAX(spt.pd_deliverable)= 'Y'
  ) 
  AND NOT (
    MIN(p.product_group_id)= {$PRODUCT_GROUPS[ "pd" ]} 
    AND MAX(p.product_group_id)= {$PRODUCT_GROUPS[ "pd" ]}
  );</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:1156</td><td>CREATE TEMPORARY TABLE amortization.tmp_order_ay (
  PRIMARY KEY (order_id, academic_year_id), 
  INDEX(order_id, ay_sort, ay_summer)
) 
SELECT 
  order_id, 
  academic_year_id, 
  ay_sort, 
  ay_summer, 
  MAX(is_leading_partial) is_leading_partial, 
  MAX(is_partial) is_partial, 
  MAX(is_partial_span) is_partial_span, 
  MAX(is_od_il_partial) is_od_il_partial, 
  MIN(
    GREATEST(
      is_leading_partial, is_partial, is_partial_span, 
      is_od_il_partial
    )
  ) min_partial 
FROM 
  amortization.tmp_bookings_order_ay 
GROUP BY 
  order_id, 
  academic_year_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:1170</td><td>CREATE TABLE amortization.tmp_sorted_order_ay (
  PRIMARY KEY (order_id, academic_year_id), 
  ay_num INT NOT NULL DEFAULT 0
) 
SELECT 
  sorted_ay.order_id, 
  sorted_ay.academic_year_id, 
  sorted_ay.ay_sort, 
  sorted_ay.ay_summer, 
  sorted_ay.is_leading_partial, 
  sorted_ay.is_partial, 
  sorted_ay.is_partial_span, 
  sorted_ay.is_od_il_partial, 
  sorted_ay.min_partial, 
  CASE order_id WHEN @curOrder THEN @curRow := @curRow + 1 ELSE @curRow := 1 
  AND @curOrder := order_id END sort, 
  0 ay_num 
FROM 
  (
    SELECT 
      ay.order_id, 
      ay.academic_year_id, 
      ay.ay_sort, 
      ay_summer, 
      is_leading_partial, 
      is_partial, 
      is_partial_span, 
      is_od_il_partial, 
      min_partial 
    FROM 
      amortization.tmp_order_ay ay, 
      (
        SELECT 
          @curRow := 0, 
          @curOrder := ''
      ) r 
    ORDER BY 
      order_id, 
      ay_summer, 
      is_partial, 
      is_partial_span, 
      is_od_il_partial, 
      ay_sort
  ) sorted_ay;</td><td></td><td></td></tr>
   <tr><td>reports/finance/booking_totals.php:1223</td><td>CREATE TEMPORARY TABLE amortization.tmp_min_academic_year (
  PRIMARY KEY(order_id), 
  INDEX(ay_sort)
) 
SELECT 
  ay.order_id, 
  MIN(ay_sort) ay_sort 
FROM 
  amortization.tmp_sorted_order_ay ay 
WHERE 
  1 
  AND ay.sort = 1 
GROUP BY 
  ay.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:1234</td><td>CREATE TEMPORARY TABLE amortization.tmp_order_acv_ay (
  PRIMARY KEY (order_id)
) 
SELECT 
  oay.order_id, 
  oay.academic_year_id, 
  oay.is_leading_partial, 
  COALESCE(
    sum1.academic_year_id, sum2.academic_year_id, 
    0
  ) summer_academic_year_id, 
  IFNULL(next_ay.academic_year_id, 0) next_academic_year_id 
FROM 
  amortization.tmp_bookings_order_ay oay 
  INNER JOIN amortization.tmp_min_academic_year may ON may.order_id = oay.order_id 
  AND may.ay_sort = oay.ay_sort 
  LEFT JOIN amortization.tmp_bookings_order_ay sum1 ON sum1.order_id = oay.order_id 
  AND may.ay_sort - 1 = sum1.ay_sort 
  AND sum1.ay_summer = 1 
  LEFT JOIN amortization.tmp_bookings_order_ay sum2 ON sum2.order_id = oay.order_id 
  AND may.ay_sort + 1 = sum2.ay_sort 
  AND sum2.ay_summer = 1 
  AND sum1.order_id IS NULL 
  LEFT JOIN amortization.tmp_bookings_order_ay next_ay ON next_ay.order_id = oay.order_id 
  AND may.ay_sort + 2 = next_ay.ay_sort 
  AND oay.ay_summer = 0 
  AND oay.is_leading_partial = 1 
WHERE 
  1 
GROUP BY 
  oay.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/finance/booking_totals.php:1251</td><td>CREATE TABLE amortization.booking_total_acv_year (
  PRIMARY KEY (order_id, academic_year_id), 
  acv_annualized_factor DECIMAL (3, 2)
) 
SELECT 
  o.order_id, 
  base.academic_year_id, 
  MAX(
    CASE WHEN (
      syo.order_id 
      OR ay_acv.order_id
    ) 
    AND ov.order_id IS NULL THEN 1 ELSE 0 END
  ) is_first_acv, 
  MAX(
    CASE WHEN pyo.order_id THEN.7 ELSE 1.0 END
  ) acv_annualized_factor 
FROM 
  interlink.orders o 
  INNER JOIN interlink.order_summary os ON os.order_id = o.order_id 
  LEFT JOIN interlink.order_details base ON o.order_id = base.order_id 
  AND base.academic_year_id <> 0 
  LEFT JOIN interlink.academic_years ay ON ay.academic_year_id = base.academic_year_id #Determine academic year after summer
  LEFT JOIN interlink.academic_years ay_ext ON ay.summer = 1 
  AND ay_ext.sort = ay.sort + 1 
  LEFT JOIN amortization.tmp_bookings_order_ay toay ON o.order_id = toay.order_id 
  AND base.academic_year_id = toay.academic_year_id 
  AND toay.account_id = base.account_id 
  LEFT JOIN amortization.tmp_order_acv_ay ay_acv ON o.order_id = ay_acv.order_id 
  AND base.academic_year_id IN (
    ay_acv.academic_year_id, ay_acv.summer_academic_year_id, 
    next_academic_year_id
  ) 
  LEFT JOIN amortization.tmp_single_year_orders syo ON syo.order_id = o.order_id 
  LEFT JOIN amortization.tmp_partial_year_orders pyo ON pyo.order_id = o.order_id 
  LEFT JOIN commissions.order_acv_overrides ov ON ov.order_id = o.order_id 
  AND ov.remove_booking_acv = 1 
WHERE 
  1 # AND os.order_total>0  
  AND (
    syo.order_id 
    OR ay_acv.order_id
  ) 
GROUP BY 
  o.order_id, 
  base.academic_year_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/booking_totals.php:1300</td><td>CREATE TABLE tmp_book_order_acv (
  PRIMARY KEY (order_id, cancel_id)
) 
SELECT 
  order_id, 
  cancel_id, 
  sum(line_total) line_total, 
  sum(acv_total) acv_total, 
  sum(acv_new_total) acv_new_total, 
  sum(acv_renew_total) acv_renew_total 
FROM 
  amortization.booking_acv_detail_lock 
GROUP BY 
  order_id, 
  cancel_id;</td><td></td><td></td></tr>
   <tr><td>reports/finance/booking_totals.php:1312</td><td>CREATE TABLE tmp_book_order_acv_backup (
  PRIMARY KEY (order_id, cancel_id)
) 
SELECT 
  order_id, 
  cancel_id, 
  sum(line_total) line_total, 
  sum(acv_total) acv_total, 
  sum(acv_new_total) acv_new_total, 
  sum(acv_renew_total) acv_renew_total 
FROM 
  amortization.booking_acv_detail_lock_backup 
GROUP BY 
  order_id, 
  cancel_id;</td><td></td><td></td></tr>
   <tr><td>reports/opportunities/yg_open_index.php:267</td><td>CREATE TEMPORARY TABLE $table_name 
SELECT 
  p.opportunity_id, 
  p.opportunity_name, 
  a.state_code, 
  a.account_name, 
  c.first_name, 
  c.middle_name, 
  c.last_name, 
  p.close_date, 
  s.probability_percent, 
  p.total, 
  ifnull(no_po, 'N/A') no_po_flag, 
  if(
    no_po > 0, 
    'Not Required', 
    group_concat(po.po)
  ) po_number, 
  0 nonstandard_discount, 
  0 nonstandard_pricing, 
  0 has_quote, 
  p.lead_source_id, 
  space(50) lead_source_name, 
  substr(u.first_name, 1, 1) rep_first_name, 
  u.last_name rep_last_name 
FROM 
  (
    opportunities p, accounts a, user_orders o, 
    users u, opportunity_probabilities s $fromStr
  ) 
  LEFT JOIN order_po po ON (
    p.opportunity_id = po.opportunity_id
  ) 
  LEFT JOIN order_contacts oc ON (
    o.opportunity_id = oc.opportunity_id 
    AND oc.contact_type_id = '" . $CONTACT_TYPES["buyer"] . "'
  ) 
  LEFT JOIN contacts c ON (c.contact_id = oc.contact_id) 
WHERE 
  p.account_id = a.account_id 
  AND p.opportunity_id = o.opportunity_id 
  AND o.role_id = '".$ROLE[$DEPARTMENT["sales"]]["sales_rep"]."' 
  AND o.user_id = u.user_id 
  AND p.probability_id = s.probability_id $whereStr 
GROUP BY 
  p.opportunity_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_pre_2017.php:115</td><td>CREATE TEMPORARY TABLE interlink.temp_renew_qcpr_user_data_source (
  PRIMARY KEY(renewal_user_id), 
  KEY(il_user_id)
) 
SELECT 
  
  /*Manager/User Group Data*/
  CAST(
    COALESCE(
      NULLIF(u.nvp_id, ''), 
      1
    ) as CHAR(8)
  ) nvp_id, 
  COALESCE(
    NULLIF(u.nvp, ''), 
    'No NVP'
  ) nvp, 
  CAST(
    COALESCE(
      NULLIF(u.vp_id, ''), 
      1
    ) as CHAR(8)
  ) vp_id, 
  COALESCE(
    NULLIF(u.vp, ''), 
    'No VP'
  ) vp, 
  CAST(
    COALESCE(
      NULLIF(u.rvp_id, ''), 
      1
    ) as CHAR(8)
  ) rvp_id, 
  COALESCE(
    NULLIF(u.rvp, ''), 
    'No RVP'
  ) rvp, 
  a.area_id, 
  a.parent_area_id, 
  u.`area`, 
  u.user_id il_user_id, 
  u.comp_plan_id, 
  u.comp_plan_id renewal_user_id, 
  u.user_f_last renewal_user, 
  u.last_name, 
  u.status user_status, 
  u.renewal_qcpr_status, 
  cp.termination_date termination_date, 
  CASE WHEN u.area_comp_plan_type IN ('nvp', 'vp', 'rvp', 'dm', 'a3k') THEN u.area_comp_plan_type ELSE 'renewal_user' END comp_plan_type, 
  cp.renewal_rate, 
  cp.renewal_rep, 
  CASE WHEN cp.annual_quota > 1 THEN cp.annual_quota ELSE 0 END Quota 
FROM 
  commissions.users_cp u 
  LEFT JOIN commissions.compensation_plans cp ON cp.comp_plan_id = u.comp_plan_id 
  AND cp.cmonth = '$report_month_filter' 
  and cp.year = $year 
  LEFT JOIN commissions.areas a on a.area_id = cp.area_id 
  LEFT JOIN commissions.qcpr_manager_permissions m ON m.manager_id = '$curr_user_id' 
  AND m.user_id = u.user_id 
  AND m.cmonth = '$report_month_filter' 
WHERE 
  1 
  AND u.year = $year 
  AND u.cmonth = '$report_month_filter' 
  and u.renewal_qcpr_status = 0 #Has current year order/QC/credit OR non-terminated rep with quota
  $user_where 
GROUP BY 
  u.sales_user_id, 
  u.comp_plan_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_pre_2017.php:159</td><td>CREATE TEMPORARY TABLE interlink.temp_renew_qcpr_user_data_source_copy (
  PRIMARY KEY(renewal_user_id)
) 
SELECT 
  * 
FROM 
  interlink.temp_renew_qcpr_user_data_source</td><td></td><td>skip</td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_pre_2017.php:172</td><td>CREATE TEMPORARY TABLE tmp_account_trainers (
  PRIMARY KEY (account_id), 
  trainer_user_name VARCHAR(250), 
  imp_rvp_user_name VARCHAR(250)
) 
SELECT 
  uad.account_id, 
  SUBSTRING_INDEX(
    MIN(
      CONCAT(
        CASE WHEN uad.role_id IN (4, 5) THEN uad.role_id ELSE NULL END, 
        '|', 
        uad.user_id
      )
    ), 
    '|', 
    -1
  ) trainer_user_id, 
  '' trainer_user_name, 
  MAX(
    CASE WHEN uad.role_id = 7 THEN uad.user_id ELSE NULL END
  ) imp_rvp_user_id, 
  '' imp_rvp_user_name 
FROM 
  interlink.user_account_dates uad 
  INNER JOIN commissions.renewal_report_base rb ON rb.account_id = uad.account_id 
  AND rb.cmonth = '$report_month_filter' 
  AND rb.rank = 1 
  INNER JOIN commissions.users u ON u.user_id = uad.user_id 
WHERE 
  @month_end BETWEEN uad.start_date 
  AND uad.end_date 
  AND uad.account_owner = 1 
  AND uad.role_id IN (7, 4, 5) 
GROUP BY 
  uad.account_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_pre_2017.php:203</td><td>CREATE TEMPORARY TABLE tmp_account_districts (
  PRIMARY KEY (account_id)
) 
SELECT 
  a.account_id, 
  a.account_name, 
  a.state_code, 
  a.account_level, 
  COALESCE(
    d1.account_id, CASE WHEN a.account_level = 1 THEN a.account_id ELSE -1 END
  ) district_account_id, 
  COALESCE(
    d1.account_name, CASE WHEN a.account_level = 1 THEN a.account_name ELSE '-- No District --' END
  ) district_account_name, 
  COALESCE(d1.state_code, a.state_code) district_state_code, 
  CASE WHEN d1.account_id 
  OR a.account_level = 1 THEN 1 ELSE 0 END has_district, 
  tat.trainer_user_name account_trainer, 
  tat.imp_rvp_user_name account_imp_rvp 
FROM 
  interlink.accounts a 
  INNER JOIN commissions.renewal_report_base rb ON rb.account_id = a.account_id 
  LEFT JOIN interlink.accounts d1 ON d1.account_id = a.parent_account_id 
  AND d1.account_level = 1 
  AND a.account_level = 2 
  LEFT JOIN tmp_account_trainers tat ON tat.account_id = a.account_id 
WHERE 
  rb.cmonth = '$report_month_filter' 
  AND rb.rank = 1 
GROUP BY 
  a.account_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_pre_2017.php:230</td><td>CREATE TEMPORARY TABLE interlink.temp_renew_qcpr_qc_data_source (
  row_id INT UNSIGNED not null auto_increment PRIMARY KEY, 
  INDEX(renewal_user_id)
) 
SELECT 
  
  /*USER INFO*/
  cp.user_id, 
  cp.comp_plan_id renewal_user_id, 
  base.orig_user_id, 
  base.is_primary_user, 
  
  /*ACCOUNT PROGRAM INFO*/
  tad.account_level, 
  tad.district_account_id district_account_id, 
  tad.district_account_name district_account, 
  tad.district_state_code district_state, 
  tad.district_state_code district_state_id, 
  tad.has_district, 
  tad.account_id, 
  tad.account_name account_name, 
  tad.state_code state_id, 
  tad.state_code state, 
  CASE WHEN tad.account_level = 1 THEN 'z' WHEN base.on_target = 1 
  OR b.more_prods = 1 THEN 'y' ELSE 'n' END on_target_id, 
  CASE WHEN tad.account_level = 1 THEN 'District' WHEN base.on_target = 1 
  OR b.more_prods = 1 THEN 'Within Quota' ELSE 'Not Within Quota' END on_target, 
  base.on_target orig_on_target, 
  base.program_id, 
  op.opportunity_product_name program, 
  
  /*EXPIRING ACCOUNT*/
  CONCAT(
    tad.account_id, 'p', base.program_id, 
    'o', base.order_id
  ) expiring_account_id, 
  tad.account_name expiring_account, 
  CASE WHEN base.on_target = 1 
  AND tad.account_level = 2 THEN 1 ELSE 0 END orig_expiring_school_count, 
  CASE WHEN IFNULL(b.on_target, base.on_target)= 1 
  AND base.school_rank = 1 
  AND tad.account_level = 2 THEN 1 ELSE 0 END expiring_school_count, 
  0 expiring_license_count, 
  base.renewal_quota orig_expiring_order_account_value, 
  IFNULL(
    b.renewal_quota, base.renewal_quota
  ) expiring_order_account_value, 
  base.non_quota_account, 
  
  /*NEW ORDER*/
  base.rank, 
  base.school_rank, 
  base.order_id booked_order_id, 
  base.order_id booked_order, 
  co.cancel, 
  IFNULL(b.orig_school_count, 0) orig_booked_school_count, 
  IFNULL(b.school_count, 0) booked_school_count, 
  IFNULL(b.school_count / b.on_target, 0) booked_school_percent, 
  0 booked_license_count, 
  0 booked_license_percent, 
  CASE WHEN base.non_quota_account = 1 THEN single_year_value ELSE b.all_yr_value END booked_order_account_value, 
  
  /*ACV*/
  LEAST(
    single_year_value, base.renewal_quota
  ) acv_matching_value, 
  GREATEST(
    single_year_value - base.renewal_quota, 
    0
  ) acv_more_value, 
  single_year_value acv_total, 
  IFNULL(
    b.single_year_value / base.renewal_quota, 
    0
  ) acv_percent, 
  more_products_yr_1 target_more_products, 
  single_year_value + more_products_yr_1 extended_acv_total, 
  IFNULL(
    (
      b.single_year_value + more_products_yr_1
    )/ base.renewal_quota, 
    0
  ) extended_acv_percent, 
  
  /*ADDTL VALUE*/
  target_more_years + more_products_more_years target_more_years, 
  single_year_value + more_products_yr_1 + target_more_years + more_products_more_years all_target_total, 
  IFNULL(
    (
      single_year_value + more_products_yr_1 + target_more_years + more_products_more_years
    )/ base.renewal_quota, 
    0
  ) all_target_percent, 
  
  /*MORE SCHOOLS ACCOUNT VALUE*/
  more_schools_yr_1, 
  more_schools_more_years, 
  more_schools_more_years + more_schools_yr_1 more_schools, 
  district_re_allocated, 
  
  /*ACCOUNT LEVEL ADDTL INFO*/
  aps.year_value booked_account_value, 
  aps.percent_target percent_account_target, 
  CASE WHEN base.on_target = 1 THEN aps.expiring_orders ELSE '' END expiring_orders, 
  tad.account_trainer, 
  tad.account_imp_rvp, 
  CASE WHEN base.non_quota_account = 1 THEN rav.year_po_total ELSE rav.po_total END po_total, 
  rav.year_po_total 
FROM 
  commissions.renewal_report_base base 
  INNER JOIN interlink.accounts a ON a.account_id = base.account_id 
  LEFT JOIN commissions.renewal_order_account_buckets b ON base.account_id = b.account_id 
  AND base.program_id = b.program_id 
  AND base.order_id = b.order_id 
  AND b.cmonth = '$report_month_filter' 
  AND b.user_id = base.user_id 
  LEFT JOIN interlink.opportunity_products op ON op.opportunity_product_id = base.program_id 
  LEFT JOIN interlink.order_summary os ON os.order_id = base.order_id 
  LEFT JOIN commissions.orders co ON co.order_id = base.order_id 
  AND co.cmonth = '$report_month_filter' 
  LEFT JOIN tmp_account_districts tad ON tad.account_id = base.account_id 
  LEFT JOIN commissions.users_cp cp ON cp.user_id = base.user_id 
  AND cp.cmonth = '$report_month_filter' 
  AND cp.year = $year 
  LEFT JOIN commissions.renewal_account_program_summary aps ON aps.account_id = base.account_id 
  and aps.program_id = base.program_id 
  AND aps.cmonth = '$report_month_filter' 
  LEFT JOIN commissions.renewal_order_account_values rav ON rav.order_id = base.order_id 
  AND rav.account_id = base.account_id 
  AND rav.program_id = base.program_id 
  AND rav.cmonth = '$report_month_filter' 
WHERE 
  base.cmonth = '$report_month_filter';</td><td></td><td>skip</td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_pre_2017.php:322</td><td>CREATE TEMPORARY TABLE interlink.temp_renew_qcpr_qc_data_source_copy (
  row_id INT UNSIGNED not null auto_increment PRIMARY KEY, 
  INDEX(renewal_user_id)
) 
SELECT 
  * 
FROM 
  interlink.temp_renew_qcpr_qc_data_source</td><td></td><td>skip</td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_pre_2017.php:541</td><td>CREATE TEMPORARY TABLE tmp_account_sales_rep (
  PRIMARY KEY (account_id)
) 
SELECT 
  a.account_id, 
  ua.user_id, 
  CONCAT(u.first_name, ' ', u.last_name) account_sales_rep 
FROM 
  interlink.accounts a 
  INNER JOIN interlink.user_account_dates ua ON ua.account_id = a.account_id 
  AND ua.role_id = 6 
  AND ua.account_owner = 1 
  AND '$cmonth_end' BETWEEN ua.start_date 
  AND ua.end_date 
  INNER JOIN commissions.renewal_report_base rb ON rb.account_id = a.account_id 
  AND rb.cmonth = '$report_month_filter' 
  INNER JOIN commissions.users u ON u.user_id = ua.user_id 
GROUP BY 
  a.account_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_pre_2017.php:558</td><td>CREATE TEMPORARY TABLE tmp_renewal_export_table (
  KEY(
    user, `account id`, `booked order`
  )
) 
SELECT 
  rou.last_name `User`, 
  u.last_name `Renewal Rep User`, 
  qc.district_account_id `District ID`, 
  qc.district_account `District`, 
  qc.district_state `District State`, 
  qc.account_id `Account ID`, 
  qc.account_name `Account`, 
  qc.state `State`, 
  CASE WHEN qc.account_level = 1 THEN 'District' WHEN qc.account_level = 2 THEN 'School' ELSE '' END `Account Type`, 
  qc.program `Program`, 
  qc.orig_expiring_order_account_value `Expiring Renewal Quota`, 
  qc.expiring_orders `Expiring Orders`, 
  qc.orig_expiring_school_count `Expiring # Schools`, 
  
  /*qc.expiring_license_count `Expiring License Count`,*/
  qc.orig_booked_school_count `Booked # Schools`, 
  
  /*
                  qc.booked_license_count `Booked License Count`,
                  qc.booked_license_percent `Booked License %`,
                  */
  qc.acv_total `ACV`, 
  qc.target_more_products `More Products`, 
  qc.extended_acv_total `ACV Total`, 
  CASE WHEN rou.base_user_id = rou.user_id 
  OR qc.is_primary_user = 1 THEN qc.extended_acv_percent ELSE 0 END `ACV Total %`, 
  qc.target_more_years `Target Acct Addt'l Years`, 
  qc.more_schools_yr_1 `More Schools  $year - $year_to Year`, 
  qc.more_schools_more_years `More Schools Addt'l Years`, 
  qc.more_schools `More Schools Total`, 
  qc.booked_order_account_value `Booked Order Account Total`, 
  qc.booked_order_id `Booked Order`, 
  
  /*school count can be overriden to 1 even if not on target*/
  CASE WHEN (
    qc.orig_on_target = 1 
    OR qc.booked_school_count = 1
  ) 
  AND (
    (
      rou.base_user_id = rou.user_id 
      AND qcu.comp_plan_type = 'renewal_user'
    ) 
    OR qc.is_primary_user = 1
  ) THEN qc.rank ELSE '' END `Order Count (Target Acct)`, 
  CASE WHEN (
    qc.orig_on_target = 1 
    OR qc.booked_school_count = 1
  ) 
  AND (
    (
      rou.base_user_id = rou.user_id 
      AND qcu.comp_plan_type = 'renewal_user'
    ) 
    OR qc.is_primary_user = 1
  ) THEN qc.school_rank ELSE '' END `School Count (Target Acct)`, 
  qc.on_target `Quota Bucket`, 
  o.order_date `Order Date`, 
  o.start_date `Start Date`, 
  o.end_date `End Date`, 
  o.Cancel `Is Cancelled`, 
  o.order_total `Order Total`, 
  oi.credit_revenue_total + oi.bad_debt_total `Credits (Cancels/Bad Debt)`, 
  o.sales_rep `Opportunity Owner`, 
  oi.order_renewal_rep `Renewal Rep`, 
  COALESCE(
    NULLIF(oi.order_field_rep, ''), 
    asr.account_sales_rep
  ) `Field Rep`, 
  oi.order_field_region `Region`, 
  qc.account_trainer `Account Trainer`, 
  qc.account_imp_rvp `Account Imp. RVP`, 
  qc.po_total `PO Total`, 
  qc.year_po_total `$year - $year_to PO Total` 
FROM 
  interlink.temp_renew_qcpr_qc_data_source qc 
  INNER JOIN commissions.users u on qc.user_id = u.user_id 
  INNER JOIN commissions.renewal_order_users rou ON rou.order_id = qc.booked_order_id 
  AND rou.account_id = qc.account_id 
  AND rou.program_id = qc.program_id 
  AND rou.cmonth = '$report_month_filter' 
  AND rou.base_user_id = qc.user_id 
  INNER JOIN interlink.temp_renew_qcpr_user_data_source qcu on rou.user_id = qcu.il_user_id 
  LEFT JOIN commissions.orders o ON o.order_id = qc.booked_order_id 
  AND o.cmonth = '$report_month_filter' 
  LEFT JOIN commissions.order_info oi ON oi.order_id = qc.booked_order_id 
  AND oi.cmonth = '$report_month_filter' 
  LEFT JOIN tmp_account_sales_rep asr ON asr.account_id = qc.account_id 
ORDER BY 
  u.last_name, 
  qc.district_state_id, 
  qc.has_district DESC, 
  qc.district_account, 
  qc.on_target_id DESC, 
  qc.account_name, 
  qc.program_id, 
  qc.rank, 
  qc.booked_order_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/sales/non_standard_discounts_index.php:6</td><td>CREATE TEMPORARY TABLE temp_$report_tmp_table 
select 
  a.state_code as 'state_code', 
  r.region_name as 'region_name', 
  op.opportunity_id, 
  op.opportunity_name, 
  opp.probability_percent as 'opportunity_status', 
  if (
    op.order_id = 0, op.close_date, o.order_date
  ) as 'close_date', 
  qud.account_id, 
  if(
    a.account_level = 2, a.account_name, 
    ''
  ) as 'school', 
  if(
    a.account_level = 2, d.account_name, 
    a.account_name
  ) as 'district', 
  concat(u.first_name, ' ', u.last_name) as 'sales_rep', 
  op.total, 
  group_concat(DISTINCT opo.po SEPARATOR ', ') as 'po', 
  qu.quote_id, 
  qud.product_id, 
  qud.price, 
  qud.quantity, 
  concat(ua.first_name, ' ', ua.last_name) as 'approved_by', 
  dai.approval_date as 'approved_date', 
  dai.approval_reason, 
  dai.business_effect 
from 
  opportunities op 
  left join order_po opo on (
    op.opportunity_id = opo.opportunity_id
  ) 
  left join orders o on (op.order_id = o.order_id), 
  opportunity_probabilities opp, 
  quote_details qud, 
  products prd, 
  region_states rs, 
  regions r, 
  user_orders uo, 
  users u, 
  quotes qu 
  left join discount_approval_info dai on (dai.quote_id = qu.quote_id) 
  left join users ua on dai.approved_by = ua.user_id 
  left join accounts a on a.account_id = qu.account_id 
  left join accounts d on (
    a.parent_account_id = d.account_id
  ) 
where 
  op.opportunity_id = qu.opportunity_id 
  AND op.probability_id = opp.probability_id 
  AND qu.quote_id = qud.quote_id 
  AND qud.product_id = prd.product_id 
  AND rs.state_code = a.state_code 
  AND rs.region_id = r.region_id 
  AND r.department_id = 2 
  AND (
    uo.opportunity_id = op.opportunity_id 
    or uo.order_id = o.order_id
  ) 
  AND uo.user_id = u.user_id 
  AND qu.final = 1 
  AND (
    op.probability_id < 15 
    OR o.order_date > TIMESTAMPADD(MONTH,-1, NOW())
  ) 
  AND (
    prd.product_group_id = 28 
    or prd.product_group_id = 32 
    or prd.product_group_id = 40
  ) $whereStr 
group by 
  qu.quote_id, 
  qud.quote_detail_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/sales/non_standard_discounts_index.php:43</td><td>CREATE TEMPORARY TABLE $report_tmp_table 
select 
  *, 
  sum(
    if (
      product_id not in (2, 394, 1554), 
      price * quantity, 
      0
    )
  ) as 'standard_discount', 
  sum(
    if (
      product_id in (2, 394, 1554), 
      price * quantity, 
      0
    )
  ) as 'non_standard_discount' 
from 
  temp_$report_tmp_table 
group by 
  quote_id;</td><td></td><td>skip</td></tr>
   <tr><td>util/classes/Search.php:554</td><td>CREATE TEMPORARY TABLE tmp_exclude_orders (
  KEY(order_id)
) 
SELECT 
  DISTINCT o.order_id 
FROM 
  orders o 
  LEFT JOIN order_details od ON (
    o.order_id = od.order_id 
    and od.status in (o.status, 0)
  ) 
WHERE 
  o.order_id IN (
    ".implode(", ", array_unique($orders))."
  ) 
  AND od.order_id IS NULL</td><td></td><td>skip</td></tr>
   <tr><td>util/classes/Search.php:564</td><td>CREATE TEMPORARY TABLE tmp_program_licenses (
  key(order_id), 
  key(program_id)
) 
SELECT 
  aos.order_id, 
  p.program_id, 
  SUM(
    IF(
      p.program_id = ".SMARTY_ANTS_PROGRAM." 
      AND aos.student_licenses = '9999', 
      NULL, 
      aos.student_licenses
    )
  ) student_licenses, 
  MAX(
    IF(
      p.program_id = ".SMARTY_ANTS_PROGRAM." 
      AND aos.student_licenses = '9999', 
      1, 
      0
    )
  ) unlimited 
FROM 
  account_order_summary aos 
  JOIN order_details od ON od.order_detail_id = aos.order_detail_id 
  JOIN products p ON p.product_id = od.product_id 
WHERE 
  od.order_id IN (
    ".implode(", ", array_unique($orders))."
  ) 
  AND aos.student_licenses > 0 
GROUP BY 
  aos.order_id, 
  p.program_id</td><td></td><td>skip</td></tr>
   <tr><td>util/classes/Search.php:578</td><td>CREATE TEMPORARY TABLE tmp_order_licenses (
  key(order_id)
) 
SELECT 
  l.order_id, 
  GROUP_CONCAT(
    CASE WHEN l.student_licenses > 0 
    AND unlimited > 0 THEN CONCAT(
      'Unlimited,', l.student_licenses
    ) WHEN l.student_licenses > 0 THEN FORMAT(l.student_licenses, 0) WHEN unlimited > 0 THEN 'Unlimited' ELSE NULL END 
    ORDER BY 
      IF(l.student_licenses <> '0', 0, 1), 
      p.sort, 
      p.program_id separator '; '
  ) student_licenses 
FROM 
  tmp_program_licenses l, 
  programs p 
WHERE 
  p.program_id = l.program_id 
GROUP BY 
  l.order_id</td><td></td><td>skip</td></tr>
   <tr><td>util/classes/Search.php:1114</td><td>CREATE TEMPORARY TABLE IF NOT EXISTS opp_contacts 
SELECT 
  opportunity_id, 
  contact_id 
FROM 
  order_contacts 
LIMIT 
  0</td><td></td><td>skip</td></tr>
   <tr><td>util/classes/Search.php:1124</td><td>CREATE TEMPORARY TABLE contact_history 
SELECT 
  record_id contact_id, 
  max(date_entered) date_entered 
FROM 
  history_log 
WHERE 
  table_name = 'contacts' 
  AND record_id IN (".implode(", ", $contacts).") 
GROUP BY 
  record_id</td><td></td><td>skip</td></tr>
   <tr><td>util/function/product_lines.php:41</td><td>CREATE TEMPORARY TABLE tmp_order_programs (
  key(order_id), 
  key(account_id), 
  key(academic_year_id)
) 
SELECT 
  STRAIGHT_JOIN od.order_id, 
  od.account_id, 
  od.academic_year_id, 
  min(p.program_id) program_id 
FROM 
  (
    SELECT 
      academic_year_id 
    FROM 
      academic_years 
    WHERE 
      1 $academic_year_clause
  ) ay 
  JOIN order_details od ON od.academic_year_id = ay.academic_year_id 
  JOIN orders o ON od.order_id = o.order_id 
  AND o.status = 0 
  JOIN products p ON p.product_id = od.product_id 
  AND p.program_id > 0 
WHERE 
  od.status = 0 $academic_year_where " . ($orders_table ? " 
  AND o.order_id IN (
    SELECT 
      order_id 
    FROM 
      $orders_table
  ) " : "") . " " . (count($accounts) ? " 
  AND od.account_id IN (
    " . implode(", ", $accounts) . "
  ) " : "") . " " . (count($product_line_exclusions) ? " 
  AND p.product_line_id NOT IN (
    " . implode(", ", $product_line_exclusions) . "
  ) " : "") . " " . (count($orders) ? " 
  AND o.order_id IN (" . implode(", ", $orders) . ") " : "")  . " 
GROUP BY 
  od.order_id, 
  od.account_id, 
  od.academic_year_id</td><td></td><td>skip</td></tr>
   <tr><td>util/function/product_lines.php:76</td><td>CREATE TEMPORARY TABLE $product_line_table (
  key(order_id), 
  key(account_id), 
  key(program_id)
) 
SELECT 
  STRAIGHT_JOIN DISTINCT od.order_id, 
  od.account_id, 
  od.academic_year_id, 
  od.order_detail_id, 
  $program_str program_id, 
  p.product_line_id, 
  pl.product_line_str, 
  pl.product_line_name, 
  pr.program_name, 
  pr.sort, 
  aos.student_licenses 
FROM 
  (
    SELECT 
      academic_year_id 
    FROM 
      academic_years 
    WHERE 
      1 $academic_year_clause
  ) ay 
  JOIN order_details od ON od.academic_year_id = ay.academic_year_id 
  JOIN orders o ON o.order_id = od.order_id 
  AND o.status = 0 
  JOIN products p ON p.product_id = od.product_id $left_join 
  LEFT JOIN product_lines pl ON (
    pl.product_line_id = p.product_line_id
  ) 
  LEFT JOIN programs pr ON (pr.program_id = $program_str) 
  LEFT JOIN account_order_summary aos ON (
    od.order_detail_id = aos.order_detail_id 
    AND aos.reallocated = 0
  ) 
WHERE 
  od.status = 0 $academic_year_where " . ($orders_table ? " 
  AND o.order_id IN (
    SELECT 
      order_id 
    FROM 
      $orders_table
  ) " : "") . " " . (count($orders) ? " 
  AND o.order_id IN (" . implode(", ", $orders) . ") " : "")  . " " . (count($product_line_exclusions) ? " 
  AND p.product_line_id NOT IN (
    " . implode(", ", $product_line_exclusions) . "
  ) " : "")  . " " . (count($accounts) ? " 
  AND od.account_id IN (
    " . implode(", ", $accounts) . "
  ) " : "")</td><td></td><td>skip</td></tr>
   <tr><td>util/function/product_lines.php:148</td><td>CREATE TABLE $product_line_licenses_table 
SELECT 
  order_id, 
  account_id, 
  program_id, 
  order_detail_id, 
  IF(
    product_line_id in (3, 4, 11), 
    program_name, 
    product_line_str
  ) product, 
  MAX(
    IF(student_licenses > 0, 1, 0)
  ) student_licenses, 
  product_line_name, 
  MIN(sort) sort, 
  MIN(program_id) min_program_id, 
  MIN(product_line_id) product_line_id 
FROM 
  $product_line_table 
GROUP BY 
  " . ($group_by ? implode(", 
  ", $group_by). ", 
  " : "") .
            " IF(
    product_line_id in (3, 4, 11), 
    program_name, 
    product_line_str
  )</td><td></td><td></td></tr>
   <tr><td>util/function/product_lines.php:165</td><td>CREATE TEMPORARY TABLE $product_line_group_table (
  key(order_id), 
  key(account_id), 
  key(program_id), 
  key(order_detail_id)
) 
SELECT 
  order_id, 
  account_id, 
  program_id, 
  order_detail_id, 
  GROUP_CONCAT(
    DISTINCT product $order_by SEPARATOR '; '
  ) product_type, 
  GROUP_CONCAT(
    DISTINCT product_line_name $order_by SEPARATOR '; '
  ) product_type_name 
FROM 
  $product_line_licenses_table " . ($group_by ? " 
GROUP BY 
  " . implode(", 
  ", $group_by) : "")</td><td></td><td>skip</td></tr>
   <tr><td>cron/daily/new_po_pending_orders.php:13</td><td>CREATE TABLE tech.hp_00831360 
SELECT 
  DISTINCT o.order_id, 
  a.account_id, 
  a.account_name 
FROM 
  orders o 
  JOIN payment_terms pt USING(order_id) 
  JOIN order_details d USING(order_id) 
  JOIN payment_term_details ptd USING(payment_term_id) 
  JOIN payment_term_status_list pl USING(payment_term_status_id) 
  LEFT JOIN accounts a ON a.account_id = o.account_id 
  AND a.state_code = 'NY' 
  AND a.county_id IN (2024, 2045, 2052, 2062, 2064) 
  AND a.account_type NOT IN (1, 4, 6, 16) 
  LEFT JOIN accounts a2 ON a2.account_id = d.account_id 
  AND a2.state_code = 'NY' 
  AND a2.county_id IN (2024, 2045, 2052, 2062, 2064) 
  AND a2.account_type NOT IN (1, 4, 6, 16) 
  JOIN products p ON p.product_id = d.product_id 
  AND p.sku NOT LIKE '%-FA-%' 
  JOIN sub_products sp ON sp.product_id = p.product_id 
  AND sp.sub_product_type_id IN (4, 5, 14, 24) 
WHERE 
  ptd.status = 0 
  AND o.status = 0 
  AND d.status = 0 
  AND DATE(o.date_entered) = CURDATE() - INTERVAL 1 DAY 
  AND payment_term_status_name LIKE 'PO Pending%' 
  AND (
    a.account_id IS NOT NULL 
    OR a2.account_id IS NOT NULL
  )</td><td></td><td></td></tr>
   <tr><td>cron/daily/new_po_pending_orders.php:101</td><td>CREATE TABLE tech.hp_00839015 (
  KEY(order_id), 
  KEY(account_id)
) 
SELECT 
  DISTINCT o.order_id, 
  a.account_id, 
  a.account_name 
FROM 
  orders o 
  JOIN payment_terms pt USING(order_id) 
  JOIN order_details d USING(order_id) 
  JOIN payment_term_details ptd USING(payment_term_id) 
  JOIN payment_term_status_list pl USING(payment_term_status_id) 
  JOIN history_log h ON h.record_id = ptd.payment_term_detail_id 
  JOIN accounts a ON a.account_id = o.account_id 
  LEFT JOIN account_info ai ON ai.account_id = o.account_id 
  LEFT JOIN account_info ai1 ON ai1.account_id = o.billing_account_id 
  LEFT JOIN account_info ai2 ON ai2.account_id = d.account_id 
WHERE 
  ptd.status = 0 
  AND o.status = 0 
  AND d.status = 0 
  AND h.column_name = 'payment_term_status_id' 
  AND h.new_value = 200 
  AND h.old_value IN (201, 208, 209, 210) 
  AND DATE(h.date_entered) = CURDATE() - INTERVAL 1 DAY 
  AND 75 IN(
    ai.info_id, ai1.info_id, ai2.info_id
  )</td><td></td><td></td></tr>
   <tr><td>cron/project_management_report.php:34</td><td>CREATE TEMPORARY TABLE project_management 
SELECT 
  DISTINCT o.order_id, 
  a.account_id, 
  REPLACE(a.account_name, ',', '') account_name, 
  IF(
    a.account_level = 2 
    AND a.parent_account_id = 0, 
    '', 
    IFNULL(a2.account_id, a.account_id)
  ) DistrictID, 
  IF(
    a.account_level = 2 
    AND a.parent_account_id = 0, 
    '', 
    IFNULL(
      REPLACE(a2.account_name, ',', ''), 
      REPLACE(a.account_name, ',', '')
    )
  ) DistrictName, 
  o.order_date, 
  o.start_date, 
  o.end_date, 
  a.state_code, 
  l.location_name, 
  od.product_id, 
  p.product_name, 
  od.quantity, 
  od.price, 
  (od.quantity * od.price) 'Total', 
  get_account_user(a.account_id, 7, 1) 'RVP', 
  get_account_user(a.account_id, 4, 1) 'CIM', 
  get_account_user(a.account_id, 22, 1) 'project_manager' 
FROM 
  orders o 
  JOIN order_details od ON o.order_id = od.order_id 
  JOIN accounts a ON o.account_id = a.account_id 
  LEFT JOIN accounts a2 ON a2.account_id = a.parent_account_id 
  JOIN locations l ON a.state_code = l.location_code 
  JOIN products p ON od.product_id = p.product_id 
  JOIN academic_years ay USING(academic_year_id) 
  JOIN user_accounts ua ON ua.account_id = a.account_id 
  AND ua.account_owner = 1 
WHERE 
  p.product_group_id = '31' 
  and p.sku NOT LIKE '%NLS%' 
  AND od.academic_year_id = ay.academic_year_id 
  AND ay.summer = 0 
  AND o.status = 0 
  AND od.status = 0 
  AND ay.academic_year_id = $academic_year_id 
ORDER BY 
  state_code, 
  account_id</td><td></td><td>skip</td></tr>
   <tr><td>cron/weekly/smartyants_report.php:11</td><td>create table tech.sa_00821476 
select 
  s.account_id, 
  s.account_name, 
  group_concat(distinct p.program_id) program, 
  s.parent_account_id, 
  a2.account_name 'district', 
  l.location_name 'state', 
  s.school_start, 
  r.region_name, 
  group_concat(distinct o.order_id separator ';') 'order_ids', 
  group_concat(
    distinct o.order_date 
    order by 
      order_date
  ) 'order_dates', 
  group_concat(
    distinct pl.product_line_name 
    order by 
      product_line_name
  ) 'product', 
  t.tier_name 'account_tier' 
from 
  accounts s 
  JOIN order_details od ON od.account_id = s.account_id 
  JOIN orders o ON o.order_id = od.order_id 
  JOIN products p ON p.product_id = od.product_id 
  left join accounts a2 on a2.account_id = s.parent_account_id 
  join locations l on l.location_code = s.state_code 
  join regions r on r.region_id = s.implementation_region_id 
  join product_lines pl on pl.product_line_id = p.product_line_id 
  left join tiers t on t.tier_id = s.tier_id 
WHERE 
  o.status = 0 
  AND od.status = 0 
  and now() between od.start_date 
  and od.end_date 
  AND p.product_group_id NOT IN (28, 32, 27) 
GROUP BY 
  s.account_id 
HAVING 
  program = '".SMARTY_ANTS_PROGRAM."'</td><td></td><td></td></tr>
   <tr><td>cron/weekly/smartyants_report.php:36</td><td>create table tech.sa_00821476_2 
select 
  distinct h.*, 
  get_account_user(h.account_id, 7, 1) 'RVP', 
  get_account_user(h.account_id, 4, 1) 'CIM', 
  get_account_user(h.account_id, 26, 1) 'RIS', 
  get_account_user(h.account_id, 27, 1) 'RM', 
  get_account_user(h.account_id, 6, 1) 'account_sales_rep', 
  get_account_user(h.account_id, 25, 1) 'account_renewal_rep' 
from 
  tech.sa_00821476 h 
  left join user_accounts ua on ua.account_id = h.account_id</td><td></td><td></td></tr>
   <tr><td>cron/weekly/smartyants_report.php:46</td><td>create table tech.sa_00821476_final 
SELECT 
  h.account_id, 
  account_name, 
  account_tier, 
  parent_account_id 'district_id', 
  district, 
  state, 
  school_start, 
  region_name, 
  order_ids, 
  order_dates, 
  product, 
  RVP, 
  CIM, 
  RIS, 
  RM, 
  account_sales_rep, 
  account_renewal_rep, 
  max(
    if(
      aos.student_licenses = 9999, 'yes', 
      ''
    )
  ) 'unlimited_licenses?' #, IFNULL(NULLIF(sum(if(aos.student_licenses = 9999, NULL, student_licenses)), 0), '')'purchased_licenses'
FROM 
  tech.sa_00821476_2 h 
  left join account_order_summary aos on aos.account_id = h.account_id 
  and aos.reallocated = 0 
  join order_details d on d.order_detail_id = aos.order_detail_id 
  and now() between d.start_date 
  and d.end_date 
group by 
  h.account_id 
order by 
  CIM, 
  state, 
  district, 
  account_name</td><td></td><td></td></tr>
   <tr><td>cron/weekly/smartyants_report.php:62</td><td>create table tech.sa_00821476_final_2 
select 
  f.*, 
  IFNULL(
    NULLIF(
      sum(
        if(
          f.`unlimited_licenses?` = 'yes', NULL, 
          student_licenses
        )
      ), 
      0
    ), 
    ''
  ) 'purchased_licenses' 
from 
  tech.sa_00821476_final f 
  left join account_order_summary aos on aos.account_id = f.account_id 
  and aos.reallocated = 0 
  join order_details d on d.order_detail_id = aos.order_detail_id 
  and now() between d.start_date 
  and d.end_date 
group by 
  f.account_id 
order by 
  CIM, 
  state, 
  district, 
  account_name</td><td></td><td></td></tr>
   <tr><td>cron/weekly/smartyants_report.php:81</td><td>create table tech.sa_00821476_ideal_sa 
select 
  a.* 
from 
  accounts a 
  join order_details d on d.account_id = a.account_id 
  join orders o on o.order_id = d.order_id 
  join products p on p.product_id = d.product_id 
  join sub_products sp on sp.product_id = p.product_id 
  and sp.sub_product_type_id = 28 
  join programs pr on pr.program_id = p.program_id 
where 
  now() between d.start_date 
  and d.end_date 
  and o.status = 0 
  and d.status = 0 
  and p.program_id = ".SMARTY_ANTS_PROGRAM</td><td></td><td></td></tr>
   <tr><td>cron/weekly/smartyants_report.php:99</td><td>create table tech.sa_00821476_ideal_both 
select 
  distinct h.account_id, 
  h.account_name, 
  t.tier_name 'account_tier', 
  a2.account_id 'district_id', 
  a2.account_name 'district', 
  l.location_name 'state', 
  h.school_start, 
  h.implementation_region_id 
from 
  tech.sa_00821476_ideal_sa h 
  join order_details d on d.account_id = h.account_id 
  join orders o on o.order_id = d.order_id 
  join products p on p.product_id = d.product_id 
  join sub_products s on s.product_id = p.product_id 
  and s.sub_product_type_id in (1, 2, 3, 9, 16, 17, 18, 20, 22, 25, 26) 
  left join accounts a2 on a2.account_id = h.parent_account_id 
  join locations l on l.location_code = h.state_code 
  left join tiers t on t.tier_id = h.tier_id 
where 
  now() between d.start_date 
  and d.end_date 
  and o.status = 0 
  and d.status = 0</td><td></td><td></td></tr>
   <tr><td>cron/weekly/smartyants_report.php:118</td><td>create table tech.sa_00821476_ideal_2 
select 
  distinct h.account_id, 
  h.account_name, 
  h.account_tier, 
  h.district_id, 
  h.district, 
  h.state, 
  h.school_start, 
  r.region_name, 
  group_concat(distinct o.order_id separator ';') 'order_ids', 
  group_concat(distinct o.order_date) 'order_dates', 
  group_concat(
    distinct pl.product_line_name 
    order by 
      product_line_name
  ) 'product', 
  get_account_user(h.account_id, 7, 1) 'RVP', 
  get_account_user(h.account_id, 4, 1) 'CIM', 
  get_account_user(h.account_id, 26, 1) 'RIS', 
  get_account_user(h.account_id, 27, 1) 'RM', 
  get_account_user(h.account_id, 6, 1) 'account_sales_rep', 
  get_account_user(h.account_id, 25, 1) 'account_renewal_rep' 
from 
  tech.sa_00821476_ideal_both h 
  left join user_accounts ua on ua.account_id = h.account_id 
  join regions r on r.region_id = h.implementation_region_id 
  join order_details d on d.account_id = h.account_id 
  and (
    now() between d.start_date 
    and d.end_date
  ) 
  and d.status = 0 
  join orders o on o.order_id = d.order_id 
  and o.status = 0 
  join products p on p.product_id = d.product_id 
  left join product_lines pl on pl.product_line_id = p.product_line_id 
where 
  pl.product_line_id in (19, 50) 
group by 
  h.account_id</td><td></td><td></td></tr>
   <tr><td>cron/weekly/smartyants_report.php:138</td><td>create table tech.sa_00821476_ideal_all_licenses 
select 
  h.*, 
  sum(
    if(
      aos.student_licenses <> 9999, student_licenses, 
      0
    )
  ) 'all_purchased_licenses' 
from 
  tech.sa_00821476_ideal_2 h 
  left join account_order_summary aos on aos.account_id = h.account_id 
  and aos.reallocated = 0 
  join order_details d on d.order_detail_id = aos.order_detail_id 
  and now() between d.start_date 
  and d.end_date 
group by 
  h.account_id</td><td></td><td></td></tr>
   <tr><td>cron/weekly/smartyants_report.php:150</td><td>create table tech.sa_00821476_ideal_final 
select 
  h.account_id, 
  h.account_name, 
  h.account_tier, 
  h.district_id, 
  h.district, 
  h.state, 
  h.school_start, 
  h.region_name, 
  h.order_ids, 
  h.order_dates, 
  h.product, 
  h.RVP, 
  h.CIM, 
  h.RIS, 
  h.RM, 
  h.account_sales_rep, 
  h.account_renewal_rep, 
  max(
    if(
      aos.student_licenses = 9999, 'yes', 
      ''
    )
  ) 'unlimited_licenses?', 
  h.all_purchased_licenses 
from 
  tech.sa_00821476_ideal_all_licenses h 
  left join account_order_summary aos on aos.account_id = h.account_id 
  and aos.reallocated = 0 
  join order_details d on d.order_detail_id = aos.order_detail_id 
  and now() between d.start_date 
  and d.end_date 
  join products p on p.product_id = d.product_id 
  and p.program_id = ".SMARTY_ANTS_PROGRAM." 
  join sub_products sp on sp.product_id = p.product_id 
  and sp.sub_product_type_id = 28 
group by 
  h.account_id 
order by 
  CIM, 
  state, 
  district, 
  account_name</td><td></td><td></td></tr>
   <tr><td>cron/weekly/smartyants_report.php:165</td><td>create table tech.sa_00821476_ideal_final_2 
select 
  f.*, 
  IFNULL(
    NULLIF(
      sum(
        if(
          f.`unlimited_licenses?` = 'yes', NULL, 
          aos.student_licenses
        )
      ), 
      0
    ), 
    ''
  ) 'SA_purchased_licenses' 
from 
  tech.sa_00821476_ideal_final f 
  left join account_order_summary aos on aos.account_id = f.account_id 
  and aos.reallocated = 0 
  join order_details d on d.order_detail_id = aos.order_detail_id 
  and now() between d.start_date 
  and d.end_date 
  join products p on p.product_id = d.product_id 
  and p.program_id = ".SMARTY_ANTS_PROGRAM." 
  join sub_products sp on sp.product_id = p.product_id 
  and sp.sub_product_type_id = 28 
group by 
  f.account_id 
order by 
  CIM, 
  state, 
  district, 
  account_name</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:49</td><td>create table amort_orders(
  order_total decimal(15, 2), 
  orig_order_total decimal(15, 2), 
  PRIMARY KEY(order_id)
) 
select 
  distinct 0 cancel_id, 
  '' this_cancel_date, 
  0 credit_total, 
  0 tax_credit_total, 
  0 credit_om_order_id, 
  max(oda.period_month) max_period_month, 
  case when m.order_id then 1 else 0 end has_billing, 
  o.* 
from 
  (
    orders o, $order_detail_amortization oda
  )</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:72</td><td>create table amort_credits(
  order_total decimal(15, 2), 
  orig_order_total decimal(15, 2), 
  KEY(order_id), 
  PRIMARY KEY(cancel_id)
) 
select 
  distinct c.cancel_id, 
  c.cancel_date this_cancel_date, 
  c.credit_total + c.tax_credit_total as credit_total, 
  c.tax_credit_total, 
  credit_om_order_id, 
  max(oda.period_month) max_period_month, 
  1 has_billing, 
  o.* 
FROM 
  (cancels c, orders o) 
  LEFT JOIN order_detail_amortization oda ON c.cancel_id = oda.cancel_id 
  AND c.order_id = oda.order_id 
where 
  c.order_id = o.order_id 
  and c.cancel_date <= '$report_end_date' 
  and round(o.order_total) != 0 
group by 
  c.cancel_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:87</td><td>create table amort_merge (
  PRIMARY KEY(order_id, cancel_id), 
  INDEX(cancel_id)
) 
select 
  * 
from 
  amort_orders 
union 
select 
  * 
from 
  amort_credits 
order by 
  order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:102</td><td>CREATE TABLE amort_user_lock_summary (
  PRIMARY KEY (order_id)
) 
SELECT 
  o.order_id, 
  MAX(
    CASE WHEN uos.user_id IS NOT NULL THEN uos.user_id ELSE uoa.user_id END
  ) sales_rep_id 
FROM 
  interlink.orders o 
  LEFT JOIN interlink.user_orders_lock uos ON uos.order_id = o.order_id 
  AND uos.role_id = 6 
  LEFT JOIN interlink.user_orders_lock uoa ON uoa.order_id = o.order_id 
  AND uoa.role_id = 31 
GROUP BY 
  o.order_id;</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:115</td><td>create table amort_column_list_totals(
  list_total DECIMAL(25, 8), 
  PRIMARY KEY(
    order_id, cancel_id, amortization_column_id
  )
) 
select 
  od.order_id, 
  0 cancel_id, 
  spt.amortization_column_id, 
  sum(od.after_prod_total) list_total 
from 
  order_details od, 
  $data_db.sub_product_types spt 
where 
  od.sub_product_type_id = spt.sub_product_type_id 
group by 
  od.order_id, 
  3</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:124</td><td>create table amort_column_disc_totals(
  discounted_total DECIMAL(25, 8), 
  PRIMARY KEY(
    order_id, cancel_id, amortization_column_id
  )
) 
select 
  order_id, 
  cancel_id, 
  spt.amortization_column_id, 
  sum(period_total) discounted_total 
from 
  $order_detail_amortization a, 
  $data_db.sub_product_types spt 
where 
  a.sub_product_type_id = spt.sub_product_type_id 
group by 
  order_id, 
  cancel_id, 
  3</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:137</td><td>CREATE TABLE comm_override_orders (
  PRIMARY KEY (order_id, cancel_id)
) 
SELECT 
  v.order_id, 
  a.cancel_id cancel_id, 
  v.new_total, 
  v.renew_total, 
  sum(a.period_total) projected_order_total 
FROM 
  commissions.v_qc_overrides v 
  INNER JOIN interlink.order_summary os ON os.order_id = v.order_id 
  INNER JOIN $order_detail_amortization a ON a.order_id = v.order_id 
  INNER JOIN interlink.orders o ON o.order_id = os.order_id 
WHERE 
  1 
  AND ABS(
    v.new_total + v.renew_total + os.sales_tax - os.order_total
  )< 1 
  AND IFNULL(v.new_total, 0)+ IFNULL(v.renew_total, 0)> 0 
  AND v.user_id = 0 
  AND v.commissions_override_only = 0 
  AND v.year = YEAR(o.order_date) 
GROUP BY 
  v.order_id, 
  a.cancel_id;</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:153</td><td>CREATE TABLE amort_order_type (
  PRIMARY KEY (order_id)
) 
SELECT 
  oi.order_id, 
  CASE WHEN l.is_domestic = 1 
  OR l.location_code IS NULL THEN 'Domestic' ELSE 'International' END domestic, 
  CASE WHEN oi.order_date > '2020-01-01' THEN 0 WHEN oi.opportunity_product_id IS NULL 
  OR oi.opportunity_product_id = 3 THEN 1 ELSE oi.opportunity_product_id END program_id, 
  CASE WHEN oi.order_date > '2020-01-01' THEN '' WHEN onames.opportunity_product_name IS NULL 
  OR onames.opportunity_product_id = 3 THEN 'Literacy' ELSE onames.opportunity_product_name END program 
FROM 
  interlink.orders oi 
  LEFT JOIN interlink.accounts a ON oi.account_id = a.account_id 
  LEFT JOIN interlink.locations l ON a.state_code = l.location_code 
  AND l.location_type = 's' 
  LEFT JOIN interlink.opportunity_products onames ON onames.opportunity_product_id = oi.opportunity_product_id 
WHERE 
  1 
GROUP BY 
  oi.order_id;</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:172</td><td>CREATE TABLE order_detail_new_renew_percent_unlocked (
  PRIMARY KEY (
    order_detail_id, cancel_id, order_id
  ), 
  percent_new DECIMAL (20, 18), 
  percent_renew DECIMAL(20, 18)
) 
SELECT 
  a.order_id, 
  a.cancel_id, 
  a.order_detail_id, 
  IFNULL(
    ROUND(r.new_percent_fin, 18), 
    os.new_total /(os.new_total + os.renew_total)
  ) percent_new, 
  IFNULL(
    ROUND(r.renew_percent_fin, 18), 
    os.renew_total /(os.new_total + os.renew_total)
  ) percent_renew, 
  SUM(a.period_total) detail_period_total, 
  SUM(
    CASE WHEN spt.recurring_yearly = 'N' THEN a.period_total ELSE 0 END
  ) non_recurring_detail_period_total, 
  SUM(
    CASE WHEN spt.pd_deliverable = 'Y' THEN a.period_total ELSE 0 END
  ) pd_detail_period_total 
FROM 
  order_detail_amortization a 
  INNER JOIN interlink.order_summary os ON os.order_id = a.order_id 
  INNER JOIN interlink.orders o ON os.order_id = o.order_id 
  LEFT JOIN interlink.order_detail_new_renew_summary r ON a.order_detail_id = r.order_detail_id 
  AND a.order_id = r.order_id 
  LEFT JOIN interlink.sub_product_types spt ON spt.sub_product_type_id = a.sub_product_type_id 
WHERE 
  o.order_date >= '2010-01-01' 
GROUP BY 
  a.order_id, 
  a.cancel_id, 
  a.order_detail_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:191</td><td>CREATE TABLE tmp_od_ay_new_renew (
  PRIMARY KEY (
    order_id, start_date, end_date, summer
  )
) 
SELECT 
  od.order_id, 
  ay.academic_year_id, 
  ay.start_date, 
  ay.end_date, 
  ay.summer, 
  SUM(
    (nr.line_list_price)+ IFNULL(nr.pro_rated_fees, 0)+ IFNULL(nr.pro_rated_discounts, 0)
  ) order_total, 
  SUM(
    (
      nr.line_list_price + IFNULL(nr.pro_rated_fees, 0)+ IFNULL(nr.pro_rated_discounts, 0)
    )* CASE WHEN nro.order_detail_id IS NOT NULL THEN nro.new_percent WHEN order_renewal_status = 'new' THEN 1 ELSE 0 END
  ) new_total, 
  SUM(
    (
      nr.line_list_price + IFNULL(nr.pro_rated_fees, 0)+ IFNULL(nr.pro_rated_discounts, 0)
    )* CASE WHEN nro.order_detail_id IS NOT NULL THEN nro.renew_percent WHEN order_renewal_status = 'renewal' THEN 1 ELSE 0 END
  ) renew_total 
FROM 
  interlink.order_details od 
  INNER JOIN interlink.academic_years ay ON od.academic_year_id = ay.academic_year_id 
  LEFT JOIN interlink.order_new_renewal_data nr ON nr.order_detail_id = od.order_detail_id 
  AND nr.order_id = od.order_id 
  INNER JOIN interlink.order_summary os ON os.order_id = od.order_id 
  LEFT JOIN interlink.orders o ON o.order_id = od.order_id 
  LEFT JOIN comm_override_orders ov ON ov.order_id = od.order_id 
  AND ov.cancel_id = od.cancel_id 
  LEFT JOIN interlink.order_detail_new_renew_overrides nro ON od.order_id = nro.order_id 
  AND od.order_detail_id = nro.order_detail_id 
  AND nro.commissions_override_only = 0 
WHERE 
  o.order_date >= '2010-01-01' 
  AND os.new_total > 0 
  AND os.renew_total > 0 
  AND ov.order_id IS NULL 
GROUP BY 
  od.order_id, 
  od.academic_year_id;</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:218</td><td>CREATE TABLE tmp_od_ay_new_renew_period_month (
  PRIMARY KEY (order_id, period_month)
) 
SELECT 
  a.order_id, 
  a.order_detail_id, 
  a.period_month, 
  ay.new_total, 
  ay.renew_total 
FROM 
  order_detail_amortization_lock a 
  INNER JOIN tmp_od_ay_new_renew ay ON ay.order_id = a.order_id 
  AND a.order_detail_id = 0 
  AND a.period_month BETWEEN ay.start_date 
  AND ay.end_date 
  AND ay.summer = 0 
GROUP BY 
  order_id, 
  period_month</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:230</td><td>CREATE TABLE order_detail_new_renew_percent (
  PRIMARY KEY (
    order_detail_id, cancel_id, order_id
  ), 
  percent_new DECIMAL (20, 18), 
  percent_renew DECIMAL(20, 18)
) 
SELECT 
  a.order_id, 
  a.cancel_id, 
  a.order_detail_id, 
  IFNULL(
    ROUND(
      CASE WHEN nro.order_detail_id IS NOT NULL THEN nro.new_percent WHEN ov.order_id IS NOT NULL THEN ov.new_total /(ov.new_total + ov.renew_total) WHEN r.order_renewal_status = 'renewal' THEN 0 WHEN (
        r.order_renewal_status = 'new' 
        OR (
          os.renew_total = 0 
          AND os.new_total > 0
        )
      ) THEN 1 WHEN a.order_detail_id = 0 THEN ay.new_total /(ay.new_total + ay.renew_total) ELSE os.new_total /(os.new_total + os.renew_total) END, 
      18
    ), 
    0
  ) percent_new, 
  IFNULL(
    ROUND(
      CASE WHEN nro.order_detail_id IS NOT NULL THEN nro.renew_percent WHEN ov.order_id IS NOT NULL THEN ov.renew_total /(ov.new_total + ov.renew_total) WHEN r.order_renewal_status = 'new' THEN 0 WHEN (
        r.order_renewal_status = 'renewal' 
        OR (
          os.new_total = 0 
          AND os.renew_total > 0
        )
      ) THEN 1 WHEN a.order_detail_id = 0 THEN ay.renew_total /(ay.new_total + ay.renew_total) ELSE os.renew_total /(os.new_total + os.renew_total) END, 
      18
    ), 
    0
  ) percent_renew, 
  SUM(a.period_total) detail_period_total 
FROM 
  order_detail_amortization_lock a 
  INNER JOIN interlink.order_summary os ON os.order_id = a.order_id 
  INNER JOIN interlink.orders o ON os.order_id = o.order_id 
  LEFT JOIN interlink.order_new_renewal_data r ON a.order_detail_id = r.order_detail_id 
  AND a.order_id = r.order_id 
  LEFT JOIN tmp_od_ay_new_renew_period_month ay ON ay.order_id = a.order_id 
  AND a.order_detail_id = 0 
  AND a.period_month = ay.period_month 
  LEFT JOIN comm_override_orders ov ON ov.order_id = a.order_id 
  AND ov.cancel_id = a.cancel_id 
  LEFT JOIN interlink.order_detail_new_renew_overrides nro ON a.order_id = nro.order_id 
  AND a.order_detail_id = nro.order_detail_id 
  AND nro.commissions_override_only = 0 
WHERE 
  o.order_date >= '2010-01-01' 
GROUP BY 
  a.order_id, 
  a.cancel_id, 
  a.order_detail_id;</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:260</td><td>CREATE TABLE order_new_renew (
  order_total_amount DECIMAL(15, 2), 
  new_total DECIMAL(15, 2), 
  renew_total DECIMAL(15, 2), 
  this_year_total_amount DECIMAL(15, 2), 
  this_year_new_total DECIMAL(15, 2), 
  this_year_renew_total DECIMAL(15, 2), 
  recognized_total_amount DECIMAL(15, 2), 
  recognized_new_total DECIMAL(15, 2), 
  recognized_renew_total DECIMAL(15, 2), 
  future_months_total_amount DECIMAL(15, 2), 
  future_months_new_total DECIMAL(15, 2), 
  future_months_renew_total DECIMAL(15, 2), 
  future_years_total_amount DECIMAL(15, 2), 
  future_years_new_total DECIMAL(15, 2), 
  future_years_renew_total DECIMAL(15, 2), 
  PRIMARY KEY (order_id, cancel_id)
) 
SELECT 
  a.order_id, 
  a.cancel_id, 
  ROUND(
    SUM(period_total), 
    2
  ) order_total_amount, 
  ROUND(
    SUM(period_total * percent_new), 
    2
  ) new_total, 
  ROUND(
    SUM(period_total * percent_renew), 
    2
  ) renew_total, 
  ROUND(
    SUM(
      CASE WHEN YEAR(a.period_month)<> $report_year 
      OR a.period_month > '$report_end_date' THEN 0 ELSE period_total END
    ), 
    2
  ) this_year_total_amount, 
  ROUND(
    SUM(
      CASE WHEN YEAR(a.period_month)<> $report_year 
      OR a.period_month > '$report_end_date' THEN 0 ELSE period_total * percent_new END
    ), 
    2
  ) this_year_new_total, 
  ROUND(
    SUM(
      CASE WHEN YEAR(a.period_month)<> $report_year 
      OR a.period_month > '$report_end_date' THEN 0 ELSE period_total * percent_renew END
    ), 
    2
  ) this_year_renew_total, 
  ROUND(
    SUM(
      CASE WHEN a.period_month > '$report_end_date' THEN 0 ELSE period_total END
    ), 
    2
  ) recognized_total_amount, 
  ROUND(
    SUM(
      CASE WHEN a.period_month > '$report_end_date' THEN 0 ELSE period_total * percent_new END
    ), 
    2
  ) recognized_new_total, 
  ROUND(
    SUM(
      CASE WHEN a.period_month > '$report_end_date' THEN 0 ELSE period_total * percent_renew END
    ), 
    2
  ) recognized_renew_total, 
  ROUND(
    SUM(
      CASE WHEN YEAR(a.period_month)= $report_year 
      AND a.period_month > '$report_end_date' THEN period_total ELSE 0 END
    ), 
    2
  ) future_months_total_amount, 
  ROUND(
    SUM(
      CASE WHEN YEAR(a.period_month)= $report_year 
      AND a.period_month > '$report_end_date' THEN period_total * percent_new ELSE 0 END
    ), 
    2
  ) future_months_new_total, 
  ROUND(
    SUM(
      CASE WHEN YEAR(a.period_month)= $report_year 
      AND a.period_month > '$report_end_date' THEN period_total * percent_renew ELSE 0 END
    ), 
    2
  ) future_months_renew_total, 
  ROUND(
    SUM(
      CASE WHEN YEAR(a.period_month)> '$report_year' THEN period_total ELSE 0 END
    ), 
    2
  ) future_years_total_amount, 
  ROUND(
    SUM(
      CASE WHEN YEAR(a.period_month)> '$report_year' THEN period_total * percent_new ELSE 0 END
    ), 
    2
  ) future_years_new_total, 
  ROUND(
    SUM(
      CASE WHEN YEAR(a.period_month)> '$report_year' THEN period_total * percent_renew ELSE 0 END
    ), 
    2
  ) future_years_renew_total 
FROM 
  order_detail_amortization_lock a 
  INNER JOIN amortization.order_detail_new_renew_percent r ON a.order_detail_id = r.order_detail_id 
  AND a.order_id = r.order_id 
  AND a.cancel_id = r.cancel_id 
GROUP BY 
  a.order_id, 
  a.cancel_id;</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:302</td><td>create table amort_prev_year(
  prev_total DECIMAL(15, 2), 
  PRIMARY KEY(order_id, cancel_id)
) 
select 
  order_id, 
  cancel_id, 
  round(
    sum(period_total), 
    2
  ) prev_total 
from 
  $order_detail_amortization 
where 
  (
    year(period_month) < '$report_year' 
    or period_month = 0
  ) 
group by 
  order_id, 
  cancel_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:312</td><td>create table amort_this_year_sum(
  this_year_total DECIMAL(15, 2), 
  PRIMARY KEY(order_id, cancel_id)
) 
select 
  order_id, 
  cancel_id, 
  round(
    sum(period_total), 
    2
  ) this_year_total 
from 
  $order_detail_amortization 
where 
  year(period_month) = '$report_year' 
  and period_month <= '$report_end_date' 
group by 
  order_id, 
  cancel_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:323</td><td>create table amort_this_year(
  this_year_total DECIMAL(15, 2), 
  PRIMARY KEY(
    order_id, cancel_id, amortization_column_id
  )
) 
select 
  order_id, 
  cancel_id, 
  spt.amortization_column_id, 
  round(
    sum(period_total), 
    2
  ) this_year_total 
from 
  $order_detail_amortization a, 
  $data_db.sub_product_types spt 
where 
  a.sub_product_type_id = spt.sub_product_type_id 
  and year(period_month) = '$report_year' 
  and period_month <= '$report_end_date' 
group by 
  order_id, 
  cancel_id, 
  3</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:344</td><td>CREATE TABLE $column_table_name(
  COLUMN_TYPE_STR PRIMARY KEY(order_id, cancel_id)
) 
SELECT 
  order_id, 
  cancel_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:403</td><td>create table amort_future(
  future_months DECIMAL(15, 2), 
  future_years DECIMAL(15, 2), 
  PRIMARY KEY(order_id, cancel_id)
) 
select 
  order_id, 
  cancel_id, 
  round(
    sum(
      if(
        year(period_month)= '$report_year', 
        period_total, 
        0
      )
    ), 
    2
  ) future_months, 
  round(
    sum(
      if(
        year(period_month)> '$report_year', 
        period_total, 
        0
      )
    ), 
    2
  ) future_years 
from 
  $order_detail_amortization 
where 
  period_month > '$report_end_date' 
group by 
  order_id, 
  cancel_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:417</td><td>create table amort_recognized(
  recognized_total DECIMAL(15, 2), 
  PRIMARY KEY(order_id, cancel_id)
) 
select 
  order_id, 
  cancel_id, 
  round(
    sum(period_total), 
    2
  ) recognized_total 
from 
  $order_detail_amortization 
where 
  period_month <= '$report_end_date' 
group by 
  order_id, 
  cancel_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:427</td><td>create table amort_billing (
  order_total DECIMAL(15, 2), 
  past_billing DECIMAL(15, 2), 
  month_billing DECIMAL(15, 2), 
  future_billing DECIMAL(15, 2), 
  past_tax DECIMAL(15, 2), 
  month_tax DECIMAL(15, 2), 
  prior_billing DECIMAL(15, 2), 
  total_billing DECIMAL(15, 2), 
  PRIMARY KEY(order_id, cancel_id)
) 
SELECT 
  o.order_id, 
  b.cancel_id, 
  order_total, 
  past_billing, 
  month_billing, 
  future_billing, 
  past_tax, 
  month_tax, 
  past_billing + month_billing prior_billing, 
  past_billing + month_billing + future_billing total_billing 
FROM 
  (
    billing.billing_monthly b, orders o
  ) 
WHERE 
  o.order_id = b.order_id 
  AND month_date = '$report_start_month'</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:446</td><td>create table amort_billing_credits (
  billed_credit DECIMAL(15, 2), 
  not_billed_credit DECIMAL(15, 2), 
  PRIMARY KEY(order_id, cancel_id)
) 
select 
  o.order_id, 
  o.cancel_id, 
  o.credit_total - o.tax_credit_total credit_total, 
  ifnull(total_billing, 0) billed_credit, 
  (
    (
      o.credit_total - o.tax_credit_total
    )+ ifnull(total_billing, 0)
  )*-1 not_billed_credit 
from 
  amort_merge o 
  left join amort_billing m on (
    o.order_id = m.order_id 
    and o.cancel_id = m.cancel_id
  ) 
where 
  1 
  and o.cancel_id <> 0 $deferred_where 
  and ifnull(total_billing, 0) <> credit_total *-1</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:465</td><td>CREATE TABLE next_year_revenue(
  next_year_revenue DECIMAL(15, 2), 
  PRIMARY KEY(order_id, cancel_id)
) 
SELECT 
  order_id, 
  cancel_id, 
  ROUND(
    SUM(period_total), 
    2
  ) next_year_revenue 
FROM 
  $order_detail_amortization 
WHERE 
  period_month BETWEEN '".date(' Y - m - d ',$next_month)."' 
  AND DATE_ADD(
    '$report_end_date', INTERVAL 1 YEAR
  ) 
GROUP BY 
  order_id, 
  cancel_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:481</td><td>CREATE TABLE ytd_sales (
  COLUMN_TYPE_STR PRIMARY KEY(order_id, cancel_id)
) 
SELECT 
  order_id, 
  cancel_id, 
  $order_date order_date, 
  IF(
    YEAR($order_date) = $report_year 
    AND $order_date <= '$report_end_date', 
    $order_total, 
    0
  ) sold_ytd</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:503</td><td>CREATE TABLE future_month_years_new_renew (
  COLUMN_TYPE_STR PRIMARY KEY (order_id, cancel_id)
) 
SELECT 
  a.order_id, 
  a.cancel_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:916</td><td>CREATE TABLE $defer_table_name (
  PRIMARY KEY(order_id, cancel_id)
) ROW_FORMAT = DYNAMIC ENGINE = InnoDB 
select 
  r.order_id, 
  r.cancel_id, 
  State state, 
  District district, 
  School school, 
  `Bill To` billto, 
  `Order Date` order_date, 
  `Start Date` start_date, 
  `End Date` end_date, 
  `Order Total` order_total, 
  `Orig Order Total` orig_order_total, 
  Cancel cancel, 
  Credit credit, 
  `Recognized Revenue` recognized_revenue, 
  IFNULL(next_year_revenue, 0) next_year_revenue, 
  `Prev Billing` + `This Month Billing` 'billed_to_date', 
  `Prev Billed Tax` + `This Month Billed Tax` tax_billed_to_date, 
  `Future Billing` future_billing, 
  `Deferred Revenue` deferred_revenue, 
  IF(
    IFNULL(next_year_revenue, 0) > `Deferred Revenue`, 
    `Deferred Revenue`, 
    IFNULL(next_year_revenue, 0)
  ) deferred_short_term_revenue 
from 
  $table_name r 
  left join next_year_revenue s ON (
    r.order_id = s.order_id 
    AND r.cancel_id = s.cancel_id
  ) 
where 
  round(`Deferred Revenue`) <> 0</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:948</td><td>CREATE TABLE defer_delete(
  PRIMARY KEY(billing_account_id)
) 
select 
  billing_account_id 
from 
  $defer_table_name 
where 
  order_id not in (2517) 
group by 
  billing_account_id 
having 
  round(
    sum(deferred_revenue)
  ) = 0</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:967</td><td>CREATE TABLE defer_delete(
  PRIMARY KEY(billing_account_id, order_date)
) 
select 
  billing_account_id, 
  order_date 
from 
  $defer_table_name 
where 
  order_id not in (2517) 
group by 
  billing_account_id, 
  order_date 
having 
  round(
    sum(deferred_revenue)
  ) = 0 #between -1 and 1</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:987</td><td>CREATE TABLE defer_delete(
  PRIMARY KEY(account_id)
) 
select 
  account_id 
from 
  $defer_table_name 
where 
  order_id not in (2517) 
group by 
  account_id 
having 
  round(
    sum(deferred_revenue)
  ) = 0 #between -1 and 1</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:1006</td><td>CREATE TABLE defer_delete(
  PRIMARY KEY(billing_account_id, year)
) 
select 
  billing_account_id, 
  year(order_date) year 
from 
  $defer_table_name 
where 
  order_id not in (2517) 
group by 
  billing_account_id, 
  year(order_date) 
having 
  round(
    sum(deferred_revenue)
  ) = 0 #between -1 and 1</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_report.inc:1186</td><td>CREATE TABLE tmp_revenue_generate_csv 
SELECT 
  * 
FROM 
  $table_name</td><td></td><td></td></tr>
   <tr><td>orders/cancel_do.php:313</td><td>CREATE TEMPORARY TABLE accounts_no_days (
  primary key (account_id, academic_year_id)
) 
SELECT 
  account_id, 
  academic_year_id 
FROM 
  account_pd_summary 
WHERE 
  account_id in (
    " . implode(", ", $order_detail_accounts) . "
  ) 
GROUP BY 
  account_id, 
  academic_year_id 
HAVING 
  sum(available_pd) = 0</td><td></td><td>skip</td></tr>
   <tr><td>reports/commissions/combined/bulk_generate/index.php:41</td><td>CREATE TABLE $bckup_payroll_lock_table_name 
SELECT 
  * 
FROM 
  commissions.payroll_lock_staging pls 
WHERE 
  pls.cmonth = '$commissions_month' 
  AND pls.payroll_date = '$payroll_date'</td><td></td><td></td></tr>
   <tr><td>reports/commissions/combined/bulk_generate/index.php:53</td><td>CREATE TABLE $bckup_payroll_details_lock_table_name 
SELECT 
  * 
FROM 
  commissions.payroll_lock_details_staging 
WHERE 
  cmonth = '$commissions_month' 
  AND payroll_date = '$payroll_date'</td><td></td><td></td></tr>
   <tr><td>reports/commissions/combined/bulk_generate/index.php:67</td><td>CREATE TEMPORARY TABLE order_years 
SELECT 
  DISTINCT YEAR(order_date) year 
FROM 
  commissions.orders 
WHERE 
  cmonth = '$commissions_month'</td><td></td><td>skip</td></tr>
   <tr><td>reports/opportunities/open_index.php:387</td><td>CREATE TEMPORARY TABLE $table_name 
SELECT 
  p.opportunity_id, 
  p.opportunity_name, 
  a.state_code, 
  if(
    a.account_level = 2, d.account_name, 
    a.account_name
  ) district, 
  if(
    a.account_level = 2, a.account_name, 
    ''
  ) school, 
  if (
    cc.first_name is not null, cc.first_name, 
    c.first_name
  ) first_name, 
  if (
    cc.middle_name is not null, cc.middle_name, 
    c.middle_name
  ) middle_name, 
  if (
    cc.last_name is not null, cc.last_name, 
    c.last_name
  ) last_name, 
  r.region_name, 
  p.close_date, 
  s.probability_percent, 
  p.total, 
  ifnull(no_po, 'N/A') no_po_flag, 
  if(
    no_po > 0, 
    'Not Required', 
    group_concat(po.po)
  ) po_number, 
  0 nonstandard_discount, 
  0 nonstandard_product, 
  0 has_final_quote, 
  p.lead_source_id, 
  space(50) lead_source_name, 
  
  /* if( instr(a.customer_status,'Customer')>0,'Renew','New') new_renew, --commenting out as per RQ:000911*/
  '' new_renew, 
  substr(u.first_name, 1, 1) rep_first_name, 
  u.last_name rep_last_name, 
  p.opportunity_type_id, 
  group_concat(
    distinct opm.opportunity_product_id 
    order by 
      opm.opportunity_product_id
  ) opportunity_product, 
  left(p.notes, 200) notes 
FROM 
  (
    opportunities p, accounts a, user_orders o, 
    users u, opportunity_probabilities s, 
    region_states rs, regions r
  ) 
  LEFT JOIN accounts d on (
    a.parent_account_id = d.account_id
  ) 
  LEFT JOIN order_po po ON (
    p.opportunity_id = po.opportunity_id
  ) 
  LEFT JOIN order_contacts oc ON (
    o.opportunity_id = oc.opportunity_id 
    AND oc.contact_type_id = '" . $CONTACT_TYPES["buyer"] . "'
  ) 
  LEFT JOIN contacts c ON (c.contact_id = oc.contact_id) 
  LEFT JOIN contact_changes cc ON (
    cc.contact_change_id = oc.contact_change_id
  ) 
  LEFT JOIN opportunity_product_map opm on (
    p.opportunity_id = opm.opportunity_id
  ) 
  LEFT JOIN opportunity_product_map opm2 on (
    p.opportunity_id = opm2.opportunity_id
  ) 
WHERE 
  p.account_id = a.account_id 
  AND p.opportunity_id = o.opportunity_id 
  AND o.role_id = '".$ROLE[$DEPARTMENT["sales"]]["sales_rep"]."' 
  AND o.user_id = u.user_id 
  AND p.probability_id = s.probability_id 
  AND rs.state_code = a.state_code 
  AND rs.region_id = r.region_id 
  AND r.department_id = ".$DEPARTMENT[" sales "]." $whereStr 
GROUP BY 
  p.opportunity_id, 
  region_name</td><td></td><td>skip</td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_2017.php:118</td><td>CREATE TEMPORARY TABLE interlink.temp_renew_qcpr_user_data_source (
  PRIMARY KEY(renewal_user_id), 
  KEY(il_user_id), 
  INDEX(nvp_id), 
  INDEX(vp_id), 
  INDEX(rvp_id)
) 
SELECT 
  
  /*Manager/User Group Data*/
  CAST(
    COALESCE(
      NULLIF(u.nvp_id, ''), 
      1
    ) as CHAR(8)
  ) nvp_id, 
  COALESCE(
    NULLIF(u.nvp, ''), 
    'No NVP'
  ) nvp, 
  COALESCE(
    NULLIF(u.nvp_area_sort, ''), 
    1
  ) nvp_area_sort, 
  CAST(
    COALESCE(
      NULLIF(u.vp_id, ''), 
      1
    ) as CHAR(8)
  ) vp_id, 
  COALESCE(
    NULLIF(u.vp, ''), 
    'No VP'
  ) vp, 
  COALESCE(
    NULLIF(u.vp_area_sort, ''), 
    1
  ) vp_area_sort, 
  CAST(
    COALESCE(
      NULLIF(u.rvp_id, ''), 
      1
    ) as CHAR(8)
  ) rvp_id, 
  COALESCE(
    NULLIF(u.rvp, ''), 
    'No RVP'
  ) rvp, 
  COALESCE(
    NULLIF(u.rvp_area_sort, ''), 
    1
  ) rvp_area_sort, 
  a.area_id, 
  u.`area`, 
  u.user_id il_user_id, 
  u.comp_plan_id, 
  u.comp_plan_id renewal_user_id, 
  u.user_f_last renewal_user, 
  u.last_name, 
  u.status user_status, 
  u.renewal_qcpr_status, 
  cp.termination_date termination_date, 
  CASE WHEN u.area_comp_plan_type IN ('nvp', 'vp', 'rvp', 'dm', 'a3k') THEN u.area_comp_plan_type ELSE 'renewal_user' END comp_plan_type 
FROM 
  commissions.users_cp u 
  LEFT JOIN commissions.compensation_plans cp ON cp.comp_plan_id = u.comp_plan_id 
  AND cp.cmonth = '$report_month_filter' 
  and cp.year = $year 
  LEFT JOIN commissions.areas a on a.area_id = cp.area_id 
  LEFT JOIN commissions.qcpr_manager_permissions m ON m.manager_id = '$curr_user_id' 
  AND m.user_id = u.user_id 
  AND m.cmonth = '$report_month_filter' 
WHERE 
  1 
  AND u.year = $year 
  AND u.cmonth = '$report_month_filter' 
  and u.renewal_qcpr_status = 0 #Has current year order/QC/credit OR non-terminated rep with quota
  $user_where 
GROUP BY 
  u.sales_user_id, 
  u.comp_plan_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_2017.php:164</td><td>CREATE TEMPORARY TABLE interlink.temp_renew_qcpr_user_data_source_copy (
  PRIMARY KEY(renewal_user_id)
) 
SELECT 
  * 
FROM 
  interlink.temp_renew_qcpr_user_data_source</td><td></td><td>skip</td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_2017.php:177</td><td>CREATE TEMPORARY TABLE tmp_account_trainers (
  PRIMARY KEY (account_id), 
  trainer_user_name VARCHAR(250), 
  imp_rvp_user_name VARCHAR(250)
) 
SELECT 
  uad.account_id, 
  SUBSTRING_INDEX(
    MIN(
      CONCAT(
        CASE WHEN uad.role_id IN (4, 5) THEN uad.role_id ELSE NULL END, 
        '|', 
        uad.user_id
      )
    ), 
    '|', 
    -1
  ) trainer_user_id, 
  '' trainer_user_name, 
  MAX(
    CASE WHEN uad.role_id = 7 THEN uad.user_id ELSE NULL END
  ) imp_rvp_user_id, 
  '' imp_rvp_user_name 
FROM 
  interlink.user_account_dates uad 
  INNER JOIN commissions.renewal_report_base rb ON rb.account_id = uad.account_id 
  AND rb.cmonth = '$report_month_filter' 
  AND rb.rank = 1 
  INNER JOIN commissions.users u ON u.user_id = uad.user_id 
WHERE 
  @month_end BETWEEN uad.start_date 
  AND uad.end_date 
  AND uad.account_owner = 1 
  AND uad.role_id IN (7, 4, 5) 
GROUP BY 
  uad.account_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_2017.php:208</td><td>CREATE TEMPORARY TABLE tmp_account_districts (
  PRIMARY KEY (account_id)
) 
SELECT 
  a.account_id, 
  a.account_name, 
  a.state_code, 
  a.account_level, 
  COALESCE(
    d1.account_id, CASE WHEN a.account_level = 1 THEN a.account_id ELSE -1 END
  ) district_account_id, 
  COALESCE(
    d1.account_name, CASE WHEN a.account_level = 1 THEN a.account_name ELSE '-- No District --' END
  ) district_account_name, 
  COALESCE(d1.state_code, a.state_code) district_state_code, 
  CASE WHEN d1.account_id 
  OR a.account_level = 1 THEN 1 ELSE 0 END has_district, 
  tat.trainer_user_name account_trainer, 
  tat.imp_rvp_user_name account_imp_rvp 
FROM 
  interlink.accounts a 
  INNER JOIN commissions.renewal_report_base rb ON rb.account_id = a.account_id 
  LEFT JOIN interlink.accounts d1 ON d1.account_id = a.parent_account_id 
  AND d1.account_level = 1 
  AND a.account_level = 2 
  LEFT JOIN tmp_account_trainers tat ON tat.account_id = a.account_id 
WHERE 
  rb.cmonth = '$report_month_filter' 
  AND rb.rank = 1 
GROUP BY 
  a.account_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_2017.php:235</td><td>CREATE TEMPORARY TABLE interlink.temp_renew_qcpr_qc_data_source (
  row_id INT UNSIGNED not null auto_increment PRIMARY KEY, 
  INDEX(renewal_user_id)
) 
SELECT 
  
  /*******USER INFO*******/
  cp.user_id, 
  cp.comp_plan_id renewal_user_id, 
  base.orig_user_id, 
  base.is_primary_user, 
  
  /*******ACCOUNT PROGRAM INFO*******/
  tad.account_level, 
  tad.district_account_id district_account_id, 
  tad.district_account_name district_account, 
  tad.district_state_code district_state, 
  tad.district_state_code district_state_id, 
  tad.has_district, 
  tad.account_id, 
  tad.account_name account_name, 
  tad.state_code state_id, 
  tad.state_code state, 
  CASE WHEN tad.account_level = 1 THEN 'z' WHEN base.on_target = 1 THEN 'y' ELSE 'n' END on_target_id, 
  CASE WHEN tad.account_level = 1 THEN 'District' WHEN base.on_target = 1 THEN 'Within Quota' ELSE 'Not Within Quota' END on_target, 
  base.on_target orig_on_target, 
  CASE WHEN tad.account_level = 1 THEN '-1' ELSE base.purchaser_level END purchaser_level_id, 
  CASE WHEN tad.account_level = 1 THEN 'District' WHEN base.purchaser_level = 1 THEN 'District Purchase' ELSE 'School Purchase' END purchaser_level, 
  base.program_id, 
  op.opportunity_product_name program, 
  
  /*******EXPIRING ACCOUNT*******/
  CONCAT(
    tad.account_id, 'p', base.program_id, 
    'o', base.order_id
  ) expiring_account_id, 
  tad.account_name expiring_account, 
  CASE WHEN base.on_target = 1 
  AND tad.account_level = 2 THEN 1 ELSE 0 END orig_expiring_school_count, 
  CASE WHEN (base.on_target)= 1 
  AND base.school_rank = 1 
  AND tad.account_level = 2 THEN 1 ELSE 0 END expiring_school_count, 
  0 expiring_license_count, 
  rb.renewal_quota_updated orig_expiring_order_account_value, 
  (base.renewal_quota_updated) expiring_order_account_value, 
  base.non_quota_account, 
  district_re_allocated, 
  
  /*******NEW ORDER*******/
  base.rank, 
  base.school_rank, 
  base.order_id booked_order_id, 
  base.order_id booked_order, 
  co.cancel, 
  IFNULL(base.orig_school_count, 0) orig_booked_school_count, 
  IFNULL(base.school_count, 0) booked_school_count, 
  IFNULL(
    base.school_count / base.on_target, 
    0
  ) booked_school_percent, 
  CASE WHEN rqt.booked_target_year = 0 THEN single_year_value ELSE base.all_yr_value END booked_order_account_value, 
  
  /******QC******/
  qc_total, 
  IFNULL(
    base.qc_total / base.renewal_quota, 
    0
  ) qc_percent, 
  
  /******ACV******/
  base.single_year_value, 
  CASE WHEN base.purchaser_level = 1 
  AND acv_total > single_year_value THEN LEAST (
    more_schools_yr_1, 
    (acv_total - single_year_value)
  ) ELSE 0 END more_schools_acv, 
  acv_total acv_total, 
  IFNULL(
    base.acv_total / base.renewal_quota, 
    0
  ) acv_percent, 
  
  /******Target Expansion******/
  CASE WHEN base.purchaser_level = 1 
  AND single_year_value > acv_total THEN single_year_value - acv_total ELSE 0 END expansion_acv, 
  target_more_years, 
  
  /******Non-Target Expansion******/
  more_products_yr_1 + more_products_more_years more_products, 
  CASE WHEN base.purchaser_level = 1 
  AND acv_total > single_year_value THEN GREATEST(
    more_schools_yr_1 -(acv_total - single_year_value), 
    0
  ) + more_schools_more_years ELSE more_schools_yr_1 + more_schools_more_years END more_schools, 
  
  /*******ACCOUNT LEVEL ADDTL INFO*******/
  aps.year_value booked_account_value, 
  aps.percent_target percent_account_target, 
  CASE WHEN base.on_target = 1 THEN aps.expiring_orders ELSE '' END expiring_orders, 
  tad.account_trainer, 
  tad.account_imp_rvp 
FROM 
  commissions.renewal_order_users base 
  INNER JOIN interlink.accounts a ON a.account_id = base.account_id 
  INNER JOIN commissions.renewal_report_base rb ON rb.cmonth = '$report_month_filter' 
  AND rb.account_id = base.account_id 
  AND rb.order_id = base.order_id 
  AND rb.user_id = base.user_id 
  AND rb.program_id = base.program_id 
  LEFT JOIN commissions.orders co ON co.order_id = base.order_id 
  AND co.cmonth = '$report_month_filter' 
  LEFT JOIN interlink.opportunity_products op ON op.opportunity_product_id = base.program_id 
  LEFT JOIN tmp_account_districts tad ON tad.account_id = base.account_id 
  LEFT JOIN commissions.users_cp cp ON cp.user_id = base.user_id 
  AND cp.cmonth = '$report_month_filter' 
  AND cp.year = $year 
  LEFT JOIN commissions.renewal_account_program_summary aps ON aps.account_id = base.account_id 
  and aps.program_id = base.program_id 
  AND aps.cmonth = '$report_month_filter' 
  LEFT JOIN commissions.renewal_quota_types rqt ON rqt.renewal_user_id = base.base_user_id 
WHERE 
  base.cmonth = '$report_month_filter' 
  AND base.user_id = base.base_user_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_2017.php:330</td><td>CREATE TEMPORARY TABLE interlink.temp_renew_qcpr_qc_data_source_copy (
  row_id INT UNSIGNED not null auto_increment PRIMARY KEY, 
  INDEX(renewal_user_id)
) 
SELECT 
  * 
FROM 
  interlink.temp_renew_qcpr_qc_data_source</td><td></td><td>skip</td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_2017.php:542</td><td>CREATE TEMPORARY TABLE tmp_account_sales_rep (
  PRIMARY KEY (account_id)
) 
SELECT 
  a.account_id, 
  ua.user_id, 
  CONCAT(u.first_name, ' ', u.last_name) account_sales_rep, 
  an.area_name 
FROM 
  interlink.accounts a 
  INNER JOIN interlink.user_account_dates ua ON ua.account_id = a.account_id 
  AND ua.role_id = 6 
  AND ua.account_owner = 1 
  AND '$cmonth_end' BETWEEN ua.start_date 
  AND ua.end_date 
  INNER JOIN commissions.renewal_report_base rb ON rb.account_id = a.account_id 
  AND rb.cmonth = '$report_month_filter' 
  INNER JOIN commissions.users u ON u.user_id = ua.user_id 
  LEFT JOIN commissions.area_users au ON au.user_id = ua.user_id 
  AND '$cmonth_end' BETWEEN au.start_date 
  AND au.end_date 
  LEFT JOIN commissions.areas an ON an.area_id = au.area_id 
GROUP BY 
  a.account_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/qcpr/renewals/generate_data_2017.php:561</td><td>CREATE TEMPORARY TABLE tmp_renewal_export_table (
  KEY(
    user, `account id`, `booked order`
  )
) 
SELECT 
  rou.last_name `User`, 
  u.last_name `Renewal Rep User`, 
  qc.district_account_id `District ID`, 
  qc.district_account `District`, 
  qc.district_state `District State`, 
  qc.account_id `Account ID`, 
  qc.account_name `Account`, 
  qc.state `State`, 
  CASE WHEN qc.account_level = 1 THEN 'District' WHEN qc.account_level = 2 THEN 'School' ELSE '' END `Account Type`, 
  qc.program `Program`, 
  qc.purchaser_level `Purchaser Level`, 
  qc.orig_expiring_order_account_value `Expiring Renewal Quota`, 
  qc.expiring_orders `Expiring Orders`, 
  qc.orig_expiring_school_count `Expiring # Schools`, 
  qc.orig_booked_school_count `Booked # Schools`, 
  qc.acv_total `ACV Total`, 
  CASE WHEN rou.base_user_id = rou.user_id 
  OR qc.is_primary_user = 1 THEN qc.acv_percent ELSE 0 END `ACV Total %`, 
  qc.single_year_value `Target Acct Value  $year - $year_to`, 
  qc.expansion_acv `Target Acct Upsell  $year - $year_to`, 
  qc.target_more_years `Target Acct Addt'l Years`, 
  rou.more_products_yr_1 `More Products  $year - $year_to Year`, 
  rou.more_products_more_years `More Products Addt'l Years`, 
  rou.more_schools_yr_1 `More Schools  $year - $year_to Year`, 
  rou.more_schools_more_years `More Schools Addt'l Years`, 
  qc.more_schools_acv `More Schools ACV`, 
  qc.more_schools `More Schools Expansion`, 
  qc.qc_total `QC Total`, 
  qc.qc_percent `QC %`, 
  qc.booked_order_account_value `Booked Order Account Total`, 
  qc.booked_order_id `Booked Order`, 
  
  /*school count can be overriden to 1 even if not on target*/
  CASE WHEN (
    qc.orig_on_target = 1 
    OR qc.booked_school_count = 1
  ) 
  AND rou.is_primary_user = 1 THEN qc.rank ELSE '' END `Order Count (Target Acct)`, 
  CASE WHEN rou.on_target = 1 
  AND rou.school_rank = 1 
  AND a.account_level = 2 
  AND rou.is_primary_school_rank = 1 THEN 1 ELSE '' END `School Count (Target Acct)`, 
  qc.on_target `Quota Bucket`, 
  o.order_date `Order Date`, 
  o.start_date `Start Date`, 
  o.end_date `End Date`, 
  o.Cancel `Is Cancelled`, 
  o.order_total `Order Total`, 
  oi.credit_revenue_total + oi.bad_debt_total `Credits (Cancels/Bad Debt)`, 
  o.sales_rep `Opportunity Owner`, 
  oi.order_renewal_rep `Renewal Rep`, 
  COALESCE(
    NULLIF(oi.order_field_rep, ''), 
    asr.account_sales_rep
  ) `Field Rep`, 
  COALESCE(
    NULLIF(
      oi.order_field_region, 'National Renewal Region'
    ), 
    asr.area_name, 
    ''
  ) `Region`, 
  qc.account_trainer `Account Trainer`, 
  qc.account_imp_rvp `Account Imp. RVP`, 
  rou.po_total `PO Total`, 
  rou.year_po_total `$year - $year_to PO Total` "
            .($corporate_report?
            ", 
  CASE WHEN l.is_domestic = 1 
  OR l.location_code IS NULL THEN 0 ELSE 1 END international, 
  rou.strict_acv `Strict ACV`, 
  rou.strict_upsell `Strict Upsell` -- EXPIRING
  , 
  rxb.literacy `Expiring Literacy`, 
  rxb.levelset `Expiring Levelset`, 
  rxb.bae `Expiring BAE`, 
  rxb.smarty_ants `Expiring Smarty Ants`, 
  rxb.science `Expiring Science`, 
  rxb.onsite_pd `Expiring Onsite PD`, 
  rxb.online_pd `Expiring Online PD`, 
  rxb.pm_imf `Expiring PM/IMF`, 
  rxb.literacy_summer `Expiring Literacy Summer`, 
  rxb.levelset_summer `Expiring Levelset Summer`, 
  rxb.bae_summer `Expiring BAE Summer`, 
  rxb.smarty_ants_summer `Expiring Smarty Ants Summer`, 
  rxb.science_summer `Expiring Science Summer`, 
  rxb.onsite_pd_summer `Expiring Onsite PD Summer`, 
  rxb.online_pd_summer `Expiring Online PD Summer`, 
  rxb.pm_imf_summer `Expiring PM/IMF Summer`, 
  rxb.literacy_count `Expiring Literacy License Count`, 
  rxb.levelset_count `Expiring Levelset License Count`, 
  rxb.bae_count `Expiring BAE License Count`, 
  rxb.smarty_ants_count `Expiring Smarty Ants License Count`, 
  rxb.science_count `Expiring Science License Count`, 
  rxb.onsite_pd_count `Expiring Onsite PD Count`, 
  rxb.online_pd_count `Expiring Online PD Count`, 
  rxb.literacy_summer_count `Expiring Literacy Summer License Count`, 
  rxb.levelset_summer_count `Expiring Levelset Summer License Count`, 
  rxb.bae_summer_count `Expiring BAE Summer License Count`, 
  rxb.smarty_ants_summer_count `Expiring Smarty Ants Summer License Count`, 
  rxb.science_summer_count `Expiring Science Summer License Count`, 
  rxb.onsite_pd_summer_count `Expiring Onsite PD Summer Count`, 
  rxb.online_pd_summer_count `Expiring Online PD Summer Count` -- BOOKED
  , 
  rbb.literacy `Literacy`, 
  rbb.levelset `Levelset`, 
  rbb.bae `BAE`, 
  rbb.smarty_ants `Smarty Ants`, 
  rbb.science `Science`, 
  rbb.onsite_pd `Onsite PD`, 
  rbb.online_pd `Online PD`, 
  rbb.pm_imf `PM/IMF`, 
  rbb.literacy_summer `Literacy Summer`, 
  rbb.levelset_summer `Levelset Summer`, 
  rbb.bae_summer `BAE Summer`, 
  rbb.smarty_ants_summer `Smarty Ants Summer`, 
  rbb.science_summer `Science Summer`, 
  rbb.onsite_pd_summer `Onsite PD Summer`, 
  rbb.online_pd_summer `Online PD Summer`, 
  rbb.pm_imf_summer `PM/IMF Summer`, 
  rbb.literacy_count `Literacy License Count`, 
  rbb.levelset_count `Levelset License Count`, 
  rbb.bae_count `BAE License Count`, 
  rbb.smarty_ants_count `Smarty Ants License Count`, 
  rbb.science_count `Science License Count`, 
  rbb.onsite_pd_count `Onsite PD Count`, 
  rbb.online_pd_count `Online PD Count`, 
  rbb.literacy_summer_count `Literacy Summer License Count`, 
  rbb.levelset_summer_count `Levelset Summer License Count`, 
  rbb.bae_summer_count `BAE Summer License Count`, 
  rbb.smarty_ants_summer_count `Smarty Ants Summer License Count`, 
  rbb.science_summer_count `Science Summer License Count`, 
  rbb.onsite_pd_summer_count `Onsite PD Summer Count`, 
  rbb.online_pd_summer_count `Online PD Summer Count` "
            : "")
            ." 
FROM 
  commissions.renewal_order_users rou 
  INNER JOIN interlink.accounts a ON a.account_id = rou.account_id 
  LEFT JOIN interlink.temp_renew_qcpr_qc_data_source qc ON rou.order_id = qc.booked_order_id 
  AND rou.account_id = qc.account_id 
  AND rou.program_id = qc.program_id 
  AND rou.base_user_id = qc.user_id 
  INNER JOIN commissions.users u ON rou.base_user_id = u.user_id 
  INNER JOIN interlink.temp_renew_qcpr_user_data_source qcu ON rou.user_id = qcu.il_user_id 
  LEFT JOIN commissions.orders o ON o.order_id = rou.order_id 
  AND o.cmonth = '$report_month_filter' 
  LEFT JOIN commissions.order_info oi ON oi.order_id = rou.order_id 
  AND oi.cmonth = '$report_month_filter' 
  LEFT JOIN interlink.tmp_account_sales_rep asr ON asr.account_id = rou.account_id 
  LEFT JOIN interlink.locations l ON a.state_code = l.location_code 
  AND l.location_type = 's' ".($corporate_report?
            " 
  LEFT JOIN commissions.renewal_user_order_booked_buckets rbb ON rbb.order_id = rou.order_id 
  AND rbb.account_id = rou.account_id 
  AND rbb.user_id = rou.user_id 
  AND rbb.is_myo = rou.is_myo 
  AND rbb.program_id = rou.program_id 
  AND rbb.base_user_id = rou.base_user_id 
  AND rbb.ay_bucket_id = 1 
  AND rbb.cmonth = rou.cmonth 
  LEFT JOIN commissions.renewal_user_account_expiring_buckets rxb ON rxb.account_id = rou.account_id 
  AND rxb.user_id = rou.user_id 
  AND rxb.is_myo = rou.is_myo 
  AND rxb.program_id = rou.program_id 
  AND rxb.base_user_id = rou.base_user_id 
  AND rxb.cmonth = rou.cmonth ": " ").
            " 
WHERE 
  rou.cmonth = '$report_month_filter' 
ORDER BY 
  u.last_name, 
  qc.district_state_id, 
  qc.has_district DESC, 
  qc.district_account, 
  qc.on_target_id DESC, 
  qc.account_name, 
  qc.program_id, 
  qc.rank, 
  qc.booked_order_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/sales/order_initial_pos_index.php:174</td><td>CREATE TEMPORARY TABLE tmp_po_year_info 
SELECT 
  pt.order_id, 
  YEAR(
    IFNULL(
      NULLIF(ptd.received_date, 0), 
      ptd.payment_term_date
    )
  ) yr, 
  SUM(ptd.payment_term_amount) sum_pmt_terms, 
  SUM(ptd.payment_term_amount)/(
    obs.order_total - obs.cancel_total - os.sales_tax
  ) po_yr_perc 
FROM 
  payment_terms pt 
  INNER JOIN payment_term_details ptd ON pt.payment_term_id = ptd.payment_term_id 
  INNER JOIN orders o ON o.order_id = pt.order_id 
  INNER JOIN order_billing_summary obs ON obs.order_id = pt.order_id 
  INNER JOIN order_summary os ON os.order_id = obs.order_id 
WHERE 
  obs.order_total > 0 
GROUP BY 
  pt.order_id, 
  yr;</td><td></td><td>skip</td></tr>
   <tr><td>reports/sales/order_initial_pos_index.php:193</td><td>CREATE TEMPORARY TABLE tmp_po_order_info(
  primary key (order_id)
) 
SELECT 
  order_id, 
  GROUP_CONCAT(
    CONCAT(
      '  YEAR ', 
      yr, 
      ': $', 
      FORMAT(sum_pmt_terms, 2), 
      ' = ', 
      ROUND(po_yr_perc * 100, 1), 
      '%', 
      ''
    )
  ) order_year_notes, 
  SUM(sum_pmt_terms) order_po_total, 
  SUM(po_yr_perc) order_po_total_percent 
FROM 
  tmp_po_year_info 
GROUP BY 
  order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/sales/order_initial_pos_index.php:207</td><td>CREATE TEMPORARY TABLE tmp_max_rate (
  PRIMARY KEY (order_id)
) 
SELECT 
  ou.order_id, 
  GROUP_CONCAT(DISTINCT ou.last_name) order_users, 
  MAX(rate) max_rate 
FROM 
  commissions.order_users ou 
  LEFT JOIN commissions.commissions c on ou.order_id = c.order_id 
  and ou.user_id = c.user_id 
  and ou.cmonth = c.cmonth 
  and c.rate_type = 'new' 
WHERE 
  ou.cmonth = '$cmonth' 
GROUP BY 
  ou.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/sales/sales_activity_history_index.php:70</td><td>CREATE TABLE $tmp_events_table as 
select 
  * 
from 
  $report_tmp_table</td><td></td><td></td></tr>
   <tr><td>cron/ns_sync/accounts_sync.php:202</td><td>CREATE TABLE sync_sales_rep (
  PRIMARY KEY (account_id)
) 
SELECT 
  a.account_id, 
  max(
    concat(first_name, ' ', last_name)
  ) sales_rep 
FROM 
  user_accounts a, 
  sync_accounts s, 
  users u 
WHERE 
  a.account_id = s.account_id 
  and a.user_id = u.user_id 
  and role_id = 6 
GROUP BY 
  a.account_id</td><td></td><td></td></tr>
   <tr><td>cron/ns_sync/accounts_sync.php:210</td><td>CREATE TABLE sync_addresses (
  INDEX (account_id)
) 
SELECT 
  a.account_id, 
  address_type, 
  address, 
  address2, 
  city, 
  state_code, 
  zip, 
  l.location_name country 
FROM 
  sync_accounts a, 
  account_address aa, 
  locations l 
WHERE 
  a.account_id = aa.account_id 
  AND aa.country_code = l.location_code 
  AND l.location_type = 'C' 
  AND aa.address_type = 'M'</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:89</td><td>CREATE TABLE summary_pending_order_details (
  primary key (order_detail_id)
) 
SELECT 
  DISTINCT order_detail_id 
FROM 
  account_pd_summary 
WHERE 
  pending = 1</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:105</td><td>CREATE TABLE summary_orders_all (
  primary key (order_id)
) 
SELECT 
  o.order_id, 
  o.expansion_order_id, 
  o.account_id, 
  o.billing_account_id, 
  o.order_date, 
  
  /*o.start_date, o.end_date,*/
  MIN(od.start_date) start_date, 
  MAX(od.end_date) end_date 
FROM 
  orders o, 
  order_details od 
WHERE 
  o.status = 0 
  AND o.draft = 0 
  AND o.order_id = od.order_id 
  AND od.status = 0 
  AND od.academic_year_id > 0 " . ($refresh_orders ? " 
  AND o.order_id IN (
    " . implode(", ", $refresh_orders) . "
  ) " : "") . " 
GROUP BY 
  o.order_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:128</td><td>CREATE TABLE summary_order_details_all (
  primary key (order_detail_id)
) 
SELECT 
  d.order_id, 
  d.order_detail_id, 
  d.account_id, 
  d.academic_year_id, 
  d.product_id, 
  d.quantity, 
  d.start_date, 
  d.end_date, 
  if(
    d.post_end = 0, d.end_date, d.post_end
  ) post_end, 
  d.link_order_detail_id 
FROM 
  summary_orders_all o, 
  order_details d 
WHERE 
  o.order_id = d.order_id 
  AND d.status = 0</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:192</td><td>CREATE TABLE summary_account_info (
  primary key (account_id, academic_year_Id)
) 
SELECT 
  a.account_id, 
  o.academic_year_id, 
  a.parent_account_id, 
  concat(
    year(o.start_date), 
    '-', 
    a.school_start
  ) school_start, 
  concat(
    year(o.end_date), 
    '-', 
    a.school_end
  ) school_end, 
  concat(
    year(o.end_date), 
    '-', 
    a.school_end
  ) placeholder 
FROM 
  accounts a, 
  summary_order_details_all o 
WHERE 
  a.account_id = o.account_id 
  AND o.academic_year_id IN (
    ".implode(", ", $academic_years)."
  ) 
GROUP BY 
  a.account_id, 
  o.academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:210</td><td>CREATE TABLE summary_account_info_tmp (
  primary key (
    parent_account_id, academic_year_id
  )
) 
SELECT 
  s.parent_account_id, 
  s.academic_year_id 
FROM 
  summary_account_info s 
WHERE 
  s.parent_account_id > 0 
GROUP BY 
  parent_account_id, 
  academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:238</td><td>CREATE TABLE summary_order_detail_info (
  primary key (
    order_detail_id, academic_year_id, 
    account_id
  )
) 
SELECT 
  o.order_id, 
  o.expansion_order_id, 
  o.account_id purchasing_account_id, 
  o.order_date order_date, 
  o.start_date order_start, 
  o.end_date order_end, 
  d.start_date detail_start, 
  d.end_date detail_end, 
  d.post_end, 
  d.order_detail_id, 
  d.link_order_detail_id, 
  d.account_id, 
  0 account_level, 
  d.academic_year_id, 
  10000 student_licenses, 
  1000 total_trainings, 
  1000 total_purchased_pd, 
  1000.0 total_initial_pd, 
  1000.0 total_followup_pd, 
  1000.0 total_initial_online_pd, 
  1000.0 total_online_pd, 
  1000.0 total_fulfilled, 
  1000.0 total_scheduled, 
  
  /*1000.0 fulfilled_initial_pd, 1000.0 fulfilled_followup_pd, */
  1000.0 fulfilled_onsite_pd, 
  1000.0 fulfilled_online_pd, 
  1000.0 expired_pd, 
  1000.0 expired_onsite_pd, 
  1000.0 expired_online_pd, 
  
  /*1000.0 scheduled_initial_pd, 1000.0 scheduled_followup_pd, */
  1000.0 scheduled_onsite_pd, 
  1000.0 scheduled_online_pd, 
  1000 days_removed, 
  0 reallocated, 
  o.order_id origin_order_id 
FROM 
  summary_orders_all o, 
  summary_order_details_all d 
WHERE 
  o.order_id = d.order_id #AND d.product_id = s.product_id
  AND d.academic_year_id IN (
    ".implode(", ", $academic_years)."
  ) 
GROUP BY 
  d.order_detail_id, 
  d.academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:300</td><td>CREATE TABLE summary_student_licenses_pre (
  primary KEY(
    order_detail_id, sub_product_type_id
  )
) 
SELECT 
  od.order_detail_id, 
  s.sub_product_type_id, 
  SUM(p.student_licenses * od.quantity) student_licenses 
FROM 
  products p, 
  summary_order_details_all od, 
  sub_products s 
WHERE 
  p.product_id = od.product_id 
  AND p.product_id = s.product_id 
  AND p.sku NOT LIKE '%BIO%' 
  AND p.product_id NOT IN (6889, 6892, 6890, 7761) # solutions products that should be excluded
  AND s.sub_product_type_id IN (1, 22, 25, 28) 
  AND s.status = 0 
  AND od.academic_year_id IN (
    ".implode(", ", $academic_years)."
  ) 
GROUP BY 
  od.order_detail_id, 
  s.sub_product_type_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:316</td><td>CREATE TABLE summary_student_licenses (
  primary key(order_detail_id)
) 
SELECT 
  order_detail_id, 
  SUBSTRING_INDEX(
    MIN(
      CONCAT(
        sub_product_type_id, '|', student_licenses
      )
    ), 
    '|', 
    -1
  ) student_licenses 
FROM 
  summary_student_licenses_pre 
GROUP BY 
  order_detail_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:350</td><td>CREATE TEMPORARY TABLE order_detail_sub_products_use (
  primary key (order_id)
) 
SELECT 
  DISTINCT order_id 
FROM 
  order_detail_sub_products</td><td></td><td>skip</td></tr>
   <tr><td>cron/summary/populate_tables.inc:358</td><td>CREATE TABLE summary_order_pd_info (
  primary key (order_detail_id)
) 
SELECT 
  o.order_id, 
  od.order_detail_id, 
  sum(
    od.quantity * if(
      odsp.order_id, odsp.sub_product_qty, 
      sp.sub_product_qty
    )
  ) total_trainings, 
  sum(
    if(
      if(
        odsp.order_id, odsp.sub_product_type_id, 
        sp.sub_product_type_id
      ) IN (
        ".$SUB_PRODUCT_TYPES[" initial training "].", 
        ".$SUB_PRODUCT_TYPES[" trainer training "]."
      ), 
      (
        od.quantity * if(
          odsp.order_id, odsp.sub_product_qty, 
          sp.sub_product_qty
        )
      ), 
      0
    )
  ) total_initial_pd, 
  sum(
    if(
      if(
        odsp.order_id, odsp.sub_product_type_id, 
        sp.sub_product_type_id
      ) IN (
        ".$SUB_PRODUCT_TYPES[" followup training "]."
      ), 
      (
        od.quantity * if(
          odsp.order_id, odsp.sub_product_qty, 
          sp.sub_product_qty
        )
      ), 
      0
    )
  ) total_followup_pd, 
  sum(
    if(
      if(
        odsp.order_id, odsp.sub_product_type_id, 
        sp.sub_product_type_id
      ) IN (
        ".$SUB_PRODUCT_TYPES[" initial online training "]."
      ), 
      (
        od.quantity * if(
          odsp.order_id, odsp.sub_product_qty, 
          sp.sub_product_qty
        )
      ), 
      0
    )
  ) total_initial_online_pd, 
  sum(
    if(
      if(
        odsp.order_id, odsp.sub_product_type_id, 
        sp.sub_product_type_id
      ) IN (
        ".$SUB_PRODUCT_TYPES[" online training "]."
      ), 
      (
        od.quantity * if(
          odsp.order_id, odsp.sub_product_qty, 
          sp.sub_product_qty
        )
      ), 
      0
    )
  ) total_online_pd 
FROM 
  (
    orders o, summary_order_details_all od
  ) 
  LEFT JOIN order_detail_sub_products_use odspu ON (o.order_id = odspu.order_id) 
  LEFT JOIN order_detail_sub_products odsp ON (
    od.order_detail_id = odsp.order_detail_id
  ) 
  LEFT JOIN sub_products sp ON (
    od.product_id = sp.product_id 
    AND sp.status = 0 
    AND odspu.order_id is null
  ) 
  LEFT JOIN sub_product_types spt ON (
    spt.sub_product_type_id IN (
      odsp.sub_product_type_id, sp.sub_product_type_id
    )
  ) 
WHERE 
  o.order_id = od.order_id 
  AND spt.pd_deliverable = 'Y' 
GROUP BY 
  od.order_detail_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:425</td><td>CREATE TABLE summary_order_reallocation_sum (
  primary key (order_detail_id, online)
) 
SELECT 
  old_order_detail_id order_detail_id, 
  online, 
  sum(quantity) total_trainings 
FROM 
  order_reallocations 
GROUP BY 
  old_order_detail_id, 
  online</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:527</td><td>CREATE TABLE summary_event_info (
  primary key (event_id, account_id)
) 
SELECT 
  e.event_id, 
  e.academic_year_id, 
  e.order_id, 
  e.order_detail_id, 
  a.account_id, 
  max(a.is_primary) is_primary, 
  e.event_status, 
  e.event_date, 
  1 account_level, 
  e.shared_day, 
  e.shared_event_id, 
  e.online, 
  e.pd_type_id, 
  a.total_attendees total_contacts, 
  count(DISTINCT u.user_id) total_trainers, 
  0000 total_overall_attendees, 
  'C' training_type 
FROM 
  (
    events e, event_accounts a, event_users u
  ) 
WHERE 
  e.event_id = a.event_id 
  AND e.event_id = u.event_id 
  AND e.event_type_id = '".$EVENTS["training"]."' 
  AND e.status = 0 #AND e.event_status != 'X'
  " . ($refresh_orders ? " 
  AND e.order_id IN (
    " . implode(", ", $refresh_orders) . "
  ) " : "") . " 
GROUP BY 
  e.event_id, 
  a.account_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:553</td><td>CREATE TABLE summary_event_all_attendees (
  primary key (event_id)
) 
SELECT 
  event_id, 
  sum(total_contacts) total_attendees 
FROM 
  summary_event_info 
GROUP BY 
  event_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:586</td><td>CREATE TABLE summary_event_info_school (
  primary key(event_id, account_id)
) 
SELECT 
  * 
FROM 
  summary_event_info 
WHERE 
  account_level = '".$ACCOUNT_LEVEL["school"]."'</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:611</td><td>CREATE TABLE summary_min_order_dates (
  primary key (account_id, academic_year_id)
) 
SELECT 
  d.account_id, 
  d.academic_year_id, 
  min(o.order_date) order_date, 
  min(o.start_date) order_start, 
  max(o.end_date) order_end, 
  min(d.start_date) detail_start, 
  max(d.end_date) detail_end, 
  max(d.post_end) post_end 
FROM 
  summary_orders_all o, 
  summary_order_details_all d 
WHERE 
  o.order_id = d.order_id 
  AND d.academic_year_id IN (
    ".implode(", ", $academic_years)."
  ) 
  AND o.start_date > 0 
  AND d.start_date > 0 
GROUP BY 
  account_id, 
  academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:638</td><td>CREATE TABLE summary_account_trainings (
  primary key (account_id, academic_year_id)
) 
SELECT 
  account_id, 
  academic_year_id, 
  sum(total_trainings - days_removed) total_trainings 
FROM 
  summary_order_detail_info 
GROUP BY 
  account_id, 
  academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:659</td><td>CREATE TABLE summary_days_fulfilled (
  primary key (
    order_detail_id, account_id, academic_year_id, 
    online
  )
) 
SELECT 
  e.order_detail_id, 
  e.account_id, 
  e.academic_year_id, 
  e.online, 
  sum(e.total_trainers) total_fulfilled 
FROM 
  summary_event_info e, 
  summary_order_detail_info o 
WHERE 
  e.order_detail_id = o.order_detail_id 
  AND e.account_id = o.account_id 
  AND e.academic_year_id = o.academic_year_id 
  AND o.account_level != '".$ACCOUNT_LEVEL["district"]."' 
  AND (
    e.event_status IN ('S', 'C') 
    OR e.total_overall_attendees > 0
  ) 
  AND e.shared_event_id = 0 
  AND e.event_date < '$run_date' 
  AND e.is_primary = 1 
GROUP BY 
  e.order_detail_id, 
  e.account_id, 
  e.academic_year_id, 
  e.online</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:678</td><td>CREATE TABLE summary_days_fulfilled_pre (id INT AUTO_INCREMENT PRIMARY KEY) 
SELECT 
  DISTINCT e.order_detail_id, 
  o.account_id, 
  e.academic_year_id, 
  e.online, 
  e.event_id, 
  e.total_trainers 
FROM 
  summary_event_info e, 
  summary_order_detail_info o 
WHERE 
  e.order_detail_id = o.order_detail_id 
  AND o.account_level = '".$ACCOUNT_LEVEL["district"]."' 
  AND e.account_level = o.account_level 
  AND e.academic_year_id = o.academic_year_id 
  AND e.shared_event_id = 0 
  AND (
    e.event_status IN ('S', 'C') 
    OR e.total_overall_attendees > 0
  ) 
  AND e.event_date < '$run_date'</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:727</td><td>CREATE TABLE summary_days_closed (
  primary key (
    order_detail_id, account_id, academic_year_id
  )
) 
SELECT 
  order_detail_id, 
  account_id, 
  academic_year_id, 
  sum(
    if (
      deliver_status = 'S', 
      (closed_amount - we_care_amount), 
      0
    )
  ) total_satisfied, 
  sum(
    if (
      deliver_status <> 'S', closed_amount, 
      0
    )
  ) total_fulfilled, 
  sum(
    if (
      deliver_status = 'S' 
      AND sub_product_type_id IN (
        '".$SUB_PRODUCT_TYPES["initial training"]."', 
        '".$SUB_PRODUCT_TYPES["followup training"]."'
      ), 
      (closed_amount - we_care_amount), 
      0
    )
  ) total_satisfied_onsite, 
  sum(
    if (
      deliver_status <> 'S' 
      AND sub_product_type_id IN (
        '".$SUB_PRODUCT_TYPES["initial training"]."', 
        '".$SUB_PRODUCT_TYPES["followup training"]."'
      ), 
      closed_amount, 
      0
    )
  ) total_fulfilled_onsite, 
  sum(
    if (
      deliver_status = 'S' 
      AND sub_product_type_id IN (
        '".$SUB_PRODUCT_TYPES["online training"]."', 
        '".$SUB_PRODUCT_TYPES["initial online training"]."'
      ), 
      (closed_amount - we_care_amount), 
      0
    )
  ) total_satisfied_online, 
  sum(
    if (
      deliver_status <> 'S' 
      AND sub_product_type_id IN (
        '".$SUB_PRODUCT_TYPES["online training"]."', 
        '".$SUB_PRODUCT_TYPES["initial online training"]."'
      ), 
      closed_amount, 
      0
    )
  ) total_fulfilled_online 
FROM 
  closed_deliverables 
WHERE 
  academic_year_id IN (
    ".implode(", ", $academic_years)."
  ) 
  AND sub_product_type_id IN (
    '".$SUB_PRODUCT_TYPES["initial training"]."', 
    '".$SUB_PRODUCT_TYPES["followup training"]."', 
    '".$SUB_PRODUCT_TYPES["online training"]."', 
    '".$SUB_PRODUCT_TYPES["initial online training"]."'
  ) " . ($refresh_orders ? " 
  AND order_id IN (
    " . implode(", ",$refresh_orders) ."
  ) " : "") . " 
GROUP BY 
  order_detail_id, 
  account_id, 
  academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:762</td><td>CREATE TABLE summary_event_info_shared (
  primary key (event_id, account_id), 
  key(shared_event_id)
) 
SELECT 
  * 
FROM 
  summary_event_info 
WHERE 
  shared_day = 1</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:771</td><td>CREATE TABLE summary_incomplete_reallocated_shared_wcd (id INT AUTO_INCREMENT PRIMARY KEY) 
SELECT 
  e.event_id, 
  e.event_date, 
  e.order_detail_id, 
  e.academic_year_id, 
  e.online, 
  o.academic_year_id orig_academic_year_id, 
  e.account_id, 
  o.account_id orig_account_id 
FROM 
  (
    summary_event_info e, summary_order_detail_info o
  ) 
  LEFT JOIN summary_event_info_shared s ON (s.shared_event_id = e.event_id) 
WHERE 
  e.order_detail_id = o.order_detail_id 
  AND e.account_id <> o.account_id 
  AND e.academic_year_id = o.academic_year_id #AND e.event_date >= '$run_date'
  AND e.shared_day = 1 
  AND e.shared_event_id = 0 
  AND s.event_id IS NULL 
  AND e.pd_type_id in (
    '" . $PD_TYPES["we care initial"] . "', 
    '" . $PD_TYPES["we care followup"] . "'
  ) 
  AND o.account_level = '".$ACCOUNT_LEVEL["school"]."' 
  AND o.reallocated = 0</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:824</td><td>CREATE TABLE summary_incomplete_past_shared_wcd (
  INDEX (
    order_detail_id, account_id, academic_year_id, 
    online
  ), 
  id INT PRIMARY KEY AUTO_INCREMENT
) 
SELECT 
  DISTINCT e.event_id, 
  o.account_id, 
  o.order_detail_id, 
  o.academic_year_id, 
  e.online 
FROM 
  (
    summary_event_info e, summary_order_detail_info o
  ) 
  LEFT JOIN summary_incomplete_reallocated_shared_wcd r ON (r.event_id = e.event_id) 
  LEFT JOIN summary_event_info_shared s ON (s.shared_event_id = e.event_id) 
WHERE 
  e.order_detail_id = o.order_detail_id 
  AND (
    e.account_id = o.account_id 
    OR o.account_level = '".$ACCOUNT_LEVEL["district"]."'
  ) 
  AND e.academic_year_id = o.academic_year_id 
  AND e.academic_year_id < 27 
  AND e.event_date < '$run_date' 
  AND e.shared_day = 1 
  AND e.shared_event_id = 0 
  AND s.event_id IS NULL 
  AND e.pd_type_id in (
    '" . $PD_TYPES["we care initial"] . "', 
    '" . $PD_TYPES["we care followup"] . "'
  ) 
  AND r.event_id IS NULL</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:858</td><td>CREATE TABLE summary_account_fulfilled (
  primary key (account_id, academic_year_id)
) 
SELECT 
  o.account_id, 
  o.academic_year_id, 
  sum(o.total_fulfilled) total_fulfilled, 
  sum(o.expired_pd) expired_pd 
FROM 
  summary_order_detail_info o 
GROUP BY 
  o.account_id, 
  o.academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:881</td><td>CREATE TABLE summary_order_detail_info2 (
  primary key (
    order_detail_id, academic_year_id, 
    account_id
  )
) 
select 
  * 
from 
  summary_order_detail_info</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:888</td><td>CREATE TABLE summary_days_scheduled (
  id INT PRIMARY KEY AUTO_INCREMENT, 
  INDEX(
    order_detail_id, account_id, academic_year_id, 
    online
  )
) 
SELECT 
  e.order_id, 
  e.order_detail_id, 
  o.account_id, 
  e.academic_year_id, 
  e.online, 
  sum(
    if(e.shared_day = 1,.5, 1)* e.total_trainers
  ) total_scheduled 
FROM 
  (
    summary_event_info e, summary_order_detail_info o
  ) 
  LEFT JOIN summary_event_info_shared s ON (
    e.shared_event_id = s.event_id 
    and s.is_primary = 1
  ) 
  LEFT JOIN summary_order_detail_info2 o2 ON (
    e.order_detail_id = o2.order_detail_id 
    AND s.account_id = o2.account_id
  ) 
WHERE 
  e.order_detail_id = o.order_detail_id 
  AND (
    (
      e.account_id = o.account_id 
      AND o2.order_detail_id IS NULL
    ) 
    OR s.account_id = o.account_id
  ) 
  AND e.academic_year_id = o.academic_year_id 
  AND e.event_date >= '$run_date' 
  AND e.is_primary = 1 
GROUP BY 
  e.order_detail_id, 
  o.account_id, 
  e.academic_year_id, 
  e.online</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:904</td><td>CREATE TABLE summary_days_scheduled_pre (id INT AUTO_INCREMENT PRIMARY KEY) 
SELECT 
  DISTINCT e.order_id, 
  e.order_detail_id, 
  o.account_id, 
  e.academic_year_id, 
  e.online, 
  e.shared_day, 
  e.event_id, 
  e.total_trainers 
FROM 
  summary_event_info e, 
  summary_order_detail_info o 
WHERE 
  e.order_detail_id = o.order_detail_id 
  AND e.academic_year_id = o.academic_year_id 
  AND o.account_level = '".$ACCOUNT_LEVEL["district"]."' 
  AND o.account_level = e.account_level 
  AND e.event_date >= '$run_date'</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:952</td><td>CREATE TABLE summary_account_scheduled (
  primary key (account_id, academic_year_id)
) 
SELECT 
  o.account_id, 
  o.academic_year_id, 
  sum(o.total_scheduled) total_scheduled 
FROM 
  summary_order_detail_info o 
GROUP BY 
  o.account_id, 
  o.academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:973</td><td>CREATE TABLE summary_district_centralized (
  primary key (
    account_id, academic_year_id, order_id, 
    order_detail_id
  )
) 
SELECT 
  o.account_id, 
  o.academic_year_id, 
  o.order_id, 
  o.order_detail_id, 
  o.expansion_order_id, 
  sum(
    o.total_trainings - o.total_fulfilled - o.days_removed
  ) total_centralized, 
  sum(
    (
      o.total_initial_pd + o.total_followup_pd
    )- o.fulfilled_onsite_pd - o.days_removed
  ) total_onsite_centralized, 
  sum(
    (
      o.total_initial_online_pd + o.total_online_pd
    )- o.fulfilled_online_pd
  ) total_online_centralized, 
  sum(o.total_trainings) total_trainings, 
  sum(o.total_fulfilled) total_fulfilled, 
  sum(o.fulfilled_onsite_pd) fulfilled_onsite_pd, 
  sum(o.fulfilled_online_pd) fulfilled_online_pd, 
  sum(o.total_scheduled) total_scheduled, 
  sum(o.scheduled_onsite_pd) scheduled_onsite_pd, 
  sum(o.scheduled_online_pd) scheduled_online_pd, 
  sum(o.expired_pd) expired_pd, 
  sum(o.expired_onsite_pd) expired_onsite_pd, 
  sum(o.expired_online_pd) expired_online_pd 
FROM 
  summary_order_detail_info o 
WHERE 
  o.account_level = '".$ACCOUNT_LEVEL["district"]."' 
GROUP BY 
  o.account_id, 
  o.academic_year_id, 
  o.order_id, 
  o.order_detail_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1012</td><td>CREATE TABLE summary_account_centralized (id INT AUTO_INCREMENT PRIMARY KEY) 
SELECT 
  d.account_id, 
  o.academic_year_id, 
  o.order_id, 
  o.order_detail_id, 
  o.account_id owning_account_id, 
  o.total_centralized, 
  o.total_onsite_centralized, 
  o.total_online_centralized, 
  o.total_trainings, 
  o.total_fulfilled, 
  o.total_scheduled, 
  o.scheduled_onsite_pd, 
  o.scheduled_online_pd, 
  o.expired_pd, 
  o.expired_onsite_pd, 
  o.expired_online_pd 
FROM 
  (
    summary_district_centralized o, summary_order_details_all d
  ) 
WHERE 
  (o.order_id = d.order_id) 
  AND o.account_id != d.account_id 
  AND d.account_level = '2' 
  AND o.academic_year_id = d.academic_year_id 
UNION 
SELECT 
  d.account_id, 
  o.academic_year_id, 
  o.order_id, 
  o.order_detail_id, 
  o.account_id owning_account_id, 
  o.total_centralized, 
  o.total_onsite_centralized, 
  o.total_online_centralized, 
  o.total_trainings, 
  o.total_fulfilled, 
  o.total_scheduled, 
  o.scheduled_onsite_pd, 
  o.scheduled_online_pd, 
  o.expired_pd, 
  o.expired_onsite_pd, 
  o.expired_online_pd 
FROM 
  (
    summary_district_centralized2 o, 
    summary_order_details_all2 d
  ) 
  LEFT JOIN summary_order_detail_info e ON (
    o.order_id = e.expansion_order_id
  ) 
WHERE 
  (e.order_id = d.order_id) 
  AND o.account_id != d.account_id 
  AND d.account_level = '2' 
  AND o.academic_year_id = d.academic_year_id;</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1061</td><td>CREATE TABLE summary_order_detail_info_expansion (
  id INT AUTO_INCREMENT PRIMARY KEY, 
  key(order_id), 
  key(expansion_order_id)
) 
SELECT 
  * 
FROM 
  summary_order_detail_info 
WHERE 
  expansion_order_id > 0</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1086</td><td>CREATE TABLE summary_child_account_centralized (id INT AUTO_INCREMENT PRIMARY KEY) 
SELECT 
  DISTINCT a.account_id, 
  i.academic_year_id, 
  i.order_id, 
  i.order_detail_id, 
  i.account_id owning_account_id, 
  i.total_centralized, 
  i.total_onsite_centralized, 
  i.total_online_centralized, 
  i.total_trainings, 
  i.total_fulfilled, 
  i.total_scheduled, 
  i.scheduled_onsite_pd, 
  i.scheduled_online_pd, 
  i.expired_pd, 
  i.expired_onsite_pd, 
  i.expired_online_pd 
FROM 
  (
    summary_district_centralized i, accounts a, 
    " . ($refresh_orders ? " orders o, 
    order_details d " : " summary_orders_all o, 
    summary_order_details_all d ") . "
  ) 
  LEFT JOIN summary_account_centralized c ON (
    a.account_id = c.account_id 
    AND i.order_id = c.order_id 
    AND i.order_detail_id = c.order_detail_id
  ) 
WHERE 
  i.account_id = a.parent_account_id 
  AND a.account_id = d.account_id 
  AND d.order_id = o.order_id 
  AND i.academic_year_id = d.academic_year_id 
  AND c.account_id IS NULL " . ($refresh_orders ? " 
  AND o.status = 0 
  AND d.status = 0 
  AND d.academic_year_id > 0 " : "")</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1117</td><td>CREATE TABLE summary_account_centralized2 (
  primary key (account_id, academic_year_id)
) 
SELECT 
  account_id, 
  academic_year_id, 
  sum(total_centralized) total_centralized, 
  sum(total_scheduled) total_scheduled 
FROM 
  summary_account_centralized 
GROUP BY 
  account_id, 
  academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1137</td><td>CREATE TABLE summary_dedicated_events (
  primary key (event_id)
) 
SELECT 
  e.event_id, 
  e.event_date, 
  count(DISTINCT e.account_id) total_accounts 
FROM 
  summary_event_info e, 
  summary_order_detail_info o 
WHERE 
  e.order_detail_id = o.order_detail_id 
GROUP BY 
  e.event_id 
HAVING 
  (
    count(DISTINCT e.account_id) < 2 
    OR (
      count(DISTINCT e.account_id) = 2 
      AND min(e.total_contacts) <= 2 
      AND min(o.account_level) != '".$ACCOUNT_LEVEL["district"]."'
    )
  )</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1162</td><td>CREATE TABLE summary_account_dedicated_pd (
  primary key (account_id, academic_year_id)
) 
SELECT 
  account_id, 
  academic_year_id, 
  count(DISTINCT event_id) total_dedicated 
FROM 
  summary_event_info 
WHERE 
  training_type = 'D' 
  AND (
    event_status IN ('C', 'S') 
    OR total_overall_attendees > 0
  ) 
  AND event_date < '$run_date' 
  AND academic_year_id IN (
    ".implode(", ", $academic_years)."
  ) 
GROUP BY 
  account_id, 
  academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1185</td><td>CREATE TABLE summary_account_centralized_pd (
  primary key (account_id, academic_year_id)
) 
SELECT 
  account_id, 
  academic_year_id, 
  count(DISTINCT event_id) total_centralized 
FROM 
  summary_event_info e 
WHERE 
  training_type IN ('C') 
  AND (
    event_status IN ('S', 'C') 
    OR total_overall_attendees > 0
  ) 
  AND event_date < '$run_date' 
GROUP BY 
  account_id, 
  academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1207</td><td>CREATE TABLE summary_account_last_trainings (
  primary key (account_id, academic_year_id)
) 
SELECT 
  e.account_id, 
  e.academic_year_id, 
  max(e.event_date) event_date, 
  substring_index(
    max(
      concat(e.event_date, '|', u.event_id)
    ), 
    '|', 
    -1
  ) event_id, 
  substring_index(
    max(
      concat(e.event_date, '|', u.user_id)
    ), 
    '|', 
    -1
  ) user_id, 
  min(e.event_date) first_training 
FROM 
  summary_event_info e, 
  event_users u 
WHERE 
  e.event_id = u.event_id 
  AND e.academic_year_id IN (
    ".implode(", ", $academic_years)."
  ) 
  AND (
    e.event_status IN ('S', 'C') 
    OR e.total_overall_attendees > 0
  ) 
  AND e.event_date < '$run_date' 
GROUP BY 
  e.account_id, 
  e.academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1239</td><td>CREATE TABLE summary_account_next_trainings (
  primary key (account_id, academic_year_id)
) 
SELECT 
  e.account_id, 
  e.academic_year_id, 
  min(e.event_date) event_date, 
  substring_index(
    min(
      concat(e.event_date, '|', u.user_id)
    ), 
    '|', 
    -1
  ) user_id 
FROM 
  summary_event_info e, 
  event_users u 
WHERE 
  e.event_id = u.event_id 
  AND e.academic_year_id IN (
    ".implode(", ", $academic_years)."
  ) 
  AND e.event_date >= '$run_date' 
GROUP BY 
  e.account_id, 
  e.academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1265</td><td>CREATE TABLE summary_data_setup (
  primary key (account_id, academic_year_id)
) 
SELECT 
  account_id, 
  academic_year_id, 
  max(date_entered) last_data_upload, 
  substring_index(
    max(
      concat(date_entered, '|', data_status)
    ), 
    '|', 
    -1
  ) data_status, 
  substring_index(
    max(
      concat(
        date_entered, '|', total_students
      )
    ), 
    '|', 
    -1
  ) last_uploaded_students, 
  sum(total_students) total_students, 
  sum(total_teachers) total_teachers, 
  min(student_ids) student_ids 
FROM 
  data_setup 
WHERE 
  academic_year_id IN (
    ".implode(", ", $academic_years)."
  ) 
GROUP BY 
  account_id, 
  academic_year_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1297</td><td>CREATE TABLE summary_low_usage (
  primary key (account_id, academic_year_id)
) 
SELECT 
  u.account_id, 
  u.academic_year_id, 
  1 low_usage 
FROM 
  account_usage u 
WHERE 
  week_date BETWEEN '".date("Y-m-d", $four_week_start)."' 
  AND '$run_date' 
GROUP BY 
  u.account_id, 
  u.academic_year_id 
HAVING 
  AVG(
    mc_students / associated_students
  ) <.05 
  AND COUNT(week_date) = 4</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1310</td><td>CREATE TABLE summary_customer_since (
  primary key (account_id, customer_since)
) 
SELECT 
  d.account_id, 
  min(d.start_date) customer_since 
FROM 
  summary_order_details_all d, 
  accounts a 
WHERE 
  d.account_id = a.account_id 
  AND (
    a.account_level = '".$ACCOUNT_LEVEL["school"]."' 
    OR a.parent_account_id > 0
  ) 
  AND d.academic_year_id > 0 
GROUP BY 
  d.account_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1350</td><td>CREATE TABLE summary_customer_since_pre (
  primary key (account_id, customer_since)
) 
SELECT 
  o.account_id, 
  min(o.start_date) customer_since 
FROM 
  summary_orders_all o, 
  accounts a 
WHERE 
  o.account_id = a.account_id 
  AND a.account_level = '".$ACCOUNT_LEVEL["district"]."' 
GROUP BY 
  o.account_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1383</td><td>CREATE TABLE summary_customer_since_children(
  primary key (account_id)
) 
SELECT 
  account_id, 
  min(customer_since) customer_since 
FROM 
  summary_customer_since 
GROUP BY 
  account_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1414</td><td>CREATE TABLE summary_customer_since_all(
  PRIMARY KEY (account_id)
) ENGINE = InnoDB 
SELECT 
  account_id, 
  min(customer_since) customer_since 
FROM 
  summary_customer_since 
GROUP BY 
  account_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1459</td><td>CREATE TABLE summary_training_request_info (id INT AUTO_INCREMENT PRIMARY KEY) 
SELECT 
  t.account_id, 
  t.contact_id, 
  t.user_id, 
  t.deferral, 
  t.academic_year_id, 
  d.start_date, 
  if(
    d.end_date = 0, d.start_date, d.end_date
  ) end_date 
FROM 
  training_requests t, 
  training_request_dates d 
WHERE 
  t.training_request_id = d.training_request_id 
  AND t.event_id = 0 
  AND t.academic_year_id IN (
    ".implode(", ", $academic_years)."
  )</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1477</td><td>CREATE TABLE summary_deferred_trainings (
  PRIMARY KEY (account_id, academic_year_id)
) 
SELECT 
  account_id, 
  academic_year_id, 
  min(start_date) start_date 
FROM 
  summary_training_request_info 
WHERE 
  start_date >= curdate() 
GROUP BY 
  account_id, 
  academic_year_id 
HAVING 
  substring_index(
    min(
      concat(start_date, '|', deferral)
    ), 
    '|', 
    -1
  ) = 1</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1753</td><td>CREATE TABLE summary_customer_status_pre (
  PRIMARY KEY (account_id)
) 
SELECT 
  a.parent_account_id account_id, 
  min(c.status_rank) status_rank, 
  substring_index(
    min(
      concat(
        c.status_rank, '|', c.customer_status
      )
    ), 
    '|', 
    -1
  ) customer_status 
FROM 
  (
    accounts a, summary_customer_status c
  ) 
  LEFT JOIN accounts b ON b.parent_account_id = a.account_id 
WHERE 
  c.account_id IN(b.account_id, a.account_id) 
GROUP BY 
  a.parent_account_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1776</td><td>CREATE TABLE summary_account_acv (
  KEY(account_id), 
  id INT AUTO_INCREMENT PRIMARY KEY
) 
SELECT 
  DISTINCT account_id, 
  year, 
  report_type_id, 
  is_summer_dates_extended, 
  current_acv 
FROM 
  annual_retention_metric_summary 
WHERE 
  year >= (
    year(now()) -1
  ) 
  AND report_type_id IN (1, 2) 
  AND current_acv IS NOT NULL</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1895</td><td>CREATE TABLE summary_imp_start_details(
  KEY(account_id, ay_year), 
  id INT AUTO_INCREMENT PRIMARY KEY
) 
SELECT 
  DISTINCT a.account_id, 
  a.parent_account_id, 
  od.order_detail_id, 
  DATE(
    GREATEST(od.start_date, od.date_entered)
  ) imp_start, 
  YEAR(ay.end_date) ay_year 
FROM 
  academic_years ay STRAIGHT_JOIN order_details od ON (
    ay.academic_year_id = od.academic_year_id
  ) 
  JOIN accounts a USING(account_id) 
  JOIN orders o USING (order_id) 
WHERE 
  od.status = 0 
  AND o.status = 0 
  AND a.account_level = 2 
  AND CURDATE() >= ay.start_date</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1919</td><td>CREATE TABLE summary_imp_start_details_edits(
  PRIMARY KEY(account_id)
) 
SELECT 
  account_id, 
  DATE(
    MAX(h.date_entered)
  ) change_date 
FROM 
  history_log h 
  JOIN summary_imp_start_details ON record_id = order_detail_id 
  AND new_value = account_id 
WHERE 
  table_name = 'order_details' 
  AND column_name = 'account_id' 
  AND old_value <> new_value 
GROUP BY 
  account_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1941</td><td>CREATE TABLE summary_imp_start_by_year(
  PRIMARY KEY(account_id, ay_year)
) 
SELECT 
  account_id, 
  parent_account_id, 
  imp_start, 
  ay_year 
FROM 
  summary_imp_start_details 
GROUP BY 
  account_id, 
  ay_year</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:1955</td><td>CREATE TABLE summary_imp_start(
  KEY(account_id, ay_year), 
  id INT AUTO_INCREMENT PRIMARY KEY
) 
SELECT 
  account_id, 
  parent_account_id, 
  imp_start, 
  ay_year 
FROM 
  summary_imp_start_by_year 
  JOIN (
    SELECT 
      account_id, 
      MAX(ay_year) ay_year 
    FROM 
      summary_imp_start_by_year 
    GROUP BY 
      account_id
  ) b USING(account_id, ay_year)</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:2266</td><td>CREATE TABLE account_order_counts_pre_cancel_table (
  PRIMARY KEY (
    `account_id`, `academic_year_id`, 
    `order_detail_id`, `reallocated`
  ), 
  KEY(order_id, order_detail_id), 
  KEY(order_detail_id)
) 
SELECT 
  aos.order_id, 
  aos.account_id, 
  aos.academic_year_id, 
  aos.order_detail_id, 
  0 status, 
  aos.student_licenses, 
  aos.purchased_pd, 
  aos.initial_purchased_pd, 
  aos.followup_purchased_pd, 
  aos.initial_online_purchased_pd, 
  aos.online_purchased_pd, 
  aos.reallocated 
FROM 
  account_order_summary aos 
  INNER JOIN order_details od ON (
    aos.order_detail_id = od.order_detail_id
  ) 
  INNER JOIN orders o ON (aos.order_id = o.order_id) 
WHERE 
  od.status = 0 
  AND o.status = 0 
UNION 
SELECT 
  aos.order_id, 
  aos.account_id, 
  aos.academic_year_id, 
  aos.order_detail_id, 
  1 status, 
  aos.student_licenses, 
  aos.purchased_pd, 
  aos.initial_purchased_pd, 
  aos.followup_purchased_pd, 
  aos.initial_online_purchased_pd, 
  aos.online_purchased_pd, 
  aos.reallocated 
FROM 
  account_order_counts_pre_cancel aos 
  INNER JOIN order_details od ON (
    aos.order_detail_id = od.order_detail_id
  ) 
  INNER JOIN orders o ON (aos.order_id = o.order_id) 
WHERE 
  (
    od.status = 1 
    OR o.status = 1
  )</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:2377</td><td>CREATE TABLE summary_order_info (
  PRIMARY KEY (order_id)
) 
SELECT 
  o.order_id, 
  sum(
    od.quantity * if(
      odsp.order_id, odsp.sub_product_qty, 
      sp.sub_product_qty
    )
  ) total_trainings, 
  sum(
    if(
      if(
        odsp.order_id, odsp.sub_product_type_id, 
        sp.sub_product_type_id
      ) IN (
        ".$SUB_PRODUCT_TYPES[" initial training "].", 
        ".$SUB_PRODUCT_TYPES[" trainer training "]."
      ), 
      (
        od.quantity * if(
          odsp.order_id, odsp.sub_product_qty, 
          sp.sub_product_qty
        )
      ), 
      0
    )
  ) total_initial_pd, 
  sum(
    if(
      if(
        odsp.order_id, odsp.sub_product_type_id, 
        sp.sub_product_type_id
      ) IN (
        ".$SUB_PRODUCT_TYPES[" followup training "]."
      ), 
      (
        od.quantity * if(
          odsp.order_id, odsp.sub_product_qty, 
          sp.sub_product_qty
        )
      ), 
      0
    )
  ) total_followup_pd, 
  sum(
    if(
      if(
        odsp.order_id, odsp.sub_product_type_id, 
        sp.sub_product_type_id
      ) IN (
        ".$SUB_PRODUCT_TYPES[" initial online training "]."
      ), 
      (
        od.quantity * if(
          odsp.order_id, odsp.sub_product_qty, 
          sp.sub_product_qty
        )
      ), 
      0
    )
  ) total_initial_online_pd, 
  sum(
    if(
      if(
        odsp.order_id, odsp.sub_product_type_id, 
        sp.sub_product_type_id
      ) IN (
        ".$SUB_PRODUCT_TYPES[" online training "]."
      ), 
      (
        od.quantity * if(
          odsp.order_id, odsp.sub_product_qty, 
          sp.sub_product_qty
        )
      ), 
      0
    )
  ) total_online_pd 
FROM 
  (
    summary_orders_all o, summary_order_details_all od
  ) 
  left join order_detail_sub_products_use odspu on (o.order_id = odspu.order_id) 
  left join order_detail_sub_products odsp on (
    od.order_detail_id = odsp.order_detail_id
  ) 
  left join sub_products sp on (
    od.product_id = sp.product_id 
    and sp.status = 0 
    and odspu.order_id is null
  ) 
  left join sub_product_types spt on (
    spt.sub_product_type_id in (
      odsp.sub_product_type_id, sp.sub_product_type_id
    )
  ) 
WHERE 
  o.order_id = od.order_id 
  AND spt.pd_deliverable = 'Y' 
GROUP BY 
  o.order_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:2408</td><td>CREATE TABLE summary_reallocated_data (
  PRIMARY KEY (order_id)
) 
SELECT 
  old_order_id order_id, 
  sum(quantity) reallocated_pd 
FROM 
  order_reallocations 
WHERE 
  old_order_id <> new_order_id 
GROUP BY 
  old_order_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:2425</td><td>CREATE TABLE summary_reallocated_breakdown_data (
  PRIMARY KEY (order_id)
) 
SELECT 
  r.old_order_id order_id, 
  count(
    DISTINCT if (
      e.event_date >= curdate(), 
      e.event_id, 
      null
    )
  ) scheduled_reallocated_pd, 
  count(
    DISTINCT if (
      e.event_date < curdate(), 
      e.event_id, 
      null
    )
  ) fulfilled_reallocated_pd 
FROM 
  order_reallocations r, 
  summary_event_info e 
WHERE 
  r.old_order_id <> r.new_order_id 
  AND e.account_id = r.new_account_id 
  AND e.order_id = r.old_order_id 
  AND e.is_primary = 1 
  AND e.shared_event_id = 0 
  AND r.new_academic_year_id = e.academic_year_id 
GROUP BY 
  r.old_order_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:2451</td><td>CREATE TABLE summary_days_scheduled_pre (id INT AUTO_INCREMENT PRIMARY KEY) 
SELECT 
  DISTINCT e.order_id, 
  e.event_id, 
  e.shared_day, 
  e.total_trainers, 
  e.online 
FROM 
  summary_event_info e 
WHERE 
  e.event_date >= '$run_date'</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:2461</td><td>CREATE TABLE summary_days_scheduled (
  PRIMARY KEY (order_id)
) 
SELECT 
  e.order_id, 
  SUM(
    if(e.shared_day = 1,.5, 1)* e.total_trainers
  ) total_scheduled, 
  SUM(
    if(
      e.online = 'N', 
      if(e.shared_day = 1,.5, 1)* e.total_trainers, 
      0
    )
  ) total_onsite_scheduled, 
  SUM(
    if(
      e.online = 'Y', 
      if(e.shared_day = 1,.5, 1)* e.total_trainers, 
      0
    )
  ) total_online_scheduled 
FROM 
  summary_days_scheduled_pre e 
GROUP BY 
  e.order_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:2482</td><td>CREATE TABLE summary_days_fulfilled_pre (id INT AUTO_INCREMENT PRIMARY KEY) 
SELECT 
  DISTINCT e.order_id, 
  e.event_id, 
  e.total_trainers, 
  e.online 
FROM 
  summary_event_info e 
WHERE 
  (
    e.event_status IN ('S', 'C') 
    OR e.total_overall_attendees > 0
  ) 
  AND e.event_date < '$run_date' 
  AND e.shared_event_id = 0</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:2494</td><td>CREATE TABLE summary_days_fulfilled (
  PRIMARY KEY (order_id)
) 
SELECT 
  e.order_id, 
  SUM(e.total_trainers) total_fulfilled, 
  SUM(
    if(
      e.online = 'N', e.total_trainers, 0
    )
  ) total_onsite_fulfilled, 
  SUM(
    if(
      e.online = 'Y', e.total_trainers, 0
    )
  ) total_online_fulfilled 
FROM 
  summary_days_fulfilled_pre e 
GROUP BY 
  e.order_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:2515</td><td>CREATE TABLE summary_days_closed (
  PRIMARY KEY (order_id)
) 
SELECT 
  cd.order_id, 
  sum(
    if (
      cd.deliver_status = 'S', 
      (
        cd.closed_amount - cd.we_care_amount
      ), 
      0
    )
  ) total_satisfied, 
  sum(
    if (
      cd.deliver_status = 'S' 
      AND cd.sub_product_type_id IN (
        '".$SUB_PRODUCT_TYPES["initial training"]."', 
        '".$SUB_PRODUCT_TYPES["followup training"]."'
      ), 
      (
        cd.closed_amount - cd.we_care_amount
      ), 
      0
    )
  ) total_onsite_satisfied, 
  sum(
    if (
      cd.deliver_status = 'S' 
      AND cd.sub_product_type_id IN (
        '".$SUB_PRODUCT_TYPES["online training"]."', 
        '".$SUB_PRODUCT_TYPES["initial online training"]."'
      ), 
      (
        cd.closed_amount - cd.we_care_amount
      ), 
      0
    )
  ) total_online_satisfied, 
  sum(
    if (
      cd.deliver_status = 'S' 
      AND cd.sub_product_type_id IN (
        '".$SUB_PRODUCT_TYPES["initial training"]."', 
        '".$SUB_PRODUCT_TYPES["followup training"]."'
      ) 
      AND curdate() <= od.end_date, 
      (
        cd.closed_amount - cd.we_care_amount
      ), 
      0
    )
  ) total_onsite_satisfied_avail, 
  sum(
    if (
      cd.deliver_status = 'S' 
      AND cd.sub_product_type_id IN (
        '".$SUB_PRODUCT_TYPES["online training"]."', 
        '".$SUB_PRODUCT_TYPES["initial online training"]."'
      ) 
      AND curdate() <= od.end_date, 
      (
        cd.closed_amount - cd.we_care_amount
      ), 
      0
    )
  ) total_online_satisfied_avail, 
  sum(
    if (
      cd.deliver_status <> 'S', cd.closed_amount, 
      0
    )
  ) total_fulfilled, 
  sum(
    if (
      cd.deliver_status <> 'S' 
      AND cd.sub_product_type_id IN (
        '".$SUB_PRODUCT_TYPES["initial training"]."', 
        '".$SUB_PRODUCT_TYPES["followup training"]."'
      ), 
      (
        cd.closed_amount - cd.we_care_amount
      ), 
      0
    )
  ) total_onsite_fulfilled, 
  sum(
    if (
      cd.deliver_status <> 'S' 
      AND cd.sub_product_type_id IN (
        '".$SUB_PRODUCT_TYPES["online training"]."', 
        '".$SUB_PRODUCT_TYPES["initial online training"]."'
      ), 
      (
        cd.closed_amount - cd.we_care_amount
      ), 
      0
    )
  ) total_online_fulfilled 
FROM 
  closed_deliverables cd, 
  order_details od 
WHERE 
  od.order_detail_id = cd.order_detail_id 
  AND cd.sub_product_type_id IN (
    '".$SUB_PRODUCT_TYPES["initial training"]."', 
    '".$SUB_PRODUCT_TYPES["followup training"]."', 
    '".$SUB_PRODUCT_TYPES["online training"]."', 
    '".$SUB_PRODUCT_TYPES["initial online training"]."'
  ) " . ($refresh_orders ? " 
  AND cd.order_id IN (
    " . implode(", ", $refresh_orders) . "
  ) " : "") . " 
GROUP BY 
  cd.order_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:2555</td><td>CREATE TEMPORARY TABLE order_summary_refresh_orders (
  PRIMARY KEY(order_id)
) 
SELECT 
  * 
FROM 
  order_summary 
WHERE 
  order_id IN (
    " . implode(", ", $refresh_orders) . "
  )</td><td></td><td>skip</td></tr>
   <tr><td>cron/summary/populate_tables.inc:2567</td><td>CREATE TABLE interlink.order_summary_backup (
  PRIMARY KEY(order_id)
) 
SELECT 
  * 
FROM 
  order_summary;</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:2618</td><td>CREATE TABLE summary_updated_order_totals (
  primary key (opportunity_id)
) 
SELECT 
  p.opportunity_id, 
  p.total old_total, 
  os.order_total - SUM(
    IF (
      oc.cancel_id IS NOT NULL, oc.credit_amount, 
      0
    )
  ) new_total 
FROM 
  (opportunities p, order_summary os) 
  LEFT JOIN order_cancels oc ON (os.order_id = oc.order_id) 
WHERE 
  os.order_id = p.order_id 
GROUP BY 
  p.opportunity_id 
HAVING 
  old_total <> new_total</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:2679</td><td>CREATE TABLE interlink.order_summary_backup (
  PRIMARY KEY(order_id)
) 
SELECT 
  * 
FROM 
  order_summary;</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:2684</td><td>CREATE TEMPORARY TABLE tmp_order_totals (
  PRIMARY KEY (order_id)
) 
SELECT 
  o.order_id, 
  sum(d.quantity * d.price) order_total 
FROM 
  orders o, 
  order_details d 
WHERE 
  o.order_id = d.order_id 
  AND o.draft = 0 
  AND d.status IN (0, 1) " . ($refresh_orders ? " 
  AND o.order_id IN (
    " . implode(", ", $refresh_orders) . "
  ) " : "") . " 
GROUP BY 
  o.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>cron/summary/populate_tables.inc:2732</td><td>CREATE TABLE orders_regenerate_new_renew (
  PRIMARY KEY (order_id)
) 
SELECT 
  od.order_id, 
  o.order_date, 
  os.order_total, 
  os.sales_tax, 
  os.new_total, 
  os.renew_total, 
  osb.order_total backup_order_total, 
  SUM(od.quantity * price) interlink_order_detail_total, 
  SUM(
    line_list_price + pro_rated_fees + pro_rated_discounts
  ) detail_total, 
  SUM(
    (
      line_list_price + pro_rated_fees + pro_rated_discounts
    )* CASE WHEN detail_override.order_id IS NOT NULL THEN detail_override.new_percent WHEN comm_override.order_id IS NOT NULL THEN comm_override.new_total /(
      comm_override.new_total + comm_override.renew_total
    ) WHEN order_renewal_status = 'new' THEN 1 ELSE 0 END
  ) detail_new_total, 
  SUM(
    (
      line_list_price + pro_rated_fees + pro_rated_discounts
    )* CASE WHEN detail_override.order_id IS NOT NULL THEN detail_override.renew_percent WHEN comm_override.order_id IS NOT NULL THEN comm_override.renew_total /(
      comm_override.new_total + comm_override.renew_total
    ) WHEN order_renewal_status = 'renewal' THEN 1 ELSE 0 END
  ) detail_renew_total, 
  MAX(
    CASE WHEN detail_override.order_id IS NOT NULL 
    AND detail_override.system_generated = 0 THEN 1 ELSE 0 END
  ) has_overrides, 
  comm_override.order_id override_order_id, 
  CASE WHEN YEAR(o.order_date)>= $fiscal_year THEN 1 ELSE 0 END is_current_fiscal_year, 
  MAX(
    detail_override.system_generated
  ) detail_override_system_generated 
FROM 
  interlink.order_details od 
  INNER JOIN interlink.orders o ON o.order_id = od.order_id 
  INNER JOIN interlink.order_summary os ON od.order_id = os.order_id 
  LEFT JOIN interlink.order_summary_backup osb ON osb.order_id = od.order_id 
  LEFT JOIN interlink.order_new_renewal_data rn ON rn.order_detail_id = od.order_detail_id 
  LEFT JOIN commissions.v_qc_overrides comm_override ON (
    rn.order_Id = comm_override.order_id 
    AND ABS(
      (
        comm_override.new_total + comm_override.renew_total
      )-(os.order_total - os.sales_tax)
    ) < 2
  ) 
  LEFT JOIN interlink.order_detail_new_renew_overrides detail_override ON (
    rn.order_id = detail_override.order_id 
    AND rn.order_detail_id = detail_override.order_detail_id
  ) 
WHERE 
  o.order_date >= '2010-01-01' 
  AND os.order_total <> 0 
GROUP BY 
  od.order_id 
HAVING 
  abs(
    order_total - sales_tax - detail_total
  )> 2 
  OR ABS(new_total - detail_new_total)> 2 
  OR ABS(renew_total - detail_renew_total)> 2;</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:2947</td><td>CREATE TABLE tmp_nr_replacement_run_year(
  PRIMARY KEY(run_year)
) 
SELECT 
  $run_year run_year</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:2991</td><td>CREATE TABLE tmp_cmr_smry_order_sales_rep (
  PRIMARY KEY (order_id)
) 
SELECT 
  o.order_id, 
  MAX(
    COALESCE(
      uos.user_id, uo.user_id, uoa.user_id
    )
  ) user_id 
FROM 
  interlink.orders o 
  LEFT JOIN interlink.user_orders_lock uos ON uos.order_id = o.order_id 
  AND uos.role_id = 6 
  LEFT JOIN interlink.user_orders uo ON uo.order_id = o.order_id 
  AND uo.role_id = 6 
  LEFT JOIN interlink.user_orders_lock uoa ON uoa.order_id = o.order_id 
  AND uoa.role_id = 31 
GROUP BY 
  o.order_id;</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:3038</td><td>CREATE TABLE interlink.mh_orders_table (
  PRIMARY KEY (order_id), 
  INDEX(
    order_id, is_post_integration_order
  )
) 
SELECT 
  o.order_id, 
  o.order_date, 
  os.order_total, 
  CASE WHEN uol_mh.order_id 
  OR uo_mh.order_id THEN 1 ELSE 0 END is_pre_integration_order, 
  CASE WHEN o.mh_order_id IS NOT NULL THEN 1 ELSE 0 END is_post_integration_order 
FROM 
  interlink.orders o 
  INNER JOIN interlink.order_summary os ON os.order_id = o.order_id 
  LEFT JOIN interlink.user_orders_lock uol_mh ON uol_mh.order_id = o.order_id 
  AND uol_mh.role_id = 6 
  AND uol_mh.user_id = 2238 
  LEFT JOIN interlink.user_orders uo_mh ON uo_mh.order_id = o.order_id 
  AND uo_mh.role_id = 6 
  AND uo_mh.user_id = 2238 
WHERE 
  1 
  AND (
    (
      o.mh_order_id IS NOT NULL 
      AND IFNULL(
        TRIM(o.mh_order_id), 
        '0'
      ) NOT IN ('', '0')
    ) 
    OR uol_mh.order_id IS NOT NULL 
    OR uo_mh.order_id IS NOT NULL
  ) 
GROUP BY 
  o.order_id;</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:3077</td><td>CREATE TEMPORARY TABLE tmp_list_prices(
  primary KEY(product_id)
) 
SELECT 
  a.product_id, 
  SUM(list_price * sub_product_qty) list_price 
FROM 
  sub_products a 
WHERE 
  a.status = 0 
GROUP BY 
  a.product_id;</td><td></td><td>skip</td></tr>
   <tr><td>cron/summary/populate_tables.inc:3121</td><td>CREATE TABLE summary_order_detail_expiration_tmp (id INT AUTO_INCREMENT PRIMARY KEY) 
SELECT 
  od.order_detail_id, 
  LEAST(
    CASE WHEN MONTH(od.start_date)= 8 
    OR (
      MONTH(od.start_date)= 9 
      AND DAY(od.start_date)< 5
    ) THEN date_add(od.start_date, INTERVAL 91 DAY) ELSE date_add(od.start_date, INTERVAL 61 DAY) END, 
    GREATEST(o.order_date, od.end_date)
  ) expire_date 
FROM 
  orders o, 
  order_details od, 
  account_order_summary aos, 
  academic_years ay 
WHERE 
  aos.order_id = o.order_id 
  AND od.order_detail_id = aos.order_detail_id 
  AND ay.academic_year_id = od.academic_year_id 
  AND (
    aos.initial_purchased_pd > 0 
    OR initial_online_purchased_pd > 0
  )</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:3140</td><td>CREATE TABLE summary_order_detail_expiration (id INT AUTO_INCREMENT PRIMARY KEY) 
SELECT 
  * 
FROM 
  summary_order_detail_expiration_tmp</td><td></td><td></td></tr>
   <tr><td>cron/summary/populate_tables.inc:3158</td><td>CREATE TEMPORARY TABLE update_user_orders_order_id(
  PRIMARY KEY(record_id)
) ENGINE = InnoDB 
SELECT 
  uo.user_order_id record_id, 
  'user_orders' table_name, 
  'order_id' column_name, 
  uo.order_id old_value, 
  p.order_id new_value, 
  'updating user_orders.order_id to match the opportunities order_id via cron' notes, 
  '".$USERS["system_generated"]."' entered_by, 
  NOW() date_entered 
FROM 
  interlink.user_orders uo 
  INNER JOIN interlink.opportunities p ON uo.opportunity_id = p.opportunity_id 
  INNER JOIN interlink.orders o ON p.order_id = o.order_id 
WHERE 
  uo.opportunity_id > 0 
  AND uo.user_id > 0 
  AND uo.order_id = 0</td><td></td><td>skip</td></tr>
   <tr><td>cron/summary/populate_tables.inc:3186</td><td>CREATE TABLE summary_ultimate_parent_account(
  PRIMARY KEY(account_id), 
  KEY(ultimate_parent_account_id)
) 
SELECT 
  a.account_id, 
  a.account_level, 
  b.account_id parent_account_id, 
  b.account_level parent_account_level, 
  b.account_id ultimate_parent_account_id 
FROM 
  accounts a 
  LEFT JOIN accounts b ON a.parent_account_id = b.account_id;</td><td></td><td></td></tr>
   <tr><td>orders/tabs/orders.php:100</td><td>CREATE TEMPORARY TABLE tmp_program_licenses (
  primary key(order_id, program_id), 
  key(program_id)
) 
SELECT 
  aos.order_id, 
  p.program_id, 
  SUM(
    IF(
      p.program_id = ".SMARTY_ANTS_PROGRAM." 
      AND aos.student_licenses = '9999', 
      NULL, 
      aos.student_licenses
    )
  ) student_licenses, 
  MAX(
    IF(
      p.program_id = ".SMARTY_ANTS_PROGRAM." 
      AND aos.student_licenses = '9999', 
      1, 
      0
    )
  ) unlimited 
FROM 
  account_order_summary aos 
  JOIN order_details od ON od.order_detail_id = aos.order_detail_id 
  JOIN products p ON p.product_id = od.product_id 
WHERE 
  od.order_id IN (
    ".implode(", ", array_unique($orders))."
  ) 
  AND aos.student_licenses > 0 
GROUP BY 
  aos.order_id, 
  p.program_id</td><td></td><td>skip</td></tr>
   <tr><td>orders/tabs/orders.php:113</td><td>CREATE TEMPORARY TABLE tmp_order_licenses (
  primary key(order_id)
) 
SELECT 
  l.order_id, 
  GROUP_CONCAT(
    CASE WHEN l.student_licenses > 0 
    AND unlimited > 0 THEN CONCAT(
      'Unlimited,', 
      FORMAT(l.student_licenses, 0)
    ) WHEN l.student_licenses > 0 THEN FORMAT(l.student_licenses, 0) WHEN unlimited > 0 THEN 'Unlimited' ELSE NULL END 
    ORDER BY 
      IF(
        (
          l.student_licenses <> '0' 
          OR l.unlimited > 0
        ), 
        0, 
        1
      ), 
      p.sort, 
      p.program_id separator '<br>'
  ) student_licenses 
FROM 
  tmp_program_licenses l 
  JOIN programs p ON p.program_id = l.program_id 
GROUP BY 
  l.order_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/deliverables/index.php:327</td><td>CREATE TABLE $trainer_table(
  PRIMARY KEY(account_id, order_id)
) 
SELECT 
  DISTINCT accounts.account_id, 
  0 order_id 
FROM 
  user_accounts, 
  accounts 
WHERE 
  user_accounts.account_id = accounts.account_id 
  AND user_id IN $trainer_ids 
  AND account_owner = 1 
  AND role_id = 4</td><td></td><td></td></tr>
   <tr><td>reports/deliverables/index.php:367</td><td>CREATE TABLE $rvp_table(
  PRIMARY KEY(order_id, user_id)
) 
SELECT 
  DISTINCT o.order_id, 
  ua.user_id 
FROM 
  orders o, 
  user_accounts ua 
WHERE 
  o.account_id = ua.account_id 
  AND ua.role_id = '" . $ROLE[$DEPARTMENT["implementation"]]["rvp"] . "'</td><td></td><td></td></tr>
   <tr><td>reports/deliverables/index.php:384</td><td>CREATE TABLE $ic_table(
  PRIMARY KEY(account_id, order_id)
) 
SELECT 
  DISTINCT accounts.account_id, 
  0 order_id 
FROM 
  user_accounts, 
  accounts 
WHERE 
  user_accounts.account_id = accounts.account_id 
  AND user_id = $coordinator_id 
  AND account_owner = 1 
  AND role_id = 2</td><td></td><td></td></tr>
   <tr><td>reports/deliverables/index.php:422</td><td>CREATE $temporary TABLE tmp_deliverables_ultimate_parents(
  PRIMARY KEY(account_id)
) 
SELECT 
  DISTINCT b.account_id, 
  b.account_name, 
  a.account_id ultimate_parent_id, 
  a.account_name ultimate_parent_name 
FROM 
  accounts a 
  JOIN accounts b ON b.parent_account_id = a.account_id 
  JOIN accounts c ON c.parent_account_id = a.account_id 
WHERE 
  b.account_level = 2 
  AND c.account_level = 1</td><td></td><td></td></tr>
   <tr><td>reports/deliverables/index.php:464</td><td>CREATE $temporary TABLE tmp_deliverable_orders(
  PRIMARY KEY(order_id)
) 
SELECT 
  o.order_id, 
  a.account_id, 
  a.account_name, 
  if (
    b.account_name is not null, b.account_name, 
    a.account_name
  ) billing_account_name, 
  a.account_level, 
  a.parent_account_id, 
  pa.account_name parent_account_name, 
  a.customer_since, 
  a.state_code, 
  a.no_pls_conversion, 
  o.order_date, 
  o.start_date order_start_date, 
  o.end_date order_end_date, 
  o.date_entered, 
  a.school_start, 
  a.school_end, 
  s.order_total, 
  CAST(s.total_trainings AS SIGNED)- CAST(s.reallocated_pd AS SIGNED) total_trainings, 
  s.reallocated_pd pd_taken, 
  s.total_initial_pd initial_purchased_pd, 
  s.total_followup_pd followup_purchased_pd, 
  (
    s.total_initial_online_pd + s.total_online_pd
  ) online_purchased_pd, 
  CAST(s.fulfilled_pd AS SIGNED)- CAST(
    s.fulfilled_reallocated_pd AS SIGNED
  ) fulfilled_pd, 
  s.expired_pd, 
  CAST(s.scheduled_pd AS SIGNED)- CAST(
    s.scheduled_reallocated_pd AS SIGNED
  ) scheduled_pd, 
  s.onsite_scheduled_pd, 
  s.online_scheduled_pd, 
  s.onsite_fulfilled_pd, 
  s.online_fulfilled_pd, 
  s.onsite_expired_pd, 
  s.online_expired_pd, 
  s.onsite_remaining_pd, 
  s.online_remaining_pd, 
  0 reallocations, 
  opportunity_product_id, 
  ad.imp_special_category, 
  t.tier_name, 
  CASE WHEN a.account_level = 1 THEN a.account_id -- account itself is district
  WHEN pa.account_id IS NOT NULL THEN pa.account_id -- school account with district
  ELSE '0' END sub_district_id, 
  -- school with no parent (private school)
  CASE WHEN a.account_level = 1 THEN a.account_name -- account itself is district
  WHEN pa.account_id IS NOT NULL THEN pa.account_name -- school account with district
  ELSE 'Private School' END sub_district_name, 
  -- school with no parent (private school)
  u.ultimate_parent_id, 
  u.ultimate_parent_name 
FROM 
  orders o 
  JOIN accounts a ON o.account_id = a.account_id 
  JOIN order_summary s ON o.order_id = s.order_id 
  JOIN account_details ad ON a.account_id = ad.account_id $fromStr 
  LEFT JOIN accounts b ON (
    b.account_id = o.billing_account_id
  ) 
  LEFT JOIN accounts pa ON pa.account_id = a.parent_account_id 
  LEFT JOIN order_reportable_excludes e ON (o.order_id = e.order_id) 
  LEFT JOIN tmp_deliverables_ultimate_parents u ON u.account_id = a.account_id 
  LEFT JOIN tiers t ON t.tier_id = a.tier_id 
WHERE 
  e.order_id IS NULL $whereStr 
  AND EXISTS(
    SELECT 
      1 
    FROM 
      order_details d 
      JOIN products p USING(product_id) 
    WHERE 
      o.order_id = d.order_id 
      AND d.status = 0 " . ($academic_year_id ?  " 
      AND d.academic_year_id IN (
        ".implode(", ", $academic_year_id) . "
      ) "
            : " 
      AND $current_date between if(
        d.pre_start, d.pre_start, d.start_date
      ) 
      AND GREATEST(d.post_end, d.end_date) 
      AND d.academic_year_id <> 0 ") ." 
    LIMIT 
      1
  ) AND o.status = 0 
  AND o.draft = 0 
GROUP BY 
  o.order_id</td><td></td><td></td></tr>
   <tr><td>reports/deliverables/index.php:530</td><td>CREATE TEMPORARY TABLE tmp_order_discounts 
SELECT 
  o.order_id, 
  sum(
    if(
      p.product_group_id <> '" . $PRODUCT_GROUPS["discount"] . "', 
      od.price * od.quantity, 0
    )
  ) order_total_before_discount, 
  sum(
    if(
      p.product_group_id = '" . $PRODUCT_GROUPS["discount"] . "', 
      od.price *-1, 0
    )
  ) discount 
FROM 
  tmp_deliverable_orders o, 
  order_details od, 
  products p 
WHERE 
  o.order_id = od.order_id 
  AND p.product_id = od.product_id 
  AND od.status = 0 
GROUP BY 
  o.order_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/deliverables/index.php:556</td><td>CREATE TEMPORARY TABLE tmp_order_credits 
SELECT 
  o.order_id, 
  sum(oc.credit_amount) credit_amount 
FROM 
  tmp_deliverable_orders o, 
  order_cancels oc 
WHERE 
  o.order_id = oc.order_id 
GROUP BY 
  o.order_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/deliverables/index.php:573</td><td>CREATE TEMPORARY TABLE tmp_user_accounts 
SELECT 
  ua.account_id, 
  ua.role_id, 
  concat(
    substr(u.first_name, 1, 1), 
    ' ', 
    u.last_name
  ) user_name 
FROM 
  user_accounts ua, 
  users u, 
  tmp_deliverable_orders o 
WHERE 
  o.account_id = ua.account_id 
  AND ua.role_id in (2, 4, 5) 
  AND ua.account_owner = 1 
  AND u.user_id = ua.user_id 
GROUP BY 
  ua.account_id, 
  ua.role_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/deliverables/index.php:600</td><td>CREATE $temporary TABLE tmp_order_deliverable_pd 
SELECT 
  o.order_id, 
  sum(ao.purchased_pd) purchased_pd, 
  sum(
    ao.fulfilled_pd + ao.scheduled_pd
  ) fulfilled_pd 
FROM 
  tmp_deliverable_orders o, 
  account_order_summary ao 
WHERE 
  o.order_id = ao.order_id 
  AND ao.reallocated = 1 
  AND ao.order_id <> ao.origin_order_id 
GROUP BY 
  o.order_id</td><td></td><td></td></tr>
   <tr><td>reports/deliverables/index.php:630</td><td>CREATE $temporary TABLE tmp_deliverable_products (
  key(product_id), 
  key(program_id)
) 
SELECT 
  DISTINCT p.product_id, 
  p.program_id, 
  p.product_line_id, 
  p.product_group_id, 
  p.student_licenses, 
  p.teacher_licenses, 
  if (pe.product_id is not null, 1, 0) editions, 
  p.exclude_pd 
FROM 
  products p 
  LEFT JOIN product_editions pe ON (p.product_id = pe.product_id)</td><td></td><td></td></tr>
   <tr><td>reports/deliverables/index.php:638</td><td>CREATE $temporary TABLE tmp_deliverable_programs (
  key(order_id), 
  key(account_id), 
  key(academic_year_id)
) 
SELECT 
  od.order_id, 
  od.account_id, 
  od.academic_year_id, 
  min(p.program_id) program_id 
FROM 
  tmp_deliverable_orders o, 
  order_details od, 
  tmp_deliverable_products p 
WHERE 
  o.order_id = od.order_id 
  AND p.product_id = od.product_id 
  AND od.status = 0 
  AND p.program_id > 0 
GROUP BY 
  od.order_id, 
  od.account_id, 
  od.academic_year_id</td><td></td><td></td></tr>
   <tr><td>reports/deliverables/index.php:650</td><td>CREATE $temporary TABLE tmp_deliverable_odetails 
SELECT 
  o.order_id, 
  a.account_id, 
  if(
    p.program_id = 0, 
    if(
      pg.program_id is not null, pg.program_id, 
      1
    ), 
    p.program_id
  ) program_id, 
  pr.sort pr_sort, 
  a.account_name, 
  a.account_level, 
  rg.group_name reporting_group, 
  a.customer_since, 
  a.parent_account_id, 
  pa.account_name parent_account_name, 
  a.state_code, 
  a.no_pls_conversion, 
  
  /*min(d.start_date) start_date, max(d.end_date) end_date,*/
  a.school_start, 
  a.school_end, 
  concat(
    substr(uc.first_name, 1, 1), 
    ' ', 
    uc.last_name
  ) coordinator_name, 
  last_training_date, 
  concat(
    substr(lu.first_name, 1, 1), 
    ' ', 
    lu.last_name
  ) last_trainer_name, 
  ev.shared_day last_training_shared, 
  next_training_date, 
  concat(
    substr(nu.first_name, 1, 1), 
    ' ', 
    nu.last_name
  ) next_trainer_name, 
  GROUP_CONCAT(
    DISTINCT aio.option_name SEPARATOR '; '
  ) implementation_status, 
  CONCAT(e.first_name, ' ', e.last_name) escalation_owner, 
  t.tier_name, 
  GROUP_CONCAT(
    DISTINCT p.product_group_id SEPARATOR ','
  ) product_group_ids, 
  p.product_group_id, 
  GROUP_CONCAT(
    DISTINCT ay.academic_year_name 
    ORDER BY 
      ay.academic_year_name
  ) academic_years, 
  GROUP_CONCAT(DISTINCT ay.academic_year_id) academic_year_ids, 
  MIN(d.start_date) impl_start, 
  MIN(ay.academic_year_id) min_ay_id, 
  ad.imp_special_category, 
  CASE WHEN a.account_level = 1 THEN a.account_id -- account itself is district
  WHEN pa.account_id IS NOT NULL THEN pa.account_id -- school account with district
  ELSE '0' END sub_district_id, 
  -- school with no parent (private school)
  CASE WHEN a.account_level = 1 THEN a.account_name -- account itself is district
  WHEN pa.account_id IS NOT NULL THEN pa.account_name -- school account with district
  ELSE 'Private School' END sub_district_name, 
  -- school with no parent (private school)
  u.ultimate_parent_id, 
  u.ultimate_parent_name 
FROM 
  (
    tmp_deliverable_orders o, order_details d, 
    accounts a, account_summary s, academic_years ay, 
    tmp_deliverable_products p, account_details ad
  ) 
  LEFT JOIN accounts pa ON pa.account_id = a.parent_account_id 
  LEFT JOIN tmp_deliverables_ultimate_parents u ON u.account_id = a.account_id 
  LEFT JOIN tiers t ON t.tier_id = a.tier_id 
  LEFT JOIN users lu ON (s.last_trainer = lu.user_id) 
  LEFT JOIN users nu ON (s.next_trainer = nu.user_id) 
  LEFT JOIN events ev ON (ev.event_id = s.last_event_id) 
  LEFT JOIN account_info ai ON (
    ai.account_id = a.account_id 
    and ai.info_id IN (
      " . implode(", ", array_keys(get_account_info_options_list('implementation_status'))) . "
    )
  ) 
  LEFT JOIN account_info_options aio ON (
    ai.info_id = aio.info_id 
    and aio.status = 0
  ) 
  LEFT JOIN user_accounts ua ON (
    a.account_id = ua.account_id 
    AND ua.role_id = '" . $ROLE[$DEPARTMENT["implementation"]]["escalation_owner"] . "'
  ) 
  LEFT JOIN users e ON (e.user_id = ua.user_id) 
  LEFT JOIN user_accounts uac ON (
    a.account_id = uac.account_id 
    AND uac.role_id = '" . $ROLE[$DEPARTMENT["implementation"]]["coordinator"] . "'
  ) 
  LEFT JOIN users uc ON (uc.user_id = uac.user_id) 
  LEFT JOIN $db_pick.schools sc ON (a.account_id = sc.account_id) 
  LEFT JOIN $db_pick.reporting_group_users rgu ON (
    sc.school_id = rgu.school_id 
    AND rgu.class_id = 0 
    AND rgu.user_id = 0 
    AND rgu.status = 0 
    AND rgu.start_date < ay.end_date 
    AND rgu.end_date > ay.start_date
  ) 
  LEFT JOIN $db_pick.reporting_groups rg ON (
    rg.reporting_group_id = rgu.reporting_group_id
  ) 
  LEFT JOIN tmp_deliverable_programs pg ON (
    o.order_id = pg.order_id 
    AND a.account_id = pg.account_id 
    AND d.academic_year_id = pg.academic_year_id
  ) 
  LEFT JOIN programs pr ON (
    pr.program_id = if(
      p.program_id = 0, 
      if(
        pg.program_id is not null, pg.program_id, 
        1
      ), 
      p.program_id
    )
  ) 
WHERE 
  o.order_id = d.order_id 
  AND a.account_id = ad.account_id $esc_owner_filter $imp_status_filter 
  AND d.status = 0 
  AND d.account_id = a.account_id "
        .($academic_year_id ?  " 
  AND d.academic_year_id IN (
    ".implode(", ", $academic_year_id) . "
  ) "
                    : " 
  AND $current_date between if(
    d.pre_start, d.pre_start, d.start_date
  ) 
  AND GREATEST(d.post_end, d.end_date) 
  AND d.academic_year_id <> 0 ").
    " 
  AND d.account_id = s.account_id 
  AND d.academic_year_id = s.academic_year_id 
  AND ay.academic_year_id = d.academic_year_id 
  AND p.product_id = d.product_id 
GROUP BY 
  o.order_id, 
  a.account_id, 
  program_id</td><td></td><td></td></tr>
   <tr><td>reports/deliverables/index.php:715</td><td>CREATE TEMPORARY TABLE tmp_cancelled_events (
  key(account_id), 
  key(program_id)
) 
SELECT 
  d.account_id, 
  if(
    p.program_id = 0, 
    if(
      pg.program_id is not null, pg.program_id, 
      1
    ), 
    p.program_id
  ) program_id, 
  max(e.event_date) event_date, 
  substring_index(
    max(
      concat(e.event_date, '|', e.event_id)
    ), 
    '|', 
    -1
  ) event_id, 
  substring_index(
    max(
      concat(e.event_date, '|', e.shared_day)
    ), 
    '|', 
    -1
  ) shared_day 
FROM 
  (
    tmp_deliverable_odetails d, events e, 
    event_cancels ec, event_accounts ea, 
    order_details od, tmp_deliverable_products p
  ) 
  LEFT JOIN tmp_deliverable_programs pg ON (
    d.order_id = pg.order_id 
    AND d.account_id = pg.account_id 
    AND e.academic_year_id = pg.academic_year_id
  ) 
WHERE 
  d.account_id = ea.account_id "
        .//($academic_year_id ?  " 
  AND e.academic_year_id IN (
    ".implode(", ", $academic_year_id) . "
  ) " : "").
                " 
  AND FIND_IN_SET(
    e.academic_year_id, d.academic_year_ids
  )> 0 
  AND e.event_id = ec.event_id 
  AND e.event_id = ea.event_id 
  AND e.event_date >= d.last_training_date 
  AND od.order_detail_id = e.order_detail_id 
  AND p.product_id = od.product_id 
  AND d.program_id = if(
    p.program_id = 0, 
    if(
      pg.program_id is not null, pg.program_id, 
      1
    ), 
    p.program_id
  ) 
GROUP BY 
  d.account_id, 
  program_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/deliverables/index.php:759</td><td>CREATE $temporary TABLE tmp_no_order_states 
SELECT 
  o.order_id 
FROM 
  tmp_deliverable_orders o 
  LEFT JOIN tmp_deliverable_odetails d ON (
    o.order_id = d.order_id 
    AND o.state_code = d.state_code
  ) 
WHERE 
  d.account_id IS NULL</td><td></td><td></td></tr>
   <tr><td>reports/deliverables/index.php:769</td><td>CREATE $temporary TABLE tmp_order_states 
SELECT 
  o.order_id 
FROM 
  (
    tmp_deliverable_orders o, tmp_deliverable_odetails d
  ) 
  LEFT JOIN tmp_no_order_states n ON (o.order_id = n.order_id) 
WHERE 
  o.order_id = d.order_id 
  AND (
    (
      o.state_code IN $state_codes 
      AND n.order_id IS NULL
    ) 
    OR (
      d.state_code IN $state_codes 
      AND n.order_id IS NOT NULL
    )
  )</td><td></td><td></td></tr>
   <tr><td>reports/deliverables/index.php:896</td><td>CREATE TEMPORARY TABLE tmp_min_imp_start(
  KEY(order_id)
) 
SELECT 
  d.order_id, 
  d.account_id, 
  MIN(
    NULLIF(d.academic_year_id, 0)
  ) min_ay, 
  ADDDATE(
    o.date_entered, 
    IF(
      DAYOFWEEK(o.date_entered) = 6, 
      3, 
      IF(
        DAYOFWEEK(o.date_entered) = 7, 
        2, 
        1
      )
    )
  ) imp_order_start 
FROM 
  tmp_deliverable_orders o 
  JOIN order_details d ON d.order_id = o.order_id 
WHERE 
  d.status = 0 
GROUP BY 
  d.order_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/deliverables/index.php:937</td><td>CREATE $temporary TABLE tmp_account_order_summary_program (
  key(order_id), 
  key(account_id), 
  key(program_id), 
  key(academic_year_id)
) 
select 
  aos.*, 
  substring_index(
    max(
      concat(
        if(
          d.program_id = if(
            p.program_id = 0, 
            if(
              pg.program_id is not null, pg.program_id, 
              1
            ), 
            p.program_id
          ), 
          1, 
          0
        ), 
        '|', 
        d.program_id
      )
    ), 
    '|', 
    -1
  ) program_id 
FROM 
  (
    account_order_summary aos, tmp_deliverable_odetails d, 
    order_details od, tmp_deliverable_products p
  ) 
  LEFT JOIN tmp_deliverable_programs pg ON (
    d.order_id = pg.order_id 
    AND d.account_id = pg.account_id 
    AND od.academic_year_id = pg.academic_year_id
  ) 
WHERE 
  aos.account_id = d.account_id 
  AND aos.order_id = d.order_id 
  AND FIND_IN_SET(
    aos.academic_year_id, d.academic_year_ids
  )> 0 
  AND od.order_detail_id = aos.order_detail_id 
  AND p.product_id = od.product_id 
  AND p.exclude_pd = 0 
GROUP BY 
  aos.order_id, 
  aos.account_id, 
  aos.order_detail_id, 
  aos.academic_year_id</td><td></td><td></td></tr>
   <tr><td>reports/deliverables/index.php:977</td><td>CREATE $temporary TABLE tmp_deliverable_pd 
SELECT 
  d.order_id, 
  d.account_id, 
  d.program_id, 
  sum(ao.purchased_pd) purchased_pd, 
  sum(ao.initial_purchased_pd) initial_purchased_pd, 
  sum(ao.followup_purchased_pd) followup_purchased_pd, 
  sum(
    ao.initial_online_purchased_pd + ao.online_purchased_pd
  ) online_purchased_pd, 
  sum(ao.fulfilled_pd) fulfilled_pd, 
  sum(ao.expired_pd) expired_pd, 
  sum(ao.scheduled_pd) scheduled_pd, 
  sum(ao.onsite_scheduled_pd) onsite_scheduled_pd, 
  sum(ao.online_scheduled_pd) online_scheduled_pd, 
  sum(ao.onsite_fulfilled_pd) onsite_fulfilled_pd, 
  sum(ao.online_fulfilled_pd) online_fulfilled_pd, 
  sum(ao.onsite_expired_pd) onsite_expired_pd, 
  sum(ao.online_expired_pd) online_expired_pd, 
  sum(ao.onsite_remaining_pd) onsite_remaining_pd, 
  sum(ao.online_remaining_pd) online_remaining_pd, 
  sum(
    if(
      ao.reallocated = 1, ao.purchased_pd, 
      0
    )
  ) reallocated_pd, 
  sum(
    if(
      ao.reallocated = 1, ao.fulfilled_pd + ao.scheduled_pd, 
      0
    )
  ) fulfilled_reallocated_pd 
FROM 
  (
    tmp_deliverable_odetails d, 
    tmp_account_order_summary_program ao, 
    order_details od 
    /*, tmp_deliverable_products p*/
    ) #LEFT JOIN tmp_deliverable_programs pg ON (d.order_id = pg.order_id AND d.account_id = pg.account_id AND ao.academic_year_id = pg.academic_year_id)
WHERE 
  d.order_id = ao.order_id 
  AND d.account_id = ao.account_id #".($academic_year_id ? "AND ao.academic_year_id IN (".implode(", ", $academic_year_id).")" : "")."
  AND FIND_IN_SET(
    ao.academic_year_id, d.academic_year_ids
  )> 0 
  AND od.order_detail_id = ao.order_detail_id #AND p.product_id = od.product_id
  AND d.program_id = ao.program_id 
GROUP BY 
  d.order_id, 
  d.account_id, 
  d.program_id #, d.academic_year_id</td><td></td><td></td></tr>
   <tr><td>reports/deliverables/index.php:1030</td><td>CREATE $temporary TABLE tmp_deliverable_pd_realloc (
  key(account_id), 
  key(order_id)
) 
select 
  'removed to' direction, 
  d.order_id, 
  d.account_id, 
  if(
    r.old_order_id != r.new_order_id, 
    r.new_order_id, ''
  ) realloc_order_id, 
  a.account_name, 
  if(
    od.academic_year_id != r.new_academic_year_id, 
    ay.academic_year_name, ''
  ) academic_year, 
  round(
    sum(r.quantity)/ count(distinct d.program_id)
  ) quantity 
from 
  tmp_deliverable_odetails d, 
  order_reallocations r, 
  order_details od, 
  accounts a, 
  academic_years ay 
where 
  d.order_id = r.old_order_id 
  and d.account_id = r.old_account_id 
  and od.order_detail_id = r.old_order_detail_id 
  and a.account_id = r.new_account_id 
  and ay.academic_year_id = r.new_academic_year_id 
  AND FIND_IN_SET(
    od.academic_year_id, d.academic_year_ids
  )> 0 
  and (
    od.academic_year_id = r.new_academic_year_id 
    or FIND_IN_SET(
      r.new_academic_year_id, d.academic_year_ids
    )<= 0
  ) 
group by 
  order_id, 
  account_id, 
  realloc_order_id, 
  account_name, 
  academic_year</td><td></td><td></td></tr>
   <tr><td>reports/deliverables/index.php:1062</td><td>CREATE $temporary TABLE tmp_deliverable_totals 
SELECT 
  d.order_id, 
  d.account_id, 
  d.program_id, 
  sum(od.price * od.quantity) total_before_discount 
FROM 
  (
    tmp_deliverable_odetails d, order_details od, 
    tmp_deliverable_products p
  ) 
  LEFT JOIN tmp_deliverable_programs pg ON (
    d.order_id = pg.order_id 
    AND d.account_id = pg.account_id 
    AND od.academic_year_id = pg.academic_year_id
  ) 
WHERE 
  d.order_id = od.order_id 
  AND d.account_id = od.account_id 
  AND od.status = 0 
  AND p.product_id = od.product_id 
  AND p.product_group_id <> '" . $PRODUCT_GROUPS["discount"] . "' 
  /*".($academic_year_id ? "AND od.academic_year_id IN (".implode(", ", $academic_year_id).")" : "")."*/
  AND d.program_id = if(
    p.program_id = 0, 
    if(
      pg.program_id is not null, pg.program_id, 
      1
    ), 
    p.program_id
  ) 
GROUP BY 
  d.order_id, 
  d.account_id, 
  d.program_id</td><td></td><td></td></tr>
   <tr><td>reports/deliverables/index.php:1094</td><td>CREATE TEMPORARY TABLE additional_account_info 
SELECT 
  DISTINCT a.account_id, 
  aio.option_name info_text #ifnull(d.academic_year_id,0) academic_year_id,
FROM 
  (
    SELECT 
      account_id 
    FROM 
      tmp_deliverable_orders 
    UNION ALL 
    SELECT 
      account_id 
    FROM 
      tmp_deliverable_odetails
  ) ta 
  JOIN accounts a ON a.account_id = ta.account_id 
  JOIN account_info ai ON ai.account_id = a.account_id 
  JOIN account_info_options aio ON aio.info_id = ai.info_id 
  AND aio.status = 0 
WHERE 
  aio.field_name IN (
    '". implode("', '", $account_info_fields) . "'
  ) 
  AND a.account_level = '" . $ACCOUNT_LEVEL["school"] . "'</td><td></td><td>skip</td></tr>
   <tr><td>reports/deliverables/index.php:1131</td><td>CREATE TEMPORARY TABLE additional_account_info_text 
SELECT 
  account_id, 
  GROUP_CONCAT(
    distinct info_text separator '<br>'
  ) info_text 
FROM 
  additional_account_info 
GROUP BY 
  account_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/deliverables/index.php:1151</td><td>CREATE $temporary TABLE tmp_program_licenses (
  key(order_id), 
  key(account_id), 
  key(program_id)
) 
SELECT 
  od.order_id, 
  od.account_id, 
  if(
    p.program_id = 0, 
    if(
      pg.program_id is not null, pg.program_id, 
      1
    ), 
    p.program_id
  ) program_id, 
  SUM(
    IF(
      aos.student_licenses = '9999' 
      AND p.program_id = ".SMARTY_ANTS_PROGRAM.", 
      NULL, 
      aos.student_licenses
    )
  ) student_licenses, 
  MAX(
    IF(
      aos.student_licenses = '9999' 
      AND p.program_id = ".SMARTY_ANTS_PROGRAM.", 
      1, 
      0
    )
  ) unlimited 
FROM 
  tmp_deliverable_orders o 
  JOIN order_details od ON o.order_id = od.order_id 
  JOIN tmp_deliverable_products p ON p.product_id = od.product_id 
  JOIN account_order_summary aos ON od.order_detail_id = aos.order_detail_id 
  LEFT JOIN tmp_deliverable_programs pg ON (
    o.order_id = pg.order_id 
    AND od.account_id = pg.account_id 
    AND od.academic_year_id = pg.academic_year_id
  ) 
WHERE 
  od.status = 0 "
        .($academic_year_id ?  " 
  AND od.academic_year_id IN (
    ".implode(", ", $academic_year_id) . "
  ) "
           : " 
  AND $current_date between if(
    od.pre_start, od.pre_start, od.start_date
  ) 
  AND GREATEST(od.post_end, od.end_date) 
  AND od.academic_year_id <> 0 ").
    " 
  AND aos.student_licenses > 0 
GROUP BY 
  od.order_id, 
  od.account_id, 
  program_id</td><td></td><td></td></tr>
   <tr><td>reports/deliverables/index.php:1182</td><td>CREATE TEMPORARY TABLE tmp_usage_data (
  key(order_id), 
  key(account_id), 
  key(program_id)
) 
SELECT 
  d.order_id, 
  d.account_id, 
  d.program_id, 
  IFNULL(
    ROUND(
      SUM(su.active_students_ytd)/ SUM(su.total_students_ytd)* 100, 
      0
    ), 
    0
  ) AS ytd_average_usage, 
  SUM(su.pre_test_comp) as pre_test_comp, 
  SUM(su.total_students) as total_students, 
  MAX(su.report_end_date) report_end_date, 
  SUM(su.student_licenses) student_licenses 
FROM 
  tmp_deliverable_odetails d 
  LEFT JOIN school_usage_current_summary su ON (
    d.account_id = su.account_id 
    AND d.program_id = su.program_id
  ) 
GROUP BY 
  d.order_id, 
  d.account_id, 
  d.program_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/deliverables/index.php:1210</td><td>CREATE TEMPORARY TABLE tmp_multi_ord_per_accnt (
  key(account_id), 
  key(program_id)
) 
SELECT 
  d.account_id, 
  d.program_id 
FROM 
  (
    tmp_deliverable_odetails d, account_order_summary aos, 
    order_details od, tmp_deliverable_products p
  ) 
  LEFT JOIN tmp_deliverable_programs pg ON (
    d.order_id = pg.order_id 
    AND d.account_id = pg.account_id 
    AND od.academic_year_id = pg.academic_year_id
  ) 
WHERE 
  d.account_id = aos.account_id 
  AND od.order_detail_id = aos.order_detail_id 
  AND p.product_id = od.product_id "
        .($academic_year_id ?  " 
  AND od.academic_year_id IN (
    ".implode(", ", $academic_year_id) . "
  ) "
           : " 
  AND $current_date between if(
    od.pre_start, od.pre_start, od.start_date
  ) 
  AND GREATEST(od.post_end, od.end_date) 
  AND od.academic_year_id <> 0 ").
    " 
  AND aos.student_licenses > 0 
  AND d.program_id = if(
    p.program_id = 0, 
    if(
      pg.program_id is not null, pg.program_id, 
      1
    ), 
    p.program_id
  ) 
GROUP BY 
  d.account_id, 
  d.program_id 
HAVING 
  count(distinct od.order_id)> 1</td><td></td><td>skip</td></tr>
   <tr><td>reports/deliverables/index.php:1335</td><td>CREATE $temporary TABLE tmp_district_grouping 
SELECT 
  distinct d.order_id, 
  d.account_id, 
  IF (
    gp.account_id is not null, 
    gp.account_id, 
    if (
      p.account_id is not null, 
      p.account_id, 
      if (
        a.account_level = 1, a.account_id, 
        0
      )
    )
  ) district_account_id, 
  IF (
    gp.account_id is not null, 
    gp.state_code, 
    if (
      p.account_id is not null, p.state_code, 
      a.state_code
    )
  ) state_code 
FROM 
  (
    tmp_deliverable_odetails d, accounts a
  ) 
  LEFT JOIN accounts p ON (
    p.account_id = a.parent_account_id
  ) 
  LEFT JOIN accounts gp ON (
    gp.account_id = p.parent_account_id
  ) 
WHERE 
  a.account_id = d.account_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:147</td><td>CREATE $temp TABLE exclude_orders_$table_suffix 
SELECT 
  distinct od.order_id 
FROM 
  order_details od, 
  accounts a, 
  order_summary os, 
  orders o 
WHERE 
  a.account_id = od.account_id 
  AND od.order_id = os.order_id 
  AND o.order_id = od.order_id 
  AND (
    a.account_type = 16 
    OR os.order_total < 0 
    /*OR o.se_0_order = 1*/
    )</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:169</td><td>CREATE $temp TABLE orders_$table_suffix (
  key(account_id), 
  key(order_id), 
  key(opportunity_product_id), 
  key(buyer_contact)
) 
SELECT 
  if (
    a.billing_account_id, a.billing_account_id, 
    a.account_id
  ) ordering_account_id, 
  b.account_id, 
  sum(b.price * b.quantity) total_purchased, 
  sum(b.list_price * b.quantity) total_list_price, 
  max(b.end_date) order_detail_end, 
  substring_index(
    max(
      concat(
        ay.end_date, '|', ay.academic_year_id
      )
    ), 
    '|', 
    -1
  ) academic_year_id, 
  a.order_id, 
  group_concat(distinct c.user_id) user_id, 
  concat(bc.first_name, ' ', bc.last_name) buyer_contact, 
  p.opportunity_id, 
  ot.opportunity_type_name opportunity_type, 
  min(
    if (
      opm.opportunity_product_id is null, 
      1, opm.opportunity_product_id
    )
  ) opportunity_product_id, 
  a.se_0_order 
FROM 
  (
    orders a, order_details b, academic_years ay
  ) 
  LEFT JOIN user_orders c ON a.order_id = c.order_id 
  and c.role_id = 6 
  LEFT JOIN exclude_orders_$table_suffix e on a.order_id = e.order_id 
  LEFT JOIN opportunities p on (p.order_id = a.order_id) 
  LEFT JOIN opportunity_product_map opm ON (
    p.opportunity_id = opm.opportunity_id
  ) 
  LEFT JOIN opportunity_types ot ON (
    ot.opportunity_type_id = p.opportunity_type_id
  ) 
  LEFT JOIN order_contacts oc on (
    p.opportunity_id = oc.opportunity_id 
    and oc.contact_type_id = 3
  ) 
  LEFT JOIN contacts bc ON (bc.contact_id = oc.contact_id) 
WHERE 
  a.order_id = b.order_id $whereStr 
  AND a.status = 0 
  AND b.status = 0 
  AND e.order_id is null 
  AND ay.academic_year_id = b.academic_year_id 
  AND ay.summer = '$summer' 
GROUP BY 
  b.account_id, 
  order_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:222</td><td>CREATE $temp TABLE prev_ay_$table_suffix (
  key(academic_year_id)
) 
SELECT 
  o.academic_year_id, 
  substring_index(
    max(
      concat(
        ay.end_date, '|', ay.academic_year_id
      )
    ), 
    '|', 
    -1
  ) prev_academic_year_id 
FROM 
  orders_$table_suffix o, 
  academic_years ay, 
  academic_years ay2 
WHERE 
  o.academic_year_id = ay2.academic_year_id 
  AND ay.end_date < ay2.end_date 
  AND ay.summer = '$summer' 
GROUP BY 
  o.academic_year_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:239</td><td>CREATE $temp TABLE next_ay_$table_suffix (
  key(academic_year_id)
) 
SELECT 
  o.academic_year_id, 
  substring_index(
    min(
      concat(
        ay.end_date, '|', ay.academic_year_id
      )
    ), 
    '|', 
    -1
  ) next_academic_year_id 
FROM 
  orders_$table_suffix o, 
  academic_years ay, 
  academic_years ay2 
WHERE 
  o.academic_year_id = ay2.academic_year_id 
  AND ay.end_date > ay2.end_date 
  AND ay.summer = '$summer' 
GROUP BY 
  o.academic_year_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:265</td><td>CREATE $temp TABLE has_licenses_$table_suffix 
SELECT 
  a.account_id, 
  a.order_id, 
  max(
    if (sp.sub_product_type_id = 1, 1, 0)
  ) licenses 
FROM 
  orders_$table_suffix a, 
  order_details b, 
  products p, 
  sub_products sp 
WHERE 
  a.order_id = b.order_id 
  AND a.account_id = b.account_id 
  AND b.status = 0 $whereStr 
  AND p.product_id = b.product_id 
  AND p.product_group_id <> '" . $PRODUCT_GROUPS["discount"] . "' 
  AND p.product_id = sp.product_id 
GROUP BY 
  a.account_id, 
  a.order_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:289</td><td>CREATE $temp TABLE non_license_products_$table_suffix 
SELECT 
  DISTINCT o.account_id, 
  o.order_id, 
  p.product_group_id 
FROM 
  products p, 
  order_details od, 
  orders_$table_suffix o 
WHERE 
  o.order_id = od.order_id 
  AND o.licenses = 0 
  AND o.account_id = od.account_id 
  AND p.product_id = od.product_id 
  AND od.status = 0 
  AND od.end_date = o.order_detail_end 
  AND p.product_group_id <> 28 
  AND p.product_group_id <> '" . $PRODUCT_GROUPS["discount"] . "'</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:307</td><td>CREATE $temp TABLE orders_future_$table_suffix 
SELECT 
  b.account_id, 
  o.order_id, 
  a.se_0_order, 
  if (
    opm.opportunity_product_id is null, 
    1, opm.opportunity_product_id
  ) opportunity_product_id, 
  group_concat(
    distinct b.order_id 
    order by 
      b.order_id separator '; '
  ) orders, 
  group_concat(
    distinct date_format(a.order_date, '%c/%e/%y') 
    order by 
      b.order_id separator '; '
  ) order_date 
FROM 
  (
    orders a, order_details b, products pr, 
    sub_products sp, orders_$table_suffix o
  ) 
  LEFT JOIN exclude_orders_$table_suffix e on (a.order_id = e.order_id) 
  LEFT JOIN opportunities p ON (p.order_id = a.order_id) 
  LEFT JOIN opportunity_product_map opm ON (
    p.opportunity_id = opm.opportunity_id
  ) 
  LEFT JOIN non_license_products_$table_suffix nl ON (
    o.order_id = nl.order_id 
    AND o.account_id = nl.account_id
  ) 
WHERE 
  a.order_id = b.order_id 
  AND o.account_id = b.account_id 
  AND a.status = 0 
  AND b.status = 0 
  AND pr.product_id = b.product_id 
  AND pr.product_id = sp.product_id 
  AND (
    (
      o.licenses = 1 
      AND sp.sub_product_type_id = 1
    ) 
    OR (
      o.licenses = 0 
      AND nl.product_group_id = pr.product_group_id
    )
  ) 
  AND a.se_0_order = o.se_0_order 
  AND e.order_id is null 
  AND b.academic_year_id = o.next_academic_year_id 
GROUP BY 
  b.account_id, 
  o.order_id, 
  opm.opportunity_product_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:347</td><td>CREATE $temp table opps_future_$table_suffix 
SELECT 
  b.account_id, 
  o.order_id, 
  opm.opportunity_product_id, 
  group_concat(
    distinct concat(
      (
        round(op.probability_percent * 100)
      ), 
      '%'
    ) 
    order by 
      op.probability_percent separator '; '
  ) status 
FROM 
  (
    quotes a, quote_details b, opportunities c, 
    opportunity_probabilities op, products p, 
    sub_products sp, orders_$table_suffix o
  ) 
  LEFT JOIN opportunity_product_map opm ON (
    c.opportunity_id = opm.opportunity_id
  ) 
  LEFT JOIN non_license_products_$table_suffix nl ON (
    o.order_id = nl.order_id 
    AND o.account_id = nl.account_id
  ) 
WHERE 
  a.quote_id = b.quote_id 
  AND c.opportunity_id = a.opportunity_id 
  AND c.order_id = 0 
  AND c.probability_id IN (
    " . implode(", ", array_keys($opportunity_probabilities)) . "
  ) 
  AND op.probability_id = c.probability_id 
  AND p.product_id = b.product_id 
  AND p.product_id = sp.product_id 
  AND (
    (
      o.licenses = 1 
      AND sp.sub_product_type_id = 1
    ) 
    OR (
      o.licenses = 0 
      AND nl.product_group_id = p.product_group_id
    )
  ) 
  AND c.lead_source_id = 7 
  AND (
    a.final = 1 
    or a.date_entered >= '" . date("Y-m-d", mktime(0,0,0,date(m)-3, 1, date(Y))) . "'
  ) 
  AND o.account_id = b.account_id 
  AND b.academic_year_id = o.next_academic_year_id 
GROUP BY 
  b.account_id, 
  o.order_id, 
  opm.opportunity_product_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:381</td><td>CREATE $temp table order_totals_$table_suffix 
SELECT 
  DISTINCT o.order_id, 
  os.order_total 
FROM 
  orders_$table_suffix o, 
  order_summary os 
WHERE 
  o.order_id = os.order_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:391</td><td>CREATE $temp table discounts_$table_suffix 
SELECT 
  distinct a.order_id, 
  order_total, 
  (
    order_total +(
      sum(b.price)*-1
    )
  ) order_total_plus_discount, 
  (
    sum(b.price)*-1
  ) total_discount, 
  (
    sum(
      if (b.product_id <> 2, b.price, 0)
    )*-1
  ) total_standard_discount, 
  (
    sum(
      if (b.product_id = 2, b.price, 0)
    )*-1
  ) total_non_standard_discount, 
  (
    (
      sum(b.price)*-1
    )/(
      order_total +(
        sum(b.price)*-1
      )
    )
  ) discount_percent, 
  (
    (
      sum(
        if (b.product_id <> 2, b.price, 0)
      )*-1
    )/(
      order_total +(
        sum(b.price)*-1
      )
    )
  ) standard_discount_percent, 
  (
    (
      sum(
        if (b.product_id = 2, b.price, 0)
      )*-1
    )/(
      order_total +(
        sum(b.price)*-1
      )
    )
  ) non_standard_discount_percent 
FROM 
  order_totals_$table_suffix a, 
  order_details b, 
  products c 
WHERE 
  a.order_id = b.order_id 
  AND b.product_id = c.product_id 
  AND product_group_id = '" . $PRODUCT_GROUPS["discount"] . "' 
GROUP BY 
  a.order_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:423</td><td>CREATE 
/*$temp*/
table exception_products_$table_suffix 
SELECT 
  a.order_id, 
  a.account_id, 
  if (
    p.sku like '%bbcp%', 
    'Blackbelt', 
    if (
      p.product_group_id = '" . $PRODUCT_GROUPS["pd"] . "', 
      'PD', 
      if (
        p.product_group_id = '" . $PRODUCT_GROUPS["project_management"] . "', 
        'Project Management', 
        if (
          p.product_group_id = '" . $PRODUCT_GROUPS["levelset"] . "', 
          'Levelset', 
          if (
            p.summer_type_id > 0, 
            'Summer', 
            if (
              p.product_group_id IN (
                '" . implode("', ' ", $upgrade_product_groups) . "'
              ), 
              'Upgrade', 
              ''
            )
          )
        )
      )
    )
  ) exception_product 
FROM 
  orders_$table_suffix a, 
  order_details b, 
  products p 
WHERE 
  a.order_id = b.order_id 
  AND a.account_id = b.account_id 
  AND b.status = 0 
  AND p.product_id = b.product_id 
  AND p.product_group_id NOT IN (
    '" . $PRODUCT_GROUPS["discount"] . "', 
    '" . $PRODUCT_GROUPS["fee"] . "'
  ) $whereStr</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:444</td><td>CREATE $temp table no_exception_products_$table_suffix 
SELECT 
  DISTINCT order_id, 
  account_id 
FROM 
  exception_products_$table_suffix 
WHERE 
  exception_product = ''</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:473</td><td>CREATE $temp table exception_orders_$table_suffix 
SELECT 
  order_id, 
  account_id, 
  concat(
    group_concat(
      distinct exception_product 
      order by 
        exception_product separator '/'
    ), 
    ' only'
  ) exception_reason 
FROM 
  exception_products_$table_suffix 
GROUP BY 
  order_id, 
  account_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:610</td><td>CREATE $temp table order_years_$table_suffix 
SELECT 
  distinct b.order_id, 
  b.order_length total_years, 
  b.order_date, 
  b.start_date order_start_date, 
  b.end_date order_end_date, 
  b.start_date first_start, 
  b.end_date last_end, 
  os.order_total multi_year_order_total, 
  count(
    distinct(
      if(
        ay.summer = '$summer', od.academic_year_id, 
        null
      )
    )
  ) ay_count 
FROM 
  orders b, 
  orders_$table_suffix c, 
  order_details od, 
  order_summary os, 
  academic_years ay 
WHERE 
  b.order_id = c.order_id 
  AND b.order_id = od.order_id 
  and od.status = 0 
  AND b.order_id = os.order_id 
  AND ay.academic_year_id = od.academic_year_id 
GROUP BY 
  b.order_id 
  /*HAVING total_years > 1*/</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:626</td><td>CREATE $temp TABLE orders_discounts_$table_suffix (
  key(order_id), 
  key(opportunity_product_id), 
  key(buyer_contact)
) 
SELECT 
  o.order_id, 
  o.opportunity_product_id, 
  concat(bc.first_name, ' ', bc.last_name) buyer_contact, 
  (
    (
      sum(
        if(p.product_id is null, 0, od.price)
      )*-1
    )/(
      os.order_total +(
        sum(
          if(p.product_id is null, 0, od.price)
        )*-1
      )
    )
  ) discount_percent 
FROM 
  (orders o, order_summary os) 
  LEFT JOIN order_details od ON (o.order_id = od.order_id) 
  left JOIN products p ON (
    od.product_id = p.product_id 
    AND p.product_group_id = '" . $PRODUCT_GROUPS["discount"] . "'
  ) 
  LEFT JOIN opportunities op on (op.order_id = o.order_id) 
  LEFT JOIN order_contacts oc on (
    op.opportunity_id = oc.opportunity_id 
    and oc.contact_type_id = 3
  ) 
  LEFT JOIN contacts bc ON (bc.contact_id = oc.contact_id) 
WHERE 
  o.order_id = os.order_id 
  AND o.status = 0 
GROUP BY 
  o.order_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:693</td><td>CREATE $temp TABLE accounts_$table_suffix (
  key(account_id), 
  key(buyer_contact), 
  key(opportunity_product_id)
) 
SELECT 
  DISTINCT account_id, 
  buyer_contact, 
  opportunity_product_id, 
  prev_academic_year_id, 
  next_academic_year_id 
FROM 
  orders_$table_suffix</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:727</td><td>CREATE $temp TABLE totals_2_years_ago_$table_suffix (
  key(account_id), 
  key(order_id)
) 
select 
  o.account_id, 
  o.order_id, 
  sum(
    greatest(
      nr.line_list_price + nr.pro_rated_fees + nr.pro_rated_discounts + nr.pro_rated_credits, 
      0
    )
  ) total_2_years_ago 
from 
  orders_$table_suffix o, 
  order_details od, 
  orders o2, 
  order_contacts oc, 
  contacts c, 
  order_new_renewal_data nr 
where 
  o.account_id = od.account_id 
  and o2.order_id = od.order_id 
  and o2.opportunity_product_id = o.opportunity_product_id 
  and o2.order_id = oc.order_id 
  and oc.contact_type_id = 3 
  and c.contact_id = oc.contact_id 
  and concat(c.first_name, ' ', c.last_name) = o.buyer_contact 
  and od.academic_year_id = o.prev_academic_year_id 
  and nr.order_detail_id = od.order_detail_id 
group by 
  o.account_id, 
  o.order_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:757</td><td>CREATE $temp TABLE usage_data_$table_suffix (
  key(account_id)
) 
select 
  account_id, 
  substring_index(
    max(
      concat(
        academic_year, '|', student_licenses
      )
    ), 
    '|', 
    -1
  ) student_licenses, 
  substring_index(
    max(
      concat(
        academic_year, '|', pre_test_comp
      )
    ), 
    '|', 
    -1
  ) pre_test_comp, 
  substring_index(
    max(
      concat(
        academic_year, '|', active_students_ytd
      )
    ), 
    '|', 
    -1
  ) active_students_ytd, 
  substring_index(
    max(
      concat(
        academic_year, '|', total_licenses_ytd
      )
    ), 
    '|', 
    -1
  ) total_licenses_ytd 
FROM 
  school_usage_by_program 
WHERE 
  report_end_date = '$usage_end_date' 
  AND renewal_extension = 0 
GROUP BY 
  account_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:772</td><td>CREATE $temp TABLE projected_totals_by_order_$table_suffix (
  key(account_id), 
  key(order_id)
) 
SELECT 
  t.*, 
  od.account_id, 
  if(
    t.opportunity_product_id != 1, '', 
    pl.product_line_str
  ) product_line, 
  sum(
    greatest(
      nr.line_list_price + nr.pro_rated_credits, 
      0
    )
  ) projected_total_before_discount, 
  sum(
    greatest(
      nr.line_list_price + nr.pro_rated_fees + nr.pro_rated_discounts + nr.pro_rated_credits, 
      0
    )
  ) projected_total_after_discount, 
  'o' order_quote 
FROM 
  (
    accounts_$table_suffix a, orders_discounts_$table_suffix t, 
    order_details od, order_new_renewal_data nr
  ) 
  left join products p ON p.product_id = od.product_id 
  left join product_lines pl on pl.product_line_id = p.product_line_id 
WHERE 
  t.order_id = od.order_id 
  AND od.status = 0 
  AND a.account_id = od.account_id 
  AND od.academic_year_id = a.next_academic_year_id 
  AND year(od.end_date) != '" . date(Y, strtotime($end_date)) . "' 
  AND t.opportunity_product_id = a.opportunity_product_id 
  AND t.buyer_contact = a.buyer_contact 
  AND nr.order_detail_id = od.order_detail_id 
GROUP BY 
  od.order_id, 
  od.account_id, 
  product_line</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:797</td><td>CREATE $temp TABLE quote_totals_$table_suffix (
  key(quote_id)
) 
SELECT 
  q.quote_id, 
  q.opportunity_id, 
  q.final, 
  q.order_length, 
  q.quote_date, 
  sum(qd.price * qd.quantity) quote_total 
FROM 
  quotes q, 
  quote_details qd, 
  products p 
WHERE 
  q.quote_id = qd.quote_id 
  AND p.product_id = qd.product_id 
  AND p.product_group_id != 32 
GROUP BY 
  q.quote_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:808</td><td>CREATE $temp TABLE quote_discounts_$table_suffix (
  key(quote_id)
) 
SELECT 
  q.*, 
  cast(
    (
      (
        sum(
          if(p.product_id is null, 0, qd.price)
        )*-1
      )/(
        q.quote_total +(
          sum(
            if(p.product_id is null, 0, qd.price)
          )*-1
        )
      )
    ) as decimal(25, 23)
  ) discount_percent, 
  min(
    if(
      ay.academic_year_id is null 
      or (
        ay.academic_year_id is not null 
        and ay.summer != '$summer'
      ), 
      null, 
      qd.academic_year_id
    )
  ) min_academic_year_id 
FROM 
  (quote_totals_$table_suffix q) 
  LEFT JOIN quote_details qd ON (q.quote_id = qd.quote_id) 
  left JOIN products p ON (
    qd.product_id = p.product_id 
    AND p.product_group_id = '" . $PRODUCT_GROUPS["discount"] . "'
  ) 
  LEFT JOIN academic_years ay ON (
    ay.academic_year_id = qd.academic_year_id
  ) 
GROUP BY 
  q.quote_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:820</td><td>CREATE $temp TABLE quote_fees_$table_suffix (
  key(quote_id)
) 
SELECT 
  q.quote_id, 
  cast(
    (qd.price / q.quote_total) as decimal(25, 23)
  ) fee_percent 
FROM 
  quote_totals_$table_suffix q, 
  quote_details qd 
WHERE 
  q.quote_id = qd.quote_id 
  AND qd.product_id = 1 
GROUP BY 
  q.quote_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:831</td><td>CREATE $temp TABLE opportunity_quotes_$table_suffix (
  key(opportunity_id), 
  key(quote_id), 
  key(opportunity_product_id), 
  key(buyer_contact)
) 
SELECT 
  p.opportunity_id, 
  op.probability_percent, 
  ifnull(opm.opportunity_product_id, 1) opportunity_product_id, 
  concat(bc.first_name, ' ', bc.last_name) buyer_contact, 
  p.notes, 
  substring_index(
    max(
      concat(
        if(q.final = 1, 1, 0), 
        '|', 
        if(q.order_length = 1, 1, 0), 
        '|', 
        lpad(q.quote_id, 7, '0')
      )
    ), 
    '|', 
    -1
  ) quote_id, 
  substring_index(
    max(
      concat(
        if(q.final = 1, 1, 0), 
        '|', 
        if(q.order_length = 1, 1, 0), 
        '|', 
        lpad(q.quote_id, 7, '0')
      )
    ), 
    '|', 
    1
  ) final, 
  substring_index(
    max(
      concat(
        if(q.final = 1, 1, 0), 
        '|', 
        if(q.order_length = 1, 1, 0), 
        '|', 
        lpad(q.quote_id, 7, '0'), 
        '|', 
        q.min_academic_year_id
      )
    ), 
    '|', 
    -1
  ) min_academic_year_id, 
  substring_index(
    max(
      concat(
        if(q.final = 1, 1, 0), 
        '|', 
        if(q.order_length = 1, 1, 0), 
        '|', 
        lpad(q.quote_id, 7, '0'), 
        '|', 
        q.quote_date
      )
    ), 
    '|', 
    -1
  ) quote_date 
FROM 
  (
    opportunities p, quote_discounts_$table_suffix q, 
    opportunity_probabilities op
  ) 
  left join opportunity_product_map opm on (
    p.opportunity_id = opm.opportunity_id
  ) 
  LEFT JOIN order_contacts oc on (
    p.opportunity_id = oc.opportunity_id 
    and oc.contact_type_id = 3
  ) 
  LEFT JOIN contacts bc ON (bc.contact_id = oc.contact_id) 
WHERE 
  p.opportunity_id = q.opportunity_id 
  AND op.probability_id = p.probability_id 
  AND op.probability_percent between.10 
  and.90 
GROUP BY 
  p.opportunity_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:850</td><td>CREATE $temp TABLE quote_no_buyer_$table_suffix (
  key(quote_id), 
  key(account_id), 
  key(opportunity_product_id), 
  key(buyer_contact)
) 
select 
  q.quote_id, 
  a.account_id, 
  a.opportunity_product_id, 
  min(a.buyer_contact) buyer_contact 
from 
  opportunity_quotes_$table_suffix q, 
  accounts_$table_suffix a, 
  quote_details qd, 
  renewal_opportunities ro, 
  opportunities p, 
  order_contacts oc, 
  contacts c 
where 
  q.buyer_contact is null 
  and q.opportunity_id = ro.opportunity_id 
  and p.order_id = ro.order_id 
  and p.opportunity_id = oc.opportunity_id 
  and oc.contact_type_id = 3 
  and c.contact_id = oc.contact_id 
  and q.quote_id = qd.quote_id 
  and qd.account_id = a.account_id 
  and qd.academic_year_id = a.next_academic_year_id 
  and q.opportunity_product_id = a.opportunity_product_id 
  and a.buyer_contact = concat(c.first_name, ' ', c.last_name) 
group by 
  q.quote_id, 
  a.account_id, 
  a.opportunity_product_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:870</td><td>CREATE $temp table quotes_$table_suffix (
  key(quote_id), 
  key(academic_year_id)
) 
SELECT 
  a.account_id, 
  a.opportunity_product_id, 
  a.buyer_contact, 
  group_concat(distinct pl.product_line_str) product_line_str, 
  qd.academic_year_id, 
  substring_index(
    max(
      concat(
        q.probability_percent, 
        '|', 
        q.final, 
        '|', 
        lpad(q.quote_id, 7, '0')
      )
    ), 
    '|', 
    -1
  ) quote_id, 
  substring_index(
    max(
      concat(
        q.probability_percent, 
        '|', 
        q.final, 
        '|', 
        lpad(q.quote_id, 7, '0'), 
        '|', 
        q.notes
      )
    ), 
    '|', 
    -1
  ) notes 
FROM 
  (
    accounts_$table_suffix a, opportunity_quotes_$table_suffix q, 
    quote_details qd
  ) 
  left join products pr on (pr.product_id = qd.product_id) 
  left join product_lines pl on (
    pl.product_line_id = pr.product_line_id
  ) 
  LEFT JOIN projected_totals_by_order_$table_suffix p ON (
    a.account_id = p.account_id 
    AND a.opportunity_product_id = p.opportunity_product_id 
    AND a.buyer_contact = p.buyer_contact 
    and (
      a.opportunity_product_id != 1 
      or pl.product_line_str is null 
      or pl.product_line_str = p.product_line
    )
  ) 
  LEFT JOIN orders_$table_suffix o ON (
    a.account_id = o.account_id 
    AND a.opportunity_product_id = o.opportunity_product_id 
    AND a.buyer_contact = o.buyer_contact
  ) 
  LEFT JOIN renewal_opportunities ro ON (
    q.opportunity_id = ro.opportunity_id 
    AND ro.order_id = o.order_id
  ) 
  LEFT JOIN quote_no_buyer_$table_suffix b ON (
    q.buyer_contact is null 
    AND q.quote_id = b.quote_id 
    AND a.account_id = b.account_id 
    and a.opportunity_product_id = b.opportunity_product_id
  ) 
WHERE 
  a.opportunity_product_id = q.opportunity_product_id 
  AND (
    a.buyer_contact = q.buyer_contact 
    or (
      b.quote_id is not null 
      and a.buyer_contact = b.buyer_contact
    )
  ) 
  AND q.quote_id = qd.quote_id 
  AND a.account_id = qd.account_id 
  AND qd.academic_year_id = a.next_academic_year_id 
  AND (
    q.min_academic_year_id = a.next_academic_year_id 
    or q.quote_date >= '" . date(' Y - m - d ', mktime(0,0,0,date(m)-3,date(d),date(Y))) . "' 
    OR ro.opportunity_id IS NOT NULL
  ) 
  AND year(qd.end_date) != '" . date(Y, strtotime($end_date)) . "' 
  AND p.account_id is null 
GROUP BY 
  a.account_id, 
  a.opportunity_product_id, 
  a.buyer_contact</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:935</td><td>CREATE $temp TABLE projected_totals_$table_suffix (
  key(account_id), 
  key(opportunity_product_id), 
  key(buyer_contact)
) 
SELECT 
  account_id, 
  opportunity_product_id, 
  buyer_contact, 
  sum(
    projected_total_before_discount
  ) projected_total_before_discount, 
  sum(projected_total_after_discount) projected_total_after_discount, 
  group_concat(distinct notes separator '|') notes 
FROM 
  projected_totals_by_order_$table_suffix 
GROUP BY 
  account_id, 
  opportunity_product_id, 
  buyer_contact</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:945</td><td>CREATE $temp table order_details_$table_suffix 
SELECT 
  a.state_code state, 
  c.county_name, 
  o.account_id, 
  if (
    a.account_level = 2, d.account_id, 
    a.account_id
  ) district_id, 
  if (
    a.account_level = 2, d.account_name, 
    a.account_name
  ) district_name, 
  if (
    a.account_level = 2, a.account_id, 
    ''
  ) school_id, 
  if (
    a.account_level = 2, a.account_name, 
    ''
  ) school_name, 
  e.account_level buyer_account_level, 
  e.account_id buyer_account_id, 
  e.account_name buyer_name, 
  sum(total_purchased) total_purchased_no_discounts, 
  sum(standard_discount_amount) standard_discount_amount, 
  sum(non_standard_discount_amount) non_standard_discount_amount, 
  sum(total_purchased_new) total_purchased_discounts, 
  sum(total_purchased_standard) total_purchased_standard_discount, 
  max(order_detail_end) order_detail_end, 
  group_concat(distinct u.user_id) sales_rep_id, 
  group_concat(
    distinct u.first_name, ' ', u.last_name
  ) sales_rep, 
  group_concat(distinct u2.user_id) account_sales_rep_id, 
  concat(ur.first_name, ' ', ur.last_name) renewal_rep, 
  group_concat(
    distinct u2.first_name, ' ', u2.last_name
  ) account_sales_rep, 
  account_user_status, 
  o.buyer_contact, 
  group_concat(
    distinct u3.first_name, ' ', u3.last_name
  ) final_sales_rep, 
  final_user_id, 
  o.trainer_id, 
  o.order_id, 
  total_years, 
  nr.order_date, 
  order_start_date, 
  order_end_date, 
  first_start multi_order_start, 
  last_end multi_order_end, 
  ay_count, 
  multi_year_order_total, 
  renewal_order, 
  renewal_order_date, 
  renewal_opportunity_status, 
  o.opportunity_product_id, 
  o.opportunity_id, 
  o.opportunity_type, 
  o.se_0_order, 
  
  /*tiers.tier_name,*/
  o.exception_reason, 
  t.total_2_years_ago, 
  i.total_enrollment, 
  if (
    a.account_level = 2, p.customers, i.customers
  ) district_customers, 
  if (
    a.account_level = 2, p.non_customers, 
    i.non_customers
  ) district_non_customers, 
  i.tier tier_name, 
  usg.student_licenses, 
  usg.pre_test_comp, 
  IF(
    usg.active_students_ytd > 0 
    AND usg.total_licenses_ytd > 0, 
    (
      usg.active_students_ytd / usg.total_licenses_ytd
    ), 
    0
  ) avg_usage_licenses, 
  a.sf_account_id, 
  pt.projected_total_before_discount, 
  pt.projected_total_after_discount, 
  pt.notes opportunity_notes 
FROM 
  (
    orders_$table_suffix o, accounts a
  ) 
  LEFT JOIN accounts e ON o.ordering_account_id = e.account_id 
  LEFT JOIN accounts d on a.parent_account_id = d.account_id 
  LEFT JOIN users u on o.user_id = u.user_id 
  LEFT JOIN users u2 on o.account_user_id = u2.user_id 
  LEFT JOIN users u3 on o.final_user_id = u3.user_id 
  LEFT JOIN order_years_$table_suffix nr ON (o.order_id = nr.order_id) 
  LEFT JOIN user_accounts uar ON (
    a.account_id = uar.account_id 
    AND uar.role_id = 25
  ) # renewal rep
  LEFT JOIN users ur ON (ur.user_id = uar.user_id) 
  LEFT JOIN counties c ON (c.county_id = a.county_id) 
  LEFT JOIN tiers ON (a.tier_id = tiers.tier_id) 
  LEFT JOIN totals_2_years_ago_$table_suffix t ON (
    a.account_id = t.account_id 
    /*AND o.opportunity_product_id = t.opportunity_product_id
        AND o.buyer_contact = t.buyer_contact*/
    AND o.order_id = t.order_id
  ) 
  LEFT JOIN bob_account_info i ON (a.account_id = i.account_id) 
  LEFT JOIN bob_account_info p ON (d.account_id = p.account_id) 
  LEFT JOIN usage_data_$table_suffix usg ON (a.account_id = usg.account_id) 
  LEFT JOIN projected_totals_$table_suffix pt ON (
    a.account_id = pt.account_id 
    AND o.opportunity_product_id = pt.opportunity_product_id 
    AND o.buyer_contact = pt.buyer_contact
  ) 
WHERE 
  a.account_id = o.account_id 
GROUP BY 
  state, 
  district_name, 
  o.account_id, 
  buyer_account_id, 
  o.order_id 
ORDER BY 
  state, 
  district_name, 
  school_name, 
  u.first_name, 
  u.last_name</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:1026</td><td>CREATE $temp TABLE product_lines_$table_suffix 
SELECT 
  o.order_id, 
  o.account_id, 
  GROUP_CONCAT(
    DISTINCT IFNULL(
      pr.program_name, pl.product_line_str
    ) 
    ORDER BY 
      IFNULL(
        pr.program_name, pl.product_line_str
      )
  ) products_on_order 
FROM 
  orders_$table_suffix o 
  JOIN order_details b ON o.order_id = b.order_id 
  AND o.account_id = b.account_id 
  JOIN academic_years ay ON ay.academic_year_id = b.academic_year_id 
  JOIN products p ON p.product_id = b.product_id 
  JOIN product_lines pl ON pl.product_line_id = p.product_line_id 
  LEFT JOIN programs pr ON pr.program_id = p.program_id 
  AND pl.product_line_id IN(3, 4, 11) 
WHERE 
  b.status = 0 $whereStr 
  AND ay.academic_year_id = b.academic_year_id 
  AND ay.summer = '$summer' 
GROUP BY 
  b.account_id, 
  b.order_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:1053</td><td>CREATE $temp TABLE licenses_$table_suffix(
  key(order_id), 
  key(account_id)
) 
SELECT 
  b.order_id, 
  b.account_id, 
  SUM(
    IF(
      p.program_id IN (1, 15) 
      AND p.summer_type_id <> 6, 
      aos.student_licenses, 
      0
    )
  ) literacy_license_count, 
  SUM(
    IF(
      (
        (
          p.program_id IN (1, 10, 11, 12, 13, 14, 15) 
          AND p.summer_type_id = 6
        ) 
        OR p.program_id = 11
      ), 
      aos.student_licenses, 
      0
    )
  ) literacy_summer_license_count, 
  SUM(
    IF(
      p.program_id IN (12, 13, 14) 
      AND p.summer_type_id <> 6, 
      aos.student_licenses, 
      0
    )
  ) bae_license_count, 
  SUM(
    IF(
      p.program_id = 10 
      AND p.summer_type_id <> 6, 
      aos.student_licenses, 
      0
    )
  ) levelset_license_count, 
  SUM(
    IF(
      p.program_id = 2, aos.student_licenses, 
      0
    )
  ) science_license_count, 
  #If SmartyAnts licenses contain a 9999, then display 'Unlimited'
  IF(
    SUM(
      IF(
        p.program_id = ".SMARTY_ANTS_PROGRAM." 
        AND p.summer_type_id <> 6, 
        aos.student_licenses, 
        0
      )
    ) >= 9999, 
    'Unlimited', 
    CAST(
      SUM(
        IF(
          p.program_id = ".SMARTY_ANTS_PROGRAM." 
          AND p.summer_type_id <> 6, 
          aos.student_licenses, 
          0
        )
      ) AS CHAR
    )
  ) smartyants_license_count, 
  IF(
    SUM(
      IF(
        p.program_id = ".SMARTY_ANTS_PROGRAM." 
        AND p.summer_type_id = 6, 
        aos.student_licenses, 
        0
      )
    ) >= 9999, 
    'Unlimited', 
    CAST(
      SUM(
        IF(
          p.program_id = ".SMARTY_ANTS_PROGRAM." 
          AND p.summer_type_id = 6, 
          aos.student_licenses, 
          0
        )
      ) AS CHAR
    )
  ) smartyants_summer_license_count 
FROM 
  orders_$table_suffix o 
  JOIN account_order_summary aos ON o.order_id = aos.order_id 
  AND aos.account_id = o.account_id 
  JOIN order_details b ON b.order_detail_id = aos.order_detail_id 
  JOIN academic_years ay ON b.academic_year_id = ay.academic_year_id 
  JOIN products p on p.product_id = b.product_id 
WHERE 
  b.status = 0 $whereStr 
  AND ay.academic_year_id = b.academic_year_id 
  AND aos.reallocated = 0 
  AND ay.summer = '$summer' 
GROUP BY 
  b.account_id, 
  b.order_id</td><td></td><td></td></tr>
   <tr><td>reports/renewal/discount_review.php:1090</td><td>(
  $run == 0 ? "CREATE $temp TABLE bob_results (key(account_id),key(order_id),key(summer))" : "INSERT INTO bob_results"
)."
  SELECT distinct if(school_id='',district_id,school_id) account_id,
  '$summer' summer,
  state , county_name, if(buyer_account_level=1,'District','School') buyer_account_level, buyer_account_id, buyer_name,  district_id district_account_id, district_name ,
        school_id  school_account_id, school_name, a.order_id,
        total_purchased_no_discounts,
  standard_discount_amount,
  non_standard_discount_amount,
        total_purchased_discounts,
        total_purchased_standard_discount,
        if (discount_percent, concat(round(discount_percent*100, 2), '%'), '0%') discount_percent,
        order_detail_end, sales_rep order_sales_rep, account_sales_rep, renewal_rep,
        concat(c.first_name, ' ', c.last_name) trainer, buyer_contact,
        /*if (total_years > 1, total_years, '')*/ total_years,
        order_date,
        order_start_date,
        order_end_date,
        if (total_years <= 1 and ay_count <= 1, '', multi_order_start) multi_year_order_start,
        if (total_years <= 1 and ay_count <= 1, '', multi_order_end) multi_year_order_end,
        if (total_years <= 1 and ay_count <= 1, '', format(multi_year_order_total, 2)) multi_year_order_total,
        if (renewal_order = '', 'N', 'Y') has_renewal, renewal_order, renewal_order_date,
        if (renewal_order = '', if (renewal_opportunity_status <> '', renewal_opportunity_status, ''), 'N/A') renewal_opportunity_status,
  a.opportunity_id, a.opportunity_type,
  products_on_order,
  literacy_license_count,
  literacy_summer_license_count,
  bae_license_count,
  levelset_license_count,
  science_license_count,
  smartyants_license_count,
  smartyants_summer_license_count,
        ls.lead_source_name, op.opportunity_product_name, se_0_order, tier_name, exception_reason,
  total_2_years_ago, total_enrollment, district_customers, district_non_customers,
  student_licenses, pre_test_comp, avg_usage_licenses, sf_account_id,
  projected_total_before_discount, projected_total_after_discount, opportunity_notes
        FROM (order_details_$table_suffix a)
        LEFT JOIN discounts_$table_suffix b on a.order_id = b.order_id
        LEFT JOIN users c ON a.trainer_id = c.user_id
        LEFT JOIN opportunities p on (p.order_id = a.order_id)
        LEFT JOIN lead_sources ls on (ls.lead_source_id = p.lead_source_id)
        LEFT JOIN opportunity_products op ON (op.opportunity_product_id = a.opportunity_product_id)</td><td></td><td></td></tr>
   <tr><td>cron/dallas_isd_training.php:10</td><td>CREATE TABLE tech.dallas_accounts (
  KEY(account_id)
) 
SELECT 
  * 
FROM 
  accounts 
WHERE 
  (
    parent_account_id = 3388 
    OR account_id = 3388
  ) 
  AND customer_status = 'current customer'</td><td></td><td></td></tr>
   <tr><td>cron/dallas_isd_training.php:20</td><td>CREATE TABLE tech.dallas_account_events (
  KEY(account_id)
) 
SELECT 
  ea.event_id, 
  ea.account_id, 
  e.event_type_id, 
  e.event_date 
FROM 
  event_accounts ea 
  JOIN tech.dallas_accounts a ON ea.account_id = a.account_id 
  JOIN events e ON e.event_id = ea.event_id 
  AND e.event_date >= '2017-07-01' 
  AND e.event_status <> 'x' 
  AND e.status = 0 
GROUP BY 
  ea.event_id 
HAVING 
  COUNT(DISTINCT ea.account_id) = 1</td><td></td><td></td></tr>
   <tr><td>cron/dallas_isd_training.php:33</td><td>CREATE TABLE tech.dallas_central_events (
  KEY(account_id)
) 
SELECT 
  ea.event_id, 
  ea.account_id, 
  e.event_date 
FROM 
  event_accounts ea 
  JOIN tech.dallas_accounts a ON ea.account_id = a.account_id 
  JOIN events e ON e.event_id = ea.event_id 
  AND event_type_id IN (1) 
  AND e.event_date >= '2017-07-01' 
  AND e.event_status <> 'x' 
  AND e.status = 0 
WHERE 
  ea.event_id NOT IN (
    SELECT 
      event_id 
    FROM 
      tech.dallas_account_events
  ) 
GROUP BY 
  ea.event_id, 
  ea.account_id</td><td></td><td></td></tr>
   <tr><td>cron/dallas_isd_training.php:46</td><td>CREATE TABLE tech.dallas_semifinal (
  KEY(account_id)
) 
SELECT 
  a.account_id, 
  REPLACE(a.account_name, ',', ' - ') account_name, 
  GROUP_CONCAT(
    DISTINCT IF(
      ae.event_type_id = 1, ae.event_date, 
      NULL
    ) 
    ORDER BY 
      ae.event_date SEPARATOR ';'
  ) 'training', 
  GROUP_CONCAT(
    DISTINCT IF(
      ae.event_type_id IN (13, 17), 
      ae.event_date, 
      NULL
    ) 
    ORDER BY 
      ae.event_date SEPARATOR ';'
  ) 'project_management', 
  GROUP_CONCAT(
    DISTINCT IF(
      ae.event_type_id NOT IN (1, 13, 17), 
      ae.event_date, 
      NULL
    ) 
    ORDER BY 
      ae.event_date SEPARATOR ';'
  ) 'other', 
  GROUP_CONCAT(
    DISTINCT ce.event_date 
    ORDER BY 
      ce.event_date SEPARATOR ';'
  ) 'centralized_days', 
  COUNT(
    DISTINCT IF(
      ae.event_type_id IN (1), 
      ae.event_id, 
      NULL
    )
  ) 'total_account_training', 
  COUNT(
    DISTINCT IF(
      ae.event_type_id IN (13, 17), 
      ae.event_id, 
      NULL
    )
  ) 'total_project_management', 
  COUNT(DISTINCT ce.event_id) 'total_centralized_days' 
FROM 
  tech.dallas_accounts a 
  LEFT JOIN tech.dallas_account_events ae ON ae.account_id = a.account_id 
  LEFT JOIN tech.dallas_central_events ce ON ce.account_id = a.account_id 
GROUP BY 
  a.account_id</td><td></td><td></td></tr>
   <tr><td>cron/dallas_isd_training.php:64</td><td>CREATE TABLE tech.dallas_final (
  KEY(account_id)
) 
SELECT 
  *, 
  SUM(
    total_account_training + total_centralized_days
  ) 'total_training_events' 
FROM 
  tech.dallas_semifinal 
GROUP BY 
  account_id</td><td></td><td></td></tr>
   <tr><td>cron/monthly/monthly_pd_utilization_report.php:11</td><td>CREATE TEMPORARY TABLE ".$rand." _pd_cims (
  KEY(user_id)
) 
SELECT 
  u.user_id, 
  COUNT(
    DISTINCT IF(
      a.account_level = 2, a.account_id, 
      NULL
    )
  ) 'school', 
  COUNT(
    DISTINCT IF(
      a.account_level = 1, a.account_id, 
      NULL
    )
  ) 'district' 
FROM 
  users u 
  JOIN user_accounts ua ON ua.user_id = u.user_id 
  AND ua.account_owner = 1 
  AND ua.role_id = 4 
  JOIN accounts a ON a.account_id = ua.account_id 
  AND a.customer_status = 'current customer' 
GROUP BY 
  u.user_id</td><td></td><td>skip</td></tr>
   <tr><td>cron/monthly/monthly_pd_utilization_report.php:21</td><td>CREATE TEMPORARY TABLE ".$rand." _pd_rvp_regions (
  KEY(user_id)
) 
SELECT 
  DISTINCT ul.user_id, 
  r.region_id 
FROM 
  user_regions ul 
  JOIN user_roles ur ON ul.user_id = ur.user_id 
  JOIN department_roles dr USING(role_id) 
  JOIN users u ON u.user_id = ur.user_id 
  JOIN regions r ON r.region_id = ul.region_id 
  AND r.department_id = 1 
WHERE 
  role_name = 'rvp' 
  AND dr.department_id = 1 
  AND u.status = 0 
  AND ur.display_flag = 'Y' 
UNION 
SELECT 
  DISTINCT r.user_id, 
  regions.region_id 
FROM 
  user_regions r 
  JOIN user_roles rl ON r.user_id = rl.user_id 
  AND rl.role_id = 7 
  AND rl.display_flag = 'n' 
  AND rl.department_id = 1 
  JOIN users us ON us.user_id = rl.user_id 
  AND us.status = 0 
  LEFT JOIN user_regions ul 
  JOIN user_roles ur ON ul.user_id = ur.user_id 
  AND ur.role_id = 7 
  AND ur.department_id = 1 
  AND ur.display_flag = 'y' 
  JOIN users u ON u.user_id = ur.user_id 
  AND u.status = 0 ON ul.region_id = r.region_id 
  JOIN regions ON regions.region_id = r.region_id 
  AND regions.department_id = 1 
WHERE 
  ul.region_id IS NULL</td><td></td><td>skip</td></tr>
   <tr><td>cron/monthly/monthly_pd_utilization_report.php:41</td><td>CREATE TEMPORARY TABLE ".$rand." _pd_rvp_manager (
  KEY(user_id)
) 
SELECT 
  u.user_id, 
  COALESCE(
    GROUP_CONCAT(
      DISTINCT IF(
        ur.role_id = 7 
        AND ur.display_flag = 'y', 
        ur.user_id, 
        NULL
      )
    ), 
    GROUP_CONCAT(
      DISTINCT IF(
        mur.role_id = 7 
        AND mur.display_flag = 'y', 
        mur.user_id, 
        NULL
      )
    ), 
    GROUP_CONCAT(DISTINCT mmur.user_id)
  ) rvp 
FROM 
  users u 
  JOIN user_roles a ON a.user_id = u.user_id 
  LEFT JOIN user_roles ur ON ur.user_id = u.user_id 
  LEFT JOIN users mu ON mu.user_id = u.manager_id 
  LEFT JOIN user_roles mur ON mur.user_id = mu.user_id 
  LEFT JOIN user_roles mmur ON mmur.user_id = mu.manager_id 
  AND mmur.role_id = 7 
WHERE 
  a.department_id = 1 
  AND a.display_flag = 'Y' 
  AND a.role_id IN(4, 5) 
GROUP BY 
  u.user_id</td><td></td><td>skip</td></tr>
   <tr><td>cron/monthly/monthly_pd_utilization_report.php:60</td><td>CREATE TEMPORARY TABLE ".$rand." _pd_events (
  KEY(month, user_id)
) 
SELECT 
  CONCAT(
    YEAR(e.event_date), 
    '-', 
    MONTHNAME(e.event_date)
  ) month, 
  e.user_id, 
  COUNT(
    DISTINCT IF(
      (
        e.event_type_id = 1 
        AND e.pd_type_id <> 5 
        AND e.online = 'n' 
        AND p.program_id <> ".SMARTY_ANTS_PROGRAM."
      ), 
      e.event_date, 
      NULL
    )
  ) 'onsite_pro_billable_count', 
  SEC_TO_TIME(
    SUM(
      IF(
        (
          e.event_type_id = 1 
          AND e.pd_type_id <> 5 
          AND e.online = 'n' 
          AND p.program_id <> ".SMARTY_ANTS_PROGRAM."
        ), 
        TIME_TO_SEC(
          TIMEDIFF(e.end_time, e.start_time)
        ), 
        0
      )
    )
  ) 'onsite_pro_billable_hours', 
  COUNT(
    DISTINCT IF(
      (
        e.event_type_id = 1 
        AND e.pd_type_id <> 5 
        AND e.online = 'y' 
        AND p.program_id <> ".SMARTY_ANTS_PROGRAM."
      ), 
      e.event_id, 
      NULL
    )
  ) 'online_pro_billable_count', 
  SEC_TO_TIME(
    SUM(
      IF(
        (
          e.event_type_id = 1 
          AND e.pd_type_id <> 5 
          AND e.online = 'y' 
          AND p.program_id <> ".SMARTY_ANTS_PROGRAM."
        ), 
        TIME_TO_SEC(
          TIMEDIFF(e.end_time, e.start_time)
        ), 
        0
      )
    )
  ) 'online_pro_billable_hours', 
  COUNT(
    DISTINCT IF(
      (
        e.event_type_id = 1 
        AND e.pd_type_id <> 5 
        AND e.online = 'n' 
        AND p.program_id = ".SMARTY_ANTS_PROGRAM."
      ), 
      e.event_date, 
      NULL
    )
  ) 'onsite_smartyants_billable_count', 
  SEC_TO_TIME(
    SUM(
      IF(
        (
          e.event_type_id = 1 
          AND e.pd_type_id <> 5 
          AND e.online = 'n' 
          AND p.program_id = ".SMARTY_ANTS_PROGRAM."
        ), 
        TIME_TO_SEC(
          TIMEDIFF(e.end_time, e.start_time)
        ), 
        0
      )
    )
  ) 'onsite_smartyants_billable_hours', 
  COUNT(
    DISTINCT IF(
      (
        e.event_type_id = 1 
        AND e.pd_type_id <> 5 
        AND e.online = 'y' 
        AND p.program_id = ".SMARTY_ANTS_PROGRAM."
      ), 
      e.event_id, 
      NULL
    )
  ) 'online_smartyants_billable_count', 
  SEC_TO_TIME(
    SUM(
      IF(
        (
          e.event_type_id = 1 
          AND e.pd_type_id <> 5 
          AND e.online = 'y' 
          AND p.program_id = ".SMARTY_ANTS_PROGRAM."
        ), 
        TIME_TO_SEC(
          TIMEDIFF(e.end_time, e.start_time)
        ), 
        0
      )
    )
  ) 'online_smartyants_billable_hours', 
  COUNT(
    DISTINCT IF(
      (
        e.pd_type_id = 5 
        AND e.online = 'n' 
        AND p.program_id <> ".SMARTY_ANTS_PROGRAM."
      ), 
      e.event_date, 
      NULL
    )
  ) 'onsite_pro_we-care_count', 
  SEC_TO_TIME(
    SUM(
      IF(
        (
          e.pd_type_id = 5 
          AND e.online = 'n' 
          AND p.program_id <> ".SMARTY_ANTS_PROGRAM."
        ), 
        TIME_TO_SEC(
          TIMEDIFF(e.end_time, e.start_time)
        ), 
        0
      )
    )
  ) 'onsite_pro_we-care_hours', 
  COUNT(
    DISTINCT IF(
      (
        e.pd_type_id = 5 
        AND e.online = 'y' 
        AND p.program_id <> ".SMARTY_ANTS_PROGRAM."
      ), 
      e.event_id, 
      NULL
    )
  ) 'online_pro_we-care_count', 
  SEC_TO_TIME(
    SUM(
      IF(
        (
          e.pd_type_id = 5 
          AND e.online = 'y' 
          AND p.program_id <> ".SMARTY_ANTS_PROGRAM."
        ), 
        TIME_TO_SEC(
          TIMEDIFF(e.end_time, e.start_time)
        ), 
        0
      )
    )
  ) 'online_pro_we-care_hours', 
  COUNT(
    DISTINCT IF(
      (
        e.pd_type_id = 5 
        AND e.online = 'n' 
        AND p.program_id = ".SMARTY_ANTS_PROGRAM."
      ), 
      e.event_date, 
      NULL
    )
  ) 'onsite_smartyants_we-care_count', 
  SEC_TO_TIME(
    SUM(
      IF(
        (
          e.pd_type_id = 5 
          AND e.online = 'n' 
          AND p.program_id = ".SMARTY_ANTS_PROGRAM."
        ), 
        TIME_TO_SEC(
          TIMEDIFF(e.end_time, e.start_time)
        ), 
        0
      )
    )
  ) 'onsite_smartyants_we-care_hours', 
  COUNT(
    DISTINCT IF(
      (
        e.pd_type_id = 5 
        AND e.online = 'y' 
        AND p.program_id = ".SMARTY_ANTS_PROGRAM."
      ), 
      e.event_id, 
      NULL
    )
  ) 'online_smartyants_we-care_count', 
  SEC_TO_TIME(
    SUM(
      IF(
        (
          e.pd_type_id = 5 
          AND e.online = 'y' 
          AND p.program_id = ".SMARTY_ANTS_PROGRAM."
        ), 
        TIME_TO_SEC(
          TIMEDIFF(e.end_time, e.start_time)
        ), 
        0
      )
    )
  ) 'online_smartyants_we-care_hours', 
  SEC_TO_TIME(
    SUM(
      IF(
        (e.event_type_id = 1), 
        TIME_TO_SEC(
          TIMEDIFF(e.end_time, e.start_time)
        ), 
        0
      )
    )
  ) 'total_billable_hours', 
  COUNT(
    DISTINCT IF(
      (
        e.event_type_id IN (13, 17)
      ), 
      e.event_date, 
      NULL
    )
  ) 'project_management', 
  COUNT(
    DISTINCT IF(
      (e.event_type_id = 11), 
      e.event_date, 
      NULL
    )
  ) 'internal_training', 
  COUNT(
    DISTINCT IF(
      (e.event_type_id = 10), 
      e.event_date, 
      NULL
    )
  ) 'sales_support', 
  COUNT(
    DISTINCT IF(
      (e.event_type_id = 4), 
      e.event_date, 
      NULL
    )
  ) 'office_days', 
  COUNT(
    DISTINCT IF(
      (e.event_type_id = 3), 
      e.event_date, 
      NULL
    )
  ) 'holds', 
  COUNT(
    DISTINCT IF(
      (e.event_type_id = 5), 
      e.event_date, 
      NULL
    )
  ) 'travels', 
  COUNT(
    DISTINCT IF(
      (e.event_type_id = 20), 
      e.event_date, 
      NULL
    )
  ) 'preps', 
  COUNT(
    DISTINCT IF(
      e.notes REGEXP '^sick| ^ sick|sick day', 
      e.event_date, NULL
    )
  ) 'sick_days', 
  COUNT(
    DISTINCT IF(
      (
        e.notes NOT REGEXP '^sick| ^ sick|sick day' 
        AND e.event_type_id = 6
      ), 
      e.event_date, 
      NULL
    )
  ) 'unavailable', 
  COUNT(
    DISTINCT IF(
      (
        e.notes NOT REGEXP '^sick| ^ sick|sick day' 
        AND e.event_type_id = 2
      ), 
      e.event_date, 
      NULL
    )
  ) 'vacation', 
  COUNT(
    DISTINCT IF(
      e.event_type_id NOT IN (1, 2, 4, 3, 5, 6, 20, 13, 17, 11, 10) 
      AND e.notes NOT REGEXP '^sick| ^ sick|sick day', 
      e.event_date, 
      NULL
    )
  ) 'other_non_billable' 
  /*
  , COUNT(DISTINCT IF((e.event_type_id = 1 AND nr.financial_renewal_treatment = 'new'), e.event_date, NULL)) 'new_order_event_days'
  , COUNT(DISTINCT IF((e.event_type_id = 1 AND nr.financial_renewal_treatment = 'renewal'), e.event_date, NULL)) 'renewal_order_event_days'
  */
FROM 
  (
    SELECT 
      beu.user_id, 
      be.* 
    FROM 
      event_users beu 
      JOIN events be ON be.event_id = beu.event_id 
      AND beu.is_primary = 1 
      AND be.event_type_id = 1 
    UNION 
    SELECT 
      eu.user_id, 
      e.* 
    FROM 
      event_users eu 
      JOIN events e ON e.event_id = eu.event_id 
      JOIN user_roles ur ON ur.user_id = eu.user_id 
      AND ur.role_id IN (4, 5) 
      AND ur.display_flag = 'y' 
      LEFT JOIN event_users eu2 
      JOIN events e2 ON e2.event_id = eu2.event_id 
      AND e2.event_type_id IN (1) 
      AND e2.status = 0 
      AND e2.event_status <> 'X' 
      AND e2.online = 'n' ON eu2.user_id = eu.user_id 
      AND e2.event_date = e.event_date 
    WHERE 
      (
        e.event_type_id <> 1 
        OR e.notes REGEXP '^sick| ^ sick|sick day'
      ) 
      AND e2.event_id IS NULL
  ) e 
  LEFT JOIN order_details od ON od.order_detail_id = e.order_detail_id 
  LEFT JOIN order_new_renewal_data nr ON nr.order_detail_id = od.order_detail_id 
  LEFT JOIN products p ON p.product_id = od.product_id 
WHERE 
  e.status = 0 
  AND e.event_status NOT IN ('x', 't') 
  AND e.status = 0 
  AND e.event_status NOT IN ('x', 't') 
  AND e.event_date BETWEEN '$start_date' 
  AND $end_date 
GROUP BY 
  e.user_id, 
  month</td><td></td><td>skip</td></tr>
   <tr><td>cron/monthly/monthly_pd_utilization_report.php:113</td><td>CREATE TEMPORARY TABLE ".$rand." _pd_start (
  KEY(user_id)
) 
SELECT 
  eu.user_id, 
  MIN(
    IF(
      e.event_date <> '0000-00-00', e.event_date, 
      NULL
    )
  ) 'first_event' 
FROM 
  events e 
  JOIN event_users eu ON eu.event_id = e.event_id 
  JOIN ".$rand." _pd_events t ON eu.user_id = t.user_id 
WHERE 
  e.status = 0 
  AND e.event_status NOT IN ('x', 't') 
  AND YEAR(e.event_date) > 2000 
GROUP BY 
  eu.user_id</td><td></td><td>skip</td></tr>
   <tr><td>cron/training_report.php:31</td><td>CREATE TEMPORARY TABLE tech.tmp_order_events (
  key(order_id), 
  key(academic_year_id), 
  key(event_id)
) 
SELECT 
  order_id, 
  academic_year_id, 
  substring_index(
    max(
      concat(event_date, '|', event_id)
    ), 
    '|', 
    -1
  ) event_id, 
  max(event_date) event_date 
FROM 
  events os 
WHERE 
  status = 0 
  AND event_type_id = 1 
  AND FIND_IN_SET(
    os.academic_year_id, '$academic_years'
  ) > 1 
  AND event_status in ('C', 'S') 
  AND event_date <= CURRENT_DATE 
GROUP BY 
  order_id, 
  academic_year_id</td><td></td><td>skip</td></tr>
   <tr><td>cron/training_report.php:48</td><td>CREATE TEMPORARY TABLE tech.tmp_order_summary (
  key(order_id), 
  key(academic_year_id)
) 
SELECT 
  order_id, 
  academic_year_id, 
  SUM(os.purchased_pd) ordered_training, 
  SUM(os.fulfilled_pd) delivered_training, 
  SUM(os.expired_pd) expired_training, 
  SUM(os.scheduled_pd) scheduled_training 
FROM 
  account_order_summary os 
WHERE 
  (
    os.purchased_pd > 0 
    OR os.fulfilled_pd > 0 
    OR os.scheduled_pd > 0
  ) 
  AND FIND_IN_SET(
    os.academic_year_id, '$academic_years'
  ) > 1 
GROUP BY 
  order_id, 
  academic_year_id</td><td></td><td>skip</td></tr>
   <tr><td>cron/training_report.php:63</td><td>CREATE TEMPORARY TABLE tech.cim_accounts (
  KEY(user_id)
) 
SELECT 
  u.user_id, 
  count(
    distinct if (
      a1.account_level = 2, a1.account_id, 
      null
    )
  ) School, 
  count(
    distinct if (
      p.account_level = 1, p.account_id, 
      null
    )
  ) District 
from 
  (
    accounts a1, orders o, account_order_summary os
  ) 
  /* account owner */
  left join user_accounts au on a1.account_id = au.account_id 
  and au.role_id = '4' 
  and au.account_owner = 1 
  left join users u on u.user_id = au.user_id 
  left join user_accounts au1 on a1.account_id = au1.account_id 
  and au1.role_id = '2' 
  and au1.account_owner = 1 
  left join users u1 on u1.user_id = au1.user_id 
  left join user_accounts ua2 on (
    a1.account_id = ua2.account_id 
    and ua2.role_id = '21'
  ) 
  left join accounts p on p.account_id = a1.parent_account_id 
  LEFT JOIN order_reportable_excludes x ON (o.order_id = x.order_id) 
where 
  1 
  and a1.account_id = os.account_id 
  and o.order_id = os.order_id 
  and o.status = 0 
  AND x.order_id IS NULL 
  and os.academic_year_id in (29) 
group by 
  u.user_id 
ORDER BY 
  concat(u.first_name, u.last_name) ASC</td><td></td><td>skip</td></tr>
   <tr><td>cron/training_report.php:90</td><td>CREATE TEMPORARY TABLE tech.account_pd_purchased (
  KEY(user_id)
) 
SELECT 
  u.user_id, 
  group_concat(distinct aos.order_id), 
  group_concat(distinct ua.account_id), 
  SUM(aos.purchased_pd) 'purchased_pd', 
  SUM(
    aos.onsite_remaining_pd + aos.online_remaining_pd
  ) 'remaining_pd', 
  SUM(
    aos.initial_purchased_pd + aos.followup_purchased_pd
  ) 'onsite_purchased', 
  SUM(
    aos.initial_online_purchased_pd + online_purchased_pd
  ) 'online_purchased' 
FROM 
  users u 
  JOIN user_accounts ua ON ua.user_id = u.user_id 
  AND ua.account_owner = 1 
  AND ua.role_id = 4 
  JOIN accounts a ON a.account_id = ua.account_id #AND a.customer_status = 'current customer'
  JOIN account_order_summary aos ON aos.account_id = a.account_id #AND FIND_IN_SET(aos.academic_year_id, @academic_years) > 1
  JOIN order_details od ON od.order_detail_id = aos.order_detail_id 
  AND od.status = 0 
  AND FIND_IN_SET(
    od.academic_year_id, @academic_years
  ) > 1 
  JOIN products p ON p.product_id = od.product_id #AND p.program_id <> ".SMARTY_ANTS_PROGRAM."
  JOIN orders o ON o.order_id = od.order_id 
  AND o.status = 0 
GROUP BY 
  u.user_id</td><td></td><td>skip</td></tr>
   <tr><td>cron/training_report.php:107</td><td>CREATE TEMPORARY TABLE tech.rvp_regions (
  KEY(user_id)
) 
SELECT 
  DISTINCT ul.user_id, 
  r.region_id 
FROM 
  user_regions ul 
  JOIN user_roles ur ON ul.user_id = ur.user_id 
  JOIN department_roles dr USING(role_id) 
  JOIN users u ON u.user_id = ur.user_id 
  JOIN regions r ON r.region_id = ul.region_id 
  AND r.department_id = 1 
WHERE 
  role_name = 'rvp' 
  AND dr.department_id = 1 
  AND u.status = 0 
  AND ur.display_flag = 'Y' 
UNION 
SELECT 
  DISTINCT r.user_id, 
  regions.region_id 
FROM 
  user_regions r 
  JOIN user_roles rl ON r.user_id = rl.user_id 
  AND rl.role_id = 7 
  AND rl.display_flag = 'n' 
  AND rl.department_id = 1 
  JOIN users us ON us.user_id = rl.user_id 
  AND us.status = 0 
  LEFT JOIN user_regions ul 
  JOIN user_roles ur ON ul.user_id = ur.user_id 
  AND ur.role_id = 7 
  AND ur.department_id = 1 
  AND ur.display_flag = 'y' 
  JOIN users u ON u.user_id = ur.user_id 
  AND u.status = 0 ON ul.region_id = r.region_id 
  JOIN regions ON regions.region_id = r.region_id 
  AND regions.department_id = 1 
WHERE 
  ul.region_id IS NULL</td><td></td><td>skip</td></tr>
   <tr><td>cron/training_report.php:130</td><td>CREATE TEMPORARY TABLE tech.events_delivered (
  KEY(user_id)
) 
SELECT 
  e.user_id, 
  COUNT(
    DISTINCT IF(
      (
        e.event_type_id = 1 
        AND e.online = 'n' 
        /*AND p.program_id <> ".SMARTY_ANTS_PROGRAM."*/
        AND e.shared_event_id = 0
      ), 
      e.event_id, 
      NULL
    )
  ) 'onsite_billable_delivered', 
  COUNT(
    DISTINCT IF(
      (
        e.event_type_id = 1 
        AND e.online = 'y' 
        /*AND p.program_id <> ".SMARTY_ANTS_PROGRAM."*/
        AND e.shared_event_id = 0
      ), 
      e.event_id, 
      NULL
    )
  ) 'online_billable_delivered', 
  COUNT(
    DISTINCT IF(
      e.event_type_id NOT IN (1), 
      e.event_date, 
      NULL
    )
  ) 'non_billable', 
  COUNT(
    DISTINCT IF(
      DAYOFWEEK(e.event_date) NOT IN (1, 7), 
      e.event_date, 
      NULL
    )
  ) 'all_events' 
FROM 
  (
    SELECT 
      beu.user_id, 
      be.* 
    FROM 
      event_users beu #billable events where user is primary
      JOIN events be ON be.event_id = beu.event_id 
      AND beu.is_primary = 1 
      AND be.event_type_id = 1 
    WHERE 
      be.event_date BETWEEN $report_start 
      AND $report_end 
      AND be.status = 0 
      AND be.event_status NOT IN ('x', 't') 
    UNION 
    SELECT 
      eu.user_id, 
      e.* 
    FROM 
      event_users eu #non billable events where user is a trainer
      JOIN events e ON e.event_id = eu.event_id 
      JOIN user_roles ur ON ur.user_id = eu.user_id 
      AND ur.role_id IN (4, 5) 
      AND ur.display_flag = 'y' #checking that user is trainer
      LEFT JOIN event_users eu2 
      JOIN events e2 ON e2.event_id = eu2.event_id 
      AND e2.event_type_id IN (1) 
      AND e2.status = 0 
      AND e2.event_status <> 'X' #excluding non-billable days that the trainer had on the same day as a billable day
      ON eu2.user_id = eu.user_id 
      AND e2.event_date = e.event_date 
    WHERE 
      (e.event_type_id <> 1) 
      AND e2.event_id IS NULL 
      AND e.event_date BETWEEN $report_start 
      AND $report_end 
      AND e.status = 0 
      AND e.event_status NOT IN ('x', 't')
  ) e 
  LEFT JOIN order_details od ON od.order_detail_id = e.order_detail_id 
  LEFT JOIN products p ON p.product_id = od.product_id 
GROUP BY 
  e.user_id 
ORDER BY 
  user_id</td><td></td><td>skip</td></tr>
   <tr><td>cron/training_report.php:156</td><td>CREATE TEMPORARY TABLE tech.cim_start (
  KEY(user_id)
) 
SELECT 
  eu.user_id, 
  MIN(
    IF(
      e.event_date <> '0000-00-00', e.event_date, 
      NULL
    )
  ) 'first_event' 
FROM 
  events e 
  JOIN event_users eu ON eu.event_id = e.event_id 
  JOIN tech.events_delivered t ON eu.user_id = t.user_id 
WHERE 
  e.status = 0 
  AND e.event_status NOT IN ('x', 't') 
  AND YEAR(e.event_date) > 2000 
GROUP BY 
  eu.user_id</td><td></td><td>skip</td></tr>
   <tr><td>cron/training_report.php:169</td><td>CREATE TEMPORARY TABLE tech.rvp_managers (
  KEY(user_id)
) 
SELECT 
  u.user_id, 
  COALESCE(
    GROUP_CONCAT(
      DISTINCT IF(
        ur.role_id = 7 
        AND ur.display_flag = 'y', 
        ur.user_id, 
        NULL
      )
    ), 
    GROUP_CONCAT(
      DISTINCT IF(
        mur.role_id = 7 
        AND mur.display_flag = 'y', 
        mur.user_id, 
        NULL
      )
    ), 
    GROUP_CONCAT(DISTINCT mmur.user_id)
  ) rvp 
FROM 
  users u 
  JOIN user_roles a ON a.user_id = u.user_id 
  LEFT JOIN user_roles ur ON ur.user_id = u.user_id 
  LEFT JOIN users mu ON mu.user_id = u.manager_id 
  LEFT JOIN user_roles mur ON mur.user_id = mu.user_id 
  LEFT JOIN user_roles mmur ON mmur.user_id = mu.manager_id 
  AND mmur.role_id = 7 
  LEFT JOIN tech.cim_accounts c ON c.user_id = u.user_id 
  LEFT JOIN tech.events_delivered e ON e.user_id = u.user_id 
WHERE 
  (
    e.user_id IS NOT NULL 
    or c.user_id IS NOT NULL
  ) 
GROUP BY 
  u.user_id</td><td></td><td>skip</td></tr>
   <tr><td>cron/training_report.php:190</td><td>CREATE TEMPORARY TABLE tech.blank_calendar_days (
  KEY(user_id)
) 
SELECT 
  d.user_id, 
  SUM(
    TOTAL_WEEKDAYS($report_start, $report_end) - d.events
  ) blank_days 
FROM 
  (
    SELECT 
      eu.user_id, 
      COUNT(DISTINCT e.event_date) events 
    FROM 
      tech.events_delivered t 
      JOIN event_users eu ON eu.user_id = t.user_id 
      JOIN events e ON e.event_id = eu.event_id 
    WHERE 
      e.status = 0 
      AND e.event_date BETWEEN $report_start 
      AND $report_end 
      AND DAYOFWEEK(e.event_date) NOT IN (1, 7) #excluding events that occurred on weekends
    GROUP BY 
      user_id
  ) d 
GROUP BY 
  d.user_id</td><td></td><td>skip</td></tr>
   <tr><td>cron/training_report.php:205</td><td>CREATE TEMPORARY TABLE tech.final_table (
  KEY(user_id)
) 
SELECT 
  u.user_id, 
  CONCAT(u.first_name, ' ', u.last_name) 'CIM', 
  REPLACE(u.title, ',', ' -') title, 
  IFNULL(tc.district, 0) 'districts', 
  IFNULL(tc.school, 0) 'schools', 
  IFNULL(ts.first_event, '') 'first_event', 
  IFNULL(
    IF(
      COUNT(DISTINCT r.region_id) <> 1, 
      CONCAT(m.first_name, ' ', m.last_name), 
      CONCAT(
        rvp.first_name, ' ', rvp.last_name
      )
    ), 
    ''
  ) RVP, 
  CASE WHEN ur2.role_id = 4 THEN 'Full Time' WHEN ur2.role_id = 5 THEN 'Per Diem' ELSE 'Other' END 'cim_type', 
  IF(
    u.status = 1, 'Deactivated', 'Active'
  ) 'cim_status', 
  IFNULL(pd.purchased_pd, 0) purchased_pd, 
  IFNULL(pd.onsite_purchased, 0) onsite_purchased, 
  IFNULL(pd.online_purchased, 0) online_purchased, 
  IFNULL(
    SUM(
      te.onsite_billable_delivered + te.online_billable_delivered
    ), 
    0
  ) 'total_billable_delivered', 
  IFNULL(te.onsite_billable_delivered, 0) 'onsite_billable_delivered', 
  IFNULL(te.online_billable_delivered, 0) 'online_billable_delivered', 
  IFNULL(pd.remaining_pd, 0) remaining_pd, 
  IFNULL(te.`non_billable`, 0) non_billable, 
  IFNULL(td.blank_days, 0) blank_days 
FROM 
  users u 
  LEFT JOIN tech.events_delivered te USING(user_id) 
  LEFT JOIN tech.cim_accounts tc 
  JOIN user_roles ur ON ur.user_id = tc.user_id 
  AND ur.role_id IN (4, 5) 
  AND ur.display_flag = 'y' ON tc.user_id = u.user_id 
  LEFT JOIN tech.account_pd_purchased pd ON pd.user_id = u.user_id 
  LEFT JOIN tech.blank_calendar_days td ON td.user_id = u.user_id 
  LEFT JOIN tech.cim_start ts ON ts.user_id = u.user_id 
  LEFT JOIN user_roles ur2 ON ur2.user_id = u.user_id 
  AND ur2.role_id IN (4, 5) 
  AND ur2.display_flag = 'y' 
  LEFT JOIN user_regions r ON u.user_id = r.user_id 
  AND r.region_id <> 27 #excluding Unassigned, which is a mistake in the SF sync, as CIMs should not belong to Unassigned.
  LEFT JOIN tech.rvp_regions tr ON tr.region_id = r.region_id 
  LEFT JOIN users rvp ON rvp.user_id = tr.user_id 
  LEFT JOIN tech.rvp_managers rm ON rm.user_id = u.user_id 
  LEFT JOIN users m ON m.user_id = rm.rvp 
WHERE 
  (
    tc.user_id IS NOT NULL 
    OR te.user_id IS NOT NULL
  ) #cim either owns accounts, or had events in the report time frame
GROUP BY 
  u.user_id 
ORDER BY 
  CIM</td><td></td><td>skip</td></tr>
   <tr><td>finance/invoices/import/import_do.php:161</td><td>CREATE TABLE $invoice_taxes_table(
  PRIMARY KEY(ns_invoice_id, type)
) 
SELECT 
  ns_invoice_id ns_invoice_id, 
  type, 
  sum(invoice_total) tax_total 
FROM 
  billing.import_taxes 
WHERE 
  ns_invoice_id IS NOT NULL 
  AND ns_invoice_id != 0 
GROUP BY 
  ns_invoice_id, 
  type</td><td></td><td></td></tr>
   <tr><td>finance/invoices/import/om/invoice_schedule.php:25</td><td>CREATE TABLE credit_link_orders_temp 
SELECT 
  o.real_order_id order_id, 
  c.link_order 
FROM 
  amortization.orders o, 
  credit_link_orders c 
WHERE 
  o.order_id = c.order_id</td><td></td><td></td></tr>
   <tr><td>finance/invoices/import/om/invoice_schedule.php:697</td><td>create table billing_outstanding 
select 
  b.*, 
  sum(invoice_amount) invoiced, 
  b.order_total - sum(
    ifnull(invoice_amount, 0)
  ) remainder 
from 
  (
    billing_orders b, amortization.orders o
  ) 
  left join billing_full f on (o.order_id = f.order_id) 
  left join billing_schedule s on (o.order_id = s.order_id) 
where 
  b.order_id = o.order_id 
  and o.cancel != 'Y' 
  and o.credit != 'Y' 
  and f.order_id is null 
  and round(b.order_total) <> 0 
group by 
  b.order_id</td><td></td><td></td></tr>
   <tr><td>finance/invoices/import/om/invoice_schedule.php:1058</td><td>create temporary table incomplete_billing 
select 
  o.order_id, 
  state, 
  district, 
  account_name, 
  o.order_total, 
  sum(invoice_amount) invoiced 
from 
  billing_schedule b, 
  amortization.orders o, 
  billing_full f 
where 
  b.order_id = o.order_id 
  and b.order_id = f.order_id #and o.cancel != 'Y'
group by 
  o.order_id 
having 
  sum(invoice_amount) not between o.order_total - 5 
  and o.order_total + 5</td><td></td><td></td></tr>
   <tr><td>finance/invoices/import/om/invoice_schedule.php:1081</td><td>CREATE TABLE billing_outstanding 
select 
  o.account_id, 
  o.order_id, 
  state, 
  account_name, 
  o.order_date, 
  o.start_date, 
  o.end_date, 
  o.order_total, 
  o.om_total, 
  sum(invoice_amount) invoiced, 
  o.order_total - sum(
    ifnull(invoice_amount, 0)
  ) remainder, 
  o.cancel, 
  o.billing_account_id, 
  o.billing_account_name 
from 
  (amortization.orders o) 
  left join billing_full f on (o.order_id = f.order_id) 
  left join billing_schedule s on (o.order_id = s.order_id) 
where 
  o.order_id = o.real_order_id 
  and f.order_id is null 
  and round(o.order_total) <> 0 
group by 
  o.order_id</td><td></td><td></td></tr>
   <tr><td>finance/invoices/import/om/invoice_schedule.php:1220</td><td>CREATE TABLE billing_summary 
select 
  year(invoice_date) year, 
  month(invoice_date) month, 
  sum(invoice_amount) billing_total 
from 
  billing_schedule 
group by 
  year(invoice_date), 
  month(invoice_date)</td><td></td><td></td></tr>
   <tr><td>reports/billing/partner_royalty/generate_data.inc:16</td><td>CREATE TEMPORARY TABLE tmp_partner_royalty_target_order_details (
  PRIMARY KEY (order_id)
) 
SELECT 
  o.order_id, 
  sum(line_list_price) list_price, 
  sum(
    pro_rated_discounts + pro_rated_fees
  ) discount, 
  sum(pro_rated_credits) credit, 
  SUM(
    line_list_price + pro_rated_discounts + pro_rated_fees + pro_rated_credits
  ) net_price, 
  MAX(
    CASE WHEN od.status = 0 
    AND o.status = 0 THEN 'Y' ELSE 'N' END
  ) has_uncancelled_details, 
  SUM(
    CASE WHEN od.status = 0 
    AND o.status = 0 THEN orn.line_list_price ELSE 0 END
  ) uncancelled_list_price 
FROM 
  interlink.orders o 
  INNER JOIN interlink.order_details od ON od.order_id = o.order_id 
  INNER JOIN interlink.order_new_renewal_data orn ON orn.order_detail_id = od.order_detail_id 
  INNER JOIN interlink.products p ON p.product_id = od.product_id 
  LEFT JOIN interlink.mh_orders mho ON mho.order_id = o.order_id 
  AND mho.is_post_integration_order = 1 
WHERE 
  1 
  AND mho.order_id IS NULL 
  AND CASE WHEN '$partner_name' = 'Actively Learn Culture Ed' THEN (
    p.product_name LIKE '%culture ed%' 
    OR p.product_line_id = 85
  ) WHEN '$partner_name' = 'Actively Learn Social Studies' THEN (
    p.program_id = 25 
    OR p.product_line_id = 84
  ) WHEN '$partner_name' = 'Actively Learn Science' THEN (
    p.program_id = 24 
    OR p.product_line_id = 83
  ) WHEN '$partner_name' = 'Actively Learn ELA' THEN (p.product_line_id = 82) ELSE 0 END ".(($start_date && $end_date)? " 
  AND o.order_date BETWEEN '$start_date' 
  AND '$end_date' " :"")
        ." 
GROUP BY 
  o.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/billing/partner_royalty/generate_data.inc:48</td><td>CREATE TEMPORARY TABLE tmp_partner_royalty_rebook_order(
  PRIMARY KEY(order_id, replacement_order_id)
) 
SELECT 
  DISTINCT ced.order_id, 
  cancel.order_id replacement_order_id 
FROM 
  tmp_partner_royalty_target_order_details ced 
  INNER JOIN interlink.order_cancel_rebook_summary cancel ON ced.order_id = cancel.rebook_order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/billing/partner_royalty/generate_data.inc:56</td><td>CREATE TEMPORARY TABLE tmp_partner_royalty_rebook_order2(
  PRIMARY KEY(order_id, replacement_order_id)
) 
SELECT 
  ced.order_id, 
  o.replacement_order_id 
FROM 
  tmp_partner_royalty_target_order_details ced 
  INNER JOIN orders o ON(ced.order_id = o.order_id) 
  LEFT JOIN tmp_partner_royalty_rebook_order r ON (
    ced.order_id = r.order_id 
    AND o.replacement_order_id = r.replacement_order_id
  ) 
WHERE 
  o.replacement_order_id > 0 
  AND r.replacement_order_id IS NULL;</td><td></td><td>skip</td></tr>
   <tr><td>reports/billing/partner_royalty/generate_data.inc:75</td><td>CREATE TEMPORARY TABLE tmp_partner_royalty_full_order_details (
  PRIMARY KEY (order_id)
) 
SELECT 
  o.*, 
  GROUP_CONCAT(
    replacement_order.order_id 
    ORDER BY 
      replacement_order.order_id SEPARATOR '|'
  ) replacement_for, 
  GROUP_CONCAT(
    DATE_FORMAT(
      replacement_order.order_date, '%m/%e/%y'
    ) 
    ORDER BY 
      replacement_order.order_id SEPARATOR '|'
  ) replaced_order_date, 
  GROUP_CONCAT(
    replacement_order_total.order_total 
    ORDER BY 
      replacement_order.order_id SEPARATOR '|'
  ) replaced_order_total 
FROM 
  (
    SELECT 
      o.order_id, 
      o.order_date, 
      o.account_id ordering_account_id, 
      os.order_total, 
      os.sales_tax, 
      sum(line_list_price) list_price, 
      sum(
        pro_rated_discounts + pro_rated_fees
      ) discount, 
      sum(pro_rated_credits) credit, 
      SUM(
        line_list_price + pro_rated_discounts + pro_rated_fees + pro_rated_credits
      ) net_price, 
      SUM(
        CASE WHEN od.status = 0 
        AND o.status = 0 THEN orn.line_list_price ELSE 0 END
      ) uncancelled_list_price 
    FROM 
      tmp_partner_royalty_target_order_details ced 
      INNER JOIN interlink.orders o ON o.order_id = ced.order_id 
      INNER JOIN interlink.order_details od ON od.order_id = o.order_id 
      INNER JOIN interlink.order_new_renewal_data orn ON orn.order_detail_id = od.order_detail_id 
      INNER JOIN interlink.order_summary os ON os.order_id = o.order_id 
    GROUP BY 
      o.order_id
  ) o 
  LEFT JOIN tmp_partner_royalty_rebook_order replacement ON (
    o.order_id = replacement.order_id
  ) 
  LEFT JOIN interlink.orders replacement_order ON (
    replacement.replacement_order_id = replacement_order.order_id
  ) 
  LEFT JOIN order_summary replacement_order_total ON (
    replacement_order.order_id = replacement_order_total.order_id
  ) 
GROUP BY 
  o.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/billing/partner_royalty/generate_data.inc:102</td><td>CREATE TEMPORARY TABLE partner_royalty_order_payments (
  PRIMARY KEY (`Order ID`, `Payment ID`)
) 
SELECT 
  o.order_id `Order ID`, 
  o.order_date `Order Date`, 
  oa.account_id `Purchaser Account ID`, 
  oa.account_name `Purchaser Account Name`, 
  CASE WHEN oa.account_level = 2 THEN 'School' ELSE 'District' END `Purchaser Level`, 
  o.order_total `Order Total`, 
  o.sales_tax `Sales Tax`, 
  o.list_price `Order List Price`, 
  o.discount `Order Discount`, 
  o.credit `Order Credit`, 
  o.net_price `Order Net Price`, 
  ced.list_price `Partner List Price`, 
  ced.discount `Partner Discount`, 
  ced.credit `Partner Credit`, 
  ced.net_price `Partner Net Price`, 
  ced.has_uncancelled_details `Partner Has Uncancelled Details`, 
  ced.uncancelled_list_price `Partner Uncancelled Details List Price`, 
  o.replacement_for `Replacement For`, 
  o.replaced_order_date `Replaced Order Date`, 
  o.replaced_order_total `Replaced Order Total`, 
  p.payment_id `Payment ID`, 
  p.payment_total `Payment Total`, 
  p.payment_total - p.sales_tax `Payment Total After Tax`, 
  p.payment_date `Payment Date` 
FROM 
  tmp_partner_royalty_full_order_details o 
  INNER JOIN interlink.accounts oa ON oa.account_id = o.ordering_account_id 
  INNER JOIN tmp_partner_royalty_target_order_details ced ON ced.order_id = o.order_id 
  LEFT JOIN billing.payments p ON p.order_id = o.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/deliverables/summary/index.php:141</td><td>CREATE TEMPORARY TABLE tmp_order_events (
  key(order_id), 
  key(academic_year_id), 
  key(event_id)
) 
SELECT 
  order_id, 
  academic_year_id, 
  substring_index(
    max(
      concat(event_date, '|', event_id)
    ), 
    '|', 
    -1
  ) event_id, 
  max(event_date) event_date 
FROM 
  events os 
WHERE 
  status = 0 
  AND event_type_id = 1 $academic_year_filter 
  AND event_status in ('C', 'S') 
  AND event_date <= CURRENT_DATE 
GROUP BY 
  order_id, 
  academic_year_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/deliverables/summary/index.php:155</td><td>CREATE TEMPORARY TABLE tmp_account_order_summary (
  key(order_id), 
  key(academic_year_id), 
  key(account_id)
) 
SELECT 
  os.order_id, 
  os.account_id, 
  os.academic_year_id, 
  SUM(os.purchased_pd) ordered_training, 
  SUM(os.fulfilled_pd) delivered_training, 
  SUM(os.expired_pd) expired_training, 
  sum(os.onsite_remaining_pd) onsite_remaining_pd, 
  sum(os.online_remaining_pd) online_remaining_pd, 
  SUM(os.scheduled_pd) scheduled_training, 
  (
    select 
      IFNULL(
        sum(aos.purchased_pd), 
        0
      ) al_pd 
    from 
      account_order_summary aos 
      JOIN order_details od on od.order_detail_id = aos.order_detail_id 
      JOIN products pp on pp.product_id = od.product_id 
    WHERE 
      pp.exclude_pd = 1 
      and od.order_id = os.order_id 
      and aos.academic_year_id in $academic_year_ids
  ) as remove_total_AL_PD 
FROM 
  account_order_summary os 
  left join order_details od on os.order_detail_id = od.order_detail_id 
  left join products p on od.product_id = p.product_id 
  and p.exclude_pd = 0 
WHERE 
  (
    os.purchased_pd > 0 
    OR os.fulfilled_pd > 0 
    OR os.scheduled_pd > 0
  ) $academic_year_filter 
GROUP BY 
  order_id, 
  academic_year_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/opportunities/renewals_index.php:491</td><td>CREATE TEMPORARY TABLE $table_name 
SELECT 
  p.opportunity_id, 
  p.opportunity_name, 
  p.order_id renewal_order_id, 
  a.state_code, 
  a.customer_since, 
  concat(t.first_name, ' ', t.last_name) trainer, 
  if(
    a.account_level = 2, d.account_name, 
    a.account_name
  ) district, 
  if(
    a.account_level = 2, a.account_name, 
    ''
  ) school, 
  if (
    cc.first_name is not null, cc.first_name, 
    c.first_name
  ) first_name, 
  if (
    cc.middle_name is not null, cc.middle_name, 
    c.middle_name
  ) middle_name, 
  if (
    cc.last_name is not null, cc.last_name, 
    c.last_name
  ) last_name, 
  r.region_name, 
  p.close_date, 
  s.probability_percent, 
  p.total_schools, 
  p.total, 
  0 has_final_quote, 
  0 final_quote_length, 
  '0000-00-00' quote_start_date, 
  '0000-00-00' quote_end_date, 
  if (
    u.user_id = '" . $USERS["inside_sales"] . "' 
    or u.user_id = '" . $USERS["renewal_sales"] . "', 
    u.first_name, 
    substr(u.first_name, 1, 1)
  ) rep_first_name, 
  u.last_name rep_last_name, 
  GROUP_CONCAT(
    DISTINCT ' ', 
    o.order_id 
    ORDER BY 
      1
  ) original_order_ids, 
  MIN(o.end_date) expiration_date, 
  p.notes, 
  p.campaign_exclude, 
  a.account_id $selectStr2, 
  loss.reason_name loss_reason, 
  p.loss_reason_explanation, 
  risk.reason_name risk_reason, 
  p.follow_up_date 
FROM 
  (
    opportunities p, accounts a, renewal_opportunities ro, 
    users u, opportunity_probabilities s, 
    region_states rs, regions r, orders o, 
    $user_table
  ) 
  LEFT JOIN accounts d on (
    a.parent_account_id = d.account_id
  ) 
  LEFT JOIN order_contacts oc ON (
    p.opportunity_id = oc.opportunity_id 
    AND oc.contact_type_id = '" . $CONTACT_TYPES["buyer"] . "'
  ) 
  LEFT JOIN contacts c ON (c.contact_id = oc.contact_id) 
  LEFT JOIN contact_changes cc ON (
    cc.contact_change_id = oc.contact_change_id
  ) 
  LEFT JOIN user_accounts ua ON (
    a.account_id = ua.account_id 
    AND ua.role_id = 4 
    AND ua.account_owner = 1
  ) 
  LEFT JOIN users t ON (t.user_id = ua.user_id) 
  LEFT JOIN opportunity_loss_reasons loss on loss.reason_id = p.loss_reason_id 
  LEFT JOIN opportunity_loss_reasons risk on risk.reason_id = p.risk_id $lJoin 
WHERE 
  p.account_id = a.account_id 
  AND p.opportunity_id = ro.opportunity_id 
  AND o.order_id = ro.order_id 
  AND p.lead_source_id = '" . $LEAD_SOURCE["renewal"] . "' 
  AND p.probability_id = s.probability_id 
  AND rs.state_code = a.state_code 
  AND rs.region_id = r.region_id $whereStr 
GROUP BY 
  p.opportunity_id $havingStr</td><td></td><td>skip</td></tr>
   <tr><td>reports/opportunities/renewals_index.php:557</td><td>CREATE TEMPORARY TABLE $table_name2 
SELECT 
  q.opportunity_id, 
  q.quote_id, 
  order_length, 
  q.start_date, 
  q.end_date, 
  SUM(price * quantity) quote_total 
FROM 
  $table_name p, 
  quotes q, 
  quote_details qd 
WHERE 
  p.opportunity_id = q.opportunity_id 
  AND q.quote_id = qd.quote_id 
  AND final = 1 
  AND p.renewal_order_id = 0 
GROUP BY 
  q.opportunity_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/opportunities/renewals_index.php:568</td><td>CREATE TEMPORARY TABLE tmp_credits 
SELECT 
  oc.order_id, 
  sum(oc.credit_amount) credit_amount 
FROM 
  $table_name p, 
  order_cancels oc 
WHERE 
  p.renewal_order_id > 0 
  AND p.renewal_order_id = oc.order_id 
GROUP BY 
  oc.order_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/opportunities/renewals_index.php:602</td><td>CREATE TEMPORARY TABLE $table_name3 
SELECT 
  p.opportunity_id, 
  SUM(os.order_total) order_total 
FROM 
  $table_name p, 
  orders o, 
  order_summary os, 
  renewal_opportunities ro 
WHERE 
  p.opportunity_id = ro.opportunity_id 
  AND o.order_id = ro.order_id 
  AND o.order_id = os.order_id 
GROUP BY 
  p.opportunity_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/opportunities/renewals_index.php:648</td><td>CREATE TEMPORARY TABLE tmp_school_usage_current_summary (
  key(account_id), 
  key(program_id)
) 
SELECT 
  account_id, 
  program_id, 
  SUM(active_students_ytd) active_students_ytd, 
  SUM(total_students_ytd) total_students_ytd, 
  SUM(total_students) total_students, 
  SUM(student_licenses) student_licenses, 
  SUM(pre_test_comp) pre_test_comp, 
  MAX(report_end_date) report_end_date 
FROM 
  school_usage_current_summary 
GROUP BY 
  account_id, 
  program_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/opportunities/renewals_index.php:658</td><td>CREATE TEMPORARY TABLE temp_renewals_usage1 
SELECT 
  o.opportunity_id, 
  IFNULL(
    ROUND(
      SUM(su.active_students_ytd)/ SUM(su.total_students_ytd)* 100, 
      0
    ), 
    0
  ) AS ytd_average_usage, 
  IFNULL(
    ROUND(
      SUM(su.total_students)/ SUM(su.student_licenses)* 100, 
      0
    ), 
    0
  ) AS percent_associated_licenses, 
  SUM(su.pre_test_comp) levelset_completed, 
  SUM(su.total_students) as total_students, 
  MAX(su.report_end_date) report_end_date, 
  o.account_id 
FROM 
  $table_name o 
  INNER JOIN opportunity_product_map opm ON opm.opportunity_id = o.opportunity_id 
  INNER JOIN tmp_school_usage_current_summary su on su.account_id = o.account_id 
  AND opm.opportunity_product_id = su.program_id 
GROUP BY 
  o.opportunity_id;</td><td></td><td>skip</td></tr>
   <tr><td>reports/opportunities/renewals_index.php:674</td><td>CREATE TEMPORARY TABLE temp_renewals_usage 
SELECT 
  su.*, 
  IFNULL(
    ROUND(
      SUM(pr.active_students_ytd)/ SUM(pr.total_students_ytd)* 100, 
      0
    ), 
    0
  ) AS prev_ytd_average_usage 
FROM 
  temp_renewals_usage1 su 
  INNER JOIN school_usage_primary_report pr on pr.account_id = su.account_id $last_year_YTD_clause 
GROUP BY 
  su.opportunity_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/renewal/renewal_book/index.php:41</td><td>CREATE TABLE interlink.renewal_bob_report_data_lock 
SELECT 
  '1' col1;</td><td></td><td></td></tr>
   <tr><td>reports/sales/pending_purchase_orders_index.php:6</td><td>CREATE TEMPORARY TABLE $report_tmp_table 
SELECT 
  a.state_code as 'state_code', 
  r.region_name as 'region_name', 
  concat(u.first_name, ' ', u.last_name) sales_rep, 
  o.order_id as 'order_id', 
  o.order_date as 'order_date', 
  a.account_id as 'account_id', 
  if(
    a.account_level = 2, a.account_name, 
    ''
  ) as 'school', 
  if(
    a.account_level = 2, d.account_name, 
    a.account_name
  ) as 'district', 
  os.order_total as 'order_total', 
  group_concat(DISTINCT orp.po SEPARATOR ',') as 'po', 
  if(orp.po_date > 0, orp.po_date, '') as po_date, 
  if(orp.po_date > 0, orp.po_amount, '') as po_amount, 
  orp.no_po as 'po_nr_date', 
  concat(ua.first_name, ' ', ua.last_name) approved_by, 
  orp.no_po_notes as 'po_nr_explanation' 
FROM 
  orders o 
  left join accounts a on (a.account_id = o.account_id) 
  left join accounts d on (
    a.parent_account_id = d.account_id
  ), 
  order_summary os, 
  user_orders uo, 
  users u, 
  order_po orp, 
  region_states rs, 
  regions r, 
  users ua 
WHERE 
  o.order_id = os.order_id 
  AND o.order_id = uo.order_id 
  AND uo.user_id = u.user_id 
  AND orp.order_id = o.order_id 
  AND rs.state_code = a.state_code 
  AND rs.region_id = r.region_id 
  AND orp.approved_by = ua.user_id 
  AND r.department_id = 2 
  AND approved_by != 0 $whereStr 
group by 
  o.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>util/function/orders.php:2261</td><td>CREATE TABLE history_log_records 
SELECT 
  u.last_name, 
  od_a.account_name account, 
  od_a.account_id account_id, 
  od_ay.academic_year_name year, 
  od_p.sku sku, 
  COALESCE(
    hln_ay.academic_year_name, hln_a.account_name, 
    hln_p.sku, hl.new_value
  ) new_val, 
  COALESCE(
    hlo_ay.academic_year_name, hlo_a.account_name, 
    hlo_p.sku, hl.old_value
  ) old_val, 
  hl.* 
FROM 
  history_log hl -- pull in order_details and relevant
  LEFT JOIN order_details od ON hl.table_name LIKE 'order_details' 
  AND hl.record_id = od.order_detail_id 
  LEFT JOIN products od_p ON od.product_id = od_p.product_id 
  LEFT JOIN accounts od_a ON od.account_id = od_a.account_id 
  LEFT JOIN academic_years od_ay ON od.academic_year_id = od_ay.academic_year_id -- pull in history_log relevant tables
  LEFT JOIN users u ON hl.entered_by = u.user_id 
  LEFT JOIN academic_years hln_ay ON hl.column_name = 'academic_year_id' 
  AND hl.new_value = hln_ay.academic_year_id 
  LEFT JOIN accounts hln_a ON (hl.column_name = 'account_id') 
  AND hl.new_value = hln_a.account_id 
  LEFT JOIN products hln_p ON (hl.column_name = 'product_id') 
  AND hl.new_value = hln_p.product_id 
  LEFT JOIN academic_years hlo_ay ON hl.column_name = 'academic_year_id' 
  AND hl.old_value = hlo_ay.academic_year_id 
  LEFT JOIN accounts hlo_a ON (hl.column_name = 'account_id') 
  AND hl.old_value = hlo_a.account_id 
  LEFT JOIN products hlo_p ON (hl.column_name = 'product_id') 
  AND hl.old_value = hlo_p.product_id 
WHERE 
  (
    table_name = 'order_details' 
    AND record_id IN (
      SELECT 
        order_detail_id 
      FROM 
        order_details 
      WHERE 
        order_id = @order_id
    )
  )</td><td></td><td></td></tr>
   <tr><td>util/function/orders.php:2897</td><td>CREATE TEMPORARY TABLE tmp_ode_pd_products (
  PRIMARY KEY(product_id)
) 
SELECT 
  p.product_id 
FROM 
  interlink.products p 
  INNER JOIN interlink.order_details od ON od.product_id = p.product_id 
  INNER JOIN interlink.sub_products sp ON sp.product_id = p.product_id 
  INNER JOIN interlink.sub_product_types spt ON spt.sub_product_type_id = sp.sub_product_type_id 
WHERE 
  spt.pd_deliverable = 'y' 
  AND od.order_id = '$order_id' 
GROUP BY 
  p.product_id;</td><td></td><td>skip</td></tr>
   <tr><td>cron/ls_breakdown.php:13</td><td>create table tech.fm_00628959_parent_program 
select 
  a.school_id, 
  a.user_id, 
  a.academic_year_id, 
  ay.academic_year_name, 
  a.assessment_date_id, 
  b.assessment_id, 
  ifnull(pp.program_id, p.program_id) program_id, 
  ifnull(pp.program_name, p.program_name) program_name 
from 
  tech.wu_assessment_completed a 
  join tech.wu_assessment_dates b on a.assessment_date_id = b.assessment_date_id 
  and b.assessment_date_id <> 0 
  join tech.wu_account_usage c on c.school_id = a.school_id 
  and c.academic_year_id = a.academic_year_id 
  and c.program_id = a.program_id 
  join academic_years ay on a.academic_year_id = ay.academic_year_id 
  join programs p on p.program_id = a.program_id 
  left join programs pp on pp.program_id = p.parent_id 
group by 
  a.user_id, 
  a.academic_year_id, 
  a.school_id, 
  a.assessment_date_id, 
  ifnull(pp.program_id, p.program_id)</td><td></td><td></td></tr>
   <tr><td>cron/ls_breakdown.php:31</td><td>create table tech.fm_00628959_parent_program_final 
select 
  school_id, 
  count(user_id) 'users', 
  academic_year_name, 
  case assessment_id when 1 then 'Pre' when 2 then 'Interim' when 4 then 'Post' else 'Other' end as 'ls_type', 
  program_name 
From 
  tech.fm_00628959_parent_program 
group by 
  school_id, 
  academic_year_id, 
  assessment_date_id, 
  program_id 
order by 
  school_id, 
  academic_year_name</td><td></td><td></td></tr>
   <tr><td>cron/ns_sync/orders_sync.php:22</td><td>CREATE TABLE sync_orders (
  primary key (order_id)
) 
SELECT 
  o.order_id, 
  account_id, 
  if(
    billing_account_id = 0, account_id, 
    billing_account_id
  ) billing_account_id, 
  replacement_order_id, 
  space(22) replacement_ns_id, 
  expansion_order_id, 
  space(8) expansion_ns_id, 
  space(1500) accounting_memo, 
  space(45) po_numbers, 
  space(5) multiple_po, 
  space(5) process_without_po, 
  space(50) sales_rep 
FROM 
  orders o, 
  order_summary os 
WHERE 
  status = 0 
  AND draft = 0 
  AND om_order_id = 0 
  and ns_order_id = '' 
  and account_id > 0 
  AND os.order_id = o.order_id 
  and os.order_total > 0 
  AND date_entered > '2009-08-01' 
  AND date_entered <= '$start_time'</td><td></td><td></td></tr>
   <tr><td>cron/ns_sync/orders_sync.php:63</td><td>CREATE TABLE sync_order_po (
  primary key (order_id)
) 
SELECT 
  s.order_id, 
  group_concat(
    if(
      p.po = '' 
      and p.po_amount = 0 
      and p.po_date = '0000-00-00', 
      '', 
      concat_ws(
        ' ', 
        p.po, 
        p.po_amount, 
        date_format(p.po_date, '%m/%d/%y'), 
        '\n'
      )
    )
  ) accounting_memo, 
  group_concat(p.po) po_numbers, 
  count(distinct p.order_po_id) total_po, 
  if(no_po > 0, 'Yes', 'No') no_po 
FROM 
  sync_orders s, 
  order_po p 
WHERE 
  s.order_id = p.order_id 
  AND (
    p.po NOT IN ('') 
    or p.no_po > 0
  ) 
GROUP BY 
  s.order_id</td><td></td><td></td></tr>
   <tr><td>cron/summary/cancels.php:26</td><td>CREATE TEMPORARY TABLE tmp_order_totals (
  PRIMARY KEY (order_id)
) 
SELECT 
  os.order_id, 
  os.order_total orig_order_total, 
  os.sales_tax, 
  SUM(
    IFNULL(oc.tax_credit_amount, 0)
  ) sales_tax_credits, 
  os.order_total - os.sales_tax + SUM(
    IFNULL(oc.tax_credit_amount, 0)
  ) order_total 
FROM 
  order_summary os 
  LEFT JOIN order_cancels oc ON oc.order_id = os.order_id 
WHERE 
  1 "
                .($order_id? " 
  AND os.order_id = $order_id " : " ")." 
GROUP BY 
  os.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>cron/summary/cancels.php:66</td><td>CREATE TABLE $ranked_cancels_table_name (
  PRIMARY KEY (cancel_id), 
  INDEX(order_id)
) 
SELECT 
  base.*, 
  CASE WHEN base.order_id = @order_id THEN @rank := @rank + 1 ELSE @rank := 1 
  AND @order_id := base.order_id END rank 
FROM 
  (
    SELECT 
      oc.cancel_id, 
      oc.order_id, 
      os.order_total, 
      oc.credit_amount - oc.tax_credit_amount credit_amount, 
      oc.cancel_date 
    FROM 
      tmp_order_cancels oc 
      INNER JOIN orders o ON oc.order_id = o.order_id 
      INNER JOIN tmp_order_totals os ON os.order_id = oc.order_id 
    WHERE 
      1 "
                    .($order_id? " 
      AND oc.order_id = $order_id " : " ")." 
    GROUP BY 
      oc.cancel_id 
    ORDER BY 
      order_id, 
      cancel_date, 
      cancel_id
  ) base CROSS 
  JOIN (
    SELECT 
      @rank := 0, 
      @order_id := 0
  ) r;</td><td></td><td></td></tr>
   <tr><td>cron/summary/cancels.php:118</td><td>CREATE TEMPORARY TABLE tmp_linked_cancels_apply (
  PRIMARY KEY (cancel_id), 
  INDEX (order_id, cancel_id)
) 
SELECT 
  oc.cancel_id, 
  oc.order_id, 
  oc.credit_amount - oc.tax_credit_amount credit_amount, 
  SUM(
    orn.line_list_price + orn.pro_rated_fees + orn.pro_rated_discounts + orn.pro_rated_credits
  ) line_item_total, 
  CASE WHEN oc.credit_amount - oc.tax_credit_amount = 0 THEN 0 ELSE LEAST(
    SUM(
      orn.line_list_price + orn.pro_rated_fees + orn.pro_rated_discounts + orn.pro_rated_credits
    ), 
    oc.credit_amount - oc.tax_credit_amount
  ) END linked_credit_amount 
FROM 
  interlink.order_cancels oc 
  INNER JOIN order_details od ON oc.cancel_id = od.cancel_id 
  INNER JOIN order_new_renewal_data orn ON orn.order_detail_id = od.order_detail_id 
WHERE 
  oc.status = 0 "
             .($order_id? " 
  AND oc.order_id = $order_id " : " ")." 
GROUP BY 
  oc.cancel_id;</td><td></td><td>skip</td></tr>
   <tr><td>cron/summary/cancels.php:171</td><td>CREATE TEMPORARY TABLE tmp_order_net_totals (
  PRIMARY KEY (order_id)
) 
SELECT 
  os.order_id, 
  os.order_total, 
  SUM(
    rn.line_list_price + rn.pro_rated_fees + rn.pro_rated_discounts + rn.pro_rated_credits
  ) sum_line_total 
FROM 
  order_new_renewal_data rn 
  INNER JOIN interlink.order_details od ON od.order_detail_id = rn.order_detail_id 
  INNER JOIN tmp_order_totals os ON rn.order_id = os.order_id 
  INNER JOIN $ranked_cancels_table_name ocr ON ocr.cancel_id = od.cancel_id 
WHERE 
  1 
  AND od.status = 1 
  AND ocr.rank <= $i 
  AND ocr.credit_amount > 0 "
                .($order_id? " 
  AND rn.order_id = $order_id " : " ")." 
GROUP BY 
  rn.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>cron/summary/cancels.php:190</td><td>CREATE TEMPORARY TABLE tmp_cancels_apply (
  PRIMARY KEY (cancel_id), 
  INDEX (order_id, cancel_id)
) 
SELECT 
  oc.cancel_id, 
  oc.order_id, 
  oc.credit_amount - oc.tax_credit_amount credit_amount, 
  SUM(
    orn.line_list_price + orn.pro_rated_fees + orn.pro_rated_discounts + orn.pro_rated_credits
  ) line_item_total, 
  CASE WHEN oc.credit_amount - oc.tax_credit_amount = 0 THEN 0 ELSE LEAST(
    SUM(odc.cancel_amount), 
    ABS(
      oc.credit_amount - oc.tax_credit_amount
    )
  ) END applied_credit_amount, 
  CASE WHEN oc.credit_amount - oc.tax_credit_amount = 0 THEN 0 ELSE oc.credit_amount - oc.tax_credit_amount - 
  /*applied_credit_amount*/
  LEAST(
    SUM(odc.cancel_amount), 
    ABS(
      oc.credit_amount - oc.tax_credit_amount
    )
  ) END unapplied_credit_amount 
FROM 
  interlink.order_cancels oc 
  INNER JOIN interlink.order_detail_cancels odc ON odc.order_id = oc.order_id 
  AND odc.cancel_id = oc.cancel_id 
  INNER JOIN order_new_renewal_data orn ON orn.order_detail_id = odc.order_detail_id 
WHERE 
  oc.status = 0 
GROUP BY 
  oc.cancel_id;</td><td></td><td>skip</td></tr>
   <tr><td>cron/summary/cancels.php:267</td><td>CREATE TEMPORARY TABLE tmp_order_net_totals (
  PRIMARY KEY (order_id)
) 
SELECT 
  os.order_id, 
  os.order_total, 
  SUM(
    rn.line_list_price + rn.pro_rated_fees + rn.pro_rated_discounts + rn.pro_rated_credits
  ) sum_line_total 
FROM 
  order_new_renewal_data rn 
  INNER JOIN tmp_order_totals os ON rn.order_id = os.order_id 
WHERE 
  1 "
             .($order_id? " 
  AND rn.order_id = $order_id " : " ")." 
GROUP BY 
  rn.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>cron/summary/cancels.php:283</td><td>CREATE TEMPORARY TABLE tmp_cancels_apply (
  PRIMARY KEY (cancel_id), 
  INDEX (order_id, cancel_id)
) 
SELECT 
  oc.cancel_id, 
  oc.order_id, 
  oc.credit_amount - oc.tax_credit_amount credit_amount, 
  SUM(
    orn.line_list_price + orn.pro_rated_fees + orn.pro_rated_discounts + orn.pro_rated_credits
  ) line_item_total, 
  CASE WHEN oc.credit_amount - oc.tax_credit_amount = 0 THEN 0 ELSE LEAST(
    SUM(odc.cancel_amount), 
    ABS(
      oc.credit_amount - oc.tax_credit_amount
    )
  ) END applied_credit_amount, 
  CASE WHEN oc.credit_amount - oc.tax_credit_amount = 0 THEN 0 ELSE oc.credit_amount - oc.tax_credit_amount - 
  /*applied_credit_amount*/
  LEAST(
    SUM(odc.cancel_amount), 
    ABS(
      oc.credit_amount - oc.tax_credit_amount
    )
  ) END unapplied_credit_amount 
FROM 
  interlink.order_cancels oc 
  INNER JOIN interlink.order_detail_cancels odc ON odc.order_id = oc.order_id 
  AND odc.cancel_id = oc.cancel_id 
  INNER JOIN order_new_renewal_data orn ON orn.order_detail_id = odc.order_detail_id 
WHERE 
  oc.status = 0 
GROUP BY 
  oc.cancel_id;</td><td></td><td>skip</td></tr>
   <tr><td>cron/summary/cancels.php:374</td><td>CREATE TEMPORARY TABLE new_renew_override_orders (
  PRIMARY KEY (order_id)
) 
SELECT 
  v.order_id, 
  v.new_total, 
  v.renew_total, 
  v.new_total /(v.new_total + v.renew_total) percent_new, 
  v.renew_total /(v.new_total + v.renew_total) percent_renew, 
  v.commissions_override_only 
FROM 
  commissions.v_qc_overrides v 
  INNER JOIN interlink.order_summary os ON os.order_id = v.order_id 
  INNER JOIN interlink.orders o ON o.order_id = os.order_id 
WHERE 
  1 
  AND ABS(
    v.new_total + v.renew_total + os.sales_tax - os.order_total
  )< 1 
  AND IFNULL(v.new_total, 0)+ IFNULL(v.renew_total, 0)> 0 
  AND v.user_id = 0 
  AND v.year = YEAR(o.order_date) 
  AND (
    v.order_id = '$order_id' 
    OR $order_id = 0
  ) 
GROUP BY 
  v.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>cron/summary/cancels.php:396</td><td>CREATE TEMPORARY TABLE tmp_cancels_update (
  PRIMARY KEY (cancel_id)
) 
SELECT 
  od.cancel_id, 
  od.order_id, 
  oc.cancel_date, 
  oc.credit_amount, 
  oc.tax_credit_amount, 
  oc.new_amount new_credit_amount, 
  oc.renewal_amount renew_credit_amount, 
  oc.new_fin_amount new_fin_credit_amount, 
  oc.renewal_fin_amount renew_fin_credit_amount, 
  sum(od.cancel_amount) spread_cancel_amount, 
  ROUND(
    SUM(
      CASE WHEN ov.order_id 
      OR odnr.order_detail_id THEN od.cancel_amount * COALESCE(
        odnr.new_percent, ov.percent_new
      ) WHEN rn.order_renewal_status = 'new' THEN od.cancel_amount ELSE 0 END
    ), 
    2
  ) new_spread_cancel_amount, 
  ROUND(
    SUM(
      CASE WHEN ov.order_id 
      OR odnr.order_detail_id THEN od.cancel_amount * COALESCE(
        odnr.renew_percent, ov.percent_renew
      ) WHEN rn.order_renewal_status = 'renewal' THEN od.cancel_amount ELSE 0 END
    ), 
    2
  ) renew_spread_cancel_amount, 
  ROUND(
    SUM(
      CASE WHEN odnr.order_id 
      AND odnr.commissions_override_only = 0 THEN od.cancel_amount * odnr.new_percent WHEN ov.order_id 
      AND ov.commissions_override_only = 0 THEN od.cancel_amount * percent_new WHEN rn.order_renewal_status = 'new' 
      AND (
        rn.commissions_override_only = 0 
        OR rn.order_renewal_status = 'new'
      ) THEN od.cancel_amount WHEN rn.order_renewal_status = 'new' 
      AND rn.commissions_override_only = 1 THEN od.cancel_amount ELSE 0 END
    ), 
    2
  ) new_fin_spread_cancel_amount, 
  ROUND(
    SUM(
      CASE WHEN odnr.order_id 
      AND odnr.commissions_override_only = 0 THEN od.cancel_amount * odnr.renew_percent WHEN ov.order_id 
      AND ov.commissions_override_only = 0 THEN od.cancel_amount * percent_renew WHEN rn.order_renewal_status = 'renewal' 
      AND (
        rn.commissions_override_only = 0 
        OR rn.order_renewal_status = 'renewal'
      ) THEN od.cancel_amount WHEN rn.order_renewal_status = 'renewal' 
      AND rn.commissions_override_only = 1 THEN od.cancel_amount ELSE 0 END
    ), 
    2
  ) renew_fin_spread_cancel_amount 
FROM 
  interlink.order_detail_cancels od 
  INNER JOIN interlink.order_new_renewal_data rn ON rn.order_detail_id = od.order_detail_id 
  AND rn.order_id = od.order_id 
  INNER JOIN interlink.order_cancels oc ON oc.cancel_id = od.cancel_id 
  LEFT JOIN new_renew_override_orders ov ON ov.order_id = od.order_id 
  LEFT JOIN order_detail_new_renew_overrides odnr ON od.order_detail_id = odnr.order_detail_id 
WHERE 
  oc.cancel_date >= @start_year 
  AND (
    oc.order_id = '$order_id' 
    OR $order_id = 0
  ) 
GROUP BY 
  od.cancel_id 
HAVING 
  abs(
    new_credit_amount - new_spread_cancel_amount
  ) >.01 
  OR abs(
    renew_credit_amount - renew_spread_cancel_amount
  ) >.01 
  OR abs(
    new_fin_credit_amount - new_fin_spread_cancel_amount
  ) >.01 
  OR abs(
    renew_fin_credit_amount - renew_fin_spread_cancel_amount
  ) >.01;</td><td></td><td>skip</td></tr>
   <tr><td>finance/after_import.php:38</td><td>create temporary table temp_order_cancels (
  primary key (order_id)
) 
select 
  order_id, 
  sum(credit_amount) cancel_amount 
from 
  interlink.order_cancels oc 
where 
  oc.status = 0 
group by 
  order_id</td><td></td><td></td></tr>
   <tr><td>finance/after_import.php:74</td><td>create temporary table temp_po_total (
  primary key (order_id)
) 
select 
  order_id, 
  sum(po_amount) total_po, 
  group_concat(distinct po) all_pos 
from 
  order_po 
where 
  no_po = 0 
  and status = 0 
group by 
  order_id</td><td></td><td></td></tr>
   <tr><td>finance/after_import.php:91</td><td>create temporary table temp_trans_date (
  primary key (order_id)
) 
select 
  io.order_id, 
  greatest(
    ifnull(
      max(oc.cancel_date), 
      0
    ), 
    ifnull(cc.invoice_date, 0), 
    ifnull(
      max(p.payment_date), 
      0
    ), 
    ifnull(
      max(i.invoice_date), 
      0
    )
  ) as last_trans_date 
from 
  billing.invoice_orders io 
  left join billing.payments p ON p.order_id = io.order_id 
  left join billing.invoices i on i.invoice_id = io.invoice_id 
  and i.type = 'Credit Memo' 
  left join billing.commission_credits cc on cc.il_order_id = io.order_id 
  left join order_cancels oc on oc.order_id = io.order_id 
  and oc.status = 0 
group by 
  io.order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_commissions_data.inc:7</td><td>create table order_revenue (
  PRIMARY KEY (order_id)
) 
select 
  o.order_id, 
  o.order_total, 
  o.cancel_total, 
  (
    (o.order_total - os.sales_tax)- o.cancel_total
  ) revenue_total, 
  ifnull(
    group_concat(
      distinct concat(last_name) 
      ORDER BY 
        1 SEPARATOR '; '
    ), 
    ''
  ) salesreps 
from 
  orders o 
  left join $data_db.user_orders uo on (
    o.order_id = uo.order_id 
    and uo.role_id = 6
  ) 
  left join $data_db.users u on (uo.user_id = u.user_id) 
  left join $data_db.order_summary os on (o.order_id = os.order_id) 
group by 
  o.order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_commissions_data.inc:20</td><td>create table order_billing (
  PRIMARY KEY (order_id), 
  INDEX(all_defer, order_id)
) 
select 
  b.order_id, 
  sum(past_billing + month_billing) prior_billing, 
  revenue_total, 
  sum(past_billing + month_billing) defer_total, 
  r.revenue_total - sum(past_billing + month_billing) contracted_total, 
  if(
    r.revenue_total <= sum(past_billing + month_billing)+ 1 
    and abs(
      r.revenue_total - sum(past_billing + month_billing)
    ) <.5, 
    'Y', 
    'N'
  ) all_defer 
from 
  billing.billing_monthly b, 
  order_revenue r, 
  orders o 
where 
  b.month_date = '$report_start_month' 
  and r.order_id = b.order_id 
  and b.order_id = o.order_id 
group by 
  b.order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_commissions_data.inc:44</td><td>create table order_revenue_schedule (
  id INT AUTO_INCREMENT PRIMARY KEY, 
  INDEX (order_id, period_month), 
  INDEX(order_id, deferred)
) 
select 
  0 id, 
  1 defer_insert, 
  o.order_id, 
  o.revenue_total, 
  period_month, 
  sum(period_total) period_total, 
  round(
    sum(period_total)/ o.revenue_total, 
    10
  ) revenue_perc, 
  'Y' deferred 
from 
  order_revenue o, 
  order_detail_amortization_lock oda, 
  order_billing b 
where 
  o.order_id = oda.order_id 
  and o.order_id = b.order_id 
  and (
    (
      oda.cancel_id = 0 
      and oda.change_id = 0
    ) 
    or oda.period_month <= '$report_start_month'
  ) 
  and b.all_defer = 'Y' 
group by 
  o.order_id, 
  oda.period_month</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_commissions_data.inc:72</td><td>create table check_defer_revenue (
  PRIMARY KEY (order_id)
) 
select 
  b.order_id, 
  sum(period_total) period_total_to_date 
from 
  order_revenue_schedule r, 
  order_billing b 
where 
  r.order_id = b.order_id 
  and b.all_defer = 'N' 
  and r.deferred = 'Y' 
group by 
  b.order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_commissions_data.inc:139</td><td>create table order_commissions (
  primary key(order_id), 
  bonus_total decimal(20, 2) default 0, 
  paid_bonus decimal(20, 2) default 0, 
  accrued_bonus decimal(20, 2) default 0, 
  total_comm_bonus decimal(20, 2) default 0, 
  paid_comm_bonus decimal(20, 2) default 0, 
  accrued_comm_bonus decimal(20, 2) default 0, 
  total_commissions decimal(20, 2) DEFAULT 0, 
  invoice_commissions decimal(20, 2) DEFAULT 0, 
  due_commissions decimal(20, 2) DEFAULT 0, 
  pending_commissions decimal(20, 2) DEFAULT 0, 
  accrued_commissions decimal(20, 2) DEFAULT 0
) 
select 
  order_id, 
  group_concat(
    distinct concat(
      ifnull(last_name, '')
    ) 
    ORDER BY 
      1 SEPARATOR '; '
  ) salesreps, 
  sum(
    if(
      termination_date > 0, due_commissions, 
      total_commissions
    )
  ) total_commissions, 
  sum(
    if(
      termination_date > 0, due_commissions, 
      invoice_commissions
    )
  ) invoice_commissions, 
  sum(due_commissions) due_commissions, 
  sum(pending_commissions) pending_commissions, 
  SUM(
    if(
      termination_date > 0, due_commissions, 
      invoice_commissions
    )- paid_commissions
  ) accrued_commissions, 
  0 bonus_total, 
  0 paid_bonus, 
  0 accrued_bonus, 
  sum(
    if(
      termination_date > 0, due_commissions, 
      total_commissions
    )
  ) total_comm_bonus, 
  sum(due_commissions) paid_comm_bonus, 
  SUM(
    if(
      termination_date > 0, due_commissions, 
      invoice_commissions
    )- paid_commissions
  ) accrued_comm_bonus 
from 
  commissions.commissions o 
where 
  cmonth = '$report_start_month' 
group by 
  o.order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_commissions_data.inc:161</td><td>CREATE TABLE order_bonuses (
  PRIMARY KEY (order_id)
) 
SELECT 
  b.order_id, 
  SUM(b.bonus_total) bonus_total, 
  SUM(
    CASE WHEN b.paid_date <= last_day('$report_start_month') THEN b.bonus_total ELSE 0 END
  ) paid_bonus, 
  SUM(
    CASE WHEN b.paid_date > last_day('$report_start_month') THEN b.bonus_total ELSE 0 END
  ) accrued_bonus 
FROM 
  commissions.bonuses_per_order b 
WHERE 
  b.bonus_date <= last_day('$report_start_month') 
  AND b.cmonth = '$report_start_month' 
GROUP BY 
  b.order_id;</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_commissions_data.inc:200</td><td>create table order_commission_schedule (
  id INT AUTO_INCREMENT PRIMARY KEY, 
  perc_com_defer decimal (12, 10), 
  recognized_to_date decimal(18, 10)
) 
select 
  r.order_id, 
  r.period_month, 
  r.revenue_perc, 
  r.revenue_perc * total_commissions commission_period_total, 
  r.revenue_perc * bonus_total bonus_period_total, 
  r.revenue_perc * total_comm_bonus comm_bonus_period_total, 
  r.deferred rev_deferred, 
  0 perc_com_defer, 
  0 recognized_to_date 
from 
  order_revenue_schedule r, 
  order_commissions c 
where 
  r.order_id = c.order_id</td><td></td><td></td></tr>
   <tr><td>finance/amortization/wizard/generate/generate_commissions_data.inc:228</td><td>CREATE TEMPORARY TABLE tmp_revenue_recognized_to_date (
  PRIMARY KEY (
    order_id, period_month, rev_deferred
  )
) 
SELECT 
  ocs.order_id, 
  ocs.period_month, 
  ocs.rev_deferred, 
  SUM(
    CASE WHEN ocs2.period_month = ocs.period_month 
    AND ocs.rev_deferred = ocs2.rev_deferred THEN IFNULL(ocs2.commission_period_total, 0) ELSE 0 END
  ) commission_period_total, 
  SUM(
    IFNULL(ocs2.commission_period_total, 0)
  ) recognized_to_date 
FROM 
  order_commission_schedule ocs 
  LEFT JOIN order_commission_schedule ocs2 ON ocs.order_id = ocs2.order_id 
  AND ocs2.period_month <= ocs.period_month 
  AND ocs2.rev_deferred >= ocs.rev_deferred 
GROUP BY 
  ocs.order_id, 
  ocs.period_month, 
  ocs.rev_deferred 
ORDER BY 
  ocs.order_id, 
  ocs.period_month, 
  ocs.rev_deferred DESC</td><td></td><td>skip</td></tr>
   <tr><td>orders/tabs/commission_history.php:137</td><td>CREATE TEMPORARY TABLE temp_billing_summary (
  primary key (order_id)
) 
SELECT 
  io.order_id, 
  GREATEST(
    IFNULL(
      MAX(oc.cancel_date), 
      0
    ), 
    IFNULL(cc.invoice_date, 0), 
    IFNULL(
      MAX(p.payment_date), 
      0
    ), 
    IFNULL(
      MAX(i.invoice_date), 
      0
    )
  ) AS last_trans_date 
FROM 
  billing.invoice_orders io 
  LEFT JOIN billing.payments p ON p.order_id = io.order_id 
  AND p.payment_date <= '$report_month_end' 
  LEFT JOIN billing.invoices i ON i.invoice_id = io.invoice_id 
  AND i.type = 'Credit Memo' 
  AND i.invoice_date <= '$report_month_end' 
  LEFT JOIN billing.commission_credits cc ON cc.il_order_id = io.order_id 
  AND cc.invoice_date <= '$report_month_end' 
  LEFT JOIN interlink.order_cancels oc ON oc.order_id = io.order_id 
  AND oc.status = 0 
  AND oc.cancel_date <= '$report_month_end' 
WHERE 
  io.order_id = $o 
GROUP BY 
  io.order_id;</td><td></td><td>skip</td></tr>
   <tr><td>orders/tabs/commission_history.php:314</td><td>CREATE TEMPORARY TABLE commissions.tmp_user_qc (
  PRIMARY KEY(user_id)
) 
SELECT 
  cmonth, 
  order_id, 
  user_id, 
  sum(quota_credit) quota_credit 
FROM 
  commissions.quota_credit_user_months_lock qcu 
WHERE 
  order_id = $o 
  AND qcu.cmonth = '$report_month_filter' 
GROUP BY 
  user_id, 
  order_id;</td><td></td><td>skip</td></tr>
   <tr><td>orders/tabs/commission_history.php:324</td><td>CREATE TEMPORARY TABLE tmp_order_users (
  PRIMARY KEY (user_id)
) 
SELECT 
  cmonth, 
  user_id, 
  order_id 
FROM 
  commissions.order_users 
WHERE 
  cmonth = '$report_month_filter' 
  AND order_id = $o 
UNION 
SELECT 
  cmonth, 
  user_id, 
  order_id 
FROM 
  commissions.commissions 
WHERE 
  cmonth = '$report_month_filter' 
  AND order_id = $o;</td><td></td><td>skip</td></tr>
   <tr><td>orders/tabs/commission_history.php:339</td><td>CREATE TEMPORARY TABLE tmp_order_users_renewal (
  PRIMARY KEY (user_id)
) 
SELECT 
  u.cmonth, 
  u.user_id, 
  u.order_id, 
  CASE WHEN cp.renewal_rate = 0 
  AND cp.base_rate = 0 THEN 1 ELSE 0 END has_no_rate 
FROM 
  tmp_order_users u 
  INNER JOIN commissions.orders o ON o.order_id = u.order_id 
  AND o.cmonth = u.cmonth 
  INNER JOIN commissions.compensation_plans cp ON cp.user_id = u.user_id 
  AND cp.cmonth = u.cmonth 
  AND YEAR(o.order_date)= cp.year 
  INNER JOIN commissions.areas a ON a.area_id = cp.area_id 
WHERE 
  a.has_renewal_quota = 1 
  AND a.has_field_quota = 0 
  AND cp.comp_plan_type != 'RESELLER' 
GROUP BY 
  u.user_id;;</td><td></td><td>skip</td></tr>
   <tr><td>reports/opportunities/live_version/closed_order_progress_index.php:296</td><td>CREATE TEMPORARY TABLE $report_tmp_table 
SELECT 
  u.first_name rep_first_name, 
  u.last_name rep_last_name, 
  o.order_id, 
  ns_order_id, 
  order_length, 
  if(
    no_po > 0, 
    'Not Required', 
    group_concat(
      DISTINCT po.po 
      ORDER BY 
        1
    )
  ) po_number, 
  if (
    p.lead_source_id is not null, p.lead_source_id, 
    0
  ) lead_source_id, 
  space(50) lead_source_name, 
  a.state_code, 
  if(
    a.account_level = 2, d.account_name, 
    a.account_name
  ) district, 
  if(
    a.account_level = 2, a.account_name, 
    ''
  ) school, 
  region_name, 
  order_date, 
  order_total total, 
  0 new_total, 
  0 renewing_total, 
  0 multiyear_total 
FROM 
  (
    orders o, accounts a, user_orders uo, 
    users u, region_states rs, regions r, 
    order_summary os
  ) 
  LEFT JOIN opportunities p on (p.order_id = o.order_id) 
  LEFT JOIN accounts d on (
    a.parent_account_id = d.account_id
  ) 
  LEFT JOIN order_po po ON (
    o.order_id = po.order_id 
    AND po.status = 0
  ) 
WHERE 
  o.account_id = a.account_id 
  AND o.order_id = os.order_id 
  AND o.order_id = uo.order_id 
  AND o.status = 0 
  AND uo.role_id = '".$ROLE[$DEPARTMENT["sales"]]["sales_rep"]."' 
  AND uo.user_id = u.user_id 
  AND rs.state_code = a.state_code 
  AND rs.region_id = r.region_id 
  AND r.department_id = ".$DEPARTMENT[" sales "]." $whereStr 
GROUP BY 
  o.order_id</td><td></td><td>skip</td></tr>
   <tr><td>reports/qcpr/company_renewal/generate_data.php:31</td><td>CREATE TEMPORARY TABLE interlink.temp_renew_qcpr_qc_data_source (
  row_id INT UNSIGNED not null auto_increment PRIMARY KEY
) 
SELECT 
  
  /***********GENERAL INFO***********/
  1 company_user_id, 
  'Company Renewal Sales' company_user, 
  CASE WHEN base.is_intl_reseller = 1 THEN 3 WHEN base.international = 1 THEN 2 ELSE 1 END international_id, 
  CASE WHEN base.is_intl_reseller = 1 THEN 'International Reseller' WHEN base.international = 1 THEN 'International' ELSE 'Domestic' END international, 
  
  /*******ACCOUNT PROGRAM INFO*******/
  a.account_level, 
  
  /* General grouping display is state>district. for international resellers we display the district(reseller name)>state */
  CASE WHEN base.is_intl_reseller = 1 THEN base.account_district_state ELSE COALESCE(
    NULLIF(base.district_account_id, ''), 
    CASE WHEN a.account_level = 1 THEN base.account_id ELSE -1 END
  ) END district_account_id, 
  CASE WHEN base.is_intl_reseller = 1 THEN base.account_district_state ELSE COALESCE(
    NULLIF(base.district_account_name, ''), 
    CASE WHEN a.account_level = 1 THEN a.account_name ELSE '-- No District --' END
  ) END district_account, 
  CASE WHEN base.is_intl_reseller = 1 THEN base.district_account_name ELSE base.account_district_state END district_state, 
  CASE WHEN base.is_intl_reseller = 1 THEN base.district_account_id ELSE base.account_district_state END district_state_id, 
  CASE WHEN IFNULL(base.district_account_id, '')> '' 
  OR a.account_level = 1 THEN 1 ELSE 0 END has_district, 
  base.account_id, 
  base.account_name account_name, 
  #a.state_code state_id,
  #a.state_code state,
  base.on_target orig_on_target, 
  CASE WHEN a.account_level = 1 THEN '-1' ELSE 2 END district_sort, 
  CASE WHEN a.account_level = 1 THEN '-1' ELSE base.account_purchaser_level END purchaser_level_id, 
  CASE WHEN a.account_level = 1 THEN 'District' WHEN base.account_purchaser_level = 1 THEN 'District Purchase' ELSE 'School Purchase' END purchaser_level, 
  
  /*******EXPIRING ACCOUNT*******/
  CONCAT(
    base.account_id, 'o', base.order_id
  ) expiring_account_id, 
  base.account_name expiring_account, 
  base.on_target, 
  CASE WHEN base.on_target = 1 
  AND a.account_level = 2 THEN 1 ELSE 0 END orig_expiring_school_count, 
  CASE WHEN (base.on_target)= 1 
  AND base.account_rank = 1 
  AND a.account_level = 2 THEN 1 ELSE 0 END expiring_school_count, 
  base.renewal_quota orig_expiring_order_account_value, 
  (base.renewal_quota) expiring_order_account_value, 
  
  /****** EXPIRING DOLLARS ******/
  CASE WHEN base.account_rank = 1 THEN base.expiring_literacy + base.expiring_levelset + base.expiring_bae ELSE 0 END expiring_literacy, 
  CASE WHEN base.account_rank = 1 THEN base.expiring_science ELSE 0 END expiring_science, 
  CASE WHEN base.account_rank = 1 THEN base.expiring_pd ELSE 0 END expiring_pd, 
  CASE WHEN base.account_rank = 1 THEN base.expiring_smartyAnts ELSE 0 END expiring_smartyAnts, 
  CASE WHEN base.account_rank = 1 THEN base.expiring_summer_subscription + base.expiring_summer_pd ELSE 0 END expiring_summer, 
  CASE WHEN base.account_rank = 1 THEN base.renewal_quota ELSE 0 END renewal_quota, 
  
  /*******NEW ORDER*******/
  base.account_rank, 
  base.order_id booked_order_id, 
  base.order_id booked_order, 
  base.order_id, 
  
  /******ACV******/
  CASE WHEN base.account_rank = 1 THEN GREATEST(is_renewed, is_replaced) ELSE 0 END is_renewed_count, 
  0 renew_school_count_percent, 
  CASE WHEN '$strict_acv' = 0 
  AND order_purchaser_level = 2 THEN acv_total + upsell_total ELSE base.acv_total END acv, 
  IFNULL(
    CASE WHEN '$strict_acv' = 0 
    AND order_purchaser_level = 2 THEN acv_total + upsell_total ELSE acv_total END / base.renewal_quota, 
    0
  ) acv_percent, 
  
  /****** ACV BY PROGRAM ******/
  CASE WHEN '$strict_acv' = 0 
  AND order_purchaser_level = 2 THEN base.literacy_acv + base.literacy_upsell + base.levelset_acv + base.levelset_upsell + base.bae_acv + base.bae_upsell ELSE base.literacy_acv + base.levelset_acv + base.bae_acv END literacy_acv, 
  CASE WHEN '$strict_acv' = 0 
  AND order_purchaser_level = 2 THEN base.science_acv + base.science_upsell ELSE base.science_acv END science_acv, 
  CASE WHEN '$strict_acv' = 0 
  AND order_purchaser_level = 2 THEN base.pd_acv + base.pd_upsell ELSE base.pd_acv END pd_acv, 
  CASE WHEN '$strict_acv' = 0 
  AND order_purchaser_level = 2 THEN base.smartyAnts_acv + base.smartyAnts_upsell ELSE base.smartyAnts_acv END smartyAnts_acv, 
  CASE WHEN '$strict_acv' = 0 
  AND order_purchaser_level = 2 THEN base.summer_subscription_acv + base.summer_subscription_upsell + base.summer_pd_acv + base.summer_pd_upsell ELSE base.summer_subscription_acv + base.summer_pd_acv END summer_acv, 
  
  /******CHURN BY PROGRAM (expiring - ACV)******/
  CASE WHEN base.account_rank = 1 THEN is_churned ELSE 0 END is_churned_count, 
  ROUND(
    (
      base.expiring_literacy + base.expiring_levelset + base.expiring_bae
    ) - (
      CASE WHEN '$strict_acv' = 0 
      AND order_purchaser_level = 2 THEN base.literacy_acv + base.literacy_upsell + base.levelset_acv + base.levelset_upsell + base.bae_acv + base.bae_upsell ELSE base.literacy_acv + base.levelset_acv + base.bae_acv END
    ), 
    2
  ) literacy_churn, 
  ROUND(
    (base.expiring_science) - (
      CASE WHEN '$strict_acv' = 0 
      AND order_purchaser_level = 2 THEN base.science_acv + base.science_upsell ELSE base.science_acv END
    ), 
    2
  ) science_churn, 
  ROUND(
    (base.expiring_pd) - (
      CASE WHEN '$strict_acv' = 0 
      AND order_purchaser_level = 2 THEN base.pd_acv + base.pd_upsell ELSE base.pd_acv END
    ), 
    2
  ) pd_churn, 
  ROUND(
    (base.expiring_smartyAnts) - (
      CASE WHEN '$strict_acv' = 0 
      AND order_purchaser_level = 2 THEN base.smartyAnts_acv + base.smartyAnts_upsell ELSE base.smartyAnts_acv END
    ), 
    2
  ) smartyAnts_churn, 
  ROUND(
    (
      base.expiring_summer_subscription + base.expiring_summer_pd
    ) - (
      CASE WHEN '$strict_acv' = 0 
      AND order_purchaser_level = 2 THEN base.summer_subscription_acv + base.summer_subscription_upsell + base.summer_pd_acv + base.summer_pd_upsell ELSE base.summer_subscription_acv + base.summer_pd_acv END
    ), 
    2
  ) summer_churn, 
  ROUND(churn_total, 2) churn_total, 
  
  /******UPSELL******/
  CASE WHEN '$strict_acv' = 0 
  AND order_purchaser_level = 2 THEN 0 ELSE upsell_total END upsell, 
  IFNULL(
    CASE WHEN '$strict_acv' = 0 
    AND order_purchaser_level = 2 THEN 0 ELSE upsell_total END / base.renewal_quota, 
    0
  ) upsell_percent, 
  acv_total + upsell_total `acv_upsell_total`, 
  IFNULL(
    (acv_total + upsell_total)/ base.renewal_quota, 
    0
  ) `acv_upsell_percent`, 
  
  /******UPSELL BY PROGRAM ******/
  CASE WHEN '$strict_acv' = 0 
  AND order_purchaser_level = 2 THEN 0 ELSE base.literacy_upsell + base.levelset_upsell + base.bae_upsell END literacy_upsell, 
  CASE WHEN '$strict_acv' = 0 
  AND order_purchaser_level = 2 THEN 0 ELSE base.science_upsell END science_upsell, 
  CASE WHEN '$strict_acv' = 0 
  AND order_purchaser_level = 2 THEN 0 ELSE base.pd_upsell END pd_upsell, 
  CASE WHEN '$strict_acv' = 0 
  AND order_purchaser_level = 2 THEN 0 ELSE base.smartyAnts_upsell END smartyAnts_upsell, 
  CASE WHEN '$strict_acv' = 0 
  AND order_purchaser_level = 2 THEN 0 ELSE base.summer_subscription_upsell + base.summer_pd_upsell END summer_upsell, 
  
  /******MORE SCHOOLS BY PROGRAM ******/
  CASE WHEN base.account_rank = 1 THEN is_more_schools ELSE 0 END is_more_schools_count, 
  base.more_schools_total, 
  base.literacy_more_schools + base.levelset_more_schools + base.bae_more_schools literacy_more_schools, 
  base.science_more_schools, 
  base.pd_more_schools, 
  base.smartyAnts_more_schools, 
  base.summer_subscription_more_schools + base.summer_pd_more_schools summer_more_schools, 
  
  /******Target Expansion******/
  target_more_years, 
  base.more_schools_more_years, 
  base.acv_total + base.upsell_total + base.more_schools_total + base.target_more_years + base.more_schools_more_years booked_order_account_value, 
  
  /*******ACCOUNT LEVEL ADDTL INFO*******/
  base.expiring_orders, 
  base.account_trainer, 
  base.account_imp_rvp 
FROM 
  commissions.$data_table base 
  INNER JOIN interlink.accounts a ON a.account_id = base.account_id 
  LEFT JOIN commissions.orders co ON co.order_id = base.order_id 
  AND co.cmonth = '$report_month_filter' 
WHERE 
  base.cmonth = '$report_month_filter' 
  AND CASE WHEN '$include_resellers' = 1 THEN 1 ELSE is_intl_reseller = 0 END;</td><td></td><td>skip</td></tr>
   <tr><td>reports/qcpr/company_renewal/generate_data.php:138</td><td>CREATE TEMPORARY TABLE interlink.temp_renew_qcpr_qc_data_source_copy (
  row_id INT UNSIGNED not null auto_increment PRIMARY KEY
) 
SELECT 
  * 
FROM 
  interlink.temp_renew_qcpr_qc_data_source</td><td></td><td>skip</td></tr>
   <tr><td>reports/qcpr/company_renewal/generate_data.php:353</td><td>CREATE TEMPORARY TABLE tmp_renewal_export_table(
  KEY(`Account ID`)
) 
SELECT 
  account_district_id `Account District ID`, 
  TRIM(account_district) `Account District Name`, 
  district_account_id `District Account ID`, 
  TRIM(district_account_name) `District Account Name`, 
  account_district_state `District State`, 
  account_rank `Account Rank`, 
  base.account_id `Account ID`, 
  base.account_name `Account Name`, 
  CASE WHEN account_purchaser_level = 2 THEN 'School' ELSE 'District' END `Account Purchaser Level`, 
  CASE WHEN a.account_level = 1 THEN 'District' ELSE 'School' END `Account Level`, 
  booked_target_year `Booked Target Year`, 
  on_target `On Target`, 
  CASE WHEN account_rank = 1 
  AND base.on_target = 1 
  AND a.account_level = 2 THEN 1 ELSE 0 END `Is Expiring School`, 
  CASE WHEN account_rank = 1 THEN expiring_literacy ELSE '' END `Expiring Literacy`, 
  CASE WHEN account_rank = 1 THEN expiring_science ELSE '' END `Expiring Science`, 
  CASE WHEN account_rank = 1 THEN expiring_pd ELSE '' END `Expiring PD`, 
  CASE WHEN account_rank = 1 THEN expiring_levelset ELSE '' END `Expiring Levelset`, 
  CASE WHEN account_rank = 1 THEN expiring_bae ELSE '' END `Expiring BAE`, 
  CASE WHEN account_rank = 1 THEN expiring_smartyAnts ELSE '' END `Expiring Smarty Ants`, 
  CASE WHEN account_rank = 1 THEN expiring_summer_subscription ELSE '' END `Expiring Summer Subscription`, 
  CASE WHEN account_rank = 1 THEN expiring_summer_pd ELSE '' END `Expiring Summer PD`, 
  CASE WHEN account_rank = 1 THEN base.renewal_quota ELSE '' END `Expiring Total`, 
  base.renewal_quota `Orig Expiring Total`, 
  CASE WHEN is_intl_reseller = 1 THEN 'International Reseller' WHEN international = 1 THEN 'International' ELSE 'Domestic' END international, 
  expiring_orders `Expiring Orders`, 
  order_id, 
  CASE WHEN account_rank = 1 THEN is_renewed ELSE 0 END `Is Renewed School`, 
  CASE WHEN account_rank = 1 THEN is_replaced ELSE 0 END `Is Replaced School`, 
  
  /*single_year_value,*/
  CASE WHEN $strict_acv = 0 
  AND order_purchaser_level = 2 THEN Literacy_acv + Literacy_upsell ELSE Literacy_acv END `Literacy $strict_text ACV`, 
  CASE WHEN $strict_acv = 0 
  AND order_purchaser_level = 2 THEN science_acv + science_upsell ELSE science_acv END `Science $strict_text ACV`, 
  CASE WHEN $strict_acv = 0 
  AND order_purchaser_level = 2 THEN PD_acv + PD_upsell ELSE PD_acv END `PD $strict_text ACV`, 
  CASE WHEN $strict_acv = 0 
  AND order_purchaser_level = 2 THEN Levelset_acv + Levelset_upsell ELSE Levelset_acv END `Levelset $strict_text ACV`, 
  CASE WHEN $strict_acv = 0 
  AND order_purchaser_level = 2 THEN BAE_acv + BAE_upsell ELSE BAE_acv END `BAE $strict_text ACV`, 
  CASE WHEN $strict_acv = 0 
  AND order_purchaser_level = 2 THEN SmartyAnts_acv + SmartyAnts_upsell ELSE SmartyAnts_acv END `SmartyAnts $strict_text ACV`, 
  CASE WHEN $strict_acv = 0 
  AND order_purchaser_level = 2 THEN Summer_subscription_acv + Summer_subscription_upsell ELSE Summer_subscription_acv END `Summer Subscription $strict_text ACV`, 
  CASE WHEN $strict_acv = 0 
  AND order_purchaser_level = 2 THEN Summer_PD_acv + Summer_PD_upsell ELSE Summer_PD_acv END `Summer PD $strict_text ACV`, 
  CASE WHEN $strict_acv = 0 
  AND order_purchaser_level = 2 THEN acv_total + upsell_total ELSE acv_total END `$strict_text ACV Total`, 
  (
    CASE WHEN $strict_acv = 0 
    AND order_purchaser_level = 2 THEN acv_total + upsell_total ELSE acv_total END
  )/ base.renewal_quota `$strict_text ACV Percent`, 
  
  /* churn (expiring - acv )*/
  CASE WHEN account_rank = 1 THEN is_churned ELSE 0 END `Is Churned School`, 
  (
    CASE WHEN account_rank = 1 THEN expiring_literacy ELSE '' END
  ) - (
    CASE WHEN $strict_acv = 0 
    AND order_purchaser_level = 2 THEN Literacy_acv + Literacy_upsell ELSE Literacy_acv END
  ) `Literacy Churn`, 
  (
    CASE WHEN account_rank = 1 THEN expiring_science ELSE '' END
  ) - (
    CASE WHEN $strict_acv = 0 
    AND order_purchaser_level = 2 THEN science_acv + science_upsell ELSE science_acv END
  ) `Science Churn`, 
  (
    CASE WHEN account_rank = 1 THEN expiring_pd ELSE '' END
  ) - (
    CASE WHEN $strict_acv = 0 
    AND order_purchaser_level = 2 THEN PD_acv + PD_upsell ELSE PD_acv END
  ) `PD Churn`, 
  (
    CASE WHEN account_rank = 1 THEN expiring_levelset ELSE '' END
  ) - (
    CASE WHEN $strict_acv = 0 
    AND order_purchaser_level = 2 THEN Levelset_acv + Levelset_upsell ELSE Levelset_acv END
  ) `Levelset Churn`, 
  (
    CASE WHEN account_rank = 1 THEN expiring_bae ELSE '' END
  ) - (
    CASE WHEN $strict_acv = 0 
    AND order_purchaser_level = 2 THEN BAE_acv + BAE_upsell ELSE BAE_acv END
  ) `BAE Churn`, 
  (
    CASE WHEN account_rank = 1 THEN expiring_smartyAnts ELSE '' END
  ) - (
    CASE WHEN $strict_acv = 0 
    AND order_purchaser_level = 2 THEN SmartyAnts_acv + SmartyAnts_upsell ELSE SmartyAnts_acv END
  ) `Smarty Ants Churn`, 
  (
    CASE WHEN account_rank = 1 THEN expiring_summer_subscription ELSE '' END
  ) - (
    CASE WHEN $strict_acv = 0 
    AND order_purchaser_level = 2 THEN Summer_subscription_acv + Summer_subscription_upsell ELSE Summer_subscription_acv END
  ) `Summer Subscription Churn`, 
  (
    CASE WHEN account_rank = 1 THEN expiring_summer_pd ELSE '' END
  ) - (
    CASE WHEN $strict_acv = 0 
    AND order_purchaser_level = 2 THEN Summer_PD_acv + Summer_PD_upsell ELSE Summer_PD_acv END
  ) `Summer PD Churn`, 
  churn_total `Churn Total`, 
  
  /** upsell **/
  CASE WHEN $strict_acv = 0 
  AND order_purchaser_level = 2 THEN 0 ELSE Literacy_upsell END `Literacy Upsell`, 
  CASE WHEN $strict_acv = 0 
  AND order_purchaser_level = 2 THEN 0 ELSE science_upsell END `Science Upsell`, 
  CASE WHEN $strict_acv = 0 
  AND order_purchaser_level = 2 THEN 0 ELSE PD_upsell END `PD Upsell`, 
  CASE WHEN $strict_acv = 0 
  AND order_purchaser_level = 2 THEN 0 ELSE Levelset_upsell END `Levelset Upsell`, 
  CASE WHEN $strict_acv = 0 
  AND order_purchaser_level = 2 THEN 0 ELSE BAE_upsell END `BAE Upsell`, 
  CASE WHEN $strict_acv = 0 
  AND order_purchaser_level = 2 THEN 0 ELSE SmartyAnts_upsell END `Smarty Ants Upsell`, 
  CASE WHEN $strict_acv = 0 
  AND order_purchaser_level = 2 THEN 0 ELSE Summer_subscription_upsell END `Summer Subscription Upsell`, 
  CASE WHEN $strict_acv = 0 
  AND order_purchaser_level = 2 THEN 0 ELSE Summer_PD_upsell END `Summer PD Upsell`, 
  CASE WHEN $strict_acv = 0 
  AND order_purchaser_level = 2 THEN 0 ELSE upsell_total END `Upsell Total`, 
  (acv_total + upsell_total) `ACV + Upsell Total`, 
  (acv_total + upsell_total)/ base.renewal_quota `ACV Upsell Percent`, 
  CASE WHEN account_rank = 1 THEN is_more_schools ELSE 0 END `Is More Schools`, 
  literacy_more_schools `Literacy More Schools`, 
  science_more_schools `Science More Schools`, 
  PD_more_schools `PD More Schools`, 
  levelset_more_schools `Levelset More Schools`, 
  bae_more_schools `BAE More Schools`, 
  SmartyAnts_more_schools `Smarty Ants More Schools`, 
  summer_subscription_more_schools `Summer Subscription More Schools`, 
  summer_PD_more_schools `Summer PD More Schools`, 
  more_schools_total `More Schools Total`, 
  target_more_years `Target More Years`, 
  more_schools_more_years `More Schools More Years`, 
  CASE WHEN order_purchaser_level = 2 THEN 'School' ELSE 'District' END `Order Purchaser Level`, 
  order_opportunity_owner `Order Opportunity Owner`, 
  order_renewal_rep `Order Renewal Rep`, 
  field_rep `Field Rep`, 
  region `Region`, 
  account_trainer `Account Trainer`, 
  account_imp_rvp `Account Imp RVP`, 
  account_trainer_expiring_ay `Account Trainer Expiring Academic Year`, 
  CASE WHEN '$group_by_district' = 1 THEN 'District' ELSE 'Purchaser Level' END `Renewal By`, 
  is_intl_reseller `Is International Reseller`, 
  tiers.tier_name Tier 
FROM 
  commissions.$data_table base 
  LEFT JOIN interlink.accounts a ON a.account_id = base.account_id 
  LEFT JOIN tiers tiers ON a.tier_id = tiers.tier_id 
WHERE 
  base.cmonth = '$report_month_filter' 
  AND CASE WHEN '$include_resellers' = 1 THEN 1 ELSE is_intl_reseller = 0 END 
ORDER BY 
  TRIM(account_district), 
  TRIM(district_account_name), 
  TRIM(base.account_name), 
  account_rank;</td><td></td><td>skip</td></tr>
   <tr><td>util/classes/User.php:310</td><td>CREATE TEMPORARY TABLE tmp_user_events (
  KEY(event_id), 
  KEY(user_id)
) 
SELECT 
  e.event_id, 
  e.event_status, 
  eu.user_id 
FROM 
  events e, 
  event_users eu 
WHERE 
  e.event_date >= CURRENT_DATE 
  AND e.event_type_id IN (7, 1) 
  AND e.event_id = eu.event_id</td><td></td><td>skip</td></tr>
</tbody>
<tfoot></tfoot>
</table>
